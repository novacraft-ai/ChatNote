const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r as a,j as e,a as me,D as xe,P as we}from"./vendor-react-BWK-dEaB.js";import{_ as Jt,B as be,C as ye,a as xt}from"./index-BYrQAyGp.js";import{G as Ht}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-CLrFw-IM.js";const ve=({pageNumber:h,pageWidth:m,pageHeight:k,scale:g,annotations:O,selectedAnnotationId:D,onAnnotationUpdate:y,onAnnotationDelete:C,onAnnotationSelect:_,mode:st})=>{const w=a.useRef(null),[A,it]=a.useState(!1),[b,q]=a.useState(!1),[x,gt]=a.useState(!1),[rt,J]=a.useState({x:0,y:0}),[G,c]=a.useState(null),[R,P]=a.useState(null),[ut,N]=a.useState({x:0,y:0,angle:0}),[E,at]=a.useState(null),Q=O.filter(n=>n.pageNumber===h),tt=n=>n*m*g,p=n=>n*k*g,B=n=>n*m*g,U=n=>n*k*g,F=n=>n/(m*g),ft=n=>n/(k*g),wt=a.useCallback((n,l,j,u)=>{const r=1-j,S=1-u;return{x:Math.max(0,Math.min(r,n)),y:Math.max(0,Math.min(S,l)),width:Math.max(.01,Math.min(1,j)),height:Math.max(.01,Math.min(1,u))}},[]),$=a.useCallback((n,l,j,u)=>{const r=document.createElement("div");r.style.position="absolute",r.style.visibility="hidden",r.style.width=`${j}px`,r.style.fontSize=`${l*u}px`,r.style.fontFamily="inherit",r.style.whiteSpace="pre-wrap",r.style.wordWrap="break-word",r.style.overflowWrap="break-word",r.style.padding=`${4*u}px`,r.style.boxSizing="border-box",r.style.lineHeight="1.2",r.textContent=n||"Text",document.body.appendChild(r);const S=r.scrollHeight;return document.body.removeChild(r),S},[]),lt=a.useCallback((n,l)=>{n.stopPropagation();const j=n.target;if(j.classList.contains("resize-handle")){n.preventDefault(),q(!0),c(j.dataset.handle||null);const r=w.current?.getBoundingClientRect();r&&(J({x:n.clientX-r.left,y:n.clientY-r.top}),P({x:n.clientX-r.left,y:n.clientY-r.top,width:l.width,height:l.height,annotationX:l.x,annotationY:l.y}));return}if(j.classList.contains("rotate-handle")){n.preventDefault(),gt(!0);const r=w.current?.getBoundingClientRect();if(r){const S=tt(l.x+l.width/2),v=p(l.y+l.height/2),M=n.clientX-r.left,et=n.clientY-r.top,bt=Math.atan2(et-v,M-S)*(180/Math.PI);N({x:M,y:et,angle:l.rotation-bt})}return}if(j.classList.contains("delete-button")){n.preventDefault(),C(l.id);return}n.preventDefault(),_(l.id),it(!0);const u=w.current?.getBoundingClientRect();u&&J({x:n.clientX-u.left-tt(l.x),y:n.clientY-u.top-p(l.y)})},[st,tt,p,_,C]);a.useEffect(()=>{if(!A&&!b&&!x)return;const n=j=>{const u=w.current?.getBoundingClientRect();if(!u)return;const r=Q.find(S=>S.id===D);if(r){if(x){const S=tt(r.x+r.width/2),v=p(r.y+r.height/2),M=j.clientX-u.left,et=j.clientY-u.top,bt=Math.atan2(et-v,M-S)*(180/Math.PI),ht=(ut.angle+bt)%360;Math.abs((r.rotation||0)-ht)>.01&&y({...r,rotation:ht})}else if(b&&G&&R){const S=j.clientX-u.left,v=j.clientY-u.top,M=S-R.x,et=v-R.y,bt=.5,ht=M/(m*g)*bt,yt=et/(k*g)*bt;let St=R.annotationX,Ft=R.annotationY,Pt=R.width,Et=R.height;G.includes("n")&&(Ft=Math.max(0,R.annotationY+yt),Et=Math.max(.01,R.height-yt)),G.includes("s")&&(Et=Math.max(.01,R.height+yt)),G.includes("w")&&(St=Math.max(0,R.annotationX+ht),Pt=Math.max(.01,R.width-ht)),G.includes("e")&&(Pt=Math.max(.01,R.width+ht));const jt=wt(St,Ft,Pt,Et);if(r.type==="textbox"){const Dt=r,$t=B(jt.width),Tt=$(Dt.text,Dt.fontSize,$t,g)/(k*g);if(Math.abs(Tt-jt.height)>.001){const Xt=Math.max(.01,Math.min(1,Tt)),Rt=wt(St,Ft,jt.width,Xt);(Math.abs((r.x||0)-Rt.x)>1e-4||Math.abs((r.y||0)-Rt.y)>1e-4||Math.abs((r.width||0)-Rt.width)>1e-4||Math.abs((r.height||0)-Rt.height)>1e-4)&&y({...r,...Rt})}else(Math.abs((r.x||0)-jt.x)>1e-4||Math.abs((r.y||0)-jt.y)>1e-4||Math.abs((r.width||0)-jt.width)>1e-4||Math.abs((r.height||0)-jt.height)>1e-4)&&y({...r,...jt})}else y({...r,...jt})}else if(A){const S=F(j.clientX-u.left-rt.x),v=ft(j.clientY-u.top-rt.y),M=wt(S,v,r.width,r.height);(Math.abs((r.x||0)-M.x)>1e-4||Math.abs((r.y||0)-M.y)>1e-4)&&y({...r,...M})}}},l=()=>{if(b&&D){const j=Q.find(u=>u.id===D);if(j&&j.type==="textbox"){const u=j,r=B(u.width),v=$(u.text,u.fontSize,r,g)/(k*g),M=wt(u.x,u.y,u.width,v);Math.abs(M.height-u.height)>.001&&y({...u,...M})}}it(!1),q(!1),gt(!1),c(null),P(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",l),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",l)}},[A,b,x,G,R,rt,ut,D,Q,tt,p,B,U,F,ft,wt,$,y,m,k,g]),a.useEffect(()=>{const n=l=>{(l.key==="Delete"||l.key==="Backspace")&&D&&l.target.tagName!=="INPUT"&&l.target.tagName!=="TEXTAREA"&&(l.preventDefault(),C(D))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[D,C]);const vt=n=>{const l=n.id===D,j=tt(n.x),u=p(n.y),r=B(n.width),S=U(n.height);return e.jsxs("div",{className:`annotation textbox-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${r}px`,height:`${S}px`,padding:`${4*g}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>lt(v,n),children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),E===n.id?e.jsx("textarea",{className:"textbox-input",value:n.text,onChange:v=>{y({...n,text:v.target.value})},onBlur:v=>{const M=v.relatedTarget;M&&(M.closest(".textbox-controls")!==null||M.closest(".textbox-font-size-input")!==null||M.classList.contains("textbox-font-size-input")||M.closest(".floating-textbox-toolbar")!==null||M.closest(".color-swatch")!==null||M.classList.contains("toolbar-icon"))||(at(null),_(null))},onKeyDown:v=>{v.key==="Enter"&&!v.shiftKey&&(v.preventDefault(),at(null),_(null)),v.key==="Escape"&&(at(null),_(null))},style:{fontSize:`${n.fontSize*g}px`,color:n.color,width:`${r}px`,maxWidth:`${r}px`,height:`${S}px`,maxHeight:`${S}px`},autoFocus:!0}):e.jsx("div",{className:"textbox-content",onClick:v=>{v.stopPropagation();const M=v.target;M.closest(".textbox-controls")!==null||M.closest(".textbox-font-size-input")!==null||M.closest(".textbox-color-button")!==null||M.closest(".textbox-color-picker")!==null||at(n.id)},style:{fontSize:`${n.fontSize*g}px`,color:n.color},children:n.text||"Text"})]},n.id)},pt=n=>{const l=n.id===D,j=tt(n.x),u=p(n.y),r=B(n.width),S=U(n.height),v=n.width*m,M=n.height*k,et=n.imageWidth/n.imageHeight,bt=v/M;let ht,yt;return et>bt?(ht=r,yt=r/et):(yt=S,ht=S*et),e.jsxs("div",{className:`annotation image-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${ht}px`,height:`${yt}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:St=>lt(St,n),children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:St=>{St.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),e.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},ct=n=>{const l=n.id===D,j=tt(n.x),u=p(n.y),r=B(n.width),S=U(n.height);return e.jsx("div",{className:`annotation highlight-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${r}px`,height:`${S}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>lt(v,n),children:l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]})},n.id)},Ct=m*g,mt=k*g,H={width:`${Ct}px`,height:`${mt}px`,pointerEvents:"none"},T=Q.find(n=>n.id===D&&n.type==="textbox"),[X,dt]=a.useState(null);return a.useEffect(()=>{if(!T||!w.current){dt(null);return}const n=tt(T.x),l=p(T.y);dt({left:n+B(T.width)/2,top:Math.max(0,l-40)})},[T,m,k,g,E]),e.jsxs("div",{ref:w,className:"annotation-layer",style:H,children:[Q.map(n=>n.type==="textbox"?vt(n):n.type==="image"?pt(n):n.type==="highlight"?ct(n):null),T&&E===T.id&&X&&e.jsxs("div",{className:"floating-textbox-toolbar",style:{left:`${X.left}px`,top:`${X.top}px`,position:"absolute",zIndex:9999},onMouseDown:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"font-size-group",children:[e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=T.fontSize||16;y({...T,fontSize:Math.max(1,n-1)})},title:"Decrease font size",children:"−"}),e.jsx("span",{className:"font-size-display",children:T.fontSize||16}),e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=T.fontSize||16;y({...T,fontSize:Math.min(200,n+1)})},title:"Increase font size",children:"+"})]}),e.jsx("div",{className:"color-swatch-group",children:["#000000","#ff0000","#0000ff","#00ff00","#ffeb3b"].map(n=>e.jsx("button",{className:`color-swatch ${T.color===n?"active":""}`,style:{backgroundColor:n},onClick:()=>y({...T,color:n}),title:n},n))})]})]})},je=({mode:h,onModeChange:m,highlightColor:k="#ffeb3b",onHighlightColorChange:g,onHighlightClick:O,hasTextSelection:D=!1,isHighlightActive:y=!1,showColorPicker:C=!1,onImageUpload:_,layout:st,onToggleLayout:w,onClearAll:A,pageNumber:it,numPages:b,onPrevPage:q,onNextPage:x,scale:gt,onZoomIn:rt,onZoomOut:J,onFitWidth:G,onFitHeight:c,onZoomInputClick:R,isEditingZoom:P,zoomInputValue:ut,onZoomInputChange:N,onZoomInputBlur:E,onZoomInputKeyDown:at,onZoomInputPaste:Q,zoomInputRef:tt})=>{const p=a.useRef(null),[B,U]=a.useState(!1),F=a.useRef(null),ft=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];me.useEffect(()=>{const lt=vt=>{B&&(vt.target.closest(".clear-button")||(U(!1),F.current&&(clearTimeout(F.current),F.current=null)))};if(B)return document.addEventListener("click",lt),()=>{document.removeEventListener("click",lt)}},[B]);const wt=lt=>{const vt=lt.target.files?.[0];vt&&vt.type.startsWith("image/")&&_(vt),m(null),p.current&&(p.current.value="")},$=lt=>{lt.stopPropagation(),B?(A&&A(),U(!1),F.current&&(clearTimeout(F.current),F.current=null)):(U(!0),F.current=setTimeout(()=>{U(!1),F.current=null},3e3))};return e.jsxs("div",{className:"annotation-toolbar",children:[e.jsxs("div",{className:"toolbar-left",children:[e.jsxs("div",{className:"toolbar-section annotation-tools",children:[e.jsx("button",{className:`toolbar-button ${y?"active":""}`,onClick:O,disabled:!D,title:D?y?"Remove highlight":"Highlight text":"Select text to highlight",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),e.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),e.jsx("button",{className:`toolbar-button ${h==="textbox"?"active":""}`,onClick:()=>m("textbox"),title:"Add text box",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M4 7V4h16v3M9 20h6M12 4v16"})})}),e.jsx("button",{className:`toolbar-button ${h==="image"?"active":""}`,onClick:()=>{m("image"),p.current?.click()},title:"Add image",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]})}),A&&e.jsx("button",{className:`toolbar-button clear-button ${B?"confirming":""}`,onClick:$,title:B?"Click again to clear all":"Clear all",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),e.jsx("input",{ref:p,type:"file",accept:"image/*",onChange:wt,style:{display:"none"}})]}),C&&g&&e.jsx("div",{className:"toolbar-section color-picker",children:ft.map(lt=>e.jsx("button",{className:`color-button ${k===lt?"active":""}`,style:{backgroundColor:lt},onClick:()=>g(lt),title:"Highlight color"},lt))})]}),e.jsxs("div",{className:"toolbar-center",children:[it!==void 0&&b!==void 0&&e.jsxs("div",{className:"toolbar-section pdf-navigation",children:[e.jsx("button",{className:"toolbar-button nav-button",onClick:q,disabled:it<=1,title:"Previous page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsxs("span",{className:"page-info",children:[it," / ",b]}),e.jsx("button",{className:"toolbar-button nav-button",onClick:x,disabled:it>=b,title:"Next page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),gt!==void 0&&e.jsxs("div",{className:"toolbar-section zoom-controls",children:[e.jsx("button",{onClick:G,className:"toolbar-button",title:"Fit width",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"5 9 2 12 5 15"}),e.jsx("polyline",{points:"19 9 22 12 19 15"}),e.jsx("line",{x1:"2",y1:"12",x2:"22",y2:"12"})]})}),e.jsx("button",{onClick:c,className:"toolbar-button",title:"Fit height",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"9 5 12 2 15 5"}),e.jsx("polyline",{points:"9 19 12 22 15 19"}),e.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22"})]})}),e.jsx("button",{onClick:J,className:"toolbar-button",title:"Zoom out",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),P?e.jsx("input",{ref:tt,type:"text",inputMode:"numeric",value:ut,onChange:N,onBlur:E,onKeyDown:at,onPaste:Q,className:"zoom-input"}):e.jsxs("span",{className:"zoom-level",onClick:R,title:"Click to edit zoom",children:[Math.round((gt||1)*100),"%"]}),e.jsx("button",{onClick:rt,className:"toolbar-button",title:"Zoom in",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]}),e.jsx("div",{className:"toolbar-right",children:e.jsx("div",{className:"toolbar-section toolbar-actions",children:e.jsx("button",{className:"toolbar-button layout-toggle-button",onClick:w,title:st==="floating"?"Switch to split layout":"Switch to floating layout",children:st==="floating"?e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]}):e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})})})]})},ke=({pageNumber:h,pageWidth:m,pageHeight:k,scale:g,knowledgeNotes:O,showKnowledgeNotes:D,onNoteClick:y})=>{const C=O.filter(w=>w.pageNumber===h);if(!D||C.length===0)return null;const _=m*g,st=k*g;return e.jsx("div",{className:"knowledge-note-connections",style:{width:`${_}px`,height:`${st}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:e.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:C.map((w,A)=>{const it=_-25,b=25+A*35;return e.jsxs("g",{children:[e.jsx("circle",{cx:it,cy:b,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:q=>{q.stopPropagation(),y?.(w)},style:{cursor:"pointer",pointerEvents:"all"}}),e.jsx("text",{x:it,y:b,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:A+1}),e.jsx("line",{x1:it,y1:b+12,x2:it,y2:b+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},w.id)})})})};let Ot,zt=null,Kt=!1;async function Ce(){if(!Ot)try{Ot=await Jt(()=>import("./vendor-CLrFw-IM.js").then(h=>h.o),__vite__mapDeps([0,1]))}catch(h){throw console.error("Failed to load pdf-lib:",h),new Error("PDF library not available. Please install pdf-lib.")}return Ot}async function Ne(){if(!Kt){Kt=!0;try{const h=await Jt(()=>import("./vendor-CLrFw-IM.js").then(m=>m.p),__vite__mapDeps([0,1]));return h.default?zt=h.default:zt=h,zt&&typeof zt.create=="function"?zt:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(h){return console.warn("Failed to load fontkit, falling back to standard fonts:",h),null}}return zt}async function Se(){try{const h=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],m="/ChatNote/",g=`${m.endsWith("/")?m:`${m}/`}NotoSans-Regular.ttf`;try{const O=await fetch(g);if(O.ok){const D=await O.arrayBuffer();if(D.byteLength>1e3){const y=new Uint8Array(D);if(y.length>=4&&y[0]===0&&y[1]===1&&y[2]===0&&y[3]===0)return D}}}catch{}for(const O of h)if(!O.includes("fonts.googleapis.com/css"))try{const D=await fetch(O,{mode:"cors",cache:"default"});if(D.ok){const y=await D.arrayBuffer();if(y.byteLength>1e3){const C=new Uint8Array(y),_=C.length>=4&&C[0]===0&&C[1]===1&&C[2]===0&&C[3]===0,st=C.length>=4&&C[0]===119&&C[1]===79&&C[2]===70&&C[3]===70,w=C.length>=4&&C[0]===119&&C[1]===79&&C[2]===70&&C[3]===50;if(_||st||w)return y;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(h){return console.warn("Failed to load Unicode font:",h),null}}async function Me(h,m,k){try{const g=await Ce(),{PDFDocument:O,rgb:D,degrees:y,StandardFonts:C}=g;if(!C)throw new Error("StandardFonts not available from pdf-lib");const _=await h.arrayBuffer(),st=await O.load(_);let w=null;try{const b=await Ne();if(b){try{st.registerFontkit(b)}catch(x){(!x.message||!x.message.includes("already registered"))&&console.warn("Failed to register fontkit:",x)}const q=await Se();if(q){const x=new Uint8Array(q),gt=x.length>=4&&x[0]===0&&x[1]===1&&x[2]===0&&x[3]===0,rt=x.length>=4&&x[0]===79&&x[1]===84&&x[2]===84&&x[3]===79,J=x.length>=4&&x[0]===116&&x[1]===116&&x[2]===99&&x[3]===102,G=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===70,c=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===50;G||c?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):gt||rt||J?w=await st.embedFont(q):console.warn(`Invalid font format. File size: ${x.length} bytes`)}}}catch(b){console.warn("Failed to embed Unicode font, falling back to standard font:",b)}if(!w){const b=C.Helvetica||C.TimesRoman;if(!b)throw new Error("No standard font available");w=await st.embedFont(b)}if(!w)throw new Error("Failed to embed font");const A=st.getPages();for(const b of m){const q=A[b.pageNumber-1];if(!q)continue;const x=k.get(b.pageNumber);if(!x)continue;const{width:gt,height:rt}=x;let J=b.width*gt,G=b.height*rt;if(b.type==="textbox"){const c=b,R=De(c.color)||{r:0,g:0,b:0},P=b.x*gt,ut=b.y*rt;let N=(b.y+b.height)*rt;const E=4,at=J-E*2,Q=(c.text||"").trimEnd();let p=Q.split(/\r\n|\r|\n/).filter(H=>H!=null);for(;p.length>0&&p[p.length-1].length===0;)p.pop();if(p.length===0&&(p=[""]),p.length===1&&w&&typeof w.widthOfTextAtSize=="function"){const H=p[0],T=at;let X;try{X=w.widthOfTextAtSize(H,c.fontSize)}catch{X=H.length*c.fontSize*.5}if(X>T){const dt=[],n=H.split(/(\s+)/);let l="";for(let j=0;j<n.length;j++){const u=n[j],r=l+u;let S;try{S=w.widthOfTextAtSize(r,c.fontSize)}catch{S=r.length*c.fontSize*.5}S<=T||l===""?l=r:(l.trim()&&dt.push(l.trim()),l=u)}l.trim()&&dt.push(l.trim()),dt.length>1&&(p=dt)}}const B=c.fontSize*1.2;G=p.length>0?(p.length-1)*B+c.fontSize+E*2:c.fontSize+E*2,N=ut+G;const ft=rt-N,$=rt-ut-ft,vt=ft+$/2,pt=c.fontSize*.2,ct=rt-c.fontSize*.2,Ct=Math.max(pt,Math.min(ct,vt));if((p.length>1||Q.includes(`
`)||Q.includes("\r"))&&p.length>0)try{const H=(p.length-1)*B,T=Ct+H/2;p.forEach((X,dt)=>{const n=T-dt*B;let l;try{w&&typeof w.widthOfTextAtSize=="function"?l=w.widthOfTextAtSize(X,c.fontSize):l=X.length*c.fontSize*.5}catch{l=X.length*c.fontSize*.5}let u=P+E+at/2-l/2;const r=P+E,S=P+J-l-E;u=Math.max(r,Math.min(S,u));const v=X.length>0?X:" ";q.drawText(v,{x:u,y:n,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})})}catch(H){if(H.message&&H.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",H.message);const T=p.map(n=>n.split("").map(l=>l.charCodeAt(0)>255?"?":l).join("")),X=(T.length-1)*B,dt=Ct+X/2;try{T.forEach((n,l)=>{const j=dt-l*B;let u;try{w&&typeof w.widthOfTextAtSize=="function"?u=w.widthOfTextAtSize(n,c.fontSize):u=n.length*c.fontSize*.5}catch{u=n.length*c.fontSize*.5}let S=P+E+at/2-u/2;const v=P+E,M=P+J-u-E;S=Math.max(v,Math.min(M,S)),q.drawText(n,{x:S,y:j,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})})}catch(n){console.error("Failed to draw text even after replacing Unicode characters:",n);continue}}else throw H}else{let H;try{w&&typeof w.widthOfTextAtSize=="function"?H=w.widthOfTextAtSize(c.text,c.fontSize):H=c.text.length*c.fontSize*.5}catch{H=c.text.length*c.fontSize*.5}let X=P+E+at/2-H/2;const dt=P+E,n=P+J-H-E;X=Math.max(dt,Math.min(n,X));try{q.drawText(c.text,{x:X,y:Ct,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})}catch(l){if(l.message&&l.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",l.message);const j=c.text.split("").map(u=>u.charCodeAt(0)>255?"?":u).join("");try{q.drawText(j,{x:X,y:Ct,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})}catch(u){console.error("Failed to draw text even after replacing Unicode characters:",u);continue}}else throw l}}}else if(b.type==="image"){const c=b,R=await fetch(c.imageData).then(F=>F.arrayBuffer());let P;if(c.imageData.startsWith("data:image/png"))P=await st.embedPng(R);else if(c.imageData.startsWith("data:image/jpeg")||c.imageData.startsWith("data:image/jpg"))P=await st.embedJpg(R);else throw console.error("Unsupported image format for PDF embedding:",c.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const ut=c.imageWidth/c.imageHeight;let N=J,E=G;J/G>ut?N=G*ut:E=J/ut;const Q=b.x*gt,tt=(b.y+b.height)*rt,U=rt-tt+(G-E)/2;q.drawImage(P,{x:Q,y:U,width:N,height:E,rotate:y(c.rotation)})}}const it=await st.save();return new Blob([it],{type:"application/pdf"})}catch(g){throw console.error("Error saving annotated PDF:",g),new Error("Failed to save annotated PDF")}}function De(h){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:null}function qt(h,m="annotated.pdf"){const k=URL.createObjectURL(h),g=document.createElement("a");g.href=k,g.download=m,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(k)}const It="chatnote_pdf_history_cache",Re=300*1e3;function Yt(h=3){const m=localStorage.getItem(It);let k=[];try{if(m){const g=JSON.parse(m);g&&Array.isArray(g.pdfs)&&(k=g.pdfs.slice(0,h))}}catch{}return k}function ze(h){try{const m={pdfs:h,timestamp:Date.now()};localStorage.setItem(It,JSON.stringify(m))}catch{}}function Fe(h=Re){try{const m=localStorage.getItem(It);if(!m)return!1;const k=JSON.parse(m);return!k||typeof k.timestamp!="number"?!1:Date.now()-k.timestamp<h}catch{return!1}}async function Pe(h=3){try{const m=localStorage.getItem("auth_token");if(!m)return Yt(h);const k=Yt(h),g=Fe(),O=fetch(`${be}/api/drive/history`,{headers:{Authorization:`Bearer ${m}`}}).then(async y=>{if(!y.ok){if(y.status===403){try{localStorage.removeItem(It)}catch{}return[]}return[]}const _=(await y.json()).pdfs||[];return ze(_),_.slice(0,h)}).catch(()=>[]);if(g)return O.catch(()=>{}),k;const D=await O;return D.length>0?D:k}catch{return Yt(h)}}const Ee="/ChatNote/assets/chatnote-logo-BGY00N4J.svg";function He({file:h,onFileUpload:m,onTextSelection:k,layout:g="floating",onPageChange:O,onTotalPagesChange:D,showKnowledgeNotes:y=!0,knowledgeNotes:C=[],onScrollToPage:_,onNoteClick:st,onAddAnnotation:w,initialAnnotations:A=[],onAnnotationsChange:it,isLoadingPdf:b=!1,onLoadingComplete:q,isSavingSession:x=!1,onNewSession:gt,onToggleLayout:rt,isDriveAuthorized:J,onSelectRecentPdf:G}){const[c,R]=a.useState(0),[P,ut]=a.useState(1),[N,E]=a.useState(1),[at,Q]=a.useState(!1),[tt,p]=a.useState("100"),B=a.useRef(null),U=a.useRef(new Map),F=a.useRef(null),ft=a.useRef(null),wt=a.useRef(!1),$=a.useRef(new Map),[lt,vt]=a.useState(0),[pt,ct]=a.useState(A),[Ct,mt]=a.useState(null),[H,T]=a.useState(null),[X,dt]=a.useState(null),[n,l]=a.useState(null),[j,u]=a.useState(!1),[r,S]=a.useState("#ffeb3b"),[v,M]=a.useState(!1),et=a.useRef(A),bt=a.useRef(it);a.useEffect(()=>{bt.current=it},[it]),a.useEffect(()=>{const t=et.current,o=A.length!==t.length||A.some((i,d)=>i.id!==t[d]?.id);A&&A.length>0&&o?(ct(A),et.current=A):h&&A.length===0&&t.length>0?(ct([]),et.current=[],mt(null)):!h&&t.length>0&&(ct([]),et.current=[],mt(null))},[A,h]),a.useEffect(()=>{JSON.stringify(et.current)!==JSON.stringify(pt)&&bt.current&&(et.current=pt,bt.current(pt))},[pt]),a.useEffect(()=>{const t=console.warn,o=console.error;return console.warn=(...i)=>{const d=i.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")||i.some(s=>typeof s=="string"&&(s.includes("TextLayer task cancelled")||s.includes("AbortException")))||t.apply(console,i)},console.error=(...i)=>{const d=i.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")&&d.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=t,console.error=o}},[]);const ht=a.useMemo(()=>h?URL.createObjectURL(h):null,[h]),yt=a.useRef(null);a.useEffect(()=>(yt.current&&yt.current!==ht&&URL.revokeObjectURL(yt.current),yt.current=ht,()=>{ht&&URL.revokeObjectURL(ht)}),[ht]);const St=a.useMemo(()=>{let t;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";t=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Ht&&(Ht.workerSrc=t,Ht.standardFontDataUrl=o),{workerSrc:t,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),Ft=({numPages:t})=>{R(t),D?.(t);const o=1;ut(o),setTimeout(()=>{O?.(o)},0),U.current.clear(),$.current.clear(),q&&setTimeout(()=>{q()},300)},Pt=t=>{if(!$.current.has(t.pageNumber))try{const o=t.page;let i,d;o.viewport?(i=o.viewport.width,d=o.viewport.height):(i=o.width/N,d=o.height/N),$.current.set(t.pageNumber,{width:i,height:d})}catch(o){console.warn("Error getting page dimensions:",o);const i=t.page,d=i.width/N,s=i.height/N;$.current.set(t.pageNumber,{width:d,height:s})}};a.useEffect(()=>{if(!F.current||c===0)return;let t=null,o=!1;const i=()=>{if(wt.current||o||t)return;o=!0,t=setTimeout(()=>{t=null,o=!1},100);const s=F.current;if(!s){o=!1;return}const f=s.getBoundingClientRect(),Y=f.top,z=f.height,V=Y+z/2;if(s.scrollTop<100){ut(I=>I!==1?(setTimeout(()=>{O?.(1)},0),1):I);return}let nt=1,W=0;for(let I=1;I<=c;I++){const L=U.current.get(I);if(L){const ot=L.getBoundingClientRect(),K=s.getBoundingClientRect(),Nt=Math.max(K.top,ot.top),kt=Math.min(K.bottom,ot.bottom),Mt=Math.max(0,kt-Nt);Mt>W&&(W=Mt,nt=I)}}if(W<z*.1){let I=1,L=1/0;for(let ot=1;ot<=c;ot++){const K=U.current.get(ot);if(K){const Nt=K.getBoundingClientRect(),kt=Nt.top+Nt.height/2,Mt=Math.abs(kt-V);Mt<L&&(L=Mt,I=ot)}}nt=I}ut(I=>nt!==I?(setTimeout(()=>{O?.(nt)},0),nt):I)},d=F.current;return d?.addEventListener("scroll",i,{passive:!0}),()=>{t&&clearTimeout(t),d?.removeEventListener("scroll",i)}},[c,O]),a.useEffect(()=>{let t=null;const o=()=>{t&&clearTimeout(t),t=setTimeout(()=>{vt(i=>i+1)},150)};return window.addEventListener("resize",o),()=>{t&&clearTimeout(t),window.removeEventListener("resize",o)}},[]);const Et=t=>{console.error("PDF load error:",t)},jt=async t=>{const o=t.target.files?.[0];if(o&&o.type==="application/pdf"){m(o);const i=o.size/(1024*1024),d=xt.generateDocumentId();xt.setCurrentDocument(d),await xt.createDocument(d,i),await xt.trackPDFUpload(i,d)}},Dt=a.useCallback(t=>{const o=U.current.get(t);o&&F.current&&(wt.current=!0,ut(t),O?.(t),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{wt.current=!1},1500))},[O]);a.useEffect(()=>(_&&(window.__pdfScrollToPage=Dt),F.current&&(window.__pdfContentRef=F.current),ft.current&&(window.__pdfViewerHeight=ft.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Dt,_,c,N]);const $t=()=>{const t=Math.max(1,P-1);Dt(t)},_t=()=>{const t=Math.min(c,P+1);Dt(t)},Tt=()=>{const t=Math.min(N+.2,5);E(t),p(Math.round(t*100).toString())},Xt=()=>{const t=Math.max(N-.2,.25);E(t),p(Math.round(t*100).toString())};a.useEffect(()=>{at||p(Math.round(N*100).toString())},[N,at]);const Rt=()=>{Q(!0),p(Math.round(N*100).toString())},Gt=t=>{let o=t.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),p(o)},Qt=()=>{At()},te=t=>{if(t.key==="Enter")t.preventDefault(),At();else if(t.key==="Escape")Q(!1),p(Math.round(N*100).toString()),B.current?.blur();else{if(t.key==="Backspace"||t.key==="Delete"||t.key==="ArrowLeft"||t.key==="ArrowRight"||t.key==="Tab")return;(t.key==="-"||t.key==="+"||t.key==="."||t.key===","||t.key==="e"||t.key==="E"||!/[0-9]/.test(t.key)&&!t.ctrlKey&&!t.metaKey)&&t.preventDefault()}},ee=t=>{t.preventDefault();const i=t.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const s=(i.replace(/^0+/,"")||"0").slice(0,3);if(p(s),s&&s!=="0"){const f=parseInt(s,10);if(!isNaN(f)&&f>0){const Y=Math.max(25,Math.min(500,f)),z=Y/100;E(z),p(Y.toString()),Q(!1)}}}},At=()=>{if(tt.trim()===""||tt==="0"){p(Math.round(N*100).toString()),Q(!1);return}const t=parseInt(tt,10);if(isNaN(t)||t<=0){p(Math.round(N*100).toString()),Q(!1);return}const o=Math.max(25,Math.min(500,t)),i=o/100;E(i),p(o.toString()),Q(!1)};a.useEffect(()=>{at&&B.current&&(B.current.focus(),B.current.select())},[at]);const ne=()=>{if($.current.size===0)return;let t=null;if(F.current){const s=F.current,f=getComputedStyle(s),Y=parseFloat(f.paddingLeft||"0")||0,z=parseFloat(f.paddingRight||"0")||0;t=s.clientWidth-Y-z,s.scrollHeight>s.clientHeight&&(t-=12),t=Math.max(0,t-4)}else if(ft.current){const s=ft.current.getBoundingClientRect();t=Math.max(0,s.width-40)}if(!t||t<=0)return;const o=$.current.get(1);if(!o)return;const i=t/o.width*.999,d=Math.max(.1,Math.min(i,5));E(d),p(Math.round(d*100).toString())},oe=()=>{if(!ft.current||$.current.size===0)return;const t=ft.current.getBoundingClientRect();let o=0;const i=ft.current.querySelector(".annotation-toolbar");i&&(o=i.getBoundingClientRect().height);const d=t.height-o,s=$.current.get(P);if(!s)return;const f=d/s.height,Y=Math.max(.1,Math.min(f,5));E(Y),p(Math.round(Y*100).toString())},Ut=a.useCallback(()=>{const t=window.getSelection();if(t&&t.toString().trim()){const o=t.toString().trim();let i,d;if(t.rangeCount>0&&F.current){const f=t.getRangeAt(0).getBoundingClientRect(),Y=F.current.getBoundingClientRect(),z=f.top-Y.top+F.current.scrollTop;for(let V=1;V<=c;V++){const Z=U.current.get(V);if(Z){const nt=Z.offsetTop,W=Z.offsetHeight,I=nt+W;if(z>=nt&&z<=I){d=V;const L=(z-nt)/W;i=Math.max(0,Math.min(1,L)),dt({text:o,pageNumber:V,rect:f,pageElement:Z});const ot=pt.find(K=>K.type==="highlight"&&K.pageNumber===V&&Math.abs(K.x-Math.max(0,Math.min(1,(f.left-Z.getBoundingClientRect().left)/Z.offsetWidth)))<.01&&Math.abs(K.y-Math.max(0,Math.min(1,L)))<.01);l(ot?.id||null);break}}}}k(o,d,i)}else k("",void 0,void 0),dt(null),l(null),u(!1)},[k,c,pt]),se=a.useCallback(t=>{const o=t.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.closest(".floating-textbox-toolbar")!==null||o.closest(".color-swatch")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker")||o.classList.contains("floating-textbox-toolbar")||o.classList.contains("color-swatch"))return;const d=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const s=window.getSelection(),f=s&&s.toString().trim().length>0;if(f||k(""),!d&&!f&&mt(null),H==="textbox"&&!d&&!f){const Y=F.current;if(!Y)return;let z=P,V=.5,Z=.5;for(let W=1;W<=c;W++){const I=U.current.get(W);if(I){const L=I.getBoundingClientRect();if(Y.getBoundingClientRect()){const K=t.clientX-L.left,Nt=t.clientY-L.top;if(K>=0&&K<=L.width&&Nt>=0&&Nt<=L.height){z=W;const kt=$.current.get(W);if(kt){const Mt=L.width/kt.width,pe=L.height/kt.height;V=K/(kt.width*Mt),Z=Nt/(kt.height*pe)}break}}}}if($.current.get(z)){const W=Math.max(0,Math.min(.8,V-.1)),I=Math.max(0,Math.min(1-.1,Z-.05)),L={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:z,x:W,y:I,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:ye[0]};ct(ot=>[...ot,L]),mt(L.id),T("select")}}},100)},[k,H,P,c,N,mt,T,ct]),Lt=a.useCallback(t=>{ct(d=>[...d,t]),mt(t.id);let o="text";t.type==="highlight"?o="highlight":t.type==="image"?o="image":t.type==="textbox"&&(o="text"),xt.trackAnnotationAdded(o);const i=xt.getCurrentDocumentId();i&&xt.updateDocument(i,{has_annotations:!0})},[]);a.useEffect(()=>(w&&(window.__addPDFAnnotation=t=>{ct(o=>[...o,t]),mt(t.id),t.pageNumber&&_&&_(t.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[w,_]);const Wt=a.useCallback((t,o,i)=>{const d=t.width*o.width*i,s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${d}px`,s.style.fontSize=`${t.fontSize*i}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*i}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=t.text||"Text",document.body.appendChild(s);const f=s.scrollHeight;document.body.removeChild(s);const Y=f/(o.height*i);return Math.max(.01,Math.min(1,Y))},[]),ie=a.useCallback(t=>{ct(o=>{let i=!1;const d=o.map(s=>{if(s.id!==t.id)return s;if(t.type==="textbox"){const f=t,Y=$.current.get(f.pageNumber);if(Y){const z=Wt(f,Y,N);return Math.abs((s.height||0)-z)>1e-4||Math.abs((s.x||0)-(f.x||0))>1e-4||Math.abs((s.y||0)-(f.y||0))>1e-4||Math.abs((s.width||0)-(f.width||0))>1e-4||Math.abs((s.rotation||0)-(f.rotation||0))>1e-4||s.type==="textbox"&&(s.text!==f.text||s.color!==f.color||s.fontSize!==f.fontSize)?(i=!0,{...f,height:z}):s}}return Math.abs((s.x||0)-(t.x||0))>1e-4||Math.abs((s.y||0)-(t.y||0))>1e-4||Math.abs((s.width||0)-(t.width||0))>1e-4||Math.abs((s.height||0)-(t.height||0))>1e-4||Math.abs((s.rotation||0)-(t.rotation||0))>1e-4||"color"in s&&"color"in t&&s.color!==t.color?(i=!0,t):s});return i?d:o})},[N,Wt]);a.useEffect(()=>{ct(t=>t.map(o=>{if(o.type==="textbox"){const i=o,d=$.current.get(i.pageNumber);if(d){const s=Wt(i,d,N);return{...i,height:s}}}return o}))},[N,Wt]);const re=a.useCallback(t=>{ct(o=>o.filter(i=>i.id!==t)),Ct===t&&mt(null)},[Ct]),ae=a.useCallback(async t=>{if(!h||!$.current.get(P))return;const i=new FileReader;i.onload=d=>{const s=d.target?.result,f=new Image;f.onload=()=>{const Y=!s.startsWith("data:image/png")&&!s.startsWith("data:image/jpeg")&&!s.startsWith("data:image/jpg");let z=s;if(Y){const ot=document.createElement("canvas");ot.width=f.width,ot.height=f.height;const K=ot.getContext("2d");K&&(K.drawImage(f,0,0),z=ot.toDataURL("image/png"))}const V=.2,Z=f.width/f.height,nt=V/Z,L={id:`image-${Date.now()}`,type:"image",pageNumber:P,x:.4,y:.4,width:V,height:nt,rotation:0,imageData:z,imageWidth:f.width,imageHeight:f.height};Lt(L),T("select")},f.src=s},i.readAsDataURL(t)},[h,P,Lt,T]),le=a.useCallback(()=>{if(!X)return;const{pageNumber:t,rect:o,pageElement:i}=X;if(n)ct(d=>d.filter(s=>s.id!==n)),l(null),u(!1);else{const d=i.offsetWidth,s=i.offsetHeight,f=i.getBoundingClientRect(),Y=(o.left-f.left)/d,z=(o.top-f.top)/s,V=o.width/d,Z=o.height/s,nt={id:crypto.randomUUID(),type:"highlight",pageNumber:t,x:Math.max(0,Math.min(1,Y)),y:Math.max(0,Math.min(1,z)),width:Math.max(.01,Math.min(1,V)),height:Math.max(.01,Math.min(1,Z)),rotation:0,color:r,opacity:.4};ct(W=>[...W,nt]),l(nt.id),u(!0)}},[X,n,r]),ce=a.useCallback(t=>{S(t),n&&ct(o=>o.map(i=>i.id===n&&i.type==="highlight"?{...i,color:t}:i))},[n]),Vt=a.useCallback(async()=>{if(h)try{if(pt.length===0){const d=h.name;qt(h,d),await xt.trackPDFExport(!1);const s=xt.getCurrentDocumentId();s&&await xt.updateDocument(s,{has_export:!0});return}const t=await Me(h,pt,$.current),o=h.name.replace(".pdf","_annotated.pdf");qt(t,o),await xt.trackPDFExport(!0);const i=xt.getCurrentDocumentId();i&&await xt.updateDocument(i,{has_export:!0})}catch(t){console.error("Error saving PDF:",t),alert("Failed to save annotated PDF. Please check the console for details.")}},[h,pt]);a.useEffect(()=>{const t=()=>{gt&&gt()},o=()=>{Vt()};return window.addEventListener("pdf-new-session",t),window.addEventListener("pdf-download",o),()=>{window.removeEventListener("pdf-new-session",t),window.removeEventListener("pdf-download",o)}},[gt,Vt]);const de=a.useCallback(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy",M(!0)},[]),he=a.useCallback(t=>{t.preventDefault(),t.stopPropagation(),F.current?.contains(t.relatedTarget)||M(!1)},[]),ue=a.useCallback(async t=>{t.preventDefault(),t.stopPropagation();const i=Array.from(t.dataTransfer.files).filter(z=>z.type.startsWith("image/"));if(i.length===0||!F.current?.getBoundingClientRect())return;let s=P,f=.5,Y=.5;for(let z=1;z<=c;z++){const V=U.current.get(z);if(V){const Z=V.getBoundingClientRect();if(F.current?.getBoundingClientRect()){const W=t.clientX-Z.left,I=t.clientY-Z.top;if(W>=0&&W<=Z.width&&I>=0&&I<=Z.height){s=z;const L=$.current.get(z);L&&(f=W/(L.width*N),Y=I/(L.height*N));break}}}}for(const z of i){const V=new FileReader;V.onload=Z=>{const nt=Z.target?.result,W=new Image;W.onload=()=>{if(!$.current.get(s))return;const L=.2,ot=W.width/W.height,K=L/ot,Nt=Math.max(0,Math.min(1-L,f-L/2)),kt=Math.max(0,Math.min(1-K,Y-K/2)),Mt={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:s,x:Nt,y:kt,width:L,height:K,rotation:0,imageData:nt,imageWidth:W.width,imageHeight:W.height};Lt(Mt)},W.src=nt},V.readAsDataURL(z)}},[P,c,N,Lt]),[Bt,fe]=a.useState(()=>Yt(3)),[ge,Zt]=a.useState(!1);if(a.useEffect(()=>{let t=!0;return J&&Pe(3).then(o=>{t&&o&&o.length>0&&fe(o)}).catch(()=>{}),()=>{t=!1}},[J]),a.useEffect(()=>{if(J&&Bt&&Bt.length>0){const t=requestAnimationFrame(()=>Zt(!0));return()=>cancelAnimationFrame(t)}Zt(!1)},[J,Bt]),!h&&!b){const t=Bt;return e.jsx("div",{className:`pdf-viewer-empty ${g==="floating"?"float-layout":""}`,children:e.jsxs("div",{className:"start-page-content",children:[e.jsxs("div",{className:"start-top",children:[e.jsx("img",{src:Ee,alt:"ChatNote Logo",className:"start-logo"}),e.jsxs("div",{className:"upload-container",children:[e.jsxs("label",{htmlFor:"pdf-upload",className:"upload-button modern-upload",children:[e.jsx("span",{className:"upload-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 19V6M5 12l7-7 7 7"}),e.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1"})]})}),e.jsx("span",{children:"Upload PDF"})]}),e.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:jt,style:{display:"none"}})]})]}),J&&t.length>0&&e.jsxs("div",{className:"recent-pdf-suggestions",children:[e.jsx("div",{className:"suggestions-title",children:"Recent PDFs"}),e.jsx("div",{className:`suggestions-list ${ge?"show":""}`,children:t.map((o,i)=>e.jsxs("button",{className:"suggestion-card",onClick:()=>G&&G(o.pdfId),children:[e.jsx("span",{className:"suggestion-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsx("span",{className:"suggestion-name",children:o.displayName||o.originalFileName})]},o.pdfId||i))})]})]})})}return e.jsxs("div",{className:`pdf-viewer ${x?"saving-session":""}`,ref:ft,children:[b&&e.jsx("div",{className:"pdf-loading-overlay",children:e.jsxs("div",{className:"pdf-loading-spinner",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Loading PDF..."})]})}),x&&e.jsx("div",{className:"pdf-saving-overlay",children:e.jsxs("div",{className:"pdf-saving-content",children:[e.jsx("div",{className:"saving-spinner"}),e.jsx("p",{children:"Saving PDF..."}),e.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})}),e.jsx(je,{mode:H,onModeChange:T,highlightColor:r,onHighlightColorChange:ce,onHighlightClick:le,hasTextSelection:!!X,isHighlightActive:!!n,showColorPicker:j,onImageUpload:ae,onToggleLayout:rt,onClearAll:()=>{ct([]),mt(null)},pageNumber:P,numPages:c,onPrevPage:$t,onNextPage:_t,scale:N,onZoomIn:Tt,onZoomOut:Xt,onFitWidth:ne,onFitHeight:oe,layout:g,onZoomInputClick:Rt,isEditingZoom:at,zoomInputValue:tt,onZoomInputChange:Gt,onZoomInputBlur:Qt,onZoomInputKeyDown:te,onZoomInputPaste:ee,zoomInputRef:B}),e.jsx("div",{ref:F,className:`pdf-content ${v?"drag-over":""}`,onMouseUp:Ut,onKeyUp:Ut,onClick:se,onDragOver:de,onDragLeave:he,onDrop:t=>{M(!1),ue(t)},children:h&&e.jsx(xe,{file:ht||h,onLoadSuccess:Ft,onLoadError:Et,loading:e.jsx("div",{className:"loading",children:"Loading PDF..."}),error:e.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",e.jsx("br",{}),e.jsxs("small",{children:["Worker: ",Ht?.workerSrc||"Not set"]})]}),noData:e.jsx("div",{className:"loading",children:"No PDF file selected"}),options:St,children:Array.from(new Array(c),(t,o)=>{const i=o+1,d=$.current.get(i);return e.jsxs("div",{ref:s=>{s?U.current.set(i,s):U.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[e.jsx(we,{pageNumber:i,scale:N,devicePixelRatio:window.devicePixelRatio||1,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:s=>Pt({pageNumber:i,page:s})},`page_${i}_${lt}`),d&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{pageNumber:i,pageWidth:d.width,pageHeight:d.height,scale:N,annotations:pt,selectedAnnotationId:Ct,onAnnotationUpdate:ie,onAnnotationDelete:re,onAnnotationSelect:mt,mode:H}),y&&e.jsx(ke,{pageNumber:i,pageWidth:d.width,pageHeight:d.height,scale:N,knowledgeNotes:C,showKnowledgeNotes:y,layout:g,onNoteClick:st})]})]},`page-wrapper-${i}`)})})})]})}export{He as default};
