const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r as a,j as e,a as ue,D as ge,P as fe}from"./vendor-react-BWK-dEaB.js";import{_ as Kt,B as pe,C as me,a as mt}from"./index-vXsnyIAV.js";import{G as Bt}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-CLrFw-IM.js";const xe=({pageNumber:h,pageWidth:m,pageHeight:C,scale:f,annotations:_,selectedAnnotationId:D,onAnnotationUpdate:v,onAnnotationDelete:N,onAnnotationSelect:A,mode:rt})=>{const b=a.useRef(null),[V,at]=a.useState(!1),[y,G]=a.useState(!1),[w,gt]=a.useState(!1),[lt,ct]=a.useState({x:0,y:0}),[Q,c]=a.useState(null),[R,P]=a.useState(null),[ht,M]=a.useState({x:0,y:0,angle:0}),[E,dt]=a.useState(null),tt=_.filter(n=>n.pageNumber===h),et=n=>n*m*f,p=n=>n*C*f,B=n=>n*m*f,Z=n=>n*C*f,F=n=>n/(m*f),ut=n=>n/(C*f),xt=a.useCallback((n,l,j,u)=>{const r=1-j,k=1-u;return{x:Math.max(0,Math.min(r,n)),y:Math.max(0,Math.min(k,l)),width:Math.max(.01,Math.min(1,j)),height:Math.max(.01,Math.min(1,u))}},[]),O=a.useCallback((n,l,j,u)=>{const r=document.createElement("div");r.style.position="absolute",r.style.visibility="hidden",r.style.width=`${j}px`,r.style.fontSize=`${l*u}px`,r.style.fontFamily="inherit",r.style.whiteSpace="pre-wrap",r.style.wordWrap="break-word",r.style.overflowWrap="break-word",r.style.padding=`${4*u}px`,r.style.boxSizing="border-box",r.style.lineHeight="1.2",r.textContent=n||"Text",document.body.appendChild(r);const k=r.scrollHeight;return document.body.removeChild(r),k},[]),H=a.useCallback((n,l)=>{n.stopPropagation();const j=n.target;if(j.classList.contains("resize-handle")){n.preventDefault(),G(!0),c(j.dataset.handle||null);const r=b.current?.getBoundingClientRect();r&&(ct({x:n.clientX-r.left,y:n.clientY-r.top}),P({x:n.clientX-r.left,y:n.clientY-r.top,width:l.width,height:l.height,annotationX:l.x,annotationY:l.y}));return}if(j.classList.contains("rotate-handle")){n.preventDefault(),gt(!0);const r=b.current?.getBoundingClientRect();if(r){const k=et(l.x+l.width/2),x=p(l.y+l.height/2),S=n.clientX-r.left,ot=n.clientY-r.top,pt=Math.atan2(ot-x,S-k)*(180/Math.PI);M({x:S,y:ot,angle:l.rotation-pt})}return}if(j.classList.contains("delete-button")){n.preventDefault(),N(l.id);return}n.preventDefault(),A(l.id),at(!0);const u=b.current?.getBoundingClientRect();u&&ct({x:n.clientX-u.left-et(l.x),y:n.clientY-u.top-p(l.y)})},[rt,et,p,A,N]);a.useEffect(()=>{if(!V&&!y&&!w)return;const n=j=>{const u=b.current?.getBoundingClientRect();if(!u)return;const r=tt.find(k=>k.id===D);if(r){if(w){const k=et(r.x+r.width/2),x=p(r.y+r.height/2),S=j.clientX-u.left,ot=j.clientY-u.top,pt=Math.atan2(ot-x,S-k)*(180/Math.PI),wt=(ht.angle+pt)%360;Math.abs((r.rotation||0)-wt)>.01&&v({...r,rotation:wt})}else if(y&&Q&&R){const k=j.clientX-u.left,x=j.clientY-u.top,S=k-R.x,ot=x-R.y,pt=.5,wt=S/(m*f)*pt,kt=ot/(C*f)*pt;let Ct=R.annotationX,Ft=R.annotationY,Pt=R.width,Dt=R.height;Q.includes("n")&&(Ft=Math.max(0,R.annotationY+kt),Dt=Math.max(.01,R.height-kt)),Q.includes("s")&&(Dt=Math.max(.01,R.height+kt)),Q.includes("w")&&(Ct=Math.max(0,R.annotationX+wt),Pt=Math.max(.01,R.width-wt)),Q.includes("e")&&(Pt=Math.max(.01,R.width+wt));const yt=xt(Ct,Ft,Pt,Dt);if(r.type==="textbox"){const Et=r,It=B(yt.width),Tt=O(Et.text,Et.fontSize,It,f)/(C*f);if(Math.abs(Tt-yt.height)>.001){const $t=Math.max(.01,Math.min(1,Tt)),Rt=xt(Ct,Ft,yt.width,$t);(Math.abs((r.x||0)-Rt.x)>1e-4||Math.abs((r.y||0)-Rt.y)>1e-4||Math.abs((r.width||0)-Rt.width)>1e-4||Math.abs((r.height||0)-Rt.height)>1e-4)&&v({...r,...Rt})}else(Math.abs((r.x||0)-yt.x)>1e-4||Math.abs((r.y||0)-yt.y)>1e-4||Math.abs((r.width||0)-yt.width)>1e-4||Math.abs((r.height||0)-yt.height)>1e-4)&&v({...r,...yt})}else v({...r,...yt})}else if(V){const k=F(j.clientX-u.left-lt.x),x=ut(j.clientY-u.top-lt.y),S=xt(k,x,r.width,r.height);(Math.abs((r.x||0)-S.x)>1e-4||Math.abs((r.y||0)-S.y)>1e-4)&&v({...r,...S})}}},l=()=>{if(y&&D){const j=tt.find(u=>u.id===D);if(j&&j.type==="textbox"){const u=j,r=B(u.width),x=O(u.text,u.fontSize,r,f)/(C*f),S=xt(u.x,u.y,u.width,x);Math.abs(S.height-u.height)>.001&&v({...u,...S})}}at(!1),G(!1),gt(!1),c(null),P(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",l),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",l)}},[V,y,w,Q,R,lt,ht,D,tt,et,p,B,Z,F,ut,xt,O,v,m,C,f]),a.useEffect(()=>{const n=l=>{(l.key==="Delete"||l.key==="Backspace")&&D&&l.target.tagName!=="INPUT"&&l.target.tagName!=="TEXTAREA"&&(l.preventDefault(),N(D))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[D,N]);const U=n=>{const l=n.id===D,j=et(n.x),u=p(n.y),r=B(n.width),k=Z(n.height);return e.jsxs("div",{className:`annotation textbox-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${r}px`,height:`${k}px`,padding:`${4*f}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:x=>H(x,n),children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:x=>{x.stopPropagation(),N(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),E===n.id?e.jsx("textarea",{className:"textbox-input",value:n.text,onChange:x=>{v({...n,text:x.target.value})},onBlur:x=>{const S=x.relatedTarget;S&&(S.closest(".textbox-controls")!==null||S.closest(".textbox-font-size-input")!==null||S.classList.contains("textbox-font-size-input")||S.closest(".floating-textbox-toolbar")!==null||S.closest(".color-swatch")!==null||S.classList.contains("toolbar-icon"))||(dt(null),A(null))},onKeyDown:x=>{x.key==="Enter"&&!x.shiftKey&&(x.preventDefault(),dt(null),A(null)),x.key==="Escape"&&(dt(null),A(null))},style:{fontSize:`${n.fontSize*f}px`,color:n.color,width:`${r}px`,maxWidth:`${r}px`,height:`${k}px`,maxHeight:`${k}px`},autoFocus:!0}):e.jsx("div",{className:"textbox-content",onClick:x=>{x.stopPropagation();const S=x.target;S.closest(".textbox-controls")!==null||S.closest(".textbox-font-size-input")!==null||S.closest(".textbox-color-button")!==null||S.closest(".textbox-color-picker")!==null||dt(n.id)},style:{fontSize:`${n.fontSize*f}px`,color:n.color},children:n.text||"Text"})]},n.id)},Mt=n=>{const l=n.id===D,j=et(n.x),u=p(n.y),r=B(n.width),k=Z(n.height),x=n.width*m,S=n.height*C,ot=n.imageWidth/n.imageHeight,pt=x/S;let wt,kt;return ot>pt?(wt=r,kt=r/ot):(kt=k,wt=k*ot),e.jsxs("div",{className:`annotation image-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${wt}px`,height:`${kt}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:Ct=>H(Ct,n),children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:Ct=>{Ct.stopPropagation(),N(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),e.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},ft=n=>{const l=n.id===D,j=et(n.x),u=p(n.y),r=B(n.width),k=Z(n.height);return e.jsx("div",{className:`annotation highlight-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${r}px`,height:`${k}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:x=>H(x,n),children:l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:x=>{x.stopPropagation(),N(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]})},n.id)},bt=m*f,St=C*f,Y={width:`${bt}px`,height:`${St}px`,pointerEvents:"none"},I=tt.find(n=>n.id===D&&n.type==="textbox"),[L,nt]=a.useState(null);return a.useEffect(()=>{if(!I||!b.current){nt(null);return}const n=et(I.x),l=p(I.y);nt({left:n+B(I.width)/2,top:Math.max(0,l-40)})},[I,m,C,f,E]),e.jsxs("div",{ref:b,className:"annotation-layer",style:Y,children:[tt.map(n=>n.type==="textbox"?U(n):n.type==="image"?Mt(n):n.type==="highlight"?ft(n):null),I&&E===I.id&&L&&e.jsxs("div",{className:"floating-textbox-toolbar",style:{left:`${L.left}px`,top:`${L.top}px`,position:"absolute",zIndex:9999},onMouseDown:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"font-size-group",children:[e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=I.fontSize||16;v({...I,fontSize:Math.max(1,n-1)})},title:"Decrease font size",children:"−"}),e.jsx("span",{className:"font-size-display",children:I.fontSize||16}),e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=I.fontSize||16;v({...I,fontSize:Math.min(200,n+1)})},title:"Increase font size",children:"+"})]}),e.jsx("div",{className:"color-swatch-group",children:["#000000","#ff0000","#0000ff","#00ff00","#ffeb3b"].map(n=>e.jsx("button",{className:`color-swatch ${I.color===n?"active":""}`,style:{backgroundColor:n},onClick:()=>v({...I,color:n}),title:n},n))})]})]})},we=({mode:h,onModeChange:m,highlightColor:C="#ffeb3b",onHighlightColorChange:f,onHighlightClick:_,hasTextSelection:D=!1,isHighlightActive:v=!1,showColorPicker:N=!1,onImageUpload:A,layout:rt,onToggleLayout:b,onClearAll:V,pageNumber:at,numPages:y,onPrevPage:G,onNextPage:w,scale:gt,onZoomIn:lt,onZoomOut:ct,onFitWidth:Q,onFitHeight:c,onZoomInputClick:R,isEditingZoom:P,zoomInputValue:ht,onZoomInputChange:M,onZoomInputBlur:E,onZoomInputKeyDown:dt,onZoomInputPaste:tt,zoomInputRef:et})=>{const p=a.useRef(null),[B,Z]=a.useState(!1),F=a.useRef(null),ut=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];ue.useEffect(()=>{const H=U=>{B&&(U.target.closest(".clear-button")||(Z(!1),F.current&&(clearTimeout(F.current),F.current=null)))};if(B)return document.addEventListener("click",H),()=>{document.removeEventListener("click",H)}},[B]);const xt=H=>{const U=H.target.files?.[0];U&&U.type.startsWith("image/")&&A(U),m(null),p.current&&(p.current.value="")},O=H=>{H.stopPropagation(),B?(V&&V(),Z(!1),F.current&&(clearTimeout(F.current),F.current=null)):(Z(!0),F.current=setTimeout(()=>{Z(!1),F.current=null},3e3))};return e.jsxs("div",{className:"annotation-toolbar",children:[e.jsxs("div",{className:"toolbar-left",children:[e.jsxs("div",{className:"toolbar-section annotation-tools",children:[e.jsx("button",{className:`toolbar-button ${v?"active":""}`,onClick:_,disabled:!D,title:D?v?"Remove highlight":"Highlight text":"Select text to highlight",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),e.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),e.jsx("button",{className:`toolbar-button ${h==="textbox"?"active":""}`,onClick:()=>m("textbox"),title:"Add text box",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M4 7V4h16v3M9 20h6M12 4v16"})})}),e.jsx("button",{className:`toolbar-button ${h==="image"?"active":""}`,onClick:()=>{m("image"),p.current?.click()},title:"Add image",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]})}),V&&e.jsx("button",{className:`toolbar-button clear-button ${B?"confirming":""}`,onClick:O,title:B?"Click again to clear all":"Clear all",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),e.jsx("input",{ref:p,type:"file",accept:"image/*",onChange:xt,style:{display:"none"}})]}),N&&f&&e.jsx("div",{className:"toolbar-section color-picker",children:ut.map(H=>e.jsx("button",{className:`color-button ${C===H?"active":""}`,style:{backgroundColor:H},onClick:()=>f(H),title:"Highlight color"},H))})]}),e.jsxs("div",{className:"toolbar-center",children:[at!==void 0&&y!==void 0&&e.jsxs("div",{className:"toolbar-section pdf-navigation",children:[e.jsx("button",{className:"toolbar-button nav-button",onClick:G,disabled:at<=1,title:"Previous page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsxs("span",{className:"page-info",children:[at," / ",y]}),e.jsx("button",{className:"toolbar-button nav-button",onClick:w,disabled:at>=y,title:"Next page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),gt!==void 0&&e.jsxs("div",{className:"toolbar-section zoom-controls",children:[e.jsx("button",{onClick:Q,className:"toolbar-button",title:"Fit width",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"5 9 2 12 5 15"}),e.jsx("polyline",{points:"19 9 22 12 19 15"}),e.jsx("line",{x1:"2",y1:"12",x2:"22",y2:"12"})]})}),e.jsx("button",{onClick:c,className:"toolbar-button",title:"Fit height",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"9 5 12 2 15 5"}),e.jsx("polyline",{points:"9 19 12 22 15 19"}),e.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22"})]})}),e.jsx("button",{onClick:ct,className:"toolbar-button",title:"Zoom out",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),P?e.jsx("input",{ref:et,type:"text",inputMode:"numeric",value:ht,onChange:M,onBlur:E,onKeyDown:dt,onPaste:tt,className:"zoom-input"}):e.jsxs("span",{className:"zoom-level",onClick:R,title:"Click to edit zoom",children:[Math.round((gt||1)*100),"%"]}),e.jsx("button",{onClick:lt,className:"toolbar-button",title:"Zoom in",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]}),e.jsx("div",{className:"toolbar-right",children:e.jsx("div",{className:"toolbar-section toolbar-actions",children:e.jsx("button",{className:"toolbar-button layout-toggle-button",onClick:b,title:rt==="floating"?"Switch to split layout":"Switch to floating layout",children:rt==="floating"?e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]}):e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})})})]})},be=({pageNumber:h,pageWidth:m,pageHeight:C,scale:f,knowledgeNotes:_,showKnowledgeNotes:D,onNoteClick:v})=>{const N=_.filter(b=>b.pageNumber===h);if(!D||N.length===0)return null;const A=m*f,rt=C*f;return e.jsx("div",{className:"knowledge-note-connections",style:{width:`${A}px`,height:`${rt}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:e.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:N.map((b,V)=>{const at=A-25,y=25+V*35;return e.jsxs("g",{children:[e.jsx("circle",{cx:at,cy:y,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:G=>{G.stopPropagation(),v?.(b)},style:{cursor:"pointer",pointerEvents:"all"}}),e.jsx("text",{x:at,y,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:V+1}),e.jsx("line",{x1:at,y1:y+12,x2:at,y2:y+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},b.id)})})})};let Xt,zt=null,Vt=!1;async function ye(){if(!Xt)try{Xt=await Kt(()=>import("./vendor-CLrFw-IM.js").then(h=>h.o),__vite__mapDeps([0,1]))}catch(h){throw console.error("Failed to load pdf-lib:",h),new Error("PDF library not available. Please install pdf-lib.")}return Xt}async function ve(){if(!Vt){Vt=!0;try{const h=await Kt(()=>import("./vendor-CLrFw-IM.js").then(m=>m.p),__vite__mapDeps([0,1]));return h.default?zt=h.default:zt=h,zt&&typeof zt.create=="function"?zt:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(h){return console.warn("Failed to load fontkit, falling back to standard fonts:",h),null}}return zt}async function je(){try{const h=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],m="/ChatNote/",f=`${m.endsWith("/")?m:`${m}/`}NotoSans-Regular.ttf`;try{const _=await fetch(f);if(_.ok){const D=await _.arrayBuffer();if(D.byteLength>1e3){const v=new Uint8Array(D);if(v.length>=4&&v[0]===0&&v[1]===1&&v[2]===0&&v[3]===0)return D}}}catch{}for(const _ of h)if(!_.includes("fonts.googleapis.com/css"))try{const D=await fetch(_,{mode:"cors",cache:"default"});if(D.ok){const v=await D.arrayBuffer();if(v.byteLength>1e3){const N=new Uint8Array(v),A=N.length>=4&&N[0]===0&&N[1]===1&&N[2]===0&&N[3]===0,rt=N.length>=4&&N[0]===119&&N[1]===79&&N[2]===70&&N[3]===70,b=N.length>=4&&N[0]===119&&N[1]===79&&N[2]===70&&N[3]===50;if(A||rt||b)return v;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(h){return console.warn("Failed to load Unicode font:",h),null}}async function ke(h,m,C){try{const f=await ye(),{PDFDocument:_,rgb:D,degrees:v,StandardFonts:N}=f;if(!N)throw new Error("StandardFonts not available from pdf-lib");const A=await h.arrayBuffer(),rt=await _.load(A);let b=null;try{const y=await ve();if(y){try{rt.registerFontkit(y)}catch(w){(!w.message||!w.message.includes("already registered"))&&console.warn("Failed to register fontkit:",w)}const G=await je();if(G){const w=new Uint8Array(G),gt=w.length>=4&&w[0]===0&&w[1]===1&&w[2]===0&&w[3]===0,lt=w.length>=4&&w[0]===79&&w[1]===84&&w[2]===84&&w[3]===79,ct=w.length>=4&&w[0]===116&&w[1]===116&&w[2]===99&&w[3]===102,Q=w.length>=4&&w[0]===119&&w[1]===79&&w[2]===70&&w[3]===70,c=w.length>=4&&w[0]===119&&w[1]===79&&w[2]===70&&w[3]===50;Q||c?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):gt||lt||ct?b=await rt.embedFont(G):console.warn(`Invalid font format. File size: ${w.length} bytes`)}}}catch(y){console.warn("Failed to embed Unicode font, falling back to standard font:",y)}if(!b){const y=N.Helvetica||N.TimesRoman;if(!y)throw new Error("No standard font available");b=await rt.embedFont(y)}if(!b)throw new Error("Failed to embed font");const V=rt.getPages();for(const y of m){const G=V[y.pageNumber-1];if(!G)continue;const w=C.get(y.pageNumber);if(!w)continue;const{width:gt,height:lt}=w;let ct=y.width*gt,Q=y.height*lt;if(y.type==="textbox"){const c=y,R=Ce(c.color)||{r:0,g:0,b:0},P=y.x*gt,ht=y.y*lt;let M=(y.y+y.height)*lt;const E=4,dt=ct-E*2,tt=(c.text||"").trimEnd();let p=tt.split(/\r\n|\r|\n/).filter(Y=>Y!=null);for(;p.length>0&&p[p.length-1].length===0;)p.pop();if(p.length===0&&(p=[""]),p.length===1&&b&&typeof b.widthOfTextAtSize=="function"){const Y=p[0],I=dt;let L;try{L=b.widthOfTextAtSize(Y,c.fontSize)}catch{L=Y.length*c.fontSize*.5}if(L>I){const nt=[],n=Y.split(/(\s+)/);let l="";for(let j=0;j<n.length;j++){const u=n[j],r=l+u;let k;try{k=b.widthOfTextAtSize(r,c.fontSize)}catch{k=r.length*c.fontSize*.5}k<=I||l===""?l=r:(l.trim()&&nt.push(l.trim()),l=u)}l.trim()&&nt.push(l.trim()),nt.length>1&&(p=nt)}}const B=c.fontSize*1.2;Q=p.length>0?(p.length-1)*B+c.fontSize+E*2:c.fontSize+E*2,M=ht+Q;const ut=lt-M,O=lt-ht-ut,U=ut+O/2,Mt=c.fontSize*.2,ft=lt-c.fontSize*.2,bt=Math.max(Mt,Math.min(ft,U));if((p.length>1||tt.includes(`
`)||tt.includes("\r"))&&p.length>0)try{const Y=(p.length-1)*B,I=bt+Y/2;p.forEach((L,nt)=>{const n=I-nt*B;let l;try{b&&typeof b.widthOfTextAtSize=="function"?l=b.widthOfTextAtSize(L,c.fontSize):l=L.length*c.fontSize*.5}catch{l=L.length*c.fontSize*.5}let u=P+E+dt/2-l/2;const r=P+E,k=P+ct-l-E;u=Math.max(r,Math.min(k,u));const x=L.length>0?L:" ";G.drawText(x,{x:u,y:n,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:v(c.rotation),font:b})})}catch(Y){if(Y.message&&Y.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",Y.message);const I=p.map(n=>n.split("").map(l=>l.charCodeAt(0)>255?"?":l).join("")),L=(I.length-1)*B,nt=bt+L/2;try{I.forEach((n,l)=>{const j=nt-l*B;let u;try{b&&typeof b.widthOfTextAtSize=="function"?u=b.widthOfTextAtSize(n,c.fontSize):u=n.length*c.fontSize*.5}catch{u=n.length*c.fontSize*.5}let k=P+E+dt/2-u/2;const x=P+E,S=P+ct-u-E;k=Math.max(x,Math.min(S,k)),G.drawText(n,{x:k,y:j,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:v(c.rotation),font:b})})}catch(n){console.error("Failed to draw text even after replacing Unicode characters:",n);continue}}else throw Y}else{let Y;try{b&&typeof b.widthOfTextAtSize=="function"?Y=b.widthOfTextAtSize(c.text,c.fontSize):Y=c.text.length*c.fontSize*.5}catch{Y=c.text.length*c.fontSize*.5}let L=P+E+dt/2-Y/2;const nt=P+E,n=P+ct-Y-E;L=Math.max(nt,Math.min(n,L));try{G.drawText(c.text,{x:L,y:bt,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:v(c.rotation),font:b})}catch(l){if(l.message&&l.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",l.message);const j=c.text.split("").map(u=>u.charCodeAt(0)>255?"?":u).join("");try{G.drawText(j,{x:L,y:bt,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:v(c.rotation),font:b})}catch(u){console.error("Failed to draw text even after replacing Unicode characters:",u);continue}}else throw l}}}else if(y.type==="image"){const c=y,R=await fetch(c.imageData).then(F=>F.arrayBuffer());let P;if(c.imageData.startsWith("data:image/png"))P=await rt.embedPng(R);else if(c.imageData.startsWith("data:image/jpeg")||c.imageData.startsWith("data:image/jpg"))P=await rt.embedJpg(R);else throw console.error("Unsupported image format for PDF embedding:",c.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const ht=c.imageWidth/c.imageHeight;let M=ct,E=Q;ct/Q>ht?M=Q*ht:E=ct/ht;const tt=y.x*gt,et=(y.y+y.height)*lt,Z=lt-et+(Q-E)/2;G.drawImage(P,{x:tt,y:Z,width:M,height:E,rotate:v(c.rotation)})}}const at=await rt.save();return new Blob([at],{type:"application/pdf"})}catch(f){throw console.error("Error saving annotated PDF:",f),new Error("Failed to save annotated PDF")}}function Ce(h){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:null}function Zt(h,m="annotated.pdf"){const C=URL.createObjectURL(h),f=document.createElement("a");f.href=C,f.download=m,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(C)}const Yt="chatnote_pdf_history_cache",Ne=300*1e3;function Ht(h=3){const m=localStorage.getItem(Yt);let C=[];try{if(m){const f=JSON.parse(m);f&&Array.isArray(f.pdfs)&&(C=f.pdfs.slice(0,h))}}catch{}return C}function Me(h){try{const m={pdfs:h,timestamp:Date.now()};localStorage.setItem(Yt,JSON.stringify(m))}catch{}}function Se(h=Ne){try{const m=localStorage.getItem(Yt);if(!m)return!1;const C=JSON.parse(m);return!C||typeof C.timestamp!="number"?!1:Date.now()-C.timestamp<h}catch{return!1}}async function De(h=3){try{const m=localStorage.getItem("auth_token");if(!m)return Ht(h);const C=Ht(h),f=Se(),_=fetch(`${pe}/api/drive/history`,{headers:{Authorization:`Bearer ${m}`}}).then(async v=>{if(!v.ok){if(v.status===403){try{localStorage.removeItem(Yt)}catch{}return[]}return[]}const A=(await v.json()).pdfs||[];return Me(A),A.slice(0,h)}).catch(()=>[]);if(f)return _.catch(()=>{}),C;const D=await _;return D.length>0?D:C}catch{return Ht(h)}}const Re="/ChatNote/assets/chatnote-logo-BGY00N4J.svg";function Te({file:h,onFileUpload:m,onTextSelection:C,layout:f="floating",onPageChange:_,onTotalPagesChange:D,showKnowledgeNotes:v=!0,knowledgeNotes:N=[],onScrollToPage:A,onNoteClick:rt,onAddAnnotation:b,initialAnnotations:V=[],onAnnotationsChange:at,isLoadingPdf:y=!1,onLoadingComplete:G,isSavingSession:w=!1,onNewSession:gt,onToggleLayout:lt,isDriveAuthorized:ct,onSelectRecentPdf:Q}){const[c,R]=a.useState(0),[P,ht]=a.useState(1),[M,E]=a.useState(1),[dt,tt]=a.useState(!1),[et,p]=a.useState("100"),B=a.useRef(null),Z=a.useRef(new Map),F=a.useRef(null),ut=a.useRef(null),xt=a.useRef(!1),O=a.useRef(new Map),[H,U]=a.useState(V),[Mt,ft]=a.useState(null),[bt,St]=a.useState(null),[Y,I]=a.useState(null),[L,nt]=a.useState(null),[n,l]=a.useState(!1),[j,u]=a.useState("#ffeb3b"),[r,k]=a.useState(!1),x=a.useRef(V),S=a.useRef(at);a.useEffect(()=>{S.current=at},[at]),a.useEffect(()=>{const t=x.current,o=V.length!==t.length||V.some((i,d)=>i.id!==t[d]?.id);V&&V.length>0&&o?(U(V),x.current=V):h&&V.length===0&&t.length>0?(U([]),x.current=[],ft(null)):!h&&t.length>0&&(U([]),x.current=[],ft(null))},[V,h]),a.useEffect(()=>{JSON.stringify(x.current)!==JSON.stringify(H)&&S.current&&(x.current=H,S.current(H))},[H]),a.useEffect(()=>{const t=console.warn,o=console.error;return console.warn=(...i)=>{const d=i.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")||i.some(s=>typeof s=="string"&&(s.includes("TextLayer task cancelled")||s.includes("AbortException")))||t.apply(console,i)},console.error=(...i)=>{const d=i.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")&&d.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=t,console.error=o}},[]);const ot=a.useMemo(()=>h?URL.createObjectURL(h):null,[h]),pt=a.useRef(null);a.useEffect(()=>(pt.current&&pt.current!==ot&&URL.revokeObjectURL(pt.current),pt.current=ot,()=>{ot&&URL.revokeObjectURL(ot)}),[ot]);const wt=a.useMemo(()=>{let t;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";t=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Bt&&(Bt.workerSrc=t,Bt.standardFontDataUrl=o),{workerSrc:t,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),kt=({numPages:t})=>{R(t),D?.(t);const o=1;ht(o),setTimeout(()=>{_?.(o)},0),Z.current.clear(),O.current.clear(),G&&setTimeout(()=>{G()},300)},Ct=t=>{if(!O.current.has(t.pageNumber))try{const o=t.page;let i,d;o.viewport?(i=o.viewport.width,d=o.viewport.height):(i=o.width/M,d=o.height/M),O.current.set(t.pageNumber,{width:i,height:d})}catch(o){console.warn("Error getting page dimensions:",o);const i=t.page,d=i.width/M,s=i.height/M;O.current.set(t.pageNumber,{width:d,height:s})}};a.useEffect(()=>{if(!F.current||c===0)return;let t=null,o=!1;const i=()=>{if(xt.current||o||t)return;o=!0,t=setTimeout(()=>{t=null,o=!1},100);const s=F.current;if(!s){o=!1;return}const g=s.getBoundingClientRect(),$=g.top,z=g.height,K=$+z/2;if(s.scrollTop<100){ht(X=>X!==1?(setTimeout(()=>{_?.(1)},0),1):X);return}let st=1,W=0;for(let X=1;X<=c;X++){const T=Z.current.get(X);if(T){const it=T.getBoundingClientRect(),J=s.getBoundingClientRect(),jt=Math.max(J.top,it.top),vt=Math.min(J.bottom,it.bottom),Nt=Math.max(0,vt-jt);Nt>W&&(W=Nt,st=X)}}if(W<z*.1){let X=1,T=1/0;for(let it=1;it<=c;it++){const J=Z.current.get(it);if(J){const jt=J.getBoundingClientRect(),vt=jt.top+jt.height/2,Nt=Math.abs(vt-K);Nt<T&&(T=Nt,X=it)}}st=X}ht(X=>st!==X?(setTimeout(()=>{_?.(st)},0),st):X)},d=F.current;return d?.addEventListener("scroll",i,{passive:!0}),()=>{t&&clearTimeout(t),d?.removeEventListener("scroll",i)}},[c,_]);const Ft=t=>{console.error("PDF load error:",t)},Pt=async t=>{const o=t.target.files?.[0];if(o&&o.type==="application/pdf"){m(o);const i=o.size/(1024*1024),d=mt.generateDocumentId();mt.setCurrentDocument(d),await mt.createDocument(d,i),await mt.trackPDFUpload(i,d)}},Dt=a.useCallback(t=>{const o=Z.current.get(t);o&&F.current&&(xt.current=!0,ht(t),_?.(t),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{xt.current=!1},1500))},[_]);a.useEffect(()=>(A&&(window.__pdfScrollToPage=Dt),F.current&&(window.__pdfContentRef=F.current),ut.current&&(window.__pdfViewerHeight=ut.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Dt,A,c,M]);const yt=()=>{const t=Math.max(1,P-1);Dt(t)},Et=()=>{const t=Math.min(c,P+1);Dt(t)},It=()=>{const t=Math.min(M+.2,5);E(t),p(Math.round(t*100).toString())},Ot=()=>{const t=Math.max(M-.2,.25);E(t),p(Math.round(t*100).toString())};a.useEffect(()=>{dt||p(Math.round(M*100).toString())},[M,dt]);const Tt=()=>{tt(!0),p(Math.round(M*100).toString())},$t=t=>{let o=t.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),p(o)},Rt=()=>{_t()},qt=t=>{if(t.key==="Enter")t.preventDefault(),_t();else if(t.key==="Escape")tt(!1),p(Math.round(M*100).toString()),B.current?.blur();else{if(t.key==="Backspace"||t.key==="Delete"||t.key==="ArrowLeft"||t.key==="ArrowRight"||t.key==="Tab")return;(t.key==="-"||t.key==="+"||t.key==="."||t.key===","||t.key==="e"||t.key==="E"||!/[0-9]/.test(t.key)&&!t.ctrlKey&&!t.metaKey)&&t.preventDefault()}},Jt=t=>{t.preventDefault();const i=t.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const s=(i.replace(/^0+/,"")||"0").slice(0,3);if(p(s),s&&s!=="0"){const g=parseInt(s,10);if(!isNaN(g)&&g>0){const $=Math.max(25,Math.min(500,g)),z=$/100;E(z),p($.toString()),tt(!1)}}}},_t=()=>{if(et.trim()===""||et==="0"){p(Math.round(M*100).toString()),tt(!1);return}const t=parseInt(et,10);if(isNaN(t)||t<=0){p(Math.round(M*100).toString()),tt(!1);return}const o=Math.max(25,Math.min(500,t)),i=o/100;E(i),p(o.toString()),tt(!1)};a.useEffect(()=>{dt&&B.current&&(B.current.focus(),B.current.select())},[dt]);const Gt=()=>{if(O.current.size===0)return;let t=null;if(F.current){const s=F.current,g=getComputedStyle(s),$=parseFloat(g.paddingLeft||"0")||0,z=parseFloat(g.paddingRight||"0")||0;t=s.clientWidth-$-z,s.scrollHeight>s.clientHeight&&(t-=12),t=Math.max(0,t-4)}else if(ut.current){const s=ut.current.getBoundingClientRect();t=Math.max(0,s.width-40)}if(!t||t<=0)return;const o=O.current.get(1);if(!o)return;const i=t/o.width*.999,d=Math.max(.1,Math.min(i,5));E(d),p(Math.round(d*100).toString())},Qt=()=>{if(!ut.current||O.current.size===0)return;const t=ut.current.getBoundingClientRect();let o=0;const i=ut.current.querySelector(".annotation-toolbar");i&&(o=i.getBoundingClientRect().height);const d=t.height-o,s=O.current.get(P);if(!s)return;const g=d/s.height,$=Math.max(.1,Math.min(g,5));E($),p(Math.round($*100).toString())},Ut=a.useCallback(()=>{const t=window.getSelection();if(t&&t.toString().trim()){const o=t.toString().trim();let i,d;if(t.rangeCount>0&&F.current){const g=t.getRangeAt(0).getBoundingClientRect(),$=F.current.getBoundingClientRect(),z=g.top-$.top+F.current.scrollTop;for(let K=1;K<=c;K++){const q=Z.current.get(K);if(q){const st=q.offsetTop,W=q.offsetHeight,X=st+W;if(z>=st&&z<=X){d=K;const T=(z-st)/W;i=Math.max(0,Math.min(1,T)),I({text:o,pageNumber:K,rect:g,pageElement:q});const it=H.find(J=>J.type==="highlight"&&J.pageNumber===K&&Math.abs(J.x-Math.max(0,Math.min(1,(g.left-q.getBoundingClientRect().left)/q.offsetWidth)))<.01&&Math.abs(J.y-Math.max(0,Math.min(1,T)))<.01);nt(it?.id||null);break}}}}C(o,d,i)}else C("",void 0,void 0),I(null),nt(null),l(!1)},[C,c,H]),te=a.useCallback(t=>{const o=t.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.closest(".floating-textbox-toolbar")!==null||o.closest(".color-swatch")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker")||o.classList.contains("floating-textbox-toolbar")||o.classList.contains("color-swatch"))return;const d=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const s=window.getSelection(),g=s&&s.toString().trim().length>0;if(g||C(""),!d&&!g&&ft(null),bt==="textbox"&&!d&&!g){const $=F.current;if(!$)return;let z=P,K=.5,q=.5;for(let W=1;W<=c;W++){const X=Z.current.get(W);if(X){const T=X.getBoundingClientRect();if($.getBoundingClientRect()){const J=t.clientX-T.left,jt=t.clientY-T.top;if(J>=0&&J<=T.width&&jt>=0&&jt<=T.height){z=W;const vt=O.current.get(W);if(vt){const Nt=T.width/vt.width,he=T.height/vt.height;K=J/(vt.width*Nt),q=jt/(vt.height*he)}break}}}}if(O.current.get(z)){const W=Math.max(0,Math.min(.8,K-.1)),X=Math.max(0,Math.min(1-.1,q-.05)),T={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:z,x:W,y:X,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:me[0]};U(it=>[...it,T]),ft(T.id),St("select")}}},100)},[C,bt,P,c,M,ft,St,U]),Lt=a.useCallback(t=>{U(d=>[...d,t]),ft(t.id);let o="text";t.type==="highlight"?o="highlight":t.type==="image"?o="image":t.type==="textbox"&&(o="text"),mt.trackAnnotationAdded(o);const i=mt.getCurrentDocumentId();i&&mt.updateDocument(i,{has_annotations:!0})},[]);a.useEffect(()=>(b&&(window.__addPDFAnnotation=t=>{U(o=>[...o,t]),ft(t.id),t.pageNumber&&A&&A(t.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[b,A]);const Wt=a.useCallback((t,o,i)=>{const d=t.width*o.width*i,s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${d}px`,s.style.fontSize=`${t.fontSize*i}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*i}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=t.text||"Text",document.body.appendChild(s);const g=s.scrollHeight;document.body.removeChild(s);const $=g/(o.height*i);return Math.max(.01,Math.min(1,$))},[]),ee=a.useCallback(t=>{U(o=>{let i=!1;const d=o.map(s=>{if(s.id!==t.id)return s;if(t.type==="textbox"){const g=t,$=O.current.get(g.pageNumber);if($){const z=Wt(g,$,M);return Math.abs((s.height||0)-z)>1e-4||Math.abs((s.x||0)-(g.x||0))>1e-4||Math.abs((s.y||0)-(g.y||0))>1e-4||Math.abs((s.width||0)-(g.width||0))>1e-4||Math.abs((s.rotation||0)-(g.rotation||0))>1e-4||s.type==="textbox"&&(s.text!==g.text||s.color!==g.color||s.fontSize!==g.fontSize)?(i=!0,{...g,height:z}):s}}return Math.abs((s.x||0)-(t.x||0))>1e-4||Math.abs((s.y||0)-(t.y||0))>1e-4||Math.abs((s.width||0)-(t.width||0))>1e-4||Math.abs((s.height||0)-(t.height||0))>1e-4||Math.abs((s.rotation||0)-(t.rotation||0))>1e-4||"color"in s&&"color"in t&&s.color!==t.color?(i=!0,t):s});return i?d:o})},[M,Wt]);a.useEffect(()=>{U(t=>t.map(o=>{if(o.type==="textbox"){const i=o,d=O.current.get(i.pageNumber);if(d){const s=Wt(i,d,M);return{...i,height:s}}}return o}))},[M,Wt]);const ne=a.useCallback(t=>{U(o=>o.filter(i=>i.id!==t)),Mt===t&&ft(null)},[Mt]),oe=a.useCallback(async t=>{if(!h||!O.current.get(P))return;const i=new FileReader;i.onload=d=>{const s=d.target?.result,g=new Image;g.onload=()=>{const $=!s.startsWith("data:image/png")&&!s.startsWith("data:image/jpeg")&&!s.startsWith("data:image/jpg");let z=s;if($){const it=document.createElement("canvas");it.width=g.width,it.height=g.height;const J=it.getContext("2d");J&&(J.drawImage(g,0,0),z=it.toDataURL("image/png"))}const K=.2,q=g.width/g.height,st=K/q,T={id:`image-${Date.now()}`,type:"image",pageNumber:P,x:.4,y:.4,width:K,height:st,rotation:0,imageData:z,imageWidth:g.width,imageHeight:g.height};Lt(T),St("select")},g.src=s},i.readAsDataURL(t)},[h,P,Lt,St]),se=a.useCallback(()=>{if(!Y)return;const{pageNumber:t,rect:o,pageElement:i}=Y;if(L)U(d=>d.filter(s=>s.id!==L)),nt(null),l(!1);else{const d=i.offsetWidth,s=i.offsetHeight,g=i.getBoundingClientRect(),$=(o.left-g.left)/d,z=(o.top-g.top)/s,K=o.width/d,q=o.height/s,st={id:crypto.randomUUID(),type:"highlight",pageNumber:t,x:Math.max(0,Math.min(1,$)),y:Math.max(0,Math.min(1,z)),width:Math.max(.01,Math.min(1,K)),height:Math.max(.01,Math.min(1,q)),rotation:0,color:j,opacity:.4};U(W=>[...W,st]),nt(st.id),l(!0)}},[Y,L,j]),ie=a.useCallback(t=>{u(t),L&&U(o=>o.map(i=>i.id===L&&i.type==="highlight"?{...i,color:t}:i))},[L]),At=a.useCallback(async()=>{if(h)try{if(H.length===0){const d=h.name;Zt(h,d),await mt.trackPDFExport(!1);const s=mt.getCurrentDocumentId();s&&await mt.updateDocument(s,{has_export:!0});return}const t=await ke(h,H,O.current),o=h.name.replace(".pdf","_annotated.pdf");Zt(t,o),await mt.trackPDFExport(!0);const i=mt.getCurrentDocumentId();i&&await mt.updateDocument(i,{has_export:!0})}catch(t){console.error("Error saving PDF:",t),alert("Failed to save annotated PDF. Please check the console for details.")}},[h,H]);a.useEffect(()=>{const t=()=>{gt&&gt()},o=()=>{At()};return window.addEventListener("pdf-new-session",t),window.addEventListener("pdf-download",o),()=>{window.removeEventListener("pdf-new-session",t),window.removeEventListener("pdf-download",o)}},[gt,At]);const re=a.useCallback(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy",k(!0)},[]),ae=a.useCallback(t=>{t.preventDefault(),t.stopPropagation(),F.current?.contains(t.relatedTarget)||k(!1)},[]),le=a.useCallback(async t=>{t.preventDefault(),t.stopPropagation();const i=Array.from(t.dataTransfer.files).filter(z=>z.type.startsWith("image/"));if(i.length===0||!F.current?.getBoundingClientRect())return;let s=P,g=.5,$=.5;for(let z=1;z<=c;z++){const K=Z.current.get(z);if(K){const q=K.getBoundingClientRect();if(F.current?.getBoundingClientRect()){const W=t.clientX-q.left,X=t.clientY-q.top;if(W>=0&&W<=q.width&&X>=0&&X<=q.height){s=z;const T=O.current.get(z);T&&(g=W/(T.width*M),$=X/(T.height*M));break}}}}for(const z of i){const K=new FileReader;K.onload=q=>{const st=q.target?.result,W=new Image;W.onload=()=>{if(!O.current.get(s))return;const T=.2,it=W.width/W.height,J=T/it,jt=Math.max(0,Math.min(1-T,g-T/2)),vt=Math.max(0,Math.min(1-J,$-J/2)),Nt={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:s,x:jt,y:vt,width:T,height:J,rotation:0,imageData:st,imageWidth:W.width,imageHeight:W.height};Lt(Nt)},W.src=st},K.readAsDataURL(z)}},[P,c,M,Lt]),[ce,de]=a.useState(()=>Ht(3));if(a.useEffect(()=>{let t=!0;return ct&&De(3).then(o=>{t&&o&&o.length>0&&de(o)}).catch(()=>{}),()=>{t=!1}},[ct]),!h&&!y){const t=ce;return e.jsx("div",{className:`pdf-viewer-empty ${f==="floating"?"float-layout":""}`,children:e.jsxs("div",{className:"start-page-content",children:[e.jsx("img",{src:Re,alt:"ChatNote Logo",className:"start-logo"}),e.jsxs("div",{className:"upload-container",children:[e.jsxs("label",{htmlFor:"pdf-upload",className:"upload-button modern-upload",children:[e.jsx("span",{className:"upload-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 19V6M5 12l7-7 7 7"}),e.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1"})]})}),e.jsx("span",{children:"Upload PDF"})]}),e.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Pt,style:{display:"none"}})]}),ct&&t.length>0&&e.jsxs("div",{className:"recent-pdf-suggestions",children:[e.jsx("div",{className:"suggestions-title",children:"Recent PDFs"}),e.jsx("div",{className:"suggestions-list",children:t.map((o,i)=>e.jsxs("button",{className:"suggestion-card",onClick:()=>Q&&Q(o.pdfId),children:[e.jsx("span",{className:"suggestion-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsx("span",{className:"suggestion-name",children:o.displayName||o.originalFileName})]},o.pdfId||i))})]})]})})}return e.jsxs("div",{className:`pdf-viewer ${w?"saving-session":""}`,ref:ut,children:[y&&e.jsx("div",{className:"pdf-loading-overlay",children:e.jsxs("div",{className:"pdf-loading-spinner",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Loading PDF..."})]})}),w&&e.jsx("div",{className:"pdf-saving-overlay",children:e.jsxs("div",{className:"pdf-saving-content",children:[e.jsx("div",{className:"saving-spinner"}),e.jsx("p",{children:"Saving PDF..."}),e.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})}),e.jsx(we,{mode:bt,onModeChange:St,highlightColor:j,onHighlightColorChange:ie,onHighlightClick:se,hasTextSelection:!!Y,isHighlightActive:!!L,showColorPicker:n,onImageUpload:oe,onToggleLayout:lt,onClearAll:()=>{U([]),ft(null)},pageNumber:P,numPages:c,onPrevPage:yt,onNextPage:Et,scale:M,onZoomIn:It,onZoomOut:Ot,onFitWidth:Gt,onFitHeight:Qt,layout:f,onZoomInputClick:Tt,isEditingZoom:dt,zoomInputValue:et,onZoomInputChange:$t,onZoomInputBlur:Rt,onZoomInputKeyDown:qt,onZoomInputPaste:Jt,zoomInputRef:B}),e.jsx("div",{ref:F,className:`pdf-content ${r?"drag-over":""}`,onMouseUp:Ut,onKeyUp:Ut,onClick:te,onDragOver:re,onDragLeave:ae,onDrop:t=>{k(!1),le(t)},children:h&&e.jsx(ge,{file:ot||h,onLoadSuccess:kt,onLoadError:Ft,loading:e.jsx("div",{className:"loading",children:"Loading PDF..."}),error:e.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",e.jsx("br",{}),e.jsxs("small",{children:["Worker: ",Bt?.workerSrc||"Not set"]})]}),noData:e.jsx("div",{className:"loading",children:"No PDF file selected"}),options:wt,children:Array.from(new Array(c),(t,o)=>{const i=o+1,d=O.current.get(i);return e.jsxs("div",{ref:s=>{s?Z.current.set(i,s):Z.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[e.jsx(fe,{pageNumber:i,scale:M,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:s=>Ct({pageNumber:i,page:s})},`page_${i}`),d&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{pageNumber:i,pageWidth:d.width,pageHeight:d.height,scale:M,annotations:H,selectedAnnotationId:Mt,onAnnotationUpdate:ee,onAnnotationDelete:ne,onAnnotationSelect:ft,mode:bt}),v&&e.jsx(be,{pageNumber:i,pageWidth:d.width,pageHeight:d.height,scale:M,knowledgeNotes:N,showKnowledgeNotes:v,layout:f,onNoteClick:rt})]})]},`page-wrapper-${i}`)})})})]})}export{Te as default};
