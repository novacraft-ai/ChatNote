const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-DOxxWhKm.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r,j as t,D as yt,P as vt}from"./vendor-react-DcdzPjWq.js";import{_ as nt,C as kt,a as xe,g as Je,p as jt,P as Qe}from"./index-BbKWuH5y.js";import{G as Ie}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-DOxxWhKm.js";const Ct=({pageNumber:d,pageWidth:E,pageHeight:$,scale:k,annotations:ue,selectedAnnotationId:C,onAnnotationUpdate:S,onAnnotationDelete:M,onAnnotationSelect:fe,mode:K})=>{const x=r.useRef(null),[be,X]=r.useState(!1),[w,G]=r.useState(!1),[b,ye]=r.useState(!1),[ee,ge]=r.useState({x:0,y:0}),[U,h]=r.useState(null),[m,ne]=r.useState(null),[A,we]=r.useState({x:0,y:0,angle:0}),[f,oe]=r.useState(null),se=ue.filter(n=>n.pageNumber===d),[J,Y]=r.useState(()=>({width:E*k,height:$*k,offsetLeft:0,offsetTop:0})),P=r.useCallback(()=>{const n=x.current?.parentElement;if(!n)return;const c=n.querySelector(".react-pdf__Page");if(!c)return;const g=n.getBoundingClientRect(),u=c.getBoundingClientRect();!u.width||!u.height||Y(a=>{const F=Math.abs(a.width-u.width)>.5,v=Math.abs(a.height-u.height)>.5,R=Math.abs(a.offsetLeft-(u.left-g.left))>.5||Math.abs(a.offsetTop-(u.top-g.top))>.5;return F||v||R?{width:u.width,height:u.height,offsetLeft:u.left-g.left,offsetTop:u.top-g.top}:a})},[]);r.useEffect(()=>{P();const n=x.current?.parentElement;if(n&&typeof ResizeObserver<"u"){const g=new ResizeObserver(()=>P());return g.observe(n),()=>g.disconnect()}const c=()=>P();return window.addEventListener("resize",c),()=>{window.removeEventListener("resize",c)}},[P,E,$,k]),r.useEffect(()=>{P()},[k,E,$,P]);const I=n=>n*J.width,B=n=>n*J.height,N=n=>n*J.width,he=n=>n*J.height,Ce=n=>n/J.width,V=n=>n/J.height,re=r.useCallback((n,c,g,u)=>{const a=1-g,F=1-u;return{x:Math.max(0,Math.min(a,n)),y:Math.max(0,Math.min(F,c)),width:Math.max(.01,Math.min(1,g)),height:Math.max(.01,Math.min(1,u))}},[]),Se=r.useCallback((n,c,g,u)=>{const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.width=`${g}px`,a.style.fontSize=`${c*u}px`,a.style.fontFamily="inherit",a.style.whiteSpace="pre-wrap",a.style.wordWrap="break-word",a.style.overflowWrap="break-word",a.style.padding=`${4*u}px`,a.style.boxSizing="border-box",a.style.lineHeight="1.2",a.textContent=n||"Text",document.body.appendChild(a);const F=a.scrollHeight;return document.body.removeChild(a),F},[]),ae=r.useCallback((n,c)=>{n.stopPropagation();const g=n.target;if(g.classList.contains("resize-handle")){n.preventDefault(),G(!0),h(g.dataset.handle||null);const a=x.current?.getBoundingClientRect();a&&(ge({x:n.clientX-a.left,y:n.clientY-a.top}),ne({x:n.clientX-a.left,y:n.clientY-a.top,width:c.width,height:c.height,annotationX:c.x,annotationY:c.y}));return}if(g.classList.contains("rotate-handle")){n.preventDefault(),ye(!0);const a=x.current?.getBoundingClientRect();if(a){const F=I(c.x+c.width/2),v=B(c.y+c.height/2),R=n.clientX-a.left,ce=n.clientY-a.top,ve=Math.atan2(ce-v,R-F)*(180/Math.PI);we({x:R,y:ce,angle:c.rotation-ve})}return}if(g.classList.contains("delete-button")){n.preventDefault(),M(c.id);return}n.preventDefault(),fe(c.id),X(!0);const u=x.current?.getBoundingClientRect();u&&ge({x:n.clientX-u.left-I(c.x),y:n.clientY-u.top-B(c.y)})},[K,I,B,fe,M]);r.useEffect(()=>{if(!be&&!w&&!b)return;const n=g=>{const u=x.current?.getBoundingClientRect();if(!u)return;const a=se.find(F=>F.id===C);if(a){if(b){const F=I(a.x+a.width/2),v=B(a.y+a.height/2),R=g.clientX-u.left,ce=g.clientY-u.top,ve=Math.atan2(ce-v,R-F)*(180/Math.PI),ke=(A.angle+ve)%360;Math.abs((a.rotation||0)-ke)>.01&&S({...a,rotation:ke})}else if(w&&U&&m){const F=g.clientX-u.left,v=g.clientY-u.top,R=F-m.x,ce=v-m.y,ve=.5,ke=R/(E*k)*ve,Re=ce/($*k)*ve;let De=m.annotationX,Fe=m.annotationY,Le=m.width,Ee=m.height;U.includes("n")&&(Fe=Math.max(0,m.annotationY+Re),Ee=Math.max(.01,m.height-Re)),U.includes("s")&&(Ee=Math.max(.01,m.height+Re)),U.includes("w")&&(De=Math.max(0,m.annotationX+ke),Le=Math.max(.01,m.width-ke)),U.includes("e")&&(Le=Math.max(.01,m.width+ke));const Me=re(De,Fe,Le,Ee);if(a.type==="textbox"){const Be=a,Oe=N(Me.width),He=Se(Be.text,Be.fontSize,Oe,k)/($*k);if(Math.abs(He-Me.height)>.001){const _e=Math.max(.01,Math.min(1,He)),Pe=re(De,Fe,Me.width,_e);(Math.abs((a.x||0)-Pe.x)>1e-4||Math.abs((a.y||0)-Pe.y)>1e-4||Math.abs((a.width||0)-Pe.width)>1e-4||Math.abs((a.height||0)-Pe.height)>1e-4)&&S({...a,...Pe})}else(Math.abs((a.x||0)-Me.x)>1e-4||Math.abs((a.y||0)-Me.y)>1e-4||Math.abs((a.width||0)-Me.width)>1e-4||Math.abs((a.height||0)-Me.height)>1e-4)&&S({...a,...Me})}else S({...a,...Me})}else if(be){const F=Ce(g.clientX-u.left-ee.x),v=V(g.clientY-u.top-ee.y),R=re(F,v,a.width,a.height);(Math.abs((a.x||0)-R.x)>1e-4||Math.abs((a.y||0)-R.y)>1e-4)&&S({...a,...R})}}},c=()=>{if(w&&C){const g=se.find(u=>u.id===C);if(g&&g.type==="textbox"){const u=g,a=N(u.width),v=Se(u.text,u.fontSize,a,k)/($*k),R=re(u.x,u.y,u.width,v);Math.abs(R.height-u.height)>.001&&S({...u,...R})}}X(!1),G(!1),ye(!1),h(null),ne(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",c),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",c)}},[be,w,b,U,m,ee,A,C,se,I,B,N,he,Ce,V,re,Se,S,E,$,k]),r.useEffect(()=>{const n=c=>{(c.key==="Delete"||c.key==="Backspace")&&C&&c.target.tagName!=="INPUT"&&c.target.tagName!=="TEXTAREA"&&(c.preventDefault(),M(C))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[C,M]);const Z=n=>{const c=n.id===C,g=I(n.x),u=B(n.y),a=N(n.width),F=he(n.height);return t.jsxs("div",{className:`annotation textbox-annotation ${c?"selected":""}`,style:{left:`${g}px`,top:`${u}px`,width:`${a}px`,height:`${F}px`,padding:`${4*k}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>ae(v,n),children:[c&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),M(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),f===n.id?t.jsx("textarea",{className:"textbox-input",value:n.text,onChange:v=>{S({...n,text:v.target.value})},onBlur:v=>{const R=v.relatedTarget;R&&(R.closest(".textbox-controls")!==null||R.closest(".textbox-font-size-input")!==null||R.classList.contains("textbox-font-size-input")||R.closest(".floating-textbox-toolbar")!==null||R.closest(".color-swatch")!==null||R.classList.contains("toolbar-icon"))||(oe(null),fe(null))},onKeyDown:v=>{v.key==="Enter"&&!v.shiftKey&&(v.preventDefault(),oe(null),fe(null)),v.key==="Escape"&&(oe(null),fe(null))},style:{fontSize:`${n.fontSize*k}px`,color:n.color,width:`${a}px`,maxWidth:`${a}px`,height:`${F}px`,maxHeight:`${F}px`},autoFocus:!0}):t.jsx("div",{className:"textbox-content",onClick:v=>{v.stopPropagation();const R=v.target;R.closest(".textbox-controls")!==null||R.closest(".textbox-font-size-input")!==null||R.closest(".textbox-color-button")!==null||R.closest(".textbox-color-picker")!==null||oe(n.id)},style:{fontSize:`${n.fontSize*k}px`,color:n.color},children:n.text||"Text"})]},n.id)},O=n=>{const c=n.id===C,g=I(n.x),u=B(n.y),a=N(n.width),F=he(n.height),v=n.width*E,R=n.height*$,ce=n.imageWidth/n.imageHeight,ve=v/R;let ke,Re;return ce>ve?(ke=a,Re=a/ce):(Re=F,ke=F*ce),t.jsxs("div",{className:`annotation image-annotation ${c?"selected":""}`,style:{left:`${g}px`,top:`${u}px`,width:`${ke}px`,height:`${Re}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:De=>ae(De,n),children:[c&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:De=>{De.stopPropagation(),M(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),t.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},y=n=>{const c=n.id===C,g=I(n.x),u=B(n.y),a=N(n.width),F=he(n.height);return t.jsx("div",{className:`annotation highlight-annotation ${c?"selected":""}`,style:{left:`${g}px`,top:`${u}px`,width:`${a}px`,height:`${F}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>ae(v,n),children:c&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),M(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]})},n.id)},pe=J.width,_=J.height,le={width:`${pe}px`,height:`${_}px`,left:`${J.offsetLeft}px`,top:`${J.offsetTop}px`,pointerEvents:"none"},D=se.find(n=>n.id===C&&n.type==="textbox"),[j,me]=r.useState(null);return r.useEffect(()=>{if(!D||!x.current){me(null);return}const n=I(D.x),c=B(D.y);me({left:n+N(D.width)/2,top:Math.max(0,c-40)})},[D,E,$,k,f]),t.jsxs("div",{ref:x,className:"annotation-layer",style:le,children:[se.map(n=>n.type==="textbox"?Z(n):n.type==="image"?O(n):n.type==="highlight"?y(n):null),D&&f===D.id&&j&&t.jsxs("div",{className:"floating-textbox-toolbar",style:{left:`${j.left}px`,top:`${j.top}px`,position:"absolute",zIndex:9999},onMouseDown:n=>n.stopPropagation(),children:[t.jsxs("div",{className:"font-size-group",children:[t.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=D.fontSize||16;S({...D,fontSize:Math.max(1,n-1)})},title:"Decrease font size",children:"−"}),t.jsx("span",{className:"font-size-display",children:D.fontSize||16}),t.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=D.fontSize||16;S({...D,fontSize:Math.min(200,n+1)})},title:"Increase font size",children:"+"})]}),t.jsx("div",{className:"color-swatch-group",children:["#000000","#ff0000","#0000ff","#00ff00","#ffeb3b"].map(n=>t.jsx("button",{className:`color-swatch ${D.color===n?"active":""}`,style:{backgroundColor:n},onClick:()=>S({...D,color:n}),title:n},n))})]})]})},Mt=({mode:d,onModeChange:E,highlightColor:$="#ffeb3b",onHighlightColorChange:k,onHighlightClick:ue,hasTextSelection:C=!1,isHighlightActive:S=!1,showColorPicker:M=!1,onImageUpload:fe,layout:K,onToggleLayout:x,showLayoutToggle:be=!0,onClearAll:X,pageNumber:w,numPages:G,onPrevPage:b,onNextPage:ye,scale:ee,onZoomIn:ge,onZoomOut:U,onFitWidth:h,onFitHeight:m,onZoomInputClick:ne,isEditingZoom:A,zoomInputValue:we,onZoomInputChange:f,onZoomInputBlur:oe,onZoomInputKeyDown:se,onZoomInputPaste:J,zoomInputRef:Y})=>{const P=r.useRef(null),[I,B]=r.useState(!1),[N,he]=r.useState(!1),[Ce,V]=r.useState(()=>typeof window<"u"?window.innerWidth<=720:!1),re=r.useRef(null),Se=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];r.useEffect(()=>{const O=y=>{I&&(y.target.closest(".clear-button")||(B(!1),re.current&&(clearTimeout(re.current),re.current=null)))};if(I)return document.addEventListener("click",O),()=>{document.removeEventListener("click",O)}},[I]),r.useEffect(()=>{if(typeof window>"u")return;const O=()=>{const y=window.innerWidth<=720;V(y),!y&&N&&he(!1)};return O(),window.addEventListener("resize",O),()=>window.removeEventListener("resize",O)},[N]);const ae=O=>{const y=O.target.files?.[0];y&&y.type.startsWith("image/")&&fe(y),E(null),P.current&&(P.current.value="")},Z=O=>{O.stopPropagation(),I?(X&&X(),B(!1),re.current&&(clearTimeout(re.current),re.current=null)):(B(!0),re.current=setTimeout(()=>{B(!1),re.current=null},3e3))};return t.jsxs("div",{className:"annotation-toolbar",children:[t.jsxs("div",{className:"toolbar-left",children:[Ce&&t.jsx("button",{type:"button",className:`toolbar-button mobile-tools-toggle ${N?"active":""}`,onClick:()=>he(O=>!O),"aria-pressed":N,"aria-expanded":N,"aria-label":N?"Hide annotation tools":"Show annotation tools",children:t.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("path",{d:"M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25Z",stroke:"currentColor",strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"}),t.jsx("path",{d:"M14.06 6.19L17.31 2.94C17.7 2.55 18.33 2.55 18.72 2.94L21.06 5.28C21.45 5.67 21.45 6.3 21.06 6.69L17.81 9.94",stroke:"currentColor",strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"})]})}),t.jsxs("div",{className:`toolbar-section annotation-tools ${Ce&&N?"mobile-visible":""}`,children:[t.jsx("button",{className:`toolbar-button ${S?"active":""}`,onClick:ue,disabled:!C,title:C?S?"Remove highlight":"Highlight text":"Select text to highlight",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),t.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),t.jsx("button",{className:`toolbar-button ${d==="textbox"?"active":""}`,onClick:()=>E("textbox"),title:"Add text box",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("path",{d:"M4 7V4h16v3M9 20h6M12 4v16"})})}),t.jsx("button",{className:`toolbar-button ${d==="image"?"active":""}`,onClick:()=>{E("image"),P.current?.click()},title:"Add image",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),t.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t.jsx("polyline",{points:"21 15 16 10 5 21"})]})}),X&&t.jsx("button",{className:`toolbar-button clear-button ${I?"confirming":""}`,onClick:Z,title:I?"Click again to clear all":"Clear all",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"3 6 5 6 21 6"}),t.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),t.jsx("input",{ref:P,type:"file",accept:"image/*",onChange:ae,style:{display:"none"}})]}),M&&k&&t.jsx("div",{className:"toolbar-section color-picker",children:Se.map(O=>t.jsx("button",{className:`color-button ${$===O?"active":""}`,style:{backgroundColor:O},onClick:()=>k(O),title:"Highlight color"},O))})]}),t.jsxs("div",{className:"toolbar-center",children:[w!==void 0&&G!==void 0&&t.jsxs("div",{className:"toolbar-section pdf-navigation",children:[t.jsx("button",{className:"toolbar-button nav-button",onClick:b,disabled:w<=1,title:"Previous page",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("polyline",{points:"15 18 9 12 15 6"})})}),t.jsxs("span",{className:"page-info",children:[w," / ",G]}),t.jsx("button",{className:"toolbar-button nav-button",onClick:ye,disabled:w>=G,title:"Next page",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),ee!==void 0&&t.jsxs("div",{className:"toolbar-section zoom-controls",children:[t.jsx("button",{onClick:h,className:"toolbar-button",title:"Fit width",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"5 9 2 12 5 15"}),t.jsx("polyline",{points:"19 9 22 12 19 15"}),t.jsx("line",{x1:"2",y1:"12",x2:"22",y2:"12"})]})}),t.jsx("button",{onClick:m,className:"toolbar-button",title:"Fit height",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"9 5 12 2 15 5"}),t.jsx("polyline",{points:"9 19 12 22 15 19"}),t.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22"})]})}),t.jsx("button",{onClick:U,className:"toolbar-button",title:"Zoom out",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:t.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),A?t.jsx("input",{ref:Y,type:"text",inputMode:"numeric",value:we,onChange:f,onBlur:oe,onKeyDown:se,onPaste:J,className:"zoom-input"}):t.jsxs("span",{className:"zoom-level",onClick:ne,title:"Click to edit zoom",children:[Math.round((ee||1)*100),"%"]}),t.jsx("button",{onClick:ge,className:"toolbar-button",title:"Zoom in",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[t.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),t.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]}),t.jsx("div",{className:"toolbar-right",children:be&&x&&t.jsx("div",{className:"toolbar-section toolbar-actions",children:t.jsx("button",{className:"toolbar-button layout-toggle-button",onClick:x,title:K==="floating"?"Switch to split layout":"Switch to floating layout",children:K==="floating"?t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),t.jsx("rect",{x:"3",y:"14",width:"7",height:"7"})]}):t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),t.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),t.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"21"})]})})})})]})},Nt=({pageNumber:d,pageWidth:E,pageHeight:$,scale:k,knowledgeNotes:ue,showKnowledgeNotes:C,onNoteClick:S})=>{const M=ue.filter(x=>x.pageNumber===d);if(!C||M.length===0)return null;const fe=E*k,K=$*k;return t.jsx("div",{className:"knowledge-note-connections",style:{width:`${fe}px`,height:`${K}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:t.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:M.map((x,be)=>{const X=fe-25,w=25+be*35;return t.jsxs("g",{children:[t.jsx("circle",{cx:X,cy:w,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:G=>{G.stopPropagation(),S?.(x)},style:{cursor:"pointer",pointerEvents:"all"}}),t.jsx("text",{x:X,y:w,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:be+1}),t.jsx("line",{x1:X,y1:w+12,x2:X,y2:w+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},x.id)})})})};let Ue,Te=null,et=!1;async function St(){if(!Ue)try{Ue=await nt(()=>import("./vendor-DOxxWhKm.js").then(d=>d.o),__vite__mapDeps([0,1]))}catch(d){throw console.error("Failed to load pdf-lib:",d),new Error("PDF library not available. Please install pdf-lib.")}return Ue}async function Rt(){if(!et){et=!0;try{const d=await nt(()=>import("./vendor-DOxxWhKm.js").then(E=>E.p),__vite__mapDeps([0,1]));return d.default?Te=d.default:Te=d,Te&&typeof Te.create=="function"?Te:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(d){return console.warn("Failed to load fontkit, falling back to standard fonts:",d),null}}return Te}async function Dt(){try{const d=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],E="/ChatNote/",k=`${E.endsWith("/")?E:`${E}/`}NotoSans-Regular.ttf`;try{const ue=await fetch(k);if(ue.ok){const C=await ue.arrayBuffer();if(C.byteLength>1e3){const S=new Uint8Array(C);if(S.length>=4&&S[0]===0&&S[1]===1&&S[2]===0&&S[3]===0)return C}}}catch{}for(const ue of d)if(!ue.includes("fonts.googleapis.com/css"))try{const C=await fetch(ue,{mode:"cors",cache:"default"});if(C.ok){const S=await C.arrayBuffer();if(S.byteLength>1e3){const M=new Uint8Array(S),fe=M.length>=4&&M[0]===0&&M[1]===1&&M[2]===0&&M[3]===0,K=M.length>=4&&M[0]===119&&M[1]===79&&M[2]===70&&M[3]===70,x=M.length>=4&&M[0]===119&&M[1]===79&&M[2]===70&&M[3]===50;if(fe||K||x)return S;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(d){return console.warn("Failed to load Unicode font:",d),null}}async function zt(d,E,$){try{const k=await St(),{PDFDocument:ue,rgb:C,degrees:S,StandardFonts:M}=k;if(!M)throw new Error("StandardFonts not available from pdf-lib");const fe=await d.arrayBuffer(),K=await ue.load(fe);let x=null;try{const w=await Rt();if(w){try{K.registerFontkit(w)}catch(b){(!b.message||!b.message.includes("already registered"))&&console.warn("Failed to register fontkit:",b)}const G=await Dt();if(G){const b=new Uint8Array(G),ye=b.length>=4&&b[0]===0&&b[1]===1&&b[2]===0&&b[3]===0,ee=b.length>=4&&b[0]===79&&b[1]===84&&b[2]===84&&b[3]===79,ge=b.length>=4&&b[0]===116&&b[1]===116&&b[2]===99&&b[3]===102,U=b.length>=4&&b[0]===119&&b[1]===79&&b[2]===70&&b[3]===70,h=b.length>=4&&b[0]===119&&b[1]===79&&b[2]===70&&b[3]===50;U||h?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):ye||ee||ge?x=await K.embedFont(G):console.warn(`Invalid font format. File size: ${b.length} bytes`)}}}catch(w){console.warn("Failed to embed Unicode font, falling back to standard font:",w)}if(!x){const w=M.Helvetica||M.TimesRoman;if(!w)throw new Error("No standard font available");x=await K.embedFont(w)}if(!x)throw new Error("Failed to embed font");const be=K.getPages();for(const w of E){const G=be[w.pageNumber-1];if(!G)continue;const b=$.get(w.pageNumber);if(!b)continue;const{width:ye,height:ee}=b;let ge=w.width*ye,U=w.height*ee;if(w.type==="textbox"){const h=w,m=Et(h.color)||{r:0,g:0,b:0},ne=w.x*ye,A=w.y*ee;let we=(w.y+w.height)*ee;const f=4,oe=ge-f*2,se=(h.text||"").trimEnd();let Y=se.split(/\r\n|\r|\n/).filter(y=>y!=null);for(;Y.length>0&&Y[Y.length-1].length===0;)Y.pop();if(Y.length===0&&(Y=[""]),Y.length===1&&x&&typeof x.widthOfTextAtSize=="function"){const y=Y[0],pe=oe;let _;try{_=x.widthOfTextAtSize(y,h.fontSize)}catch{_=y.length*h.fontSize*.5}if(_>pe){const le=[],D=y.split(/(\s+)/);let j="";for(let me=0;me<D.length;me++){const n=D[me],c=j+n;let g;try{g=x.widthOfTextAtSize(c,h.fontSize)}catch{g=c.length*h.fontSize*.5}g<=pe||j===""?j=c:(j.trim()&&le.push(j.trim()),j=n)}j.trim()&&le.push(j.trim()),le.length>1&&(Y=le)}}const P=h.fontSize*1.2;U=Y.length>0?(Y.length-1)*P+h.fontSize+f*2:h.fontSize+f*2,we=A+U;const N=ee-we,Ce=ee-A-N,re=N+Ce/2,Se=h.fontSize*.2,ae=ee-h.fontSize*.2,Z=Math.max(Se,Math.min(ae,re));if((Y.length>1||se.includes(`
`)||se.includes("\r"))&&Y.length>0)try{const y=(Y.length-1)*P,pe=Z+y/2;Y.forEach((_,le)=>{const D=pe-le*P;let j;try{x&&typeof x.widthOfTextAtSize=="function"?j=x.widthOfTextAtSize(_,h.fontSize):j=_.length*h.fontSize*.5}catch{j=_.length*h.fontSize*.5}let n=ne+f+oe/2-j/2;const c=ne+f,g=ne+ge-j-f;n=Math.max(c,Math.min(g,n));const u=_.length>0?_:" ";G.drawText(u,{x:n,y:D,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:x})})}catch(y){if(y.message&&y.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",y.message);const pe=Y.map(D=>D.split("").map(j=>j.charCodeAt(0)>255?"?":j).join("")),_=(pe.length-1)*P,le=Z+_/2;try{pe.forEach((D,j)=>{const me=le-j*P;let n;try{x&&typeof x.widthOfTextAtSize=="function"?n=x.widthOfTextAtSize(D,h.fontSize):n=D.length*h.fontSize*.5}catch{n=D.length*h.fontSize*.5}let g=ne+f+oe/2-n/2;const u=ne+f,a=ne+ge-n-f;g=Math.max(u,Math.min(a,g)),G.drawText(D,{x:g,y:me,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:x})})}catch(D){console.error("Failed to draw text even after replacing Unicode characters:",D);continue}}else throw y}else{let y;try{x&&typeof x.widthOfTextAtSize=="function"?y=x.widthOfTextAtSize(h.text,h.fontSize):y=h.text.length*h.fontSize*.5}catch{y=h.text.length*h.fontSize*.5}let _=ne+f+oe/2-y/2;const le=ne+f,D=ne+ge-y-f;_=Math.max(le,Math.min(D,_));try{G.drawText(h.text,{x:_,y:Z,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:x})}catch(j){if(j.message&&j.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",j.message);const me=h.text.split("").map(n=>n.charCodeAt(0)>255?"?":n).join("");try{G.drawText(me,{x:_,y:Z,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:x})}catch(n){console.error("Failed to draw text even after replacing Unicode characters:",n);continue}}else throw j}}}else if(w.type==="image"){const h=w,m=await fetch(h.imageData).then(B=>B.arrayBuffer());let ne;if(h.imageData.startsWith("data:image/png"))ne=await K.embedPng(m);else if(h.imageData.startsWith("data:image/jpeg")||h.imageData.startsWith("data:image/jpg"))ne=await K.embedJpg(m);else throw console.error("Unsupported image format for PDF embedding:",h.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const A=h.imageWidth/h.imageHeight;let we=ge,f=U;ge/U>A?we=U*A:f=ge/A;const se=w.x*ye,J=(w.y+w.height)*ee,I=ee-J+(U-f)/2;G.drawImage(ne,{x:se,y:I,width:we,height:f,rotate:S(h.rotation)})}}const X=await K.save();return new Blob([X],{type:"application/pdf"})}catch(k){throw console.error("Error saving annotated PDF:",k),new Error("Failed to save annotated PDF")}}function Et(d){const E=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);return E?{r:parseInt(E[1],16),g:parseInt(E[2],16),b:parseInt(E[3],16)}:null}function tt(d,E="annotated.pdf"){const $=URL.createObjectURL(d),k=document.createElement("a");k.href=$,k.download=E,document.body.appendChild(k),k.click(),document.body.removeChild(k),URL.revokeObjectURL($)}const Pt="/ChatNote/assets/chatnote-logo-BGY00N4J.svg",Xe=d=>Math.max(0,Math.min(1,d)),Tt=d=>d?(d.querySelector(".react-pdf__Page")??d).getBoundingClientRect():null;function Ht({file:d,onFileUpload:E,onTextSelection:$,layout:k="floating",showLayoutToggle:ue=!0,onPageChange:C,onTotalPagesChange:S,showKnowledgeNotes:M=!0,knowledgeNotes:fe=[],onScrollToPage:K,onNoteClick:x,onAddAnnotation:be,initialAnnotations:X=[],onAnnotationsChange:w,isLoadingPdf:G=!1,onLoadingComplete:b,isSavingSession:ye=!1,onNewSession:ee,onToggleLayout:ge,isDriveAuthorized:U,onSelectRecentPdf:h}){const[m,ne]=r.useState(0),[A,we]=r.useState(1),[f,oe]=r.useState(1),[se,J]=r.useState(!1),[Y,P]=r.useState("100"),I=r.useRef(null),B=r.useRef(new Map),N=r.useRef(null),he=r.useRef(null),Ce=r.useRef(!1),V=r.useRef(new Map),[re,Se]=r.useState(0),[ae,Z]=r.useState(X),[O,y]=r.useState(null),[pe,_]=r.useState(null),[le,D]=r.useState(null),[j,me]=r.useState(null),[n,c]=r.useState(!1),[g,u]=r.useState("#ffeb3b"),[a,F]=r.useState(!1),v=r.useRef(X),R=r.useRef(w);r.useEffect(()=>{R.current=w},[w]),r.useEffect(()=>{const e=v.current,o=X.length!==e.length||X.some((i,l)=>i.id!==e[l]?.id);X&&X.length>0&&o?(Z(X),v.current=X):d&&X.length===0&&e.length>0?(Z([]),v.current=[],y(null)):!d&&e.length>0&&(Z([]),v.current=[],y(null))},[X,d]),r.useEffect(()=>{JSON.stringify(v.current)!==JSON.stringify(ae)&&R.current&&(v.current=ae,R.current(ae))},[ae]),r.useEffect(()=>{const e=console.warn,o=console.error;return console.warn=(...i)=>{const l=i.join(" ");l.includes("TextLayer task cancelled")||l.includes("AbortException")||i.some(s=>typeof s=="string"&&(s.includes("TextLayer task cancelled")||s.includes("AbortException")))||e.apply(console,i)},console.error=(...i)=>{const l=i.join(" ");l.includes("TextLayer task cancelled")||l.includes("AbortException")&&l.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=e,console.error=o}},[]);const ce=r.useMemo(()=>d?URL.createObjectURL(d):null,[d]),ve=r.useRef(null);r.useEffect(()=>(ve.current&&ve.current!==ce&&URL.revokeObjectURL(ve.current),ve.current=ce,()=>{ce&&URL.revokeObjectURL(ce)}),[ce]);const ke=r.useMemo(()=>{let e;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";e=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Ie&&(Ie.workerSrc=e,Ie.standardFontDataUrl=o),{workerSrc:e,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),Re=({numPages:e})=>{ne(e),S?.(e);const o=1;we(o),setTimeout(()=>{C?.(o)},0),B.current.clear(),V.current.clear(),b&&setTimeout(()=>{b()},300)},De=e=>{if(!V.current.has(e.pageNumber))try{const o=e.page;let i,l;o.viewport?(i=o.viewport.width,l=o.viewport.height):(i=o.width/f,l=o.height/f),V.current.set(e.pageNumber,{width:i,height:l})}catch(o){console.warn("Error getting page dimensions:",o);const i=e.page,l=i.width/f,s=i.height/f;V.current.set(e.pageNumber,{width:l,height:s})}};r.useEffect(()=>{if(!N.current||m===0)return;let e=null,o=!1;const i=()=>{if(Ce.current||o||e)return;o=!0,e=setTimeout(()=>{e=null,o=!1},100);const s=N.current;if(!s){o=!1;return}const p=s.getBoundingClientRect(),H=p.top,T=p.height,Q=H+T/2;if(s.scrollTop<100){we(z=>z!==1?(setTimeout(()=>{C?.(1)},0),1):z);return}let de=1,W=0;for(let z=1;z<=m;z++){const L=B.current.get(z);if(L){const ie=L.getBoundingClientRect(),q=s.getBoundingClientRect(),je=Math.max(q.top,ie.top),Ne=Math.min(q.bottom,ie.bottom),ze=Math.max(0,Ne-je);ze>W&&(W=ze,de=z)}}if(W<T*.1){let z=1,L=1/0;for(let ie=1;ie<=m;ie++){const q=B.current.get(ie);if(q){const je=q.getBoundingClientRect(),Ne=je.top+je.height/2,ze=Math.abs(Ne-Q);ze<L&&(L=ze,z=ie)}}de=z}we(z=>de!==z?(setTimeout(()=>{C?.(de)},0),de):z)},l=N.current;return l?.addEventListener("scroll",i,{passive:!0}),()=>{e&&clearTimeout(e),l?.removeEventListener("scroll",i)}},[m,C]),r.useEffect(()=>{let e=null;const o=()=>{e&&clearTimeout(e),e=setTimeout(()=>{Se(i=>i+1)},150)};return window.addEventListener("resize",o),()=>{e&&clearTimeout(e),window.removeEventListener("resize",o)}},[]);const Fe=e=>{console.error("PDF load error:",e)},Le=async e=>{const o=e.target.files?.[0];if(o&&o.type==="application/pdf"){E(o);const i=o.size/(1024*1024),l=xe.generateDocumentId();xe.setCurrentDocument(l),await xe.createDocument(l,i),await xe.trackPDFUpload(i,l)}},Ee=r.useCallback(e=>{const o=B.current.get(e);o&&N.current&&(Ce.current=!0,we(e),C?.(e),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{Ce.current=!1},1500))},[C]);r.useEffect(()=>(K&&(window.__pdfScrollToPage=Ee),N.current&&(window.__pdfContentRef=N.current),he.current&&(window.__pdfViewerHeight=he.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Ee,K,m,f]);const Me=()=>{const e=Math.max(1,A-1);Ee(e)},Be=()=>{const e=Math.min(m,A+1);Ee(e)},Oe=()=>{const e=Math.min(f+.2,5);oe(e),P(Math.round(e*100).toString())},Ae=()=>{const e=Math.max(f-.2,.25);oe(e),P(Math.round(e*100).toString())};r.useEffect(()=>{se||P(Math.round(f*100).toString())},[f,se]);const He=()=>{J(!0),P(Math.round(f*100).toString())},_e=e=>{let o=e.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),P(o)},Pe=()=>{Ve()},ot=e=>{if(e.key==="Enter")e.preventDefault(),Ve();else if(e.key==="Escape")J(!1),P(Math.round(f*100).toString()),I.current?.blur();else{if(e.key==="Backspace"||e.key==="Delete"||e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Tab")return;(e.key==="-"||e.key==="+"||e.key==="."||e.key===","||e.key==="e"||e.key==="E"||!/[0-9]/.test(e.key)&&!e.ctrlKey&&!e.metaKey)&&e.preventDefault()}},st=e=>{e.preventDefault();const i=e.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const s=(i.replace(/^0+/,"")||"0").slice(0,3);if(P(s),s&&s!=="0"){const p=parseInt(s,10);if(!isNaN(p)&&p>0){const H=Math.max(25,Math.min(500,p)),T=H/100;oe(T),P(H.toString()),J(!1)}}}},Ve=()=>{if(Y.trim()===""||Y==="0"){P(Math.round(f*100).toString()),J(!1);return}const e=parseInt(Y,10);if(isNaN(e)||e<=0){P(Math.round(f*100).toString()),J(!1);return}const o=Math.max(25,Math.min(500,e)),i=o/100;oe(i),P(o.toString()),J(!1)};r.useEffect(()=>{se&&I.current&&(I.current.focus(),I.current.select())},[se]);const it=()=>{if(V.current.size===0)return;let e=null;if(N.current){const s=N.current,p=getComputedStyle(s),H=parseFloat(p.paddingLeft||"0")||0,T=parseFloat(p.paddingRight||"0")||0;e=s.clientWidth-H-T,s.scrollHeight>s.clientHeight&&(e-=12),e=Math.max(0,e-4)}else if(he.current){const s=he.current.getBoundingClientRect();e=Math.max(0,s.width-40)}if(!e||e<=0)return;const o=V.current.get(1);if(!o)return;const i=e/o.width*.999,l=Math.max(.1,Math.min(i,5));oe(l),P(Math.round(l*100).toString())},rt=()=>{if(!he.current||V.current.size===0)return;const e=he.current.getBoundingClientRect();let o=0;const i=he.current.querySelector(".annotation-toolbar");i&&(o=i.getBoundingClientRect().height);const l=e.height-o,s=V.current.get(A);if(!s)return;const p=l/s.height,H=Math.max(.1,Math.min(p,5));oe(H),P(Math.round(H*100).toString())},Ze=r.useCallback(()=>{const e=window.getSelection();if(e&&e.toString().trim()){const o=e.toString().trim();let i,l;if(e.rangeCount>0&&N.current){const p=e.getRangeAt(0).getBoundingClientRect(),H=N.current.getBoundingClientRect(),T=p.top-H.top+N.current.scrollTop;for(let Q=1;Q<=m;Q++){const te=B.current.get(Q);if(te){const de=te.offsetTop,W=te.offsetHeight,z=de+W;if(T>=de&&T<=z){l=Q;const L=(T-de)/W;i=Math.max(0,Math.min(1,L)),D({text:o,pageNumber:Q,rect:p,pageElement:te});const ie=ae.find(q=>q.type==="highlight"&&q.pageNumber===Q&&Math.abs(q.x-Math.max(0,Math.min(1,(p.left-te.getBoundingClientRect().left)/te.offsetWidth)))<.01&&Math.abs(q.y-Math.max(0,Math.min(1,L)))<.01);me(ie?.id||null);break}}}}$(o,l,i)}else $("",void 0,void 0),D(null),me(null),c(!1)},[$,m,ae]),at=r.useCallback(e=>{const o=e.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.closest(".floating-textbox-toolbar")!==null||o.closest(".color-swatch")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker")||o.classList.contains("floating-textbox-toolbar")||o.classList.contains("color-swatch"))return;const l=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const s=window.getSelection(),p=s&&s.toString().trim().length>0;if(p||$(""),!l&&!p&&y(null),pe==="textbox"&&!l&&!p){const H=N.current;if(!H)return;let T=A,Q=.5,te=.5;for(let W=1;W<=m;W++){const z=B.current.get(W);if(z){const L=z.getBoundingClientRect();if(H.getBoundingClientRect()){const q=e.clientX-L.left,je=e.clientY-L.top;if(q>=0&&q<=L.width&&je>=0&&je<=L.height){T=W;const Ne=V.current.get(W);if(Ne){const ze=L.width/Ne.width,bt=L.height/Ne.height;Q=q/(Ne.width*ze),te=je/(Ne.height*bt)}break}}}}if(V.current.get(T)){const W=Math.max(0,Math.min(.8,Q-.1)),z=Math.max(0,Math.min(1-.1,te-.05)),L={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:T,x:W,y:z,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:kt[0]};Z(ie=>{const q=[...ie,L];return We(L).catch(je=>{console.warn("Failed to track text box annotation:",je)}),q}),y(L.id),_("select")}}},100)},[$,pe,A,m,f,y,_,Z]),We=r.useCallback(async e=>{Z(o=>[...o,e]),y(e.id);try{let o="text";e.type==="highlight"?o="highlight":e.type==="image"?o="image":e.type==="textbox"&&(o="text"),await xe.trackAnnotationAdded(o);const i=xe.getCurrentDocumentId();i&&await xe.updateDocument(i,{has_annotations:!0})}catch(o){console.warn("Failed to track annotation creation:",o)}},[]);r.useEffect(()=>(be&&(window.__addPDFAnnotation=e=>{Z(o=>[...o,e]),y(e.id),e.pageNumber&&K&&K(e.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[be,K]);const $e=r.useCallback((e,o,i)=>{const l=e.width*o.width*i,s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${l}px`,s.style.fontSize=`${e.fontSize*i}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*i}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=e.text||"Text",document.body.appendChild(s);const p=s.scrollHeight;document.body.removeChild(s);const H=p/(o.height*i);return Math.max(.01,Math.min(1,H))},[]),lt=r.useCallback(e=>{Z(o=>{let i=!1;const l=o.map(s=>{if(s.id!==e.id)return s;if(e.type==="textbox"){const p=e,H=V.current.get(p.pageNumber);if(H){const T=$e(p,H,f);return Math.abs((s.height||0)-T)>1e-4||Math.abs((s.x||0)-(p.x||0))>1e-4||Math.abs((s.y||0)-(p.y||0))>1e-4||Math.abs((s.width||0)-(p.width||0))>1e-4||Math.abs((s.rotation||0)-(p.rotation||0))>1e-4||s.type==="textbox"&&(s.text!==p.text||s.color!==p.color||s.fontSize!==p.fontSize)?(i=!0,{...p,height:T}):s}}return Math.abs((s.x||0)-(e.x||0))>1e-4||Math.abs((s.y||0)-(e.y||0))>1e-4||Math.abs((s.width||0)-(e.width||0))>1e-4||Math.abs((s.height||0)-(e.height||0))>1e-4||Math.abs((s.rotation||0)-(e.rotation||0))>1e-4||"color"in s&&"color"in e&&s.color!==e.color?(i=!0,e):s});return i?l:o})},[f,$e]);r.useEffect(()=>{Z(e=>e.map(o=>{if(o.type==="textbox"){const i=o,l=V.current.get(i.pageNumber);if(l){const s=$e(i,l,f);return{...i,height:s}}}return o}))},[f,$e]);const ct=r.useCallback(e=>{Z(o=>o.filter(i=>i.id!==e)),O===e&&y(null)},[O]),dt=r.useCallback(async e=>{if(!d||!V.current.get(A))return;const i=new FileReader;i.onload=l=>{const s=l.target?.result,p=new Image;p.onload=()=>{const H=!s.startsWith("data:image/png")&&!s.startsWith("data:image/jpeg")&&!s.startsWith("data:image/jpg");let T=s;if(H){const ie=document.createElement("canvas");ie.width=p.width,ie.height=p.height;const q=ie.getContext("2d");q&&(q.drawImage(p,0,0),T=ie.toDataURL("image/png"))}const Q=.2,te=p.width/p.height,de=Q/te,L={id:`image-${Date.now()}`,type:"image",pageNumber:A,x:.4,y:.4,width:Q,height:de,rotation:0,imageData:T,imageWidth:p.width,imageHeight:p.height};We(L),_("select")},p.src=s},i.readAsDataURL(e)},[d,A,We,_]),ht=r.useCallback(async()=>{if(!le)return;const{pageNumber:e,rect:o,pageElement:i}=le;if(j)Z(l=>l.filter(s=>s.id!==j)),me(null),c(!1);else{const s=Tt(i)??i.getBoundingClientRect(),p=s.width||i.offsetWidth,H=s.height||i.offsetHeight,T=Xe((o.left-s.left)/p),Q=Xe((o.top-s.top)/H),te=Xe(o.width/p),de=Xe(o.height/H),W={id:crypto.randomUUID(),type:"highlight",pageNumber:e,x:T,y:Q,width:Math.max(.01,te),height:Math.max(.01,de),rotation:0,color:g,opacity:.4};Z(z=>[...z,W]),me(W.id),c(!0);try{await xe.trackAnnotationAdded("highlight");const z=xe.getCurrentDocumentId();z&&await xe.updateDocument(z,{has_annotations:!0})}catch(z){console.warn("Failed to track highlight annotation:",z)}}},[le,j,g]),ut=r.useCallback(e=>{u(e),j&&Z(o=>o.map(i=>i.id===j&&i.type==="highlight"?{...i,color:e}:i))},[j]),qe=r.useCallback(async()=>{if(d)try{if(ae.length===0){const l=d.name;tt(d,l),await xe.trackPDFExport(!1);const s=xe.getCurrentDocumentId();s&&await xe.updateDocument(s,{has_export:!0});return}const e=await zt(d,ae,V.current),o=d.name.replace(".pdf","_annotated.pdf");tt(e,o),await xe.trackPDFExport(!0);const i=xe.getCurrentDocumentId();i&&await xe.updateDocument(i,{has_export:!0})}catch(e){console.error("Error saving PDF:",e),alert("Failed to save annotated PDF. Please check the console for details.")}},[d,ae]);r.useEffect(()=>{const e=()=>{ee&&ee()},o=()=>{qe()};return window.addEventListener("pdf-new-session",e),window.addEventListener("pdf-download",o),()=>{window.removeEventListener("pdf-new-session",e),window.removeEventListener("pdf-download",o)}},[ee,qe]);const ft=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy",F(!0)},[]),gt=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),N.current?.contains(e.relatedTarget)||F(!1)},[]),pt=r.useCallback(async e=>{e.preventDefault(),e.stopPropagation();const i=Array.from(e.dataTransfer.files).filter(T=>T.type.startsWith("image/"));if(i.length===0||!N.current?.getBoundingClientRect())return;let s=A,p=.5,H=.5;for(let T=1;T<=m;T++){const Q=B.current.get(T);if(Q){const te=Q.getBoundingClientRect();if(N.current?.getBoundingClientRect()){const W=e.clientX-te.left,z=e.clientY-te.top;if(W>=0&&W<=te.width&&z>=0&&z<=te.height){s=T;const L=V.current.get(T);L&&(p=W/(L.width*f),H=z/(L.height*f));break}}}}for(const T of i){const Q=new FileReader;Q.onload=te=>{const de=te.target?.result,W=new Image;W.onload=()=>{if(!V.current.get(s))return;const L=.2,ie=W.width/W.height,q=L/ie,je=Math.max(0,Math.min(1-L,p-L/2)),Ne=Math.max(0,Math.min(1-q,H-q/2)),ze={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:s,x:je,y:Ne,width:L,height:q,rotation:0,imageData:de,imageWidth:W.width,imageHeight:W.height};We(ze)},W.src=de},Q.readAsDataURL(T)}},[A,m,f,We]),[Ye,Ke]=r.useState(()=>Je(3)),[mt,Ge]=r.useState(!1);r.useEffect(()=>{let e=!0;return U&&jt(3).then(o=>{e&&o&&o.length>0&&Ke(o)}).catch(()=>{}),()=>{e=!1}},[U]),r.useEffect(()=>{if(typeof window>"u")return;const e=()=>{Ke(Je(3))};return window.addEventListener(Qe,e),()=>{window.removeEventListener(Qe,e)}},[]),r.useEffect(()=>{if(U&&Ye&&Ye.length>0){const e=requestAnimationFrame(()=>Ge(!0));return()=>cancelAnimationFrame(e)}Ge(!1)},[U,Ye]);const xt=!d&&!G,wt=()=>{const e=Ye;return t.jsx("div",{className:`pdf-viewer-empty ${k==="floating"?"float-layout":""}`,children:t.jsxs("div",{className:"start-page-content",children:[t.jsxs("div",{className:"start-top",children:[t.jsx("img",{src:Pt,alt:"ChatNote Logo",className:"start-logo"}),t.jsxs("div",{className:"upload-container",children:[t.jsxs("label",{htmlFor:"pdf-upload",className:"upload-button modern-upload",children:[t.jsx("span",{className:"upload-icon","aria-hidden":"true",children:t.jsxs("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M12 19V6M5 12l7-7 7 7"}),t.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1"})]})}),t.jsx("span",{children:"Upload PDF"})]}),t.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Le,style:{display:"none"}})]})]}),U&&e.length>0&&t.jsxs("div",{className:"recent-pdf-suggestions",children:[t.jsx("div",{className:"suggestions-title",children:"Recent PDFs"}),t.jsx("div",{className:`suggestions-list ${mt?"show":""}`,children:e.map((o,i)=>t.jsxs("button",{className:"suggestion-card",onClick:()=>h&&h(o.pdfId),children:[t.jsx("span",{className:"suggestion-icon","aria-hidden":"true",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),t.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),t.jsx("span",{className:"suggestion-name",children:o.displayName||o.originalFileName})]},o.pdfId||i))})]})]})})};return t.jsxs("div",{className:`pdf-viewer ${ye?"saving-session":""}`,ref:he,children:[xt?wt():t.jsxs(t.Fragment,{children:[G&&t.jsx("div",{className:"pdf-loading-overlay",children:t.jsxs("div",{className:"pdf-loading-spinner",children:[t.jsx("div",{className:"spinner"}),t.jsx("p",{children:"Loading PDF..."})]})}),t.jsx(Mt,{mode:pe,onModeChange:_,highlightColor:g,onHighlightColorChange:ut,onHighlightClick:ht,hasTextSelection:!!le,isHighlightActive:!!j,showColorPicker:n,onImageUpload:dt,onToggleLayout:ge,showLayoutToggle:ue,onClearAll:()=>{Z([]),y(null)},pageNumber:A,numPages:m,onPrevPage:Me,onNextPage:Be,scale:f,onZoomIn:Oe,onZoomOut:Ae,onFitWidth:it,onFitHeight:rt,layout:k,onZoomInputClick:He,isEditingZoom:se,zoomInputValue:Y,onZoomInputChange:_e,onZoomInputBlur:Pe,onZoomInputKeyDown:ot,onZoomInputPaste:st,zoomInputRef:I}),t.jsx("div",{ref:N,className:`pdf-content ${a?"drag-over":""}`,onMouseUp:Ze,onKeyUp:Ze,onClick:at,onDragOver:ft,onDragLeave:gt,onDrop:e=>{F(!1),pt(e)},children:d&&t.jsx(yt,{file:ce||d,onLoadSuccess:Re,onLoadError:Fe,loading:t.jsx("div",{className:"loading",children:"Loading PDF..."}),error:t.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",t.jsx("br",{}),t.jsxs("small",{children:["Worker: ",Ie?.workerSrc||"Not set"]})]}),noData:t.jsx("div",{className:"loading",children:"No PDF file selected"}),options:ke,children:Array.from(new Array(m),(e,o)=>{const i=o+1,l=V.current.get(i);return t.jsxs("div",{ref:s=>{s?B.current.set(i,s):B.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[t.jsx(vt,{pageNumber:i,scale:f,devicePixelRatio:window.devicePixelRatio||1,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:s=>De({pageNumber:i,page:s})},`page_${i}_${re}`),l&&t.jsxs(t.Fragment,{children:[t.jsx(Ct,{pageNumber:i,pageWidth:l.width,pageHeight:l.height,scale:f,annotations:ae,selectedAnnotationId:O,onAnnotationUpdate:lt,onAnnotationDelete:ct,onAnnotationSelect:y,mode:pe}),M&&t.jsx(Nt,{pageNumber:i,pageWidth:l.width,pageHeight:l.height,scale:f,knowledgeNotes:fe,showKnowledgeNotes:M,layout:k,onNoteClick:x})]})]},`page-wrapper-${i}`)})})})]}),ye&&t.jsx("div",{className:"pdf-saving-overlay",children:t.jsxs("div",{className:"pdf-saving-content",children:[t.jsx("div",{className:"saving-spinner"}),t.jsx("p",{children:"Saving PDF..."}),t.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})})]})}export{Ht as default};
