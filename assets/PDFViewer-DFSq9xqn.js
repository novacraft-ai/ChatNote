const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r,j as e,D as we,P as be}from"./vendor-react-BWK-dEaB.js";import{_ as ee,B as ye,C as ve,a as xt}from"./index-0C4Z6WNA.js";import{G as Yt}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-CLrFw-IM.js";const ke=({pageNumber:l,pageWidth:x,pageHeight:R,scale:w,annotations:ot,selectedAnnotationId:C,onAnnotationUpdate:S,onAnnotationDelete:N,onAnnotationSelect:st,mode:K})=>{const b=r.useRef(null),[bt,X]=r.useState(!1),[y,J]=r.useState(!1),[v,yt]=r.useState(!1),[tt,gt]=r.useState({x:0,y:0}),[A,h]=r.useState(null),[m,nt]=r.useState(null),[U,wt]=r.useState({x:0,y:0,angle:0}),[f,it]=r.useState(null),rt=ot.filter(n=>n.pageNumber===l),[G,$]=r.useState(()=>({width:x*w,height:R*w,offsetLeft:0,offsetTop:0})),P=r.useCallback(()=>{const n=b.current?.parentElement;if(!n)return;const d=n.querySelector(".react-pdf__Page");if(!d)return;const g=n.getBoundingClientRect(),u=d.getBoundingClientRect();!u.width||!u.height||$(a=>{const L=Math.abs(a.width-u.width)>.5,j=Math.abs(a.height-u.height)>.5,z=Math.abs(a.offsetLeft-(u.left-g.left))>.5||Math.abs(a.offsetTop-(u.top-g.top))>.5;return L||j||z?{width:u.width,height:u.height,offsetLeft:u.left-g.left,offsetTop:u.top-g.top}:a})},[]);r.useEffect(()=>{P();const n=b.current?.parentElement;if(n&&typeof ResizeObserver<"u"){const g=new ResizeObserver(()=>P());return g.observe(n),()=>g.disconnect()}const d=()=>P();return window.addEventListener("resize",d),()=>{window.removeEventListener("resize",d)}},[P,x,R,w]),r.useEffect(()=>{P()},[w,x,R,P]);const Y=n=>n*G.width,H=n=>n*G.height,D=n=>n*G.width,ft=n=>n*G.height,Ct=n=>n/G.width,V=n=>n/G.height,lt=r.useCallback((n,d,g,u)=>{const a=1-g,L=1-u;return{x:Math.max(0,Math.min(a,n)),y:Math.max(0,Math.min(L,d)),width:Math.max(.01,Math.min(1,g)),height:Math.max(.01,Math.min(1,u))}},[]),Mt=r.useCallback((n,d,g,u)=>{const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.width=`${g}px`,a.style.fontSize=`${d*u}px`,a.style.fontFamily="inherit",a.style.whiteSpace="pre-wrap",a.style.wordWrap="break-word",a.style.overflowWrap="break-word",a.style.padding=`${4*u}px`,a.style.boxSizing="border-box",a.style.lineHeight="1.2",a.textContent=n||"Text",document.body.appendChild(a);const L=a.scrollHeight;return document.body.removeChild(a),L},[]),ct=r.useCallback((n,d)=>{n.stopPropagation();const g=n.target;if(g.classList.contains("resize-handle")){n.preventDefault(),J(!0),h(g.dataset.handle||null);const a=b.current?.getBoundingClientRect();a&&(gt({x:n.clientX-a.left,y:n.clientY-a.top}),nt({x:n.clientX-a.left,y:n.clientY-a.top,width:d.width,height:d.height,annotationX:d.x,annotationY:d.y}));return}if(g.classList.contains("rotate-handle")){n.preventDefault(),yt(!0);const a=b.current?.getBoundingClientRect();if(a){const L=Y(d.x+d.width/2),j=H(d.y+d.height/2),z=n.clientX-a.left,ht=n.clientY-a.top,vt=Math.atan2(ht-j,z-L)*(180/Math.PI);wt({x:z,y:ht,angle:d.rotation-vt})}return}if(g.classList.contains("delete-button")){n.preventDefault(),N(d.id);return}n.preventDefault(),st(d.id),X(!0);const u=b.current?.getBoundingClientRect();u&&gt({x:n.clientX-u.left-Y(d.x),y:n.clientY-u.top-H(d.y)})},[K,Y,H,st,N]);r.useEffect(()=>{if(!bt&&!y&&!v)return;const n=g=>{const u=b.current?.getBoundingClientRect();if(!u)return;const a=rt.find(L=>L.id===C);if(a){if(v){const L=Y(a.x+a.width/2),j=H(a.y+a.height/2),z=g.clientX-u.left,ht=g.clientY-u.top,vt=Math.atan2(ht-j,z-L)*(180/Math.PI),kt=(U.angle+vt)%360;Math.abs((a.rotation||0)-kt)>.01&&S({...a,rotation:kt})}else if(y&&A&&m){const L=g.clientX-u.left,j=g.clientY-u.top,z=L-m.x,ht=j-m.y,vt=.5,kt=z/(x*w)*vt,Rt=ht/(R*w)*vt;let Dt=m.annotationX,Tt=m.annotationY,Lt=m.width,Et=m.height;A.includes("n")&&(Tt=Math.max(0,m.annotationY+Rt),Et=Math.max(.01,m.height-Rt)),A.includes("s")&&(Et=Math.max(.01,m.height+Rt)),A.includes("w")&&(Dt=Math.max(0,m.annotationX+kt),Lt=Math.max(.01,m.width-kt)),A.includes("e")&&(Lt=Math.max(.01,m.width+kt));const St=lt(Dt,Tt,Lt,Et);if(a.type==="textbox"){const Bt=a,At=D(St.width),Ht=Mt(Bt.text,Bt.fontSize,At,w)/(R*w);if(Math.abs(Ht-St.height)>.001){const Ut=Math.max(.01,Math.min(1,Ht)),Ft=lt(Dt,Tt,St.width,Ut);(Math.abs((a.x||0)-Ft.x)>1e-4||Math.abs((a.y||0)-Ft.y)>1e-4||Math.abs((a.width||0)-Ft.width)>1e-4||Math.abs((a.height||0)-Ft.height)>1e-4)&&S({...a,...Ft})}else(Math.abs((a.x||0)-St.x)>1e-4||Math.abs((a.y||0)-St.y)>1e-4||Math.abs((a.width||0)-St.width)>1e-4||Math.abs((a.height||0)-St.height)>1e-4)&&S({...a,...St})}else S({...a,...St})}else if(bt){const L=Ct(g.clientX-u.left-tt.x),j=V(g.clientY-u.top-tt.y),z=lt(L,j,a.width,a.height);(Math.abs((a.x||0)-z.x)>1e-4||Math.abs((a.y||0)-z.y)>1e-4)&&S({...a,...z})}}},d=()=>{if(y&&C){const g=rt.find(u=>u.id===C);if(g&&g.type==="textbox"){const u=g,a=D(u.width),j=Mt(u.text,u.fontSize,a,w)/(R*w),z=lt(u.x,u.y,u.width,j);Math.abs(z.height-u.height)>.001&&S({...u,...z})}}X(!1),J(!1),yt(!1),h(null),nt(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",d),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",d)}},[bt,y,v,A,m,tt,U,C,rt,Y,H,D,ft,Ct,V,lt,Mt,S,x,R,w]),r.useEffect(()=>{const n=d=>{(d.key==="Delete"||d.key==="Backspace")&&C&&d.target.tagName!=="INPUT"&&d.target.tagName!=="TEXTAREA"&&(d.preventDefault(),N(C))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[C,N]);const Z=n=>{const d=n.id===C,g=Y(n.x),u=H(n.y),a=D(n.width),L=ft(n.height);return e.jsxs("div",{className:`annotation textbox-annotation ${d?"selected":""}`,style:{left:`${g}px`,top:`${u}px`,width:`${a}px`,height:`${L}px`,padding:`${4*w}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:j=>ct(j,n),children:[d&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:j=>{j.stopPropagation(),N(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),f===n.id?e.jsx("textarea",{className:"textbox-input",value:n.text,onChange:j=>{S({...n,text:j.target.value})},onBlur:j=>{const z=j.relatedTarget;z&&(z.closest(".textbox-controls")!==null||z.closest(".textbox-font-size-input")!==null||z.classList.contains("textbox-font-size-input")||z.closest(".floating-textbox-toolbar")!==null||z.closest(".color-swatch")!==null||z.classList.contains("toolbar-icon"))||(it(null),st(null))},onKeyDown:j=>{j.key==="Enter"&&!j.shiftKey&&(j.preventDefault(),it(null),st(null)),j.key==="Escape"&&(it(null),st(null))},style:{fontSize:`${n.fontSize*w}px`,color:n.color,width:`${a}px`,maxWidth:`${a}px`,height:`${L}px`,maxHeight:`${L}px`},autoFocus:!0}):e.jsx("div",{className:"textbox-content",onClick:j=>{j.stopPropagation();const z=j.target;z.closest(".textbox-controls")!==null||z.closest(".textbox-font-size-input")!==null||z.closest(".textbox-color-button")!==null||z.closest(".textbox-color-picker")!==null||it(n.id)},style:{fontSize:`${n.fontSize*w}px`,color:n.color},children:n.text||"Text"})]},n.id)},_=n=>{const d=n.id===C,g=Y(n.x),u=H(n.y),a=D(n.width),L=ft(n.height),j=n.width*x,z=n.height*R,ht=n.imageWidth/n.imageHeight,vt=j/z;let kt,Rt;return ht>vt?(kt=a,Rt=a/ht):(Rt=L,kt=L*ht),e.jsxs("div",{className:`annotation image-annotation ${d?"selected":""}`,style:{left:`${g}px`,top:`${u}px`,width:`${kt}px`,height:`${Rt}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:Dt=>ct(Dt,n),children:[d&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:Dt=>{Dt.stopPropagation(),N(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),e.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},k=n=>{const d=n.id===C,g=Y(n.x),u=H(n.y),a=D(n.width),L=ft(n.height);return e.jsx("div",{className:`annotation highlight-annotation ${d?"selected":""}`,style:{left:`${g}px`,top:`${u}px`,width:`${a}px`,height:`${L}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:j=>ct(j,n),children:d&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:j=>{j.stopPropagation(),N(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]})},n.id)},pt=G.width,O=G.height,dt={width:`${pt}px`,height:`${O}px`,left:`${G.offsetLeft}px`,top:`${G.offsetTop}px`,pointerEvents:"none"},E=rt.find(n=>n.id===C&&n.type==="textbox"),[M,mt]=r.useState(null);return r.useEffect(()=>{if(!E||!b.current){mt(null);return}const n=Y(E.x),d=H(E.y);mt({left:n+D(E.width)/2,top:Math.max(0,d-40)})},[E,x,R,w,f]),e.jsxs("div",{ref:b,className:"annotation-layer",style:dt,children:[rt.map(n=>n.type==="textbox"?Z(n):n.type==="image"?_(n):n.type==="highlight"?k(n):null),E&&f===E.id&&M&&e.jsxs("div",{className:"floating-textbox-toolbar",style:{left:`${M.left}px`,top:`${M.top}px`,position:"absolute",zIndex:9999},onMouseDown:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"font-size-group",children:[e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=E.fontSize||16;S({...E,fontSize:Math.max(1,n-1)})},title:"Decrease font size",children:"−"}),e.jsx("span",{className:"font-size-display",children:E.fontSize||16}),e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=E.fontSize||16;S({...E,fontSize:Math.min(200,n+1)})},title:"Increase font size",children:"+"})]}),e.jsx("div",{className:"color-swatch-group",children:["#000000","#ff0000","#0000ff","#00ff00","#ffeb3b"].map(n=>e.jsx("button",{className:`color-swatch ${E.color===n?"active":""}`,style:{backgroundColor:n},onClick:()=>S({...E,color:n}),title:n},n))})]})]})},je=({mode:l,onModeChange:x,highlightColor:R="#ffeb3b",onHighlightColorChange:w,onHighlightClick:ot,hasTextSelection:C=!1,isHighlightActive:S=!1,showColorPicker:N=!1,onImageUpload:st,layout:K,onToggleLayout:b,showLayoutToggle:bt=!0,onClearAll:X,pageNumber:y,numPages:J,onPrevPage:v,onNextPage:yt,scale:tt,onZoomIn:gt,onZoomOut:A,onFitWidth:h,onFitHeight:m,onZoomInputClick:nt,isEditingZoom:U,zoomInputValue:wt,onZoomInputChange:f,onZoomInputBlur:it,onZoomInputKeyDown:rt,onZoomInputPaste:G,zoomInputRef:$})=>{const P=r.useRef(null),[Y,H]=r.useState(!1),[D,ft]=r.useState(!1),[Ct,V]=r.useState(()=>typeof window<"u"?window.innerWidth<=720:!1),lt=r.useRef(null),Mt=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];r.useEffect(()=>{const _=k=>{Y&&(k.target.closest(".clear-button")||(H(!1),lt.current&&(clearTimeout(lt.current),lt.current=null)))};if(Y)return document.addEventListener("click",_),()=>{document.removeEventListener("click",_)}},[Y]),r.useEffect(()=>{if(typeof window>"u")return;const _=()=>{const k=window.innerWidth<=720;V(k),!k&&D&&ft(!1)};return _(),window.addEventListener("resize",_),()=>window.removeEventListener("resize",_)},[D]);const ct=_=>{const k=_.target.files?.[0];k&&k.type.startsWith("image/")&&st(k),x(null),P.current&&(P.current.value="")},Z=_=>{_.stopPropagation(),Y?(X&&X(),H(!1),lt.current&&(clearTimeout(lt.current),lt.current=null)):(H(!0),lt.current=setTimeout(()=>{H(!1),lt.current=null},3e3))};return e.jsxs("div",{className:"annotation-toolbar",children:[e.jsxs("div",{className:"toolbar-left",children:[Ct&&e.jsx("button",{type:"button",className:`toolbar-button mobile-tools-toggle ${D?"active":""}`,onClick:()=>ft(_=>!_),"aria-pressed":D,"aria-expanded":D,"aria-label":D?"Hide annotation tools":"Show annotation tools",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25Z",stroke:"currentColor",strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M14.06 6.19L17.31 2.94C17.7 2.55 18.33 2.55 18.72 2.94L21.06 5.28C21.45 5.67 21.45 6.3 21.06 6.69L17.81 9.94",stroke:"currentColor",strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsxs("div",{className:`toolbar-section annotation-tools ${Ct&&D?"mobile-visible":""}`,children:[e.jsx("button",{className:`toolbar-button ${S?"active":""}`,onClick:ot,disabled:!C,title:C?S?"Remove highlight":"Highlight text":"Select text to highlight",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),e.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),e.jsx("button",{className:`toolbar-button ${l==="textbox"?"active":""}`,onClick:()=>x("textbox"),title:"Add text box",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M4 7V4h16v3M9 20h6M12 4v16"})})}),e.jsx("button",{className:`toolbar-button ${l==="image"?"active":""}`,onClick:()=>{x("image"),P.current?.click()},title:"Add image",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]})}),X&&e.jsx("button",{className:`toolbar-button clear-button ${Y?"confirming":""}`,onClick:Z,title:Y?"Click again to clear all":"Clear all",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),e.jsx("input",{ref:P,type:"file",accept:"image/*",onChange:ct,style:{display:"none"}})]}),N&&w&&e.jsx("div",{className:"toolbar-section color-picker",children:Mt.map(_=>e.jsx("button",{className:`color-button ${R===_?"active":""}`,style:{backgroundColor:_},onClick:()=>w(_),title:"Highlight color"},_))})]}),e.jsxs("div",{className:"toolbar-center",children:[y!==void 0&&J!==void 0&&e.jsxs("div",{className:"toolbar-section pdf-navigation",children:[e.jsx("button",{className:"toolbar-button nav-button",onClick:v,disabled:y<=1,title:"Previous page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsxs("span",{className:"page-info",children:[y," / ",J]}),e.jsx("button",{className:"toolbar-button nav-button",onClick:yt,disabled:y>=J,title:"Next page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),tt!==void 0&&e.jsxs("div",{className:"toolbar-section zoom-controls",children:[e.jsx("button",{onClick:h,className:"toolbar-button",title:"Fit width",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"5 9 2 12 5 15"}),e.jsx("polyline",{points:"19 9 22 12 19 15"}),e.jsx("line",{x1:"2",y1:"12",x2:"22",y2:"12"})]})}),e.jsx("button",{onClick:m,className:"toolbar-button",title:"Fit height",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"9 5 12 2 15 5"}),e.jsx("polyline",{points:"9 19 12 22 15 19"}),e.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22"})]})}),e.jsx("button",{onClick:A,className:"toolbar-button",title:"Zoom out",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),U?e.jsx("input",{ref:$,type:"text",inputMode:"numeric",value:wt,onChange:f,onBlur:it,onKeyDown:rt,onPaste:G,className:"zoom-input"}):e.jsxs("span",{className:"zoom-level",onClick:nt,title:"Click to edit zoom",children:[Math.round((tt||1)*100),"%"]}),e.jsx("button",{onClick:gt,className:"toolbar-button",title:"Zoom in",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]}),e.jsx("div",{className:"toolbar-right",children:bt&&b&&e.jsx("div",{className:"toolbar-section toolbar-actions",children:e.jsx("button",{className:"toolbar-button layout-toggle-button",onClick:b,title:K==="floating"?"Switch to split layout":"Switch to floating layout",children:K==="floating"?e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("rect",{x:"3",y:"14",width:"7",height:"7"})]}):e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"21"})]})})})})]})},Ce=({pageNumber:l,pageWidth:x,pageHeight:R,scale:w,knowledgeNotes:ot,showKnowledgeNotes:C,onNoteClick:S})=>{const N=ot.filter(b=>b.pageNumber===l);if(!C||N.length===0)return null;const st=x*w,K=R*w;return e.jsx("div",{className:"knowledge-note-connections",style:{width:`${st}px`,height:`${K}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:e.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:N.map((b,bt)=>{const X=st-25,y=25+bt*35;return e.jsxs("g",{children:[e.jsx("circle",{cx:X,cy:y,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:J=>{J.stopPropagation(),S?.(b)},style:{cursor:"pointer",pointerEvents:"all"}}),e.jsx("text",{x:X,y,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:bt+1}),e.jsx("line",{x1:X,y1:y+12,x2:X,y2:y+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},b.id)})})})};let Vt,Pt=null,Qt=!1;async function Se(){if(!Vt)try{Vt=await ee(()=>import("./vendor-CLrFw-IM.js").then(l=>l.o),__vite__mapDeps([0,1]))}catch(l){throw console.error("Failed to load pdf-lib:",l),new Error("PDF library not available. Please install pdf-lib.")}return Vt}async function Ne(){if(!Qt){Qt=!0;try{const l=await ee(()=>import("./vendor-CLrFw-IM.js").then(x=>x.p),__vite__mapDeps([0,1]));return l.default?Pt=l.default:Pt=l,Pt&&typeof Pt.create=="function"?Pt:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(l){return console.warn("Failed to load fontkit, falling back to standard fonts:",l),null}}return Pt}async function Me(){try{const l=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],x="/ChatNote/",w=`${x.endsWith("/")?x:`${x}/`}NotoSans-Regular.ttf`;try{const ot=await fetch(w);if(ot.ok){const C=await ot.arrayBuffer();if(C.byteLength>1e3){const S=new Uint8Array(C);if(S.length>=4&&S[0]===0&&S[1]===1&&S[2]===0&&S[3]===0)return C}}}catch{}for(const ot of l)if(!ot.includes("fonts.googleapis.com/css"))try{const C=await fetch(ot,{mode:"cors",cache:"default"});if(C.ok){const S=await C.arrayBuffer();if(S.byteLength>1e3){const N=new Uint8Array(S),st=N.length>=4&&N[0]===0&&N[1]===1&&N[2]===0&&N[3]===0,K=N.length>=4&&N[0]===119&&N[1]===79&&N[2]===70&&N[3]===70,b=N.length>=4&&N[0]===119&&N[1]===79&&N[2]===70&&N[3]===50;if(st||K||b)return S;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(l){return console.warn("Failed to load Unicode font:",l),null}}async function Re(l,x,R){try{const w=await Se(),{PDFDocument:ot,rgb:C,degrees:S,StandardFonts:N}=w;if(!N)throw new Error("StandardFonts not available from pdf-lib");const st=await l.arrayBuffer(),K=await ot.load(st);let b=null;try{const y=await Ne();if(y){try{K.registerFontkit(y)}catch(v){(!v.message||!v.message.includes("already registered"))&&console.warn("Failed to register fontkit:",v)}const J=await Me();if(J){const v=new Uint8Array(J),yt=v.length>=4&&v[0]===0&&v[1]===1&&v[2]===0&&v[3]===0,tt=v.length>=4&&v[0]===79&&v[1]===84&&v[2]===84&&v[3]===79,gt=v.length>=4&&v[0]===116&&v[1]===116&&v[2]===99&&v[3]===102,A=v.length>=4&&v[0]===119&&v[1]===79&&v[2]===70&&v[3]===70,h=v.length>=4&&v[0]===119&&v[1]===79&&v[2]===70&&v[3]===50;A||h?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):yt||tt||gt?b=await K.embedFont(J):console.warn(`Invalid font format. File size: ${v.length} bytes`)}}}catch(y){console.warn("Failed to embed Unicode font, falling back to standard font:",y)}if(!b){const y=N.Helvetica||N.TimesRoman;if(!y)throw new Error("No standard font available");b=await K.embedFont(y)}if(!b)throw new Error("Failed to embed font");const bt=K.getPages();for(const y of x){const J=bt[y.pageNumber-1];if(!J)continue;const v=R.get(y.pageNumber);if(!v)continue;const{width:yt,height:tt}=v;let gt=y.width*yt,A=y.height*tt;if(y.type==="textbox"){const h=y,m=De(h.color)||{r:0,g:0,b:0},nt=y.x*yt,U=y.y*tt;let wt=(y.y+y.height)*tt;const f=4,it=gt-f*2,rt=(h.text||"").trimEnd();let $=rt.split(/\r\n|\r|\n/).filter(k=>k!=null);for(;$.length>0&&$[$.length-1].length===0;)$.pop();if($.length===0&&($=[""]),$.length===1&&b&&typeof b.widthOfTextAtSize=="function"){const k=$[0],pt=it;let O;try{O=b.widthOfTextAtSize(k,h.fontSize)}catch{O=k.length*h.fontSize*.5}if(O>pt){const dt=[],E=k.split(/(\s+)/);let M="";for(let mt=0;mt<E.length;mt++){const n=E[mt],d=M+n;let g;try{g=b.widthOfTextAtSize(d,h.fontSize)}catch{g=d.length*h.fontSize*.5}g<=pt||M===""?M=d:(M.trim()&&dt.push(M.trim()),M=n)}M.trim()&&dt.push(M.trim()),dt.length>1&&($=dt)}}const P=h.fontSize*1.2;A=$.length>0?($.length-1)*P+h.fontSize+f*2:h.fontSize+f*2,wt=U+A;const D=tt-wt,Ct=tt-U-D,lt=D+Ct/2,Mt=h.fontSize*.2,ct=tt-h.fontSize*.2,Z=Math.max(Mt,Math.min(ct,lt));if(($.length>1||rt.includes(`
`)||rt.includes("\r"))&&$.length>0)try{const k=($.length-1)*P,pt=Z+k/2;$.forEach((O,dt)=>{const E=pt-dt*P;let M;try{b&&typeof b.widthOfTextAtSize=="function"?M=b.widthOfTextAtSize(O,h.fontSize):M=O.length*h.fontSize*.5}catch{M=O.length*h.fontSize*.5}let n=nt+f+it/2-M/2;const d=nt+f,g=nt+gt-M-f;n=Math.max(d,Math.min(g,n));const u=O.length>0?O:" ";J.drawText(u,{x:n,y:E,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:b})})}catch(k){if(k.message&&k.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",k.message);const pt=$.map(E=>E.split("").map(M=>M.charCodeAt(0)>255?"?":M).join("")),O=(pt.length-1)*P,dt=Z+O/2;try{pt.forEach((E,M)=>{const mt=dt-M*P;let n;try{b&&typeof b.widthOfTextAtSize=="function"?n=b.widthOfTextAtSize(E,h.fontSize):n=E.length*h.fontSize*.5}catch{n=E.length*h.fontSize*.5}let g=nt+f+it/2-n/2;const u=nt+f,a=nt+gt-n-f;g=Math.max(u,Math.min(a,g)),J.drawText(E,{x:g,y:mt,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:b})})}catch(E){console.error("Failed to draw text even after replacing Unicode characters:",E);continue}}else throw k}else{let k;try{b&&typeof b.widthOfTextAtSize=="function"?k=b.widthOfTextAtSize(h.text,h.fontSize):k=h.text.length*h.fontSize*.5}catch{k=h.text.length*h.fontSize*.5}let O=nt+f+it/2-k/2;const dt=nt+f,E=nt+gt-k-f;O=Math.max(dt,Math.min(E,O));try{J.drawText(h.text,{x:O,y:Z,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:b})}catch(M){if(M.message&&M.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",M.message);const mt=h.text.split("").map(n=>n.charCodeAt(0)>255?"?":n).join("");try{J.drawText(mt,{x:O,y:Z,size:h.fontSize,color:C(m.r/255,m.g/255,m.b/255),rotate:S(h.rotation),font:b})}catch(n){console.error("Failed to draw text even after replacing Unicode characters:",n);continue}}else throw M}}}else if(y.type==="image"){const h=y,m=await fetch(h.imageData).then(H=>H.arrayBuffer());let nt;if(h.imageData.startsWith("data:image/png"))nt=await K.embedPng(m);else if(h.imageData.startsWith("data:image/jpeg")||h.imageData.startsWith("data:image/jpg"))nt=await K.embedJpg(m);else throw console.error("Unsupported image format for PDF embedding:",h.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const U=h.imageWidth/h.imageHeight;let wt=gt,f=A;gt/A>U?wt=A*U:f=gt/U;const rt=y.x*yt,G=(y.y+y.height)*tt,Y=tt-G+(A-f)/2;J.drawImage(nt,{x:rt,y:Y,width:wt,height:f,rotate:S(h.rotation)})}}const X=await K.save();return new Blob([X],{type:"application/pdf"})}catch(w){throw console.error("Error saving annotated PDF:",w),new Error("Failed to save annotated PDF")}}function De(l){const x=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(l);return x?{r:parseInt(x[1],16),g:parseInt(x[2],16),b:parseInt(x[3],16)}:null}function te(l,x="annotated.pdf"){const R=URL.createObjectURL(l),w=document.createElement("a");w.href=R,w.download=x,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(R)}const Ot="chatnote_pdf_history_cache",ze=300*1e3;function _t(l=3){const x=localStorage.getItem(Ot);let R=[];try{if(x){const w=JSON.parse(x);w&&Array.isArray(w.pdfs)&&(R=w.pdfs.slice(0,l))}}catch{}return R}function Ee(l){try{const x={pdfs:l,timestamp:Date.now()};localStorage.setItem(Ot,JSON.stringify(x))}catch{}}function Fe(l=ze){try{const x=localStorage.getItem(Ot);if(!x)return!1;const R=JSON.parse(x);return!R||typeof R.timestamp!="number"?!1:Date.now()-R.timestamp<l}catch{return!1}}async function Pe(l=3){try{const x=localStorage.getItem("auth_token");if(!x)return _t(l);const R=_t(l),w=Fe(),ot=fetch(`${ye}/api/drive/history`,{headers:{Authorization:`Bearer ${x}`}}).then(async S=>{if(!S.ok){if(S.status===403){try{localStorage.removeItem(Ot)}catch{}return[]}return[]}const st=(await S.json()).pdfs||[];return Ee(st),st.slice(0,l)}).catch(()=>[]);if(w)return ot.catch(()=>{}),R;const C=await ot;return C.length>0?C:R}catch{return _t(l)}}const Te="/ChatNote/assets/chatnote-logo-BGY00N4J.svg",Xt=l=>Math.max(0,Math.min(1,l)),Le=l=>l?(l.querySelector(".react-pdf__Page")??l).getBoundingClientRect():null;function $e({file:l,onFileUpload:x,onTextSelection:R,layout:w="floating",showLayoutToggle:ot=!0,onPageChange:C,onTotalPagesChange:S,showKnowledgeNotes:N=!0,knowledgeNotes:st=[],onScrollToPage:K,onNoteClick:b,onAddAnnotation:bt,initialAnnotations:X=[],onAnnotationsChange:y,isLoadingPdf:J=!1,onLoadingComplete:v,isSavingSession:yt=!1,onNewSession:tt,onToggleLayout:gt,isDriveAuthorized:A,onSelectRecentPdf:h}){const[m,nt]=r.useState(0),[U,wt]=r.useState(1),[f,it]=r.useState(1),[rt,G]=r.useState(!1),[$,P]=r.useState("100"),Y=r.useRef(null),H=r.useRef(new Map),D=r.useRef(null),ft=r.useRef(null),Ct=r.useRef(!1),V=r.useRef(new Map),[lt,Mt]=r.useState(0),[ct,Z]=r.useState(X),[_,k]=r.useState(null),[pt,O]=r.useState(null),[dt,E]=r.useState(null),[M,mt]=r.useState(null),[n,d]=r.useState(!1),[g,u]=r.useState("#ffeb3b"),[a,L]=r.useState(!1),j=r.useRef(X),z=r.useRef(y);r.useEffect(()=>{z.current=y},[y]),r.useEffect(()=>{const t=j.current,o=X.length!==t.length||X.some((i,c)=>i.id!==t[c]?.id);X&&X.length>0&&o?(Z(X),j.current=X):l&&X.length===0&&t.length>0?(Z([]),j.current=[],k(null)):!l&&t.length>0&&(Z([]),j.current=[],k(null))},[X,l]),r.useEffect(()=>{JSON.stringify(j.current)!==JSON.stringify(ct)&&z.current&&(j.current=ct,z.current(ct))},[ct]),r.useEffect(()=>{const t=console.warn,o=console.error;return console.warn=(...i)=>{const c=i.join(" ");c.includes("TextLayer task cancelled")||c.includes("AbortException")||i.some(s=>typeof s=="string"&&(s.includes("TextLayer task cancelled")||s.includes("AbortException")))||t.apply(console,i)},console.error=(...i)=>{const c=i.join(" ");c.includes("TextLayer task cancelled")||c.includes("AbortException")&&c.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=t,console.error=o}},[]);const ht=r.useMemo(()=>l?URL.createObjectURL(l):null,[l]),vt=r.useRef(null);r.useEffect(()=>(vt.current&&vt.current!==ht&&URL.revokeObjectURL(vt.current),vt.current=ht,()=>{ht&&URL.revokeObjectURL(ht)}),[ht]);const kt=r.useMemo(()=>{let t;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";t=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Yt&&(Yt.workerSrc=t,Yt.standardFontDataUrl=o),{workerSrc:t,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),Rt=({numPages:t})=>{nt(t),S?.(t);const o=1;wt(o),setTimeout(()=>{C?.(o)},0),H.current.clear(),V.current.clear(),v&&setTimeout(()=>{v()},300)},Dt=t=>{if(!V.current.has(t.pageNumber))try{const o=t.page;let i,c;o.viewport?(i=o.viewport.width,c=o.viewport.height):(i=o.width/f,c=o.height/f),V.current.set(t.pageNumber,{width:i,height:c})}catch(o){console.warn("Error getting page dimensions:",o);const i=t.page,c=i.width/f,s=i.height/f;V.current.set(t.pageNumber,{width:c,height:s})}};r.useEffect(()=>{if(!D.current||m===0)return;let t=null,o=!1;const i=()=>{if(Ct.current||o||t)return;o=!0,t=setTimeout(()=>{t=null,o=!1},100);const s=D.current;if(!s){o=!1;return}const p=s.getBoundingClientRect(),I=p.top,T=p.height,Q=I+T/2;if(s.scrollTop<100){wt(F=>F!==1?(setTimeout(()=>{C?.(1)},0),1):F);return}let ut=1,B=0;for(let F=1;F<=m;F++){const W=H.current.get(F);if(W){const at=W.getBoundingClientRect(),q=s.getBoundingClientRect(),jt=Math.max(q.top,at.top),Nt=Math.min(q.bottom,at.bottom),zt=Math.max(0,Nt-jt);zt>B&&(B=zt,ut=F)}}if(B<T*.1){let F=1,W=1/0;for(let at=1;at<=m;at++){const q=H.current.get(at);if(q){const jt=q.getBoundingClientRect(),Nt=jt.top+jt.height/2,zt=Math.abs(Nt-Q);zt<W&&(W=zt,F=at)}}ut=F}wt(F=>ut!==F?(setTimeout(()=>{C?.(ut)},0),ut):F)},c=D.current;return c?.addEventListener("scroll",i,{passive:!0}),()=>{t&&clearTimeout(t),c?.removeEventListener("scroll",i)}},[m,C]),r.useEffect(()=>{let t=null;const o=()=>{t&&clearTimeout(t),t=setTimeout(()=>{Mt(i=>i+1)},150)};return window.addEventListener("resize",o),()=>{t&&clearTimeout(t),window.removeEventListener("resize",o)}},[]);const Tt=t=>{console.error("PDF load error:",t)},Lt=async t=>{const o=t.target.files?.[0];if(o&&o.type==="application/pdf"){x(o);const i=o.size/(1024*1024),c=xt.generateDocumentId();xt.setCurrentDocument(c),await xt.createDocument(c,i),await xt.trackPDFUpload(i,c)}},Et=r.useCallback(t=>{const o=H.current.get(t);o&&D.current&&(Ct.current=!0,wt(t),C?.(t),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{Ct.current=!1},1500))},[C]);r.useEffect(()=>(K&&(window.__pdfScrollToPage=Et),D.current&&(window.__pdfContentRef=D.current),ft.current&&(window.__pdfViewerHeight=ft.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Et,K,m,f]);const St=()=>{const t=Math.max(1,U-1);Et(t)},Bt=()=>{const t=Math.min(m,U+1);Et(t)},At=()=>{const t=Math.min(f+.2,5);it(t),P(Math.round(t*100).toString())},Zt=()=>{const t=Math.max(f-.2,.25);it(t),P(Math.round(t*100).toString())};r.useEffect(()=>{rt||P(Math.round(f*100).toString())},[f,rt]);const Ht=()=>{G(!0),P(Math.round(f*100).toString())},Ut=t=>{let o=t.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),P(o)},Ft=()=>{qt()},ne=t=>{if(t.key==="Enter")t.preventDefault(),qt();else if(t.key==="Escape")G(!1),P(Math.round(f*100).toString()),Y.current?.blur();else{if(t.key==="Backspace"||t.key==="Delete"||t.key==="ArrowLeft"||t.key==="ArrowRight"||t.key==="Tab")return;(t.key==="-"||t.key==="+"||t.key==="."||t.key===","||t.key==="e"||t.key==="E"||!/[0-9]/.test(t.key)&&!t.ctrlKey&&!t.metaKey)&&t.preventDefault()}},oe=t=>{t.preventDefault();const i=t.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const s=(i.replace(/^0+/,"")||"0").slice(0,3);if(P(s),s&&s!=="0"){const p=parseInt(s,10);if(!isNaN(p)&&p>0){const I=Math.max(25,Math.min(500,p)),T=I/100;it(T),P(I.toString()),G(!1)}}}},qt=()=>{if($.trim()===""||$==="0"){P(Math.round(f*100).toString()),G(!1);return}const t=parseInt($,10);if(isNaN(t)||t<=0){P(Math.round(f*100).toString()),G(!1);return}const o=Math.max(25,Math.min(500,t)),i=o/100;it(i),P(o.toString()),G(!1)};r.useEffect(()=>{rt&&Y.current&&(Y.current.focus(),Y.current.select())},[rt]);const se=()=>{if(V.current.size===0)return;let t=null;if(D.current){const s=D.current,p=getComputedStyle(s),I=parseFloat(p.paddingLeft||"0")||0,T=parseFloat(p.paddingRight||"0")||0;t=s.clientWidth-I-T,s.scrollHeight>s.clientHeight&&(t-=12),t=Math.max(0,t-4)}else if(ft.current){const s=ft.current.getBoundingClientRect();t=Math.max(0,s.width-40)}if(!t||t<=0)return;const o=V.current.get(1);if(!o)return;const i=t/o.width*.999,c=Math.max(.1,Math.min(i,5));it(c),P(Math.round(c*100).toString())},ie=()=>{if(!ft.current||V.current.size===0)return;const t=ft.current.getBoundingClientRect();let o=0;const i=ft.current.querySelector(".annotation-toolbar");i&&(o=i.getBoundingClientRect().height);const c=t.height-o,s=V.current.get(U);if(!s)return;const p=c/s.height,I=Math.max(.1,Math.min(p,5));it(I),P(Math.round(I*100).toString())},Kt=r.useCallback(()=>{const t=window.getSelection();if(t&&t.toString().trim()){const o=t.toString().trim();let i,c;if(t.rangeCount>0&&D.current){const p=t.getRangeAt(0).getBoundingClientRect(),I=D.current.getBoundingClientRect(),T=p.top-I.top+D.current.scrollTop;for(let Q=1;Q<=m;Q++){const et=H.current.get(Q);if(et){const ut=et.offsetTop,B=et.offsetHeight,F=ut+B;if(T>=ut&&T<=F){c=Q;const W=(T-ut)/B;i=Math.max(0,Math.min(1,W)),E({text:o,pageNumber:Q,rect:p,pageElement:et});const at=ct.find(q=>q.type==="highlight"&&q.pageNumber===Q&&Math.abs(q.x-Math.max(0,Math.min(1,(p.left-et.getBoundingClientRect().left)/et.offsetWidth)))<.01&&Math.abs(q.y-Math.max(0,Math.min(1,W)))<.01);mt(at?.id||null);break}}}}R(o,c,i)}else R("",void 0,void 0),E(null),mt(null),d(!1)},[R,m,ct]),re=r.useCallback(t=>{const o=t.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.closest(".floating-textbox-toolbar")!==null||o.closest(".color-swatch")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker")||o.classList.contains("floating-textbox-toolbar")||o.classList.contains("color-swatch"))return;const c=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const s=window.getSelection(),p=s&&s.toString().trim().length>0;if(p||R(""),!c&&!p&&k(null),pt==="textbox"&&!c&&!p){const I=D.current;if(!I)return;let T=U,Q=.5,et=.5;for(let B=1;B<=m;B++){const F=H.current.get(B);if(F){const W=F.getBoundingClientRect();if(I.getBoundingClientRect()){const q=t.clientX-W.left,jt=t.clientY-W.top;if(q>=0&&q<=W.width&&jt>=0&&jt<=W.height){T=B;const Nt=V.current.get(B);if(Nt){const zt=W.width/Nt.width,xe=W.height/Nt.height;Q=q/(Nt.width*zt),et=jt/(Nt.height*xe)}break}}}}if(V.current.get(T)){const B=Math.max(0,Math.min(.8,Q-.1)),F=Math.max(0,Math.min(1-.1,et-.05)),W={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:T,x:B,y:F,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:ve[0]};Z(at=>{const q=[...at,W];return Wt(W).catch(jt=>{console.warn("Failed to track text box annotation:",jt)}),q}),k(W.id),O("select")}}},100)},[R,pt,U,m,f,k,O,Z]),Wt=r.useCallback(async t=>{Z(o=>[...o,t]),k(t.id);try{let o="text";t.type==="highlight"?o="highlight":t.type==="image"?o="image":t.type==="textbox"&&(o="text"),await xt.trackAnnotationAdded(o);const i=xt.getCurrentDocumentId();i&&await xt.updateDocument(i,{has_annotations:!0})}catch(o){console.warn("Failed to track annotation creation:",o)}},[]);r.useEffect(()=>(bt&&(window.__addPDFAnnotation=t=>{Z(o=>[...o,t]),k(t.id),t.pageNumber&&K&&K(t.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[bt,K]);const It=r.useCallback((t,o,i)=>{const c=t.width*o.width*i,s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${c}px`,s.style.fontSize=`${t.fontSize*i}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*i}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=t.text||"Text",document.body.appendChild(s);const p=s.scrollHeight;document.body.removeChild(s);const I=p/(o.height*i);return Math.max(.01,Math.min(1,I))},[]),ae=r.useCallback(t=>{Z(o=>{let i=!1;const c=o.map(s=>{if(s.id!==t.id)return s;if(t.type==="textbox"){const p=t,I=V.current.get(p.pageNumber);if(I){const T=It(p,I,f);return Math.abs((s.height||0)-T)>1e-4||Math.abs((s.x||0)-(p.x||0))>1e-4||Math.abs((s.y||0)-(p.y||0))>1e-4||Math.abs((s.width||0)-(p.width||0))>1e-4||Math.abs((s.rotation||0)-(p.rotation||0))>1e-4||s.type==="textbox"&&(s.text!==p.text||s.color!==p.color||s.fontSize!==p.fontSize)?(i=!0,{...p,height:T}):s}}return Math.abs((s.x||0)-(t.x||0))>1e-4||Math.abs((s.y||0)-(t.y||0))>1e-4||Math.abs((s.width||0)-(t.width||0))>1e-4||Math.abs((s.height||0)-(t.height||0))>1e-4||Math.abs((s.rotation||0)-(t.rotation||0))>1e-4||"color"in s&&"color"in t&&s.color!==t.color?(i=!0,t):s});return i?c:o})},[f,It]);r.useEffect(()=>{Z(t=>t.map(o=>{if(o.type==="textbox"){const i=o,c=V.current.get(i.pageNumber);if(c){const s=It(i,c,f);return{...i,height:s}}}return o}))},[f,It]);const le=r.useCallback(t=>{Z(o=>o.filter(i=>i.id!==t)),_===t&&k(null)},[_]),ce=r.useCallback(async t=>{if(!l||!V.current.get(U))return;const i=new FileReader;i.onload=c=>{const s=c.target?.result,p=new Image;p.onload=()=>{const I=!s.startsWith("data:image/png")&&!s.startsWith("data:image/jpeg")&&!s.startsWith("data:image/jpg");let T=s;if(I){const at=document.createElement("canvas");at.width=p.width,at.height=p.height;const q=at.getContext("2d");q&&(q.drawImage(p,0,0),T=at.toDataURL("image/png"))}const Q=.2,et=p.width/p.height,ut=Q/et,W={id:`image-${Date.now()}`,type:"image",pageNumber:U,x:.4,y:.4,width:Q,height:ut,rotation:0,imageData:T,imageWidth:p.width,imageHeight:p.height};Wt(W),O("select")},p.src=s},i.readAsDataURL(t)},[l,U,Wt,O]),de=r.useCallback(async()=>{if(!dt)return;const{pageNumber:t,rect:o,pageElement:i}=dt;if(M)Z(c=>c.filter(s=>s.id!==M)),mt(null),d(!1);else{const s=Le(i)??i.getBoundingClientRect(),p=s.width||i.offsetWidth,I=s.height||i.offsetHeight,T=Xt((o.left-s.left)/p),Q=Xt((o.top-s.top)/I),et=Xt(o.width/p),ut=Xt(o.height/I),B={id:crypto.randomUUID(),type:"highlight",pageNumber:t,x:T,y:Q,width:Math.max(.01,et),height:Math.max(.01,ut),rotation:0,color:g,opacity:.4};Z(F=>[...F,B]),mt(B.id),d(!0);try{await xt.trackAnnotationAdded("highlight");const F=xt.getCurrentDocumentId();F&&await xt.updateDocument(F,{has_annotations:!0})}catch(F){console.warn("Failed to track highlight annotation:",F)}}},[dt,M,g]),he=r.useCallback(t=>{u(t),M&&Z(o=>o.map(i=>i.id===M&&i.type==="highlight"?{...i,color:t}:i))},[M]),Jt=r.useCallback(async()=>{if(l)try{if(ct.length===0){const c=l.name;te(l,c),await xt.trackPDFExport(!1);const s=xt.getCurrentDocumentId();s&&await xt.updateDocument(s,{has_export:!0});return}const t=await Re(l,ct,V.current),o=l.name.replace(".pdf","_annotated.pdf");te(t,o),await xt.trackPDFExport(!0);const i=xt.getCurrentDocumentId();i&&await xt.updateDocument(i,{has_export:!0})}catch(t){console.error("Error saving PDF:",t),alert("Failed to save annotated PDF. Please check the console for details.")}},[l,ct]);r.useEffect(()=>{const t=()=>{tt&&tt()},o=()=>{Jt()};return window.addEventListener("pdf-new-session",t),window.addEventListener("pdf-download",o),()=>{window.removeEventListener("pdf-new-session",t),window.removeEventListener("pdf-download",o)}},[tt,Jt]);const ue=r.useCallback(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy",L(!0)},[]),fe=r.useCallback(t=>{t.preventDefault(),t.stopPropagation(),D.current?.contains(t.relatedTarget)||L(!1)},[]),ge=r.useCallback(async t=>{t.preventDefault(),t.stopPropagation();const i=Array.from(t.dataTransfer.files).filter(T=>T.type.startsWith("image/"));if(i.length===0||!D.current?.getBoundingClientRect())return;let s=U,p=.5,I=.5;for(let T=1;T<=m;T++){const Q=H.current.get(T);if(Q){const et=Q.getBoundingClientRect();if(D.current?.getBoundingClientRect()){const B=t.clientX-et.left,F=t.clientY-et.top;if(B>=0&&B<=et.width&&F>=0&&F<=et.height){s=T;const W=V.current.get(T);W&&(p=B/(W.width*f),I=F/(W.height*f));break}}}}for(const T of i){const Q=new FileReader;Q.onload=et=>{const ut=et.target?.result,B=new Image;B.onload=()=>{if(!V.current.get(s))return;const W=.2,at=B.width/B.height,q=W/at,jt=Math.max(0,Math.min(1-W,p-W/2)),Nt=Math.max(0,Math.min(1-q,I-q/2)),zt={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:s,x:jt,y:Nt,width:W,height:q,rotation:0,imageData:ut,imageWidth:B.width,imageHeight:B.height};Wt(zt)},B.src=ut},Q.readAsDataURL(T)}},[U,m,f,Wt]),[$t,pe]=r.useState(()=>_t(3)),[me,Gt]=r.useState(!1);if(r.useEffect(()=>{let t=!0;return A&&Pe(3).then(o=>{t&&o&&o.length>0&&pe(o)}).catch(()=>{}),()=>{t=!1}},[A]),r.useEffect(()=>{if(A&&$t&&$t.length>0){const t=requestAnimationFrame(()=>Gt(!0));return()=>cancelAnimationFrame(t)}Gt(!1)},[A,$t]),!l&&!J){const t=$t;return e.jsx("div",{className:`pdf-viewer-empty ${w==="floating"?"float-layout":""}`,children:e.jsxs("div",{className:"start-page-content",children:[e.jsxs("div",{className:"start-top",children:[e.jsx("img",{src:Te,alt:"ChatNote Logo",className:"start-logo"}),e.jsxs("div",{className:"upload-container",children:[e.jsxs("label",{htmlFor:"pdf-upload",className:"upload-button modern-upload",children:[e.jsx("span",{className:"upload-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 19V6M5 12l7-7 7 7"}),e.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1"})]})}),e.jsx("span",{children:"Upload PDF"})]}),e.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Lt,style:{display:"none"}})]})]}),A&&t.length>0&&e.jsxs("div",{className:"recent-pdf-suggestions",children:[e.jsx("div",{className:"suggestions-title",children:"Recent PDFs"}),e.jsx("div",{className:`suggestions-list ${me?"show":""}`,children:t.map((o,i)=>e.jsxs("button",{className:"suggestion-card",onClick:()=>h&&h(o.pdfId),children:[e.jsx("span",{className:"suggestion-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsx("span",{className:"suggestion-name",children:o.displayName||o.originalFileName})]},o.pdfId||i))})]})]})})}return e.jsxs("div",{className:`pdf-viewer ${yt?"saving-session":""}`,ref:ft,children:[J&&e.jsx("div",{className:"pdf-loading-overlay",children:e.jsxs("div",{className:"pdf-loading-spinner",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Loading PDF..."})]})}),yt&&e.jsx("div",{className:"pdf-saving-overlay",children:e.jsxs("div",{className:"pdf-saving-content",children:[e.jsx("div",{className:"saving-spinner"}),e.jsx("p",{children:"Saving PDF..."}),e.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})}),e.jsx(je,{mode:pt,onModeChange:O,highlightColor:g,onHighlightColorChange:he,onHighlightClick:de,hasTextSelection:!!dt,isHighlightActive:!!M,showColorPicker:n,onImageUpload:ce,onToggleLayout:gt,showLayoutToggle:ot,onClearAll:()=>{Z([]),k(null)},pageNumber:U,numPages:m,onPrevPage:St,onNextPage:Bt,scale:f,onZoomIn:At,onZoomOut:Zt,onFitWidth:se,onFitHeight:ie,layout:w,onZoomInputClick:Ht,isEditingZoom:rt,zoomInputValue:$,onZoomInputChange:Ut,onZoomInputBlur:Ft,onZoomInputKeyDown:ne,onZoomInputPaste:oe,zoomInputRef:Y}),e.jsx("div",{ref:D,className:`pdf-content ${a?"drag-over":""}`,onMouseUp:Kt,onKeyUp:Kt,onClick:re,onDragOver:ue,onDragLeave:fe,onDrop:t=>{L(!1),ge(t)},children:l&&e.jsx(we,{file:ht||l,onLoadSuccess:Rt,onLoadError:Tt,loading:e.jsx("div",{className:"loading",children:"Loading PDF..."}),error:e.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",e.jsx("br",{}),e.jsxs("small",{children:["Worker: ",Yt?.workerSrc||"Not set"]})]}),noData:e.jsx("div",{className:"loading",children:"No PDF file selected"}),options:kt,children:Array.from(new Array(m),(t,o)=>{const i=o+1,c=V.current.get(i);return e.jsxs("div",{ref:s=>{s?H.current.set(i,s):H.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[e.jsx(be,{pageNumber:i,scale:f,devicePixelRatio:window.devicePixelRatio||1,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:s=>Dt({pageNumber:i,page:s})},`page_${i}_${lt}`),c&&e.jsxs(e.Fragment,{children:[e.jsx(ke,{pageNumber:i,pageWidth:c.width,pageHeight:c.height,scale:f,annotations:ct,selectedAnnotationId:_,onAnnotationUpdate:ae,onAnnotationDelete:le,onAnnotationSelect:k,mode:pt}),N&&e.jsx(Ce,{pageNumber:i,pageWidth:c.width,pageHeight:c.height,scale:f,knowledgeNotes:st,showKnowledgeNotes:N,layout:w,onNoteClick:b})]})]},`page-wrapper-${i}`)})})})]})}export{$e as default};
