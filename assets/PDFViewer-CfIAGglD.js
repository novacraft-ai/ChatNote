const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r,j as t,a as ce,D as de,P as he}from"./vendor-react-BWK-dEaB.js";import{_ as Ut,C as _t,a as wt}from"./index-DUQSXbTy.js";import{G as Et}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-CLrFw-IM.js";const ue=({pageNumber:g,pageWidth:j,pageHeight:P,scale:w,annotations:z,selectedAnnotationId:l,onAnnotationUpdate:u,onAnnotationDelete:p,onAnnotationSelect:H,mode:A})=>{const k=r.useRef(null),[at,X]=r.useState(!1),[b,V]=r.useState(!1),[x,ht]=r.useState(!1),[tt,R]=r.useState({x:0,y:0}),[F,a]=r.useState(null),[C,v]=r.useState(null),[st,ut]=r.useState({x:0,y:0,angle:0}),[$,lt]=r.useState(null),U=z.filter(o=>o.pageNumber===g),nt=o=>o*j*w,S=o=>o*P*w,L=o=>o*j*w,it=o=>o*P*w,bt=o=>o/(j*w),yt=o=>o/(P*w),mt=r.useCallback((o,h,y,f)=>{const i=1-y,N=1-f;return{x:Math.max(0,Math.min(i,o)),y:Math.max(0,Math.min(N,h)),width:Math.max(.01,Math.min(1,y)),height:Math.max(.01,Math.min(1,f))}},[]),Z=r.useCallback((o,h,y,f)=>{const i=document.createElement("div");i.style.position="absolute",i.style.visibility="hidden",i.style.width=`${y}px`,i.style.fontSize=`${h*f}px`,i.style.fontFamily="inherit",i.style.whiteSpace="pre-wrap",i.style.wordWrap="break-word",i.style.overflowWrap="break-word",i.style.padding=`${4*f}px`,i.style.boxSizing="border-box",i.style.lineHeight="1.2",i.textContent=o||"Text",document.body.appendChild(i);const N=i.scrollHeight;return document.body.removeChild(i),N},[]),ot=r.useCallback((o,h)=>{o.stopPropagation();const y=o.target;if(y.classList.contains("resize-handle")){o.preventDefault(),V(!0),a(y.dataset.handle||null);const i=k.current?.getBoundingClientRect();i&&(R({x:o.clientX-i.left,y:o.clientY-i.top}),v({x:o.clientX-i.left,y:o.clientY-i.top,width:h.width,height:h.height,annotationX:h.x,annotationY:h.y}));return}if(y.classList.contains("rotate-handle")){o.preventDefault(),ht(!0);const i=k.current?.getBoundingClientRect();if(i){const N=nt(h.x+h.width/2),m=S(h.y+h.height/2),M=o.clientX-i.left,I=o.clientY-i.top,G=Math.atan2(I-m,M-N)*(180/Math.PI);ut({x:M,y:I,angle:h.rotation-G})}return}if(y.classList.contains("delete-button")){o.preventDefault(),p(h.id);return}o.preventDefault(),H(h.id),X(!0);const f=k.current?.getBoundingClientRect();f&&R({x:o.clientX-f.left-nt(h.x),y:o.clientY-f.top-S(h.y)})},[A,nt,S,H,p]);r.useEffect(()=>{if(!at&&!b&&!x)return;const o=y=>{const f=k.current?.getBoundingClientRect();if(!f)return;const i=U.find(N=>N.id===l);if(i){if(x){const N=nt(i.x+i.width/2),m=S(i.y+i.height/2),M=y.clientX-f.left,I=y.clientY-f.top,G=Math.atan2(I-m,M-N)*(180/Math.PI),rt=(st.angle+G)%360;u({...i,rotation:rt})}else if(b&&F&&C){const N=y.clientX-f.left,m=y.clientY-f.top,M=N-C.x,I=m-C.y,G=.5,rt=M/(j*w)*G,ct=I/(P*w)*G;let gt=C.annotationX,Dt=C.annotationY,Mt=C.width,zt=C.height;F.includes("n")&&(Dt=Math.max(0,C.annotationY+ct),zt=Math.max(.01,C.height-ct)),F.includes("s")&&(zt=Math.max(.01,C.height+ct)),F.includes("w")&&(gt=Math.max(0,C.annotationX+rt),Mt=Math.max(.01,C.width-rt)),F.includes("e")&&(Mt=Math.max(.01,C.width+rt));const Ct=mt(gt,Dt,Mt,zt);if(i.type==="textbox"){const Rt=i,Nt=L(Ct.width),Pt=Z(Rt.text,Rt.fontSize,Nt,w)/(P*w);if(Math.abs(Pt-Ct.height)>.001){const Lt=Math.max(.01,Math.min(1,Pt)),Wt=mt(gt,Dt,Ct.width,Lt);u({...i,...Wt})}else u({...i,...Ct})}else u({...i,...Ct})}else if(at){const N=bt(y.clientX-f.left-tt.x),m=yt(y.clientY-f.top-tt.y),M=mt(N,m,i.width,i.height);u({...i,...M})}}},h=()=>{if(b&&l){const y=U.find(f=>f.id===l);if(y&&y.type==="textbox"){const f=y,i=L(f.width),m=Z(f.text,f.fontSize,i,w)/(P*w),M=mt(f.x,f.y,f.width,m);Math.abs(M.height-f.height)>.001&&u({...f,...M})}}X(!1),V(!1),ht(!1),a(null),v(null)};return window.addEventListener("mousemove",o),window.addEventListener("mouseup",h),()=>{window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",h)}},[at,b,x,F,C,tt,st,l,U,nt,S,L,it,bt,yt,mt,Z,u,j,P,w]),r.useEffect(()=>{const o=h=>{(h.key==="Delete"||h.key==="Backspace")&&l&&h.target.tagName!=="INPUT"&&h.target.tagName!=="TEXTAREA"&&(h.preventDefault(),p(l))};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[l,p]);const et=o=>{const h=o.id===l,y=nt(o.x),f=S(o.y),i=L(o.width),N=it(o.height);return t.jsxs("div",{className:`annotation textbox-annotation ${h?"selected":""}`,style:{left:`${y}px`,top:`${f}px`,width:`${i}px`,height:`${N}px`,padding:`${4*w}px`,transform:`rotate(${o.rotation}deg)`,transformOrigin:"center center"},onMouseDown:m=>ot(m,o),children:[h&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:m=>{m.stopPropagation(),p(o.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),$===o.id?t.jsx("textarea",{className:"textbox-input",value:o.text,onChange:m=>{u({...o,text:m.target.value})},onBlur:m=>{const M=m.relatedTarget;M&&(M.closest(".textbox-controls")!==null||M.closest(".textbox-font-size-input")!==null||M.classList.contains("textbox-font-size-input"))||(lt(null),H(null))},onKeyDown:m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),lt(null),H(null)),m.key==="Escape"&&(lt(null),H(null))},style:{fontSize:`${o.fontSize*w}px`,color:o.color,width:`${i}px`,maxWidth:`${i}px`,height:`${N}px`,maxHeight:`${N}px`},autoFocus:!0}):t.jsx("div",{className:"textbox-content",onClick:m=>{m.stopPropagation();const M=m.target;M.closest(".textbox-controls")!==null||M.closest(".textbox-font-size-input")!==null||M.closest(".textbox-color-button")!==null||M.closest(".textbox-color-picker")!==null||lt(o.id)},style:{fontSize:`${o.fontSize*w}px`,color:o.color},children:o.text||"Text"})]},o.id)},kt=o=>{const h=o.id===l,y=nt(o.x),f=S(o.y),i=L(o.width),N=it(o.height),m=o.width*j,M=o.height*P,I=o.imageWidth/o.imageHeight,G=m/M;let rt,ct;return I>G?(rt=i,ct=i/I):(ct=N,rt=N*I),t.jsxs("div",{className:`annotation image-annotation ${h?"selected":""}`,style:{left:`${y}px`,top:`${f}px`,width:`${rt}px`,height:`${ct}px`,transform:`rotate(${o.rotation}deg)`,transformOrigin:"center center"},onMouseDown:gt=>ot(gt,o),children:[h&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:gt=>{gt.stopPropagation(),p(o.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),t.jsx("img",{src:o.imageData,alt:"Annotation",draggable:!1})]},o.id)},dt=o=>{const h=o.id===l,y=nt(o.x),f=S(o.y),i=L(o.width),N=it(o.height);return t.jsx("div",{className:`annotation highlight-annotation ${h?"selected":""}`,style:{left:`${y}px`,top:`${f}px`,width:`${i}px`,height:`${N}px`,backgroundColor:o.color,opacity:o.opacity||.4,transform:`rotate(${o.rotation}deg)`,transformOrigin:"center center"},onMouseDown:m=>ot(m,o),children:h&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:m=>{m.stopPropagation(),p(o.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]})},o.id)},ft=j*w,jt=P*w,B={width:`${ft}px`,height:`${jt}px`,pointerEvents:"none"};return t.jsx("div",{ref:k,className:"annotation-layer",style:B,children:U.map(o=>o.type==="textbox"?et(o):o.type==="image"?kt(o):o.type==="highlight"?dt(o):null)})},ge=({mode:g,onModeChange:j,highlightColor:P="#ffeb3b",onHighlightColorChange:w,onHighlightClick:z,hasTextSelection:l=!1,isHighlightActive:u=!1,showColorPicker:p=!1,onImageUpload:H,onDownload:A,onNewSession:k,onClearAll:at})=>{const X=r.useRef(null),[b,V]=r.useState(!1),x=r.useRef(null),ht=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];ce.useEffect(()=>{const F=a=>{b&&(a.target.closest(".clear-button")||(V(!1),x.current&&(clearTimeout(x.current),x.current=null)))};if(b)return document.addEventListener("click",F),()=>{document.removeEventListener("click",F)}},[b]);const tt=F=>{const a=F.target.files?.[0];a&&a.type.startsWith("image/")&&H(a),j(null),X.current&&(X.current.value="")},R=F=>{F.stopPropagation(),b?(at&&at(),V(!1),x.current&&(clearTimeout(x.current),x.current=null)):(V(!0),x.current=setTimeout(()=>{V(!1),x.current=null},3e3))};return t.jsxs("div",{className:"annotation-toolbar",children:[t.jsxs("div",{className:"toolbar-section",children:[t.jsx("button",{className:`toolbar-button ${u?"active":""}`,onClick:z,disabled:!l,title:l?u?"Remove highlight":"Highlight text":"Select text to highlight",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),t.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),t.jsxs("button",{className:`toolbar-button ${g==="textbox"?"active":""}`,onClick:()=>j("textbox"),title:"Add text box (click on PDF to add)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M4 20h16"}),t.jsx("path",{d:"M6 4v16"}),t.jsx("path",{d:"M18 4v16"}),t.jsx("path",{d:"M4 7h16"}),t.jsx("path",{d:"M4 10h16"}),t.jsx("path",{d:"M4 13h16"}),t.jsx("path",{d:"M4 16h16"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Text"})]}),t.jsxs("button",{className:`toolbar-button ${g==="image"?"active":""}`,onClick:()=>{j("image"),X.current?.click()},title:"Add image (click to upload)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),t.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t.jsx("polyline",{points:"21 15 16 10 5 21"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Image"})]}),at&&t.jsxs("button",{className:`toolbar-button clear-button ${b?"confirming":""}`,onClick:R,title:b?"Click again to clear all annotations":"Clear all annotations",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"3 6 5 6 21 6"}),t.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Clear All"})]}),t.jsx("input",{ref:X,type:"file",accept:"image/*",onChange:tt,style:{display:"none"}})]}),p&&w&&t.jsx("div",{className:"toolbar-section color-picker",children:ht.map(F=>t.jsx("button",{className:`color-button ${P===F?"active":""}`,style:{backgroundColor:F},onClick:()=>w(F),title:"Select highlight color"},F))}),t.jsxs("div",{className:"toolbar-section toolbar-actions",children:[k&&t.jsxs("button",{className:"toolbar-button new-session-button",onClick:k,title:"Start new session (save current and upload new PDF)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),t.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),t.jsx("span",{className:"toolbar-button-text",children:"New Session"})]}),t.jsxs("button",{className:"toolbar-button download-button",onClick:A,title:"Download annotated PDF",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),t.jsx("polyline",{points:"7 10 12 15 17 10"}),t.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Download"})]})]})]})},fe=({pageNumber:g,pageWidth:j,pageHeight:P,scale:w,knowledgeNotes:z,showKnowledgeNotes:l,onNoteClick:u})=>{const p=z.filter(k=>k.pageNumber===g);if(!l||p.length===0)return null;const H=j*w,A=P*w;return t.jsx("div",{className:"knowledge-note-connections",style:{width:`${H}px`,height:`${A}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:t.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:p.map((k,at)=>{const X=H-25,b=25+at*35;return t.jsxs("g",{children:[t.jsx("circle",{cx:X,cy:b,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:V=>{V.stopPropagation(),u?.(k)},style:{cursor:"pointer",pointerEvents:"all"}}),t.jsx("text",{x:X,y:b,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:at+1}),t.jsx("line",{x1:X,y1:b+12,x2:X,y2:b+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},k.id)})})})};let Bt,St=null,Ot=!1;async function pe(){if(!Bt)try{Bt=await Ut(()=>import("./vendor-CLrFw-IM.js").then(g=>g.o),__vite__mapDeps([0,1]))}catch(g){throw console.error("Failed to load pdf-lib:",g),new Error("PDF library not available. Please install pdf-lib.")}return Bt}async function me(){if(!Ot){Ot=!0;try{const g=await Ut(()=>import("./vendor-CLrFw-IM.js").then(j=>j.p),__vite__mapDeps([0,1]));return g.default?St=g.default:St=g,St&&typeof St.create=="function"?St:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(g){return console.warn("Failed to load fontkit, falling back to standard fonts:",g),null}}return St}async function xe(){try{const g=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],j="/ChatNote/",w=`${j.endsWith("/")?j:`${j}/`}NotoSans-Regular.ttf`;try{const z=await fetch(w);if(z.ok){const l=await z.arrayBuffer();if(l.byteLength>1e3){const u=new Uint8Array(l);if(u.length>=4&&u[0]===0&&u[1]===1&&u[2]===0&&u[3]===0)return l}}}catch{}for(const z of g)if(!z.includes("fonts.googleapis.com/css"))try{const l=await fetch(z,{mode:"cors",cache:"default"});if(l.ok){const u=await l.arrayBuffer();if(u.byteLength>1e3){const p=new Uint8Array(u),H=p.length>=4&&p[0]===0&&p[1]===1&&p[2]===0&&p[3]===0,A=p.length>=4&&p[0]===119&&p[1]===79&&p[2]===70&&p[3]===70,k=p.length>=4&&p[0]===119&&p[1]===79&&p[2]===70&&p[3]===50;if(H||A||k)return u;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(g){return console.warn("Failed to load Unicode font:",g),null}}async function we(g,j,P){try{const w=await pe(),{PDFDocument:z,rgb:l,degrees:u,StandardFonts:p}=w;if(!p)throw new Error("StandardFonts not available from pdf-lib");const H=await g.arrayBuffer(),A=await z.load(H);let k=null;try{const b=await me();if(b){try{A.registerFontkit(b)}catch(x){(!x.message||!x.message.includes("already registered"))&&console.warn("Failed to register fontkit:",x)}const V=await xe();if(V){const x=new Uint8Array(V),ht=x.length>=4&&x[0]===0&&x[1]===1&&x[2]===0&&x[3]===0,tt=x.length>=4&&x[0]===79&&x[1]===84&&x[2]===84&&x[3]===79,R=x.length>=4&&x[0]===116&&x[1]===116&&x[2]===99&&x[3]===102,F=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===70,a=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===50;F||a?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):ht||tt||R?k=await A.embedFont(V):console.warn(`Invalid font format. File size: ${x.length} bytes`)}}}catch(b){console.warn("Failed to embed Unicode font, falling back to standard font:",b)}if(!k){const b=p.Helvetica||p.TimesRoman;if(!b)throw new Error("No standard font available");k=await A.embedFont(b)}if(!k)throw new Error("Failed to embed font");const at=A.getPages();for(const b of j){const V=at[b.pageNumber-1];if(!V)continue;const x=P.get(b.pageNumber);if(!x)continue;const{width:ht,height:tt}=x;let R=b.width*ht,F=b.height*tt;if(b.type==="textbox"){const a=b,C=be(a.color)||{r:0,g:0,b:0},v=b.x*ht,st=b.y*tt;let ut=(b.y+b.height)*tt;const $=4,lt=R-$*2,U=(a.text||"").trimEnd();let S=U.split(/\r\n|\r|\n/).filter(B=>B!=null);for(;S.length>0&&S[S.length-1].length===0;)S.pop();if(S.length===0&&(S=[""]),S.length===1&&k&&typeof k.widthOfTextAtSize=="function"){const B=S[0],o=lt;let h;try{h=k.widthOfTextAtSize(B,a.fontSize)}catch{h=B.length*a.fontSize*.5}if(h>o){const y=[],f=B.split(/(\s+)/);let i="";for(let N=0;N<f.length;N++){const m=f[N],M=i+m;let I;try{I=k.widthOfTextAtSize(M,a.fontSize)}catch{I=M.length*a.fontSize*.5}I<=o||i===""?i=M:(i.trim()&&y.push(i.trim()),i=m)}i.trim()&&y.push(i.trim()),y.length>1&&(S=y)}}const L=a.fontSize*1.2;F=S.length>0?(S.length-1)*L+a.fontSize+$*2:a.fontSize+$*2,ut=st+F;const yt=tt-ut,Z=tt-st-yt,et=yt+Z/2,kt=a.fontSize*.2,dt=tt-a.fontSize*.2,ft=Math.max(kt,Math.min(dt,et));if((S.length>1||U.includes(`
`)||U.includes("\r"))&&S.length>0)try{const B=(S.length-1)*L,o=ft+B/2;S.forEach((h,y)=>{const f=o-y*L;let i;try{k&&typeof k.widthOfTextAtSize=="function"?i=k.widthOfTextAtSize(h,a.fontSize):i=h.length*a.fontSize*.5}catch{i=h.length*a.fontSize*.5}let m=v+$+lt/2-i/2;const M=v+$,I=v+R-i-$;m=Math.max(M,Math.min(I,m));const G=h.length>0?h:" ";V.drawText(G,{x:m,y:f,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:u(a.rotation),font:k})})}catch(B){if(B.message&&B.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",B.message);const o=S.map(f=>f.split("").map(i=>i.charCodeAt(0)>255?"?":i).join("")),h=(o.length-1)*L,y=ft+h/2;try{o.forEach((f,i)=>{const N=y-i*L;let m;try{k&&typeof k.widthOfTextAtSize=="function"?m=k.widthOfTextAtSize(f,a.fontSize):m=f.length*a.fontSize*.5}catch{m=f.length*a.fontSize*.5}let I=v+$+lt/2-m/2;const G=v+$,rt=v+R-m-$;I=Math.max(G,Math.min(rt,I)),V.drawText(f,{x:I,y:N,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:u(a.rotation),font:k})})}catch(f){console.error("Failed to draw text even after replacing Unicode characters:",f);continue}}else throw B}else{let B;try{k&&typeof k.widthOfTextAtSize=="function"?B=k.widthOfTextAtSize(a.text,a.fontSize):B=a.text.length*a.fontSize*.5}catch{B=a.text.length*a.fontSize*.5}let h=v+$+lt/2-B/2;const y=v+$,f=v+R-B-$;h=Math.max(y,Math.min(f,h));try{V.drawText(a.text,{x:h,y:ft,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:u(a.rotation),font:k})}catch(i){if(i.message&&i.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",i.message);const N=a.text.split("").map(m=>m.charCodeAt(0)>255?"?":m).join("");try{V.drawText(N,{x:h,y:ft,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:u(a.rotation),font:k})}catch(m){console.error("Failed to draw text even after replacing Unicode characters:",m);continue}}else throw i}}}else if(b.type==="image"){const a=b,C=await fetch(a.imageData).then(bt=>bt.arrayBuffer());let v;if(a.imageData.startsWith("data:image/png"))v=await A.embedPng(C);else if(a.imageData.startsWith("data:image/jpeg")||a.imageData.startsWith("data:image/jpg"))v=await A.embedJpg(C);else throw console.error("Unsupported image format for PDF embedding:",a.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const st=a.imageWidth/a.imageHeight;let ut=R,$=F;R/F>st?ut=F*st:$=R/st;const U=b.x*ht,nt=(b.y+b.height)*tt,it=tt-nt+(F-$)/2;V.drawImage(v,{x:U,y:it,width:ut,height:$,rotate:u(a.rotation)})}}const X=await A.save();return new Blob([X],{type:"application/pdf"})}catch(w){throw console.error("Error saving annotated PDF:",w),new Error("Failed to save annotated PDF")}}function be(g){const j=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(g);return j?{r:parseInt(j[1],16),g:parseInt(j[2],16),b:parseInt(j[3],16)}:null}function ye(g,j="annotated.pdf"){const P=URL.createObjectURL(g),w=document.createElement("a");w.href=P,w.download=j,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(P)}const ve=({selectedAnnotation:g,onUpdate:j})=>{const[P,w]=r.useState(g.fontSize.toString()),z=r.useRef(g.fontSize);return r.useEffect(()=>{z.current=g.fontSize,w(g.fontSize.toString())},[g.id,g.fontSize]),t.jsxs("div",{className:"textbox-controls",onClick:l=>{l.target.closest('input[type="number"]')||l.stopPropagation()},onMouseDown:l=>{l.target.closest('input[type="number"]')||l.stopPropagation()},children:[t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Font Size:"}),t.jsxs("div",{className:"font-size-input-wrapper",children:[t.jsx("button",{type:"button",className:"font-size-arrow-button font-size-arrow-left",onClick:l=>{l.stopPropagation(),l.preventDefault();const u=parseInt(P,10)||z.current,p=Math.max(1,u-1);w(p.toString());const H={...g,fontSize:p};j(H),z.current=p},onMouseDown:l=>{l.stopPropagation(),l.preventDefault()},title:"Decrease font size",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"15 18 9 12 15 6"})})}),t.jsx("input",{type:"number",min:"1",max:"200",value:P,onChange:l=>{const u=l.target.value;if(w(u),u===""||u==="-")return;const p=parseInt(u,10);if(!isNaN(p)&&p>0){const H=Math.max(1,Math.min(200,p)),A={...g,fontSize:H};j(A),z.current=H}},onBlur:l=>{const u=l.target.value.trim();if(u===""||u==="-"||isNaN(parseInt(u,10))||parseInt(u,10)<=0)w(z.current.toString());else{const p=parseInt(u,10),H=Math.max(1,Math.min(200,p));H!==p&&w(H.toString()),z.current=H}},onMouseDown:l=>{l.stopPropagation()},onClick:l=>{l.stopPropagation()},onFocus:l=>{l.stopPropagation()},onWheel:l=>{l.stopPropagation()},className:"textbox-font-size-input"}),t.jsx("button",{type:"button",className:"font-size-arrow-button font-size-arrow-right",onClick:l=>{l.stopPropagation(),l.preventDefault();const u=parseInt(P,10)||z.current,p=Math.min(200,u+1);w(p.toString());const H={...g,fontSize:p};j(H),z.current=p},onMouseDown:l=>{l.stopPropagation(),l.preventDefault()},title:"Increase font size",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"9 18 15 12 9 6"})})})]})]}),t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Color:"}),t.jsx("div",{className:"textbox-color-picker",children:_t.map(l=>t.jsx("button",{className:`textbox-color-button ${g.color===l?"active":""}`,style:{backgroundColor:l},onClick:u=>{u.stopPropagation(),u.preventDefault(),j({...g,color:l})},onMouseDown:u=>{u.stopPropagation(),u.preventDefault()},onFocus:u=>{u.stopPropagation()},title:l},l))})]})]})};function Ne({file:g,onFileUpload:j,onTextSelection:P,layout:w="floating",onPageChange:z,onTotalPagesChange:l,showKnowledgeNotes:u=!0,onToggleKnowledgeNotes:p,knowledgeNotes:H=[],onScrollToPage:A,onNoteClick:k,onAddAnnotation:at,initialAnnotations:X=[],onAnnotationsChange:b,isLoadingPdf:V=!1,onLoadingComplete:x,isSavingSession:ht=!1,onNewSession:tt}){const[R,F]=r.useState(0),[a,C]=r.useState(1),[v,st]=r.useState(1),[ut,$]=r.useState(!1),[lt,U]=r.useState("100"),nt=r.useRef(null),S=r.useRef(new Map),L=r.useRef(null),it=r.useRef(null),bt=r.useRef(null),yt=r.useRef(null),mt=r.useRef(!1),Z=r.useRef(new Map),[ot,et]=r.useState(X),[kt,dt]=r.useState(null),[ft,jt]=r.useState(null),[B,o]=r.useState(null),[h,y]=r.useState(null),[f,i]=r.useState(!1),[N,m]=r.useState("#ffeb3b"),[M,I]=r.useState(!1),G=r.useRef(X),rt=r.useRef(b);r.useEffect(()=>{rt.current=b},[b]),r.useEffect(()=>{const e=G.current,n=X.length!==e.length||X.some((s,d)=>s.id!==e[d]?.id);X&&X.length>0&&n?(et(X),G.current=X):g&&X.length===0&&e.length>0?(et([]),G.current=[],dt(null)):!g&&e.length>0&&(et([]),G.current=[],dt(null))},[X,g]),r.useEffect(()=>{JSON.stringify(G.current)!==JSON.stringify(ot)&&rt.current&&(G.current=ot,rt.current(ot))},[ot]),r.useEffect(()=>{const e=console.warn,n=console.error;return console.warn=(...s)=>{const d=s.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")||s.some(c=>typeof c=="string"&&(c.includes("TextLayer task cancelled")||c.includes("AbortException")))||e.apply(console,s)},console.error=(...s)=>{const d=s.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")&&d.includes("TextLayer")||n.apply(console,s)},()=>{console.warn=e,console.error=n}},[]);const ct=r.useMemo(()=>g?URL.createObjectURL(g):null,[g]),gt=r.useRef(null);r.useEffect(()=>(gt.current&&gt.current!==ct&&URL.revokeObjectURL(gt.current),gt.current=ct,()=>{ct&&URL.revokeObjectURL(ct)}),[ct]);const Dt=r.useMemo(()=>{let e;const n="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const s="/ChatNote/";e=`${s.endsWith("/")?s:`${s}/`}pdf.worker.min.js`}return Et&&(Et.workerSrc=e,Et.standardFontDataUrl=n),{workerSrc:e,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:n,verbosity:0}},[]),Mt=({numPages:e})=>{F(e),l?.(e);const n=1;C(n),setTimeout(()=>{z?.(n)},0),S.current.clear(),Z.current.clear(),x&&setTimeout(()=>{x()},300)},zt=e=>{if(!Z.current.has(e.pageNumber))try{const n=e.page;let s,d;n.viewport?(s=n.viewport.width,d=n.viewport.height):(s=n.width/v,d=n.height/v),Z.current.set(e.pageNumber,{width:s,height:d})}catch(n){console.warn("Error getting page dimensions:",n);const s=e.page,d=s.width/v,c=s.height/v;Z.current.set(e.pageNumber,{width:d,height:c})}};r.useEffect(()=>{if(!L.current||R===0)return;let e=null,n=!1;const s=()=>{if(mt.current||n||e)return;n=!0,e=setTimeout(()=>{e=null,n=!1},100);const c=L.current;if(!c){n=!1;return}const D=c.getBoundingClientRect(),_=D.top,T=D.height,O=_+T/2;if(c.scrollTop<100){C(Y=>Y!==1?(setTimeout(()=>{z?.(1)},0),1):Y);return}let J=1,W=0;for(let Y=1;Y<=R;Y++){const E=S.current.get(Y);if(E){const Q=E.getBoundingClientRect(),K=c.getBoundingClientRect(),xt=Math.max(K.top,Q.top),pt=Math.min(K.bottom,Q.bottom),vt=Math.max(0,pt-xt);vt>W&&(W=vt,J=Y)}}if(W<T*.1){let Y=1,E=1/0;for(let Q=1;Q<=R;Q++){const K=S.current.get(Q);if(K){const xt=K.getBoundingClientRect(),pt=xt.top+xt.height/2,vt=Math.abs(pt-O);vt<E&&(E=vt,Y=Q)}}J=Y}C(Y=>J!==Y?(setTimeout(()=>{z?.(J)},0),J):Y)},d=L.current;return d?.addEventListener("scroll",s,{passive:!0}),()=>{e&&clearTimeout(e),d?.removeEventListener("scroll",s)}},[R,z]);const Ct=e=>{console.error("PDF load error:",e)},Rt=async e=>{const n=e.target.files?.[0];if(n&&n.type==="application/pdf"){j(n);const s=n.size/(1024*1024),d=wt.generateDocumentId();wt.setCurrentDocument(d),await wt.createDocument(d,s),await wt.trackPDFUpload(s,d)}},Nt=r.useCallback(e=>{const n=S.current.get(e);n&&L.current&&(mt.current=!0,C(e),z?.(e),n.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{mt.current=!1},1500))},[z]);r.useEffect(()=>(A&&(window.__pdfScrollToPage=Nt),L.current&&(window.__pdfContentRef=L.current),it.current&&(window.__pdfViewerHeight=it.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Nt,A,R,v]);const Yt=()=>{const e=Math.max(1,a-1);Nt(e)},Pt=()=>{const e=Math.min(R,a+1);Nt(e)},Lt=()=>{const e=Math.min(v+.2,5);st(e),U(Math.round(e*100).toString())},Wt=()=>{const e=Math.max(v-.2,.25);st(e),U(Math.round(e*100).toString())};r.useEffect(()=>{ut||U(Math.round(v*100).toString())},[v,ut]);const At=()=>{$(!0),U(Math.round(v*100).toString())},Vt=e=>{let n=e.target.value;n=n.replace(/[^0-9]/g,""),n.length>1&&n.startsWith("0")&&(n=n.replace(/^0+/,"")||"0"),n.length>3&&(n=n.slice(0,3)),U(n)},Zt=()=>{Xt()},qt=e=>{if(e.key==="Enter")e.preventDefault(),Xt();else if(e.key==="Escape")$(!1),U(Math.round(v*100).toString()),nt.current?.blur();else{if(e.key==="Backspace"||e.key==="Delete"||e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Tab")return;(e.key==="-"||e.key==="+"||e.key==="."||e.key===","||e.key==="e"||e.key==="E"||!/[0-9]/.test(e.key)&&!e.ctrlKey&&!e.metaKey)&&e.preventDefault()}},Kt=e=>{e.preventDefault();const s=e.clipboardData.getData("text").replace(/[^0-9]/g,"");if(s){const c=(s.replace(/^0+/,"")||"0").slice(0,3);if(U(c),c&&c!=="0"){const D=parseInt(c,10);if(!isNaN(D)&&D>0){const _=Math.max(25,Math.min(500,D)),T=_/100;st(T),U(_.toString()),$(!1)}}}},Xt=()=>{if(lt.trim()===""||lt==="0"){U(Math.round(v*100).toString()),$(!1);return}const e=parseInt(lt,10);if(isNaN(e)||e<=0){U(Math.round(v*100).toString()),$(!1);return}const n=Math.max(25,Math.min(500,e)),s=n/100;st(s),U(n.toString()),$(!1)};r.useEffect(()=>{ut&&nt.current&&(nt.current.focus(),nt.current.select())},[ut]);const Gt=()=>{if(!it.current||Z.current.size===0)return;const e=it.current.getBoundingClientRect();let n;n=e.width-40;const s=Z.current.get(1);if(!s)return;const d=n/s.width,c=Math.max(.1,Math.min(d,5));st(c),U(Math.round(c*100).toString())},Jt=()=>{if(!it.current||Z.current.size===0)return;const e=it.current.getBoundingClientRect();let n=0,s=0;bt.current&&(n=bt.current.getBoundingClientRect().height),yt.current&&(s=yt.current.getBoundingClientRect().height);let d=0;const c=it.current.querySelector(".annotation-toolbar");c&&(d=c.getBoundingClientRect().height);const D=e.height-n-s-d,_=Z.current.get(a);if(!_)return;const T=D/_.height,O=Math.max(.1,Math.min(T,5));st(O),U(Math.round(O*100).toString())},$t=r.useCallback(()=>{const e=window.getSelection();if(e&&e.toString().trim()){const n=e.toString().trim();let s,d;if(e.rangeCount>0&&L.current){const D=e.getRangeAt(0).getBoundingClientRect(),_=L.current.getBoundingClientRect(),T=D.top-_.top+L.current.scrollTop;for(let O=1;O<=R;O++){const q=S.current.get(O);if(q){const J=q.offsetTop,W=q.offsetHeight,Y=J+W;if(T>=J&&T<=Y){d=O;const E=(T-J)/W;s=Math.max(0,Math.min(1,E)),o({text:n,pageNumber:O,rect:D,pageElement:q});const Q=ot.find(K=>K.type==="highlight"&&K.pageNumber===O&&Math.abs(K.x-Math.max(0,Math.min(1,(D.left-q.getBoundingClientRect().left)/q.offsetWidth)))<.01&&Math.abs(K.y-Math.max(0,Math.min(1,E)))<.01);y(Q?.id||null);break}}}}P(n,d,s)}else P("",void 0,void 0),o(null),y(null),i(!1)},[P,R,ot]),Qt=r.useCallback(e=>{const n=e.target;if(n.closest(".textbox-controls")!==null||n.closest(".textbox-font-size-input")!==null||n.closest(".textbox-color-button")!==null||n.closest(".textbox-color-picker")!==null||n.classList.contains("textbox-controls")||n.classList.contains("textbox-font-size-input")||n.classList.contains("textbox-color-button")||n.classList.contains("textbox-color-picker"))return;const d=n.closest(".annotation")!==null||n.closest(".annotation-layer")!==null||n.closest(".resize-handle")!==null||n.closest(".rotate-handle")!==null||n.closest(".delete-button")!==null||n.classList.contains("annotation")||n.classList.contains("annotation-layer")||n.classList.contains("resize-handle")||n.classList.contains("rotate-handle")||n.classList.contains("delete-button");setTimeout(()=>{const c=window.getSelection(),D=c&&c.toString().trim().length>0;if(D||P(""),!d&&!D&&dt(null),ft==="textbox"&&!d&&!D){const _=L.current;if(!_)return;let T=a,O=.5,q=.5;for(let W=1;W<=R;W++){const Y=S.current.get(W);if(Y){const E=Y.getBoundingClientRect();if(_.getBoundingClientRect()){const K=e.clientX-E.left,xt=e.clientY-E.top;if(K>=0&&K<=E.width&&xt>=0&&xt<=E.height){T=W;const pt=Z.current.get(W);if(pt){const vt=E.width/pt.width,le=E.height/pt.height;O=K/(pt.width*vt),q=xt/(pt.height*le)}break}}}}if(Z.current.get(T)){const W=Math.max(0,Math.min(.8,O-.1)),Y=Math.max(0,Math.min(1-.1,q-.05)),E={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:T,x:W,y:Y,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:_t[0]};et(Q=>[...Q,E]),dt(E.id),jt("select")}}},100)},[P,ft,a,R,v,dt,jt,et]),Ft=r.useCallback(e=>{et(d=>[...d,e]),dt(e.id);let n="text";e.type==="highlight"?n="highlight":e.type==="image"?n="image":e.type==="textbox"&&(n="text"),wt.trackAnnotationAdded(n);const s=wt.getCurrentDocumentId();s&&wt.updateDocument(s,{has_annotations:!0})},[]);r.useEffect(()=>(at&&(window.__addPDFAnnotation=e=>{et(n=>[...n,e]),dt(e.id),e.pageNumber&&A&&A(e.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[at,A]);const Tt=r.useCallback((e,n,s)=>{const d=e.width*n.width*s,c=document.createElement("div");c.style.position="absolute",c.style.visibility="hidden",c.style.width=`${d}px`,c.style.fontSize=`${e.fontSize*s}px`,c.style.fontFamily="inherit",c.style.whiteSpace="pre-wrap",c.style.wordWrap="break-word",c.style.overflowWrap="break-word",c.style.padding=`${4*s}px`,c.style.boxSizing="border-box",c.style.lineHeight="1.2",c.textContent=e.text||"Text",document.body.appendChild(c);const D=c.scrollHeight;document.body.removeChild(c);const _=D/(n.height*s);return Math.max(.01,Math.min(1,_))},[]),It=r.useCallback(e=>{et(n=>{const s=n.map(d=>d.id===e.id?e:d);if(e.type==="textbox"){const d=e,c=Z.current.get(d.pageNumber);if(c){const D=Tt(d,c,v);return s.map(_=>_.id===e.id?{...d,height:D}:_)}}return s})},[v,Tt]);r.useEffect(()=>{et(e=>e.map(n=>{if(n.type==="textbox"){const s=n,d=Z.current.get(s.pageNumber);if(d){const c=Tt(s,d,v);return{...s,height:c}}}return n}))},[v,Tt]);const te=r.useCallback(e=>{et(n=>n.filter(s=>s.id!==e)),kt===e&&dt(null)},[kt]),ee=r.useCallback(async e=>{if(!g||!Z.current.get(a))return;const s=new FileReader;s.onload=d=>{const c=d.target?.result,D=new Image;D.onload=()=>{const _=!c.startsWith("data:image/png")&&!c.startsWith("data:image/jpeg")&&!c.startsWith("data:image/jpg");let T=c;if(_){const Q=document.createElement("canvas");Q.width=D.width,Q.height=D.height;const K=Q.getContext("2d");K&&(K.drawImage(D,0,0),T=Q.toDataURL("image/png"))}const O=.2,q=D.width/D.height,J=O/q,E={id:`image-${Date.now()}`,type:"image",pageNumber:a,x:.4,y:.4,width:O,height:J,rotation:0,imageData:T,imageWidth:D.width,imageHeight:D.height};Ft(E),jt("select")},D.src=c},s.readAsDataURL(e)},[g,a,Ft,jt]),ne=r.useCallback(()=>{if(!B)return;const{pageNumber:e,rect:n,pageElement:s}=B;if(h)et(d=>d.filter(c=>c.id!==h)),y(null),i(!1);else{const d=s.offsetWidth,c=s.offsetHeight,D=s.getBoundingClientRect(),_=(n.left-D.left)/d,T=(n.top-D.top)/c,O=n.width/d,q=n.height/c,J={id:crypto.randomUUID(),type:"highlight",pageNumber:e,x:Math.max(0,Math.min(1,_)),y:Math.max(0,Math.min(1,T)),width:Math.max(.01,Math.min(1,O)),height:Math.max(.01,Math.min(1,q)),rotation:0,color:N,opacity:.4};et(W=>[...W,J]),y(J.id),i(!0)}},[B,h,N]),oe=r.useCallback(e=>{m(e),h&&et(n=>n.map(s=>s.id===h&&s.type==="highlight"?{...s,color:e}:s))},[h]),se=r.useCallback(async()=>{if(!g||ot.length===0){alert("No annotations to save");return}try{const e=await we(g,ot,Z.current),n=g.name.replace(".pdf","_annotated.pdf");ye(e,n);const s=ot.length>0;await wt.trackPDFExport(s);const d=wt.getCurrentDocumentId();d&&await wt.updateDocument(d,{has_export:!0})}catch(e){console.error("Error saving PDF:",e),alert("Failed to save annotated PDF. Please check the console for details.")}},[g,ot]),ie=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy",I(!0)},[]),re=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),L.current?.contains(e.relatedTarget)||I(!1)},[]),ae=r.useCallback(async e=>{e.preventDefault(),e.stopPropagation();const s=Array.from(e.dataTransfer.files).filter(T=>T.type.startsWith("image/"));if(s.length===0||!L.current?.getBoundingClientRect())return;let c=a,D=.5,_=.5;for(let T=1;T<=R;T++){const O=S.current.get(T);if(O){const q=O.getBoundingClientRect();if(L.current?.getBoundingClientRect()){const W=e.clientX-q.left,Y=e.clientY-q.top;if(W>=0&&W<=q.width&&Y>=0&&Y<=q.height){c=T;const E=Z.current.get(T);E&&(D=W/(E.width*v),_=Y/(E.height*v));break}}}}for(const T of s){const O=new FileReader;O.onload=q=>{const J=q.target?.result,W=new Image;W.onload=()=>{if(!Z.current.get(c))return;const E=.2,Q=W.width/W.height,K=E/Q,xt=Math.max(0,Math.min(1-E,D-E/2)),pt=Math.max(0,Math.min(1-K,_-K/2)),vt={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:c,x:xt,y:pt,width:E,height:K,rotation:0,imageData:J,imageWidth:W.width,imageHeight:W.height};Ft(vt)},W.src=J},O.readAsDataURL(T)}},[a,R,v,Ft]);if(!g&&!V)return t.jsx("div",{className:`pdf-viewer-empty ${w==="floating"?"float-layout":""}`,children:t.jsxs("div",{className:"upload-container",children:[t.jsx("label",{htmlFor:"pdf-upload",className:"upload-button",children:"Upload PDF"}),t.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Rt,style:{display:"none"}})]})});const Ht=ot.find(e=>e.id===kt)||null;return t.jsxs("div",{className:`pdf-viewer ${ht?"saving-session":""}`,ref:it,children:[V&&t.jsx("div",{className:"pdf-loading-overlay",children:t.jsxs("div",{className:"pdf-loading-spinner",children:[t.jsx("div",{className:"spinner"}),t.jsx("p",{children:"Loading PDF..."})]})}),ht&&t.jsx("div",{className:"pdf-saving-overlay",children:t.jsxs("div",{className:"pdf-saving-content",children:[t.jsx("div",{className:"saving-spinner"}),t.jsx("p",{children:"Saving PDF..."}),t.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})}),t.jsx(ge,{mode:ft,onModeChange:jt,highlightColor:N,onHighlightColorChange:oe,onHighlightClick:ne,hasTextSelection:!!B,isHighlightActive:!!h,showColorPicker:f,onImageUpload:ee,onDownload:se,onNewSession:tt,onClearAll:()=>{et([]),dt(null)}}),t.jsxs("div",{className:"pdf-controls-top",ref:bt,children:[Ht&&Ht.type==="textbox"&&t.jsx(ve,{selectedAnnotation:Ht,onUpdate:It}),t.jsxs("div",{className:"zoom-controls",children:[t.jsx("button",{onClick:Gt,className:"control-button fit-button",title:"Fit to width",children:"↔"}),t.jsx("button",{onClick:Jt,className:"control-button fit-button",title:"Fit to height",children:"↕"}),t.jsx("button",{onClick:Wt,className:"control-button",children:"−"}),ut?t.jsx("input",{ref:nt,type:"text",inputMode:"numeric",pattern:"[0-9]*",value:lt,onChange:Vt,onBlur:Zt,onKeyDown:qt,onPaste:Kt,className:"zoom-input"}):t.jsxs("span",{className:"zoom-level",onClick:At,title:"Click to edit zoom level",children:[Math.round(v*100),"%"]}),t.jsx("button",{onClick:Lt,className:"control-button",children:"+"}),p&&t.jsx("button",{onClick:p,className:"control-button knowledge-notes-toggle",title:u?"Hide knowledge notes":"Show knowledge notes",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),t.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),t.jsx("polyline",{points:"10 9 9 9 8 9"})]})})]})]}),t.jsx("div",{ref:L,className:`pdf-content ${M?"drag-over":""}`,onMouseUp:$t,onKeyUp:$t,onClick:Qt,onDragOver:ie,onDragLeave:re,onDrop:e=>{I(!1),ae(e)},children:g&&t.jsx(de,{file:ct||g,onLoadSuccess:Mt,onLoadError:Ct,loading:t.jsx("div",{className:"loading",children:"Loading PDF..."}),error:t.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",t.jsx("br",{}),t.jsxs("small",{children:["Worker: ",Et?.workerSrc||"Not set"]})]}),noData:t.jsx("div",{className:"loading",children:"No PDF file selected"}),options:Dt,children:Array.from(new Array(R),(e,n)=>{const s=n+1,d=Z.current.get(s);return t.jsxs("div",{ref:c=>{c?S.current.set(s,c):S.current.delete(s)},className:"pdf-page-wrapper",style:{position:"relative"},children:[t.jsx(he,{pageNumber:s,scale:v,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:c=>zt({pageNumber:s,page:c})},`page_${s}`),d&&t.jsxs(t.Fragment,{children:[t.jsx(ue,{pageNumber:s,pageWidth:d.width,pageHeight:d.height,scale:v,annotations:ot,selectedAnnotationId:kt,onAnnotationUpdate:It,onAnnotationDelete:te,onAnnotationSelect:dt,mode:ft}),u&&t.jsx(fe,{pageNumber:s,pageWidth:d.width,pageHeight:d.height,scale:v,knowledgeNotes:H,showKnowledgeNotes:u,layout:w,onNoteClick:k})]})]},`page-wrapper-${s}`)})})}),t.jsxs("div",{className:"pdf-controls-bottom",ref:yt,children:[t.jsx("button",{onClick:Yt,disabled:a<=1,className:"nav-button",children:"Previous"}),t.jsxs("span",{className:"page-info",children:["Page ",a," of ",R]}),t.jsx("button",{onClick:Pt,disabled:a>=R,className:"nav-button",children:"Next"})]})]})}export{Ne as default};
