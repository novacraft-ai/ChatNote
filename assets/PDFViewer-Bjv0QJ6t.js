const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r,j as t,a as le,D as ce,P as de}from"./vendor-react-BWK-dEaB.js";import{_ as Ot,C as Ut}from"./index-nSc6AkPl.js";import{G as Tt}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-CLrFw-IM.js";const he=({pageNumber:u,pageWidth:j,pageHeight:P,scale:w,annotations:D,selectedAnnotationId:l,onAnnotationUpdate:h,onAnnotationDelete:p,onAnnotationSelect:H,mode:A})=>{const k=r.useRef(null),[at,X]=r.useState(!1),[b,V]=r.useState(!1),[x,ht]=r.useState(!1),[tt,R]=r.useState({x:0,y:0}),[F,a]=r.useState(null),[C,v]=r.useState(null),[ot,ut]=r.useState({x:0,y:0,angle:0}),[$,lt]=r.useState(null),U=D.filter(n=>n.pageNumber===u),nt=n=>n*j*w,S=n=>n*P*w,L=n=>n*j*w,st=n=>n*P*w,wt=n=>n/(j*w),bt=n=>n/(P*w),mt=r.useCallback((n,d,y,f)=>{const s=1-y,N=1-f;return{x:Math.max(0,Math.min(s,n)),y:Math.max(0,Math.min(N,d)),width:Math.max(.01,Math.min(1,y)),height:Math.max(.01,Math.min(1,f))}},[]),Z=r.useCallback((n,d,y,f)=>{const s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${y}px`,s.style.fontSize=`${d*f}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*f}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=n||"Text",document.body.appendChild(s);const N=s.scrollHeight;return document.body.removeChild(s),N},[]),it=r.useCallback((n,d)=>{n.stopPropagation();const y=n.target;if(y.classList.contains("resize-handle")){n.preventDefault(),V(!0),a(y.dataset.handle||null);const s=k.current?.getBoundingClientRect();s&&(R({x:n.clientX-s.left,y:n.clientY-s.top}),v({x:n.clientX-s.left,y:n.clientY-s.top,width:d.width,height:d.height,annotationX:d.x,annotationY:d.y}));return}if(y.classList.contains("rotate-handle")){n.preventDefault(),ht(!0);const s=k.current?.getBoundingClientRect();if(s){const N=nt(d.x+d.width/2),m=S(d.y+d.height/2),z=n.clientX-s.left,I=n.clientY-s.top,G=Math.atan2(I-m,z-N)*(180/Math.PI);ut({x:z,y:I,angle:d.rotation-G})}return}if(y.classList.contains("delete-button")){n.preventDefault(),p(d.id);return}n.preventDefault(),H(d.id),X(!0);const f=k.current?.getBoundingClientRect();f&&R({x:n.clientX-f.left-nt(d.x),y:n.clientY-f.top-S(d.y)})},[A,nt,S,H,p]);r.useEffect(()=>{if(!at&&!b&&!x)return;const n=y=>{const f=k.current?.getBoundingClientRect();if(!f)return;const s=U.find(N=>N.id===l);if(s){if(x){const N=nt(s.x+s.width/2),m=S(s.y+s.height/2),z=y.clientX-f.left,I=y.clientY-f.top,G=Math.atan2(I-m,z-N)*(180/Math.PI),rt=(ot.angle+G)%360;h({...s,rotation:rt})}else if(b&&F&&C){const N=y.clientX-f.left,m=y.clientY-f.top,z=N-C.x,I=m-C.y,G=.5,rt=z/(j*w)*G,ct=I/(P*w)*G;let gt=C.annotationX,Nt=C.annotationY,Mt=C.width,zt=C.height;F.includes("n")&&(Nt=Math.max(0,C.annotationY+ct),zt=Math.max(.01,C.height-ct)),F.includes("s")&&(zt=Math.max(.01,C.height+ct)),F.includes("w")&&(gt=Math.max(0,C.annotationX+rt),Mt=Math.max(.01,C.width-rt)),F.includes("e")&&(Mt=Math.max(.01,C.width+rt));const jt=mt(gt,Nt,Mt,zt);if(s.type==="textbox"){const Dt=s,St=L(jt.width),Rt=Z(Dt.text,Dt.fontSize,St,w)/(P*w);if(Math.abs(Rt-jt.height)>.001){const Et=Math.max(.01,Math.min(1,Rt)),Lt=mt(gt,Nt,jt.width,Et);h({...s,...Lt})}else h({...s,...jt})}else h({...s,...jt})}else if(at){const N=wt(y.clientX-f.left-tt.x),m=bt(y.clientY-f.top-tt.y),z=mt(N,m,s.width,s.height);h({...s,...z})}}},d=()=>{if(b&&l){const y=U.find(f=>f.id===l);if(y&&y.type==="textbox"){const f=y,s=L(f.width),m=Z(f.text,f.fontSize,s,w)/(P*w),z=mt(f.x,f.y,f.width,m);Math.abs(z.height-f.height)>.001&&h({...f,...z})}}X(!1),V(!1),ht(!1),a(null),v(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",d),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",d)}},[at,b,x,F,C,tt,ot,l,U,nt,S,L,st,wt,bt,mt,Z,h,j,P,w]),r.useEffect(()=>{const n=d=>{(d.key==="Delete"||d.key==="Backspace")&&l&&d.target.tagName!=="INPUT"&&d.target.tagName!=="TEXTAREA"&&(d.preventDefault(),p(l))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[l,p]);const et=n=>{const d=n.id===l,y=nt(n.x),f=S(n.y),s=L(n.width),N=st(n.height);return t.jsxs("div",{className:`annotation textbox-annotation ${d?"selected":""}`,style:{left:`${y}px`,top:`${f}px`,width:`${s}px`,height:`${N}px`,padding:`${4*w}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:m=>it(m,n),children:[d&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:m=>{m.stopPropagation(),p(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),$===n.id?t.jsx("textarea",{className:"textbox-input",value:n.text,onChange:m=>{h({...n,text:m.target.value})},onBlur:m=>{const z=m.relatedTarget;z&&(z.closest(".textbox-controls")!==null||z.closest(".textbox-font-size-input")!==null||z.classList.contains("textbox-font-size-input"))||(lt(null),H(null))},onKeyDown:m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),lt(null),H(null)),m.key==="Escape"&&(lt(null),H(null))},style:{fontSize:`${n.fontSize*w}px`,color:n.color,width:`${s}px`,maxWidth:`${s}px`,height:`${N}px`,maxHeight:`${N}px`},autoFocus:!0}):t.jsx("div",{className:"textbox-content",onClick:m=>{m.stopPropagation();const z=m.target;z.closest(".textbox-controls")!==null||z.closest(".textbox-font-size-input")!==null||z.closest(".textbox-color-button")!==null||z.closest(".textbox-color-picker")!==null||lt(n.id)},style:{fontSize:`${n.fontSize*w}px`,color:n.color},children:n.text||"Text"})]},n.id)},vt=n=>{const d=n.id===l,y=nt(n.x),f=S(n.y),s=L(n.width),N=st(n.height),m=n.width*j,z=n.height*P,I=n.imageWidth/n.imageHeight,G=m/z;let rt,ct;return I>G?(rt=s,ct=s/I):(ct=N,rt=N*I),t.jsxs("div",{className:`annotation image-annotation ${d?"selected":""}`,style:{left:`${y}px`,top:`${f}px`,width:`${rt}px`,height:`${ct}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:gt=>it(gt,n),children:[d&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:gt=>{gt.stopPropagation(),p(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),t.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},dt=n=>{const d=n.id===l,y=nt(n.x),f=S(n.y),s=L(n.width),N=st(n.height);return t.jsx("div",{className:`annotation highlight-annotation ${d?"selected":""}`,style:{left:`${y}px`,top:`${f}px`,width:`${s}px`,height:`${N}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:m=>it(m,n),children:d&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:m=>{m.stopPropagation(),p(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]})},n.id)},ft=j*w,kt=P*w,B={width:`${ft}px`,height:`${kt}px`,pointerEvents:"none"};return t.jsx("div",{ref:k,className:"annotation-layer",style:B,children:U.map(n=>n.type==="textbox"?et(n):n.type==="image"?vt(n):n.type==="highlight"?dt(n):null)})},ue=({mode:u,onModeChange:j,highlightColor:P="#ffeb3b",onHighlightColorChange:w,onHighlightClick:D,hasTextSelection:l=!1,isHighlightActive:h=!1,showColorPicker:p=!1,onImageUpload:H,onDownload:A,onNewSession:k,onClearAll:at})=>{const X=r.useRef(null),[b,V]=r.useState(!1),x=r.useRef(null),ht=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];le.useEffect(()=>{const F=a=>{b&&(a.target.closest(".clear-button")||(V(!1),x.current&&(clearTimeout(x.current),x.current=null)))};if(b)return document.addEventListener("click",F),()=>{document.removeEventListener("click",F)}},[b]);const tt=F=>{const a=F.target.files?.[0];a&&a.type.startsWith("image/")&&H(a),j(null),X.current&&(X.current.value="")},R=F=>{F.stopPropagation(),b?(at&&at(),V(!1),x.current&&(clearTimeout(x.current),x.current=null)):(V(!0),x.current=setTimeout(()=>{V(!1),x.current=null},3e3))};return t.jsxs("div",{className:"annotation-toolbar",children:[t.jsxs("div",{className:"toolbar-section",children:[t.jsx("button",{className:`toolbar-button ${h?"active":""}`,onClick:D,disabled:!l,title:l?h?"Remove highlight":"Highlight text":"Select text to highlight",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),t.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),t.jsxs("button",{className:`toolbar-button ${u==="textbox"?"active":""}`,onClick:()=>j("textbox"),title:"Add text box (click on PDF to add)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M4 20h16"}),t.jsx("path",{d:"M6 4v16"}),t.jsx("path",{d:"M18 4v16"}),t.jsx("path",{d:"M4 7h16"}),t.jsx("path",{d:"M4 10h16"}),t.jsx("path",{d:"M4 13h16"}),t.jsx("path",{d:"M4 16h16"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Text"})]}),t.jsxs("button",{className:`toolbar-button ${u==="image"?"active":""}`,onClick:()=>{j("image"),X.current?.click()},title:"Add image (click to upload)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),t.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t.jsx("polyline",{points:"21 15 16 10 5 21"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Image"})]}),at&&t.jsxs("button",{className:`toolbar-button clear-button ${b?"confirming":""}`,onClick:R,title:b?"Click again to clear all annotations":"Clear all annotations",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"3 6 5 6 21 6"}),t.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Clear All"})]}),t.jsx("input",{ref:X,type:"file",accept:"image/*",onChange:tt,style:{display:"none"}})]}),p&&w&&t.jsx("div",{className:"toolbar-section color-picker",children:ht.map(F=>t.jsx("button",{className:`color-button ${P===F?"active":""}`,style:{backgroundColor:F},onClick:()=>w(F),title:"Select highlight color"},F))}),t.jsxs("div",{className:"toolbar-section toolbar-actions",children:[k&&t.jsxs("button",{className:"toolbar-button new-session-button",onClick:k,title:"Start new session (save current and upload new PDF)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),t.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),t.jsx("span",{className:"toolbar-button-text",children:"New Session"})]}),t.jsxs("button",{className:"toolbar-button download-button",onClick:A,title:"Download annotated PDF",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),t.jsx("polyline",{points:"7 10 12 15 17 10"}),t.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Download"})]})]})]})},ge=({pageNumber:u,pageWidth:j,pageHeight:P,scale:w,knowledgeNotes:D,showKnowledgeNotes:l,onNoteClick:h})=>{const p=D.filter(k=>k.pageNumber===u);if(!l||p.length===0)return null;const H=j*w,A=P*w;return t.jsx("div",{className:"knowledge-note-connections",style:{width:`${H}px`,height:`${A}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:t.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:p.map((k,at)=>{const X=H-25,b=25+at*35;return t.jsxs("g",{children:[t.jsx("circle",{cx:X,cy:b,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:V=>{V.stopPropagation(),h?.(k)},style:{cursor:"pointer",pointerEvents:"all"}}),t.jsx("text",{x:X,y:b,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:at+1}),t.jsx("line",{x1:X,y1:b+12,x2:X,y2:b+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},k.id)})})})};let Ht,Ct=null,It=!1;async function fe(){if(!Ht)try{Ht=await Ot(()=>import("./vendor-CLrFw-IM.js").then(u=>u.o),__vite__mapDeps([0,1]))}catch(u){throw console.error("Failed to load pdf-lib:",u),new Error("PDF library not available. Please install pdf-lib.")}return Ht}async function pe(){if(!It){It=!0;try{const u=await Ot(()=>import("./vendor-CLrFw-IM.js").then(j=>j.p),__vite__mapDeps([0,1]));return u.default?Ct=u.default:Ct=u,Ct&&typeof Ct.create=="function"?Ct:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(u){return console.warn("Failed to load fontkit, falling back to standard fonts:",u),null}}return Ct}async function me(){try{const u=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],j="/ChatNote/",w=`${j.endsWith("/")?j:`${j}/`}NotoSans-Regular.ttf`;try{const D=await fetch(w);if(D.ok){const l=await D.arrayBuffer();if(l.byteLength>1e3){const h=new Uint8Array(l);if(h.length>=4&&h[0]===0&&h[1]===1&&h[2]===0&&h[3]===0)return l}}}catch{}for(const D of u)if(!D.includes("fonts.googleapis.com/css"))try{const l=await fetch(D,{mode:"cors",cache:"default"});if(l.ok){const h=await l.arrayBuffer();if(h.byteLength>1e3){const p=new Uint8Array(h),H=p.length>=4&&p[0]===0&&p[1]===1&&p[2]===0&&p[3]===0,A=p.length>=4&&p[0]===119&&p[1]===79&&p[2]===70&&p[3]===70,k=p.length>=4&&p[0]===119&&p[1]===79&&p[2]===70&&p[3]===50;if(H||A||k)return h;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(u){return console.warn("Failed to load Unicode font:",u),null}}async function xe(u,j,P){try{const w=await fe(),{PDFDocument:D,rgb:l,degrees:h,StandardFonts:p}=w;if(!p)throw new Error("StandardFonts not available from pdf-lib");const H=await u.arrayBuffer(),A=await D.load(H);let k=null;try{const b=await pe();if(b){try{A.registerFontkit(b)}catch(x){(!x.message||!x.message.includes("already registered"))&&console.warn("Failed to register fontkit:",x)}const V=await me();if(V){const x=new Uint8Array(V),ht=x.length>=4&&x[0]===0&&x[1]===1&&x[2]===0&&x[3]===0,tt=x.length>=4&&x[0]===79&&x[1]===84&&x[2]===84&&x[3]===79,R=x.length>=4&&x[0]===116&&x[1]===116&&x[2]===99&&x[3]===102,F=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===70,a=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===50;F||a?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):ht||tt||R?k=await A.embedFont(V):console.warn(`Invalid font format. File size: ${x.length} bytes`)}}}catch(b){console.warn("Failed to embed Unicode font, falling back to standard font:",b)}if(!k){const b=p.Helvetica||p.TimesRoman;if(!b)throw new Error("No standard font available");k=await A.embedFont(b),console.log("Using standard font (limited Unicode support)")}if(!k)throw new Error("Failed to embed font");const at=A.getPages();for(const b of j){const V=at[b.pageNumber-1];if(!V)continue;const x=P.get(b.pageNumber);if(!x)continue;const{width:ht,height:tt}=x;let R=b.width*ht,F=b.height*tt;if(b.type==="textbox"){const a=b,C=we(a.color)||{r:0,g:0,b:0},v=b.x*ht,ot=b.y*tt;let ut=(b.y+b.height)*tt;const $=4,lt=R-$*2,U=(a.text||"").trimEnd();let S=U.split(/\r\n|\r|\n/).filter(B=>B!=null);for(;S.length>0&&S[S.length-1].length===0;)S.pop();if(S.length===0&&(S=[""]),S.length===1&&k&&typeof k.widthOfTextAtSize=="function"){const B=S[0],n=lt;let d;try{d=k.widthOfTextAtSize(B,a.fontSize)}catch{d=B.length*a.fontSize*.5}if(d>n){const y=[],f=B.split(/(\s+)/);let s="";for(let N=0;N<f.length;N++){const m=f[N],z=s+m;let I;try{I=k.widthOfTextAtSize(z,a.fontSize)}catch{I=z.length*a.fontSize*.5}I<=n||s===""?s=z:(s.trim()&&y.push(s.trim()),s=m)}s.trim()&&y.push(s.trim()),y.length>1&&(S=y)}}const L=a.fontSize*1.2;F=S.length>0?(S.length-1)*L+a.fontSize+$*2:a.fontSize+$*2,ut=ot+F;const bt=tt-ut,Z=tt-ot-bt,et=bt+Z/2,vt=a.fontSize*.2,dt=tt-a.fontSize*.2,ft=Math.max(vt,Math.min(dt,et));if((S.length>1||U.includes(`
`)||U.includes("\r"))&&S.length>0)try{const B=(S.length-1)*L,n=ft+B/2;S.forEach((d,y)=>{const f=n-y*L;let s;try{k&&typeof k.widthOfTextAtSize=="function"?s=k.widthOfTextAtSize(d,a.fontSize):s=d.length*a.fontSize*.5}catch{s=d.length*a.fontSize*.5}let m=v+$+lt/2-s/2;const z=v+$,I=v+R-s-$;m=Math.max(z,Math.min(I,m));const G=d.length>0?d:" ";V.drawText(G,{x:m,y:f,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:h(a.rotation),font:k})})}catch(B){if(B.message&&B.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",B.message);const n=S.map(f=>f.split("").map(s=>s.charCodeAt(0)>255?"?":s).join("")),d=(n.length-1)*L,y=ft+d/2;try{n.forEach((f,s)=>{const N=y-s*L;let m;try{k&&typeof k.widthOfTextAtSize=="function"?m=k.widthOfTextAtSize(f,a.fontSize):m=f.length*a.fontSize*.5}catch{m=f.length*a.fontSize*.5}let I=v+$+lt/2-m/2;const G=v+$,rt=v+R-m-$;I=Math.max(G,Math.min(rt,I)),V.drawText(f,{x:I,y:N,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:h(a.rotation),font:k})}),console.log("Drew text with Unicode characters replaced")}catch(f){console.error("Failed to draw text even after replacing Unicode characters:",f);continue}}else throw B}else{let B;try{k&&typeof k.widthOfTextAtSize=="function"?B=k.widthOfTextAtSize(a.text,a.fontSize):B=a.text.length*a.fontSize*.5}catch{B=a.text.length*a.fontSize*.5}let d=v+$+lt/2-B/2;const y=v+$,f=v+R-B-$;d=Math.max(y,Math.min(f,d));try{V.drawText(a.text,{x:d,y:ft,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:h(a.rotation),font:k})}catch(s){if(s.message&&s.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",s.message);const N=a.text.split("").map(m=>m.charCodeAt(0)>255?"?":m).join("");try{V.drawText(N,{x:d,y:ft,size:a.fontSize,color:l(C.r/255,C.g/255,C.b/255),rotate:h(a.rotation),font:k}),console.log("Drew text with Unicode characters replaced")}catch(m){console.error("Failed to draw text even after replacing Unicode characters:",m);continue}}else throw s}}}else if(b.type==="image"){const a=b,C=await fetch(a.imageData).then(wt=>wt.arrayBuffer());let v;if(a.imageData.startsWith("data:image/png"))v=await A.embedPng(C);else if(a.imageData.startsWith("data:image/jpeg")||a.imageData.startsWith("data:image/jpg"))v=await A.embedJpg(C);else throw console.error("Unsupported image format for PDF embedding:",a.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const ot=a.imageWidth/a.imageHeight;let ut=R,$=F;R/F>ot?ut=F*ot:$=R/ot;const U=b.x*ht,nt=(b.y+b.height)*tt,st=tt-nt+(F-$)/2;V.drawImage(v,{x:U,y:st,width:ut,height:$,rotate:h(a.rotation)})}}const X=await A.save();return new Blob([X],{type:"application/pdf"})}catch(w){throw console.error("Error saving annotated PDF:",w),new Error("Failed to save annotated PDF")}}function we(u){const j=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(u);return j?{r:parseInt(j[1],16),g:parseInt(j[2],16),b:parseInt(j[3],16)}:null}function be(u,j="annotated.pdf"){const P=URL.createObjectURL(u),w=document.createElement("a");w.href=P,w.download=j,document.body.appendChild(w),w.click(),document.body.removeChild(w),URL.revokeObjectURL(P)}const ye=({selectedAnnotation:u,onUpdate:j})=>{const[P,w]=r.useState(u.fontSize.toString()),D=r.useRef(u.fontSize);return r.useEffect(()=>{D.current=u.fontSize,w(u.fontSize.toString())},[u.id,u.fontSize]),t.jsxs("div",{className:"textbox-controls",onClick:l=>{l.target.closest('input[type="number"]')||l.stopPropagation()},onMouseDown:l=>{l.target.closest('input[type="number"]')||l.stopPropagation()},children:[t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Font Size:"}),t.jsxs("div",{className:"font-size-input-wrapper",children:[t.jsx("button",{type:"button",className:"font-size-arrow-button font-size-arrow-left",onClick:l=>{l.stopPropagation(),l.preventDefault();const h=parseInt(P,10)||D.current,p=Math.max(1,h-1);w(p.toString());const H={...u,fontSize:p};j(H),D.current=p},onMouseDown:l=>{l.stopPropagation(),l.preventDefault()},title:"Decrease font size",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"15 18 9 12 15 6"})})}),t.jsx("input",{type:"number",min:"1",max:"200",value:P,onChange:l=>{const h=l.target.value;if(w(h),h===""||h==="-")return;const p=parseInt(h,10);if(!isNaN(p)&&p>0){const H=Math.max(1,Math.min(200,p)),A={...u,fontSize:H};j(A),D.current=H}},onBlur:l=>{const h=l.target.value.trim();if(h===""||h==="-"||isNaN(parseInt(h,10))||parseInt(h,10)<=0)w(D.current.toString());else{const p=parseInt(h,10),H=Math.max(1,Math.min(200,p));H!==p&&w(H.toString()),D.current=H}},onMouseDown:l=>{l.stopPropagation()},onClick:l=>{l.stopPropagation()},onFocus:l=>{l.stopPropagation()},onWheel:l=>{l.stopPropagation()},className:"textbox-font-size-input"}),t.jsx("button",{type:"button",className:"font-size-arrow-button font-size-arrow-right",onClick:l=>{l.stopPropagation(),l.preventDefault();const h=parseInt(P,10)||D.current,p=Math.min(200,h+1);w(p.toString());const H={...u,fontSize:p};j(H),D.current=p},onMouseDown:l=>{l.stopPropagation(),l.preventDefault()},title:"Increase font size",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"9 18 15 12 9 6"})})})]})]}),t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Color:"}),t.jsx("div",{className:"textbox-color-picker",children:Ut.map(l=>t.jsx("button",{className:`textbox-color-button ${u.color===l?"active":""}`,style:{backgroundColor:l},onClick:h=>{h.stopPropagation(),h.preventDefault(),j({...u,color:l})},onMouseDown:h=>{h.stopPropagation(),h.preventDefault()},onFocus:h=>{h.stopPropagation()},title:l},l))})]})]})};function Se({file:u,onFileUpload:j,onTextSelection:P,layout:w="floating",onPageChange:D,onTotalPagesChange:l,showKnowledgeNotes:h=!0,onToggleKnowledgeNotes:p,knowledgeNotes:H=[],onScrollToPage:A,onNoteClick:k,onAddAnnotation:at,initialAnnotations:X=[],onAnnotationsChange:b,isLoadingPdf:V=!1,onLoadingComplete:x,isSavingSession:ht=!1,onNewSession:tt}){const[R,F]=r.useState(0),[a,C]=r.useState(1),[v,ot]=r.useState(1),[ut,$]=r.useState(!1),[lt,U]=r.useState("100"),nt=r.useRef(null),S=r.useRef(new Map),L=r.useRef(null),st=r.useRef(null),wt=r.useRef(null),bt=r.useRef(null),mt=r.useRef(!1),Z=r.useRef(new Map),[it,et]=r.useState(X),[vt,dt]=r.useState(null),[ft,kt]=r.useState(null),[B,n]=r.useState(null),[d,y]=r.useState(null),[f,s]=r.useState(!1),[N,m]=r.useState("#ffeb3b"),[z,I]=r.useState(!1),G=r.useRef(X),rt=r.useRef(b);r.useEffect(()=>{rt.current=b},[b]),r.useEffect(()=>{const e=G.current,o=X.length!==e.length||X.some((i,g)=>i.id!==e[g]?.id);X&&X.length>0&&o?(et(X),G.current=X):u&&X.length===0&&e.length>0?(et([]),G.current=[],dt(null)):!u&&e.length>0&&(et([]),G.current=[],dt(null))},[X,u]),r.useEffect(()=>{JSON.stringify(G.current)!==JSON.stringify(it)&&rt.current&&(G.current=it,rt.current(it))},[it]),r.useEffect(()=>{const e=console.warn,o=console.error;return console.warn=(...i)=>{const g=i.join(" ");g.includes("TextLayer task cancelled")||g.includes("AbortException")||i.some(c=>typeof c=="string"&&(c.includes("TextLayer task cancelled")||c.includes("AbortException")))||e.apply(console,i)},console.error=(...i)=>{const g=i.join(" ");g.includes("TextLayer task cancelled")||g.includes("AbortException")&&g.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=e,console.error=o}},[]);const ct=r.useMemo(()=>u?URL.createObjectURL(u):null,[u]),gt=r.useRef(null);r.useEffect(()=>(gt.current&&gt.current!==ct&&URL.revokeObjectURL(gt.current),gt.current=ct,()=>{ct&&URL.revokeObjectURL(ct)}),[ct]);const Nt=r.useMemo(()=>{let e;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";e=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Tt&&(Tt.workerSrc=e,Tt.standardFontDataUrl=o),{workerSrc:e,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),Mt=({numPages:e})=>{F(e),l?.(e);const o=1;C(o),setTimeout(()=>{D?.(o)},0),S.current.clear(),Z.current.clear(),x&&setTimeout(()=>{x()},300)},zt=e=>{if(!Z.current.has(e.pageNumber))try{const o=e.page;let i,g;o.viewport?(i=o.viewport.width,g=o.viewport.height):(i=o.width/v,g=o.height/v),Z.current.set(e.pageNumber,{width:i,height:g})}catch(o){console.warn("Error getting page dimensions:",o);const i=e.page,g=i.width/v,c=i.height/v;Z.current.set(e.pageNumber,{width:g,height:c})}};r.useEffect(()=>{if(!L.current||R===0)return;let e=null,o=!1;const i=()=>{if(mt.current||o||e)return;o=!0,e=setTimeout(()=>{e=null,o=!1},100);const c=L.current;if(!c){o=!1;return}const M=c.getBoundingClientRect(),_=M.top,T=M.height,O=_+T/2;if(c.scrollTop<100){C(Y=>Y!==1?(setTimeout(()=>{D?.(1)},0),1):Y);return}let J=1,W=0;for(let Y=1;Y<=R;Y++){const E=S.current.get(Y);if(E){const Q=E.getBoundingClientRect(),K=c.getBoundingClientRect(),xt=Math.max(K.top,Q.top),pt=Math.min(K.bottom,Q.bottom),yt=Math.max(0,pt-xt);yt>W&&(W=yt,J=Y)}}if(W<T*.1){let Y=1,E=1/0;for(let Q=1;Q<=R;Q++){const K=S.current.get(Q);if(K){const xt=K.getBoundingClientRect(),pt=xt.top+xt.height/2,yt=Math.abs(pt-O);yt<E&&(E=yt,Y=Q)}}J=Y}C(Y=>J!==Y?(setTimeout(()=>{D?.(J)},0),J):Y)},g=L.current;return g?.addEventListener("scroll",i,{passive:!0}),()=>{e&&clearTimeout(e),g?.removeEventListener("scroll",i)}},[R,D]);const jt=e=>{console.error("PDF load error:",e)},Dt=e=>{const o=e.target.files?.[0];o&&o.type==="application/pdf"&&j(o)},St=r.useCallback(e=>{const o=S.current.get(e);o&&L.current&&(mt.current=!0,C(e),D?.(e),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{mt.current=!1},1500))},[D]);r.useEffect(()=>(A&&(window.__pdfScrollToPage=St),L.current&&(window.__pdfContentRef=L.current),st.current&&(window.__pdfViewerHeight=st.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[St,A,R,v]);const Bt=()=>{const e=Math.max(1,a-1);St(e)},Rt=()=>{const e=Math.min(R,a+1);St(e)},Et=()=>{const e=Math.min(v+.2,5);ot(e),U(Math.round(e*100).toString())},Lt=()=>{const e=Math.max(v-.2,.25);ot(e),U(Math.round(e*100).toString())};r.useEffect(()=>{ut||U(Math.round(v*100).toString())},[v,ut]);const _t=()=>{$(!0),U(Math.round(v*100).toString())},At=e=>{let o=e.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),U(o)},Vt=()=>{Yt()},Zt=e=>{if(e.key==="Enter")e.preventDefault(),Yt();else if(e.key==="Escape")$(!1),U(Math.round(v*100).toString()),nt.current?.blur();else{if(e.key==="Backspace"||e.key==="Delete"||e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Tab")return;(e.key==="-"||e.key==="+"||e.key==="."||e.key===","||e.key==="e"||e.key==="E"||!/[0-9]/.test(e.key)&&!e.ctrlKey&&!e.metaKey)&&e.preventDefault()}},qt=e=>{e.preventDefault();const i=e.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const c=(i.replace(/^0+/,"")||"0").slice(0,3);if(U(c),c&&c!=="0"){const M=parseInt(c,10);if(!isNaN(M)&&M>0){const _=Math.max(25,Math.min(500,M)),T=_/100;ot(T),U(_.toString()),$(!1)}}}},Yt=()=>{if(lt.trim()===""||lt==="0"){U(Math.round(v*100).toString()),$(!1);return}const e=parseInt(lt,10);if(isNaN(e)||e<=0){U(Math.round(v*100).toString()),$(!1);return}const o=Math.max(25,Math.min(500,e)),i=o/100;ot(i),U(o.toString()),$(!1)};r.useEffect(()=>{ut&&nt.current&&(nt.current.focus(),nt.current.select())},[ut]);const Kt=()=>{if(!st.current||Z.current.size===0)return;const e=st.current.getBoundingClientRect();let o;o=e.width-40;const i=Z.current.get(1);if(!i)return;const g=o/i.width,c=Math.max(.1,Math.min(g,5));ot(c),U(Math.round(c*100).toString())},Gt=()=>{if(!st.current||Z.current.size===0)return;const e=st.current.getBoundingClientRect();let o=0,i=0;wt.current&&(o=wt.current.getBoundingClientRect().height),bt.current&&(i=bt.current.getBoundingClientRect().height);let g=0;const c=st.current.querySelector(".annotation-toolbar");c&&(g=c.getBoundingClientRect().height);const M=e.height-o-i-g,_=Z.current.get(a);if(!_)return;const T=M/_.height,O=Math.max(.1,Math.min(T,5));ot(O),U(Math.round(O*100).toString())},Xt=r.useCallback(()=>{const e=window.getSelection();if(e&&e.toString().trim()){const o=e.toString().trim();let i,g;if(e.rangeCount>0&&L.current){const M=e.getRangeAt(0).getBoundingClientRect(),_=L.current.getBoundingClientRect(),T=M.top-_.top+L.current.scrollTop;for(let O=1;O<=R;O++){const q=S.current.get(O);if(q){const J=q.offsetTop,W=q.offsetHeight,Y=J+W;if(T>=J&&T<=Y){g=O;const E=(T-J)/W;i=Math.max(0,Math.min(1,E)),n({text:o,pageNumber:O,rect:M,pageElement:q});const Q=it.find(K=>K.type==="highlight"&&K.pageNumber===O&&Math.abs(K.x-Math.max(0,Math.min(1,(M.left-q.getBoundingClientRect().left)/q.offsetWidth)))<.01&&Math.abs(K.y-Math.max(0,Math.min(1,E)))<.01);y(Q?.id||null);break}}}}P(o,g,i)}else P("",void 0,void 0),n(null),y(null),s(!1)},[P,R,it]),Jt=r.useCallback(e=>{const o=e.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker"))return;const g=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const c=window.getSelection(),M=c&&c.toString().trim().length>0;if(M||P(""),!g&&!M&&dt(null),ft==="textbox"&&!g&&!M){const _=L.current;if(!_)return;let T=a,O=.5,q=.5;for(let W=1;W<=R;W++){const Y=S.current.get(W);if(Y){const E=Y.getBoundingClientRect();if(_.getBoundingClientRect()){const K=e.clientX-E.left,xt=e.clientY-E.top;if(K>=0&&K<=E.width&&xt>=0&&xt<=E.height){T=W;const pt=Z.current.get(W);if(pt){const yt=E.width/pt.width,ae=E.height/pt.height;O=K/(pt.width*yt),q=xt/(pt.height*ae)}break}}}}if(Z.current.get(T)){const W=Math.max(0,Math.min(.8,O-.1)),Y=Math.max(0,Math.min(1-.1,q-.05)),E={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:T,x:W,y:Y,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:Ut[0]};et(Q=>[...Q,E]),dt(E.id),kt("select")}}},100)},[P,ft,a,R,v,dt,kt,et]),Pt=r.useCallback(e=>{et(o=>[...o,e]),dt(e.id)},[]);r.useEffect(()=>(at&&(window.__addPDFAnnotation=e=>{et(o=>[...o,e]),dt(e.id),e.pageNumber&&A&&A(e.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[at,A]);const Ft=r.useCallback((e,o,i)=>{const g=e.width*o.width*i,c=document.createElement("div");c.style.position="absolute",c.style.visibility="hidden",c.style.width=`${g}px`,c.style.fontSize=`${e.fontSize*i}px`,c.style.fontFamily="inherit",c.style.whiteSpace="pre-wrap",c.style.wordWrap="break-word",c.style.overflowWrap="break-word",c.style.padding=`${4*i}px`,c.style.boxSizing="border-box",c.style.lineHeight="1.2",c.textContent=e.text||"Text",document.body.appendChild(c);const M=c.scrollHeight;document.body.removeChild(c);const _=M/(o.height*i);return Math.max(.01,Math.min(1,_))},[]),$t=r.useCallback(e=>{et(o=>{const i=o.map(g=>g.id===e.id?e:g);if(e.type==="textbox"){const g=e,c=Z.current.get(g.pageNumber);if(c){const M=Ft(g,c,v);return i.map(_=>_.id===e.id?{...g,height:M}:_)}}return i})},[v,Ft]);r.useEffect(()=>{et(e=>e.map(o=>{if(o.type==="textbox"){const i=o,g=Z.current.get(i.pageNumber);if(g){const c=Ft(i,g,v);return{...i,height:c}}}return o}))},[v,Ft]);const Qt=r.useCallback(e=>{et(o=>o.filter(i=>i.id!==e)),vt===e&&dt(null)},[vt]),te=r.useCallback(async e=>{if(!u||!Z.current.get(a))return;const i=new FileReader;i.onload=g=>{const c=g.target?.result,M=new Image;M.onload=()=>{const _=!c.startsWith("data:image/png")&&!c.startsWith("data:image/jpeg")&&!c.startsWith("data:image/jpg");let T=c;if(_){const Q=document.createElement("canvas");Q.width=M.width,Q.height=M.height;const K=Q.getContext("2d");K&&(K.drawImage(M,0,0),T=Q.toDataURL("image/png"))}const O=.2,q=M.width/M.height,J=O/q,E={id:`image-${Date.now()}`,type:"image",pageNumber:a,x:.4,y:.4,width:O,height:J,rotation:0,imageData:T,imageWidth:M.width,imageHeight:M.height};Pt(E),kt("select")},M.src=c},i.readAsDataURL(e)},[u,a,Pt,kt]),ee=r.useCallback(()=>{if(!B)return;const{pageNumber:e,rect:o,pageElement:i}=B;if(d)et(g=>g.filter(c=>c.id!==d)),y(null),s(!1);else{const g=i.offsetWidth,c=i.offsetHeight,M=i.getBoundingClientRect(),_=(o.left-M.left)/g,T=(o.top-M.top)/c,O=o.width/g,q=o.height/c,J={id:crypto.randomUUID(),type:"highlight",pageNumber:e,x:Math.max(0,Math.min(1,_)),y:Math.max(0,Math.min(1,T)),width:Math.max(.01,Math.min(1,O)),height:Math.max(.01,Math.min(1,q)),rotation:0,color:N,opacity:.4};et(W=>[...W,J]),y(J.id),s(!0)}},[B,d,N]),ne=r.useCallback(e=>{m(e),d&&et(o=>o.map(i=>i.id===d&&i.type==="highlight"?{...i,color:e}:i))},[d]),oe=r.useCallback(async()=>{if(!u||it.length===0){alert("No annotations to save");return}try{const e=await xe(u,it,Z.current),o=u.name.replace(".pdf","_annotated.pdf");be(e,o)}catch(e){console.error("Error saving PDF:",e),alert("Failed to save annotated PDF. Please check the console for details.")}},[u,it]),se=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy",I(!0)},[]),ie=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),L.current?.contains(e.relatedTarget)||I(!1)},[]),re=r.useCallback(async e=>{e.preventDefault(),e.stopPropagation();const i=Array.from(e.dataTransfer.files).filter(T=>T.type.startsWith("image/"));if(i.length===0||!L.current?.getBoundingClientRect())return;let c=a,M=.5,_=.5;for(let T=1;T<=R;T++){const O=S.current.get(T);if(O){const q=O.getBoundingClientRect();if(L.current?.getBoundingClientRect()){const W=e.clientX-q.left,Y=e.clientY-q.top;if(W>=0&&W<=q.width&&Y>=0&&Y<=q.height){c=T;const E=Z.current.get(T);E&&(M=W/(E.width*v),_=Y/(E.height*v));break}}}}for(const T of i){const O=new FileReader;O.onload=q=>{const J=q.target?.result,W=new Image;W.onload=()=>{if(!Z.current.get(c))return;const E=.2,Q=W.width/W.height,K=E/Q,xt=Math.max(0,Math.min(1-E,M-E/2)),pt=Math.max(0,Math.min(1-K,_-K/2)),yt={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:c,x:xt,y:pt,width:E,height:K,rotation:0,imageData:J,imageWidth:W.width,imageHeight:W.height};Pt(yt)},W.src=J},O.readAsDataURL(T)}},[a,R,v,Pt]);if(!u&&!V)return t.jsx("div",{className:`pdf-viewer-empty ${w==="floating"?"float-layout":""}`,children:t.jsxs("div",{className:"upload-container",children:[t.jsx("label",{htmlFor:"pdf-upload",className:"upload-button",children:"Upload PDF"}),t.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Dt,style:{display:"none"}})]})});const Wt=it.find(e=>e.id===vt)||null;return t.jsxs("div",{className:`pdf-viewer ${ht?"saving-session":""}`,ref:st,children:[V&&t.jsx("div",{className:"pdf-loading-overlay",children:t.jsxs("div",{className:"pdf-loading-spinner",children:[t.jsx("div",{className:"spinner"}),t.jsx("p",{children:"Loading PDF..."})]})}),ht&&t.jsx("div",{className:"pdf-saving-overlay",children:t.jsxs("div",{className:"pdf-saving-content",children:[t.jsx("div",{className:"saving-spinner"}),t.jsx("p",{children:"Saving PDF..."}),t.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})}),t.jsx(ue,{mode:ft,onModeChange:kt,highlightColor:N,onHighlightColorChange:ne,onHighlightClick:ee,hasTextSelection:!!B,isHighlightActive:!!d,showColorPicker:f,onImageUpload:te,onDownload:oe,onNewSession:tt,onClearAll:()=>{et([]),dt(null)}}),t.jsxs("div",{className:"pdf-controls-top",ref:wt,children:[Wt&&Wt.type==="textbox"&&t.jsx(ye,{selectedAnnotation:Wt,onUpdate:$t}),t.jsxs("div",{className:"zoom-controls",children:[t.jsx("button",{onClick:Kt,className:"control-button fit-button",title:"Fit to width",children:"↔"}),t.jsx("button",{onClick:Gt,className:"control-button fit-button",title:"Fit to height",children:"↕"}),t.jsx("button",{onClick:Lt,className:"control-button",children:"−"}),ut?t.jsx("input",{ref:nt,type:"text",inputMode:"numeric",pattern:"[0-9]*",value:lt,onChange:At,onBlur:Vt,onKeyDown:Zt,onPaste:qt,className:"zoom-input"}):t.jsxs("span",{className:"zoom-level",onClick:_t,title:"Click to edit zoom level",children:[Math.round(v*100),"%"]}),t.jsx("button",{onClick:Et,className:"control-button",children:"+"}),p&&t.jsx("button",{onClick:p,className:"control-button knowledge-notes-toggle",title:h?"Hide knowledge notes":"Show knowledge notes",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),t.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),t.jsx("polyline",{points:"10 9 9 9 8 9"})]})})]})]}),t.jsx("div",{ref:L,className:`pdf-content ${z?"drag-over":""}`,onMouseUp:Xt,onKeyUp:Xt,onClick:Jt,onDragOver:se,onDragLeave:ie,onDrop:e=>{I(!1),re(e)},children:u&&t.jsx(ce,{file:ct||u,onLoadSuccess:Mt,onLoadError:jt,loading:t.jsx("div",{className:"loading",children:"Loading PDF..."}),error:t.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",t.jsx("br",{}),t.jsxs("small",{children:["Worker: ",Tt?.workerSrc||"Not set"]})]}),noData:t.jsx("div",{className:"loading",children:"No PDF file selected"}),options:Nt,children:Array.from(new Array(R),(e,o)=>{const i=o+1,g=Z.current.get(i);return t.jsxs("div",{ref:c=>{c?S.current.set(i,c):S.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[t.jsx(de,{pageNumber:i,scale:v,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:c=>zt({pageNumber:i,page:c})},`page_${i}`),g&&t.jsxs(t.Fragment,{children:[t.jsx(he,{pageNumber:i,pageWidth:g.width,pageHeight:g.height,scale:v,annotations:it,selectedAnnotationId:vt,onAnnotationUpdate:$t,onAnnotationDelete:Qt,onAnnotationSelect:dt,mode:ft}),h&&t.jsx(ge,{pageNumber:i,pageWidth:g.width,pageHeight:g.height,scale:v,knowledgeNotes:H,showKnowledgeNotes:h,layout:w,onNoteClick:k})]})]},`page-wrapper-${i}`)})})}),t.jsxs("div",{className:"pdf-controls-bottom",ref:bt,children:[t.jsx("button",{onClick:Bt,disabled:a<=1,className:"nav-button",children:"Previous"}),t.jsxs("span",{className:"page-info",children:["Page ",a," of ",R]}),t.jsx("button",{onClick:Rt,disabled:a>=R,className:"nav-button",children:"Next"})]})]})}export{Se as default};
