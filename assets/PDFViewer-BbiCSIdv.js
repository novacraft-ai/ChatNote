const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-D8Lt8S1G.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r as o,j as t,D as Te,P as Ye}from"./vendor-react-QLvrzKBK.js";import{_ as Xe}from"./index-CHwDSoyl.js";import{G as Me}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-D8Lt8S1G.js";const Ie=({pageNumber:g,pageWidth:y,pageHeight:N,scale:u,annotations:B,selectedAnnotationId:E,onAnnotationUpdate:H,onAnnotationDelete:M,onAnnotationSelect:te,mode:le})=>{const i=o.useRef(null),[V,w]=o.useState(!1),[T,l]=o.useState(!1),[A,J]=o.useState(!1),[X,Z]=o.useState({x:0,y:0}),[d,I]=o.useState(null),[f,R]=o.useState(null),[W,oe]=o.useState({x:0,y:0,angle:0}),[ce,ne]=o.useState(null),D=B.filter(s=>s.pageNumber===g),$=s=>s*y*u,Y=s=>s*N*u,ae=s=>s*y*u,Q=s=>s*N*u,ie=s=>s/(y*u),re=s=>s/(N*u),xe=o.useCallback((s,r,C,S)=>{const h=1-C,F=1-S;return{x:Math.max(0,Math.min(h,s)),y:Math.max(0,Math.min(F,r)),width:Math.max(.01,Math.min(1,C)),height:Math.max(.01,Math.min(1,S))}},[]),ue=o.useCallback((s,r)=>{s.stopPropagation();const C=s.target;if(C.classList.contains("resize-handle")){s.preventDefault(),l(!0),I(C.dataset.handle||null);const h=i.current?.getBoundingClientRect();h&&(Z({x:s.clientX-h.left,y:s.clientY-h.top}),R({x:s.clientX-h.left,y:s.clientY-h.top,width:r.width,height:r.height,annotationX:r.x,annotationY:r.y}));return}if(C.classList.contains("rotate-handle")){s.preventDefault(),J(!0);const h=i.current?.getBoundingClientRect();if(h){const F=$(r.x+r.width/2),x=Y(r.y+r.height/2),K=s.clientX-h.left,G=s.clientY-h.top,q=Math.atan2(G-x,K-F)*(180/Math.PI);oe({x:K,y:G,angle:r.rotation-q})}return}if(C.classList.contains("delete-button")){s.preventDefault(),M(r.id);return}s.preventDefault(),te(r.id),w(!0);const S=i.current?.getBoundingClientRect();S&&Z({x:s.clientX-S.left-$(r.x),y:s.clientY-S.top-Y(r.y)})},[le,$,Y,te,M]);o.useEffect(()=>{if(!V&&!T&&!A)return;const s=C=>{const S=i.current?.getBoundingClientRect();if(!S)return;const h=D.find(F=>F.id===E);if(h){if(A){const F=$(h.x+h.width/2),x=Y(h.y+h.height/2),K=C.clientX-S.left,G=C.clientY-S.top,q=Math.atan2(G-x,K-F)*(180/Math.PI),ee=(W.angle+q)%360;H({...h,rotation:ee})}else if(T&&d&&f){const F=C.clientX-S.left,x=C.clientY-S.top,K=F-f.x,G=x-f.y,q=.5,ee=K/(y*u)*q,ge=G/(N*u)*q;let ve=f.annotationX,ye=f.annotationY,fe=f.width,we=f.height;d.includes("n")&&(ye=Math.max(0,f.annotationY+ge),we=Math.max(.01,f.height-ge)),d.includes("s")&&(we=Math.max(.01,f.height+ge)),d.includes("w")&&(ve=Math.max(0,f.annotationX+ee),fe=Math.max(.01,f.width-ee)),d.includes("e")&&(fe=Math.max(.01,f.width+ee));const pe=xe(ve,ye,fe,we);H({...h,...pe})}else if(V){const F=ie(C.clientX-S.left-X.x),x=re(C.clientY-S.top-X.y),K=xe(F,x,h.width,h.height);H({...h,...K})}}},r=()=>{w(!1),l(!1),J(!1),I(null),R(null)};return window.addEventListener("mousemove",s),window.addEventListener("mouseup",r),()=>{window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",r)}},[V,T,A,d,f,X,W,E,D,$,Y,ae,Q,ie,re,xe,H,y,N,u]),o.useEffect(()=>{const s=r=>{(r.key==="Delete"||r.key==="Backspace")&&E&&r.target.tagName!=="INPUT"&&r.target.tagName!=="TEXTAREA"&&(r.preventDefault(),M(E))};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[E,M]);const he=s=>{const r=s.id===E,C=$(s.x),S=Y(s.y),h=ae(s.width),F=Q(s.height);return t.jsxs("div",{className:`annotation textbox-annotation ${r?"selected":""}`,style:{left:`${C}px`,top:`${S}px`,maxWidth:`${h}px`,maxHeight:`${F}px`,transform:`rotate(${s.rotation}deg)`,transformOrigin:"center center"},onMouseDown:x=>ue(x,s),children:[r&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:x=>{x.stopPropagation(),M(s.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),ce===s.id?t.jsx("textarea",{className:"textbox-input",value:s.text,onChange:x=>{H({...s,text:x.target.value})},onBlur:()=>ne(null),onKeyDown:x=>{x.key==="Enter"&&!x.shiftKey&&(x.preventDefault(),ne(null)),x.key==="Escape"&&ne(null)},style:{fontSize:`${s.fontSize}px`,color:s.color},autoFocus:!0}):t.jsx("div",{className:"textbox-content",onClick:x=>{x.stopPropagation(),ne(s.id)},style:{fontSize:`${s.fontSize}px`,color:s.color},children:s.text||"Text"})]},s.id)},je=s=>{const r=s.id===E,C=$(s.x),S=Y(s.y),h=ae(s.width),F=Q(s.height),x=s.imageWidth/s.imageHeight,K=h/F;let G,q;return x>K?(G=h,q=h/x):(q=F,G=F*x),t.jsxs("div",{className:`annotation image-annotation ${r?"selected":""}`,style:{left:`${C}px`,top:`${S}px`,width:`${G}px`,height:`${q}px`,transform:`rotate(${s.rotation}deg)`,transformOrigin:"center center"},onMouseDown:ee=>ue(ee,s),children:[r&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:ee=>{ee.stopPropagation(),M(s.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),t.jsx("img",{src:s.imageData,alt:"Annotation",draggable:!1})]},s.id)},ke=y*u,Ne=N*u,Re={width:`${ke}px`,height:`${Ne}px`,pointerEvents:"none"};return t.jsx("div",{ref:i,className:"annotation-layer",style:Re,children:D.map(s=>s.type==="textbox"?he(s):s.type==="image"?je(s):null)})},We=({mode:g,onModeChange:y,onImageUpload:N,onDownload:u})=>{const B=o.useRef(null),E=H=>{const M=H.target.files?.[0];M&&M.type.startsWith("image/")&&N(M),B.current&&(B.current.value="")};return t.jsxs("div",{className:"annotation-toolbar",children:[t.jsxs("div",{className:"toolbar-section",children:[t.jsxs("button",{className:`toolbar-button ${g==="select"?"active":""}`,onClick:()=>y("select"),title:"Select mode (click to select annotations)",children:[t.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("path",{d:"M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"})}),"Select"]}),t.jsxs("button",{className:`toolbar-button ${g==="textbox"?"active":""}`,onClick:()=>y("textbox"),title:"Add text box (click on PDF to add)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M4 20h16"}),t.jsx("path",{d:"M6 4v16"}),t.jsx("path",{d:"M18 4v16"}),t.jsx("path",{d:"M4 7h16"}),t.jsx("path",{d:"M4 10h16"}),t.jsx("path",{d:"M4 13h16"}),t.jsx("path",{d:"M4 16h16"})]}),"Text"]}),t.jsxs("button",{className:`toolbar-button ${g==="image"?"active":""}`,onClick:()=>{y("image"),B.current?.click()},title:"Add image (click to upload)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),t.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t.jsx("polyline",{points:"21 15 16 10 5 21"})]}),"Image"]}),t.jsx("input",{ref:B,type:"file",accept:"image/*",onChange:E,style:{display:"none"}})]}),t.jsx("div",{className:"toolbar-section toolbar-actions",children:t.jsxs("button",{className:"toolbar-button download-button",onClick:u,title:"Download annotated PDF",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),t.jsx("polyline",{points:"7 10 12 15 17 10"}),t.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),"Download"]})})]})},$e=({pageNumber:g,pageWidth:y,pageHeight:N,scale:u,knowledgeNotes:B,showKnowledgeNotes:E,onNoteClick:H})=>{const M=B.filter(i=>i.pageNumber===g);if(!E||M.length===0)return null;const te=y*u,le=N*u;return t.jsx("div",{className:"knowledge-note-connections",style:{width:`${te}px`,height:`${le}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:t.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:M.map((i,V)=>{const w=te-25,T=25+V*35;return t.jsxs("g",{children:[t.jsx("circle",{cx:w,cy:T,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:l=>{l.stopPropagation(),H?.(i)},style:{cursor:"pointer",pointerEvents:"all"}}),t.jsx("text",{x:w,y:T,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:V+1}),t.jsx("line",{x1:w,y1:T+12,x2:w,y2:T+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},i.id)})})})},Se=["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#FFC0CB"];let Ce;async function He(){if(!Ce)try{Ce=await Xe(()=>import("./vendor-D8Lt8S1G.js").then(g=>g.o),__vite__mapDeps([0,1]))}catch(g){throw console.error("Failed to load pdf-lib:",g),new Error("PDF library not available. Please install pdf-lib.")}return Ce}async function Ae(g,y,N){try{const{PDFDocument:u,rgb:B,degrees:E}=await He(),H=await g.arrayBuffer(),M=await u.load(H),te=M.getPages();for(const i of y){const V=te[i.pageNumber-1];if(!V)continue;const w=N.get(i.pageNumber);if(!w)continue;const{width:T,height:l}=w,A=i.x*T,J=l-(i.y+i.height)*l,X=i.width*T,Z=i.height*l;if(i.type==="textbox"){const d=i,I=_e(d.color)||{r:0,g:0,b:0};V.drawText(d.text,{x:A,y:J,size:d.fontSize,color:B(I.r/255,I.g/255,I.b/255),rotate:E(d.rotation)})}else if(i.type==="image"){const d=i,I=await fetch(d.imageData).then(Y=>Y.arrayBuffer());let f;d.imageData.startsWith("data:image/png")?f=await M.embedPng(I):f=await M.embedJpg(I);const R=d.imageWidth/d.imageHeight;let W=X,oe=Z;X/Z>R?W=Z*R:oe=X/R;const ce=A+X/2,ne=J+Z/2,D=ce-W/2,$=ne-oe/2;V.drawImage(f,{x:D,y:$,width:W,height:oe,rotate:E(d.rotation)})}}const le=await M.save();return new Blob([le],{type:"application/pdf"})}catch(u){throw console.error("Error saving annotated PDF:",u),new Error("Failed to save annotated PDF")}}function _e(g){const y=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(g);return y?{r:parseInt(y[1],16),g:parseInt(y[2],16),b:parseInt(y[3],16)}:null}function Oe(g,y="annotated.pdf"){const N=URL.createObjectURL(g),u=document.createElement("a");u.href=N,u.download=y,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(N)}function Ge({file:g,onFileUpload:y,onTextSelection:N,layout:u="floating",onPageChange:B,showKnowledgeNotes:E=!0,onToggleKnowledgeNotes:H,knowledgeNotes:M=[],onScrollToPage:te,onNoteClick:le}){const[i,V]=o.useState(0),[w,T]=o.useState(1),[l,A]=o.useState(1),[J,X]=o.useState(!1),[Z,d]=o.useState("100"),I=o.useRef(null),f=o.useRef(new Map),R=o.useRef(null),W=o.useRef(null),oe=o.useRef(null),ce=o.useRef(null),ne=o.useRef(!1),D=o.useRef(new Map),[$,Y]=o.useState([]),[ae,Q]=o.useState(null),[ie,re]=o.useState("select"),[xe,ue]=o.useState(!1),he=o.useMemo(()=>g?URL.createObjectURL(g):null,[g]);o.useEffect(()=>()=>{he&&URL.revokeObjectURL(he)},[he]);const je=o.useMemo(()=>{let e;{const n="/ChatNote/";e=`${n.endsWith("/")?n:`${n}/`}pdf.worker.min.js`}return Me&&(Me.workerSrc=e),{workerSrc:e,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:"https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/"}},[]),ke=({numPages:e})=>{V(e);const n=1;T(n),setTimeout(()=>{B?.(n)},0),f.current.clear(),D.current.clear(),Y([]),Q(null)},Ne=e=>{if(!D.current.has(e.pageNumber))try{const n=e.page;let a,m;n.viewport?(a=n.viewport.width,m=n.viewport.height):(a=n.width/l,m=n.height/l),D.current.set(e.pageNumber,{width:a,height:m})}catch(n){console.warn("Error getting page dimensions:",n);const a=e.page;D.current.set(e.pageNumber,{width:a.width/l,height:a.height/l})}};o.useEffect(()=>{if(!R.current||i===0)return;let e=null,n=!1;const a=()=>{if(ne.current||n||e)return;n=!0,e=setTimeout(()=>{e=null,n=!1},100);const c=R.current;if(!c){n=!1;return}const j=c.getBoundingClientRect(),L=j.top,b=j.height,P=L+b/2;if(c.scrollTop<100){T(p=>p!==1?(setTimeout(()=>{B?.(1)},0),1):p);return}let k=1,v=0;for(let p=1;p<=i;p++){const z=f.current.get(p);if(z){const O=z.getBoundingClientRect(),U=c.getBoundingClientRect(),se=Math.max(U.top,O.top),be=Math.min(U.bottom,O.bottom),de=Math.max(0,be-se);de>v&&(v=de,k=p)}}if(v<b*.1){let p=1,z=1/0;for(let O=1;O<=i;O++){const U=f.current.get(O);if(U){const se=U.getBoundingClientRect(),be=se.top+se.height/2,de=Math.abs(be-P);de<z&&(z=de,p=O)}}k=p}T(p=>k!==p?(setTimeout(()=>{B?.(k)},0),k):p)},m=R.current;return m?.addEventListener("scroll",a,{passive:!0}),()=>{e&&clearTimeout(e),m?.removeEventListener("scroll",a)}},[i,B]);const Re=e=>{console.error("PDF load error:",e)},s=e=>{const n=e.target.files?.[0];n&&n.type==="application/pdf"&&y(n)},r=o.useCallback(e=>{const n=f.current.get(e);n&&R.current&&(ne.current=!0,T(e),B?.(e),n.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{ne.current=!1},1500))},[B]);o.useEffect(()=>(te&&(window.__pdfScrollToPage=r),R.current&&(window.__pdfContentRef=R.current),W.current&&(window.__pdfViewerHeight=W.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[r,te,i,l]);const C=()=>{const e=Math.max(1,w-1);r(e)},S=()=>{const e=Math.min(i,w+1);r(e)},h=()=>{const e=Math.min(l+.2,5);A(e),d(Math.round(e*100).toString())},F=()=>{const e=Math.max(l-.2,.25);A(e),d(Math.round(e*100).toString())};o.useEffect(()=>{J||d(Math.round(l*100).toString())},[l,J]);const x=()=>{X(!0),d(Math.round(l*100).toString())},K=e=>{let n=e.target.value;n=n.replace(/[^0-9]/g,""),n.length>1&&n.startsWith("0")&&(n=n.replace(/^0+/,"")||"0"),n.length>3&&(n=n.slice(0,3)),d(n)},G=()=>{ge()},q=e=>{if(e.key==="Enter")e.preventDefault(),ge();else if(e.key==="Escape")X(!1),d(Math.round(l*100).toString()),I.current?.blur();else{if(e.key==="Backspace"||e.key==="Delete"||e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Tab")return;(e.key==="-"||e.key==="+"||e.key==="."||e.key===","||e.key==="e"||e.key==="E"||!/[0-9]/.test(e.key)&&!e.ctrlKey&&!e.metaKey)&&e.preventDefault()}},ee=e=>{e.preventDefault();const a=e.clipboardData.getData("text").replace(/[^0-9]/g,"");if(a){const c=(a.replace(/^0+/,"")||"0").slice(0,3);if(d(c),c&&c!=="0"){const j=parseInt(c,10);if(!isNaN(j)&&j>0){const L=Math.max(25,Math.min(500,j)),b=L/100;A(b),d(L.toString()),X(!1)}}}},ge=()=>{if(Z.trim()===""||Z==="0"){d(Math.round(l*100).toString()),X(!1);return}const e=parseInt(Z,10);if(isNaN(e)||e<=0){d(Math.round(l*100).toString()),X(!1);return}const n=Math.max(25,Math.min(500,e)),a=n/100;A(a),d(n.toString()),X(!1)};o.useEffect(()=>{J&&I.current&&(I.current.focus(),I.current.select())},[J]);const ve=()=>{if(!W.current||D.current.size===0)return;const e=W.current.getBoundingClientRect();let n;n=e.width-40;const a=D.current.get(1);if(!a)return;const m=n/a.width,c=Math.max(.1,Math.min(m,5));A(c),d(Math.round(c*100).toString())},ye=()=>{if(!W.current||D.current.size===0)return;const e=W.current.getBoundingClientRect();let n=0,a=0;oe.current&&(n=oe.current.getBoundingClientRect().height),ce.current&&(a=ce.current.getBoundingClientRect().height);let m=0;const c=W.current.querySelector(".annotation-toolbar");c&&(m=c.getBoundingClientRect().height);const j=e.height-n-a-m,L=D.current.get(w);if(!L)return;const b=j/L.height,P=Math.max(.1,Math.min(b,5));A(P),d(Math.round(P*100).toString())},fe=o.useCallback(()=>{const e=window.getSelection();if(e&&e.toString().trim()){const n=e.toString().trim();let a,m;if(e.rangeCount>0&&R.current){const j=e.getRangeAt(0).getBoundingClientRect(),L=R.current.getBoundingClientRect(),b=j.top-L.top+R.current.scrollTop;for(let P=1;P<=i;P++){const _=f.current.get(P);if(_){const k=_.offsetTop,v=_.offsetHeight,p=k+v;if(b>=k&&b<=p){m=P;const z=(b-k)/v;a=Math.max(0,Math.min(1,z));break}}}}N(n,m,a)}else N("",void 0,void 0)},[N,i]),we=o.useCallback(e=>{const n=e.target,a=n.closest(".annotation")!==null||n.closest(".annotation-layer")!==null||n.closest(".resize-handle")!==null||n.closest(".rotate-handle")!==null||n.closest(".delete-button")!==null||n.classList.contains("annotation")||n.classList.contains("annotation-layer")||n.classList.contains("resize-handle")||n.classList.contains("rotate-handle")||n.classList.contains("delete-button");setTimeout(()=>{const m=window.getSelection(),c=m&&m.toString().trim().length>0;if(c||N(""),ie==="select"&&!a&&!c&&Q(null),ie==="textbox"&&!a&&!c){const j=R.current;if(!j)return;let L=w,b=.5,P=.5;for(let k=1;k<=i;k++){const v=f.current.get(k);if(v){const p=v.getBoundingClientRect();if(j.getBoundingClientRect()){const O=e.clientX-p.left,U=e.clientY-p.top;if(O>=0&&O<=p.width&&U>=0&&U<=p.height){L=k;const se=D.current.get(k);se&&(b=O/(se.width*l),P=U/(se.height*l));break}}}}if(D.current.get(L)){const k=Math.max(0,Math.min(.8,b-.1)),v=Math.max(0,Math.min(1-.1,P-.05)),p={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:L,x:k,y:v,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:Se[0]};Y(z=>[...z,p]),Q(p.id),re("select")}}},100)},[N,ie,w,i,l,Q,re,Y]),pe=o.useCallback(e=>{Y(n=>[...n,e]),Q(e.id)},[]),De=o.useCallback(e=>{Y(n=>n.map(a=>a.id===e.id?e:a))},[]),Pe=o.useCallback(e=>{Y(n=>n.filter(a=>a.id!==e)),ae===e&&Q(null)},[ae]),Fe=o.useCallback(async e=>{if(!g||!D.current.get(w))return;const a=new FileReader;a.onload=m=>{const c=m.target?.result,j=new Image;j.onload=()=>{const P=.2/(j.width/j.height),v={id:`image-${Date.now()}`,type:"image",pageNumber:w,x:.4,y:.4,width:.2,height:P,rotation:0,imageData:c,imageWidth:j.width,imageHeight:j.height};pe(v),re("select")},j.src=c},a.readAsDataURL(e)},[g,w,pe,re]),ze=o.useCallback(async()=>{if(!g||$.length===0){alert("No annotations to save");return}try{const e=await Ae(g,$,D.current),n=g.name.replace(".pdf","_annotated.pdf");Oe(e,n)}catch(e){console.error("Error saving PDF:",e),alert("Failed to save annotated PDF. Please check the console for details.")}},[g,$]),Ee=o.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy",ue(!0)},[]),Be=o.useCallback(e=>{e.preventDefault(),e.stopPropagation(),R.current?.contains(e.relatedTarget)||ue(!1)},[]),Le=o.useCallback(async e=>{e.preventDefault(),e.stopPropagation();const a=Array.from(e.dataTransfer.files).filter(b=>b.type.startsWith("image/"));if(a.length===0||!R.current?.getBoundingClientRect())return;let c=w,j=.5,L=.5;for(let b=1;b<=i;b++){const P=f.current.get(b);if(P){const _=P.getBoundingClientRect();if(R.current?.getBoundingClientRect()){const v=e.clientX-_.left,p=e.clientY-_.top;if(v>=0&&v<=_.width&&p>=0&&p<=_.height){c=b;const z=D.current.get(b);z&&(j=v/(z.width*l),L=p/(z.height*l));break}}}}for(const b of a){const P=new FileReader;P.onload=_=>{const k=_.target?.result,v=new Image;v.onload=()=>{if(!D.current.get(c))return;const z=.2,O=v.width/v.height,U=z/O,se=Math.max(0,Math.min(1-z,j-z/2)),be=Math.max(0,Math.min(1-U,L-U/2)),de={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:c,x:se,y:be,width:z,height:U,rotation:0,imageData:k,imageWidth:v.width,imageHeight:v.height};pe(de)},v.src=k},P.readAsDataURL(b)}},[w,i,l,pe]);if(!g)return t.jsx("div",{className:`pdf-viewer-empty ${u==="floating"?"float-layout":""}`,children:t.jsxs("div",{className:"upload-container",children:[t.jsx("label",{htmlFor:"pdf-upload",className:"upload-button",children:"Upload PDF"}),t.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:s,style:{display:"none"}})]})});const me=$.find(e=>e.id===ae)||null;return t.jsxs("div",{className:"pdf-viewer",ref:W,children:[t.jsx(We,{mode:ie,onModeChange:re,onImageUpload:Fe,onDownload:ze}),t.jsxs("div",{className:"pdf-controls-top",ref:oe,children:[me&&me.type==="textbox"&&t.jsxs("div",{className:"textbox-controls",children:[t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Font Size:"}),t.jsx("input",{type:"number",min:"8",max:"72",value:me.fontSize,onChange:e=>{const n=parseInt(e.target.value,10);!isNaN(n)&&n>0&&De({...me,fontSize:Math.max(8,Math.min(72,n))})},className:"textbox-font-size-input"})]}),t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Color:"}),t.jsx("div",{className:"textbox-color-picker",children:Se.map(e=>t.jsx("button",{className:`textbox-color-button ${me.color===e?"active":""}`,style:{backgroundColor:e},onClick:()=>De({...me,color:e}),title:e},e))})]})]}),t.jsxs("div",{className:"zoom-controls",children:[t.jsx("button",{onClick:ve,className:"control-button fit-button",title:"Fit to width",children:"↔"}),t.jsx("button",{onClick:ye,className:"control-button fit-button",title:"Fit to height",children:"↕"}),t.jsx("button",{onClick:F,className:"control-button",children:"−"}),J?t.jsx("input",{ref:I,type:"text",inputMode:"numeric",pattern:"[0-9]*",value:Z,onChange:K,onBlur:G,onKeyDown:q,onPaste:ee,className:"zoom-input"}):t.jsxs("span",{className:"zoom-level",onClick:x,title:"Click to edit zoom level",children:[Math.round(l*100),"%"]}),t.jsx("button",{onClick:h,className:"control-button",children:"+"}),H&&t.jsx("button",{onClick:H,className:"control-button knowledge-notes-toggle",title:E?"Hide knowledge notes":"Show knowledge notes",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),t.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),t.jsx("polyline",{points:"10 9 9 9 8 9"})]})})]})]}),t.jsx("div",{ref:R,className:`pdf-content ${xe?"drag-over":""}`,onMouseUp:fe,onKeyUp:fe,onClick:we,onDragOver:Ee,onDragLeave:Be,onDrop:e=>{ue(!1),Le(e)},children:t.jsx(Te,{file:he||g,onLoadSuccess:ke,onLoadError:Re,loading:t.jsx("div",{className:"loading",children:"Loading PDF..."}),error:t.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",t.jsx("br",{}),t.jsxs("small",{children:["Worker: ",Me?.workerSrc||"Not set"]})]}),noData:t.jsx("div",{className:"loading",children:"No PDF file selected"}),options:je,children:Array.from(new Array(i),(e,n)=>{const a=n+1,m=D.current.get(a);return t.jsxs("div",{ref:c=>{c?f.current.set(a,c):f.current.delete(a)},className:"pdf-page-wrapper",style:{position:"relative"},children:[t.jsx(Ye,{pageNumber:a,scale:l,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:c=>Ne({pageNumber:a,page:c})},`page_${a}`),m&&t.jsxs(t.Fragment,{children:[t.jsx(Ie,{pageNumber:a,pageWidth:m.width,pageHeight:m.height,scale:l,annotations:$,selectedAnnotationId:ae,onAnnotationUpdate:De,onAnnotationDelete:Pe,onAnnotationSelect:Q,mode:ie}),E&&t.jsx($e,{pageNumber:a,pageWidth:m.width,pageHeight:m.height,scale:l,knowledgeNotes:M,showKnowledgeNotes:E,layout:u,onNoteClick:le})]})]},`page-wrapper-${a}`)})})}),t.jsxs("div",{className:"pdf-controls-bottom",ref:ce,children:[t.jsx("button",{onClick:C,disabled:w<=1,className:"nav-button",children:"Previous"}),t.jsxs("span",{className:"page-info",children:["Page ",w," of ",i]}),t.jsx("button",{onClick:S,disabled:w>=i,className:"nav-button",children:"Next"})]})]})}export{Ge as default};
