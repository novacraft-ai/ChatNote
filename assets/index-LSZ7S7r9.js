const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PDFViewer-DaIYnRm-.js","assets/vendor-react-BWK-dEaB.js","assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css","assets/vendor-pdf-DDxsMbbh.js","assets/vendor-react-CBXYWCWZ.css","assets/PDFViewer-CX8r4eE6.css"])))=>i.map(i=>d[i]);
import{r as u,j as e,M as _t,R as ln,a as cn}from"./vendor-react-BWK-dEaB.js";import{p as dn}from"./vendor-pdf-DDxsMbbh.js";import{k as Rt,l as Ot,n as Dt}from"./vendor-CLrFw-IM.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const k of l)if(k.type==="childList")for(const m of k.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function i(l){const k={};return l.integrity&&(k.integrity=l.integrity),l.referrerPolicy&&(k.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?k.credentials="include":l.crossOrigin==="anonymous"?k.credentials="omit":k.credentials="same-origin",k}function a(l){if(l.ep)return;l.ep=!0;const k=i(l);fetch(l.href,k)}})();if(typeof window<"u"){let n;{const a="/ChatNote/";n=`${a.endsWith("/")?a:`${a}/`}pdf.worker.min.js`}const t=a=>{try{if(a)if(!a.GlobalWorkerOptions)a.GlobalWorkerOptions={workerSrc:n};else try{a.GlobalWorkerOptions.workerSrc=n}catch{try{Object.defineProperty(a,"GlobalWorkerOptions",{value:{workerSrc:n},writable:!0,configurable:!0})}catch{}}}catch{}};window.pdfjsLib||(window.pdfjsLib={}),window.pdfjsLib.GlobalWorkerOptions?window.pdfjsLib.GlobalWorkerOptions.workerSrc=n:window.pdfjsLib.GlobalWorkerOptions={workerSrc:n},typeof window.pdfjs>"u"&&(window.pdfjs={}),window.pdfjs.GlobalWorkerOptions?window.pdfjs.GlobalWorkerOptions.workerSrc=n:window.pdfjs.GlobalWorkerOptions={workerSrc:n};const i=dn;if(t(i),i.default&&t(i.default),i.GlobalWorkerOptions)try{i.GlobalWorkerOptions.workerSrc=n}catch{}}const un="modulepreload",hn=function(n){return"/ChatNote/"+n},Ft={},st=function(t,i,a){let l=Promise.resolve();if(i&&i.length>0){let N=function(f){return Promise.all(f.map(g=>Promise.resolve(g).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const m=document.querySelector("meta[property=csp-nonce]"),C=m?.nonce||m?.getAttribute("nonce");l=N(i.map(f=>{if(f=hn(f),f in Ft)return;Ft[f]=!0;const g=f.endsWith(".css"),d=g?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${d}`))return;const x=document.createElement("link");if(x.rel=g?"stylesheet":un,g||(x.as="script"),x.crossOrigin="",x.href=f,C&&x.setAttribute("nonce",C),document.head.appendChild(x),g)return new Promise((h,b)=>{x.addEventListener("load",h),x.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${f}`)))})}))}function k(m){const C=new Event("vite:preloadError",{cancelable:!0});if(C.payload=m,window.dispatchEvent(C),!C.defaultPrevented)throw m}return l.then(m=>{for(const C of m||[])C.status==="rejected"&&k(C.reason);return t().catch(k)})},Vt=u.createContext(void 0);function gn({children:n}){const[t,i]=u.useState(()=>localStorage.getItem("theme")||"light");u.useEffect(()=>{document.documentElement.setAttribute("data-theme",t),localStorage.setItem("theme",t)},[t]);const a=()=>{i(l=>l==="light"?"dark":"light")};return e.jsx(Vt.Provider,{value:{theme:t,toggleTheme:a},children:n})}function mt(){const n=u.useContext(Vt);if(n===void 0)throw new Error("useTheme must be used within a ThemeProvider");return n}const Ye=["meta-llama/llama-4-scout-17b-16e-instruct","meta-llama/llama-4-maverick-17b-128e-instruct","llama-3.3-70b-versatile"],Je=["openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-32b"],fn=["openai/gpt-oss-120b","openai/gpt-oss-20b"],pn=["qwen/qwen3-32b"];function mn(n){return fn.includes(n)}function xn(n){return pn.includes(n)}const nt={primary:"groq/compound",fallback:"groq/compound-mini"},yn=["moonshotai/kimi-k2-instruct-0905","openai/gpt-oss-safeguard-20b"],qe="https://chatnote-backend-8pk3.onrender.com",Wt="105659660993-u7lnrcbis23u3mlaigteag67d6h6inar.apps.googleusercontent.com",Kt=u.createContext(void 0);function wn({children:n}){const[t,i]=u.useState(null),[a,l]=u.useState(!0);u.useEffect(()=>{const N=localStorage.getItem("auth_token");N?k(N):l(!1)},[]);const k=async(N,f=0)=>{let d=!1;try{const x=new AbortController,h=setTimeout(()=>x.abort(),1e4),b=await fetch(`${qe}/api/auth/me`,{headers:{Authorization:`Bearer ${N}`},signal:x.signal});if(clearTimeout(h),b.ok){const M=await b.json();i(M.user),d=!0}else if(b.status===401||b.status===403)console.warn("Token invalid, logging out"),localStorage.removeItem("auth_token"),i(null),d=!0;else{if(f<2)return console.warn(`Failed to fetch user (${b.status}), retrying... (${f+1}/2)`),await new Promise(M=>setTimeout(M,1e3*(f+1))),k(N,f+1);console.error("Failed to fetch user after retries, but keeping token:",b.status),d=!0}}catch(x){if(f<2){const h=x instanceof Error?x.name:"Unknown";return console.warn(`Network error (${h}), retrying... (${f+1}/2)`),await new Promise(b=>setTimeout(b,1e3*(f+1))),k(N,f+1)}else x instanceof Error&&x.name==="AbortError"?console.warn("Request timeout after retries, but keeping user logged in"):console.error("Network error fetching user after retries, but keeping token:",x),d=!0}finally{d&&l(!1)}},m=async N=>{try{const f=await fetch(`${qe}/api/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:N})});if(!f.ok){const d=await f.json();throw new Error(d.error||"Authentication failed")}const g=await f.json();localStorage.setItem("auth_token",g.token),i(g.user)}catch(f){throw console.error("Login error:",f),f}},C=()=>{localStorage.removeItem("auth_token"),i(null)};return e.jsx(Kt.Provider,{value:{user:t,loading:a,login:m,logout:C,isAuthenticated:!!t,isAdmin:t?.role==="admin"},children:n})}function xt(){const n=u.useContext(Kt);if(n===void 0)throw new Error("useAuth must be used within an AuthProvider");return n}const Zt=u.createContext(void 0);function kn({children:n}){const[t,i]=u.useState(()=>{const l=localStorage.getItem("chatVisible");return l!==null?l==="true":!0});u.useEffect(()=>{localStorage.setItem("chatVisible",String(t))},[t]);const a=()=>{i(l=>!l)};return e.jsx(Zt.Provider,{value:{isChatVisible:t,toggleChatVisibility:a},children:n})}function Xt(){const n=u.useContext(Zt);if(n===void 0)throw new Error("useChatVisibility must be used within a ChatVisibilityProvider");return n}function bn(){const{user:n,login:t,logout:i,loading:a}=xt(),[l,k]=u.useState(!1),[m,C]=u.useState(null);u.useEffect(()=>{const d=console.error,x=console.warn;console.error=(...b)=>{const M=b.join(" ");M.includes("Not signed in with the identity provider")||M.includes("AbortError")||M.includes("signal is aborted")||M.includes("FedCM get() rejects")||M.includes("GSI_LOGGER")||M.includes("Only one navigator.credentials.get request may be outstanding")||d.apply(console,b)},console.warn=(...b)=>{const M=b.join(" ");M.includes("GSI_LOGGER")||M.includes("Not signed in with the identity provider")||M.includes("Only one navigator.credentials.get request may be outstanding")||x.apply(console,b)};const h=window.onerror;return window.onerror=(b,M,I,z,F)=>typeof b=="string"&&(b.includes("Not signed in with the identity provider")||b.includes("Only one navigator.credentials.get request may be outstanding")||b.includes("AbortError")||M?.includes("accounts.google.com"))?!0:h?h(b,M,I,z,F):!1,()=>{console.error=d,console.warn=x,window.onerror=h}},[]);const N=u.useCallback(async d=>{try{await t(d.credential);const x=document.getElementById("google-signin-button");x&&x.remove()}catch(x){console.error("Login failed:",x),alert(x instanceof Error?x.message:"Login failed. Please try again.")}},[t]);u.useEffect(()=>{if(n)return;if(window.google){try{window.google.accounts.id.initialize({client_id:Wt,callback:N}),k(!0)}catch(h){console.error("Failed to initialize Google OAuth:",h),C("Failed to initialize Google OAuth")}return}const d=document.createElement("script");d.src="https://accounts.google.com/gsi/client",d.async=!0,d.defer=!0,d.onload=()=>{if(window.google)try{window.google.accounts.id.initialize({client_id:Wt,callback:N,use_fedcm_for_prompt:!0}),k(!0)}catch(h){console.error("Failed to initialize Google OAuth:",h),C("Failed to initialize Google OAuth")}else console.error("Google script loaded but window.google is not available"),C("Google script failed to load")},d.onerror=()=>{console.error("Failed to load Google Identity Services script"),C("Failed to load Google Sign-In script"),k(!1)};const x=setTimeout(()=>{window.google||(console.error("Google script loading timeout"),C("Google Sign-In is taking too long to load"),k(!1))},1e4);return document.head.appendChild(d),()=>{clearTimeout(x)}},[N,n]),u.useEffect(()=>{if(n){const d=document.getElementById("google-login-backdrop"),x=document.getElementById("google-signin-button");d&&d.remove(),x&&x.remove()}},[n]);const f=()=>{const d=document.getElementById("google-login-backdrop"),x=document.getElementById("google-signin-button");d&&d.remove(),x&&x.remove();const h=document.createElement("div");h.id="google-login-backdrop",h.style.position="fixed",h.style.top="0",h.style.left="0",h.style.width="100%",h.style.height="100%",h.style.backgroundColor="rgba(0, 0, 0, 0.5)",h.style.zIndex="9999",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center";const b=()=>{h.remove(),I.remove(),document.removeEventListener("keydown",M)};h.addEventListener("click",z=>{z.target===h&&b()});const M=z=>{z.key==="Escape"&&b()};document.addEventListener("keydown",M);const I=document.createElement("div");I.id="google-signin-button",I.style.position="relative",I.style.background="white",I.style.padding="20px",I.style.borderRadius="8px",I.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",I.style.zIndex="10000",I.addEventListener("click",z=>{z.stopPropagation()}),h.appendChild(I),document.body.appendChild(h);try{window.google.accounts.id.renderButton(I,{theme:"outline",size:"large",text:"signin_with",width:250})}catch(z){console.warn("Could not render Google button, showing manual login option:",z),I.innerHTML=`
                <p style="margin: 0 0 10px 0; text-align: center;">Sign in with Google</p>
                <button onclick="window.location.href='https://accounts.google.com/signin'" 
                        style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Continue with Google
                </button>
                <button onclick="document.getElementById('google-login-backdrop')?.remove(); document.getElementById('google-signin-button')?.remove();" 
                        style="margin-top: 10px; padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Cancel
                </button>
              `;const F=I.querySelector("button:last-child");F&&F.addEventListener("click",()=>{document.removeEventListener("keydown",M)})}},g=()=>{if(m){alert(`Google Sign-In error: ${m}. Please check the browser console.`);return}if(window.google&&l)try{window.google.accounts.id.prompt(d=>{const x=d.getNotDisplayedReason?.(),h=d.getSkippedReason?.(),b=d.getDismissedReason?.(),M=d.isNotDisplayed?.(),I=d.isSkippedMoment?.(),z=d.isDismissedMoment?.();(x||h||b||M||I||z)&&f()}),setTimeout(()=>{document.getElementById("google-login-backdrop")||f()},500)}catch(d){console.error("Error showing Google sign-in:",d),f()}else alert("Google Sign-In is still loading. Please wait a moment and try again.")};return a&&!n?e.jsx("div",{className:"login-button loading",children:e.jsx("span",{children:"Loading..."})}):n?e.jsxs("div",{className:"login-button user-info",children:[e.jsx("div",{className:"user-avatar",children:n.picture?e.jsx("img",{src:n.picture,alt:n.name||n.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:d=>{const x=d.target;x.style.display="none";const h=x.parentElement;if(h){const b=h.querySelector("span");b&&b.remove();const M=document.createElement("span");M.textContent=n.name?.[0]||n.email[0].toUpperCase(),h.appendChild(M)}}}):e.jsx("span",{children:n.name?.[0]||n.email[0].toUpperCase()})}),e.jsxs("div",{className:"user-details",children:[e.jsx("span",{className:"user-name",children:n.name||n.email}),n.role==="admin"&&e.jsx("span",{className:"user-role",children:"Admin"})]}),e.jsx("button",{onClick:()=>{window.confirm("Are you sure you want to log out?")&&i()},className:"logout-button",title:"Logout",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e.jsx("polyline",{points:"16 17 21 12 16 7"}),e.jsx("line",{x1:"21",y1:"12",x2:"9",y2:"12"})]})})]}):m&&!l?e.jsxs("button",{onClick:g,className:"login-button sign-in error",title:m,children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Sign in (Error)"]}):e.jsx("button",{onClick:g,className:"login-button sign-in",disabled:!l,title:l?"Sign in with Google":"Loading Google Sign-In...",children:l?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"}),e.jsx("path",{d:"M3 20a6 6 0 0 1 6-6h6a6 6 0 0 1 6 6v1H3v-1Z"})]}),"Sign in with Google"]}):e.jsx("span",{children:"Loading Google Sign-In..."})})}async function vn(n){const t=await fetch(`${qe}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${n}`}});if(!t.ok)throw new Error("Failed to check API key status");return t.json()}async function jn(n,t){const i=await fetch(`${qe}/api/user/api-key`,{method:"POST",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"},body:JSON.stringify({apiKey:t})});if(!i.ok){const a=await i.json();throw new Error(a.error||"Failed to save API key")}}function Cn(){const{user:n,isAdmin:t}=xt(),[i,a]=u.useState(""),[l,k]=u.useState(!1),[m,C]=u.useState(!1),[N,f]=u.useState(!1),[g,d]=u.useState(null);u.useEffect(()=>{n&&!t?x():t&&k(!0)},[n,t]);const x=async()=>{if(n){C(!0);try{const b=localStorage.getItem("auth_token");if(!b)return;const M=await vn(b);k(M.hasApiKey)}catch(b){console.error("Failed to load API key status:",b)}finally{C(!1)}}},h=async()=>{if(!(!n||!i.trim())){f(!0),d(null);try{const b=localStorage.getItem("auth_token");if(!b)throw new Error("Not authenticated");await jn(b,i.trim()),d({type:"success",text:"API key saved securely!"}),a(""),k(!0)}catch(b){d({type:"error",text:b instanceof Error?b.message:"Failed to save API key"})}finally{f(!1)}}};return n?t?e.jsx("div",{className:"api-key-settings",children:e.jsxs("div",{className:"api-key-info admin",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"api-key-title",children:"Admin Account"}),e.jsx("p",{className:"api-key-description",children:"You're using the admin API key. No configuration needed."})]})]})}):m?e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Loading..."})}):e.jsxs("div",{className:"api-key-settings",children:[e.jsxs("div",{className:"api-key-header",children:[e.jsx("h3",{children:"Groq API Key"}),l&&e.jsx("span",{className:"api-key-status-badge",children:"Configured"})]}),e.jsx("p",{className:"api-key-description",children:l?"Your API key is securely stored and encrypted. You can update it below.":"Enter your Groq API key to use the chat feature. Your key will be encrypted and stored securely."}),e.jsxs("div",{className:"api-key-input-group",children:[e.jsx("input",{type:"password",value:i,onChange:b=>a(b.target.value),placeholder:"gsk_...",className:"api-key-input",disabled:N}),e.jsx("button",{onClick:h,disabled:!i.trim()||N,className:"api-key-save-button",children:N?"Saving...":l?"Update":"Save"})]}),g&&e.jsx("div",{className:`api-key-message ${g.type}`,children:g.text}),e.jsxs("div",{className:"api-key-help",children:[e.jsx("p",{children:e.jsx("strong",{children:"Don't have an API key?"})}),e.jsxs("ol",{children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://console.groq.com/keys",target:"_blank",rel:"noopener noreferrer",children:"Groq Console"})]}),e.jsx("li",{children:"Sign up or log in"}),e.jsx("li",{children:"Create a new API key"}),e.jsx("li",{children:"Copy and paste it here"})]}),e.jsx("p",{className:"api-key-security-note",children:"ðŸ”’ Your API key is encrypted with AES-256 and stored securely. Only you can use it."})]})]}):e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Please sign in to configure your API key."})})}function Sn(){const{theme:n,toggleTheme:t}=mt(),{isChatVisible:i,toggleChatVisibility:a}=Xt(),[l,k]=u.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("nav",{className:"navbar",children:e.jsxs("div",{className:"navbar-content",children:[e.jsx("h1",{className:"navbar-title",children:"ChatNote"}),e.jsxs("div",{className:"navbar-actions",children:[e.jsx(bn,{}),e.jsx("button",{className:"settings-toggle",onClick:()=>k(!l),title:"Settings","aria-label":"Settings",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"})]})}),e.jsx("button",{className:"chat-toggle",onClick:a,title:i?"Hide chat":"Show chat","aria-label":i?"Hide chat":"Show chat",children:i?e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"})]}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18",strokeWidth:"2.5"})]})}),e.jsx("button",{className:"theme-toggle",onClick:t,title:`Switch to ${n==="light"?"dark":"light"} mode`,"aria-label":`Switch to ${n==="light"?"dark":"light"} mode`,children:n==="light"?e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"5"}),e.jsx("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),e.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),e.jsx("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),e.jsx("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),e.jsx("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),e.jsx("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),e.jsx("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),e.jsx("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]})})]})]})}),l&&e.jsx("div",{className:"settings-modal-overlay",onClick:()=>k(!1),children:e.jsxs("div",{className:"settings-modal",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"settings-modal-header",children:[e.jsx("h2",{children:"Settings"}),e.jsx("button",{className:"settings-modal-close",onClick:()=>k(!1),"aria-label":"Close settings",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("div",{className:"settings-modal-content",children:e.jsx(Cn,{})})]})})]})}function Qt(){return localStorage.getItem("auth_token")}function $n(n){if(Ye.includes(n)){const t=Ye.indexOf(n);return Ye.slice(t)}if(Je.includes(n)){const t=Je.indexOf(n);return Je.slice(t)}return n===nt.primary?[nt.primary,nt.fallback]:[n]}function Nn(n,t){if(t===429||t>=500&&t<600)return!0;const i=typeof n?.error=="string"?n.error:n?.error?.message||n?.message||"";return["rate limit","too many requests","service unavailable","internal server error","bad gateway","gateway timeout","timeout"].some(l=>i.toLowerCase().includes(l))}function Bt(n,t){if(t===429)return"Rate limit reached. Please wait a moment and try again.";if(t===401)return"Authentication failed. Please log in again.";if(t===400){const a=typeof n?.error=="string"?n.error:n?.error?.message||n?.message||"";return a.includes("API key not configured")?"API key not configured. Please add your API key in settings.":a.includes("model")||a.includes("invalid")?"Invalid request. Please try again or select a different model.":"Invalid request. Please check your input and try again."}if(t===403)return"Access denied. Please check your API key permissions.";if(t===404)return"Model not found. Please select a different model.";if(t>=500&&t<600)return"Service temporarily unavailable. Please try again in a moment.";const i=typeof n?.error=="string"?n.error:n?.error?.message||n?.message||"";return console.error("API error details (not shown to user):",{status:t,message:i,error:n}),"An error occurred while processing your request. Please try again."}async function zt(n,t,i,a,l,k){const m=Qt();if(!m)throw new Error("Authentication required. Please log in.");const C=a||Ye[0],N=$n(C),f=k||!1;let g=null;for(const d of N)try{const x={messages:n,context:t,model:d,temperature:.7,maxTokens:3e3,stream:!!i};f&&Je.includes(d)&&(mn(d)?x.include_reasoning=!0:xn(d)&&(x.reasoning_format="parsed"));let h;try{h=await fetch(`${qe}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${m}`},body:JSON.stringify(x),signal:l})}catch(D){throw D instanceof DOMException&&D.name==="AbortError"?new DOMException("Request aborted by user","AbortError"):D}if(!h.ok){let D;try{const W=await h.text();try{D=JSON.parse(W)}catch{D={error:{message:W||"Unknown error"}}}}catch{D={error:{message:"Unknown error"}}}if(h.status===401)throw localStorage.removeItem("auth_token"),new Error("Session expired. Please log in again.");if(h.status===400&&D.error?.message?.includes("API key not configured"))throw new Error("API key not configured. Please add your Groq API key in settings.");const V=Nn(D,h.status),Q=N.length>1&&d!==N[N.length-1];if(V&&Q){g=new Error(Bt(D,h.status));continue}const J=Bt(D,h.status);throw console.error("Backend error response (details logged, user sees sanitized message):",D),new Error(J)}if(i&&h.body){const D=h.body.getReader(),V=new TextDecoder;let Q="",J="",W="";for(;;){if(l?.aborted)throw D.cancel(),new DOMException("Request aborted by user","AbortError");let A,H;try{const r=await D.read();A=r.done,H=r.value}catch(r){throw r instanceof DOMException&&r.name==="AbortError"?(D.cancel(),new DOMException("Request aborted by user","AbortError")):r}if(A)break;W+=V.decode(H,{stream:!0});const ee=W.split(`
`);W=ee.pop()||"";for(const r of ee){const o=r.trim();if(o&&o.startsWith("data: ")){const p=o.slice(6);if(p==="[DONE]")continue;try{const c=JSON.parse(p).choices?.[0]?.delta;c?.content&&(Q+=c.content,i(c.content)),c?.reasoning&&(J+=c.reasoning)}catch(v){console.warn("Failed to parse streaming chunk:",v)}}}}if(W.trim()){const A=W.trim();if(A.startsWith("data: ")){const H=A.slice(6);if(H!=="[DONE]")try{const r=JSON.parse(H).choices?.[0]?.delta;r?.content&&(Q+=r.content,i(r.content)),r?.reasoning&&(J+=r.reasoning)}catch{}}}return J?`__REASONING_START__${J}__REASONING_END__${Q}`:Q}const M=(await h.json()).choices[0]?.message;let I=M?.content||"No response from API";const z=M?.reasoning,F=M?.executed_tools;let q="";if(F&&F.length>0){const D=F.find(V=>V.search_results);if(D?.search_results?.results&&D.search_results.results.length>0){const V=D.search_results.results;q=`

---

## Sources

`,V.forEach((Q,J)=>{q+=`${J+1}. [${Q.title}](${Q.url})
`})}}return q&&(I=I+q),z?`__REASONING_START__${z}__REASONING_END__${I}`:I}catch(x){if(d===N[N.length-1])throw x instanceof DOMException&&x.name==="AbortError"?x:g||(console.error("Chat service error:",x),x);g=x instanceof Error?x:new Error(String(x))}throw g||new Error("Unable to process your request. Please try again later.")}async function En(){const n=Qt();if(!n)return!1;try{const t=await fetch(`${qe}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${n}`}});if(t.ok){const i=await t.json();return i.hasApiKey||i.isAdmin}if(t.status===429)throw new Error("Rate limited");return!1}catch(t){if(t instanceof Error&&t.message==="Rate limited")throw t;return!1}}function Ht({mode:n,onModeChange:t,disabled:i=!1}){const[a,l]=u.useState(!1),[k,m]=u.useState(0),[C,N]=u.useState(!1),f=u.useRef(null),g=u.useRef(null),d=["auto","reasoning","advanced"],x={auto:"Auto",reasoning:"Reasoning",advanced:"Advanced"},h=u.useCallback(()=>{const q=d.indexOf(n),D=f.current?.offsetWidth||80,V=g.current?.offsetWidth||20,W=(D-4-V)/(d.length-1);return q*W},[n]),b=q=>{i||(l(!0),N(!1),m(q.clientX),q.preventDefault(),q.stopPropagation())},M=u.useCallback(q=>{if(!a||i)return;const D=q.clientX-k;Math.abs(D)>3&&N(!0);const V=f.current?.offsetWidth||80,Q=g.current?.offsetWidth||20,J=4,A=(V-J-Q)/(d.length-1),H=f.current?.getBoundingClientRect();if(!H)return;const ee=q.clientX-H.left-J/2-Q/2,r=Math.round(ee/A),o=Math.max(0,Math.min(d.length-1,r)),p=d[o];p!==n&&t(p)},[a,i,k,n,t]),I=u.useCallback(()=>{if(a&&(l(!1),!C)){const D=(d.indexOf(n)+1)%d.length;t(d[D])}},[a,C,n,t]);u.useEffect(()=>{if(a)return document.addEventListener("mousemove",M),document.addEventListener("mouseup",I),()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",I)}},[a,M,I]);const z=q=>{if(i||a)return;const D=f.current?.getBoundingClientRect();if(!D)return;const V=q.clientX-D.left,Q=D.width,J=g.current?.offsetWidth||20,W=4,H=(Q-W-J)/(d.length-1),ee=V-W/2-J/2,r=Math.round(ee/H),o=Math.max(0,Math.min(d.length-1,r)),p=d[o];p!==n&&t(p)},F=h();return e.jsxs("div",{className:"model-mode-toggle-wrapper",children:[e.jsx("div",{ref:f,className:`model-mode-toggle ${n} ${i?"disabled":""} ${a?"dragging":""}`,onMouseDown:b,onClick:z,children:e.jsx("div",{className:"model-mode-toggle-track",children:e.jsx("div",{ref:g,className:"model-mode-toggle-button",style:{transform:`translateX(${F}px)`,transition:a?"none":"transform 0.3s ease"}})})}),e.jsx("div",{className:"model-mode-toggle-label",children:x[n]})]})}function Mn(n){if(!n)return[];const t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","be","been","being","have","has","had","do","does","did","will","would","should","could","may","might","must","can","this","that","these","those","what","which","who","whom","whose","where","when","why","how","about","tell","me","please","help","does","mention","any","pdf"]),i=n.toLowerCase(),a=[],l=i.replace(/[^\w\s]/g," ").split(/\s+/).filter(m=>m.length>2&&!t.has(m));for(let m=0;m<l.length-1;m++){const C=`${l[m]} ${l[m+1]}`;l[m].length>3&&l[m+1].length>3&&a.push(C)}for(let m=0;m<l.length-2;m++){const C=`${l[m]} ${l[m+1]} ${l[m+2]}`;l[m].length>3&&l[m+1].length>2&&l[m+2].length>3&&a.push(C)}const k=[...a,...l];return[...new Set(k)].sort((m,C)=>C.length-m.length)}function An(n){const t=new Set(n),i={distribution:["spread","scatter","allocation","dispersion","arrangement"],data:["information","dataset","sample","observation","record"],figure:["chart","graph","plot","diagram","visualization","illustration"],table:["matrix","grid","tabular"],method:["approach","technique","algorithm","procedure","strategy"],result:["finding","outcome","conclusion","summary","finding"],analysis:["evaluation","examination","study","investigation","assessment"]};for(const a of n){const l=a.toLowerCase();t.add(l);for(const[k,m]of Object.entries(i))(l.includes(k)||k.includes(l))&&m.forEach(C=>t.add(C));l.endsWith("s")&&t.add(l.slice(0,-1)),l.endsWith("ed")&&t.add(l.slice(0,-2)),l.endsWith("ing")&&t.add(l.slice(0,-3))}return Array.from(t)}function Pn(n,t,i){if(!n||t.length===0)return n;const a=800,l=[];for(const f of t){const g=f.toLowerCase(),d=new RegExp(g.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");let x;for(;(x=d.exec(n))!==null;){const h=x.index,b=x.index+x[0].length,M=Math.max(0,h-a),I=Math.min(n.length,b+a),z=f.length>4?3:2;l.push({start:M,end:I,score:z})}}if(l.length===0)return ze(n,Math.floor(i/4));l.sort((f,g)=>f.start-g.start);const k=[];for(const f of l){let g=!1;for(let d=0;d<k.length;d++){const x=k[d];if(f.start<=x.end+200&&f.end>=x.start-200){x.start=Math.min(x.start,f.start),x.end=Math.max(x.end,f.end),x.score+=f.score,g=!0;break}}g||k.push(f)}k.sort((f,g)=>g.score-f.score);let m="",C=0;for(const f of k){if(C>=i*.9)break;const g=n.substring(f.start,f.end),d=g.length;if(C+d<=i)m&&(m+=`

---

`),m+=g,C+=d+10;else{const x=i-C-10;x>200&&(m&&(m+=`

---

`),m+=g.substring(0,x)+"...");break}}const N=i-C;if(N>500&&m){const f=Math.min(N*.3,500),g=Math.min(N*.2,300),d=n.substring(0,f),x=n.substring(Math.max(0,n.length-g));m=`[Document Introduction]
${d}

---

[Relevant Sections]
${m}

---

[Document Conclusion]
${x}`}else if(!m)return ze(n,Math.floor(i/4));return m}async function qt(n,t,i){if(!n)return n;const a=i*4;if(n.length<=a)return n;try{const{getRAGContext:C}=await st(async()=>{const{getRAGContext:f}=await import("./pdfRAG-BUQZRmsO.js");return{getRAGContext:f}},[]),N=await C(n,t,i);if(N&&N.length>100)return N}catch{}const l=Mn(t),k=An(l);if(k.length===0)return ze(n,i);const m=Pn(n,k,a);return m&&m.length>100?m:ze(n,i)}function ze(n,t){if(!n)return n;const i=t*4;if(n.length<=i)return n;const a=Math.floor(i*.6),l=Math.floor(i*.4),k=n.substring(0,a),m=n.substring(Math.max(0,n.length-l));let C=k;const N=k.lastIndexOf("."),f=k.lastIndexOf(`
`),g=Math.max(N,f);if(g>a*.7)C=k.substring(0,g+1);else{const I=k.lastIndexOf(" ");I>a*.8&&(C=k.substring(0,I))}let d=m;const x=m.indexOf("."),h=m.indexOf(`
`),b=x!==-1&&h!==-1?Math.min(x,h):x!==-1?x:h;if(b!==-1&&b<l*.3)d=m.substring(b+1);else{const I=m.indexOf(" ");I!==-1&&I<l*.2&&(d=m.substring(I+1))}const M=C+`

[... middle content truncated ...]

`+d;if(M.length>i){const I=M.length-i,z=`

[... middle content truncated ...]

`;if(I<=z.length)return C+`

[...]

`+d;const F=Math.floor(I*.6);return C.substring(0,C.length-F)+z+d}return M}function ft(n){if(!n)return 0;const t=n.trim().split(/\s+/).length,i=n.length;return Math.ceil(Math.max(t*1.33,i/4))}function gt(n,t){let i=0;t&&(i+=ft(t));for(const a of n){const l=typeof a.content=="string"?a.content:Array.isArray(a.content)&&a.content.find(k=>k.type==="text")?.text||"";i+=ft(l),i+=4}return i}function Yt(n,t,i){const a=n.toLowerCase().trim(),l=t.length>0,k=[/^(what|who|when|where|which)\s+(is|are|was|were)\s+\w{1,30}\?*$/i,/^(yes|no|ok|thanks|thank you|got it)/i,/^(explain|define|tell me about)\s+\w{1,20}$/i],m=[/^(it|that|this|they|those|these)/i,/^(also|additionally|furthermore|moreover|and|but)/i,/^(what about|how about|can you|could you|would you)/i,/^(can you|could you|would you)\s+(also|please|again)/i],C=[/(pdf|document|text|chapter|section|page|according to|in the|from the)/i,/(what does.*say|what is.*about|what does the.*say)/i,/(what is this.*about|what is the.*about|what's this.*about|what's the.*about)/i,/(tell me about.*pdf|tell me about.*document|tell me about.*text)/i,/(summarize.*pdf|summarize.*document|summarize.*text)/i,/(explain.*pdf|explain.*document|explain.*text)/i,/(describe.*pdf|describe.*document|describe.*text)/i,/(this pdf|the pdf|this document|the document)/i],N=[/(why|how|explain|analyze|compare|contrast|evaluate|discuss)/i,/(calculate|solve|derive|prove|show|demonstrate)/i,/(relationship|connection|difference|similarity|correlation)/i],f=k.some(W=>W.test(a)),g=l&&m.some(W=>W.test(a)),d=i&&C.some(W=>W.test(a)),x=N.some(W=>W.test(a)),h=/^(what is|what are|define|definition)/i.test(a),b=/(calculate|solve|compute|formula|equation|math)/i.test(a),M=/(compare|contrast|difference|similar|versus|vs)/i.test(a),I=/(what do you mean|clarify|explain.*again|repeat)/i.test(a),z=/(what is|what's|what are|tell me about|summarize|explain|describe).*(about|say|contain|discuss)/i.test(a);let F=0;d?F=.9:z&&i&&!g?F=.85:i&&!f&&!g?F=.4:i&&(F=.2);let q=0;g?q=.9:l&&(I||/^(it|that|this)/i.test(a))?q=.7:l&&(q=.2);let D="detailed";f||h?D="quick":(x||b||M)&&(D="reasoning");const V=i&&(d||z&&!g||!g&&!f&&i),Q=l&&(g||I||q>.5);return{needsPdfContext:V,needsChatHistory:Q,needsFullContext:V&&Q,answerComplexity:D,isClarification:I,isFollowUp:g,isDefinition:h,isCalculation:b,isComparison:M,pdfRelevanceScore:F,historyRelevanceScore:q,classificationMethod:"rule-based",confidence:f||g||d?.9:.6}}async function Tn(n,t,i,a){const l=t.length>0,k=f=>typeof f.content=="string"?f.content:Array.isArray(f.content)&&f.content.find(d=>d.type==="text")?.text||"",m=l?`Previous conversation has ${t.length} messages. Last user message: "${k(t[t.length-1]).substring(0,100)}"`:"No previous conversation history.",C=i?"A PDF document is available as context.":"No PDF document is available.",N={type:"object",properties:{needsPdfContext:{type:"boolean"},needsChatHistory:{type:"boolean"},needsFullContext:{type:"boolean"},answerComplexity:{type:"string",enum:["quick","detailed","reasoning"]},isClarification:{type:"boolean"},isFollowUp:{type:"boolean"},isDefinition:{type:"boolean"},isCalculation:{type:"boolean"},isComparison:{type:"boolean"},pdfRelevanceScore:{type:"number",minimum:0,maximum:1},historyRelevanceScore:{type:"number",minimum:0,maximum:1},confidence:{type:"number",minimum:0,maximum:1}},required:["needsPdfContext","needsChatHistory","needsFullContext","answerComplexity","isClarification","isFollowUp","isDefinition","isCalculation","isComparison","pdfRelevanceScore","historyRelevanceScore","confidence"],additionalProperties:!1};for(const f of yn)try{const g=await fetch(`${qe}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({messages:[{role:"system",content:`You are a question classification expert. Analyze the user's question and classify it to determine what context is needed for an optimal response. Consider:
- Whether the question is about the PDF document
- Whether the question references previous conversation
- The complexity of the answer needed (quick fact, detailed explanation, or reasoning)
- Question characteristics (clarification, follow-up, definition, calculation, comparison)

${C}
${m}

Output your classification as JSON matching the provided schema.`},{role:"user",content:n}],model:f,temperature:.3,maxTokens:500,response_format:{type:"json_schema",json_schema:{name:"question_classification",schema:N}}})});if(!g.ok)continue;const d=await g.json(),x=JSON.parse(d.choices[0]?.message?.content||"{}");return{...x,classificationMethod:"llm",confidence:x.confidence||.8}}catch{continue}return Yt(n,t,i)}async function In(n,t,i,a){const l=Yt(n,t,i);if(l.confidence>=.85)return l;try{return await Tn(n,t,i,a)}catch{return l}}function Ln(n,t,i){const a=t==="reasoning";if(n.needsPdfContext&&!n.needsChatHistory){const m=n.answerComplexity==="quick"?a?1500:2e3:n.answerComplexity==="detailed"&&!a?2e3:1500,C=2;return{includePdfContext:!0,pdfContextTokens:m,includeChatHistory:i>0,chatHistoryDepth:C,summarizeOldMessages:i>C,recentMessagesCount:C,preferQuickModel:n.answerComplexity==="quick",needsReasoning:n.answerComplexity==="reasoning"}}if(n.needsChatHistory&&!n.needsPdfContext){const m=n.isFollowUp||a?2:5;return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:!0,chatHistoryDepth:m,summarizeOldMessages:i>m,recentMessagesCount:m,preferQuickModel:n.answerComplexity==="quick",needsReasoning:n.answerComplexity==="reasoning"}}if(n.answerComplexity==="quick"&&!n.needsPdfContext&&!n.needsChatHistory)return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:i>0,chatHistoryDepth:2,summarizeOldMessages:i>2,recentMessagesCount:2,preferQuickModel:!0,needsReasoning:!1};const l=n.needsPdfContext?n.answerComplexity==="quick"?a?1200:1500:a?1500:n.answerComplexity==="detailed"?2e3:1500:0,k=n.needsChatHistory?a||n.isFollowUp?2:5:2;return{includePdfContext:n.needsPdfContext,pdfContextTokens:l,includeChatHistory:i>0,chatHistoryDepth:k,summarizeOldMessages:i>k,recentMessagesCount:k,preferQuickModel:n.answerComplexity==="quick",needsReasoning:n.answerComplexity==="reasoning"}}function _n(n,t=!1){if(n.length===0)return{role:"system",content:""};const i=[],a=t?50:80,l=t?80:120;for(let C=0;C<n.length;C+=2){const N=n[C],f=n[C+1];if(N&&N.role==="user"){const g=typeof N.content=="string"?N.content:Array.isArray(N.content)&&N.content.find(d=>d.type==="text")?.text||"";if(g.trim()){const d=g.length>a?g.substring(0,a)+"...":g;i.push(`Q: ${d}`)}}if(f&&f.role==="assistant"){const g=typeof f.content=="string"?f.content:Array.isArray(f.content)&&f.content.find(d=>d.type==="text")?.text||"";if(g.trim()){const d=g.length>l?g.substring(0,l)+"...":g;i.push(`A: ${d}`)}}}return{role:"system",content:`${t?`[Prev (${n.length})]`:`[Previous conversation (${n.length} msgs)]`}:
${i.join(`
`)}`}}function Gt(n){return typeof n=="string"?n.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim():Array.isArray(n)?n.map(t=>{if(t.type==="text"&&t.text){const i=t.text.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim();return{...t,text:i}}return t}).filter(t=>!(t.type==="text"&&t.text&&t.text.trim()==="")):n}function Qe(n){if(!n)return{thinking:null,mainContent:n};const t="__REASONING_START__",i="__REASONING_END__",a=n.indexOf(t),l=n.indexOf(i);if(a!==-1&&l!==-1&&l>a){const x=a+t.length,h=n.substring(x,l).trim(),b=n.substring(l+i.length).trim();return{thinking:h||null,mainContent:b}}const k=n.indexOf("<think>"),m=n.lastIndexOf("</think>");if(k===-1||m===-1||m<=k)return{thinking:null,mainContent:n};const C=k+7,N=n.substring(C,m).trim(),f=n.substring(0,k),g=n.substring(m+8),d=(f+g).trim();return{thinking:N||null,mainContent:d}}function Ut(n){if(!n||typeof n!="string")return"";let t=n.replace(/[\u2000-\u200B\u202F\u205F\u3000]/g," ");t=t.replace(/\u2011/g,"-"),t=t.replace(/(<[^>]*>)([^<]*)(<\/[^>]*>)/g,(r,o,p,v)=>{const c=p.replace(/\u2011/g,"-");return c!==p?o+c+v:r}),t=t.replace(/[\u2013\u2014]/g,"-"),t=t.replace(/[\u2018\u2019]/g,"'"),t=t.replace(/[\u201C\u201D]/g,'"'),t=t.replace(/\n{4,}/g,`


`),t=t.replace(/\$\$[\s\S]*?\$\$/g,r=>r.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-")),t=t.replace(/\$[^$\n]+?\$/g,r=>r.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-"));const i=[],a=r=>`__MATH_PLACEHOLDER_${r}__`;t=t.replace(/\$\$[\s\S]*?\$\$/g,r=>{const o=r.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return i.push(o),a(i.length-1)}),t=t.replace(/\\\(([\s\S]*?)\\\)/g,(r,o)=>{let p=o.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");p=p.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const v=`$${p}$`;return i.push(v),a(i.length-1)}),t=t.replace(/\$[^$\n]+?\$/g,r=>{const o=r.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return i.push(o),a(i.length-1)}),t=t.replace(/\\\[([\s\S]*?)\\\]/g,(r,o)=>{let p=o.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");p=p.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const v=`$$${p}$$`;return i.push(v),a(i.length-1)});const l=[],k=/\(([^()]*?(?:[\\_^]|\\[a-zA-Z@]+\{[^}]*\}|\\pm|\\sim|\\times|\\div|\\sqrt|\\frac|\\text\{|\\approx|\\leq|\\geq|\\neq|\\sum|\\int|\\prod|=\s*\\[a-zA-Z@]+|~\s*\\[a-zA-Z@]+)[^()]*?)\)/g;let m;for(;(m=k.exec(t))!==null;){const r=m[0],o=m.index,p=o>0?t[o-1]:"",v=o+r.length<t.length?t[o+r.length]:"";p==="$"&&v==="$"||t.substring(Math.max(0,o-2),o).includes("](")||p==="`"||v==="`"||t.substring(Math.max(0,o-10),o+r.length+10).includes("__MATH_PLACEHOLDER")||l.push({match:r,index:o})}const C=[],N=/\\[a-zA-Z@]+(?:_[a-zA-Z0-9{}]+|\^[a-zA-Z0-9{}]+)?\s*[~Â±â‰¤â‰¥â‰ â‰ˆ=]\s*[^.,;:!?\n]{5,150}?(?=\s|$|[.,;:!?]|\\[a-zA-Z@]|_[a-zA-Z0-9]|\^[a-zA-Z0-9])/g;let f;for(;(f=N.exec(t))!==null;){const r=f.index;let o=f[0];const p=Math.max(o.indexOf("~"),o.indexOf("="),o.indexOf("Â±"),o.indexOf("â‰¤"),o.indexOf("â‰¥"),o.indexOf("â‰ "),o.indexOf("â‰ˆ"));if(p===-1||p===o.length-1)continue;const v=o.substring(p+1);if(!/\\[a-zA-Z@]+|_[a-zA-Z0-9{}]|\^[a-zA-Z0-9{}]/.test(v))continue;const c=/[.,;:!?]/.exec(o);c&&c.index>10&&c.index<o.length-5&&(o=o.substring(0,c.index+1));const j=r>0?t[r-1]:"",E=r+o.length<t.length?t[r+o.length]:"";if(j==="$"||E==="$"||j==="`"||E==="`"||t.substring(Math.max(0,r-10),r+o.length+10).includes("__MATH_PLACEHOLDER"))continue;!l.some(B=>{const _=B.index,O=_+B.match.length;return r>=_&&r+o.length<=O})&&o.length>10&&C.push({match:o,index:r})}const g=[],d=(r,o)=>{let p=0,v=o;for(;v<r.length;){if(r[v]==="{")p++;else if(r[v]==="}"&&(p--,p===0))return v+1;v++}return-1},x=/\\sqrt\[[^\]]+\](?=\{)/g;let h;for(;(h=x.exec(t))!==null;){const r=h.index,o=r+h[0].length;if(t[o]==="{"){const p=d(t,o);if(p!==-1){const v=t.substring(r,p),c=r>0?t[r-1]:"",j=p<t.length?t[p]:"";c!=="$"&&j!=="$"&&!t.substring(Math.max(0,r-10),p+10).includes("__MATH_PLACEHOLDER")&&g.push({match:v,index:r})}}}const b=/\\(sqrt|frac|text|overline|underline)(?=\{)/g;let M;for(;(M=b.exec(t))!==null;){const r=M.index,o=M[1],p=r+M[0].length;if(t[p]==="{")if(o==="frac"){const v=d(t,p);if(v===-1||t[v]!=="{")continue;const c=d(t,v);if(c===-1)continue;const j=t.substring(r,c),E=r>0?t[r-1]:"",Z=c<t.length?t[c]:"";E!=="$"&&Z!=="$"&&!t.substring(Math.max(0,r-10),c+10).includes("__MATH_PLACEHOLDER")&&g.push({match:j,index:r})}else{const v=d(t,p);if(v===-1)continue;const c=t.substring(r,v),j=r>0?t[r-1]:"",E=v<t.length?t[v]:"";j!=="$"&&E!=="$"&&!t.substring(Math.max(0,r-10),v+10).includes("__MATH_PLACEHOLDER")&&(l.some(B=>{const _=B.index,O=_+B.match.length;return r>=_&&v<=O})||C.some(B=>{const _=B.index,O=_+B.match.length;return r>=_&&v<=O})||g.push({match:c,index:r}))}}t=t.replace(/(\$?\s*)(\d{1,3}(?:\s+\d{3})+)(\b)/g,(r,o,p,v)=>{const c=p.replace(/\s+/g,",");return o.trim().startsWith("$")?`$${c}$${v}`:o+c+v}),t=t.replace(/\$(\d{1,3}(?:,\d{3})+)(?![$])/g,(r,o,p,v)=>{if((p>0?v[p-1]:"")==="$")return r;const j=p+r.length;if(j<v.length&&v[j]==="$")return r;const E=j<v.length?v[j]:"";return E===" "||/[.,;:!?)]/.test(E)?`$${o}$${E}`:`$${o}$`});const I=/(\d+)\{,\}(\d+)/g,z=[];let F;for(;(F=I.exec(t))!==null;){const r=`${F[1]}{,}${F[2]}`,o=F.index,p=o+F[0].length,v=t.substring(0,o),c=t.substring(p),j=v.lastIndexOf("\\("),E=c.indexOf("\\)");if(j!==-1&&E!==-1&&!t.substring(j+2,o).includes("\\)")||t.substring(Math.max(0,o-10),p+10).includes("__MATH_PLACEHOLDER"))continue;const Z=v.lastIndexOf("\\["),B=c.indexOf("\\]");if(Z!==-1&&B!==-1&&!t.substring(Z+2,o).includes("\\]"))continue;const _=v.lastIndexOf("$$"),O=c.indexOf("$$");if(_!==-1&&O!==-1&&!t.substring(_+2,o).includes("$$"))continue;const te=v.lastIndexOf("$"),ae=c.indexOf("$");if(te!==-1&&ae!==-1){const re=te>0?v[te-1]:"",Ee=ae<c.length-1?c[ae+1]:"";if(re!=="$"&&Ee!=="$"&&(t.substring(te+1,o).match(/\$/g)||[]).length%2===0)continue}let L=o,G=p,ye=-1,we=-1;for(let re=o;re>=Math.max(0,o-200);re--)if(t[re]==="["){ye=re;break}else if(t[re]==="]")break;if(ye!==-1){for(let re=p;re<Math.min(t.length,p+200);re++)if(t[re]==="]"){we=re+1;break}else if(t[re]==="["&&re>p)break}if(ye!==-1&&we!==-1)L=ye,G=we,t.substring(L,o),t.substring(p,G);else{let re=!1,Ee=!1,Me=!1;for(;L>0;){const ke=t[L-1];if(ke==="\\")L--,re=!0;else if(ke==="(")L--,Ee=!0;else if(ke==="$"){if((L>1?t[L-2]:"")==="\\"){L-=2,Me=!0;break}else if(Ee||!re){if(L--,Me=!0,Ee)break}else if(L--,Me=!0,Ee)break}else if(ke==="["){L--;break}else if(/\s/.test(ke))L--;else if(Ee&&!Me&&L>o-5)L--;else break}for(;G<t.length;){const ke=t[G];if(ke==="]"||ke===")"||ke===";"||ke==="$"){G++;break}else if(ke===",")G++;else if(/\s/.test(ke))G++;else break}}const Ce=t.substring(L,G);z.push({numberPart:r,fullMatch:Ce,startIndex:L,endIndex:G,prefix:t.substring(L,o),suffix:t.substring(p,G)})}const q=[],D=/(?:\\pm|\\times|\\div|\\sim|\\approx|\\leq|\\geq|\\neq|\\alpha|\\beta|\\gamma|\\delta|\\epsilon|\\varepsilon|\\theta|\\lambda|\\mu|\\pi|\\sigma|\\phi|\\chi|\\omega|[a-zA-Z]_[a-zA-Z0-9{}]+|\\[a-zA-Z@]+(?:_[a-zA-Z0-9{}]+|\^[a-zA-Z0-9{}]+)(?!\{))/g;let V;for(;(V=D.exec(t))!==null;){const r=V.index,o=V[0],p=r>0?t[r-1]:"",v=r+o.length<t.length?t[r+o.length]:"";if(p==="$"||v==="$"||p==="`"||v==="`"||t.substring(Math.max(0,r-10),r+o.length+10).includes("__MATH_PLACEHOLDER")||p&&/[a-zA-Z0-9]/.test(p)&&!o.startsWith("\\")||v&&/[a-zA-Z0-9]/.test(v)&&!o.includes("_")&&!o.includes("^")&&!o.startsWith("\\"))continue;l.some(j=>{const E=j.index,Z=E+j.match.length;return r>=E&&r+o.length<=Z})||C.some(j=>{const E=j.index,Z=E+j.match.length;return r>=E&&r+o.length<=Z})||g.some(j=>{const E=j.index,Z=E+j.match.length;return r>=E&&r+o.length<=Z})||(o.startsWith("\\")||o.includes("_")||o.includes("^"))&&q.push({match:o,index:r})}const Q=new Set;for(let r=z.length-1;r>=0;r--){const{numberPart:o,fullMatch:p,startIndex:v,endIndex:c,prefix:j,suffix:E}=z[r];if(p.startsWith("[")&&p.endsWith("]"))continue;const Z=t.substring(0,v),B=t.substring(c);if(Z.endsWith("$")&&B.startsWith("$"))continue;const _=v>0?t[v-1]:"",O=c<t.length?t[c]:"";if(_==="$"&&O==="$")continue;let te="";const ae=j.includes("(")||p.startsWith("("),L=E.includes(")")||p.endsWith(")"),G=j.includes("\\")||p.startsWith("\\"),ye=j.includes("$")||p.startsWith("$");if(j.endsWith("\\$")||j.match(/\\\$\s*$/)!==null||p.startsWith("\\$")||v>1&&t.substring(v-2,v)==="\\$"){let Ce=j;j.endsWith("\\$")?Ce=j.slice(0,-2)+"$":j.match(/\\\$\s*$/)?Ce=j.replace(/\\\$\s*$/,"$"):Ce=j.replace(/\\\$/g,"$"),te=Ce+`$${o}$`+E}else if(ae&&G&&L)te=j+`$${o}$`+E;else if(ae&&ye)te=j+`$${o}$`+E;else if(G&&L&&!ae)te=j+`$${o}$`+E;else if(G&&!ae)te=j+`$${o}$`+E;else if(ae&&L)te=j+`$${o}$`+E;else if(ye&&!ae)te=j+`$${o}$`+E;else{if(p.startsWith("$")&&p.endsWith("$"))continue;te=j+`$${o}$`+E}t=Z+te+B}const J=/\[([^\]]*(\d+)\{,\}(\d+)[^\]]*)\]/g;let W;const A=[];for(;(W=J.exec(t))!==null;){const r=W[1],o=W.index,p=o+W[0].length;A.push({bracketContent:r,startIndex:o,endIndex:p})}for(let r=A.length-1;r>=0;r--){const{bracketContent:o,startIndex:p,endIndex:v}=A[r],c=`${p}-${v}`;if(Q.has(c))continue;Q.add(c);const j=t.substring(0,p),E=t.substring(v),Z=o.replace(/(\d+)\{,\}(\d+)/g,(B,_,O)=>{const te=o.indexOf(B);if(te===-1)return B;const ae=o.substring(0,te),L=o.substring(te+B.length),G=ae.trim(),ye=L.trim();return G.endsWith("$")&&ye.startsWith("$")?B:`$${_}{,}${O}$`});t=j+`[${Z}]`+E}for(let r=g.length-1;r>=0;r--){const{match:o,index:p}=g[r],v=t.substring(0,p),c=t.substring(p+o.length);v.endsWith("$")&&c.startsWith("$")||(t=v+`$${o}$`+c)}for(let r=l.length-1;r>=0;r--){const{match:o,index:p}=l[r],v=t.substring(0,p),c=t.substring(p+o.length);v.endsWith("$")&&c.startsWith("$")||(t=v+`$${o}$`+c)}for(let r=C.length-1;r>=0;r--){const{match:o,index:p}=C[r],v=t.substring(0,p),c=t.substring(p+o.length);v.endsWith("$")&&c.startsWith("$")||(t=v+`$${o}$`+c)}for(let r=q.length-1;r>=0;r--){const{match:o,index:p}=q[r],v=t.substring(0,p),c=t.substring(p+o.length);v.endsWith("$")&&c.startsWith("$")||(t=v+`$${o}$`+c)}i.forEach((r,o)=>{const p=a(o);let v=r.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");for(v=v.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");t.includes(p);)t=t.replace(p,v)});let H=100,ee=0;for(;t.includes("__MATH_PLACEHOLDER_")&&ee<H;){ee++;const r=t.match(/__MATH_PLACEHOLDER_(\d+)__/);if(!r)break;const o=parseInt(r[1],10);if(o>=0&&o<i.length){const v=i[o].replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");t=t.replace(r[0],v)}else t=t.replace(r[0],"")}return t.includes("â€‘")&&(t=t.replace(/\u2011/g,"-")),t=t.replace(/(\$[\d,]+)\$([a-zA-Z])/g,"$1$ $2"),t=t.replace(/([a-zA-Z])(\$[\d,]+)\$/g,"$1 $2$"),t}function Rn({selectedText:n,pdfText:t,onToggleLayout:i,layout:a,currentPageNumber:l,onCreateKnowledgeNote:k,onClearSelectedText:m,onAddAnnotationToPDF:C,onOpenKnowledgeNotes:N}){const{theme:f}=mt(),{isAuthenticated:g,user:d,loading:x}=xt();u.useEffect(()=>{const s=console.warn;return console.warn=(...$)=>{const S=$.map(y=>{if(typeof y=="string")return y;if(y&&typeof y=="object")try{return JSON.stringify(y)}catch{return String(y)}return String(y)}).join(" ");S.includes("No character metrics")&&(S.includes("â€‘")||S.includes("8209")||S.includes("U+2011"))||S.includes("Unrecognized Unicode character")&&(S.includes("â€‘")||S.includes("8209")||S.includes("U+2011"))||S.includes("LaTeX-incompatible input")&&(S.includes("â€‘")||S.includes("8209")||S.includes("U+2011"))||S.includes("unknownSymbol")&&(S.includes("â€‘")||S.includes("8209")||S.includes("U+2011"))||s.apply(console,$)},()=>{console.warn=s}},[]);const[h,b]=u.useState([]),[M,I]=u.useState({}),[z,F]=u.useState({}),[q,D]=u.useState({}),[V,Q]=u.useState({}),[J,W]=u.useState(""),[A,H]=u.useState(!1),[ee,r]=u.useState(null),[o,p]=u.useState(!0),[v,c]=u.useState(!0),[j,E]=u.useState(!0),[Z,B]=u.useState(null),[_,O]=u.useState("auto"),[te,ae]=u.useState(null),[L,G]=u.useState([]),[ye,we]=u.useState(!1),[Ce,re]=u.useState(!1),[Ee,Me]=u.useState(!1),[ke,Ge]=u.useState({}),[be,Ue]=u.useState(!1),Se=u.useRef(null),He=u.useRef(null),Ve=u.useRef(null),Ae=u.useRef({}),Te=u.useRef(null),_e=u.useRef(null),je=u.useRef(null),yt=u.useRef(null),lt=u.useRef(null),me=u.useRef(null),[wt,ot]=u.useState(null),[kt,ct]=u.useState(null),Oe=(s=!0,$=!1)=>{if(me.current){const S=me.current;(S.scrollHeight-S.scrollTop-S.clientHeight<100||$)&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!me.current)return;const y=me.current;s?Te.current?Te.current.scrollIntoView({behavior:"smooth"}):y.scrollTo({top:y.scrollHeight,behavior:"smooth"}):Te.current?Te.current.scrollIntoView({behavior:"auto"}):y.scrollTop=y.scrollHeight})})}},dt=()=>{const s=_e.current;if(s){s.style.height="auto";const w=Math.min(Math.max(s.scrollHeight,24),200);s.style.height=`${w}px`}},bt=u.useRef(0),Jt=u.useRef(null);u.useEffect(()=>{const s=h.length,$=bt.current,w=(h.length>0?h[h.length-1]:null)?.role||null;s>$?w==="user"?Oe(!0,!0):Oe(!0):s===$&&A&&Oe(!1),bt.current=s,Jt.current=w},[h,A]),u.useEffect(()=>{if(!me.current||!A)return;const s=me.current;let $=s.scrollHeight,S=null;const w=new ResizeObserver(()=>{if(!me.current)return;const y=me.current.scrollHeight,P=me.current.scrollHeight-me.current.scrollTop-me.current.clientHeight<100;y>$&&P?(S&&clearTimeout(S),S=setTimeout(()=>{Oe(!1),$=y},50)):$=y});return w.observe(s),()=>{w.disconnect(),S&&clearTimeout(S)}},[A]),u.useEffect(()=>()=>{Se.current&&clearTimeout(Se.current)},[]),u.useEffect(()=>{_e.current?.focus(),dt()},[]),u.useEffect(()=>{const s=setTimeout(()=>{dt()},0);return()=>clearTimeout(s)},[J]);const rt=async()=>{if(g){c(!0);try{const s=await En();p(!s)}catch(s){console.warn("API key check failed:",s)}finally{c(!1)}}else p(!0),c(!1)};u.useEffect(()=>{rt();const s=setInterval(()=>{g&&rt()},1e4);return()=>clearInterval(s)},[g,d]),u.useEffect(()=>{a==="split"&&(E(!1),B(null))},[a]),u.useEffect(()=>{a==="floating"&&!j&&Z!==null&&me.current&&requestAnimationFrame(()=>{me.current&&(me.current.scrollTop=Z)})},[j,a,Z]),u.useEffect(()=>{if(a!=="floating"){ot(null);return}const s=()=>{const $=window.innerHeight,S=window.innerWidth<=768?70:90,w=60,y=400,P=$-w-S;if(P<y)E(!0),ot(null);else if(j)ot(null);else{const X=Math.min(P-200,600);ot(Math.max(X,300))}};return s(),window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s)}},[a,j]),u.useEffect(()=>{if(!te||!me.current||!lt.current){ct(null);return}const s=()=>{const S=me.current,w=lt.current;if(!S||!w)return;const y=S.clientHeight,P=window.innerHeight,X=Math.min(P*.7,600)+40;if(X<=y)ct(null);else{const pe=w.clientHeight-y,K=X+pe;ct(K)}},$=setTimeout(s,100);return window.addEventListener("resize",s),()=>{clearTimeout($),window.removeEventListener("resize",s)}},[te]);const vt=()=>{switch(_){case"auto":return Ye[0];case"reasoning":return Je[0];case"advanced":return nt.primary}},jt=s=>{O(s),s!=="auto"&&L.length>0&&G([])},De=()=>{if(_!=="auto")return!1;const s=vt();return s==="meta-llama/llama-4-scout-17b-16e-instruct"||s==="meta-llama/llama-4-maverick-17b-128e-instruct"};u.useEffect(()=>{!De()&&L.length>0&&G([])},[_]);const Ct=s=>{Array.from(s).forEach(S=>{if(!S.type.startsWith("image/")){r("Please upload image files only.");return}const w=new FileReader;w.onload=y=>{const P=y.target?.result;P&&G(U=>[...U,P])},w.onerror=()=>{r("Failed to read image file.")},w.readAsDataURL(S)})},St=s=>{const $=s.target.files;!$||$.length===0||(Ct($),He.current&&(He.current.value=""))},en=s=>{De()&&(s.preventDefault(),s.stopPropagation(),we(!0))},tn=s=>{De()&&(s.preventDefault(),s.stopPropagation(),we(!1))},nn=s=>{if(!De())return;s.preventDefault(),s.stopPropagation(),we(!1);const $=s.dataTransfer.files;$&&$.length>0&&Ct($)},Ke=()=>{const s=Ve.current;if(!s){re(!1),Me(!1);return}re(s.scrollLeft>0),Me(s.scrollLeft<s.scrollWidth-s.clientWidth-1)},$t=s=>{const $=Ve.current;if(!$)return;const S=200,w=s==="left"?$.scrollLeft-S:$.scrollLeft+S;$.scrollTo({left:w,behavior:"smooth"})},it=s=>{const $=Ae.current[s];if(!$){Ge(y=>({...y,[s]:{canScrollLeft:!1,canScrollRight:!1}}));return}const S=$.scrollLeft>0,w=$.scrollLeft<$.scrollWidth-$.clientWidth-1;Ge(y=>({...y,[s]:{canScrollLeft:S,canScrollRight:w}}))},Nt=(s,$)=>{const S=Ae.current[s];if(!S)return;const w=200,y=$==="left"?S.scrollLeft-w:S.scrollLeft+w;S.scrollTo({left:y,behavior:"smooth"})};u.useEffect(()=>{const s=setTimeout(()=>{Ke()},0),$=Ve.current;return $?($.addEventListener("scroll",Ke),window.addEventListener("resize",Ke),()=>{clearTimeout(s),$.removeEventListener("scroll",Ke),window.removeEventListener("resize",Ke)}):()=>{clearTimeout(s)}},[L]),u.useEffect(()=>{const s=setTimeout(()=>{Object.keys(Ae.current).forEach(S=>{it(S)})},0),$=()=>{Object.keys(Ae.current).forEach(S=>{it(S)})};return window.addEventListener("resize",$),()=>{clearTimeout(s),window.removeEventListener("resize",$)}},[h]);const Et=async()=>{const s=J.trim(),$=L.length>0;if(!s&&!n&&!$)return;if(!g){r("Please sign in to use the chat feature.");return}if(o){r("Please configure your Groq API key in Settings.");return}j&&E(!1),je.current&&je.current.abort(),je.current=new AbortController;let S=s;n&&!s?S=`Tell me about this: ${n}`:n&&s&&(S=`${s}

Context from PDF: ${n}`);let w;if(De()&&L.length>0){const Y=[];S&&Y.push({type:"text",text:S}),L.forEach(Le=>{Y.push({type:"image_url",image_url:{url:Le}})}),w=Y}else w=S;const y={id:Date.now().toString(),role:"user",content:w,selectedTextAtSend:n||void 0};b(Y=>[...Y,y]),W(""),G([]),setTimeout(()=>{dt()},0),H(!0),r(null),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Oe(!0,!0)})});const P=_==="reasoning",U=t&&t.trim().length>0||!!n,X=s||(n?`Tell me about: ${n}`:""),pe=localStorage.getItem("auth_token")||"";let K,ue;try{K=await In(X,h,U,pe),ue=Ln(K,_,h.length)}catch(Y){console.warn("[Smart Router] Classification failed, using default routing:",Y),ue={includePdfContext:U,pdfContextTokens:P?1500:2e3,includeChatHistory:!0,chatHistoryDepth:P?2:5,summarizeOldMessages:h.length>(P?2:5),recentMessagesCount:P?2:5,preferQuickModel:!1,needsReasoning:!1}}let ge;ue.includePdfContext&&ue.pdfContextTokens>0&&(n&&!s?ge=ze(n,ue.pdfContextTokens):t&&t.trim().length>0?s&&s.trim().length>0?ge=await qt(t,s,ue.pdfContextTokens):ge=ze(t,ue.pdfContextTokens):n&&s&&(ge=ze(n,ue.pdfContextTokens)));const oe=(Date.now()+1).toString(),Ie=y.selectedTextAtSend,Ne={id:oe,role:"assistant",content:"",selectedTextAtSend:Ie};b(Y=>[...Y,Ne]),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Oe(!0,!0)})});try{let Y=[];if(ue.includeChatHistory&&h.length>0){const le=h.length,T=ue.recentMessagesCount;if(le>T&&ue.summarizeOldMessages){const ce=h.slice(0,le-T),de=h.slice(-T);Y=[_n(ce,P),...de.map(fe=>({role:fe.role,content:fe.content}))]}else le<=T?Y=h.map(ce=>({role:ce.role,content:ce.content})):Y=h.slice(-T).map(ce=>({role:ce.role,content:ce.content}))}else Y=[];const Le=gt([...Y,y],ge),Fe={"openai/gpt-oss-120b":7e3,"openai/gpt-oss-20b":7e3,"qwen/qwen3-32b":5e3},xe=vt(),R=Fe[xe]||8e3;if(Le>R&&ge){const le=R/Le,T=Math.floor(ft(ge)*le*.9);ge=ze(ge,T)}const ve={role:"system",content:'You are a mathematical assistant. All mathematical equations you generate must be 100% compatible with the KaTeX rendering engine.\n\nFollow these strict rules:\n\n1. **Delimiters:**\n   * For block-level equations (on their own line), **must** use `$$...$$` delimiters.\n   * For inline equations (inside a sentence), **must** use `\\(...\\)` delimiters.\n   * **Do not** use single `$` or `\\[...\\]` delimiters.\n\n2. **Alignment (Crucial):**\n   * To align multiple equations, **must** use the `aligned` environment.\n   * **Do not** use the `align`, `align*`, or `eqnarray` environments, as they are not supported.\n   * Example of a correct multi-line equation:\n     ```\n     $$\n     \\begin{aligned}\n     a &= b + c \\\\\n     d &= e + f\n     \\end{aligned}\n     $$\n     ```\n\n3. **General Formatting:**\n   * Use standard, common LaTeX commands.\n   * To write plain text inside math, **must** use `\\text{...}`.\n   * To create a fraction, **must** use `\\frac{...}{...}`.\n   * To create a matrix or case, use the `pmatrix`, `bmatrix`, or `cases` environments.\n   * **Do not** use complex, obscure, or custom LaTeX packages. Stick to `amsmath`-style commands that are known to be supported by KaTeX.\n\n4. **Dollar Amounts and Numbers:**\n   * For dollar amounts in text (e.g., "$40,000", "$1,000"), use plain text with commas, NOT math delimiters.\n   * **Always include spaces** before and after dollar amounts when they appear in sentences (e.g., "between $40,000 and $42,000", not "between $40,000and$42,000").\n   * **Do not** wrap dollar amounts in `$` delimiters unless they are part of a mathematical expression.\n   * For consistency, use the same formatting style for similar phrases (e.g., if you use "no smaller than" in normal text, use "no larger than" in the same style, not italic).\n\n5. **Text Formatting Consistency:**\n   * Use consistent markdown formatting for similar phrases.\n   * If you use italic (`*text*`) for emphasis, use it consistently for similar phrases.\n   * **Always preserve spaces** between numbers and words (e.g., "1,000 and", not "1,000and").'},ne=Y.length>0&&Y[0]?.role==="system"?Y:[ve,...Y];let ie=gt([...ne,y],ge);if(ie>R&&ne.length>1){const le=ne[0]?.role==="system"?ne[0]:null,T=le?ne.slice(1):ne,ce=T[0],se=T.slice(1).slice(-2);Y=ce?.content?le?[le,ce,...se]:[ce,...se]:le?[le,...se]:se,ie=gt([...Y,y],ge)}else Y=ne;ie>R&&ge&&(ge=void 0);let he="";const We=y,et=zt([...Y,We],ge,le=>{if(je.current?.signal.aborted)return;he+=le;const{thinking:T,mainContent:ce}=Qe(he),de=T&&T.trim().length>0;b(P||_==="advanced"&&de?se=>se.map(fe=>fe.id===oe?{...fe,content:ce||he,thinking:de?T:fe.thinking}:fe):se=>se.map(fe=>fe.id===oe?{...fe,content:he}:fe)),Oe(!1)},xe,je.current?.signal,P);et.catch(le=>{if(!(le instanceof DOMException&&le.name==="AbortError"))throw le});const Pe=await et,{thinking:$e,mainContent:Ze}=Qe(Pe);let tt=$e,ut=Ze;if($e&&(!Ze||Ze.trim().length===0)){const le=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let T=null;for(const ce of le){const de=$e.match(ce);if(de&&de[1]){const se=$e.indexOf(de[0]),fe=$e.substring(se+de[0].length);let Xe=de[1].trim();const It=fe.match(/^([^.!?]*[.!?]+)/);if(It)Xe+=It[1];else{const Be=fe.match(/^([^\n]+)/);Be&&(Xe+=Be[1])}if(T=Xe.trim(),T&&!T.match(/^[A-Z"']/)){const Lt=$e.substring(Math.max(0,se-200),se).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);Lt&&(T=Lt[2]+T)}if(T.length>300){const Be=T.match(/[^.!?]*[.!?]+/g);Be&&Be.length>0?(T=Be.slice(0,2).join(" ").trim(),Be.length>2&&(T+="...")):T=T.substring(0,300).trim()+"..."}break}}if(!T){const ce=$e.split(/\n\n+/).filter(de=>de.trim().length>0);if(ce.length>0){for(let de=ce.length-1;de>=0;de--){const se=ce[de].trim();if(!se.match(/^(?:Step \d+|## Step|\d+\.)/i)&&se.length>50){const fe=se.match(/[^.!?]*[.!?]+/g);if(fe&&fe.length>0?T=fe.slice(-2).join(" ").trim():T=se,T.length>300){const Xe=fe?fe.slice(0,2).join(" ").trim():null;Xe?T=Xe+(fe&&fe.length>2?"...":""):T=se.substring(0,300).trim()+"..."}break}}if(!T&&ce.length>0){const de=ce[ce.length-1].trim(),se=de.match(/[^.!?]*[.!?]+/g);se&&se.length>0?(T=se.slice(-2).join(" ").trim(),T.length>300&&(T=se.slice(0,2).join(" ").trim()+(se.length>2?"...":""))):(T=de,T.length>300&&(T=de.substring(0,300).trim()+"..."))}}}T&&(T=T.replace(/\$\\([0-7]{1,3})(\d[^$]*)\$/g,(ce,de,se)=>`$${de}${se}$`),T=T.replace(/\$\\\$(\d[^$]*)\$/g,"$$$1$"),T=T.replace(/\\\$(\d[^$]*?)(?=\s|$|,|\.|;)/g,"$$$1$")),ut=T||"",tt=$e}else $e&&Ze&&$e.trim()===Ze.trim()&&(tt=null,ut=Ze);const ht=tt&&tt.trim().length>0,at={content:ut||(ht?"":Pe),thinking:ht&&tt||void 0,timestamp:Date.now()};D(le=>{const ce=[...le[oe]||[],at],de=ce.length-1;return Q(se=>({...se,[oe]:de})),{...le,[oe]:ce}}),b(P||_==="advanced"&&ht?le=>le.map(T=>T.id===oe?{...T,content:at.content,thinking:at.thinking}:T):le=>le.map(T=>T.id===oe?{...T,content:at.content,thinking:void 0}:T))}catch(Y){Y instanceof DOMException&&Y.name==="AbortError"||(console.error("Error sending message (details logged, user sees sanitized message):",Y),r(Y instanceof Error?Y.message:"Unable to send message. Please try again."),b(Le=>Le.filter(Fe=>Fe.id!==oe)))}finally{H(!1),je.current=null,_e.current?.focus()}},sn=()=>{je.current&&(je.current.abort(),je.current=null,H(!1),_e.current?.focus())},on=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),Et())},rn=()=>{n&&(W(`Tell me about this: ${n}`),_e.current?.focus())},an=async s=>{const $=h.findIndex(P=>P.id===s);if($===-1||h[$].role!=="assistant")return;let S=$-1;for(;S>=0&&h[S].role!=="user";)S--;if(S<0)return;const w=h[S],y=_==="reasoning";b(P=>P.map(U=>U.id===s?{...U,content:"",thinking:void 0}:U)),H(!0),je.current&&je.current.abort(),je.current=new AbortController;try{const P=typeof w.content=="string"?w.content:w.content.filter(xe=>xe.type==="text").map(xe=>xe.text).join(`
`),U=w.selectedTextAtSend,X=h.slice(0,$).map(xe=>({role:xe.role,content:xe.content}));let pe;t&&t.trim().length>0&&(U?pe=U:pe=await qt(t,P,y?1500:2e3));let K;_==="auto"?K=Ye[0]:_==="reasoning"?K=Je[0]:K=nt.primary;let ue="";const ge=await zt([...X,w],pe,xe=>{if(je.current?.signal.aborted)return;ue+=xe;const{thinking:R,mainContent:ve}=Qe(ue),ne=R&&R.trim().length>0;b(y||_==="advanced"&&ne?ie=>ie.map(he=>he.id===s?{...he,content:ve||ue,thinking:ne?R:he.thinking}:he):ie=>ie.map(he=>he.id===s?{...he,content:ue}:he)),Oe(!1)},K,je.current.signal,y),{thinking:oe,mainContent:Ie}=Qe(ge),Ne=oe&&oe.trim().length>0;let Y=oe,Le=Ie;if(_==="advanced"&&Ne)if(oe&&(!Ie||Ie.trim().length===0)){const xe=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let R=null;for(const ve of xe){const ne=oe.match(ve);if(ne&&ne[1]){const ie=oe.indexOf(ne[0]),he=oe.substring(ie+ne[0].length);let We=ne[1].trim();const et=he.match(/^([^.!?]*[.!?]+)/);if(et)We+=et[1];else{const Pe=he.match(/^([^\n]+)/);Pe&&(We+=Pe[1])}if(R=We.trim(),R&&!R.match(/^[A-Z"']/)){const $e=oe.substring(Math.max(0,ie-200),ie).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);$e&&(R=$e[2]+R)}if(R.length>300){const Pe=R.match(/[^.!?]*[.!?]+/g);Pe&&Pe.length>0?(R=Pe.slice(0,2).join(" ").trim(),Pe.length>2&&(R+="...")):R=R.substring(0,300).trim()+"..."}break}}if(!R){const ve=oe.split(/\n\n+/).filter(ne=>ne.trim().length>0);if(ve.length>0){for(let ne=ve.length-1;ne>=0;ne--){const ie=ve[ne].trim();if(!ie.match(/^(?:Step \d+|## Step|\d+\.)/i)&&ie.length>50){const he=ie.match(/[^.!?]*[.!?]+/g);if(he&&he.length>0?R=he.slice(-2).join(" ").trim():R=ie,R.length>300){const We=he?he.slice(0,2).join(" ").trim():null;We?R=We+(he&&he.length>2?"...":""):R=ie.substring(0,300).trim()+"..."}break}}if(!R&&ve.length>0){const ne=ve[ve.length-1].trim(),ie=ne.match(/[^.!?]*[.!?]+/g);ie&&ie.length>0?(R=ie.slice(-2).join(" ").trim(),R.length>300&&(R=ie.slice(0,2).join(" ").trim()+(ie.length>2?"...":""))):(R=ne,R.length>300&&(R=ne.substring(0,300).trim()+"..."))}}}R&&(R=R.replace(/\$\\([0-7]{1,3})(\d[^$]*)\$/g,(ve,ne,ie)=>`$${ne}${ie}$`),R=R.replace(/\$\\\$(\d[^$]*)\$/g,"$$$1$"),R=R.replace(/\\\$(\d[^$]*?)(?=\s|$|,|\.|;)/g,"$$$1$")),Le=R||"",Y=oe}else oe&&Ie&&oe.trim()===Ie.trim()&&(Y=null,Le=Ie);const Fe={content:Le||(Ne?"":ge),thinking:Ne&&Y||void 0,timestamp:Date.now()};D(xe=>{const ve=[...xe[s]||[],Fe];return Q(ne=>{const ie=ve.length-1;return{...ne,[s]:ie}}),{...xe,[s]:ve}}),b(y||_==="advanced"&&Ne?xe=>xe.map(R=>R.id===s?{...R,content:Fe.content,thinking:Fe.thinking}:R):xe=>xe.map(R=>R.id===s?{...R,content:Fe.content,thinking:void 0}:R))}catch(P){if(!(P instanceof DOMException&&P.name==="AbortError")){console.error("Error resending message:",P),r(P instanceof Error?P.message:"Unable to resend message. Please try again.");const U=q[s]||[];if(U.length>0){const X=U[U.length-1];b(pe=>pe.map(K=>K.id===s?{...K,content:X.content,thinking:X.thinking}:K))}}}finally{H(!1),je.current=null}},Mt=(s,$)=>{const S=q[s]||[];if(S.length===0)return;const w=V[s]??S.length-1;let y=w;if($==="prev"?y=Math.max(0,w-1):y=Math.min(S.length-1,w+1),y===w)return;Q(U=>({...U,[s]:y}));const P=S[y];P&&b(U=>U.map(X=>X.id===s?{...X,content:P.content,thinking:P.thinking}:X))},At=s=>{let $="";typeof s=="string"?$=s:Array.isArray(s)&&($=s.find(P=>P.type==="text")?.text||"");const S=$.match(/^(.+?)\n\nContext from PDF:\s*(.+)$/s);if(S)return{mainQuestion:S[1].trim(),pdfContext:S[2].trim()};const w=$.match(/^Tell me about this:\s*(.+)$/s);return w?{mainQuestion:"",pdfContext:w[1].trim()}:{mainQuestion:$.trim()}},Pt=()=>{const s=window.getSelection();if(!s||s.rangeCount===0)return null;const $=s.toString().trim();if(!$)return null;const w=s.getRangeAt(0).commonAncestorContainer;return(w.nodeType===Node.TEXT_NODE?w.parentElement?.closest(".message-assistant, .message-user"):w?.closest(".message-assistant, .message-user"))?$:null},Tt=()=>{be?(b([]),r(null),Ue(!1),Se.current&&(clearTimeout(Se.current),Se.current=null)):(Ue(!0),Se.current&&clearTimeout(Se.current),Se.current=setTimeout(()=>{Ue(!1),Se.current=null},3e3))};return e.jsxs("div",{className:"chatgpt-wrapper",children:[!x&&!g&&a==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!x&&g&&!v&&o&&a==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:d?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:s=>{s.preventDefault(),s.stopPropagation(),rt()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),a==="floating"&&e.jsxs("div",{className:`model-selector-bar ${f==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:yt,children:[e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(Ht,{mode:_,onModeChange:jt,disabled:o})}),De()&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:He,type:"file",accept:"image/*",multiple:!0,onChange:St,style:{display:"none"}}),e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),He.current?.click()},className:"image-upload-button",title:"Upload images",disabled:o,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]}),e.jsx("span",{className:"image-upload-text",children:"Image"})]})]})]}),e.jsxs("div",{className:"header-actions",children:[h.length>0&&e.jsxs("button",{onClick:Tt,className:`clear-button ${be?"confirming":""}`,title:be?"Click again to confirm":"Clear chat",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:be?"Confirm":"Clear"})]}),a==="floating"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:i,className:"layout-toggle-button",title:a==="floating"?"Switch to split layout":"Switch to floating layout","aria-label":a==="floating"?"Switch to split layout":"Switch to floating layout",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:a==="floating"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]}):e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})}),e.jsx("button",{onClick:()=>{j||me.current&&B(me.current.scrollTop),E(!j)},className:"collapse-button",title:j?"Expand chat":"Collapse chat","aria-label":j?"Expand chat":"Collapse chat",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{transform:j?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx("path",{d:"M18 15l-6-6-6 6"})})})]})]})]}),e.jsxs("div",{ref:lt,className:`chatgpt-inner ${f==="dark"?"theme-dark":"theme-light"} ${j&&a==="floating"?"collapsed":""}`,style:{...kt?{maxHeight:`${kt}px`}:a==="floating"&&!j&&wt?{maxHeight:`${wt}px`}:{}},children:[n&&e.jsxs("div",{className:"selected-text-banner",children:[e.jsxs("span",{className:"banner-text",children:["Selected Text: ",n.length>20?`${n.substring(0,20)}...`:n]}),e.jsxs("div",{className:"banner-buttons",children:[e.jsx("button",{onClick:rn,className:"use-text-button",children:"Tell me more"}),m&&e.jsx("button",{onClick:m,className:"close-text-button",title:"Clear selection",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(!j||a==="split")&&e.jsxs("div",{ref:me,className:"chatgpt-messages",children:[h.length===0&&e.jsxs("div",{className:"welcome-screen",children:[e.jsx("div",{className:"welcome-icon",children:e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z",fill:"#10a37f",opacity:"0.1"}),e.jsx("path",{d:"M6 9H18M6 13H14",stroke:"#10a37f",strokeWidth:"2",strokeLinecap:"round"})]})}),e.jsx("h3",{children:"How can I help you today?"}),e.jsx("p",{children:"Ask me anything about your PDF, or select text to get context-specific answers."})]}),h.map((s,$)=>{const S=s.role==="assistant"&&$===h.length-1;return e.jsxs("div",{className:`message ${s.role==="user"?"message-user":"message-assistant"}`,children:[e.jsx("div",{className:"message-avatar",children:s.role==="user"?e.jsx("div",{className:"avatar-user",children:d?.picture?e.jsx("img",{src:d.picture,alt:d.name||d.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:w=>{const y=w.target;y.style.display="none";const P=y.parentElement;if(P){const U=P.querySelector("span.avatar-fallback");U&&U.remove();const X=document.createElement("span");X.className="avatar-fallback",X.textContent=d.name?.[0]?.toUpperCase()||d.email[0].toUpperCase(),P.appendChild(X)}}}):e.jsx("span",{className:"avatar-fallback",children:d?.name?.[0]?.toUpperCase()||d?.email?.[0]?.toUpperCase()||"U"})}):e.jsx("div",{className:"avatar-assistant",children:e.jsx("img",{src:"/chatnote-icon.svg",alt:"ChatNote",className:"assistant-avatar-img",onError:w=>{const y=w.target;y.style.display="none";const P=y.parentElement;if(P){const U=P.querySelector("svg.avatar-fallback-svg");U&&U.remove();const X=document.createElementNS("http://www.w3.org/2000/svg","svg");X.setAttribute("width","32"),X.setAttribute("height","32"),X.setAttribute("viewBox","0 0 24 24"),X.setAttribute("fill","none"),X.setAttribute("class","avatar-fallback-svg");const pe=document.createElementNS("http://www.w3.org/2000/svg","path");pe.setAttribute("d","M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"),pe.setAttribute("fill","currentColor"),X.appendChild(pe),P.appendChild(X)}}})})}),e.jsxs("div",{className:"message-content-wrapper",children:[e.jsx("div",{className:"message-content",children:s.role==="assistant"&&A&&!s.content&&S?e.jsxs("div",{className:"typing-indicator",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]}):s.role==="assistant"&&s.content?e.jsxs(e.Fragment,{children:[(_==="reasoning"||_==="advanced")&&s.thinking&&s.thinking.trim().length>0?e.jsxs("div",{className:"thinking-process-container",children:[e.jsxs("button",{className:`thinking-toggle-button ${M[s.id]?"expanded":""}`,onClick:()=>{I(w=>({...w,[s.id]:!(w[s.id]??!1)}))},title:M[s.id]?"Collapse thinking":"Expand thinking",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:M[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Thinking Process"}),A&&S&&!M[s.id]&&e.jsx("span",{style:{marginLeft:"8px",fontSize:"12px",opacity:.7},children:"(generating...)"})]}),M[s.id]&&s.thinking?e.jsxs("div",{className:"thinking-content expanded",children:[e.jsx("div",{className:"markdown-content",children:e.jsx(_t,{remarkPlugins:[Ot,Dt],rehypePlugins:[[Rt,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],children:(()=>{try{const w=Ut(s.thinking||"");return w.includes("â€‘")?w.replace(/\u2011/g,"-"):w||""}catch(w){return console.error("Error preprocessing thinking content:",w),(s.thinking||"").replace(/\u2011/g,"-")}})()})}),A&&S&&e.jsxs("div",{className:"typing-indicator",style:{marginTop:"12px"},children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})]}):null]}):null,s.content&&(typeof s.content!="string"||s.content.trim().length>0)?e.jsx("div",{className:"markdown-content",children:e.jsx(_t,{remarkPlugins:[Ot,Dt],rehypePlugins:[[Rt,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],components:{table:({children:w,...y})=>e.jsx("div",{className:"table-scroll-wrapper",children:e.jsx("table",{...y,children:w})}),div:({children:w,className:y,...P})=>y&&typeof y=="string"&&y.includes("katex-display")&&!y.includes("math-scroll-wrapper")?e.jsx("div",{className:"math-scroll-wrapper",children:e.jsx("div",{className:y,...P,children:w})}):e.jsx("div",{...P,className:y,children:w}),pre:({children:w,...y})=>e.jsx("pre",{className:"code-scroll-wrapper",...y,children:w})},children:(()=>{try{if(typeof s.content=="string"&&s.content){const w=Ut(s.content);return w.includes("â€‘")?w.replace(/\u2011/g,"-"):w||""}return""}catch(w){return console.error("Error preprocessing message content:",w),(typeof s.content=="string"?s.content:"").replace(/\u2011/g,"-")}})()})}):null]}):s.role==="user"?e.jsx("div",{className:"user-message-content",children:Array.isArray(s.content)?e.jsx(e.Fragment,{children:(()=>{const w=Gt(s.content),y=w.filter(K=>K.type==="text"),P=w.filter(K=>K.type==="image_url"),U=ke[s.id]||{canScrollLeft:!1,canScrollRight:!1},X=y.map(K=>K.text||"").join(`
`),pe=At(X);return e.jsxs(e.Fragment,{children:[pe.mainQuestion&&e.jsx("div",{className:"message-text",children:pe.mainQuestion}),pe.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${z[s.id]?"expanded":""}`,onClick:()=>{F(K=>({...K,[s.id]:!(K[s.id]??!1)}))},title:z[s.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:z[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),z[s.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:pe.pdfContext})})]}),!pe.mainQuestion&&!pe.pdfContext&&y.map((K,ue)=>e.jsx("div",{className:"message-text",children:K.text},`text-${ue}`)),P.length>0&&e.jsxs(e.Fragment,{children:[P.map((K,ue)=>{const ge=K.image_url?.url;if(!ge)return null;const oe=`${s.id}-${ue}`;return te===oe?e.jsx("div",{className:"message-image-enlarged-container",children:e.jsx("div",{className:"message-image enlarged",children:e.jsx("div",{className:"message-image-wrapper",children:e.jsx("img",{src:ge,alt:"Uploaded",onClick:Ne=>{Ne.stopPropagation(),ae(null)}})})})},`enlarged-${ue}`):null}),e.jsxs("div",{className:"message-images-wrapper",children:[U.canScrollLeft&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-left",onClick:()=>Nt(s.id,"left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:K=>{Ae.current[s.id]=K,K&&setTimeout(()=>it(s.id),0)},className:"message-images-container",onScroll:()=>it(s.id),children:P.map((K,ue)=>{const ge=K.image_url?.url;if(!ge)return null;const oe=`${s.id}-${ue}`;return te===oe?null:e.jsx("div",{className:"message-image-item",children:e.jsx("div",{className:"message-image",children:e.jsxs("div",{className:"message-image-wrapper",children:[e.jsx("img",{src:ge,alt:"Uploaded",onClick:Ne=>{Ne.stopPropagation(),ae(oe)}}),e.jsx("div",{className:"image-magnifier",onClick:Ne=>{Ne.stopPropagation(),ae(oe)},title:"Click to enlarge",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"}),e.jsx("circle",{cx:"11",cy:"11",r:"3"})]})})]})})},ue)})}),U.canScrollRight&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-right",onClick:()=>Nt(s.id,"right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]})]})]})})()}):(()=>{const w=typeof s.content=="string"?Gt(s.content):"",y=At(w);return e.jsxs(e.Fragment,{children:[y.mainQuestion&&e.jsx("div",{className:"message-text",children:y.mainQuestion}),y.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${z[s.id]?"expanded":""}`,onClick:()=>{F(P=>({...P,[s.id]:!(P[s.id]??!1)}))},title:z[s.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:z[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),z[s.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:y.pdfContext})})]}),!y.mainQuestion&&!y.pdfContext&&e.jsx("div",{className:"message-text",children:w})]})})()}):e.jsx("div",{className:"markdown-content",children:typeof s.content=="string"?s.content:""})}),s.role==="assistant"&&s.content&&e.jsxs("div",{className:"message-actions",children:[e.jsxs("button",{className:"message-action-button copy-button",onClick:async()=>{try{const w=typeof s.content=="string"?s.content:Array.isArray(s.content)?s.content.filter(y=>y.type==="text").map(y=>y.text).join(`
`):"";await navigator.clipboard.writeText(w)}catch(w){console.error("Failed to copy:",w)}},title:"Copy to clipboard",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),e.jsx("span",{className:"message-action-button-text",children:"Copy"})]}),t&&t.trim().length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"message-action-button knowledge-note-button",onClick:()=>{if(k){const w=Pt();let y="";w?y=w:y=typeof s.content=="string"?s.content:Array.isArray(s.content)?s.content.filter(U=>U.type==="text").map(U=>U.text).join(`
`):"";const P=s.selectedTextAtSend||n||void 0;k(y,P,l,s.id),N&&N()}},title:"Create knowledge note",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),e.jsx("span",{className:"message-action-button-text",children:"Save Note"})]}),e.jsxs("button",{className:"message-action-button add-to-pdf-button",onClick:()=>{if(C){const w=Pt();let y="";if(w)y=w;else if(typeof s.content=="string"){const{mainContent:X}=Qe(s.content);y=X}else if(Array.isArray(s.content)){const X=s.content.filter(K=>K.type==="text").map(K=>K.text).join(`
`),{mainContent:pe}=Qe(X);y=pe}const P=l||1,U=window.__lastSelectedTextPosition?.textYPosition;y.trim()&&(C(y,P,U),a==="floating"&&(me.current&&B(me.current.scrollTop),E(!0)))}},title:"Add response to PDF as text box",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Add to PDF"})]})]}),e.jsxs("button",{className:"message-action-button refresh-button",onClick:()=>an(s.id),title:"Get a new response",disabled:A,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Redo"})]}),q[s.id]&&q[s.id].length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"message-action-button nav-button-left",onClick:()=>Mt(s.id,"prev"),title:"Previous response",disabled:!V[s.id]||V[s.id]===0,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("button",{className:"message-action-button nav-button-right",onClick:()=>Mt(s.id,"next"),title:"Next response",disabled:(()=>{const w=q[s.id]||[];return w.length===0?!0:(V[s.id]??w.length-1)>=w.length-1})(),children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})}),e.jsxs("span",{className:"response-counter",children:[(V[s.id]??q[s.id].length-1)+1," / ",q[s.id].length]})]})]})]})]},s.id)}),ee&&e.jsxs("div",{className:"error-message",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("div",{className:"error-text",children:ee})]}),e.jsx("div",{ref:Te})]}),!x&&!g&&a==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!x&&g&&!v&&o&&a==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:d?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:s=>{s.preventDefault(),s.stopPropagation(),rt()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),a==="split"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:`model-selector-bar ${f==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:yt,children:[e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(Ht,{mode:_,onModeChange:jt,disabled:o||!g})}),De()&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:He,type:"file",accept:"image/*",multiple:!0,onChange:St,style:{display:"none"}}),e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),He.current?.click()},className:"image-upload-button",title:"Upload images",disabled:o||!g,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]}),e.jsx("span",{className:"image-upload-text",children:"Image"})]})]})]}),h.length>0&&e.jsxs("button",{onClick:Tt,className:`clear-button ${be?"confirming":""}`,title:be?"Click again to confirm":"Clear chat",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:be?"Confirm":"Clear"})]}),e.jsx("button",{onClick:i,className:"layout-toggle-button",title:"Switch to floating layout","aria-label":"Switch to floating layout",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]})})]})}),e.jsxs("div",{className:"chatgpt-input-container",onDragOver:en,onDragLeave:tn,onDrop:nn,children:[L.length>0&&e.jsxs("div",{className:"uploaded-images-preview-wrapper",children:[Ce&&e.jsx("button",{className:"image-scroll-button image-scroll-left",onClick:()=>$t("left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:Ve,className:"uploaded-images-preview",onScroll:Ke,children:L.map((s,$)=>e.jsxs("div",{className:"image-preview-item",children:[e.jsx("img",{src:s,alt:`Upload ${$+1}`}),e.jsx("button",{type:"button",className:"image-preview-remove",onClick:()=>{G(S=>S.filter((w,y)=>y!==$))},title:"Remove image",children:"Ã—"})]},$))}),Ee&&e.jsx("button",{className:"image-scroll-button image-scroll-right",onClick:()=>$t("right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),e.jsxs("div",{className:`input-wrapper ${ye&&De()?"drag-over":""}`,children:[e.jsx("textarea",{ref:_e,value:J,onChange:s=>W(s.target.value),onKeyPress:on,placeholder:"Ask a question...",rows:1,className:"chatgpt-input",disabled:A||o||!g}),A?e.jsx("button",{onClick:sn,className:"send-button pause-button",title:"Pause/Stop response",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"}),e.jsx("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"})]})}):e.jsx("button",{onClick:Et,disabled:!J.trim()&&!n&&L.length===0||o||!g,className:"send-button",title:"Send message",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})]}),a==="split"&&e.jsx("div",{className:`footer-text-outer split-footer ${f==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})}),a==="floating"&&e.jsx("div",{className:`footer-text-outer ${f==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})})]})]})}class On extends u.Component{constructor(t){super(t),this.state={hasError:!1,error:null}}static getDerivedStateFromError(t){return{hasError:!0,error:t}}render(){return this.state.hasError?this.props.fallback||e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#666",height:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{maxWidth:"400px"},children:[e.jsx("h3",{style:{marginBottom:"10px"},children:"PDF Viewer Temporarily Unavailable"}),e.jsx("p",{style:{marginBottom:"20px"},children:"There's a configuration issue with the PDF viewer. The rest of the app is working fine!"}),e.jsxs("p",{style:{fontSize:"12px",color:"#999",marginBottom:"20px"},children:["Error: ",this.state.error?.message||"Unknown error"]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("label",{htmlFor:"pdf-upload-fallback",style:{padding:"12px 24px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"6px",fontSize:"16px",fontWeight:"500",cursor:"pointer",display:"inline-block"},children:"Upload PDF (Basic)"}),e.jsx("input",{id:"pdf-upload-fallback",type:"file",accept:"application/pdf",onChange:t=>{const i=t.target.files?.[0];i&&alert(`PDF "${i.name}" selected. PDF viewing will work once the configuration issue is resolved.`)},style:{display:"none"}})]}),e.jsx("button",{onClick:()=>this.setState({hasError:!1,error:null}),style:{marginTop:"15px",padding:"8px 16px",backgroundColor:"#6c757d",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Try Again"})]})}):this.props.children}}const Dn=({notes:n,onDeleteNote:t,onClearAllNotes:i,onScrollToPage:a,onHighlightText:l,layout:k,theme:m,onNoteClick:C,isVisible:N=!0,onClose:f,pdfContentRef:g})=>{const[d,x]=u.useState(new Set),h=u.useRef(null),[b,M]=u.useState(0),[I,z]=u.useState(new Map),[F,q]=u.useState("following"),[D,V]=u.useState(!1),[Q,J]=u.useState(null),[W,A]=u.useState(null);u.useEffect(()=>{if(!D)return;const c=j=>{j.key==="Escape"&&(V(!1),J(null))};return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[D]);const H=u.useCallback((c,j)=>{j.preventDefault(),j.stopPropagation(),x(E=>{const Z=new Set(E);return Z.has(c)?Z.delete(c):Z.add(c),Z})},[]);u.useEffect(()=>{const c=()=>g?.current?g.current:window.__pdfContentRef||null,j=()=>{const B=c();if(B&&h.current){const _=B.scrollHeight;if(M(_),F==="following"?h.current.style.height=`${_}px`:h.current.style.height="auto",F==="following"){const O=B.scrollTop;h.current.style.transform=`translateY(-${O}px)`}else h.current.style.transform="none"}};j();const E=c();if(E){const B=()=>{if(h.current&&F==="following"){const te=E.scrollTop;h.current.style.transform=`translateY(-${te}px)`}else h.current&&F==="stack"&&(h.current.style.transform="none")};E.addEventListener("scroll",B,{passive:!0});const _=new ResizeObserver(()=>{j()});_.observe(E);const O=setInterval(j,1e3);return()=>{clearInterval(O),E.removeEventListener("scroll",B),_.disconnect()}}const Z=setTimeout(j,100);return()=>clearTimeout(Z)},[g,N,n.length,F]);const ee=c=>{c.pageNumber&&a?(a(c.pageNumber),setTimeout(()=>{c.linkedText&&l&&l(c.linkedText)},500)):c.linkedText&&l&&l(c.linkedText)},r=c=>{const j=new Date(c);return j.toLocaleDateString()+" "+j.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},o=u.useCallback(()=>{const c=g?.current||window.__pdfContentRef;if(!c)return;const j=new Map;n.forEach(E=>{if(!E.pageNumber||E.textYPosition===void 0)return;const Z=c.querySelectorAll(".pdf-page-wrapper");if(Z.length<E.pageNumber){const L=c.querySelectorAll(".react-pdf__Page");if(L.length<E.pageNumber)return;const G=L[E.pageNumber-1];if(!G)return;const ye=G.offsetTop,we=G.offsetHeight,Ce=ye+E.textYPosition*we;j.set(E.id,Ce);return}const B=Z[E.pageNumber-1];if(!B)return;const _=B.offsetTop,O=B.offsetHeight,te=E.textYPosition*O,ae=_+te;j.set(E.id,ae)}),z(j)},[n,g]);u.useEffect(()=>{o();const c=g?.current||window.__pdfContentRef;if(c){const j=new ResizeObserver(()=>{o()});j.observe(c);const E=setInterval(o,500);return()=>{j.disconnect(),clearInterval(E)}}},[o,g,N]),u.useEffect(()=>{if(b>0){const c=setTimeout(()=>{o()},200);return()=>clearTimeout(c)}},[b,o]),u.useEffect(()=>{if(n.length===0){A(null);return}const c=n.some(j=>j.id===W);W&&!c&&A(null)},[n,W]);const p=c=>I.get(c.id),v=(c,j)=>{const E=p(c);if(E===void 0)return{stackIndex:0,stackSize:1,basePosition:0,displayIndex:0};const Z=10,B=j.filter(L=>{const G=p(L);return G!==void 0&&Math.abs(G-E)<Z}).sort((L,G)=>L.createdAt-G.createdAt),_=B.findIndex(L=>L.id===c.id),O=B.length,te=Math.min(...B.map(L=>p(L)||0));let ae=_;if(O>1&&W){const L=B.findIndex(G=>G.id===W);if(L!==-1){const G=B.filter((ye,we)=>we>_).length;if(_>L)ae=O-1-G;else{const ye=(_-L+O)%O,we=B.filter((Ce,re)=>re>L).length;ae=Math.min(ye,O-1-we)}}}else O>1&&(ae=_);return{stackIndex:_,stackSize:O,basePosition:te,displayIndex:ae}};return e.jsxs("div",{className:`knowledge-notes-panel ${k}-layout theme-${m} ${N?"knowledge-notes-visible":""}`,children:[e.jsxs("div",{className:"knowledge-notes-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h3",{children:"Knowledge Notes"}),e.jsx("button",{className:"display-mode-toggle",onClick:()=>q(F==="following"?"stack":"following"),title:F==="following"?"Switch to stack mode":"Switch to following mode",style:{background:"transparent",border:"1px solid rgba(0, 0, 0, 0.2)",borderRadius:"4px",padding:"4px 8px",cursor:"pointer",fontSize:"12px",color:"inherit",display:"flex",alignItems:"center",gap:"4px"},children:F==="following"?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]}),"Following"]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),"Stack"]})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxs("button",{className:"notes-count-button",onClick:c=>{c.preventDefault(),c.stopPropagation(),n.length>0&&(J(null),V(!0))},title:n.length>0?"Clear all notes":"No notes to clear",disabled:n.length===0,children:[e.jsx("span",{className:"notes-count-text",children:n.length}),e.jsxs("svg",{className:"notes-count-clear-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})]}),e.jsx("button",{className:"knowledge-notes-close",onClick:c=>{c.stopPropagation(),f?.()},"aria-label":"Close knowledge notes",style:{display:"flex",alignItems:"center",justifyContent:"center",background:"transparent",border:"none",cursor:"pointer",padding:"4px",width:"32px",height:"32px",borderRadius:"6px",transition:"background 0.2s, color 0.2s"},children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx("div",{className:`knowledge-notes-list ${F==="stack"?"stack-mode":"following-mode"}`,ref:h,style:{height:F==="following"&&b>0?`${b}px`:"auto",overflow:F==="stack"?"auto":"visible"},children:n.length===0?e.jsx("div",{className:"empty-notes",children:"No knowledge notes yet"}):n.map(c=>{const j=d.has(c.id),E=p(c),B=(c.content?c.content.split(`
`):[]).length>3||c.content&&c.content.length>200,_=W===c.id,O=v(c,n),te=8,ae=1.5,L=2,G=O.displayIndex*te,ye=O.displayIndex*L,we=O.stackSize-1,Ce=O.stackIndex===O.stackSize-1,re=we*ae,Ee=Ce?re:O.displayIndex*ae,Me=E!==void 0?O.displayIndex===0?E:E+G:void 0,ke=O.displayIndex===0?0:Ee,Ge=O.displayIndex===0?0:ye;return e.jsxs("div",{className:`knowledge-note-item ${_?"note-front":""} ${O.stackSize>1?"note-stacked":""}`,onClick:be=>{const Ue=be.target;if(!(Ue.closest("button")||Ue.closest(".note-linked-text")))if(F==="following"&&O.stackSize>1)if(W!==c.id)A(c.id);else{const Se=n.filter(Ae=>{const Te=p(Ae),_e=p(c);return Te!==void 0&&_e!==void 0&&Math.abs(Te-_e)<10}).sort((Ae,Te)=>Ae.createdAt-Te.createdAt),Ve=(Se.findIndex(Ae=>Ae.id===c.id)+1)%Se.length;A(Se[Ve].id)}else F==="following"&&A(c.id)},style:F==="following"&&Me!==void 0?{position:"absolute",top:`${Me}px`,left:`${8+Ge}px`,right:`${8-Ge}px`,width:"auto",zIndex:O.displayIndex===0?20+O.stackSize:10+O.displayIndex,pointerEvents:"auto",transform:`rotate(${ke}deg)`,transformOrigin:"center top",transition:"transform 0.3s ease, z-index 0.2s ease, top 0.3s ease, left 0.3s ease, right 0.3s ease",boxShadow:O.displayIndex===0?"0 4px 16px rgba(0, 0, 0, 0.15)":`0 ${2+O.displayIndex}px ${8+O.displayIndex*2}px rgba(0, 0, 0, ${.1+O.displayIndex*.02})`}:{position:"relative",marginBottom:"12px",marginLeft:"8px",marginRight:"8px",width:"auto"},children:[e.jsxs("div",{className:"note-header",children:[e.jsxs("div",{className:"note-meta",children:[c.pageNumber&&e.jsxs("span",{className:"note-page-badge",children:["Page ",c.pageNumber]}),c.linkedText&&e.jsx("span",{className:"note-text-badge",children:"Linked Text"}),e.jsx("span",{className:"note-date",children:r(c.createdAt)})]}),e.jsx("button",{className:"note-delete-button",onClick:be=>{be.stopPropagation(),J(c.id),V(!0)},title:"Delete note",children:"Ã—"})]}),c.linkedText&&e.jsxs("div",{className:"note-linked-text",onClick:()=>{ee(c),C?.(c)},children:['"',c.linkedText.substring(0,100),c.linkedText.length>100?"...":"",'"']}),e.jsxs("div",{className:"note-content-wrapper",children:[e.jsx("div",{className:`note-content ${j?"expanded":"collapsed"}`,children:c.content}),B&&e.jsx("button",{className:"note-expand-button",onClick:be=>{be.preventDefault(),be.stopPropagation(),H(c.id,be)},onMouseDown:be=>{be.stopPropagation()},title:j?"Collapse":"Expand",type:"button",children:j?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}),e.jsx("span",{children:"Show Less"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{children:"Show More"})]})})]})]},c.id)})}),D&&e.jsx("div",{className:"confirm-dialog-overlay",onClick:()=>{V(!1),J(null)},children:e.jsxs("div",{className:"confirm-dialog",onClick:c=>c.stopPropagation(),children:[e.jsx("div",{className:"confirm-dialog-header",children:e.jsx("h3",{children:Q?"Delete Note":"Clear All Notes"})}),e.jsx("div",{className:"confirm-dialog-content",children:Q?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"Are you sure you want to delete this knowledge note?"}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Are you sure you want to delete all ",e.jsx("strong",{children:n.length})," knowledge note",n.length===1?"":"s","?"]}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]})}),e.jsxs("div",{className:"confirm-dialog-actions",children:[e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-cancel",onClick:()=>{V(!1),J(null)},children:"Cancel"}),e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-confirm",onClick:()=>{Q?(t(Q),J(null)):i&&i(),V(!1)},children:Q?"Delete":"Clear All"})]})]})})]})};let Re;async function Fn(){if(!Re){if(typeof window<"u"&&window.pdfjsLib)Re=window.pdfjsLib;else{const n=await st(()=>import("./vendor-pdf-DDxsMbbh.js").then(t=>t.p),[]);Re=n.default||n}if(typeof window<"u"&&Re&&!Re.GlobalWorkerOptions?.workerSrc){let n;{const t="/ChatNote/";n=`${t.endsWith("/")?t:`${t}/`}pdf.worker.min.js`}Re.GlobalWorkerOptions?Re.GlobalWorkerOptions.workerSrc=n:Re.GlobalWorkerOptions={workerSrc:n}}}return Re}async function Wn(n){try{const t=await Fn(),i=await n.arrayBuffer(),l=await t.getDocument({data:i}).promise,k=l.numPages,m=[];for(let f=1;f<=k;f++){const x=(await(await l.getPage(f)).getTextContent()).items.map(h=>h.str).join(" ");m.push(Promise.resolve(x))}return(await Promise.all(m)).map((f,g)=>`--- Page ${g+1} ---
${f}`).join(`

`)}catch(t){throw console.error("Error extracting text from PDF:",t),new Error("Failed to extract text from PDF. The PDF may be corrupted or password-protected.")}}const Bn=["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#FFC0CB"],zn=u.lazy(()=>st(()=>import("./PDFViewer-DaIYnRm-.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function Hn(){const{theme:n}=mt(),{isChatVisible:t}=Xt(),[i,a]=u.useState(null),[l,k]=u.useState(""),[m,C]=u.useState(""),[N,f]=u.useState("floating"),[g,d]=u.useState(1),[x,h]=u.useState([]),[b,M]=u.useState(!1),[I,z]=u.useState(null),F=async A=>{a(A);try{const H=await Wn(A);if(k(H),H&&H.trim().length>0)try{const{indexPDF:ee}=await st(async()=>{const{indexPDF:r}=await import("./pdfRAG-BUQZRmsO.js");return{indexPDF:r}},[]);await ee(H)}catch(ee){console.warn("[RAG] Failed to index PDF, will use keyword search:",ee)}}catch(H){console.error("Failed to extract PDF text:",H),k("")}};u.useEffect(()=>{i||(k(""),st(async()=>{const{clearPDFIndices:A}=await import("./pdfRAG-BUQZRmsO.js");return{clearPDFIndices:A}},[]).then(({clearPDFIndices:A})=>{A()}).catch(()=>{}))},[i]),u.useEffect(()=>{const A=H=>{if(i)return H.preventDefault(),H.returnValue="",""};return window.addEventListener("beforeunload",A),()=>{window.removeEventListener("beforeunload",A)}},[i]);const q=(A,H,ee)=>{C(A),A&&H!==void 0&&ee!==void 0&&(z({text:A,pageNumber:H,textYPosition:ee}),window.__lastSelectedTextPosition={text:A,pageNumber:H,textYPosition:ee})},D=()=>{f(A=>A==="floating"?"split":"floating")},V=(A,H,ee,r)=>{const o=ee||I?.pageNumber||g,p=I?.textYPosition,v={id:`note-${Date.now()}`,content:A,linkedText:H||I?.text,pageNumber:o,textYPosition:p,createdAt:Date.now(),messageId:r};h(c=>[...c,v])},Q=A=>{h(H=>H.filter(ee=>ee.id!==A))},J=()=>{h([])},W=A=>{d(A),window.__pdfScrollToPage&&window.__pdfScrollToPage(A)};return e.jsxs("div",{className:"app",children:[e.jsx(Sn,{}),e.jsxs("div",{className:`main-content ${N==="split"?"split-layout":""} ${b&&N==="floating"?"has-knowledge-notes":""}`,children:[e.jsx(On,{children:e.jsx(u.Suspense,{fallback:e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading PDF viewer..."}),children:e.jsx(zn,{file:i,onFileUpload:F,onTextSelection:q,layout:N,onPageChange:d,showKnowledgeNotes:b,onToggleKnowledgeNotes:()=>M(!b),knowledgeNotes:x,onScrollToPage:W,onNoteClick:A=>{A.pageNumber&&W(A.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0,onAddAnnotation:()=>{}})})}),b&&e.jsx(Dn,{notes:x,onDeleteNote:Q,onClearAllNotes:J,onScrollToPage:W,layout:N,theme:n,isVisible:b,onClose:()=>M(!1),onNoteClick:A=>{A.pageNumber&&W(A.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0}),t&&e.jsx("div",{className:`chat-container ${N==="floating"?"floating-chat":"split-chat"} ${b?"knowledge-notes-open":""}`,children:e.jsx(Rn,{selectedText:m,pdfText:l,onToggleLayout:D,layout:N,currentPageNumber:g,onCreateKnowledgeNote:V,onClearSelectedText:()=>C(""),onOpenKnowledgeNotes:()=>{b||M(!0)},onAddAnnotationToPDF:(A,H,ee)=>{if(window.__addPDFAnnotation){const o=ee!==void 0?ee:.5,p={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:H,x:Math.max(0,Math.min(1-.3,.4-.15)),y:Math.max(0,Math.min(1-.2,o-.1)),width:.3,height:.2,rotation:0,text:A,fontSize:14,color:Bn[0]};window.__addPDFAnnotation(p)}}})})]})]})}function qn(){return e.jsx(gn,{children:e.jsx(wn,{children:e.jsx(kn,{children:e.jsx(Hn,{})})})})}const pt=document.getElementById("root");if(!pt)throw new Error("Root element not found");try{ln.createRoot(pt).render(e.jsx(cn.StrictMode,{children:e.jsx(qn,{})}))}catch(n){pt.innerHTML=`
    <div style="padding: 20px; color: red;">
      <h1>Error Loading App</h1>
      <p>${n instanceof Error?n.message:String(n)}</p>
      <p>Check the browser console for more details.</p>
    </div>
  `}export{Bn as C,st as _};
