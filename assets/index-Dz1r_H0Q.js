const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PDFViewer-BH854lJo.js","assets/vendor-react-BWK-dEaB.js","assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css","assets/vendor-pdf-DDxsMbbh.js","assets/vendor-react-CBXYWCWZ.css","assets/PDFViewer-DlkHv-wn.css"])))=>i.map(i=>d[i]);
import{r,j as e,M as st,R as ns,a as ss}from"./vendor-react-BWK-dEaB.js";import{p as os}from"./vendor-pdf-DDxsMbbh.js";import{k as ot,l as rt,n as it}from"./vendor-CLrFw-IM.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))a(l);new MutationObserver(l=>{for(const m of l)if(m.type==="childList")for(const h of m.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&a(h)}).observe(document,{childList:!0,subtree:!0});function o(l){const m={};return l.integrity&&(m.integrity=l.integrity),l.referrerPolicy&&(m.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?m.credentials="include":l.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function a(l){if(l.ep)return;l.ep=!0;const m=o(l);fetch(l.href,m)}})();if(typeof window<"u"){let t,n;{const l="/ChatNote/";t=`${l.endsWith("/")?l:`${l}/`}pdf.worker.min.js`,n="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/"}const o=l=>{try{if(l)if(!l.GlobalWorkerOptions)l.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:n};else try{l.GlobalWorkerOptions.workerSrc=t,l.GlobalWorkerOptions.standardFontDataUrl=n}catch{try{Object.defineProperty(l,"GlobalWorkerOptions",{value:{workerSrc:t,standardFontDataUrl:n},writable:!0,configurable:!0})}catch{}}}catch{}};window.pdfjsLib||(window.pdfjsLib={}),window.pdfjsLib.GlobalWorkerOptions?(window.pdfjsLib.GlobalWorkerOptions.workerSrc=t,window.pdfjsLib.GlobalWorkerOptions.standardFontDataUrl=n):window.pdfjsLib.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:n},typeof window.pdfjs>"u"&&(window.pdfjs={}),window.pdfjs.GlobalWorkerOptions?(window.pdfjs.GlobalWorkerOptions.workerSrc=t,window.pdfjs.GlobalWorkerOptions.standardFontDataUrl=n):window.pdfjs.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:n};const a=os;if(o(a),a.default&&o(a.default),a.GlobalWorkerOptions)try{a.GlobalWorkerOptions.workerSrc=t,a.GlobalWorkerOptions.standardFontDataUrl=n}catch{}}const rs="modulepreload",is=function(t){return"/ChatNote/"+t},vn={},Et=function(n,o,a){let l=Promise.resolve();if(o&&o.length>0){let N=function(g){return Promise.all(g.map(d=>Promise.resolve(d).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const h=document.querySelector("meta[property=csp-nonce]"),j=h?.nonce||h?.getAttribute("nonce");l=N(o.map(g=>{if(g=is(g),g in vn)return;vn[g]=!0;const d=g.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${g}"]${u}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":rs,d||(p.as="script"),p.crossOrigin="",p.href=g,j&&p.setAttribute("nonce",j),document.head.appendChild(p),d)return new Promise((f,P)=>{p.addEventListener("load",f),p.addEventListener("error",()=>P(new Error(`Unable to preload CSS for ${g}`)))})}))}function m(h){const j=new Event("vite:preloadError",{cancelable:!0});if(j.payload=h,window.dispatchEvent(j),!j.defaultPrevented)throw h}return l.then(h=>{for(const j of h||[])j.status==="rejected"&&m(j.reason);return n().catch(m)})},En=r.createContext(void 0);function as({children:t}){const[n,o]=r.useState(()=>localStorage.getItem("theme")||"light");r.useEffect(()=>{document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n)},[n]);const a=()=>{o(l=>l==="light"?"dark":"light")};return e.jsx(En.Provider,{value:{theme:n,toggleTheme:a},children:t})}function Vt(){const t=r.useContext(En);if(t===void 0)throw new Error("useTheme must be used within a ThemeProvider");return t}const xt=["meta-llama/llama-4-scout-17b-16e-instruct","meta-llama/llama-4-maverick-17b-128e-instruct","llama-3.3-70b-versatile"],yt=["openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-32b"],ls=["openai/gpt-oss-120b","openai/gpt-oss-20b"],cs=["qwen/qwen3-32b"];function ds(t){return ls.includes(t)}function us(t){return cs.includes(t)}const Rt={primary:"groq/compound",fallback:"groq/compound-mini"},hs=["moonshotai/kimi-k2-instruct-0905","openai/gpt-oss-safeguard-20b"],Ne="https://chatnote-backend-8pk3.onrender.com",jn="105659660993-u7lnrcbis23u3mlaigteag67d6h6inar.apps.googleusercontent.com";console.warn("Supabase environment variables not configured. Analytics tracking will be disabled.");class fs{sessionId;userId=null;currentDocumentId=null;noteModeStartTime=null;currentNoteMode=null;constructor(){const n=typeof window<"u"?sessionStorage.getItem("analytics_session_id"):null;if(n)this.sessionId=n;else{this.sessionId=this.generateSessionId();try{sessionStorage.setItem("analytics_session_id",this.sessionId)}catch{}}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}generateDocumentId(){return`doc_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}setUserId(n){this.userId=n,localStorage.setItem("analytics_user_id",n)}getUserId(){return this.userId||(this.userId=localStorage.getItem("analytics_user_id")),this.userId}setCurrentDocument(n){this.currentDocumentId=n}clearCurrentDocument(){this.currentDocumentId=null}getCurrentDocumentId(){return this.currentDocumentId}async trackEvent(n,o,a){{console.warn("[Analytics] Tracking disabled: Supabase not configured");return}}async trackPageView(){await this.trackEvent("page_viewed",{})}async resetAnalytics(){await this.endNoteModeTracking(),this.userId=null,this.currentDocumentId=null,this.noteModeStartTime=null,this.currentNoteMode=null;try{localStorage.removeItem("analytics_user_id")}catch{}}async trackQuerySubmitted(n,o,a){await this.trackEvent("query_submitted",{ai_mode:n,ui_mode:o,is_contextual:a})}async trackAIResponse(n,o){await this.trackEvent("ai_response_rendered",{ai_mode:n,response_time_ms:o})}async trackAIResultAction(n){await this.trackEvent("ai_result_action",{action_type:n})}async trackPDFUpload(n,o){await this.trackEvent("pdf_uploaded",{file_size_mb:n},o)}async trackAnnotationAdded(n){await this.trackEvent("annotation_added",{tool_name:n})}async trackPDFExport(n){await this.trackEvent("pdf_exported",{include_annotations:n})}async startNoteModeTracking(n){if(this.noteModeStartTime!==null&&this.currentNoteMode!==null&&this.currentNoteMode!==n){const o=Date.now()-this.noteModeStartTime;o>=100&&await this.trackEvent("note_mode_viewed",{view_mode:this.currentNoteMode,duration_ms:o}),this.noteModeStartTime=null,this.currentNoteMode=null}this.noteModeStartTime===null&&(this.noteModeStartTime=Date.now(),this.currentNoteMode=n)}async endNoteModeTracking(){if(this.noteModeStartTime===null||this.currentNoteMode===null)return;const n=Date.now()-this.noteModeStartTime;n>=100&&await this.trackEvent("note_mode_viewed",{view_mode:this.currentNoteMode,duration_ms:n}),this.noteModeStartTime=null,this.currentNoteMode=null}async trackError(n,o){await this.trackEvent("error_occurred",{error_type:n,error_message:o})}async upsertUser(n,o){}async createDocument(n,o){}async updateDocument(n,o){}}const he=new fs,In=r.createContext(void 0);function gs({children:t}){const[n,o]=r.useState(null),[a,l]=r.useState(!0);r.useEffect(()=>{const N=localStorage.getItem("auth_token");N?m(N):l(!1)},[]);const m=async(N,g=0)=>{let u=!1;try{const p=new AbortController,f=setTimeout(()=>p.abort(),1e4),P=await fetch(`${Ne}/api/auth/me`,{headers:{Authorization:`Bearer ${N}`},signal:p.signal});if(clearTimeout(f),P.ok){const b=await P.json();o(b.user),he.getUserId(),u=!0}else if(P.status===401||P.status===403)console.warn("Token invalid, logging out"),localStorage.removeItem("auth_token"),o(null),u=!0;else{if(g<2)return console.warn(`Failed to fetch user (${P.status}), retrying... (${g+1}/2)`),await new Promise(b=>setTimeout(b,1e3*(g+1))),m(N,g+1);console.error("Failed to fetch user after retries, but keeping token:",P.status),u=!0}}catch(p){if(g<2){const f=p instanceof Error?p.name:"Unknown";return console.warn(`Network error (${f}), retrying... (${g+1}/2)`),await new Promise(P=>setTimeout(P,1e3*(g+1))),m(N,g+1)}else p instanceof Error&&p.name==="AbortError"?console.warn("Request timeout after retries, but keeping user logged in"):console.error("Network error fetching user after retries, but keeping token:",p),u=!0}finally{u&&l(!1)}},h=async N=>{try{const g=await fetch(`${Ne}/api/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:N})});if(!g.ok){const u=await g.json();throw new Error(u.error||"Authentication failed")}const d=await g.json();localStorage.setItem("auth_token",d.token),o(d.user),d.user&&d.user.id&&(he.setUserId(d.user.id),await he.upsertUser(d.user.id,d.user.email),await he.trackPageView())}catch(g){throw console.error("Login error:",g),console.error("Failed URL:",`${Ne}/api/auth/google`),g}},j=async()=>{const N=localStorage.getItem("auth_token");if(N)try{await fetch(`${Ne}/api/drive/revoke`,{method:"POST",headers:{Authorization:`Bearer ${N}`}}).catch(()=>{})}catch(g){console.warn("Error revoking Drive access during logout:",g)}localStorage.removeItem("auth_token");try{localStorage.removeItem("chatnote_pdf_history_cache")}catch(g){console.warn("Failed to clear PDF history cache:",g)}await he.resetAnalytics(),o(null)};return e.jsx(In.Provider,{value:{user:n,loading:a,login:h,logout:j,isAuthenticated:!!n,isAdmin:n?.role==="admin"},children:t})}function It(){const t=r.useContext(In);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}const Tn=r.createContext(void 0);function ms({children:t}){const[n,o]=r.useState(()=>{const m=localStorage.getItem("chatVisible");return m!==null?m==="true":!0});r.useEffect(()=>{localStorage.setItem("chatVisible",String(n))},[n]);const a=()=>{o(m=>!m)},l=m=>{o(m)};return e.jsx(Tn.Provider,{value:{isChatVisible:n,toggleChatVisibility:a,setChatVisible:l},children:t})}function Ln(){const t=r.useContext(Tn);if(t===void 0)throw new Error("useChatVisibility must be used within a ChatVisibilityProvider");return t}const $n=r.createContext(void 0);function ps({children:t,hasUnsavedChanges:n,saveCurrentState:o,isSavingSession:a,setIsSavingSession:l}){return e.jsx($n.Provider,{value:{hasUnsavedChanges:n,saveCurrentState:o,isSavingSession:a,setIsSavingSession:l},children:t})}function xs(){const t=r.useContext($n);if(t===void 0)throw new Error("useSave must be used within a SaveProvider");return t}function Dn(){return localStorage.getItem("auth_token")}function ys(t){if(xt.includes(t)){const n=xt.indexOf(t);return xt.slice(n)}if(yt.includes(t)){const n=yt.indexOf(t);return yt.slice(n)}return t===Rt.primary?[Rt.primary,Rt.fallback]:[t]}function ws(t,n){if(n===429||n>=500&&n<600)return!0;const o=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return["rate limit","too many requests","service unavailable","internal server error","bad gateway","gateway timeout","timeout"].some(l=>o.toLowerCase().includes(l))}function kn(t,n){if(n===429)return"Rate limit reached. Please wait a moment and try again.";if(n===401)return"Authentication failed. Please log in again.";if(n===400){const a=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return a.includes("API key not configured")?"API key not configured. Please add your API key in settings.":a.includes("model")||a.includes("invalid")?"Invalid request. Please try again or select a different model.":"Invalid request. Please check your input and try again."}if(n===403)return"Access denied. Please check your API key permissions.";if(n===404)return"Model not found. Please select a different model.";if(n>=500&&n<600)return"Service temporarily unavailable. Please try again in a moment.";const o=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return console.error("API error details (not shown to user):",{status:n,message:o,error:t}),"An error occurred while processing your request. Please try again."}async function Ot(t,n,o,a,l,m){const h=Dn();if(!h)throw new Error("Authentication required. Please log in.");const j=a||xt[0],N=ys(j),g=m||!1;let d=null;for(const u of N)try{const p={messages:t,context:n,model:u,temperature:.7,maxTokens:3e3,stream:!!o};g&&yt.includes(u)&&(ds(u)?p.include_reasoning=!0:us(u)&&(p.reasoning_format="parsed"));let f;try{f=await fetch(`${Ne}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`},body:JSON.stringify(p),signal:l})}catch(_){throw _ instanceof DOMException&&_.name==="AbortError"?new DOMException("Request aborted by user","AbortError"):_}if(!f.ok){let _;try{const S=await f.text();try{_=JSON.parse(S)}catch{_={error:{message:S||"Unknown error"}}}}catch{_={error:{message:"Unknown error"}}}if(f.status===401)throw localStorage.removeItem("auth_token"),new Error("Session expired. Please log in again.");if(f.status===400&&_.error?.message?.includes("API key not configured"))throw new Error("API key not configured. Please add your Groq API key in settings.");const i=ws(_,f.status),c=N.length>1&&u!==N[N.length-1];if(i&&c){d=new Error(kn(_,f.status));continue}const y=kn(_,f.status);throw console.error("Backend error response (details logged, user sees sanitized message):",_),new Error(y)}if(o&&f.body){const _=f.body.getReader(),i=new TextDecoder;let c="",y="",S="";for(;;){if(l?.aborted)throw _.cancel(),new DOMException("Request aborted by user","AbortError");let L,B;try{const T=await _.read();L=T.done,B=T.value}catch(T){throw T instanceof DOMException&&T.name==="AbortError"?(_.cancel(),new DOMException("Request aborted by user","AbortError")):T}if(L)break;S+=i.decode(B,{stream:!0});const U=S.split(`
`);S=U.pop()||"";for(const T of U){const V=T.trim();if(V&&V.startsWith("data: ")){const H=V.slice(6);if(H==="[DONE]")continue;try{const ue=JSON.parse(H).choices?.[0]?.delta;ue?.content&&(c+=ue.content,o(ue.content)),ue?.reasoning&&(y+=ue.reasoning)}catch{}}}}if(S.trim()){const L=S.trim();if(L.startsWith("data: ")){const B=L.slice(6);if(B!=="[DONE]")try{const T=JSON.parse(B).choices?.[0]?.delta;T?.content&&(c+=T.content,o(T.content)),T?.reasoning&&(y+=T.reasoning)}catch{}}}return y?`__REASONING_START__${y}__REASONING_END__${c}`:c}const b=(await f.json()).choices[0]?.message;let R=b?.content||"No response from API";const F=b?.reasoning,x=b?.executed_tools;let v="";if(x&&x.length>0){const _=x.find(i=>i.search_results);if(_?.search_results?.results&&_.search_results.results.length>0){const i=_.search_results.results;v=`

---

## Sources

`,i.forEach((c,y)=>{v+=`${y+1}. [${c.title}](${c.url})
`})}}return v&&(R=R+v),F?`__REASONING_START__${F}__REASONING_END__${R}`:R}catch(p){if(u===N[N.length-1])throw p instanceof DOMException&&p.name==="AbortError"?p:d||(console.error("Chat service error:",p),p);d=p instanceof Error?p:new Error(String(p))}throw d||new Error("Unable to process your request. Please try again later.")}async function _n(){const t=Dn();if(!t)return!1;try{const n=await fetch(`${Ne}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){const o=await n.json();return o.hasApiKey||o.isAdmin}if(n.status===429)throw new Error("Rate limited");return!1}catch(n){if(n instanceof Error&&n.message==="Rate limited")throw n;return!1}}function vs(){const{user:t,login:n,logout:o,loading:a}=It(),{hasUnsavedChanges:l,saveCurrentState:m,setIsSavingSession:h}=xs(),[j,N]=r.useState(!1),[g,d]=r.useState(null),[u,p]=r.useState(!1),f=async()=>{if(l)if(window.confirm("You have unsaved changes to your PDF annotations and notes. Would you like to save them before logging out?")){p(!0),h(!0);try{await m(),await o()}catch(x){console.error("Error saving or logging out:",x)}finally{p(!1),h(!1)}}else await o();else window.confirm("Are you sure you want to log out?")&&await o()};r.useEffect(()=>{const F=console.error,x=console.warn;console.error=(..._)=>{const i=_.join(" ");i.includes("Not signed in with the identity provider")||i.includes("AbortError")||i.includes("signal is aborted")||i.includes("FedCM get() rejects")||i.includes("GSI_LOGGER")||i.includes("The given origin is not allowed")||i.includes("ERR_BLOCKED_BY_CLIENT")||i.includes("Cross-Origin-Opener-Policy")||i.includes("Only one navigator.credentials.get request may be outstanding")||F.apply(console,_)},console.warn=(..._)=>{const i=_.join(" ");i.includes("GSI_LOGGER")||i.includes("The given origin is not allowed")||i.includes("Not signed in with the identity provider")||i.includes("Only one navigator.credentials.get request may be outstanding")||x.apply(console,_)};const v=window.onerror;return window.onerror=(_,i,c,y,S)=>typeof _=="string"&&(_.includes("Not signed in with the identity provider")||_.includes("Only one navigator.credentials.get request may be outstanding")||_.includes("AbortError")||_.includes("The given origin is not allowed")||i?.includes("accounts.google.com"))?!0:v?v(_,i,c,y,S):!1,()=>{console.error=F,console.warn=x,window.onerror=v}},[]);const P=r.useCallback(async F=>{try{await n(F.credential);const x=document.getElementById("google-signin-button");x&&x.remove()}catch(x){console.error("Login failed:",x),alert(x instanceof Error?x.message:"Login failed. Please try again.")}},[n]);r.useEffect(()=>{if(t)return;if(window.google){try{window.google.accounts.id.initialize({client_id:jn,callback:P}),N(!0)}catch(v){console.error("Failed to initialize Google OAuth:",v),d("Failed to initialize Google OAuth")}return}const F=document.createElement("script");F.src="https://accounts.google.com/gsi/client",F.async=!0,F.defer=!0,F.onload=()=>{if(window.google)try{window.google.accounts.id.initialize({client_id:jn,callback:P,use_fedcm_for_prompt:!0}),N(!0),d(null)}catch(v){console.error("Failed to initialize Google OAuth:",v),d("Failed to initialize Google OAuth")}else console.error("Google script loaded but window.google is not available"),d("Google script failed to load")},F.onerror=v=>{console.error("Failed to load Google Identity Services script:",v),d("Failed to load Google Sign-In script. Please check your internet connection and try again."),N(!1)};const x=setTimeout(()=>{!window.google&&!g&&(console.error("Google script loading timeout"),d("Google Sign-In is taking too long to load. Please check your internet connection or try again later."),N(!1))},15e3);return document.head.appendChild(F),()=>{clearTimeout(x)}},[P,t]),r.useEffect(()=>{if(t){const F=document.getElementById("google-login-backdrop"),x=document.getElementById("google-signin-button");F&&F.remove(),x&&x.remove()}},[t]);const b=()=>{const F=document.getElementById("google-login-backdrop"),x=document.getElementById("google-signin-button");F&&F.remove(),x&&x.remove();const v=document.createElement("div");v.id="google-login-backdrop",v.style.position="fixed",v.style.top="0",v.style.left="0",v.style.width="100%",v.style.height="100%",v.style.backgroundColor="rgba(0, 0, 0, 0.5)",v.style.zIndex="9999",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center";const _=()=>{v.remove(),c.remove(),document.removeEventListener("keydown",i)};v.addEventListener("click",y=>{y.target===v&&_()});const i=y=>{y.key==="Escape"&&_()};document.addEventListener("keydown",i);const c=document.createElement("div");c.id="google-signin-button",c.style.position="relative",c.style.background="white",c.style.padding="20px",c.style.borderRadius="8px",c.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",c.style.zIndex="10000",c.addEventListener("click",y=>{y.stopPropagation()}),v.appendChild(c),document.body.appendChild(v);try{window.google.accounts.id.renderButton(c,{theme:"outline",size:"large",text:"signin_with",width:250})}catch(y){console.warn("Could not render Google button, showing manual login option:",y),c.innerHTML=`
                <p style="margin: 0 0 10px 0; text-align: center;">Sign in with Google</p>
                <button onclick="window.location.href='https://accounts.google.com/signin'" 
                        style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Continue with Google
                </button>
                <button onclick="document.getElementById('google-login-backdrop')?.remove(); document.getElementById('google-signin-button')?.remove();" 
                        style="margin-top: 10px; padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Cancel
                </button>
              `;const S=c.querySelector("button:last-child");S&&S.addEventListener("click",()=>{document.removeEventListener("keydown",i)})}},R=()=>{if(g){alert(`Google Sign-In error: ${g}. Please check the browser console.`);return}if(window.google&&j)try{window.google.accounts.id.prompt(F=>{const x=F.getNotDisplayedReason?.(),v=F.getSkippedReason?.(),_=F.getDismissedReason?.(),i=F.isNotDisplayed?.(),c=F.isSkippedMoment?.(),y=F.isDismissedMoment?.();(x||v||_||i||c||y)&&b()}),setTimeout(()=>{document.getElementById("google-login-backdrop")||b()},500)}catch(F){console.error("Error showing Google sign-in:",F),b()}else alert("Google Sign-In is still loading. Please wait a moment and try again.")};return a&&!t?e.jsx("div",{className:"login-button loading",children:e.jsx("span",{children:"Loading..."})}):t?e.jsxs("div",{className:"login-button user-info",children:[e.jsx("div",{className:"user-avatar",children:t.picture?e.jsx("img",{src:t.picture,alt:t.name||t.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:F=>{const x=F.target;x.style.display="none";const v=x.parentElement;if(v){const _=v.querySelector("span");_&&_.remove();const i=document.createElement("span");i.textContent=t.name?.[0]||t.email[0].toUpperCase(),v.appendChild(i)}}}):e.jsx("span",{children:t.name?.[0]||t.email[0].toUpperCase()})}),e.jsxs("div",{className:"user-details",children:[e.jsx("span",{className:"user-name",children:t.name||t.email}),t.role==="admin"&&e.jsx("span",{className:"user-role",children:"Admin"})]}),e.jsx("button",{onClick:f,className:"logout-button",title:u?"Saving changes...":"Logout",disabled:u,children:u?e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",opacity:"0.75",children:e.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"0 12 12",to:"360 12 12",dur:"1s",repeatCount:"indefinite"})})]}):e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e.jsx("polyline",{points:"16 17 21 12 16 7"}),e.jsx("line",{x1:"21",y1:"12",x2:"9",y2:"12"})]})})]}):g&&!j?e.jsxs("div",{className:"login-button-group",children:[e.jsxs("button",{onClick:R,className:"login-button sign-in error",title:g,children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Sign in (Error)"]}),e.jsxs("button",{onClick:()=>{d(null),N(!1),window.location.reload()},className:"login-button retry",title:"Retry loading Google Sign-In",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"})}),"Retry"]})]}):e.jsx("button",{onClick:R,className:"login-button sign-in",disabled:!j,title:j?"Sign in with Google":"Loading Google Sign-In...",children:j?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"}),e.jsx("path",{d:"M3 20a6 6 0 0 1 6-6h6a6 6 0 0 1 6 6v1H3v-1Z"})]}),e.jsx("span",{children:"Sign in"})]}):e.jsx("span",{children:"Loading Google Sign-In..."})})}async function js(t){const n=await fetch(`${Ne}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)throw new Error("Failed to check API key status");return n.json()}async function ks(t,n){const o=await fetch(`${Ne}/api/user/api-key`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})});if(!o.ok){const a=await o.json();throw new Error(a.error||"Failed to save API key")}}function bs(){const{user:t,isAdmin:n}=It(),[o,a]=r.useState(""),[l,m]=r.useState(!1),[h,j]=r.useState(!1),[N,g]=r.useState(!1),[d,u]=r.useState(null);r.useEffect(()=>{t&&!n?p():n&&m(!0)},[t,n]);const p=async()=>{if(t){j(!0);try{const P=localStorage.getItem("auth_token");if(!P)return;const b=await js(P);m(b.hasApiKey)}catch(P){console.error("Failed to load API key status:",P)}finally{j(!1)}}},f=async()=>{if(!(!t||!o.trim())){g(!0),u(null);try{const P=localStorage.getItem("auth_token");if(!P)throw new Error("Not authenticated");await ks(P,o.trim()),u({type:"success",text:"API key saved securely!"}),a(""),m(!0)}catch(P){u({type:"error",text:P instanceof Error?P.message:"Failed to save API key"})}finally{g(!1)}}};return t?n?e.jsx("div",{className:"api-key-settings",children:e.jsxs("div",{className:"api-key-info admin",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"api-key-title",children:"Admin Account"}),e.jsx("p",{className:"api-key-description",children:"You're using the admin API key. No configuration needed."})]})]})}):h?e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Loading..."})}):e.jsxs("div",{className:"api-key-settings",children:[e.jsxs("div",{className:"api-key-header",children:[e.jsx("h3",{children:"Groq API Key"}),l&&e.jsx("span",{className:"api-key-status-badge",children:"Configured"})]}),e.jsx("p",{className:"api-key-description",children:l?"Your API key is securely stored and encrypted. You can update it below.":"Enter your Groq API key to use the chat feature. Your key will be encrypted and stored securely."}),e.jsxs("div",{className:"api-key-input-group",children:[e.jsx("input",{type:"password",value:o,onChange:P=>a(P.target.value),placeholder:"gsk_...",className:"api-key-input",disabled:N}),e.jsx("button",{onClick:f,disabled:!o.trim()||N,className:"api-key-save-button",children:N?"Saving...":l?"Update":"Save"})]}),d&&e.jsx("div",{className:`api-key-message ${d.type}`,children:d.text}),e.jsxs("div",{className:"api-key-help",children:[e.jsx("p",{children:e.jsx("strong",{children:"Don't have an API key?"})}),e.jsxs("ol",{children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://console.groq.com/keys",target:"_blank",rel:"noopener noreferrer",children:"Groq Console"})]}),e.jsx("li",{children:"Sign up or log in"}),e.jsx("li",{children:"Create a new API key"}),e.jsx("li",{children:"Copy and paste it here"})]}),e.jsx("p",{className:"api-key-security-note",children:"ðŸ”’ Your API key is encrypted with AES-256 and stored securely. Only you can use it."})]})]}):e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Please sign in to configure your API key."})})}const Cs="/ChatNote/assets/ucla-logo-BjjJ2cYq.svg";function Ns({onOpenHistory:t,isSavingSession:n=!1,currentMode:o,onResetMode:a,hasPdf:l=!1}){const{theme:m,toggleTheme:h}=Vt(),{isChatVisible:j,toggleChatVisibility:N}=Ln(),{user:g}=It(),[d,u]=r.useState(!1),[p,f]=r.useState(!1),P=r.useRef(null),b=r.useRef(null),R=r.useRef(null),F=g?.email?.endsWith("@g.ucla.edu")??!1,v=o==="quiz-me"?"Quiz Mode":o==="guide-me-learn"?"Learn Mode":null;return r.useEffect(()=>{const _=setTimeout(()=>{P.current&&P.current.classList.add("animation-complete"),b.current&&b.current.classList.add("animation-complete"),R.current&&R.current.classList.add("animation-complete")},13500);return()=>clearTimeout(_)},[]),e.jsxs(e.Fragment,{children:[e.jsx("nav",{className:"navbar",children:e.jsxs("div",{className:"navbar-content",children:[t&&e.jsx("button",{className:"history-toggle",onClick:t,title:"PDF History","aria-label":"Open PDF history",disabled:n,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),e.jsxs("div",{className:"navbar-title",children:[v&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"mode-indicator",onClick:a,title:"Click to change mode",children:[e.jsx("span",{className:"mode-text",children:v}),e.jsx("svg",{className:"mode-change-icon",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})]}),e.jsx("span",{className:"mode-separator",children:"â€¢"})]}),e.jsx("span",{ref:P,className:"title-text",children:"ChatNote"}),F&&e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:b,className:"title-for",children:"for"}),e.jsx("img",{ref:R,src:Cs,alt:"UCLA",className:"ucla-logo"})]})]}),e.jsxs("div",{className:"navbar-actions",children:[e.jsx(vs,{}),e.jsxs("div",{className:"navbar-actions-desktop",children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"history-toggle",onClick:()=>window.dispatchEvent(new CustomEvent("pdf-new-session")),title:"New Session","aria-label":"New Session",disabled:n,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]})}),e.jsx("button",{className:"history-toggle",onClick:()=>window.dispatchEvent(new CustomEvent("pdf-download")),title:"Download","aria-label":"Download PDF",disabled:n,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})})]}),e.jsx("button",{className:"settings-toggle",onClick:()=>u(!d),title:"Settings","aria-label":"Settings",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"})]})}),l&&e.jsx("button",{className:"chat-toggle",onClick:N,title:j?"Hide chat":"Show chat","aria-label":j?"Hide chat":"Show chat",disabled:n,children:j?e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"})]}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18",strokeWidth:"2.5"})]})}),e.jsx("button",{className:"theme-toggle",onClick:h,title:`Switch to ${m==="light"?"dark":"light"} mode`,"aria-label":`Switch to ${m==="light"?"dark":"light"} mode`,children:m==="light"?e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"5"}),e.jsx("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),e.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),e.jsx("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),e.jsx("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),e.jsx("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),e.jsx("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),e.jsx("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),e.jsx("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]})})]}),e.jsx("button",{className:"mobile-menu-toggle",onClick:()=>f(!p),title:"More options","aria-label":"Toggle menu",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"12",cy:"5",r:"1"}),e.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})]}),p&&e.jsxs("div",{className:"mobile-menu",children:[e.jsxs("button",{className:"mobile-menu-item",onClick:()=>{u(!d),f(!1)},children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"})]}),e.jsx("span",{children:"Settings"})]}),l&&e.jsx("button",{className:"mobile-menu-item",onClick:()=>{N(),f(!1)},disabled:n,children:j?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"})]}),e.jsx("span",{children:"Hide Chat"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18",strokeWidth:"2.5"})]}),e.jsx("span",{children:"Show Chat"})]})}),l&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"mobile-menu-item",onClick:()=>{window.dispatchEvent(new CustomEvent("pdf-new-session")),f(!1)},disabled:n,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),e.jsx("span",{children:"New Session"})]}),e.jsxs("button",{className:"mobile-menu-item",onClick:()=>{window.dispatchEvent(new CustomEvent("pdf-download")),f(!1)},disabled:n,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),e.jsx("span",{children:"Download"})]})]}),e.jsx("button",{className:"mobile-menu-item",onClick:()=>{h(),f(!1)},children:m==="light"?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})}),e.jsx("span",{children:"Dark Mode"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"5"}),e.jsx("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),e.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),e.jsx("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),e.jsx("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),e.jsx("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),e.jsx("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),e.jsx("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),e.jsx("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]}),e.jsx("span",{children:"Light Mode"})]})})]})]})}),d&&e.jsx("div",{className:"settings-modal-overlay",onClick:()=>u(!1),children:e.jsxs("div",{className:"settings-modal",onClick:_=>_.stopPropagation(),children:[e.jsxs("div",{className:"settings-modal-header",children:[e.jsx("h2",{children:"Settings"}),e.jsx("button",{className:"settings-modal-close",onClick:()=>u(!1),"aria-label":"Close settings",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("div",{className:"settings-modal-content",children:e.jsx(bs,{})})]})})]})}function bn({mode:t,onModeChange:n,disabled:o=!1}){const[a,l]=r.useState(!1),[m,h]=r.useState(0),[j,N]=r.useState(!1),[g,d]=r.useState(!1),u=r.useRef(null),p=r.useRef(null),f=["auto","reasoning","advanced"],P={auto:"Auto",reasoning:"Reasoning",advanced:"Advanced"},b={auto:"ChatNote will choose the best model automatically - best for daily use",reasoning:"Uses advanced reasoning models for complex problems with thinking process",advanced:"Most capable model for challenging tasks that need real-time information (limited usage)"},R=r.useCallback(()=>{const c=f.indexOf(t),y=u.current?.offsetWidth||80,S=p.current?.offsetWidth||20,U=(y-4-S)/(f.length-1);return c*U},[t]),F=c=>{o||(l(!0),N(!1),h(c.clientX),c.preventDefault(),c.stopPropagation())},x=r.useCallback(c=>{if(!a||o)return;const y=c.clientX-m;Math.abs(y)>3&&N(!0);const S=u.current?.offsetWidth||80,L=p.current?.offsetWidth||20,B=4,T=(S-B-L)/(f.length-1),V=u.current?.getBoundingClientRect();if(!V)return;const H=c.clientX-V.left-B/2-L/2,ee=Math.round(H/T),ue=Math.max(0,Math.min(f.length-1,ee)),ie=f[ue];ie!==t&&n(ie)},[a,o,m,t,n]),v=r.useCallback(()=>{if(a&&(l(!1),!j)){const y=(f.indexOf(t)+1)%f.length;n(f[y])}},[a,j,t,n]);r.useEffect(()=>{if(a)return document.addEventListener("mousemove",x),document.addEventListener("mouseup",v),()=>{document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",v)}},[a,x,v]);const _=c=>{if(o||a)return;const y=u.current?.getBoundingClientRect();if(!y)return;const S=c.clientX-y.left,L=y.width,B=p.current?.offsetWidth||20,U=4,V=(L-U-B)/(f.length-1),H=S-U/2-B/2,ee=Math.round(H/V),ue=Math.max(0,Math.min(f.length-1,ee)),ie=f[ue];ie!==t&&n(ie)},i=R();return e.jsxs("div",{className:"model-mode-toggle-wrapper",children:[e.jsx("div",{ref:u,className:`model-mode-toggle ${t} ${o?"disabled":""} ${a?"dragging":""}`,onMouseDown:F,onClick:_,children:e.jsx("div",{className:"model-mode-toggle-track",children:e.jsx("div",{ref:p,className:"model-mode-toggle-button",style:{transform:`translateX(${i}px)`,transition:a?"none":"transform 0.3s ease"}})})}),e.jsx("div",{className:"model-mode-toggle-label",children:P[t]}),e.jsxs("div",{className:"model-mode-info-icon-wrapper",onMouseEnter:()=>d(!0),onMouseLeave:()=>d(!1),children:[e.jsxs("svg",{className:"model-mode-info-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),g&&e.jsx("div",{className:"model-mode-tooltip",children:b[t]})]})]})}function at(t){if(!t||typeof t!="string")return"";let n=t.replace(/[\u2000-\u200B\u202F\u205F\u3000]/g," ");n=n.replace(/\u2011/g,"-"),n=n.replace(/(<[^>]*>)([^<]*)(<\/[^>]*>)/g,(i,c,y,S)=>{const L=y.replace(/\u2011/g,"-");return L!==y?c+L+S:i}),n=n.replace(/[\u2013\u2014]/g,"-"),n=n.replace(/[\u2018\u2019]/g,"'"),n=n.replace(/[\u201C\u201D]/g,'"'),n=n.replace(/\n{4,}/g,`


`),n=n.replace(/\$\$[\s\S]*?\$\$/g,i=>i.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-")),n=n.replace(/\$[^$\n]+?\$/g,i=>i.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-"));const o=[],a=i=>`__MATH_PLACEHOLDER_${i}__`;n=n.replace(/\$\$[\s\S]*?\$\$/g,i=>{const c=i.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return o.push(c),a(o.length-1)}),n=n.replace(/\\\(([\s\S]*?)\\\)/g,(i,c)=>{let y=c.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");y=y.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const S=`$${y}$`;return o.push(S),a(o.length-1)}),n=n.replace(/\$[^$\n]+?\$/g,i=>{const c=i.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return o.push(c),a(o.length-1)}),n=n.replace(/\\\[([\s\S]*?)\\\]/g,(i,c)=>{let y=c.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");y=y.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const S=`$$${y}$$`;return o.push(S),a(o.length-1)});const l=[],m=/\(([^()]*?(?:[\\_^]|\\[a-zA-Z@]+\{[^}]*\}|\\pm|\\sim|\\times|\\div|\\sqrt|\\frac|\\text\{|\\approx|\\leq|\\geq|\\neq|\\sum|\\int|\\prod|=\s*\\[a-zA-Z@]+|~\s*\\[a-zA-Z@]+)[^()]*?)\)/g;let h;for(;(h=m.exec(n))!==null;){const i=h[0],c=h.index,y=c>0?n[c-1]:"",S=c+i.length<n.length?n[c+i.length]:"";y==="$"&&S==="$"||n.substring(Math.max(0,c-2),c).includes("](")||y==="`"||S==="`"||n.substring(Math.max(0,c-10),c+i.length+10).includes("__MATH_PLACEHOLDER")||l.push({match:i,index:c})}const j=[],N=/\\[a-zA-Z@]+(?:_[a-zA-Z0-9{}]+|\^[a-zA-Z0-9{}]+)?\s*[~Â±â‰¤â‰¥â‰ â‰ˆ=]\s*[^.,;:!?\n]{5,150}?(?=\s|$|[.,;:!?]|\\[a-zA-Z@]|_[a-zA-Z0-9]|\^[a-zA-Z0-9])/g;let g;for(;(g=N.exec(n))!==null;){const i=g.index;let c=g[0];const y=Math.max(c.indexOf("~"),c.indexOf("="),c.indexOf("Â±"),c.indexOf("â‰¤"),c.indexOf("â‰¥"),c.indexOf("â‰ "),c.indexOf("â‰ˆ"));if(y===-1||y===c.length-1)continue;const S=c.substring(y+1);if(!/\\[a-zA-Z@]+|_[a-zA-Z0-9{}]|\^[a-zA-Z0-9{}]/.test(S))continue;const L=/[.,;:!?]/.exec(c);L&&L.index>10&&L.index<c.length-5&&(c=c.substring(0,L.index+1));const B=i>0?n[i-1]:"",U=i+c.length<n.length?n[i+c.length]:"";if(B==="$"||U==="$"||B==="`"||U==="`"||n.substring(Math.max(0,i-10),i+c.length+10).includes("__MATH_PLACEHOLDER"))continue;!l.some(V=>{const H=V.index,ee=H+V.match.length;return i>=H&&i+c.length<=ee})&&c.length>10&&j.push({match:c,index:i})}const d=[],u=(i,c)=>{let y=0,S=c;for(;S<i.length;){if(i[S]==="{")y++;else if(i[S]==="}"&&(y--,y===0))return S+1;S++}return-1},p=/\\sqrt\[[^\]]+\](?=\{)/g;let f;for(;(f=p.exec(n))!==null;){const i=f.index,c=i+f[0].length;if(n[c]==="{"){const y=u(n,c);if(y!==-1){const S=n.substring(i,y),L=i>0?n[i-1]:"",B=y<n.length?n[y]:"";L!=="$"&&B!=="$"&&!n.substring(Math.max(0,i-10),y+10).includes("__MATH_PLACEHOLDER")&&d.push({match:S,index:i})}}}const P=/\\(sqrt|frac|text|overline|underline)(?=\{)/g;let b;for(;(b=P.exec(n))!==null;){const i=b.index,c=b[1],y=i+b[0].length;if(n[y]==="{")if(c==="frac"){const S=u(n,y);if(S===-1||n[S]!=="{")continue;const L=u(n,S);if(L===-1)continue;const B=n.substring(i,L),U=i>0?n[i-1]:"",T=L<n.length?n[L]:"";U!=="$"&&T!=="$"&&!n.substring(Math.max(0,i-10),L+10).includes("__MATH_PLACEHOLDER")&&d.push({match:B,index:i})}else{const S=u(n,y);if(S===-1)continue;const L=n.substring(i,S),B=i>0?n[i-1]:"",U=S<n.length?n[S]:"";B!=="$"&&U!=="$"&&!n.substring(Math.max(0,i-10),S+10).includes("__MATH_PLACEHOLDER")&&(l.some(V=>{const H=V.index,ee=H+V.match.length;return i>=H&&S<=ee})||j.some(V=>{const H=V.index,ee=H+V.match.length;return i>=H&&S<=ee})||d.push({match:L,index:i}))}}n=n.replace(/(\$?\s*)(\d{1,3}(?:\s+\d{3})+)(\b)/g,(i,c,y,S)=>{const L=y.replace(/\s+/g,",");return c.trim().startsWith("$")?`$${L}$${S}`:c+L+S}),n=n.replace(/\$(\d{1,3}(?:,\d{3})+)(?![$])/g,(i,c,y,S)=>{if((y>0?S[y-1]:"")==="$")return i;const B=y+i.length;if(B<S.length&&S[B]==="$")return i;const U=B<S.length?S[B]:"";return U===" "||/[.,;:!?)]/.test(U)?`$${c}$${U}`:`$${c}$`});const R=/(\d+)\{,\}(\d+)/g,F=[];let x;for(;(x=R.exec(n))!==null;){const i=x.index,c=x[0],y=i>0?n[i-1]:"",S=i+c.length<n.length?n[i+c.length]:"";if(y==="$"||S==="$"||n.substring(Math.max(0,i-10),i+c.length+10).includes("__MATH_PLACEHOLDER"))continue;let L=i;for(;L>0&&/\d/.test(n[L-1]);)L--;let B=i+c.length;for(;B<n.length&&/\d/.test(n[B]);)B++;const U=n.substring(L,B),T=Math.max(0,L-5),V=n.substring(T,L),H=n.substring(B,Math.min(n.length,B+5));F.push({numberPart:U,fullMatch:U,startIndex:L,endIndex:B,prefix:V,suffix:H})}const v=[...l.map(i=>({...i,type:"parentheses"})),...j.map(i=>({...i,type:"expression"})),...d.map(i=>({...i,type:"complex"})),...F.map(i=>({match:i.fullMatch,index:i.startIndex,type:"thousand",isThousand:!0,replacement:i.numberPart.replace(/\{,\}/g,",")}))].sort((i,c)=>i.index-c.index),_=[];for(let i=0;i<v.length;i++){const c=v[i];let y=!1;for(let S=0;S<_.length;S++){const L=_[S],B=c.index+c.match.length,U=L.index+L.match.length;if(c.index<U&&B>L.index){c.match.length>L.match.length&&(_[S]=c),y=!0;break}}y||_.push(c)}_.sort((i,c)=>c.index-i.index);for(const i of _){const c=n.substring(0,i.index),y=n.substring(i.index+i.match.length);if(i.type==="thousand"){const S=i.replacement;n=c+`$${S}$`+y}else n=c+`$${i.match}$`+y}return o.forEach((i,c)=>{n=n.replace(a(c),i)}),n}const Ss="/ChatNote/assets/chatnote-icon-BQXPxUrH.svg";function Ms({onModeSelect:t,disabled:n=!1}){const[o,a]=r.useState(null);return e.jsxs("div",{className:"interaction-mode-selector",children:[e.jsxs("div",{className:"mode-selector-header",children:[e.jsx("h2",{children:"How would you like to learn today?"}),e.jsx("p",{children:"Choose your preferred learning experience"})]}),e.jsxs("div",{className:"mode-cards",children:[e.jsxs("button",{className:`mode-card ${o==="guide-me-learn"?"hovered":""}`,onClick:()=>!n&&t("guide-me-learn"),onMouseEnter:()=>a("guide-me-learn"),onMouseLeave:()=>a(null),disabled:n,children:[e.jsx("div",{className:"mode-icon guide-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M12 2L2 7L12 12L22 7L12 2Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M2 17L12 22L22 17",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M2 12L12 17L22 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsx("h3",{children:"Guide Me Learn"}),e.jsx("p",{children:"Interactive learning with AI tutor assistance"}),e.jsxs("ul",{className:"mode-features",children:[e.jsx("li",{children:"ðŸ’¬ Chat with AI about PDF"}),e.jsx("li",{children:"ðŸ“– Get detailed explanations"}),e.jsx("li",{children:"ðŸ’¡ Ask questions anytime"}),e.jsx("li",{children:"ðŸ” Deep dive into any topic"})]}),e.jsx("div",{className:"mode-action",children:"Start Learning â†’"})]}),e.jsxs("button",{className:`mode-card ${o==="quiz-me"?"hovered":""}`,onClick:()=>!n&&t("quiz-me"),onMouseEnter:()=>a("quiz-me"),onMouseLeave:()=>a(null),disabled:n,children:[e.jsx("div",{className:"mode-icon quiz-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M9 11L12 14L22 4",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsx("h3",{children:"Quiz Me"}),e.jsx("p",{children:"Test your knowledge with AI-generated quizzes"}),e.jsxs("ul",{className:"mode-features",children:[e.jsx("li",{children:"ðŸŽ¯ Multiple types questions"}),e.jsx("li",{children:"ðŸ§  AI-powered generation"}),e.jsx("li",{children:"ðŸ“Š Track your progress"}),e.jsx("li",{children:"ðŸ”„ Request more questions"})]}),e.jsx("div",{className:"mode-action",children:"Take Quiz â†’"})]})]})]})}async function Ps(t,n={}){const{count:o=10,difficulty:a="mixed",questionTypes:l=["multiple-choice"],focusPages:m}=n,h=Date.now(),j=Math.floor(Math.random()*1e4),N=`You are an expert quiz generator. Generate high-quality quiz questions based on the provided content.

IMPORTANT: Generate UNIQUE questions each time. Use varied topics, concepts, and difficulty levels across the content.
Generation ID: ${h}-${j}

Requirements:
- Generate exactly ${o} questions
- Difficulty: ${a}
- Question types: ${l.join(", ")}
- Each question must have clear, unambiguous answers
- For multiple choice: provide 4 options with only ONE correct answer
- For short answer: provide the correct answer text (NO options)
- For true/false: correctAnswer should be "true" or "false" (NO options)
- For fill-blank: provide the word/phrase that fills the blank (NO options)
- Include page references when possible
- Provide detailed explanations for correct answers
- Vary the topics and concepts tested - don't focus on the same areas

Return ONLY a valid JSON array of questions. Use these structures based on question type:

For multiple-choice:
{
  "id": "q1",
  "type": "multiple-choice",
  "question": "What is...",
  "options": [
    {"id": "a", "text": "Option A", "isCorrect": false},
    {"id": "b", "text": "Option B", "isCorrect": true},
    {"id": "c", "text": "Option C", "isCorrect": false},
    {"id": "d", "text": "Option D", "isCorrect": false}
  ],
  "correctAnswer": "b",
  "explanation": "The correct answer is B because...",
  "pageReference": 1,
  "difficulty": "medium"
}

For short-answer (NO options array):
{
  "id": "q2",
  "type": "short-answer",
  "question": "Explain the concept of...",
  "correctAnswer": "The expected answer text",
  "explanation": "A good answer should include...",
  "pageReference": 2,
  "difficulty": "medium"
}
NOTE: For short-answer questions, avoid answers that require typing math functions or complex formulas. Use simple text answers instead.

For true-false (NO options array):
{
  "id": "q3",
  "type": "true-false",
  "question": "Statement to evaluate...",
  "correctAnswer": "true",
  "explanation": "This is true/false because...",
  "pageReference": 3,
  "difficulty": "easy"
}

For fill-blank (NO options array):
{
  "id": "q4",
  "type": "fill-blank",
  "question": "The ____ is responsible for...",
  "correctAnswer": "nucleus",
  "explanation": "The nucleus is correct because...",
  "pageReference": 4,
  "difficulty": "medium"
}

IMPORTANT: 
- Do NOT include "options" field for short-answer, true-false, or fill-blank questions. Only multiple-choice questions should have options.
- Ensure all text fields use proper JSON escaping (escape quotes, backslashes, and newlines)
- Keep text clean and simple - avoid special characters that need escaping when possible
- Do not use literal newlines in text fields - use spaces instead

Focus on testing understanding, not just memorization.`,g=`Generate ${o} ${a} quiz questions from this content:

${m?`Focus on pages: ${m.join(", ")}

`:""}${t}`,d=6e3;let u=t;t.length>d&&(u=t.slice(0,d));let p=null;for(let f=0;f<yt.length;f++)for(let P=0;P<3;P++)try{const b=await Ot([{role:"system",content:N},{role:"user",content:g.replace(t,u)}],yt[f]),R=typeof b=="string"?b:"";let F=R.match(/\[[\s\S]*\]/),x=F?F[0]:null;if(!x){const i=R.match(/\{[\s\S]*\}/);i&&(x=`[${i[0]}]`)}if(!x){console.error("No JSON array/object found in response:",R.substring(0,500)),p=new Error("Failed to parse quiz questions from AI response");continue}x=x.replace(/```json\s*/g,"").replace(/```\s*/g,""),x=x.replace(/\\n/g," ").replace(/\\t/g," ").replace(/\n/g," ").replace(/\t/g," ").replace(/\r/g," ");let v=[];try{v=JSON.parse(x)}catch(i){console.warn("JSON parse failed, attempting to fix:",i),x=x.replace(/,\s*([}\]])/g,"$1"),v=JSON.parse(x)}const _=v.map((i,c)=>{const y={id:i.id||`q${c+1}`,type:i.type||"multiple-choice",question:i.question,correctAnswer:i.correctAnswer,explanation:i.explanation,pageReference:i.pageReference,difficulty:i.difficulty||"medium"};return i.type==="multiple-choice"&&i.options&&(y.options=i.options),y}).filter(i=>i.question&&typeof i.question=="string"&&i.question.trim().length>0&&(i.type!=="multiple-choice"||Array.isArray(i.options)&&i.options.length>0));if(_.length>0)return _;console.warn(`Attempt ${P+1}: No valid questions, retrying...`)}catch(b){if(p=b,b?.message?.includes("rate limit")||b?.message?.includes("Payload Too Large")){console.warn("Model error, trying next fallback:",b?.message);break}break}throw console.error("Quiz generation error:",p),new Error("Failed to generate quiz. Please try again.")}function Ut(t,n){const a=(Array.isArray(t.correctAnswer)?t.correctAnswer:[t.correctAnswer]).some(m=>m.toLowerCase().trim()===n.toLowerCase().trim()),l=a?`âœ… Correct! ${t.explanation}`:`âŒ Incorrect. ${t.explanation}`;return{isCorrect:a,feedback:l}}function As({questions:t,userAnswers:n,score:o,onAddToPDF:a,onAddToNotes:l,onRetake:m,onExit:h}){const j=t.length,N=Math.round(o/j*100),g=(u,p)=>{let f=p;if(u.type==="multiple-choice"&&u.options){const P=u.options.find(b=>b.id===p);f=P?P.text:p}return e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1}]],children:at(f)})},d=u=>{let p="N/A";if(u.type==="multiple-choice"&&u.options){const f=u.options.find(P=>P.isCorrect);p=f?f.text:"N/A"}else Array.isArray(u.correctAnswer)?p=u.correctAnswer.join(", "):p=u.correctAnswer;return e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1}]],children:at(p)})};return e.jsxs("div",{className:"quiz-review",children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("div",{className:"score-summary",children:[e.jsxs("div",{className:"score-circle-small",children:[e.jsxs("svg",{viewBox:"0 0 120 120",children:[e.jsx("circle",{cx:"60",cy:"60",r:"54",fill:"none",stroke:"#e5e7eb",strokeWidth:"12"}),e.jsx("circle",{cx:"60",cy:"60",r:"54",fill:"none",stroke:"url(#reviewGradient)",strokeWidth:"12",strokeDasharray:`${N*3.39} 339`,strokeLinecap:"round",transform:"rotate(-90 60 60)"}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"reviewGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#667eea"}),e.jsx("stop",{offset:"100%",stopColor:"#764ba2"})]})})]}),e.jsx("div",{className:"score-text-small",children:e.jsxs("div",{className:"score-percentage-small",children:[N,"%"]})})]}),e.jsxs("div",{className:"summary-text",children:[e.jsx("h2",{children:"Quiz Review"}),e.jsxs("p",{className:"score-details",children:["You answered ",e.jsx("strong",{children:o})," out of ",e.jsx("strong",{children:j})," questions correctly"]}),e.jsxs("div",{className:"performance-badge",children:[N>=90&&"ðŸŒŸ Excellent Work!",N>=70&&N<90&&"ðŸ‘ Good Job!",N>=50&&N<70&&"ðŸ“š Keep Studying!",N<50&&"ðŸ’ª Practice More!"]})]})]}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{className:"action-btn secondary",onClick:m,children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M1 4V10H7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M3.51 15C4.15839 16.8404 5.38734 18.4202 7.01166 19.5014C8.63598 20.5826 10.5677 21.1066 12.5157 20.9945C14.4637 20.8824 16.3226 20.1402 17.8121 18.8798C19.3017 17.6193 20.3413 15.9089 20.7742 14.0064C21.2072 12.1038 21.0101 10.1119 20.2126 8.33111C19.4152 6.55029 18.0605 5.07462 16.3528 4.1235C14.6451 3.17238 12.6769 2.78949 10.7447 3.02841C8.81245 3.26733 7.02091 4.11638 5.64 5.45",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),"Retake Quiz"]}),e.jsxs("button",{className:"action-btn primary",onClick:h,children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M9 11L12 14L22 4",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),"Done"]})]})]}),e.jsx("div",{className:"questions-review-list",children:t.map((u,p)=>{const f=n.get(u.id)||"",b=Ut(u,f).isCorrect;return e.jsxs("div",{className:`review-question-card ${b?"correct":"incorrect"}`,children:[e.jsxs("div",{className:"review-question-header",children:[e.jsxs("div",{className:"question-number-badge",children:["Question ",p+1,b?e.jsx("span",{className:"status-icon correct-icon",children:"âœ“"}):e.jsx("span",{className:"status-icon incorrect-icon",children:"âœ—"})]}),e.jsxs("div",{className:"question-meta",children:[e.jsx("span",{className:`difficulty-badge ${u.difficulty}`,children:u.difficulty}),u.pageReference&&e.jsxs("span",{className:"page-ref",children:["Page ",u.pageReference]})]})]}),e.jsx("div",{className:"review-question-text",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1}]],children:at(u.question)})}),e.jsxs("div",{className:"answer-comparison",children:[e.jsxs("div",{className:`answer-box ${b?"correct-answer-box":"incorrect-answer-box"}`,children:[e.jsx("div",{className:"answer-label",children:"Your Answer"}),e.jsx("div",{className:"answer-content",children:f?g(u,f):e.jsx("span",{className:"no-answer",children:"No answer provided"})})]}),!b&&e.jsxs("div",{className:"answer-box correct-answer-box",children:[e.jsx("div",{className:"answer-label",children:"Correct Answer"}),e.jsx("div",{className:"answer-content",children:d(u)})]})]}),e.jsxs("div",{className:"review-explanation",children:[e.jsxs("div",{className:"explanation-label",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2"}),e.jsx("path",{d:"M12 16V12M12 8H12.01",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]}),"Explanation"]}),e.jsx("div",{className:"explanation-content",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1}]],children:at(u.explanation)})})]}),e.jsxs("div",{className:"review-question-actions",children:[e.jsxs("button",{className:"mini-action-btn",onClick:()=>a(u,f,b),title:"Add question and answer to PDF as annotation",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M14 2V8H20",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M12 18V12M9 15H15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),"Add to PDF"]}),e.jsxs("button",{className:"mini-action-btn",onClick:()=>l(u,f,b),title:"Save question to Knowledge Notes",children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M19 21L12 16L5 21V5C5 4.46957 5.21071 3.96086 5.58579 3.58579C5.96086 3.21071 6.46957 3 7 3H17C17.5304 3 18.0391 3.21071 18.4142 3.58579C18.7893 3.96086 19 4.46957 19 5V21Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),"Save to Notes"]})]})]},u.id)})})]})}function Es({session:t,onAnswer:n,onNextQuestion:o,onPreviousQuestion:a,onRequestMore:l,onFinish:m,onRestart:h,onAddToPDF:j,onAddToNotes:N,onExitReview:g}){const[d,u]=r.useState(""),[p,f]=r.useState(!1),[P,b]=r.useState(!1),[R,F]=r.useState(!1),x=t.questions[t.currentQuestionIndex],v=t.currentQuestionIndex===t.questions.length-1,_=t.currentQuestionIndex===0,i=t.answers.has(x?.id||"");r.useEffect(()=>{const T=t.answers.get(x?.id||"");T&&i?(u(T),f(!0)):(u(""),f(!1))},[t.currentQuestionIndex,x?.id,i,t.answers]);const c=T=>{i||(u(T),n(x.id,T),f(!0))},y=()=>{v?m():o()},S=()=>{a()},L=(T,V)=>{b(!1),l(T,V)};if(!x)return e.jsx("div",{className:"quiz-interface",children:e.jsx("div",{className:"quiz-empty",children:e.jsx("h3",{children:"Loading quiz..."})})});if(t.isComplete){if(R)return e.jsx(As,{questions:t.questions,userAnswers:t.answers,score:t.score,onAddToPDF:j||(()=>{}),onAddToNotes:N||(()=>{}),onRetake:()=>{F(!1),h()},onExit:()=>{F(!1),g&&g()}});const T=t.questions.length,V=Array.from(t.answers.entries()).filter(([ee,ue])=>{const ie=t.questions.find(je=>je.id===ee);return ie?Ut(ie,ue).isCorrect:!1}).length,H=Math.round(V/T*100);return e.jsx("div",{className:"quiz-interface quiz-complete",children:e.jsxs("div",{className:"quiz-results",children:[e.jsxs("div",{className:"results-header",children:[e.jsx("div",{className:"trophy-icon",children:"ðŸ†"}),e.jsx("h2",{children:"Quiz Complete!"})]}),e.jsxs("div",{className:"score-circle",children:[e.jsxs("svg",{viewBox:"0 0 200 200",children:[e.jsx("circle",{cx:"100",cy:"100",r:"90",fill:"none",stroke:"#e5e7eb",strokeWidth:"20"}),e.jsx("circle",{cx:"100",cy:"100",r:"90",fill:"none",stroke:"url(#scoreGradient)",strokeWidth:"20",strokeDasharray:`${H*5.65} 565`,strokeLinecap:"round",transform:"rotate(-90 100 100)"}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"scoreGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#667eea"}),e.jsx("stop",{offset:"100%",stopColor:"#764ba2"})]})})]}),e.jsxs("div",{className:"score-text",children:[e.jsxs("div",{className:"score-percentage",children:[H,"%"]}),e.jsxs("div",{className:"score-label",children:[V," / ",T]})]})]}),e.jsxs("div",{className:"performance-label",children:[H>=90&&"ðŸŒŸ Excellent!",H>=70&&H<90&&"ðŸ‘ Good job!",H>=50&&H<70&&"ðŸ“š Keep studying!",H<50&&"ðŸ’ª Practice more!"]}),e.jsxs("div",{className:"results-actions review-actions",children:[e.jsxs("button",{className:"result-btn primary",onClick:()=>F(!0),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M9 5H7C6.46957 5 5.96086 5.21071 5.58579 5.58579C5.21071 5.96086 5 6.46957 5 7V19C5 19.5304 5.21071 20.0391 5.58579 20.4142C5.96086 20.7893 6.46957 21 7 21H17C17.5304 21 18.0391 20.7893 18.4142 20.4142C18.7893 20.0391 19 19.5304 19 19V7C19 6.46957 18.7893 5.96086 18.4142 5.58579C18.0391 5.21071 17.5304 5 17 5H15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M9 5C9 4.46957 9.21071 3.96086 9.58579 3.58579C9.96086 3.21071 10.4696 3 11 3H13C13.5304 3 14.0391 3.21071 14.4142 3.58579C14.7893 3.96086 15 4.46957 15 5C15 5.53043 14.7893 6.03914 14.4142 6.41421C14.0391 6.78929 13.5304 7 13 7H11C10.4696 7 9.96086 6.78929 9.58579 6.41421C9.21071 6.03914 9 5.53043 9 5Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M9 12H15M9 16H15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),e.jsx("span",{className:"btn-label",children:"Review Answers"})]}),e.jsxs("button",{className:"result-btn",onClick:h,children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M1 4V10H7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M23 20V14H17",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M20.49 9C19.9828 7.56678 19.1209 6.28536 17.9845 5.27541C16.8482 4.26546 15.4745 3.55977 13.9917 3.22426C12.5089 2.88875 10.9652 2.93434 9.50481 3.35677C8.04437 3.77921 6.71475 4.56471 5.64 5.64L1 10M23 14L18.36 18.36C17.2853 19.4353 15.9556 20.2208 14.4952 20.6432C13.0348 21.0657 11.4911 21.1112 10.0083 20.7757C8.52547 20.4402 7.1518 19.7345 6.01547 18.7246C4.87913 17.7146 4.01717 16.4332 3.51 15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),e.jsx("span",{className:"btn-label",children:"Try Again"})]}),e.jsxs("button",{className:"result-btn",onClick:()=>b(!0),children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 5V19M5 12H19",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),e.jsx("span",{className:"btn-label",children:"More Questions"})]})]}),P&&e.jsxs("div",{className:"request-more-panel",children:[e.jsx("h4",{children:"Request More Questions"}),e.jsxs("div",{className:"more-options",children:[e.jsx("button",{onClick:()=>L(5),children:"+5 Mixed Questions"}),e.jsx("button",{onClick:()=>L(5,"multiple-choice"),children:"+5 Multiple Choice"}),e.jsx("button",{onClick:()=>L(10),children:"+10 Mixed Questions"})]})]})]})})}const B=t.answers.get(x.id),U=B?Ut(x,B):null;return e.jsxs("div",{className:"quiz-interface",children:[e.jsxs("div",{className:"quiz-header",children:[e.jsxs("div",{className:"quiz-progress",children:[e.jsxs("div",{className:"progress-text",children:["Question ",t.currentQuestionIndex+1," of ",t.questions.length]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${(t.currentQuestionIndex+1)/t.questions.length*100}%`}})})]}),e.jsxs("div",{className:"quiz-score",children:["Score: ",t.score," / ",t.questions.length]})]}),e.jsxs("div",{className:"question-card",children:[e.jsxs("div",{className:"question-header",children:[e.jsx("span",{className:`difficulty-badge ${x.difficulty}`,children:x.difficulty}),x.pageReference&&e.jsxs("span",{className:"page-ref",children:["Page ",x.pageReference]})]}),e.jsx("div",{className:"question-text",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1}]],children:at(x.question)})}),x.type==="multiple-choice"&&x.options&&e.jsx("div",{className:"options-list",children:x.options.map(T=>{const V=d===T.id||B===T.id,H=T.isCorrect,ee=i&&H,ue=i&&V&&!H;return e.jsxs("button",{className:`option-btn ${V?"selected":""} ${ee?"correct":""} ${ue?"incorrect":""}`,onClick:()=>c(T.id),disabled:i,children:[e.jsx("div",{className:"option-letter",children:T.id.toUpperCase()}),e.jsx("div",{className:"option-text",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1}]],children:at(T.text)})}),ee&&e.jsx("div",{className:"option-icon",children:"âœ“"}),ue&&e.jsx("div",{className:"option-icon",children:"âœ—"})]},T.id)})}),x.type==="true-false"&&e.jsx("div",{className:"true-false-options",children:["true","false"].map(T=>{const V=d===T||B===T,H=x.correctAnswer===T,ee=i&&H,ue=i&&V&&!H;return e.jsxs("button",{className:`tf-btn ${V?"selected":""} ${ee?"correct":""} ${ue?"incorrect":""}`,onClick:()=>c(T),disabled:i,children:[e.jsx("div",{className:"tf-icon",children:T==="true"?"âœ“":"âœ—"}),e.jsx("div",{className:"tf-text",children:T==="true"?"True":"False"}),ee&&e.jsx("div",{className:"option-icon",children:"âœ“"}),ue&&e.jsx("div",{className:"option-icon",children:"âœ—"})]},T)})}),x.type==="short-answer"&&e.jsxs("div",{className:"short-answer-container",children:[e.jsx("textarea",{className:"short-answer-input",placeholder:"Type your answer here...",value:d,onChange:T=>u(T.target.value),disabled:i,rows:4}),!i&&e.jsx("button",{className:"submit-answer-btn",onClick:()=>c(d),disabled:!d.trim(),children:"Submit Answer"})]}),x.type==="fill-blank"&&e.jsxs("div",{className:"fill-blank-container",children:[e.jsx("input",{type:"text",className:"fill-blank-input",placeholder:"Type your answer...",value:d,onChange:T=>u(T.target.value),disabled:i}),!i&&e.jsx("button",{className:"submit-answer-btn",onClick:()=>c(d),disabled:!d.trim(),children:"Submit Answer"})]}),p&&U&&e.jsxs("div",{className:`explanation ${U.isCorrect?"correct":"incorrect"}`,children:[e.jsx("div",{className:"explanation-header",children:U.isCorrect?"âœ… Correct!":"âŒ Incorrect"}),e.jsx("div",{className:"explanation-text",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1}]],children:at(x.explanation)})})]})]}),e.jsxs("div",{className:"quiz-navigation",children:[e.jsxs("button",{className:"nav-btn",onClick:S,disabled:_,children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M15 18L9 12L15 6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),"Previous"]}),i&&e.jsxs("button",{className:"nav-btn primary",onClick:y,children:[v?"Finish Quiz":"Next Question",!v&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M9 18L15 12L9 6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})]})]}),e.jsx("button",{className:"request-more-btn",onClick:()=>b(!P),children:"+ Request More Questions"}),P&&e.jsxs("div",{className:"request-more-panel",children:[e.jsx("h4",{children:"Add More Questions"}),e.jsxs("div",{className:"more-options",children:[e.jsx("button",{onClick:()=>L(5),children:"+5 Questions"}),e.jsx("button",{onClick:()=>L(5,"multiple-choice"),children:"+5 Multiple Choice"}),e.jsx("button",{onClick:()=>L(10),children:"+10 Questions"})]})]})]})}const Cn={"multiple-choice":20,"true-false":30,"short-answer":15,"fill-blank":15,mixed:20};function Is({onStartQuiz:t,onBack:n}){const[o,a]=r.useState(["multiple-choice"]),[l,m]=r.useState(10),h=f=>{switch(f){case"multiple-choice":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M9 11l3 3L22 4"}),e.jsx("path",{d:"M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"})]});case"true-false":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M9 12l2 2 4-4"}),e.jsx("path",{d:"M15 9l-6 6",opacity:"0.4"})]});case"short-answer":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),e.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]});case"mixed":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("rect",{x:"3",y:"14",width:"7",height:"7"})]})}},j=[{value:"multiple-choice",label:"Multiple Choice",description:"Select from 4 options"},{value:"true-false",label:"True/False",description:"Binary choice questions"},{value:"short-answer",label:"Short Answer",description:"Brief written responses"},{value:"mixed",label:"Mixed",description:"Combination of types"}],N=()=>o.length===0?10:Math.min(...o.map(f=>Cn[f])),g=f=>{if(f==="mixed")a(["mixed"]),l<3&&m(3);else{const P=o.includes(f)?o.filter(b=>b!==f):[...o.filter(b=>b!=="mixed"),f];if(P.length===0)a(["multiple-choice"]);else{a(P);const b=P.length;l<b&&m(b)}}},d=f=>{const P=N(),b=o.includes("mixed")?3:Math.max(1,o.length);m(Math.min(Math.max(b,f),P))},u=()=>{const f=o.includes("mixed")?["multiple-choice","true-false","short-answer"]:o.filter(P=>P!=="mixed");t(l,f)},p=N();return e.jsxs("div",{className:"quiz-configuration",children:[e.jsxs("button",{className:"quiz-config-back",onClick:n,title:"Back to mode selection",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})}),"Back"]}),e.jsxs("div",{className:"quiz-config-header",children:[e.jsx("h2",{children:"Configure Your Quiz"}),e.jsx("p",{children:"Customize your learning experience"})]}),e.jsxs("div",{className:"quiz-config-content",children:[e.jsxs("div",{className:"config-section",children:[e.jsx("h3",{children:"Question Types"}),e.jsx("p",{className:"section-description",children:"Select one or more types (or choose Mixed)"}),e.jsx("div",{className:"question-type-grid",children:j.map(f=>e.jsxs("button",{className:`question-type-card ${o.includes(f.value)?"selected":""}`,onClick:()=>g(f.value),children:[e.jsx("div",{className:"type-icon",children:h(f.value)}),e.jsx("div",{className:"type-label",children:f.label}),e.jsx("div",{className:"type-description",children:f.description}),e.jsxs("div",{className:"type-limit",children:["Max: ",Cn[f.value]]})]},f.value))})]}),e.jsxs("div",{className:"config-section",children:[e.jsx("h3",{children:"Number of Questions"}),e.jsxs("p",{className:"section-description",children:["Choose between 1 and ",p," questions"]}),e.jsxs("div",{className:"question-count-selector",children:[e.jsxs("div",{className:"count-input-wrapper",children:[e.jsx("button",{className:"count-btn",onClick:()=>d(l-1),disabled:l<=1,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),e.jsx("input",{type:"number",value:l,onChange:f=>d(parseInt(f.target.value)||1),min:1,max:p,className:"count-input"}),e.jsx("button",{className:"count-btn",onClick:()=>d(l+1),disabled:l>=p,children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),e.jsx("input",{type:"range",value:l,onChange:f=>d(parseInt(f.target.value)),min:1,max:p,className:"count-slider"})]})]}),e.jsxs("div",{className:"config-summary",children:[e.jsxs("div",{className:"summary-info",children:[e.jsx("div",{className:"summary-icon",children:"ðŸ“"}),e.jsxs("div",{className:"summary-text",children:[e.jsx("strong",{children:l})," ",o.join(" + ")," question",l!==1?"s":""]})]}),e.jsxs("button",{className:"start-quiz-btn",onClick:u,children:[e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polygon",{points:"5 3 19 12 5 21 5 3"})}),"Generate Quiz"]})]})]})]})}function Ts(t){if(!t)return[];const n=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","be","been","being","have","has","had","do","does","did","will","would","should","could","may","might","must","can","this","that","these","those","what","which","who","whom","whose","where","when","why","how","about","tell","me","please","help","does","mention","any","pdf"]),o=t.toLowerCase(),a=[],l=o.replace(/[^\w\s]/g," ").split(/\s+/).filter(h=>h.length>2&&!n.has(h));for(let h=0;h<l.length-1;h++){const j=`${l[h]} ${l[h+1]}`;l[h].length>3&&l[h+1].length>3&&a.push(j)}for(let h=0;h<l.length-2;h++){const j=`${l[h]} ${l[h+1]} ${l[h+2]}`;l[h].length>3&&l[h+1].length>2&&l[h+2].length>3&&a.push(j)}const m=[...a,...l];return[...new Set(m)].sort((h,j)=>j.length-h.length)}function Ls(t){const n=new Set(t),o={distribution:["spread","scatter","allocation","dispersion","arrangement"],data:["information","dataset","sample","observation","record"],figure:["chart","graph","plot","diagram","visualization","illustration"],table:["matrix","grid","tabular"],method:["approach","technique","algorithm","procedure","strategy"],result:["finding","outcome","conclusion","summary","finding"],analysis:["evaluation","examination","study","investigation","assessment"]};for(const a of t){const l=a.toLowerCase();n.add(l);for(const[m,h]of Object.entries(o))(l.includes(m)||m.includes(l))&&h.forEach(j=>n.add(j));l.endsWith("s")&&n.add(l.slice(0,-1)),l.endsWith("ed")&&n.add(l.slice(0,-2)),l.endsWith("ing")&&n.add(l.slice(0,-3))}return Array.from(n)}function $s(t,n,o){if(!t||n.length===0)return t;const a=800,l=[];for(const g of n){const d=g.toLowerCase(),u=new RegExp(d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");let p;for(;(p=u.exec(t))!==null;){const f=p.index,P=p.index+p[0].length,b=Math.max(0,f-a),R=Math.min(t.length,P+a),F=g.length>4?3:2;l.push({start:b,end:R,score:F})}}if(l.length===0)return pt(t,Math.floor(o/4));l.sort((g,d)=>g.start-d.start);const m=[];for(const g of l){let d=!1;for(let u=0;u<m.length;u++){const p=m[u];if(g.start<=p.end+200&&g.end>=p.start-200){p.start=Math.min(p.start,g.start),p.end=Math.max(p.end,g.end),p.score+=g.score,d=!0;break}}d||m.push(g)}m.sort((g,d)=>d.score-g.score);let h="",j=0;for(const g of m){if(j>=o*.9)break;const d=t.substring(g.start,g.end),u=d.length;if(j+u<=o)h&&(h+=`

---

`),h+=d,j+=u+10;else{const p=o-j-10;p>200&&(h&&(h+=`

---

`),h+=d.substring(0,p)+"...");break}}const N=o-j;if(N>500&&h){const g=Math.min(N*.3,500),d=Math.min(N*.2,300),u=t.substring(0,g),p=t.substring(Math.max(0,t.length-d));h=`[Document Introduction]
${u}

---

[Relevant Sections]
${h}

---

[Document Conclusion]
${p}`}else if(!h)return pt(t,Math.floor(o/4));return h}async function Nn(t,n,o){if(!t)return t;const a=o*4;if(t.length<=a)return t;try{const{getRAGContext:j}=await Et(async()=>{const{getRAGContext:g}=await import("./pdfRAG-BUQZRmsO.js");return{getRAGContext:g}},[]),N=await j(t,n,o);if(N&&N.length>100)return N}catch{}const l=Ts(n),m=Ls(l);if(m.length===0)return pt(t,o);const h=$s(t,m,a);return h&&h.length>100?h:pt(t,o)}function pt(t,n){if(!t)return t;const o=n*4;if(t.length<=o)return t;const a=Math.floor(o*.6),l=Math.floor(o*.4),m=t.substring(0,a),h=t.substring(Math.max(0,t.length-l));let j=m;const N=m.lastIndexOf("."),g=m.lastIndexOf(`
`),d=Math.max(N,g);if(d>a*.7)j=m.substring(0,d+1);else{const R=m.lastIndexOf(" ");R>a*.8&&(j=m.substring(0,R))}let u=h;const p=h.indexOf("."),f=h.indexOf(`
`),P=p!==-1&&f!==-1?Math.min(p,f):p!==-1?p:f;if(P!==-1&&P<l*.3)u=h.substring(P+1);else{const R=h.indexOf(" ");R!==-1&&R<l*.2&&(u=h.substring(R+1))}const b=j+`

[... middle content truncated ...]

`+u;if(b.length>o){const R=b.length-o,F=`

[... middle content truncated ...]

`;if(R<=F.length)return j+`

[...]

`+u;const x=Math.floor(R*.6);return j.substring(0,j.length-x)+F+u}return b}function en(t){if(!t)return 0;const n=t.trim().split(/\s+/).length,o=t.length;return Math.ceil(Math.max(n*1.33,o/4))}function Xt(t,n){let o=0;n&&(o+=en(n));for(const a of t){const l=typeof a.content=="string"?a.content:Array.isArray(a.content)&&a.content.find(m=>m.type==="text")?.text||"";o+=en(l),o+=4}return o}function Fn(t,n,o){const a=t.toLowerCase().trim(),l=n.length>0,m=[/^(what|who|when|where|which)\s+(is|are|was|were)\s+\w{1,30}\?*$/i,/^(yes|no|ok|thanks|thank you|got it)/i,/^(explain|define|tell me about)\s+\w{1,20}$/i],h=[/^(it|that|this|they|those|these)/i,/^(also|additionally|furthermore|moreover|and|but)/i,/^(what about|how about|can you|could you|would you)/i,/^(can you|could you|would you)\s+(also|please|again)/i],j=[/(pdf|document|text|chapter|section|page|according to|in the|from the)/i,/(what does.*say|what is.*about|what does the.*say)/i,/(what is this.*about|what is the.*about|what's this.*about|what's the.*about)/i,/(tell me about.*pdf|tell me about.*document|tell me about.*text)/i,/(summarize.*pdf|summarize.*document|summarize.*text)/i,/(explain.*pdf|explain.*document|explain.*text)/i,/(describe.*pdf|describe.*document|describe.*text)/i,/(this pdf|the pdf|this document|the document)/i],N=[/(why|how|explain|analyze|compare|contrast|evaluate|discuss)/i,/(calculate|solve|derive|prove|show|demonstrate)/i,/(relationship|connection|difference|similarity|correlation)/i],g=m.some(S=>S.test(a)),d=l&&h.some(S=>S.test(a)),u=o&&j.some(S=>S.test(a)),p=N.some(S=>S.test(a)),f=/^(what is|what are|define|definition)/i.test(a),P=/(calculate|solve|compute|formula|equation|math)/i.test(a),b=/(compare|contrast|difference|similar|versus|vs)/i.test(a),R=/(what do you mean|clarify|explain.*again|repeat)/i.test(a),F=/(what is|what's|what are|tell me about|summarize|explain|describe).*(about|say|contain|discuss)/i.test(a);let x=0;u?x=.9:F&&o&&!d?x=.85:o&&!g&&!d?x=.4:o&&(x=.2);let v=0;d?v=.9:l&&(R||/^(it|that|this)/i.test(a))?v=.7:l&&(v=.2);let _="detailed";g||f?_="quick":(p||P||b)&&(_="reasoning");const i=o&&(u||F&&!d||!d&&!g&&o),c=l&&(d||R||v>.5);return{needsPdfContext:i,needsChatHistory:c,needsFullContext:i&&c,answerComplexity:_,isClarification:R,isFollowUp:d,isDefinition:f,isCalculation:P,isComparison:b,pdfRelevanceScore:x,historyRelevanceScore:v,classificationMethod:"rule-based",confidence:g||d||u?.9:.6}}async function Ds(t,n,o,a){const l=n.length>0,m=g=>typeof g.content=="string"?g.content:Array.isArray(g.content)&&g.content.find(u=>u.type==="text")?.text||"",h=l?`Previous conversation has ${n.length} messages. Last user message: "${m(n[n.length-1]).substring(0,100)}"`:"No previous conversation history.",j=o?"A PDF document is available as context.":"No PDF document is available.",N={type:"object",properties:{needsPdfContext:{type:"boolean"},needsChatHistory:{type:"boolean"},needsFullContext:{type:"boolean"},answerComplexity:{type:"string",enum:["quick","detailed","reasoning"]},isClarification:{type:"boolean"},isFollowUp:{type:"boolean"},isDefinition:{type:"boolean"},isCalculation:{type:"boolean"},isComparison:{type:"boolean"},pdfRelevanceScore:{type:"number",minimum:0,maximum:1},historyRelevanceScore:{type:"number",minimum:0,maximum:1},confidence:{type:"number",minimum:0,maximum:1}},required:["needsPdfContext","needsChatHistory","needsFullContext","answerComplexity","isClarification","isFollowUp","isDefinition","isCalculation","isComparison","pdfRelevanceScore","historyRelevanceScore","confidence"],additionalProperties:!1};for(const g of hs)try{const d=await fetch(`${Ne}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({messages:[{role:"system",content:`You are a question classification expert. Analyze the user's question and classify it to determine what context is needed for an optimal response. Consider:
- Whether the question is about the PDF document
- Whether the question references previous conversation
- The complexity of the answer needed (quick fact, detailed explanation, or reasoning)
- Question characteristics (clarification, follow-up, definition, calculation, comparison)

${j}
${h}

Output your classification as JSON matching the provided schema.`},{role:"user",content:t}],model:g,temperature:.3,maxTokens:500,response_format:{type:"json_schema",json_schema:{name:"question_classification",schema:N}}})});if(!d.ok)continue;const u=await d.json(),p=JSON.parse(u.choices[0]?.message?.content||"{}");return{...p,classificationMethod:"llm",confidence:p.confidence||.8}}catch{continue}return Fn(t,n,o)}async function _s(t,n,o,a){const l=Fn(t,n,o);if(l.confidence>=.85)return l;try{return await Ds(t,n,o,a)}catch{return l}}function Fs(t,n,o){const a=n==="reasoning";if(t.needsPdfContext&&!t.needsChatHistory){const h=t.answerComplexity==="quick"?a?1500:2e3:t.answerComplexity==="detailed"&&!a?2e3:1500,j=2;return{includePdfContext:!0,pdfContextTokens:h,includeChatHistory:o>0,chatHistoryDepth:j,summarizeOldMessages:o>j,recentMessagesCount:j,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning"}}if(t.needsChatHistory&&!t.needsPdfContext){const h=t.isFollowUp||a?2:5;return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:!0,chatHistoryDepth:h,summarizeOldMessages:o>h,recentMessagesCount:h,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning"}}if(t.answerComplexity==="quick"&&!t.needsPdfContext&&!t.needsChatHistory)return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:o>0,chatHistoryDepth:2,summarizeOldMessages:o>2,recentMessagesCount:2,preferQuickModel:!0,needsReasoning:!1};const l=t.needsPdfContext?t.answerComplexity==="quick"?a?1200:1500:a?1500:t.answerComplexity==="detailed"?2e3:1500:0,m=t.needsChatHistory?a||t.isFollowUp?2:5:2;return{includePdfContext:t.needsPdfContext,pdfContextTokens:l,includeChatHistory:o>0,chatHistoryDepth:m,summarizeOldMessages:o>m,recentMessagesCount:m,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning"}}function Rs(t,n=!1){if(t.length===0)return{role:"system",content:""};const o=[],a=n?50:80,l=n?80:120;for(let j=0;j<t.length;j+=2){const N=t[j],g=t[j+1];if(N&&N.role==="user"){const d=typeof N.content=="string"?N.content:Array.isArray(N.content)&&N.content.find(u=>u.type==="text")?.text||"";if(d.trim()){const u=d.length>a?d.substring(0,a)+"...":d;o.push(`Q: ${u}`)}}if(g&&g.role==="assistant"){const d=typeof g.content=="string"?g.content:Array.isArray(g.content)&&g.content.find(u=>u.type==="text")?.text||"";if(d.trim()){const u=d.length>l?d.substring(0,l)+"...":d;o.push(`A: ${u}`)}}}return{role:"system",content:`${n?`[Prev (${t.length})]`:`[Previous conversation (${t.length} msgs)]`}:
${o.join(`
`)}`}}function Sn(t){return typeof t=="string"?t.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim():Array.isArray(t)?t.map(n=>{if(n.type==="text"&&n.text){const o=n.text.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim();return{...n,text:o}}return n}).filter(n=>!(n.type==="text"&&n.text&&n.text.trim()==="")):t}function At(t){if(!t)return{thinking:null,mainContent:t};const n="__REASONING_START__",o="__REASONING_END__",a=t.indexOf(n),l=t.indexOf(o);if(a!==-1&&l!==-1&&l>a){const p=a+n.length,f=t.substring(p,l).trim(),P=t.substring(l+o.length).trim();return{thinking:f||null,mainContent:P}}const m=t.indexOf("<think>"),h=t.lastIndexOf("</think>");if(m===-1||h===-1||h<=m)return{thinking:null,mainContent:t};const j=m+7,N=t.substring(j,h).trim(),g=t.substring(0,m),d=t.substring(h+8),u=(g+d).trim();return{thinking:N||null,mainContent:u}}function Os({selectedText:t,pdfText:n,layout:o,currentPageNumber:a,onCreateKnowledgeNote:l,onClearSelectedText:m,onAddAnnotationToPDF:h,onOpenKnowledgeNotes:j,onToggleKnowledgeNotes:N,showKnowledgeNotes:g,onModeChange:d,resetModeRef:u,modelMode:p,onModelModeChange:f}){const{theme:P}=Vt(),{isAuthenticated:b,user:R,loading:F}=It();r.useEffect(()=>{const s=console.warn;return console.warn=(...$)=>{const E=$.map(M=>{if(typeof M=="string")return M;if(M&&typeof M=="object")try{return JSON.stringify(M)}catch{return String(M)}return String(M)}).join(" ");E.includes("No character metrics")&&(E.includes("â€‘")||E.includes("8209")||E.includes("U+2011"))||E.includes("Unrecognized Unicode character")&&(E.includes("â€‘")||E.includes("8209")||E.includes("U+2011"))||E.includes("LaTeX-incompatible input")&&(E.includes("â€‘")||E.includes("8209")||E.includes("U+2011"))||E.includes("unknownSymbol")&&(E.includes("â€‘")||E.includes("8209")||E.includes("U+2011"))||s.apply(console,$)},()=>{console.warn=s}},[]);const[x,v]=r.useState([]),[_,i]=r.useState({}),[c,y]=r.useState({}),[S,L]=r.useState({}),[B,U]=r.useState({}),[T,V]=r.useState(""),[H,ee]=r.useState(!1),[ue,ie]=r.useState(null),[je,lt]=r.useState(!0),[I,ne]=r.useState(!0),[q,le]=r.useState(!0),[w,D]=r.useState(null),[k,K]=r.useState(p||"auto"),[X,te]=r.useState(!1),[se,pe]=r.useState(null),[xe,Te]=r.useState([]),[Ge,Ye]=r.useState(!1),[kt,ct]=r.useState(!1),[bt,be]=r.useState(!1),[ht,Je]=r.useState({}),[Xe,wt]=r.useState(!1),Le=r.useRef(null),[Ee,Ze]=r.useState(()=>{const s=localStorage.getItem("chatnote-interaction-mode");return s||null}),[fe,Ue]=r.useState(null),[Kt,zt]=r.useState(!1),[Bt,ft]=r.useState(!1),qe=r.useRef(null),Ve=r.useRef(null),Qe=r.useRef({}),Ke=r.useRef(null),dt=r.useRef(null),$e=r.useRef(null),Wt=r.useRef(null),A=r.useRef(null),z=r.useRef(null),[oe,re]=r.useState(null),[ke,Ie]=r.useState(null),De=(s=!0,$=!1)=>{if(z.current){const E=z.current;(E.scrollHeight-E.scrollTop-E.clientHeight<100||$)&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!z.current)return;const M=z.current;s?Ke.current?Ke.current.scrollIntoView({behavior:"smooth"}):M.scrollTo({top:M.scrollHeight,behavior:"smooth"}):Ke.current?Ke.current.scrollIntoView({behavior:"auto"}):M.scrollTop=M.scrollHeight})})}},et=()=>{const s=dt.current;if(s){s.style.height="auto";const C=Math.min(Math.max(s.scrollHeight,24),200);s.style.height=`${C}px`}},Se=r.useRef(0),Fe=r.useRef(null);r.useEffect(()=>{const s=x.length,$=Se.current,C=(x.length>0?x[x.length-1]:null)?.role||null;s>$?C==="user"?De(!0,!0):De(!0):s===$&&H&&De(!1),Se.current=s,Fe.current=C},[x,H]),r.useEffect(()=>{if(!z.current||!H)return;const s=z.current;let $=s.scrollHeight,E=null;const C=new ResizeObserver(()=>{if(!z.current)return;const M=z.current.scrollHeight,O=z.current.scrollHeight-z.current.scrollTop-z.current.clientHeight<100;M>$&&O?(E&&clearTimeout(E),E=setTimeout(()=>{De(!1),$=M},50)):$=M});return C.observe(s),()=>{C.disconnect(),E&&clearTimeout(E)}},[H]),r.useEffect(()=>()=>{Le.current&&clearTimeout(Le.current)},[]),r.useEffect(()=>{dt.current?.focus(),et()},[]),r.useEffect(()=>{const s=setTimeout(()=>{et()},0);return()=>clearTimeout(s)},[T]);const _e=async()=>{if(b){ne(!0);try{const s=await _n();lt(!s)}catch(s){console.warn("API key check failed:",s)}finally{ne(!1)}}else lt(!0),ne(!1)};r.useEffect(()=>{_e();const s=setInterval(()=>{b&&_e()},1e4);return()=>clearInterval(s)},[b]),r.useEffect(()=>{o==="split"&&(le(!1),D(null))},[o]),r.useEffect(()=>{o==="floating"&&!q&&w!==null&&z.current&&requestAnimationFrame(()=>{z.current&&(z.current.scrollTop=w)})},[q,o,w]),r.useEffect(()=>{if(o!=="floating"){re(null);return}const s=()=>{const $=window.innerHeight,E=window.innerWidth<=768?70:90,C=60,M=400,O=$-C-E;if(O<M)le(!0),re(null);else if(q)re(null);else{const Y=Math.min(O-200,600);re(Math.max(Y,300))}};return s(),window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s)}},[o,q]),r.useEffect(()=>{if(!se||!z.current||!A.current){Ie(null);return}const s=()=>{const E=z.current,C=A.current;if(!E||!C)return;const M=E.clientHeight,O=window.innerHeight,Y=Math.min(O*.7,600)+40;if(Y<=M)Ie(null);else{const ae=C.clientHeight-M,Z=Y+ae;Ie(Z)}},$=setTimeout(s,100);return window.addEventListener("resize",s),()=>{clearTimeout($),window.removeEventListener("resize",s)}},[se]);const vt=()=>{switch(k){case"auto":return xt[0];case"reasoning":return yt[0];case"advanced":return Rt.primary}},jt=s=>{K(s),f&&f(s),s!=="auto"&&xe.length>0&&Te([])},gt=()=>{if(k!=="auto")return!1;const s=vt();return s==="meta-llama/llama-4-scout-17b-16e-instruct"||s==="meta-llama/llama-4-maverick-17b-128e-instruct"};r.useEffect(()=>{!gt()&&xe.length>0&&Te([])},[k]),r.useEffect(()=>{p&&p!==k&&K(p)},[p]);const rn=s=>{Array.from(s).forEach(E=>{if(!E.type.startsWith("image/")){ie("Please upload image files only.");return}const C=new FileReader;C.onload=M=>{const O=M.target?.result;O&&Te(J=>[...J,O])},C.onerror=()=>{ie("Failed to read image file.")},C.readAsDataURL(E)})},an=s=>{const $=s.target.files;!$||$.length===0||(rn($),qe.current&&(qe.current.value=""))},zn=s=>{gt()&&(s.preventDefault(),s.stopPropagation(),Ye(!0))},Bn=s=>{gt()&&(s.preventDefault(),s.stopPropagation(),Ye(!1))},Wn=s=>{if(!gt())return;s.preventDefault(),s.stopPropagation(),Ye(!1);const $=s.dataTransfer.files;$&&$.length>0&&rn($)},Ct=()=>{const s=Ve.current;if(!s){ct(!1),be(!1);return}ct(s.scrollLeft>0),be(s.scrollLeft<s.scrollWidth-s.clientWidth-1)},ln=s=>{const $=Ve.current;if(!$)return;const E=200,C=s==="left"?$.scrollLeft-E:$.scrollLeft+E;$.scrollTo({left:C,behavior:"smooth"})},Ht=s=>{const $=Qe.current[s];if(!$){Je(M=>({...M,[s]:{canScrollLeft:!1,canScrollRight:!1}}));return}const E=$.scrollLeft>0,C=$.scrollLeft<$.scrollWidth-$.scrollWidth-1;Je(M=>({...M,[s]:{canScrollLeft:E,canScrollRight:C}}))},cn=(s,$)=>{const E=Qe.current[s];if(!E)return;const C=200,M=$==="left"?E.scrollLeft-C:E.scrollLeft+C;E.scrollTo({left:M,behavior:"smooth"})};r.useEffect(()=>{const s=setTimeout(()=>{Ct()},0),$=Ve.current;return $?($.addEventListener("scroll",Ct),window.addEventListener("resize",Ct),()=>{clearTimeout(s),$.removeEventListener("scroll",Ct),window.removeEventListener("resize",Ct)}):()=>{clearTimeout(s)}},[xe]),r.useEffect(()=>{const s=setTimeout(()=>{Object.keys(Qe.current).forEach(E=>{Ht(E)})},0),$=()=>{Object.keys(Qe.current).forEach(E=>{Ht(E)})};return window.addEventListener("resize",$),()=>{clearTimeout(s),window.removeEventListener("resize",$)}},[x]);const dn=async()=>{const s=T.trim(),$=xe.length>0;if(!s&&!t&&!$)return;if(!b){ie("Please sign in to use the chat feature.");return}if(je){ie("Please configure your Groq API key in Settings.");return}q&&le(!1),$e.current&&$e.current.abort(),$e.current=new AbortController;const E=Date.now(),C=!!t;he.trackQuerySubmitted(k,o,C);let M=s;t&&!s?M=`Tell me about this: ${t}`:t&&s&&(M=`${s}

Context from PDF: ${t}`);let O;if(gt()&&xe.length>0){const Q=[];M&&Q.push({type:"text",text:M}),xe.forEach(G=>{Q.push({type:"image_url",image_url:{url:G}})}),O=Q}else O=M;const J=window.__lastSelectedTextPosition,Y={id:Date.now().toString(),role:"user",content:O,selectedTextAtSend:t||void 0,pageNumberAtSend:J?.pageNumber,textYPositionAtSend:J?.textYPosition};v(Q=>[...Q,Y]),V(""),Te([]),setTimeout(()=>{et()},0),ee(!0),ie(null),requestAnimationFrame(()=>{requestAnimationFrame(()=>{De(!0,!0)})});const ae=k==="reasoning",Z=n&&n.trim().length>0||!!t,Re=s||(t?`Tell me about: ${t}`:""),ze=localStorage.getItem("auth_token")||"";let Me,Ae;try{Me=await _s(Re,x,Z,ze),Ae=Fs(Me,k,x.length)}catch(Q){console.warn("[Smart Router] Classification failed, using default routing:",Q),Ae={includePdfContext:Z,pdfContextTokens:ae?1500:2e3,includeChatHistory:!0,chatHistoryDepth:ae?2:5,summarizeOldMessages:x.length>(ae?2:5),recentMessagesCount:ae?2:5,preferQuickModel:!1,needsReasoning:!1}}let ye;Ae.includePdfContext&&Ae.pdfContextTokens>0&&(t&&!s?ye=pt(t,Ae.pdfContextTokens):n&&n.trim().length>0?s&&s.trim().length>0?ye=await Nn(n,s,Ae.pdfContextTokens):ye=pt(n,Ae.pdfContextTokens):t&&s&&(ye=pt(t,Ae.pdfContextTokens)));const We=(Date.now()+1).toString(),Tt=Y.selectedTextAtSend,Nt={id:We,role:"assistant",content:"",selectedTextAtSend:Tt,pageNumberAtSend:Y.pageNumberAtSend,textYPositionAtSend:Y.textYPositionAtSend};v(Q=>[...Q,Nt]),requestAnimationFrame(()=>{requestAnimationFrame(()=>{De(!0,!0)})});try{let Q=[];if(Ae.includeChatHistory&&x.length>0){const ge=x.length,W=Ae.recentMessagesCount;if(ge>W&&Ae.summarizeOldMessages){const me=x.slice(0,ge-W),ve=x.slice(-W);Q=[Rs(me,ae),...ve.map(Ce=>({role:Ce.role,content:Ce.content}))]}else ge<=W?Q=x.map(me=>({role:me.role,content:me.content})):Q=x.slice(-W).map(me=>({role:me.role,content:me.content}))}else Q=[];const G=Xt([...Q,Y],ye),Oe={"openai/gpt-oss-120b":7e3,"openai/gpt-oss-20b":7e3,"qwen/qwen3-32b":5e3},we=vt(),de=Oe[we]||8e3;if(G>de&&ye){const ge=de/G,W=Math.floor(en(ye)*ge*.9);ye=pt(ye,W)}const Pe={role:"system",content:'You are a mathematical assistant. All mathematical equations you generate must be 100% compatible with the KaTeX rendering engine.\n\nFollow these strict rules:\n\n1. **Delimiters:**\n   * For block-level equations (on their own line), **must** use `$$...$$` delimiters.\n   * For inline equations (inside a sentence), **must** use `\\(...\\)` delimiters.\n   * **Do not** use single `$` or `\\[...\\]` delimiters.\n\n2. **Alignment (Crucial):**\n   * To align multiple equations, **must** use the `aligned` environment.\n   * **Do not** use the `align`, `align*`, or `eqnarray` environments, as they are not supported.\n   * Example of a correct multi-line equation:\n     ```\n     $$\n     \\begin{aligned}\n     a &= b + c \\\\\n     d &= e + f\n     \\end{aligned}\n     $$\n     ```\n\n3. **General Formatting:**\n   * Use standard, common LaTeX commands.\n   * To write plain text inside math, **must** use `\\text{...}`.\n   * To create a fraction, **must** use `\\frac{...}{...}`.\n   * To create a matrix or case, use the `pmatrix`, `bmatrix`, or `cases` environments.\n   * **Do not** use complex, obscure, or custom LaTeX packages. Stick to `amsmath`-style commands that are known to be supported by KaTeX.\n\n4. **Dollar Amounts and Numbers:**\n   * For dollar amounts in text (e.g., "$40,000", "$1,000"), use plain text with commas, NOT math delimiters.\n   * **Always include spaces** before and after dollar amounts when they appear in sentences (e.g., "between $40,000 and $42,000", not "between $40,000and$42,000").\n   * **Do not** wrap dollar amounts in `$` delimiters unless they are part of a mathematical expression.\n   * For consistency, use the same formatting style for similar phrases (e.g., if you use "no smaller than" in normal text, use "no larger than" in the same style, not italic).\n\n5. **Text Formatting Consistency:**\n   * Use consistent markdown formatting for similar phrases.\n   * If you use italic (`*text*`) for emphasis, use it consistently for similar phrases.\n   * **Always preserve spaces** between numbers and words (e.g., "1,000 and", not "1,000and$42,000").\n   * **Do not** wrap dollar amounts in `$` delimiters unless they are part of a mathematical expression.\n   * For consistency, use the same formatting style for similar phrases (e.g., if you use "no smaller than" in normal text, use "no larger than" in the same style, not italic).'},Be=Q.length>0&&Q[0]?.role==="system"?Q:[Pe,...Q];let St=Xt([...Be,Y],ye);if(St>de&&Be.length>1){const ge=Be[0]?.role==="system"?Be[0]:null,W=ge?Be.slice(1):Be,me=W[0],ce=W.slice(1).slice(-2);Q=me?.content?ge?[ge,me,...ce]:[me,...ce]:ge?[ge,...ce]:ce,St=Xt([...Q,Y],ye)}else Q=Be;St>de&&ye&&(ye=void 0);let He="";const qt=Y,pn=Ot([...Q,qt],ye,ge=>{if($e.current?.signal.aborted)return;He+=ge;const{thinking:W,mainContent:me}=At(He),ve=W&&W.trim().length>0;v(ae||k==="advanced"&&ve?ce=>ce.map(Ce=>Ce.id===We?{...Ce,content:me||He,thinking:ve?W:Ce.thinking}:Ce):ce=>ce.map(Ce=>Ce.id===We?{...Ce,content:He}:Ce)),De(!1)},we,$e.current?.signal,ae);pn.catch(ge=>{if(!(ge instanceof DOMException&&ge.name==="AbortError"))throw ge});const xn=await pn,{thinking:tt,mainContent:Mt}=At(xn);let Lt=tt,Yt=Mt;if(tt&&(!Mt||Mt.trim().length===0)){const ge=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let W=null;for(const me of ge){const ve=tt.match(me);if(ve&&ve[1]){const ce=tt.indexOf(ve[0]),Ce=tt.substring(ce+ve[0].length);let Pt=ve[1].trim();const yn=Ce.match(/^([^.!?]*[.!?]+)/);if(yn)Pt+=yn[1];else{const mt=Ce.match(/^([^\n]+)/);mt&&(Pt+=mt[1])}if(W=Pt.trim(),W&&!W.match(/^[A-Z"']/)){const wn=tt.substring(Math.max(0,ce-200),ce).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);wn&&(W=wn[2]+W)}if(W.length>300){const mt=W.match(/[^.!?]*[.!?]+/g);mt&&mt.length>0?(W=mt.slice(0,2).join(" ").trim(),mt.length>2&&(W+="...")):W=W.substring(0,300).trim()+"..."}break}}if(!W){const me=tt.split(/\n\n+/).filter(ve=>ve.trim().length>0);if(me.length>0){for(let ve=me.length-1;ve>=0;ve--){const ce=me[ve].trim();if(!ce.match(/^(?:Step \d+|## Step|\d+\.)/i)&&ce.length>50){const Ce=ce.match(/[^.!?]*[.!?]+/g);if(Ce&&Ce.length>0?W=Ce.slice(-2).join(" ").trim():W=ce,W.length>300){const Pt=Ce?Ce.slice(0,2).join(" ").trim():null;Pt?W=Pt+(Ce&&Ce.length>2?"...":""):W=ce.substring(0,300).trim()+"..."}break}}if(!W&&me.length>0){const ve=me[me.length-1].trim(),ce=ve.match(/[^.!?]*[.!?]+/g);ce&&ce.length>0?(W=ce.slice(-2).join(" ").trim(),W.length>300&&(W=ce.slice(0,2).join(" ").trim()+(ce.length>2?"...":""))):(W=ve,W.length>300&&(W=ve.substring(0,300).trim()+"..."))}}}W&&(W=W.replace(/\$\\([0-7]{1,3})(\d[^$]*)\$/g,(me,ve,ce)=>`$${ve}${ce}$`),W=W.replace(/\$\\\$(\d[^$]*)\$/g,"$$$1$"),W=W.replace(/\\\$(\d[^$]*?)(?=\s|$|,|\.|;)/g,"$$$1$")),Yt=W||"",Lt=tt}else tt&&Mt&&tt.trim()===Mt.trim()&&(Lt=null,Yt=Mt);const Jt=Lt&&Lt.trim().length>0,Qt={content:Yt||(Jt?"":xn),thinking:Jt&&Lt||void 0,timestamp:Date.now()};L(ge=>{const me=[...ge[We]||[],Qt],ve=me.length-1;return U(ce=>({...ce,[We]:ve})),{...ge,[We]:me}}),v(ae||k==="advanced"&&Jt?ge=>ge.map(W=>W.id===We?{...W,content:Qt.content,thinking:Qt.thinking}:W):ge=>ge.map(W=>W.id===We?{...W,content:Qt.content,thinking:void 0}:W))}catch(Q){if(!(Q instanceof DOMException&&Q.name==="AbortError")){console.error("Error sending message (details logged, user sees sanitized message):",Q);const G=Q instanceof Error?Q.message:"Unable to send message. Please try again.";ie(G),v(we=>we.filter(de=>de.id!==We)),(G.toLowerCase().includes("timeout")||G.toLowerCase().includes("timed out"))&&await he.trackError("ai_timeout",`Model: ${k}, Error: ${G}`)}}finally{const Q=Date.now()-E;he.trackAIResponse(k,Q),ee(!1),$e.current=null,dt.current?.focus()}},Hn=()=>{$e.current&&($e.current.abort(),$e.current=null,ee(!1),dt.current?.focus())},qn=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),dn())},Qn=()=>{t&&(V(`Tell me about this: ${t}`),dt.current?.focus())},Gn=async s=>{const $=x.findIndex(O=>O.id===s);if($===-1||x[$].role!=="assistant")return;let E=$-1;for(;E>=0&&x[E].role!=="user";)E--;if(E<0)return;const C=x[E],M=k==="reasoning";v(O=>O.map(J=>J.id===s?{...J,content:"",thinking:void 0}:J)),ee(!0),$e.current&&$e.current.abort(),$e.current=new AbortController;try{const O=typeof C.content=="string"?C.content:C.content.filter(Q=>Q.type==="text").map(Q=>Q.text).join(`
`),J=C.selectedTextAtSend,Y=x.slice(0,$).map(Q=>({role:Q.role,content:Q.content}));let ae;n&&n.trim().length>0&&(J?ae=J:ae=await Nn(n,O,M?1500:2e3));let Z;k==="auto"?Z=xt[0]:k==="reasoning"?Z=yt[0]:Z=Rt.primary;let Re="";const ze=await Ot([...Y,C],ae,Q=>{if($e.current?.signal.aborted)return;Re+=Q;const{thinking:G,mainContent:Oe}=At(Re),we=G&&G.trim().length>0;v(M||k==="advanced"&&we?de=>de.map(Pe=>Pe.id===s?{...Pe,content:Oe||Re,thinking:we?G:Pe.thinking}:Pe):de=>de.map(Pe=>Pe.id===s?{...Pe,content:Re}:Pe)),De(!1)},Z,$e.current.signal,M),{thinking:Me,mainContent:Ae}=At(ze),ye=Me&&Me.trim().length>0;let We=Me,Tt=Ae;if(k==="advanced"&&ye)if(Me&&(!Ae||Ae.trim().length===0)){const Q=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let G=null;for(const Oe of Q){const we=Me.match(Oe);if(we&&we[1]){const de=Me.indexOf(we[0]),Pe=Me.substring(de+we[0].length);let Be=we[1].trim();const St=Pe.match(/^([^.!?]*[.!?]+)/);if(St)Be+=St[1];else{const He=Pe.match(/^([^\n]+)/);He&&(Be+=He[1])}if(G=Be.trim(),G&&!G.match(/^[A-Z"']/)){const qt=Me.substring(Math.max(0,de-200),de).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);qt&&(G=qt[2]+G)}if(G.length>300){const He=G.match(/[^.!?]*[.!?]+/g);He&&He.length>0?(G=He.slice(0,2).join(" ").trim(),He.length>2&&(G+="...")):G=G.substring(0,300).trim()+"..."}break}}if(!G){const Oe=Me.split(/\n\n+/).filter(we=>we.trim().length>0);if(Oe.length>0){for(let we=Oe.length-1;we>=0;we--){const de=Oe[we].trim();if(!de.match(/^(?:Step \d+|## Step|\d+\.)/i)&&de.length>50){const Pe=de.match(/[^.!?]*[.!?]+/g);if(Pe&&Pe.length>0?G=Pe.slice(-2).join(" ").trim():G=de,G.length>300){const Be=Pe?Pe.slice(0,2).join(" ").trim():null;Be?G=Be+(Pe&&Pe.length>2?"...":""):G=de.substring(0,300).trim()+"..."}break}}if(!G&&Oe.length>0){const we=Oe[Oe.length-1].trim(),de=we.match(/[^.!?]*[.!?]+/g);de&&de.length>0?(G=de.slice(-2).join(" ").trim(),G.length>300&&(G=de.slice(0,2).join(" ").trim()+(de.length>2?"...":""))):(G=we,G.length>300&&(G=we.substring(0,300).trim()+"..."))}}}Tt=G||"",We=Me}else Me&&Ae&&Me.trim()===Ae.trim()&&(We=null,Tt=Ae);const Nt={content:Tt||(ye?"":ze),thinking:ye&&We||void 0,timestamp:Date.now()};L(Q=>{const Oe=[...Q[s]||[],Nt];return U(we=>{const de=Oe.length-1;return{...we,[s]:de}}),{...Q,[s]:Oe}}),v(M||k==="advanced"&&ye?Q=>Q.map(G=>G.id===s?{...G,content:Nt.content,thinking:Nt.thinking}:G):Q=>Q.map(G=>G.id===s?{...G,content:Nt.content,thinking:void 0}:G))}catch(O){if(!(O instanceof DOMException&&O.name==="AbortError")){console.error("Error resending message:",O),ie(O instanceof Error?O.message:"Unable to resend message. Please try again.");const J=S[s]||[];if(J.length>0){const Y=J[J.length-1];v(ae=>ae.map(Z=>Z.id===s?{...Z,content:Y.content,thinking:Y.thinking}:Z))}}}finally{ee(!1),$e.current=null}},un=(s,$)=>{const E=S[s]||[];if(E.length===0)return;const C=B[s]??E.length-1;let M=C;if($==="prev"?M=Math.max(0,C-1):M=Math.min(E.length-1,C+1),M===C)return;U(J=>({...J,[s]:M}));const O=E[M];O&&v(J=>J.map(Y=>Y.id===s?{...Y,content:O.content,thinking:O.thinking}:Y))},hn=s=>{let $="";typeof s=="string"?$=s:Array.isArray(s)&&($=s.find(O=>O.type==="text")?.text||"");const E=$.match(/^(.+?)\n\nContext from PDF:\s*(.+)$/s);if(E)return{mainQuestion:E[1].trim(),pdfContext:E[2].trim()};const C=$.match(/^Tell me about this:\s*(.+)$/s);return C?{mainQuestion:"",pdfContext:C[1].trim()}:{mainQuestion:$.trim()}},fn=()=>{const s=window.getSelection();if(!s||s.rangeCount===0)return null;const $=s.toString().trim();if(!$)return null;const C=s.getRangeAt(0).commonAncestorContainer;return(C.nodeType===Node.TEXT_NODE?C.parentElement?.closest(".message-assistant, .message-user"):C?.closest(".message-assistant, .message-user"))?$:null},gn=()=>{Xe?(v([]),ie(null),wt(!1),Le.current&&(clearTimeout(Le.current),Le.current=null)):(wt(!0),Le.current&&clearTimeout(Le.current),Le.current=setTimeout(()=>{wt(!1),Le.current=null},3e3))},Un=s=>{Ze(s),s==="quiz-me"&&ft(!0),d?.(s)},Vn=()=>{Ze(null),d?.(null)},Kn=()=>{ft(!1),Ze(null),d?.(null)};r.useEffect(()=>{u&&(u.current=Vn)},[u]),r.useEffect(()=>{Ee?localStorage.setItem("chatnote-interaction-mode",Ee):localStorage.removeItem("chatnote-interaction-mode")},[Ee]),r.useEffect(()=>{Ee&&d?.(Ee)},[Ee,d]),r.useEffect(()=>{Ee==="quiz-me"&&!fe&&ft(!0)},[]);const Yn=async(s,$)=>{if(!n){ie("Please load a PDF document first");return}ft(!1),Ue(null),zt(!0),ie(null);try{const E=await Ps(n,{count:s,difficulty:"medium",questionTypes:$});Ue({questions:E,currentQuestionIndex:0,score:0,answers:new Map,startTime:new Date,isComplete:!1})}catch(E){ie(E instanceof Error?E.message:"Failed to generate quiz"),Ze(null)}finally{zt(!1)}},Jn=async(s,$)=>{if(!fe)return;const E=fe.questions[fe.currentQuestionIndex],C=await Ut(E,$),M=new Map(fe.answers);M.set(s,$);const O=C.isCorrect?fe.score+1:fe.score,J=fe.currentQuestionIndex===fe.questions.length-1;Ue({...fe,answers:M,score:O,currentQuestionIndex:J?fe.currentQuestionIndex:fe.currentQuestionIndex+1,isComplete:J,endTime:J?new Date:void 0})},Xn=()=>{Ue(null),ft(!0)},Zn=()=>{fe?Ue({...fe,currentQuestionIndex:0,score:0,answers:new Map,startTime:new Date,endTime:void 0,isComplete:!1}):(Ue(null),ft(!0))},mn=()=>{Ue(null),Ze(null),d?.(null)},es=(s,$,E)=>{if(s.pageReference){const C=`Quiz Question: ${s.question}

Your Answer: ${$}
${E?"âœ“ Correct!":"âœ— Incorrect"}

Explanation: ${s.explanation}`;h?.(C,s.pageReference,.5)}else{const C=a||1,M=`Quiz Question: ${s.question}

Your Answer: ${$}
${E?"âœ“ Correct!":"âœ— Incorrect"}

Explanation: ${s.explanation}`;h?.(M,C,.5)}},ts=(s,$,E)=>{const C=s.pageReference||a||1;let M="N/A";if(s.type==="multiple-choice"&&s.options){const J=s.options.find(Y=>Y.isCorrect);M=J?J.text:"N/A"}else Array.isArray(s.correctAnswer)?M=s.correctAnswer.join(", "):M=s.correctAnswer;const O=`**Quiz Question** ${E?"âœ“":"âœ—"}

${s.question}

**Correct Answer:** ${M}

**Explanation:** ${s.explanation}`;l?.(O,s.question,C,.5,`quiz-${s.id}`)};return e.jsx("div",{className:"chatgpt-wrapper",children:n&&e.jsxs(e.Fragment,{children:[!Ee&&e.jsx(Ms,{onModeSelect:Un}),Ee==="quiz-me"&&e.jsxs(e.Fragment,{children:[Bt&&e.jsx(Is,{onStartQuiz:Yn,onBack:Kn}),Kt&&e.jsxs("div",{className:"quiz-loading",children:[e.jsx("div",{className:"quiz-loading-spinner"}),e.jsx("p",{children:"Generating quiz questions..."})]}),fe&&!Bt&&e.jsx(Es,{session:fe,onAnswer:Jn,onNextQuestion:()=>{fe.currentQuestionIndex<fe.questions.length-1&&Ue({...fe,currentQuestionIndex:fe.currentQuestionIndex+1})},onPreviousQuestion:()=>{fe.currentQuestionIndex>0&&Ue({...fe,currentQuestionIndex:fe.currentQuestionIndex-1})},onRequestMore:(s,$)=>Xn(),onFinish:mn,onRestart:Zn,onAddToPDF:es,onAddToNotes:ts,onExitReview:mn})]}),(!Ee||Ee==="guide-me-learn")&&e.jsxs(e.Fragment,{children:[!F&&!b&&o==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!F&&b&&!I&&je&&o==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:R?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:s=>{s.preventDefault(),s.stopPropagation(),_e()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),o==="floating"&&e.jsxs("div",{className:`model-selector-bar ${P==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:Wt,children:[e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(bn,{mode:k,onModeChange:jt,disabled:je})}),gt()&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:qe,type:"file",accept:"image/*",multiple:!0,onChange:an,style:{display:"none"}}),e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),qe.current?.click()},className:"image-upload-button",title:"Upload images",disabled:je,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]}),e.jsx("span",{className:"image-upload-text",children:"Image"})]})]})]}),e.jsxs("div",{className:"header-actions",children:[x.length>0&&e.jsxs("button",{onClick:gn,className:`clear-button ${Xe?"confirming":""}`,title:Xe?"Click again to confirm":"Clear chat",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:Xe?"Confirm":"Clear"})]}),o==="floating"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:N,className:"notes-toggle-button collapse-button",title:g?"Hide knowledge notes":"Show knowledge notes",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsx("button",{onClick:()=>{q||z.current&&D(z.current.scrollTop),le(!q)},className:"collapse-button",title:q?"Expand chat":"Collapse chat","aria-label":q?"Expand chat":"Collapse chat",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{transform:q?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx("path",{d:"M18 15l-6-6-6 6"})})})]})]})]}),e.jsxs("div",{ref:A,className:`chatgpt-inner ${P==="dark"?"theme-dark":"theme-light"} ${q&&o==="floating"?"collapsed":""}`,style:{...ke?{maxHeight:`${ke}px`}:o==="floating"&&!q&&oe?{maxHeight:`${oe}px`}:{}},children:[t&&e.jsxs("div",{className:"selected-text-banner",children:[e.jsxs("span",{className:"banner-text",children:["Selected Text: ",t.length>20?`${t.substring(0,20)}...`:t]}),e.jsxs("div",{className:"banner-buttons",children:[e.jsx("button",{onClick:Qn,className:"use-text-button",children:"Tell me more"}),m&&e.jsx("button",{onClick:m,className:"close-text-button",title:"Clear selection",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(!q||o==="split")&&e.jsxs("div",{ref:z,className:"chatgpt-messages",children:[x.length===0&&e.jsxs("div",{className:"welcome-screen",children:[e.jsx("div",{className:"welcome-icon",children:e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z",fill:"#10a37f",opacity:"0.1"}),e.jsx("path",{d:"M6 9H18M6 13H14",stroke:"#10a37f",strokeWidth:"2",strokeLinecap:"round"})]})}),e.jsx("h3",{children:"How can I help you today?"}),e.jsx("p",{children:"Ask me anything about your PDF, or select text to get context-specific answers."})]}),x.map((s,$)=>{const E=s.role==="assistant"&&$===x.length-1;return e.jsxs("div",{className:`message ${s.role==="user"?"message-user":"message-assistant"}`,children:[e.jsx("div",{className:"message-avatar",children:s.role==="user"?e.jsx("div",{className:"avatar-user",children:R?.picture?e.jsx("img",{src:R.picture,alt:R.name||R.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:C=>{const M=C.target;M.style.display="none";const O=M.parentElement;if(O){const J=O.querySelector("span.avatar-fallback");J&&J.remove();const Y=document.createElement("span");Y.className="avatar-fallback",Y.textContent=R.name?.[0]?.toUpperCase()||R.email[0].toUpperCase(),O.appendChild(Y)}}}):e.jsx("span",{className:"avatar-fallback",children:R?.name?.[0]?.toUpperCase()||R?.email?.[0]?.toUpperCase()||"U"})}):e.jsx("div",{className:"avatar-assistant",children:e.jsx("img",{src:Ss,alt:"ChatNote",className:"assistant-avatar-img",onError:C=>{const M=C.target;M.style.display="none";const O=M.parentElement;if(O){const J=O.querySelector("svg.avatar-fallback-svg");J&&J.remove();const Y=document.createElementNS("http://www.w3.org/2000/svg","svg");Y.setAttribute("width","32"),Y.setAttribute("height","32"),Y.setAttribute("viewBox","0 0 24 24"),Y.setAttribute("fill","none"),Y.setAttribute("class","avatar-fallback-svg");const ae=document.createElementNS("http://www.w3.org/2000/svg","path");ae.setAttribute("d","M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"),ae.setAttribute("fill","currentColor"),Y.appendChild(ae),O.appendChild(Y)}}})})}),e.jsxs("div",{className:"message-content-wrapper",children:[e.jsx("div",{className:"message-content",children:s.role==="assistant"&&H&&!s.content&&E?e.jsxs("div",{className:"typing-indicator",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]}):s.role==="assistant"&&s.content?e.jsxs(e.Fragment,{children:[(k==="reasoning"||k==="advanced")&&s.thinking&&s.thinking.trim().length>0?e.jsxs("div",{className:"thinking-process-container",children:[e.jsxs("button",{className:`thinking-toggle-button ${_[s.id]?"expanded":""}`,onClick:()=>{i(C=>({...C,[s.id]:!(C[s.id]??!1)}))},title:_[s.id]?"Collapse thinking":"Expand thinking",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:_[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Thinking Process"}),H&&E&&!_[s.id]&&e.jsx("span",{style:{marginLeft:"8px",fontSize:"12px",opacity:.7},children:"(generating...)"})]}),_[s.id]&&s.thinking?e.jsxs("div",{className:"thinking-content expanded",children:[e.jsx("div",{className:"markdown-content",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],children:(()=>{try{const C=at(s.thinking||"");return C.includes("â€‘")?C.replace(/\u2011/g,"-"):C||""}catch(C){return console.error("Error preprocessing thinking content:",C),(s.thinking||"").replace(/\u2011/g,"-")}})()})}),H&&E&&e.jsxs("div",{className:"typing-indicator",style:{marginTop:"12px"},children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})]}):null]}):null,s.content&&(typeof s.content!="string"||s.content.trim().length>0)?e.jsx("div",{className:"markdown-content",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],components:{table:({children:C,...M})=>e.jsx("div",{className:"table-scroll-wrapper",children:e.jsx("table",{...M,children:C})}),div:({children:C,className:M,...O})=>M&&typeof M=="string"&&M.includes("katex-display")&&!M.includes("math-scroll-wrapper")?e.jsx("div",{className:"math-scroll-wrapper",children:e.jsx("div",{className:M,...O,children:C})}):e.jsx("div",{...O,className:M,children:C}),pre:({children:C,...M})=>e.jsx("pre",{className:"code-scroll-wrapper",...M,children:C})},children:(()=>{try{if(typeof s.content=="string"&&s.content){let C=s.content.replace(/<tool>[\s\S]*?<\/tool>/gi,"").replace(/<think>[\s\S]*?<\/think>/gi,"");return C=at(C),C.includes("â€‘")?C.replace(/\u2011/g,"-"):C||""}return""}catch(C){return console.error("Error preprocessing message content:",C),(typeof s.content=="string"?s.content:"").replace(/\u2011/g,"-")}})()})}):null]}):s.role==="user"?e.jsx("div",{className:"user-message-content",children:Array.isArray(s.content)?e.jsx(e.Fragment,{children:(()=>{const C=Sn(s.content),M=C.filter(Z=>Z.type==="text"),O=C.filter(Z=>Z.type==="image_url"),J=ht[s.id]||{canScrollLeft:!1,canScrollRight:!1},Y=M.map(Z=>Z.text||"").join(`
`),ae=hn(Y);return e.jsxs(e.Fragment,{children:[ae.mainQuestion&&e.jsx("div",{className:"message-text",children:ae.mainQuestion}),ae.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${c[s.id]?"expanded":""}`,onClick:()=>{y(Z=>({...Z,[s.id]:!(Z[s.id]??!1)}))},title:c[s.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:c[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),c[s.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:ae.pdfContext})})]}),!ae.mainQuestion&&!ae.pdfContext&&M.map((Z,Re)=>e.jsx("div",{className:"message-text",children:Z.text},`text-${Re}`)),O.length>0&&e.jsxs(e.Fragment,{children:[O.map((Z,Re)=>{const ze=Z.image_url?.url;if(!ze)return null;const Me=`${s.id}-${Re}`;return se===Me?e.jsx("div",{className:"message-image-enlarged-container",children:e.jsx("div",{className:"message-image enlarged",children:e.jsx("div",{className:"message-image-wrapper",children:e.jsx("img",{src:ze,alt:"Uploaded",onClick:ye=>{ye.stopPropagation(),pe(null)}})})})},`enlarged-${Re}`):null}),e.jsxs("div",{className:"message-images-wrapper",children:[J.canScrollLeft&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-left",onClick:()=>cn(s.id,"left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:Z=>{Qe.current[s.id]=Z,Z&&setTimeout(()=>Ht(s.id),0)},className:"message-images-container",onScroll:()=>Ht(s.id),children:O.map((Z,Re)=>{const ze=Z.image_url?.url;if(!ze)return null;const Me=`${s.id}-${Re}`;return se===Me?null:e.jsx("div",{className:"message-image-item",children:e.jsx("div",{className:"message-image",children:e.jsxs("div",{className:"message-image-wrapper",children:[e.jsx("img",{src:ze,alt:"Uploaded",onClick:ye=>{ye.stopPropagation(),pe(Me)}}),e.jsx("div",{className:"image-magnifier",onClick:ye=>{ye.stopPropagation(),pe(Me)},title:"Click to enlarge",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"}),e.jsx("circle",{cx:"11",cy:"11",r:"3"})]})})]})})},Re)})}),J.canScrollRight&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-right",onClick:()=>cn(s.id,"right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]})]})]})})()}):(()=>{const C=typeof s.content=="string"?Sn(s.content):"",M=hn(C);return e.jsxs(e.Fragment,{children:[M.mainQuestion&&e.jsx("div",{className:"message-text",children:M.mainQuestion}),M.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${c[s.id]?"expanded":""}`,onClick:()=>{y(O=>({...O,[s.id]:!(O[s.id]??!1)}))},title:c[s.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:c[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),c[s.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:M.pdfContext})})]}),!M.mainQuestion&&!M.pdfContext&&e.jsx("div",{className:"message-text",children:C})]})})()}):e.jsx("div",{className:"markdown-content",children:typeof s.content=="string"?s.content:""})}),s.role==="assistant"&&s.content&&e.jsxs("div",{className:"message-actions",children:[e.jsxs("button",{className:"message-action-button copy-button",onClick:async()=>{try{const C=typeof s.content=="string"?s.content:Array.isArray(s.content)?s.content.filter(M=>M.type==="text").map(M=>M.text).join(`
`):"";await navigator.clipboard.writeText(C)}catch(C){console.error("Failed to copy:",C)}},title:"Copy to clipboard",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),e.jsx("span",{className:"message-action-button-text",children:"Copy"})]}),n&&n.trim().length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"message-action-button knowledge-note-button",onClick:()=>{if(l){he.trackAIResultAction("save_note");const C=he.getCurrentDocumentId();C&&he.updateDocument(C,{has_notes:!0});const M=fn();let O="";M?O=M:O=typeof s.content=="string"?s.content:Array.isArray(s.content)?s.content.filter(Z=>Z.type==="text").map(Z=>Z.text).join(`
`):"";const J=s.selectedTextAtSend||t||void 0,Y=s.pageNumberAtSend||a,ae=s.textYPositionAtSend;l(O,J,Y,ae,s.id),j&&j()}},title:"Create knowledge note",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),e.jsx("span",{className:"message-action-button-text",children:"Save Note"})]}),e.jsxs("button",{className:"message-action-button add-to-pdf-button",onClick:()=>{if(h){he.trackAIResultAction("add_to_pdf");const C=he.getCurrentDocumentId();C&&he.updateDocument(C,{has_annotations:!0});const M=fn();let O="";if(M)O=M;else if(typeof s.content=="string"){const{mainContent:Z}=At(s.content);O=Z}else if(Array.isArray(s.content)){const Z=s.content.filter(ze=>ze.type==="text").map(ze=>ze.text).join(`
`),{mainContent:Re}=At(Z);O=Re}const J=window.__lastSelectedTextPosition,Y=J?.pageNumber||a||1,ae=J?.textYPosition;O.trim()&&(h(O,Y,ae),o==="floating"&&(z.current&&D(z.current.scrollTop),le(!0)))}},title:"Add response to PDF as text box",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Add to PDF"})]})]}),e.jsxs("button",{className:"message-action-button refresh-button",onClick:()=>Gn(s.id),title:"Get a new response",disabled:H,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Redo"})]}),S[s.id]&&S[s.id].length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"message-action-button nav-button-left",onClick:()=>un(s.id,"prev"),title:"Previous response",disabled:!B[s.id]||B[s.id]===0,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("button",{className:"message-action-button nav-button-right",onClick:()=>un(s.id,"next"),title:"Next response",disabled:(()=>{const C=S[s.id]||[];return C.length===0?!0:(B[s.id]??C.length-1)>=C.length-1})(),children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})}),e.jsxs("span",{className:"response-counter",children:[(B[s.id]??S[s.id].length-1)+1," / ",S[s.id].length]})]})]})]})]},s.id)}),ue&&e.jsxs("div",{className:"error-message",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("div",{className:"error-text",children:ue})]}),e.jsx("div",{ref:Ke})]}),!F&&!b&&o==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!F&&b&&!I&&je&&o==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:R?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:s=>{s.preventDefault(),s.stopPropagation(),_e()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),o==="split"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:`model-selector-bar ${P==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:Wt,children:[e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(bn,{mode:k,onModeChange:jt,disabled:je||!b})}),gt()&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:qe,type:"file",accept:"image/*",multiple:!0,onChange:an,style:{display:"none"}}),e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),qe.current?.click()},className:"image-upload-button",title:"Upload images",disabled:je||!b,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]}),e.jsx("span",{className:"image-upload-text",children:"Image"})]})]})]}),x.length>0&&e.jsxs("button",{onClick:gn,className:`clear-button ${Xe?"confirming":""}`,title:Xe?"Click again to confirm":"Clear chat",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:Xe?"Confirm":"Clear"})]}),o==="split"&&e.jsx("button",{onClick:N,className:"layout-toggle-button collapse-button",title:g?"Hide knowledge notes":"Show knowledge notes","aria-label":g?"Hide knowledge notes":"Show knowledge notes",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})})]})}),e.jsxs("div",{className:"chatgpt-input-container",onDragOver:zn,onDragLeave:Bn,onDrop:Wn,children:[xe.length>0&&e.jsxs("div",{className:"uploaded-images-preview-wrapper",children:[kt&&e.jsx("button",{className:"image-scroll-button image-scroll-left",onClick:()=>ln("left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:Ve,className:"uploaded-images-preview",onScroll:Ct,children:xe.map((s,$)=>e.jsxs("div",{className:"image-preview-item",children:[e.jsx("img",{src:s,alt:`Upload ${$+1}`}),e.jsx("button",{type:"button",className:"image-preview-remove",onClick:()=>{Te(E=>E.filter((C,M)=>M!==$))},title:"Remove image",children:"Ã—"})]},$))}),bt&&e.jsx("button",{className:"image-scroll-button image-scroll-right",onClick:()=>ln("right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),e.jsxs("div",{className:`input-wrapper${Ge&&gt()?" drag-over":""}${X?` focus-${k}`:""}`,children:[e.jsx("textarea",{ref:dt,value:T,onChange:s=>V(s.target.value),onKeyPress:qn,onFocus:()=>te(!0),onBlur:()=>te(!1),placeholder:"Ask a question...",rows:1,className:"chatgpt-input",disabled:H||je||!b}),H?e.jsx("button",{onClick:Hn,className:"send-button pause-button",title:"Pause/Stop response",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"}),e.jsx("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"})]})}):e.jsx("button",{onClick:dn,disabled:!T.trim()&&!t&&xe.length===0||je||!b,className:"send-button",title:"Send message",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})]}),o==="split"&&x.length===0&&!t&&e.jsx("div",{className:`footer-text-outer split-footer ${P==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})}),o==="floating"&&e.jsx("div",{className:`footer-text-outer ${P==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})})]})]})]})})}class zs extends r.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}render(){return this.state.hasError?this.props.fallback||e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#666",height:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{maxWidth:"400px"},children:[e.jsx("h3",{style:{marginBottom:"10px"},children:"PDF Viewer Temporarily Unavailable"}),e.jsx("p",{style:{marginBottom:"20px"},children:"There's a configuration issue with the PDF viewer. The rest of the app is working fine!"}),e.jsxs("p",{style:{fontSize:"12px",color:"#999",marginBottom:"20px"},children:["Error: ",this.state.error?.message||"Unknown error"]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("label",{htmlFor:"pdf-upload-fallback",style:{padding:"12px 24px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"6px",fontSize:"16px",fontWeight:"500",cursor:"pointer",display:"inline-block"},children:"Upload PDF (Basic)"}),e.jsx("input",{id:"pdf-upload-fallback",type:"file",accept:"application/pdf",onChange:n=>{const o=n.target.files?.[0];o&&alert(`PDF "${o.name}" selected. PDF viewing will work once the configuration issue is resolved.`)},style:{display:"none"}})]}),e.jsx("button",{onClick:()=>this.setState({hasError:!1,error:null}),style:{marginTop:"15px",padding:"8px 16px",backgroundColor:"#6c757d",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Try Again"})]})}):this.props.children}}const Bs=({notes:t,onDeleteNote:n,onClearAllNotes:o,onScrollToPage:a,onHighlightText:l,layout:m,theme:h,onNoteClick:j,isVisible:N=!0,onClose:g,pdfContentRef:d})=>{const[u,p]=r.useState(new Set),f=r.useRef(null),P=r.useRef(0),[b,R]=r.useState(0),[F,x]=r.useState(new Map),[v,_]=r.useState("following"),[i,c]=r.useState(!1),[y,S]=r.useState(null),[L,B]=r.useState(null),U=r.useRef(!1),T=r.useRef(null),V=r.useRef(0);r.useEffect(()=>{if(!i)return;const I=ne=>{ne.key==="Escape"&&(c(!1),S(null))};return document.addEventListener("keydown",I),()=>{document.removeEventListener("keydown",I)}},[i]);const H=r.useCallback((I,ne)=>{ne.preventDefault(),ne.stopPropagation(),p(q=>{const le=new Set(q);return le.has(I)?le.delete(I):le.add(I),le})},[]);r.useEffect(()=>{const I=T.current!==v&&T.current!==null,ne=V.current!==t.length&&V.current>0,q=T.current===null;ne?he.endNoteModeTracking().then(()=>{he.startNoteModeTracking(v),V.current=t.length}):I?(he.startNoteModeTracking(v),T.current=v):q&&t.length>0?(he.startNoteModeTracking(v),T.current=v,V.current=t.length):he.startNoteModeTracking(v);const le=()=>{he.endNoteModeTracking()};return window.addEventListener("pagehide",le),document.addEventListener("visibilitychange",le),()=>{window.removeEventListener("pagehide",le),document.removeEventListener("visibilitychange",le)}},[v,t.length]),r.useEffect(()=>{const I=()=>d?.current?d.current:window.__pdfContentRef||null,ne=()=>{const w=I();if(w&&f.current){const D=w.scrollHeight;if(P.current!==D&&(P.current=D,R(D)),v==="following"?f.current.style.height=`${D}px`:f.current.style.height="auto",v==="following"){const k=w.scrollTop;f.current.style.transform=`translateY(-${k}px)`}else f.current.style.transform="none"}};ne();const q=I();if(q){const w=()=>{if(f.current&&v==="following"){const K=q.scrollTop;f.current.style.transform=`translateY(-${K}px)`}else f.current&&v==="stack"&&(f.current.style.transform="none")};q.addEventListener("scroll",w,{passive:!0});const D=new ResizeObserver(()=>{ne()});D.observe(q);const k=setInterval(ne,1e3);return()=>{clearInterval(k),q.removeEventListener("scroll",w),D.disconnect()}}const le=setTimeout(ne,100);return()=>clearTimeout(le)},[d,N,t.length,v]);const ee=I=>{I.pageNumber&&a?(a(I.pageNumber),setTimeout(()=>{I.linkedText&&l&&l(I.linkedText)},500)):I.linkedText&&l&&l(I.linkedText)},ue=I=>{const ne=new Date(I);return ne.toLocaleDateString()+" "+ne.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},ie=r.useCallback(()=>{if(U.current)return;U.current=!0;const I=d?.current||window.__pdfContentRef;if(!I){U.current=!1;return}const ne=new Map;t.forEach(q=>{if(!q.pageNumber||q.textYPosition===void 0)return;const le=I.querySelectorAll(".pdf-page-wrapper");if(le.length<q.pageNumber){const te=I.querySelectorAll(".react-pdf__Page");if(te.length<q.pageNumber)return;const se=te[q.pageNumber-1];if(!se)return;const pe=se.offsetTop,xe=se.offsetHeight,Te=pe+q.textYPosition*xe;ne.set(q.id,Te);return}const w=le[q.pageNumber-1];if(!w)return;const D=w.offsetTop,k=w.offsetHeight,K=q.textYPosition*k,X=D+K;ne.set(q.id,X)}),x(ne),setTimeout(()=>{U.current=!1},0)},[t,d]);r.useEffect(()=>{if(!N)return;ie();const I=d?.current||window.__pdfContentRef;if(I){const ne=new ResizeObserver(()=>{ie()});ne.observe(I);const q=setInterval(ie,500);return()=>{ne.disconnect(),clearInterval(q)}}},[ie,d,N]),r.useEffect(()=>{if(b>0){const I=setTimeout(()=>{ie()},200);return()=>clearTimeout(I)}},[b,ie]),r.useEffect(()=>{if(t.length===0){B(null);return}const I=t.some(ne=>ne.id===L);L&&!I&&B(null)},[t,L]);const je=I=>F.get(I.id),lt=(I,ne)=>{const q=je(I);if(q===void 0)return{stackIndex:0,stackSize:1,basePosition:0,displayIndex:0};const le=10,w=ne.filter(te=>{const se=je(te);return se!==void 0&&Math.abs(se-q)<le}).sort((te,se)=>te.createdAt-se.createdAt),D=w.findIndex(te=>te.id===I.id),k=w.length,K=Math.min(...w.map(te=>je(te)||0));let X=D;if(k>1&&L){const te=w.findIndex(se=>se.id===L);if(te!==-1){const se=w.filter((pe,xe)=>xe>D).length;if(D>te)X=k-1-se;else{const pe=(D-te+k)%k,xe=w.filter((Te,Ge)=>Ge>te).length;X=Math.min(pe,k-1-xe)}}}else k>1&&(X=D);return{stackIndex:D,stackSize:k,basePosition:K,displayIndex:X}};return e.jsxs("div",{className:`knowledge-notes-panel ${m}-layout theme-${h} ${N?"knowledge-notes-visible":""}`,children:[e.jsxs("div",{className:"knowledge-notes-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h3",{children:"Knowledge Notes"}),e.jsx("button",{className:"display-mode-toggle",onClick:()=>_(v==="following"?"stack":"following"),title:v==="following"?"Switch to stack mode":"Switch to following mode",style:{background:"transparent",border:"1px solid rgba(0, 0, 0, 0.2)",borderRadius:"4px",padding:"4px 8px",cursor:"pointer",fontSize:"12px",color:"inherit",display:"flex",alignItems:"center",gap:"4px"},children:v==="following"?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]}),"Following"]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),"Stack"]})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxs("button",{className:"notes-count-button",onClick:I=>{I.preventDefault(),I.stopPropagation(),t.length>0&&(S(null),c(!0))},title:t.length>0?"Clear all notes":"No notes to clear",disabled:t.length===0,children:[e.jsx("span",{className:"notes-count-text",children:t.length}),e.jsxs("svg",{className:"notes-count-clear-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})]}),e.jsx("button",{className:"knowledge-notes-close",onClick:async I=>{I.stopPropagation(),await he.endNoteModeTracking(),g?.()},"aria-label":"Close knowledge notes",style:{display:"flex",alignItems:"center",justifyContent:"center",background:"transparent",border:"none",cursor:"pointer",padding:"4px",width:"32px",height:"32px",borderRadius:"6px",transition:"background 0.2s, color 0.2s"},children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx("div",{className:`knowledge-notes-list ${v==="stack"?"stack-mode":"following-mode"}`,ref:f,style:{height:v==="following"&&b>0?`${b}px`:"auto",overflow:v==="stack"?"auto":"visible"},children:t.length===0?e.jsx("div",{className:"empty-notes",children:"No knowledge notes yet"}):t.map(I=>{const ne=u.has(I.id),q=je(I),w=(I.content?I.content.split(`
`):[]).length>3||I.content&&I.content.length>200,D=L===I.id,k=lt(I,t),K=8,X=1.5,te=2,se=k.displayIndex*K,pe=k.displayIndex*te,xe=k.stackSize-1,Te=k.stackIndex===k.stackSize-1,Ge=xe*X,Ye=Te?Ge:k.displayIndex*X,kt=q!==void 0?k.displayIndex===0?q:q+se:void 0,ct=k.displayIndex===0?0:Ye,bt=k.displayIndex===0?0:pe;return e.jsxs("div",{className:`knowledge-note-item ${D?"note-front":""} ${k.stackSize>1?"note-stacked":""}`,onClick:be=>{const ht=be.target;if(!(ht.closest("button")||ht.closest(".note-linked-text")))if(ee(I),j?.(I),v==="following"&&k.stackSize>1)if(L!==I.id)B(I.id);else{const Je=t.filter(Le=>{const Ee=je(Le),Ze=je(I);return Ee!==void 0&&Ze!==void 0&&Math.abs(Ee-Ze)<10}).sort((Le,Ee)=>Le.createdAt-Ee.createdAt),wt=(Je.findIndex(Le=>Le.id===I.id)+1)%Je.length;B(Je[wt].id)}else v==="following"&&B(I.id)},style:v==="following"&&kt!==void 0?{position:"absolute",top:`${kt}px`,left:`${8+bt}px`,right:`${8-bt}px`,width:"auto",zIndex:k.displayIndex===0?20+k.stackSize:10+k.displayIndex,pointerEvents:"auto",transform:`rotate(${ct}deg)`,transformOrigin:"center top",transition:"transform 0.3s ease, z-index 0.2s ease, top 0.3s ease, left 0.3s ease, right 0.3s ease",boxShadow:k.displayIndex===0?"0 4px 16px rgba(0, 0, 0, 0.15)":`0 ${2+k.displayIndex}px ${8+k.displayIndex*2}px rgba(0, 0, 0, ${.1+k.displayIndex*.02})`}:{position:"relative",marginBottom:"12px",marginLeft:"8px",marginRight:"8px",width:"auto"},children:[e.jsxs("div",{className:"note-header",children:[e.jsxs("div",{className:"note-meta",children:[I.pageNumber&&e.jsxs("span",{className:"note-page-badge",children:["Page ",I.pageNumber]}),I.linkedText&&e.jsx("span",{className:"note-text-badge",children:"Linked Text"}),e.jsx("span",{className:"note-date",children:ue(I.createdAt)})]}),e.jsx("button",{className:"note-delete-button",onClick:be=>{be.stopPropagation(),S(I.id),c(!0)},title:"Delete note",children:"Ã—"})]}),I.linkedText&&e.jsxs("div",{className:"note-linked-text",onClick:()=>{ee(I),j?.(I)},children:['"',I.linkedText.substring(0,100),I.linkedText.length>100?"...":"",'"']}),e.jsxs("div",{className:"note-content-wrapper",children:[e.jsx("div",{className:`note-content ${ne?"expanded":"collapsed"}`,children:e.jsx("div",{className:"markdown-content",children:e.jsx(st,{remarkPlugins:[rt,it],rehypePlugins:[[ot,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],components:{p:({children:be})=>e.jsx("p",{style:{marginBottom:"0.5em"},children:be}),a:({href:be,children:ht})=>e.jsx("a",{href:be,target:"_blank",rel:"noopener noreferrer",onClick:Je=>Je.stopPropagation(),children:ht})},children:at(I.content)})})}),w&&e.jsx("button",{className:"note-expand-button",onClick:be=>{be.preventDefault(),be.stopPropagation(),H(I.id,be)},onMouseDown:be=>{be.stopPropagation()},title:ne?"Collapse":"Expand",type:"button",children:ne?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}),e.jsx("span",{children:"Show Less"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{children:"Show More"})]})})]})]},I.id)})}),i&&e.jsx("div",{className:"confirm-dialog-overlay",onClick:()=>{c(!1),S(null)},children:e.jsxs("div",{className:"confirm-dialog",onClick:I=>I.stopPropagation(),children:[e.jsx("div",{className:"confirm-dialog-header",children:e.jsx("h3",{children:y?"Delete Note":"Clear All Notes"})}),e.jsx("div",{className:"confirm-dialog-content",children:y?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"Are you sure you want to delete this knowledge note?"}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Are you sure you want to delete all ",e.jsx("strong",{children:t.length})," knowledge note",t.length===1?"":"s","?"]}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]})}),e.jsxs("div",{className:"confirm-dialog-actions",children:[e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-cancel",onClick:()=>{c(!1),S(null)},children:"Cancel"}),e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-confirm",onClick:()=>{y?(n(y),S(null)):o&&o(),c(!1)},children:y?"Delete":"Clear All"})]})]})})]})},ut="chatnote_pdf_history_cache",Rn=300*1e3,On="chatnote_pdf_history_names",nn="chatnote_pdf_history_version",sn="chatnote_pdf_history_last_fetch",Ws=()=>{try{const t=localStorage.getItem(On);if(!t)return{};const n=JSON.parse(t);if(n&&typeof n=="object")return n}catch(t){console.warn("Failed to parse generated name cache:",t)}return{}},Mn=t=>{try{localStorage.setItem(On,JSON.stringify(t))}catch(n){console.warn("Failed to persist generated name cache:",n)}},Hs=t=>{try{const n=localStorage.getItem(ut);if(!n)return;const o=JSON.parse(n);o.pdfs=(o.pdfs||[]).filter(a=>a.pdfId!==t),localStorage.setItem(ut,JSON.stringify(o))}catch(n){console.warn("Failed to update history cache after deletion:",n)}},qs=t=>{if(!t)return"";const n="__REASONING_START__",o="__REASONING_END__";if(t.includes(n)&&t.includes(o)){const a=t.indexOf(o)+o.length;t=t.slice(a)}return t=t.replace(/<think>[\s\S]*?<\/think>/gi,""),t.trim()},Qs=(t,n)=>{const o=qs(t);if(!o)return n;const l=o.split(`
`)[0].replace(/^["'â€œâ€`]+|["'â€œâ€`]+$/g,"").replace(/[.:]+$/g,"").trim().replace(/\s+/g," ");return l?l.length>60?`${l.slice(0,57).trimEnd()}...`:l:n},$t=()=>{try{const t=localStorage.getItem(nn);if(!t)return 0;const n=Number(t);return Number.isFinite(n)?n:0}catch{return 0}},Gs=()=>{try{const t=sessionStorage.getItem(sn);if(!t)return 0;const n=Number(t);return Number.isFinite(n)?n:0}catch{return 0}},Us=t=>{try{sessionStorage.setItem(sn,`${t}`)}catch{}},on="chatnote_pdf_history_pending_save",Vs=()=>{try{localStorage.setItem(on,"true")}catch{}},Pn=()=>{try{localStorage.removeItem(on)}catch{}},Gt=()=>{try{return localStorage.getItem(on)==="true"}catch{return!1}},Ks=()=>{try{sessionStorage.removeItem(sn)}catch{}},_t=t=>{try{localStorage.setItem(nn,`${Date.now()}`),t&&Vs()}catch{}},Ys=()=>{try{localStorage.removeItem(nn)}catch{}};function Ft(){try{localStorage.removeItem(ut)}catch(t){console.warn("Failed to invalidate PDF history cache:",t)}}let Dt=null;async function Zt(t){try{const n=localStorage.getItem("auth_token");if(!n)return;const o=localStorage.getItem(ut);if(o)try{const a=JSON.parse(o);if(Date.now()-a.timestamp<Rn)return}catch{}return Dt||(Dt=(async()=>{try{const a=await fetch(`${t}/api/drive/history`,{headers:{Authorization:`Bearer ${n}`}});if(a.ok){const m=(await a.json()).pdfs||[];try{const h={pdfs:m,timestamp:Date.now()};localStorage.setItem(ut,JSON.stringify(h))}catch(h){console.warn("Failed to save cached history:",h)}}else if(a.status===403)try{localStorage.removeItem(ut)}catch{}}finally{Dt=null}})(),Dt)}catch{}}function Js({isOpen:t,onClose:n,onSelectPdf:o,hasUnsavedChanges:a=!1,onSaveBeforeFetch:l,isDriveAuthorized:m=!1}){const{isAuthenticated:h}=It(),[j,N]=r.useState([]),[g,d]=r.useState(!1),[u,p]=r.useState(null),[f,P]=r.useState(!1),[b,R]=r.useState(()=>Ws()),[F,x]=r.useState({}),v=r.useRef(new Set),[_,i]=r.useState(!1),[c,y]=r.useState(""),[S,L]=r.useState({}),[B,U]=r.useState({}),T=r.useRef({}),[V,H]=r.useState(()=>Gs()),ee=r.useRef(t),ue=()=>{try{const w=localStorage.getItem(ut);if(!w)return null;const D=JSON.parse(w);if(Date.now()-D.timestamp<Rn)return D.pdfs}catch(w){console.warn("Failed to load cached history:",w)}return null},ie=w=>{try{const D={pdfs:w,timestamp:Date.now()};localStorage.setItem(ut,JSON.stringify(D))}catch(D){console.warn("Failed to save cached history:",D)}};r.useEffect(()=>{ee.current=t},[t]),r.useEffect(()=>()=>{Object.values(T.current).forEach(w=>clearTimeout(w)),T.current={}},[]),r.useEffect(()=>{let w=!0;return _n().then(D=>{w&&i(D)}).catch(()=>{w&&i(!1)}),()=>{w=!1}},[]),r.useEffect(()=>{if(t&&h){P(!1);const w=ue();if(w){N(w),d(!1);const D=$t(),k=D>0&&D>V,K=Gt(),X=a;(k||K||X||!w||w.length===0)&&(X&&l?l().then(()=>{const se=$t(),pe=Gt();I(!0,se,pe)}).catch(()=>{const se=$t(),pe=Gt();I(!0,se,pe)}):I(!0,D,K))}else d(!0),I(!1,$t(),Gt())}else h?t||(P(!1),y(""),U({})):(N([]),p(null),d(!1),P(!1),Ys(),H(0),Ks(),Pn())},[t,h]),r.useEffect(()=>{if(!_||j.length===0)return;let w=!1;return(async()=>{for(const k of j){if(w)return;const K=b[k.pdfId];let X=!1;if(K?X=K.originalFileName!==k.originalFileName:X=k.displayName.toLowerCase().endsWith(".pdf")||k.displayName===k.originalFileName,!(!X||v.current.has(k.pdfId))){v.current.add(k.pdfId),x(te=>({...te,[k.pdfId]:!0}));try{const te=`You generate short, descriptive titles for uploaded PDFs.
File name: "${k.originalFileName}".
Output a concise (<=5 words) human-friendly title without quotes.`,se=await Ot([{role:"user",content:te}],void 0,void 0,xt[0]);if(w)return;const pe=Qs(se,k.displayName||k.originalFileName);R(xe=>{const Te=xe[k.pdfId];if(Te&&Te.name===pe&&Te.originalFileName===k.originalFileName)return xe;const Ge={...xe,[k.pdfId]:{name:pe,originalFileName:k.originalFileName,updatedAt:Date.now()}};return Mn(Ge),Ge})}catch(te){console.warn("Failed to generate PDF title:",te)}finally{v.current.delete(k.pdfId),x(te=>{const se={...te};return delete se[k.pdfId],se})}}}})(),()=>{w=!0}},[_,j]);const je=r.useCallback(w=>{U(D=>({...D,[w]:!0})),T.current[w]&&clearTimeout(T.current[w]),T.current[w]=window.setTimeout(()=>{U(D=>{const k={...D};return delete k[w],k}),delete T.current[w]},4e3)},[]),lt=r.useCallback(async w=>{if(w){L(D=>({...D,[w]:!0}));try{const D=localStorage.getItem("auth_token");if(!D)throw new Error("Please log in again.");const k=await fetch(`${Ne}/api/drive/history/${w}`,{method:"DELETE",headers:{Authorization:`Bearer ${D}`}});if(!k.ok){const K=await k.text();throw new Error(K||"Failed to delete PDF")}N(K=>K.filter(X=>X.pdfId!==w)),R(K=>{if(!K[w])return K;const X={...K};return delete X[w],Mn(X),X}),Hs(w),Ft(),_t(!1)}catch(D){console.error("Failed to delete PDF:",D),alert(D instanceof Error?D.message:"Failed to delete PDF")}finally{L(D=>{const k={...D};return delete k[w],k}),U(D=>{if(!D[w])return D;const k={...D};return delete k[w],k}),T.current[w]&&(clearTimeout(T.current[w]),delete T.current[w])}}},[]),I=async(w=!1,D,k)=>{if(!m){ee.current&&!w&&(p("Google Drive not authorized. Please authorize Drive access to view PDF history."),d(!1));return}if(ee.current){w?P(!0):d(!0),p(null);try{const K=localStorage.getItem("auth_token");if(!K){ee.current&&p("Not authenticated"),w?P(!1):d(!1);return}const X=await fetch(`${Ne}/api/drive/history`,{headers:{Authorization:`Bearer ${K}`}});if(!X.ok){ee.current&&(X.status===403?(p("Drive not authorized. Please authorize Drive access first."),localStorage.removeItem(ut)):p("Failed to load PDF history")),w?P(!1):d(!1);return}const se=(await X.json()).pdfs||[];if(ee.current){N(se),ie(se);const pe=D&&D>0?D:$t();pe>0&&(H(pe),Us(pe)),k&&Pn()}}catch(K){console.error("Error loading history:",K),ee.current&&!w&&p("Failed to load PDF history")}finally{w?P(!1):d(!1)}}},ne=w=>{const D=new Date(w),K=new Date().getTime()-D.getTime(),X=Math.floor(K/6e4),te=Math.floor(K/36e5),se=Math.floor(K/864e5);return X<1?"Just now":X<60?`${X}m ago`:te<24?`${te}h ago`:se<7?`${se}d ago`:D.toLocaleDateString()},q=r.useMemo(()=>{const w=c.trim().toLowerCase();return w?j.filter(D=>(b[D.pdfId]?.name||"").toLowerCase().includes(w)||D.originalFileName.toLowerCase().includes(w)||D.displayName.toLowerCase().includes(w)):j},[j,c,b]),le=c.trim().length>0;return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pdf-history-overlay",onClick:n}),e.jsxs("div",{className:"pdf-history-panel",children:[e.jsxs("div",{className:"pdf-history-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h2",{children:"PDF History"}),f&&e.jsx("div",{className:"pdf-history-refresh-indicator",title:"Refreshing...",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"})})})]}),e.jsx("button",{className:"pdf-history-close",onClick:n,"aria-label":"Close history",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsxs("div",{className:"pdf-history-content",children:[!u&&e.jsxs("div",{className:"pdf-history-search",children:[e.jsx("input",{type:"search",placeholder:"Search by title or file name...",value:c,onChange:w=>y(w.target.value),"aria-label":"Search PDF history",disabled:g&&j.length===0}),c&&e.jsx("button",{type:"button",className:"pdf-history-search-clear",onClick:()=>y(""),"aria-label":"Clear search",children:"Ã—"})]}),g&&e.jsx("div",{className:"pdf-history-loading",children:e.jsx("span",{children:"Loading..."})}),u&&e.jsxs("div",{className:"pdf-history-error",children:[e.jsx("p",{children:u}),u.includes("not authorized")&&e.jsx("button",{className:"pdf-history-authorize-btn",onClick:async()=>{try{const w=localStorage.getItem("auth_token");if(!w){alert("Please log in first");return}const D=await fetch(`${Ne}/api/drive/auth`,{headers:{Authorization:`Bearer ${w}`}});if(!D.ok)throw new Error("Failed to initiate Drive authorization");const k=await D.json();k.authorized?I():k.authUrl&&(window.location.href=k.authUrl)}catch(w){console.error("Error authorizing Drive:",w),p("Failed to authorize Drive access. Please try again.")}},children:"Authorize Drive Access"})]}),!g&&!u&&j.length===0&&!le&&e.jsxs("div",{className:"pdf-history-empty",children:[e.jsx("p",{children:"No PDFs yet"}),e.jsx("p",{className:"pdf-history-empty-hint",children:"Upload a PDF to get started"})]}),!g&&!u&&le&&q.length===0&&e.jsxs("div",{className:"pdf-history-empty",children:[e.jsx("p",{children:"No PDFs match your search"}),e.jsx("button",{type:"button",className:"pdf-history-search-reset",onClick:()=>y(""),children:"Clear search"})]}),!g&&!u&&q.length>0&&e.jsx("div",{className:"pdf-history-list",children:q.map(w=>{const D=b[w.pdfId]?.name||w.displayName,k=!!F[w.pdfId],K=!!S[w.pdfId],X=!!B[w.pdfId];return e.jsxs("div",{className:"pdf-history-item",onClick:()=>{K||(o(w.pdfId),n())},children:[e.jsx("div",{className:"pdf-history-item-icon",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsxs("div",{className:"pdf-history-item-content",children:[e.jsxs("div",{className:"pdf-history-item-header",children:[e.jsxs("div",{className:"pdf-history-item-name",children:[e.jsx("span",{children:D}),k&&e.jsx("span",{className:"pdf-history-name-spinner","aria-label":"Generating title"})]}),e.jsx("button",{type:"button",className:`pdf-history-delete ${X?"confirm":""}`,onClick:te=>{if(te.stopPropagation(),!K){if(!X){je(w.pdfId);return}lt(w.pdfId)}},"aria-label":"Delete PDF",disabled:K,children:K?e.jsx("span",{className:"pdf-history-delete-spinner","aria-hidden":"true"}):e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"})]})})]}),e.jsxs("div",{className:"pdf-history-item-original",title:w.originalFileName,children:[e.jsx("span",{className:"pdf-history-original-name",children:w.originalFileName}),e.jsx("span",{className:"pdf-history-divider",children:"â€¢"}),e.jsx("span",{children:ne(w.lastModifiedAt)})]}),e.jsx("div",{className:"pdf-history-item-meta",children:w.pageCount>0&&e.jsxs("span",{children:[w.pageCount," page",w.pageCount!==1?"s":""]})}),(w.hasAnnotations||w.hasNotes)&&e.jsxs("div",{className:"pdf-history-item-badges",children:[w.hasAnnotations&&e.jsx("span",{className:"pdf-history-badge",children:"Annotations"}),w.hasNotes&&e.jsx("span",{className:"pdf-history-badge",children:"Notes"})]})]})]},w.pdfId)})})]})]})]}):null}let nt;async function Xs(){if(!nt){if(typeof window<"u"&&window.pdfjsLib)nt=window.pdfjsLib;else{const t=await Et(()=>import("./vendor-pdf-DDxsMbbh.js").then(n=>n.p),[]);nt=t.default||t}if(typeof window<"u"&&nt&&!nt.GlobalWorkerOptions?.workerSrc){let t;const n="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const o="/ChatNote/";t=`${o.endsWith("/")?o:`${o}/`}pdf.worker.min.js`}nt.GlobalWorkerOptions?(nt.GlobalWorkerOptions.workerSrc=t,nt.GlobalWorkerOptions.standardFontDataUrl=n):nt.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:n}}}return nt}async function An(t){try{const n=await Xs(),o=await t.arrayBuffer(),l=await n.getDocument({data:o,standardFontDataUrl:"https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/"}).promise,m=l.numPages,h=[];for(let g=1;g<=m;g++){const p=(await(await l.getPage(g)).getTextContent()).items.map(f=>f.str).join(" ");h.push(Promise.resolve(p))}return(await Promise.all(h)).map((g,d)=>`--- Page ${d+1} ---
${g}`).join(`

`)}catch(n){throw console.error("Error extracting text from PDF:",n),new Error("Failed to extract text from PDF. The PDF may be corrupted or password-protected.")}}const Zs=["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#FFC0CB"];function eo({isOpen:t,onConfirm:n,onCancel:o}){const{theme:a}=Vt();return t?e.jsx("div",{className:"drive-sync-backdrop",children:e.jsxs("div",{className:`drive-sync-modal ${a}`,children:[e.jsx("h3",{children:"Sync with Google Drive?"}),e.jsx("p",{children:"Would you like to sync your PDFs and notes with Google Drive? This allows you to access your files from any device."}),e.jsxs("div",{className:"drive-sync-buttons",children:[e.jsx("button",{onClick:o,className:"button-cancel",children:"Not Now"}),e.jsx("button",{onClick:n,className:"button-confirm",children:"Sync with Drive"})]})]})}):null}function to({message:t,type:n="info",duration:o=3e3,onClose:a}){const[l,m]=r.useState(!1);return r.useEffect(()=>{const h=setTimeout(()=>{m(!0)},o-300),j=setTimeout(()=>{a()},o);return()=>{clearTimeout(h),clearTimeout(j)}},[o,a]),e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${l?"toast-exit":""}`,children:[e.jsx("svg",{className:`toast-icon ${n}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:n==="info"&&e.jsxs(e.Fragment,{children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]})}),e.jsx("span",{children:t})]})})}const no=({onResize:t,initialWidth:n,minWidth:o,maxWidth:a,modelMode:l})=>{const[m,h]=r.useState(!1),[j,N]=r.useState(!1),g=r.useRef(0),d=r.useRef(n),u=()=>{switch(l){case"auto":return"#4285f4";case"reasoning":return"#9c27b0";case"advanced":return"#4caf50";default:return"#4285f4"}},p=f=>{f.preventDefault(),h(!0),g.current=f.clientX,d.current=n,document.body.style.cursor="ew-resize",document.body.style.userSelect="none"};return r.useEffect(()=>{if(!m)return;const f=b=>{const R=b.clientX-g.current,F=d.current-R,x=Math.max(o,Math.min(a,F));t(x)},P=()=>{h(!1),document.body.style.cursor="",document.body.style.userSelect=""};return document.addEventListener("mousemove",f),document.addEventListener("mouseup",P),()=>{document.removeEventListener("mousemove",f),document.removeEventListener("mouseup",P)}},[m,o,a,t]),e.jsx("div",{className:`resizable-divider ${m?"dragging":""} ${j?"hovering":""}`,onMouseDown:p,onMouseEnter:()=>N(!0),onMouseLeave:()=>N(!1),style:{"--model-color":u()},children:e.jsxs("div",{className:"divider-handle",children:[e.jsx("div",{className:"divider-grip"}),e.jsx("div",{className:"divider-grip"}),e.jsx("div",{className:"divider-grip"})]})})},so=r.lazy(()=>Et(()=>import("./PDFViewer-BH854lJo.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function oo(){const{theme:t}=Vt(),{isChatVisible:n,setChatVisible:o}=Ln(),{isAuthenticated:a,user:l}=It(),[m,h]=r.useState(null),[j,N]=r.useState(""),[g,d]=r.useState(""),[u,p]=r.useState("split"),[f,P]=r.useState(1),[b,R]=r.useState([]),[F,x]=r.useState(!1),[v,_]=r.useState(null),[i,c]=r.useState(!1),[y,S]=r.useState(null),[L,B]=r.useState([]),[U,T]=r.useState(!1),[V,H]=r.useState(!1),[ee,ue]=r.useState(!1),[ie,je]=r.useState(!1),[lt,I]=r.useState(null),[ne,q]=r.useState(!1),[le,w]=r.useState(!1),[D,k]=r.useState(0),[K,X]=r.useState(0),[te,se]=r.useState(null),pe=r.useRef(!1),xe=r.useRef(null),[Te,Ge]=r.useState(null),[Ye,kt]=r.useState(()=>{const A=localStorage.getItem("chatModelMode");return A==="auto"||A==="reasoning"||A==="advanced"?A:"auto"}),[ct,bt]=r.useState(()=>{const A=localStorage.getItem("chatWidth");return A?parseInt(A,10):500}),be=r.useMemo(()=>!y||!a?!1:D===0||K>D,[y,a,D,K]);r.useEffect(()=>{const A=new URLSearchParams(window.location.search),z=A.get("drive_auth_success"),oe=A.get("drive_auth_error");z==="true"?(window.history.replaceState({},"",window.location.pathname),q(!1),setTimeout(()=>{Zt(Ne).catch(()=>{})},1e3)):oe&&(console.warn("Drive authorization failed:",oe),window.history.replaceState({},"",window.location.pathname))},[]),r.useEffect(()=>{localStorage.setItem("chatModelMode",Ye)},[Ye]),r.useEffect(()=>{localStorage.setItem("chatWidth",ct.toString())},[ct]);const ht=r.useCallback(A=>{kt(A)},[]),Je=r.useCallback(A=>{bt(A)},[]);r.useEffect(()=>{a&&l&&!pe.current&&(_t(!1),pe.current=!0),a&&l&&!ne?(q(!0),setTimeout(()=>{Xe()},500)):a||(q(!1),pe.current=!1,he.endNoteModeTracking(),h(null),N(""),B([]),R([]),S(null),P(1),x(!1),d(""),c(!1),Ft())},[a,l]);const Xe=async()=>{try{const A=localStorage.getItem("auth_token");if(!A)return;const z=await fetch(`${Ne}/api/drive/status`,{headers:{Authorization:`Bearer ${A}`}});if(z.ok)if((await z.json()).authorized){w(!0),Zt(Ne).catch(()=>{});return}else w(!1);const oe=await fetch(`${Ne}/api/drive/auth`,{headers:{Authorization:`Bearer ${A}`}});if(oe.ok){const re=await oe.json();!re.authorized&&re.authUrl&&(I(re.authUrl),je(!0))}}catch(A){console.warn("Failed to check/authorize Drive:",A)}},wt=()=>{lt&&(window.location.href=lt),je(!1)},Le=()=>{je(!1)},Ee=async A=>{h(A),ue(!0);try{const z=await An(A);if(N(z),z&&z.trim().length>0)try{const{indexPDF:oe}=await Et(async()=>{const{indexPDF:re}=await import("./pdfRAG-BUQZRmsO.js");return{indexPDF:re}},[]);await oe(z)}catch(oe){console.warn("[RAG] Failed to index PDF, will use keyword search:",oe)}if(a&&le)try{const oe=localStorage.getItem("auth_token");if(oe){const re=await A.arrayBuffer(),ke=new Uint8Array(re);let Ie="";const De=8192;for(let _e=0;_e<ke.length;_e+=De){const vt=ke.subarray(_e,Math.min(_e+De,ke.length));for(let jt=0;jt<vt.length;jt++)Ie+=String.fromCharCode(vt[jt])}const et=btoa(Ie);let Se="";if(z&&z.trim().length>0)try{const _e=z.slice(0,1e3),vt=`You generate short, descriptive titles for uploaded PDFs based on their content.
File name: "${A.name}"
Content snippet: "${_e}"
Output a concise (<=5 words) human-friendly title without quotes. Do not include "Title:" prefix.`;Se=(await Ot([{role:"user",content:vt}],void 0,void 0,xt[0])).replace(/^["'â€œâ€`]+|["'â€œâ€`]+$/g,"").replace(/[.:]+$/g,"").trim(),(!Se||Se.length>60)&&(Se="")}catch(_e){console.warn("Failed to generate title:",_e)}const Fe=await fetch(`${Ne}/api/drive/upload-pdf`,{method:"POST",headers:{Authorization:`Bearer ${oe}`,"Content-Type":"application/json"},body:JSON.stringify({pdfBase64:et,fileName:A.name,displayName:Se||void 0})});if(Fe.ok){const _e=await Fe.json();S(_e.pdfId),k(0),X(0),Ft(),_t(!1)}else console.warn("Failed to upload PDF to Drive:",await Fe.text())}}catch(oe){console.warn("Error uploading PDF to Drive:",oe)}}catch(z){console.error("Failed to extract PDF text:",z),N("");const oe=z instanceof Error?z.message:"Unknown error during PDF upload",re=(A.size/(1024*1024)).toFixed(2);await he.trackError("upload_fail",`File: ${A.name}, Size: ${re}MB, Error: ${oe}`)}finally{ue(!1)}};r.useEffect(()=>{m||(N(""),Et(async()=>{const{clearPDFIndices:A}=await import("./pdfRAG-BUQZRmsO.js");return{clearPDFIndices:A}},[]).then(({clearPDFIndices:A})=>{A()}).catch(()=>{}))},[m]);const Ze=(A,z,oe)=>{d(A),A&&z!==void 0&&oe!==void 0&&(_({text:A,pageNumber:z,textYPosition:oe}),window.__lastSelectedTextPosition={text:A,pageNumber:z,textYPosition:oe})},fe=()=>{p(A=>A==="floating"?"split":"floating")},Ue=A=>{se(A)},Kt=()=>{p("split"),xe.current&&xe.current()},zt=(A,z,oe,re,ke)=>{if(b.find(Fe=>Fe.messageId===ke&&Fe.content===A)){Ge("This note has already been saved to your knowledge notes");return}const De=oe||v?.pageNumber||f,et=re??v?.textYPosition??0,Se={id:`note-${Date.now()}`,content:A,linkedText:z||v?.text,pageNumber:De,textYPosition:et,createdAt:Date.now(),messageId:ke};R(Fe=>[...Fe,Se]),De&&qe(De)},Bt=A=>{R(z=>z.filter(oe=>oe.id!==A))},ft=()=>{R([])},qe=A=>{P(A),window.__pdfScrollToPage&&window.__pdfScrollToPage(A)},Ve=r.useCallback(async()=>{if(!(!y||!a))try{const A=localStorage.getItem("auth_token");if(!A)return;await fetch(`${Ne}/api/drive/save-annotations/${y}`,{method:"POST",headers:{Authorization:`Bearer ${A}`,"Content-Type":"application/json"},body:JSON.stringify({annotations:L})}),Ft(),_t(!0),k(Date.now())}catch(A){console.error("Failed to save annotations:",A)}},[y,a,L]),Qe=r.useCallback(async()=>{if(!(!y||!a))try{const A=localStorage.getItem("auth_token");if(!A)return;await fetch(`${Ne}/api/drive/save-notes/${y}`,{method:"POST",headers:{Authorization:`Bearer ${A}`,"Content-Type":"application/json"},body:JSON.stringify({notes:b})}),Ft(),_t(!0),k(Date.now())}catch(A){console.error("Failed to save notes:",A)}},[y,a,b]);r.useEffect(()=>{const A=()=>{if(!y||!a)return!1;const re=L.length>0,ke=b.length>0;return!re&&!ke?!1:D===0||K>D},z=()=>{if(document.visibilityState==="hidden"&&A()){const re=[];L.length>0&&re.push(Ve()),b.length>0&&re.push(Qe()),Promise.race([Promise.all(re),new Promise(ke=>setTimeout(ke,1500))]).catch(()=>{})}},oe=re=>{if(A())try{const ke=localStorage.getItem("auth_token");if(ke){if(L.length>0){const Ie=JSON.stringify({annotations:L});Ie.length<6e4&&fetch(`${Ne}/api/drive/save-annotations/${y}`,{method:"POST",headers:{Authorization:`Bearer ${ke}`,"Content-Type":"application/json"},body:Ie,keepalive:!0}).catch(()=>{})}if(b.length>0){const Ie=JSON.stringify({notes:b});Ie.length<6e4&&fetch(`${Ne}/api/drive/save-notes/${y}`,{method:"POST",headers:{Authorization:`Bearer ${ke}`,"Content-Type":"application/json"},body:Ie,keepalive:!0}).catch(()=>{})}}}catch{}if(m&&A())return re.preventDefault(),re.returnValue="",""};return window.addEventListener("beforeunload",oe),document.addEventListener("visibilitychange",z),()=>{window.removeEventListener("beforeunload",oe),document.removeEventListener("visibilitychange",z)}},[m,y,a,L,b,D,K,Ve,Qe]);const Ke=r.useCallback(async()=>{if(!y||!a)return;const A=n;await he.endNoteModeTracking(),x(!1),o(!1),H(!0);try{await Promise.all([Ve(),Qe()])}finally{H(!1),A&&o(!0)}},[y,a,n,o,Ve,Qe]),dt=async A=>{if(A!==y){if(y&&a&&be)try{await Promise.race([Ke(),new Promise(z=>setTimeout(z,2e3))])}catch(z){console.warn("Failed to save before switching PDF:",z)}await he.endNoteModeTracking(),T(!0),x(!1),h(null),B([]),R([]),S(null);try{const z=localStorage.getItem("auth_token");if(!z){alert("Please log in to load PDF from history"),T(!1);return}const oe=await fetch(`${Ne}/api/drive/load-pdf/${A}`,{headers:{Authorization:`Bearer ${z}`}});if(!oe.ok)throw new Error("Failed to load PDF");const re=await oe.json(),ke=atob(re.pdfBlob),Ie=new Uint8Array(ke.length);for(let Se=0;Se<ke.length;Se++)Ie[Se]=ke.charCodeAt(Se);const De=new Blob([Ie],{type:"application/pdf"}),et=new File([De],re.metadata.originalFileName,{type:"application/pdf"});h(et),S(re.metadata.pdfId),An(et).then(Se=>{if(N(Se),Se&&Se.trim().length>0)try{Et(async()=>{const{indexPDF:Fe}=await import("./pdfRAG-BUQZRmsO.js");return{indexPDF:Fe}},[]).then(({indexPDF:Fe})=>{Fe(Se).catch(_e=>{console.warn("[RAG] Failed to index PDF:",_e)})})}catch(Fe){console.warn("[RAG] Failed to index PDF:",Fe)}}).catch(Se=>{console.warn("Failed to extract PDF text:",Se)}),B(re.annotations||[]),R(re.knowledgeNotes||[]),k(Date.now()),X(Date.now()),P(1)}catch(z){console.error("Failed to load PDF from history:",z),alert("Failed to load PDF. Please try again."),T(!1)}}},$e=async()=>{const A=be;if(await he.endNoteModeTracking(),A){H(!0);try{await Ke()}catch(z){console.warn("Failed to save before starting new session:",z)}finally{H(!1)}}h(null),N(""),B([]),R([]),S(null),P(1),x(!1),d(""),A&&Zt(Ne).catch(()=>{})},Wt=r.useCallback(async()=>{be&&await Ke()},[be,Ke]);return r.useEffect(()=>{X(Date.now())},[L,b]),r.useEffect(()=>{if(y&&a&&L.length>0){const A=setTimeout(()=>{Ve()},5e3);return()=>clearTimeout(A)}},[L,y,a,Ve]),r.useEffect(()=>{if(y&&a&&b.length>0){const A=setTimeout(()=>{Qe()},5e3);return()=>clearTimeout(A)}},[b,y,a,Qe]),e.jsxs("div",{className:"app",children:[e.jsx(ps,{hasUnsavedChanges:be,saveCurrentState:Ke,isSavingSession:V,setIsSavingSession:H,children:e.jsx(Ns,{onOpenHistory:()=>c(!0),isSavingSession:V,currentMode:te,onResetMode:Kt,hasPdf:m!==null})}),e.jsx(Js,{isOpen:i,onClose:()=>c(!1),onSelectPdf:dt,hasUnsavedChanges:be,onSaveBeforeFetch:Wt,isDriveAuthorized:le}),e.jsxs("div",{className:`main-content ${u==="split"?"split-layout":""} ${F&&u==="floating"?"has-knowledge-notes":""}`,children:[e.jsx(zs,{children:e.jsx(r.Suspense,{fallback:e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading PDF viewer..."}),children:e.jsx(so,{file:m,onFileUpload:Ee,onTextSelection:Ze,layout:u,onPageChange:P,onTotalPagesChange:A=>{window.__pdfTotalPages!==A&&(window.__pdfTotalPages=A)},showKnowledgeNotes:F,onToggleLayout:fe,knowledgeNotes:b,onScrollToPage:qe,onNoteClick:A=>{A.pageNumber&&qe(A.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0,onAddAnnotation:()=>{},initialAnnotations:L,onAnnotationsChange:B,isLoadingPdf:U,onLoadingComplete:()=>T(!1),isSavingSession:V,onNewSession:$e,isDriveAuthorized:le,onSelectRecentPdf:dt})})}),F&&e.jsx(Bs,{notes:b,onDeleteNote:Bt,onClearAllNotes:ft,onScrollToPage:qe,layout:u,theme:t,isVisible:F,onClose:()=>x(!1),onNoteClick:A=>{A.pageNumber&&qe(A.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0}),u==="split"&&n&&m&&e.jsx(no,{modelMode:Ye,onResize:Je,initialWidth:ct,minWidth:350,maxWidth:800}),n&&m&&e.jsx("div",{className:`chat-container ${u==="floating"?"floating-chat":"split-chat"} ${F?"knowledge-notes-open":""}`,style:u==="split"?{"--chat-width":`${ct}px`}:void 0,children:e.jsx(Os,{selectedText:g,pdfText:j,onToggleLayout:fe,onToggleKnowledgeNotes:async()=>{F&&await he.endNoteModeTracking(),x(A=>!A)},showKnowledgeNotes:F,layout:u,currentPageNumber:f,pdfTotalPages:window.__pdfTotalPages,onCreateKnowledgeNote:zt,onClearSelectedText:()=>d(""),onOpenKnowledgeNotes:()=>{F||x(!0)},onModeChange:Ue,resetModeRef:xe,onRequestPageChange:P,modelMode:Ye,onModelModeChange:ht,onAddAnnotationToPDF:(A,z,oe)=>{if(window.__addPDFAnnotation){const ke=oe!==void 0?oe:.5,Ie={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:z,x:Math.max(0,Math.min(1-.3,.4-.15)),y:Math.max(0,Math.min(1-.2,ke-.1)),width:.3,height:.2,rotation:0,text:A,fontSize:14,color:Zs[0]};window.__addPDFAnnotation(Ie)}}})})]}),ee&&e.jsxs("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.7)",zIndex:9999,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:"white"},children:[e.jsx("div",{className:"loading-spinner",style:{width:"40px",height:"40px",border:"4px solid rgba(255, 255, 255, 0.3)",borderTop:"4px solid white",borderRadius:"50%",animation:"spin 1s linear infinite",marginBottom:"16px"}}),e.jsx("style",{children:`
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `}),e.jsx("h3",{children:"Uploading PDF..."}),e.jsx("p",{children:"This may take a moment for large files"})]}),e.jsx(eo,{isOpen:ie,onConfirm:wt,onCancel:Le}),Te&&e.jsx(to,{message:Te,type:"info",duration:3e3,onClose:()=>Ge(null)})]})}function ro(){return e.jsx(as,{children:e.jsx(gs,{children:e.jsx(ms,{children:e.jsx(oo,{})})})})}const tn=document.getElementById("root");if(!tn)throw new Error("Root element not found");try{ns.createRoot(tn).render(e.jsx(ss.StrictMode,{children:e.jsx(ro,{})}))}catch(t){tn.innerHTML=`
    <div style="padding: 20px; color: red;">
      <h1>Error Loading App</h1>
      <p>${t instanceof Error?t.message:String(t)}</p>
      <p>Check the browser console for more details.</p>
    </div>
  `}export{Ne as B,Zs as C,Et as _,he as a};
