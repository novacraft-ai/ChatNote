const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r as a,j as e,D as me,P as xe}from"./vendor-react-BWK-dEaB.js";import{_ as Jt,B as we,C as be,a as xt}from"./index-CwcTExBU.js";import{G as Ht}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-CLrFw-IM.js";const ye=({pageNumber:h,pageWidth:m,pageHeight:k,scale:g,annotations:_,selectedAnnotationId:D,onAnnotationUpdate:y,onAnnotationDelete:C,onAnnotationSelect:U,mode:rt})=>{const w=a.useRef(null),[V,lt]=a.useState(!1),[b,G]=a.useState(!1),[x,pt]=a.useState(!1),[ct,Q]=a.useState({x:0,y:0}),[tt,c]=a.useState(null),[R,F]=a.useState(null),[gt,N]=a.useState({x:0,y:0,angle:0}),[T,dt]=a.useState(null),et=_.filter(n=>n.pageNumber===h),nt=n=>n*m*g,p=n=>n*k*g,H=n=>n*m*g,Z=n=>n*k*g,P=n=>n/(m*g),ht=n=>n/(k*g),ot=a.useCallback((n,l,j,u)=>{const r=1-j,S=1-u;return{x:Math.max(0,Math.min(r,n)),y:Math.max(0,Math.min(S,l)),width:Math.max(.01,Math.min(1,j)),height:Math.max(.01,Math.min(1,u))}},[]),X=a.useCallback((n,l,j,u)=>{const r=document.createElement("div");r.style.position="absolute",r.style.visibility="hidden",r.style.width=`${j}px`,r.style.fontSize=`${l*u}px`,r.style.fontFamily="inherit",r.style.whiteSpace="pre-wrap",r.style.wordWrap="break-word",r.style.overflowWrap="break-word",r.style.padding=`${4*u}px`,r.style.boxSizing="border-box",r.style.lineHeight="1.2",r.textContent=n||"Text",document.body.appendChild(r);const S=r.scrollHeight;return document.body.removeChild(r),S},[]),St=a.useCallback((n,l)=>{n.stopPropagation();const j=n.target;if(j.classList.contains("resize-handle")){n.preventDefault(),G(!0),c(j.dataset.handle||null);const r=w.current?.getBoundingClientRect();r&&(Q({x:n.clientX-r.left,y:n.clientY-r.top}),F({x:n.clientX-r.left,y:n.clientY-r.top,width:l.width,height:l.height,annotationX:l.x,annotationY:l.y}));return}if(j.classList.contains("rotate-handle")){n.preventDefault(),pt(!0);const r=w.current?.getBoundingClientRect();if(r){const S=nt(l.x+l.width/2),v=p(l.y+l.height/2),M=n.clientX-r.left,st=n.clientY-r.top,wt=Math.atan2(st-v,M-S)*(180/Math.PI);N({x:M,y:st,angle:l.rotation-wt})}return}if(j.classList.contains("delete-button")){n.preventDefault(),C(l.id);return}n.preventDefault(),U(l.id),lt(!0);const u=w.current?.getBoundingClientRect();u&&Q({x:n.clientX-u.left-nt(l.x),y:n.clientY-u.top-p(l.y)})},[rt,nt,p,U,C]);a.useEffect(()=>{if(!V&&!b&&!x)return;const n=j=>{const u=w.current?.getBoundingClientRect();if(!u)return;const r=et.find(S=>S.id===D);if(r){if(x){const S=nt(r.x+r.width/2),v=p(r.y+r.height/2),M=j.clientX-u.left,st=j.clientY-u.top,wt=Math.atan2(st-v,M-S)*(180/Math.PI),ft=(gt.angle+wt)%360;Math.abs((r.rotation||0)-ft)>.01&&y({...r,rotation:ft})}else if(b&&tt&&R){const S=j.clientX-u.left,v=j.clientY-u.top,M=S-R.x,st=v-R.y,wt=.5,ft=M/(m*g)*wt,bt=st/(k*g)*wt;let Ct=R.annotationX,Et=R.annotationY,Ft=R.width,Pt=R.height;tt.includes("n")&&(Et=Math.max(0,R.annotationY+bt),Pt=Math.max(.01,R.height-bt)),tt.includes("s")&&(Pt=Math.max(.01,R.height+bt)),tt.includes("w")&&(Ct=Math.max(0,R.annotationX+ft),Ft=Math.max(.01,R.width-ft)),tt.includes("e")&&(Ft=Math.max(.01,R.width+ft));const vt=ot(Ct,Et,Ft,Pt);if(r.type==="textbox"){const Dt=r,It=H(vt.width),Tt=X(Dt.text,Dt.fontSize,It,g)/(k*g);if(Math.abs(Tt-vt.height)>.001){const Xt=Math.max(.01,Math.min(1,Tt)),Rt=ot(Ct,Et,vt.width,Xt);(Math.abs((r.x||0)-Rt.x)>1e-4||Math.abs((r.y||0)-Rt.y)>1e-4||Math.abs((r.width||0)-Rt.width)>1e-4||Math.abs((r.height||0)-Rt.height)>1e-4)&&y({...r,...Rt})}else(Math.abs((r.x||0)-vt.x)>1e-4||Math.abs((r.y||0)-vt.y)>1e-4||Math.abs((r.width||0)-vt.width)>1e-4||Math.abs((r.height||0)-vt.height)>1e-4)&&y({...r,...vt})}else y({...r,...vt})}else if(V){const S=P(j.clientX-u.left-ct.x),v=ht(j.clientY-u.top-ct.y),M=ot(S,v,r.width,r.height);(Math.abs((r.x||0)-M.x)>1e-4||Math.abs((r.y||0)-M.y)>1e-4)&&y({...r,...M})}}},l=()=>{if(b&&D){const j=et.find(u=>u.id===D);if(j&&j.type==="textbox"){const u=j,r=H(u.width),v=X(u.text,u.fontSize,r,g)/(k*g),M=ot(u.x,u.y,u.width,v);Math.abs(M.height-u.height)>.001&&y({...u,...M})}}lt(!1),G(!1),pt(!1),c(null),F(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",l),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",l)}},[V,b,x,tt,R,ct,gt,D,et,nt,p,H,Z,P,ht,ot,X,y,m,k,g]),a.useEffect(()=>{const n=l=>{(l.key==="Delete"||l.key==="Backspace")&&D&&l.target.tagName!=="INPUT"&&l.target.tagName!=="TEXTAREA"&&(l.preventDefault(),C(D))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[D,C]);const Mt=n=>{const l=n.id===D,j=nt(n.x),u=p(n.y),r=H(n.width),S=Z(n.height);return e.jsxs("div",{className:`annotation textbox-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${r}px`,height:`${S}px`,padding:`${4*g}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>St(v,n),children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),T===n.id?e.jsx("textarea",{className:"textbox-input",value:n.text,onChange:v=>{y({...n,text:v.target.value})},onBlur:v=>{const M=v.relatedTarget;M&&(M.closest(".textbox-controls")!==null||M.closest(".textbox-font-size-input")!==null||M.classList.contains("textbox-font-size-input")||M.closest(".floating-textbox-toolbar")!==null||M.closest(".color-swatch")!==null||M.classList.contains("toolbar-icon"))||(dt(null),U(null))},onKeyDown:v=>{v.key==="Enter"&&!v.shiftKey&&(v.preventDefault(),dt(null),U(null)),v.key==="Escape"&&(dt(null),U(null))},style:{fontSize:`${n.fontSize*g}px`,color:n.color,width:`${r}px`,maxWidth:`${r}px`,height:`${S}px`,maxHeight:`${S}px`},autoFocus:!0}):e.jsx("div",{className:"textbox-content",onClick:v=>{v.stopPropagation();const M=v.target;M.closest(".textbox-controls")!==null||M.closest(".textbox-font-size-input")!==null||M.closest(".textbox-color-button")!==null||M.closest(".textbox-color-picker")!==null||dt(n.id)},style:{fontSize:`${n.fontSize*g}px`,color:n.color},children:n.text||"Text"})]},n.id)},E=n=>{const l=n.id===D,j=nt(n.x),u=p(n.y),r=H(n.width),S=Z(n.height),v=n.width*m,M=n.height*k,st=n.imageWidth/n.imageHeight,wt=v/M;let ft,bt;return st>wt?(ft=r,bt=r/st):(bt=S,ft=S*st),e.jsxs("div",{className:`annotation image-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${ft}px`,height:`${bt}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:Ct=>St(Ct,n),children:[l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:Ct=>{Ct.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]}),e.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},A=n=>{const l=n.id===D,j=nt(n.x),u=p(n.y),r=H(n.width),S=Z(n.height);return e.jsx("div",{className:`annotation highlight-annotation ${l?"selected":""}`,style:{left:`${j}px`,top:`${u}px`,width:`${r}px`,height:`${S}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>St(v,n),children:l&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),e.jsx("div",{className:"resize-handle","data-handle":"ne"}),e.jsx("div",{className:"resize-handle","data-handle":"sw"}),e.jsx("div",{className:"resize-handle","data-handle":"se"}),e.jsx("div",{className:"resize-handle","data-handle":"n"}),e.jsx("div",{className:"resize-handle","data-handle":"s"}),e.jsx("div",{className:"resize-handle","data-handle":"w"}),e.jsx("div",{className:"resize-handle","data-handle":"e"}),e.jsx("div",{className:"rotate-handle"})]})},n.id)},yt=m*g,mt=k*g,Y={width:`${yt}px`,height:`${mt}px`,pointerEvents:"none"},L=et.find(n=>n.id===D&&n.type==="textbox"),[O,ut]=a.useState(null);return a.useEffect(()=>{if(!L||!w.current){ut(null);return}const n=nt(L.x),l=p(L.y);ut({left:n+H(L.width)/2,top:Math.max(0,l-40)})},[L,m,k,g,T]),e.jsxs("div",{ref:w,className:"annotation-layer",style:Y,children:[et.map(n=>n.type==="textbox"?Mt(n):n.type==="image"?E(n):n.type==="highlight"?A(n):null),L&&T===L.id&&O&&e.jsxs("div",{className:"floating-textbox-toolbar",style:{left:`${O.left}px`,top:`${O.top}px`,position:"absolute",zIndex:9999},onMouseDown:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"font-size-group",children:[e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=L.fontSize||16;y({...L,fontSize:Math.max(1,n-1)})},title:"Decrease font size",children:"−"}),e.jsx("span",{className:"font-size-display",children:L.fontSize||16}),e.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=L.fontSize||16;y({...L,fontSize:Math.min(200,n+1)})},title:"Increase font size",children:"+"})]}),e.jsx("div",{className:"color-swatch-group",children:["#000000","#ff0000","#0000ff","#00ff00","#ffeb3b"].map(n=>e.jsx("button",{className:`color-swatch ${L.color===n?"active":""}`,style:{backgroundColor:n},onClick:()=>y({...L,color:n}),title:n},n))})]})]})},ve=({mode:h,onModeChange:m,highlightColor:k="#ffeb3b",onHighlightColorChange:g,onHighlightClick:_,hasTextSelection:D=!1,isHighlightActive:y=!1,showColorPicker:C=!1,onImageUpload:U,layout:rt,onToggleLayout:w,onClearAll:V,pageNumber:lt,numPages:b,onPrevPage:G,onNextPage:x,scale:pt,onZoomIn:ct,onZoomOut:Q,onFitWidth:tt,onFitHeight:c,onZoomInputClick:R,isEditingZoom:F,zoomInputValue:gt,onZoomInputChange:N,onZoomInputBlur:T,onZoomInputKeyDown:dt,onZoomInputPaste:et,zoomInputRef:nt})=>{const p=a.useRef(null),[H,Z]=a.useState(!1),[P,ht]=a.useState(!1),ot=a.useRef(null),X=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];a.useEffect(()=>{const E=A=>{H&&(A.target.closest(".clear-button")||(Z(!1),ot.current&&(clearTimeout(ot.current),ot.current=null)))};if(H)return document.addEventListener("click",E),()=>{document.removeEventListener("click",E)}},[H]),a.useEffect(()=>{const E=()=>{window.innerWidth>720&&P&&ht(!1)};return window.addEventListener("resize",E),()=>window.removeEventListener("resize",E)},[P]);const St=E=>{const A=E.target.files?.[0];A&&A.type.startsWith("image/")&&U(A),m(null),p.current&&(p.current.value="")},Mt=E=>{E.stopPropagation(),H?(V&&V(),Z(!1),ot.current&&(clearTimeout(ot.current),ot.current=null)):(Z(!0),ot.current=setTimeout(()=>{Z(!1),ot.current=null},3e3))};return e.jsxs("div",{className:"annotation-toolbar",children:[e.jsxs("div",{className:"toolbar-left",children:[e.jsx("button",{type:"button",className:`toolbar-button mobile-tools-toggle ${P?"active":""}`,onClick:()=>ht(E=>!E),"aria-pressed":P,"aria-expanded":P,"aria-label":P?"Hide annotation tools":"Show annotation tools",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"})]})}),e.jsxs("div",{className:`toolbar-section annotation-tools ${P?"mobile-expanded":""}`,children:[e.jsx("button",{className:`toolbar-button ${y?"active":""}`,onClick:_,disabled:!D,title:D?y?"Remove highlight":"Highlight text":"Select text to highlight",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),e.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),e.jsx("button",{className:`toolbar-button ${h==="textbox"?"active":""}`,onClick:()=>m("textbox"),title:"Add text box",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M4 7V4h16v3M9 20h6M12 4v16"})})}),e.jsx("button",{className:`toolbar-button ${h==="image"?"active":""}`,onClick:()=>{m("image"),p.current?.click()},title:"Add image",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]})}),V&&e.jsx("button",{className:`toolbar-button clear-button ${H?"confirming":""}`,onClick:Mt,title:H?"Click again to clear all":"Clear all",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),e.jsx("input",{ref:p,type:"file",accept:"image/*",onChange:St,style:{display:"none"}})]}),C&&g&&e.jsx("div",{className:"toolbar-section color-picker",children:X.map(E=>e.jsx("button",{className:`color-button ${k===E?"active":""}`,style:{backgroundColor:E},onClick:()=>g(E),title:"Highlight color"},E))})]}),e.jsxs("div",{className:"toolbar-center",children:[lt!==void 0&&b!==void 0&&e.jsxs("div",{className:"toolbar-section pdf-navigation",children:[e.jsx("button",{className:"toolbar-button nav-button",onClick:G,disabled:lt<=1,title:"Previous page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsxs("span",{className:"page-info",children:[lt," / ",b]}),e.jsx("button",{className:"toolbar-button nav-button",onClick:x,disabled:lt>=b,title:"Next page",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),pt!==void 0&&e.jsxs("div",{className:"toolbar-section zoom-controls",children:[e.jsx("button",{onClick:tt,className:"toolbar-button",title:"Fit width",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"5 9 2 12 5 15"}),e.jsx("polyline",{points:"19 9 22 12 19 15"}),e.jsx("line",{x1:"2",y1:"12",x2:"22",y2:"12"})]})}),e.jsx("button",{onClick:c,className:"toolbar-button",title:"Fit height",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"9 5 12 2 15 5"}),e.jsx("polyline",{points:"9 19 12 22 15 19"}),e.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22"})]})}),e.jsx("button",{onClick:Q,className:"toolbar-button",title:"Zoom out",children:e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),F?e.jsx("input",{ref:nt,type:"text",inputMode:"numeric",value:gt,onChange:N,onBlur:T,onKeyDown:dt,onPaste:et,className:"zoom-input"}):e.jsxs("span",{className:"zoom-level",onClick:R,title:"Click to edit zoom",children:[Math.round((pt||1)*100),"%"]}),e.jsx("button",{onClick:ct,className:"toolbar-button",title:"Zoom in",children:e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]}),e.jsx("div",{className:"toolbar-right",children:e.jsx("div",{className:"toolbar-section toolbar-actions",children:e.jsx("button",{className:"toolbar-button layout-toggle-button",onClick:w,title:rt==="floating"?"Switch to split layout":"Switch to floating layout",children:rt==="floating"?e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]}):e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})})})]})},je=({pageNumber:h,pageWidth:m,pageHeight:k,scale:g,knowledgeNotes:_,showKnowledgeNotes:D,onNoteClick:y})=>{const C=_.filter(w=>w.pageNumber===h);if(!D||C.length===0)return null;const U=m*g,rt=k*g;return e.jsx("div",{className:"knowledge-note-connections",style:{width:`${U}px`,height:`${rt}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:e.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:C.map((w,V)=>{const lt=U-25,b=25+V*35;return e.jsxs("g",{children:[e.jsx("circle",{cx:lt,cy:b,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:G=>{G.stopPropagation(),y?.(w)},style:{cursor:"pointer",pointerEvents:"all"}}),e.jsx("text",{x:lt,y:b,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:V+1}),e.jsx("line",{x1:lt,y1:b+12,x2:lt,y2:b+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},w.id)})})})};let Ot,zt=null,Kt=!1;async function ke(){if(!Ot)try{Ot=await Jt(()=>import("./vendor-CLrFw-IM.js").then(h=>h.o),__vite__mapDeps([0,1]))}catch(h){throw console.error("Failed to load pdf-lib:",h),new Error("PDF library not available. Please install pdf-lib.")}return Ot}async function Ce(){if(!Kt){Kt=!0;try{const h=await Jt(()=>import("./vendor-CLrFw-IM.js").then(m=>m.p),__vite__mapDeps([0,1]));return h.default?zt=h.default:zt=h,zt&&typeof zt.create=="function"?zt:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(h){return console.warn("Failed to load fontkit, falling back to standard fonts:",h),null}}return zt}async function Ne(){try{const h=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],m="/ChatNote/",g=`${m.endsWith("/")?m:`${m}/`}NotoSans-Regular.ttf`;try{const _=await fetch(g);if(_.ok){const D=await _.arrayBuffer();if(D.byteLength>1e3){const y=new Uint8Array(D);if(y.length>=4&&y[0]===0&&y[1]===1&&y[2]===0&&y[3]===0)return D}}}catch{}for(const _ of h)if(!_.includes("fonts.googleapis.com/css"))try{const D=await fetch(_,{mode:"cors",cache:"default"});if(D.ok){const y=await D.arrayBuffer();if(y.byteLength>1e3){const C=new Uint8Array(y),U=C.length>=4&&C[0]===0&&C[1]===1&&C[2]===0&&C[3]===0,rt=C.length>=4&&C[0]===119&&C[1]===79&&C[2]===70&&C[3]===70,w=C.length>=4&&C[0]===119&&C[1]===79&&C[2]===70&&C[3]===50;if(U||rt||w)return y;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(h){return console.warn("Failed to load Unicode font:",h),null}}async function Se(h,m,k){try{const g=await ke(),{PDFDocument:_,rgb:D,degrees:y,StandardFonts:C}=g;if(!C)throw new Error("StandardFonts not available from pdf-lib");const U=await h.arrayBuffer(),rt=await _.load(U);let w=null;try{const b=await Ce();if(b){try{rt.registerFontkit(b)}catch(x){(!x.message||!x.message.includes("already registered"))&&console.warn("Failed to register fontkit:",x)}const G=await Ne();if(G){const x=new Uint8Array(G),pt=x.length>=4&&x[0]===0&&x[1]===1&&x[2]===0&&x[3]===0,ct=x.length>=4&&x[0]===79&&x[1]===84&&x[2]===84&&x[3]===79,Q=x.length>=4&&x[0]===116&&x[1]===116&&x[2]===99&&x[3]===102,tt=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===70,c=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===50;tt||c?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):pt||ct||Q?w=await rt.embedFont(G):console.warn(`Invalid font format. File size: ${x.length} bytes`)}}}catch(b){console.warn("Failed to embed Unicode font, falling back to standard font:",b)}if(!w){const b=C.Helvetica||C.TimesRoman;if(!b)throw new Error("No standard font available");w=await rt.embedFont(b)}if(!w)throw new Error("Failed to embed font");const V=rt.getPages();for(const b of m){const G=V[b.pageNumber-1];if(!G)continue;const x=k.get(b.pageNumber);if(!x)continue;const{width:pt,height:ct}=x;let Q=b.width*pt,tt=b.height*ct;if(b.type==="textbox"){const c=b,R=Me(c.color)||{r:0,g:0,b:0},F=b.x*pt,gt=b.y*ct;let N=(b.y+b.height)*ct;const T=4,dt=Q-T*2,et=(c.text||"").trimEnd();let p=et.split(/\r\n|\r|\n/).filter(Y=>Y!=null);for(;p.length>0&&p[p.length-1].length===0;)p.pop();if(p.length===0&&(p=[""]),p.length===1&&w&&typeof w.widthOfTextAtSize=="function"){const Y=p[0],L=dt;let O;try{O=w.widthOfTextAtSize(Y,c.fontSize)}catch{O=Y.length*c.fontSize*.5}if(O>L){const ut=[],n=Y.split(/(\s+)/);let l="";for(let j=0;j<n.length;j++){const u=n[j],r=l+u;let S;try{S=w.widthOfTextAtSize(r,c.fontSize)}catch{S=r.length*c.fontSize*.5}S<=L||l===""?l=r:(l.trim()&&ut.push(l.trim()),l=u)}l.trim()&&ut.push(l.trim()),ut.length>1&&(p=ut)}}const H=c.fontSize*1.2;tt=p.length>0?(p.length-1)*H+c.fontSize+T*2:c.fontSize+T*2,N=gt+tt;const ht=ct-N,X=ct-gt-ht,Mt=ht+X/2,E=c.fontSize*.2,A=ct-c.fontSize*.2,yt=Math.max(E,Math.min(A,Mt));if((p.length>1||et.includes(`
`)||et.includes("\r"))&&p.length>0)try{const Y=(p.length-1)*H,L=yt+Y/2;p.forEach((O,ut)=>{const n=L-ut*H;let l;try{w&&typeof w.widthOfTextAtSize=="function"?l=w.widthOfTextAtSize(O,c.fontSize):l=O.length*c.fontSize*.5}catch{l=O.length*c.fontSize*.5}let u=F+T+dt/2-l/2;const r=F+T,S=F+Q-l-T;u=Math.max(r,Math.min(S,u));const v=O.length>0?O:" ";G.drawText(v,{x:u,y:n,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})})}catch(Y){if(Y.message&&Y.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",Y.message);const L=p.map(n=>n.split("").map(l=>l.charCodeAt(0)>255?"?":l).join("")),O=(L.length-1)*H,ut=yt+O/2;try{L.forEach((n,l)=>{const j=ut-l*H;let u;try{w&&typeof w.widthOfTextAtSize=="function"?u=w.widthOfTextAtSize(n,c.fontSize):u=n.length*c.fontSize*.5}catch{u=n.length*c.fontSize*.5}let S=F+T+dt/2-u/2;const v=F+T,M=F+Q-u-T;S=Math.max(v,Math.min(M,S)),G.drawText(n,{x:S,y:j,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})})}catch(n){console.error("Failed to draw text even after replacing Unicode characters:",n);continue}}else throw Y}else{let Y;try{w&&typeof w.widthOfTextAtSize=="function"?Y=w.widthOfTextAtSize(c.text,c.fontSize):Y=c.text.length*c.fontSize*.5}catch{Y=c.text.length*c.fontSize*.5}let O=F+T+dt/2-Y/2;const ut=F+T,n=F+Q-Y-T;O=Math.max(ut,Math.min(n,O));try{G.drawText(c.text,{x:O,y:yt,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})}catch(l){if(l.message&&l.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",l.message);const j=c.text.split("").map(u=>u.charCodeAt(0)>255?"?":u).join("");try{G.drawText(j,{x:O,y:yt,size:c.fontSize,color:D(R.r/255,R.g/255,R.b/255),rotate:y(c.rotation),font:w})}catch(u){console.error("Failed to draw text even after replacing Unicode characters:",u);continue}}else throw l}}}else if(b.type==="image"){const c=b,R=await fetch(c.imageData).then(P=>P.arrayBuffer());let F;if(c.imageData.startsWith("data:image/png"))F=await rt.embedPng(R);else if(c.imageData.startsWith("data:image/jpeg")||c.imageData.startsWith("data:image/jpg"))F=await rt.embedJpg(R);else throw console.error("Unsupported image format for PDF embedding:",c.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const gt=c.imageWidth/c.imageHeight;let N=Q,T=tt;Q/tt>gt?N=tt*gt:T=Q/gt;const et=b.x*pt,nt=(b.y+b.height)*ct,Z=ct-nt+(tt-T)/2;G.drawImage(F,{x:et,y:Z,width:N,height:T,rotate:y(c.rotation)})}}const lt=await rt.save();return new Blob([lt],{type:"application/pdf"})}catch(g){throw console.error("Error saving annotated PDF:",g),new Error("Failed to save annotated PDF")}}function Me(h){const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(h);return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:null}function qt(h,m="annotated.pdf"){const k=URL.createObjectURL(h),g=document.createElement("a");g.href=k,g.download=m,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(k)}const $t="chatnote_pdf_history_cache",De=300*1e3;function Yt(h=3){const m=localStorage.getItem($t);let k=[];try{if(m){const g=JSON.parse(m);g&&Array.isArray(g.pdfs)&&(k=g.pdfs.slice(0,h))}}catch{}return k}function Re(h){try{const m={pdfs:h,timestamp:Date.now()};localStorage.setItem($t,JSON.stringify(m))}catch{}}function ze(h=De){try{const m=localStorage.getItem($t);if(!m)return!1;const k=JSON.parse(m);return!k||typeof k.timestamp!="number"?!1:Date.now()-k.timestamp<h}catch{return!1}}async function Ee(h=3){try{const m=localStorage.getItem("auth_token");if(!m)return Yt(h);const k=Yt(h),g=ze(),_=fetch(`${we}/api/drive/history`,{headers:{Authorization:`Bearer ${m}`}}).then(async y=>{if(!y.ok){if(y.status===403){try{localStorage.removeItem($t)}catch{}return[]}return[]}const U=(await y.json()).pdfs||[];return Re(U),U.slice(0,h)}).catch(()=>[]);if(g)return _.catch(()=>{}),k;const D=await _;return D.length>0?D:k}catch{return Yt(h)}}const Fe="/ChatNote/assets/chatnote-logo-BGY00N4J.svg";function Be({file:h,onFileUpload:m,onTextSelection:k,layout:g="floating",onPageChange:_,onTotalPagesChange:D,showKnowledgeNotes:y=!0,knowledgeNotes:C=[],onScrollToPage:U,onNoteClick:rt,onAddAnnotation:w,initialAnnotations:V=[],onAnnotationsChange:lt,isLoadingPdf:b=!1,onLoadingComplete:G,isSavingSession:x=!1,onNewSession:pt,onToggleLayout:ct,isDriveAuthorized:Q,onSelectRecentPdf:tt}){const[c,R]=a.useState(0),[F,gt]=a.useState(1),[N,T]=a.useState(1),[dt,et]=a.useState(!1),[nt,p]=a.useState("100"),H=a.useRef(null),Z=a.useRef(new Map),P=a.useRef(null),ht=a.useRef(null),ot=a.useRef(!1),X=a.useRef(new Map),[St,Mt]=a.useState(0),[E,A]=a.useState(V),[yt,mt]=a.useState(null),[Y,L]=a.useState(null),[O,ut]=a.useState(null),[n,l]=a.useState(null),[j,u]=a.useState(!1),[r,S]=a.useState("#ffeb3b"),[v,M]=a.useState(!1),st=a.useRef(V),wt=a.useRef(lt);a.useEffect(()=>{wt.current=lt},[lt]),a.useEffect(()=>{const t=st.current,o=V.length!==t.length||V.some((i,d)=>i.id!==t[d]?.id);V&&V.length>0&&o?(A(V),st.current=V):h&&V.length===0&&t.length>0?(A([]),st.current=[],mt(null)):!h&&t.length>0&&(A([]),st.current=[],mt(null))},[V,h]),a.useEffect(()=>{JSON.stringify(st.current)!==JSON.stringify(E)&&wt.current&&(st.current=E,wt.current(E))},[E]),a.useEffect(()=>{const t=console.warn,o=console.error;return console.warn=(...i)=>{const d=i.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")||i.some(s=>typeof s=="string"&&(s.includes("TextLayer task cancelled")||s.includes("AbortException")))||t.apply(console,i)},console.error=(...i)=>{const d=i.join(" ");d.includes("TextLayer task cancelled")||d.includes("AbortException")&&d.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=t,console.error=o}},[]);const ft=a.useMemo(()=>h?URL.createObjectURL(h):null,[h]),bt=a.useRef(null);a.useEffect(()=>(bt.current&&bt.current!==ft&&URL.revokeObjectURL(bt.current),bt.current=ft,()=>{ft&&URL.revokeObjectURL(ft)}),[ft]);const Ct=a.useMemo(()=>{let t;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";t=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Ht&&(Ht.workerSrc=t,Ht.standardFontDataUrl=o),{workerSrc:t,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),Et=({numPages:t})=>{R(t),D?.(t);const o=1;gt(o),setTimeout(()=>{_?.(o)},0),Z.current.clear(),X.current.clear(),G&&setTimeout(()=>{G()},300)},Ft=t=>{if(!X.current.has(t.pageNumber))try{const o=t.page;let i,d;o.viewport?(i=o.viewport.width,d=o.viewport.height):(i=o.width/N,d=o.height/N),X.current.set(t.pageNumber,{width:i,height:d})}catch(o){console.warn("Error getting page dimensions:",o);const i=t.page,d=i.width/N,s=i.height/N;X.current.set(t.pageNumber,{width:d,height:s})}};a.useEffect(()=>{if(!P.current||c===0)return;let t=null,o=!1;const i=()=>{if(ot.current||o||t)return;o=!0,t=setTimeout(()=>{t=null,o=!1},100);const s=P.current;if(!s){o=!1;return}const f=s.getBoundingClientRect(),$=f.top,z=f.height,K=$+z/2;if(s.scrollTop<100){gt(I=>I!==1?(setTimeout(()=>{_?.(1)},0),1):I);return}let it=1,B=0;for(let I=1;I<=c;I++){const W=Z.current.get(I);if(W){const at=W.getBoundingClientRect(),J=s.getBoundingClientRect(),kt=Math.max(J.top,at.top),jt=Math.min(J.bottom,at.bottom),Nt=Math.max(0,jt-kt);Nt>B&&(B=Nt,it=I)}}if(B<z*.1){let I=1,W=1/0;for(let at=1;at<=c;at++){const J=Z.current.get(at);if(J){const kt=J.getBoundingClientRect(),jt=kt.top+kt.height/2,Nt=Math.abs(jt-K);Nt<W&&(W=Nt,I=at)}}it=I}gt(I=>it!==I?(setTimeout(()=>{_?.(it)},0),it):I)},d=P.current;return d?.addEventListener("scroll",i,{passive:!0}),()=>{t&&clearTimeout(t),d?.removeEventListener("scroll",i)}},[c,_]),a.useEffect(()=>{let t=null;const o=()=>{t&&clearTimeout(t),t=setTimeout(()=>{Mt(i=>i+1)},150)};return window.addEventListener("resize",o),()=>{t&&clearTimeout(t),window.removeEventListener("resize",o)}},[]);const Pt=t=>{console.error("PDF load error:",t)},vt=async t=>{const o=t.target.files?.[0];if(o&&o.type==="application/pdf"){m(o);const i=o.size/(1024*1024),d=xt.generateDocumentId();xt.setCurrentDocument(d),await xt.createDocument(d,i),await xt.trackPDFUpload(i,d)}},Dt=a.useCallback(t=>{const o=Z.current.get(t);o&&P.current&&(ot.current=!0,gt(t),_?.(t),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{ot.current=!1},1500))},[_]);a.useEffect(()=>(U&&(window.__pdfScrollToPage=Dt),P.current&&(window.__pdfContentRef=P.current),ht.current&&(window.__pdfViewerHeight=ht.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Dt,U,c,N]);const It=()=>{const t=Math.max(1,F-1);Dt(t)},_t=()=>{const t=Math.min(c,F+1);Dt(t)},Tt=()=>{const t=Math.min(N+.2,5);T(t),p(Math.round(t*100).toString())},Xt=()=>{const t=Math.max(N-.2,.25);T(t),p(Math.round(t*100).toString())};a.useEffect(()=>{dt||p(Math.round(N*100).toString())},[N,dt]);const Rt=()=>{et(!0),p(Math.round(N*100).toString())},Gt=t=>{let o=t.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),p(o)},Qt=()=>{At()},te=t=>{if(t.key==="Enter")t.preventDefault(),At();else if(t.key==="Escape")et(!1),p(Math.round(N*100).toString()),H.current?.blur();else{if(t.key==="Backspace"||t.key==="Delete"||t.key==="ArrowLeft"||t.key==="ArrowRight"||t.key==="Tab")return;(t.key==="-"||t.key==="+"||t.key==="."||t.key===","||t.key==="e"||t.key==="E"||!/[0-9]/.test(t.key)&&!t.ctrlKey&&!t.metaKey)&&t.preventDefault()}},ee=t=>{t.preventDefault();const i=t.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const s=(i.replace(/^0+/,"")||"0").slice(0,3);if(p(s),s&&s!=="0"){const f=parseInt(s,10);if(!isNaN(f)&&f>0){const $=Math.max(25,Math.min(500,f)),z=$/100;T(z),p($.toString()),et(!1)}}}},At=()=>{if(nt.trim()===""||nt==="0"){p(Math.round(N*100).toString()),et(!1);return}const t=parseInt(nt,10);if(isNaN(t)||t<=0){p(Math.round(N*100).toString()),et(!1);return}const o=Math.max(25,Math.min(500,t)),i=o/100;T(i),p(o.toString()),et(!1)};a.useEffect(()=>{dt&&H.current&&(H.current.focus(),H.current.select())},[dt]);const ne=()=>{if(X.current.size===0)return;let t=null;if(P.current){const s=P.current,f=getComputedStyle(s),$=parseFloat(f.paddingLeft||"0")||0,z=parseFloat(f.paddingRight||"0")||0;t=s.clientWidth-$-z,s.scrollHeight>s.clientHeight&&(t-=12),t=Math.max(0,t-4)}else if(ht.current){const s=ht.current.getBoundingClientRect();t=Math.max(0,s.width-40)}if(!t||t<=0)return;const o=X.current.get(1);if(!o)return;const i=t/o.width*.999,d=Math.max(.1,Math.min(i,5));T(d),p(Math.round(d*100).toString())},oe=()=>{if(!ht.current||X.current.size===0)return;const t=ht.current.getBoundingClientRect();let o=0;const i=ht.current.querySelector(".annotation-toolbar");i&&(o=i.getBoundingClientRect().height);const d=t.height-o,s=X.current.get(F);if(!s)return;const f=d/s.height,$=Math.max(.1,Math.min(f,5));T($),p(Math.round($*100).toString())},Ut=a.useCallback(()=>{const t=window.getSelection();if(t&&t.toString().trim()){const o=t.toString().trim();let i,d;if(t.rangeCount>0&&P.current){const f=t.getRangeAt(0).getBoundingClientRect(),$=P.current.getBoundingClientRect(),z=f.top-$.top+P.current.scrollTop;for(let K=1;K<=c;K++){const q=Z.current.get(K);if(q){const it=q.offsetTop,B=q.offsetHeight,I=it+B;if(z>=it&&z<=I){d=K;const W=(z-it)/B;i=Math.max(0,Math.min(1,W)),ut({text:o,pageNumber:K,rect:f,pageElement:q});const at=E.find(J=>J.type==="highlight"&&J.pageNumber===K&&Math.abs(J.x-Math.max(0,Math.min(1,(f.left-q.getBoundingClientRect().left)/q.offsetWidth)))<.01&&Math.abs(J.y-Math.max(0,Math.min(1,W)))<.01);l(at?.id||null);break}}}}k(o,d,i)}else k("",void 0,void 0),ut(null),l(null),u(!1)},[k,c,E]),se=a.useCallback(t=>{const o=t.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.closest(".floating-textbox-toolbar")!==null||o.closest(".color-swatch")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker")||o.classList.contains("floating-textbox-toolbar")||o.classList.contains("color-swatch"))return;const d=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const s=window.getSelection(),f=s&&s.toString().trim().length>0;if(f||k(""),!d&&!f&&mt(null),Y==="textbox"&&!d&&!f){const $=P.current;if(!$)return;let z=F,K=.5,q=.5;for(let B=1;B<=c;B++){const I=Z.current.get(B);if(I){const W=I.getBoundingClientRect();if($.getBoundingClientRect()){const J=t.clientX-W.left,kt=t.clientY-W.top;if(J>=0&&J<=W.width&&kt>=0&&kt<=W.height){z=B;const jt=X.current.get(B);if(jt){const Nt=W.width/jt.width,pe=W.height/jt.height;K=J/(jt.width*Nt),q=kt/(jt.height*pe)}break}}}}if(X.current.get(z)){const B=Math.max(0,Math.min(.8,K-.1)),I=Math.max(0,Math.min(1-.1,q-.05)),W={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:z,x:B,y:I,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:be[0]};A(at=>[...at,W]),mt(W.id),L("select")}}},100)},[k,Y,F,c,N,mt,L,A]),Lt=a.useCallback(t=>{A(d=>[...d,t]),mt(t.id);let o="text";t.type==="highlight"?o="highlight":t.type==="image"?o="image":t.type==="textbox"&&(o="text"),xt.trackAnnotationAdded(o);const i=xt.getCurrentDocumentId();i&&xt.updateDocument(i,{has_annotations:!0})},[]);a.useEffect(()=>(w&&(window.__addPDFAnnotation=t=>{A(o=>[...o,t]),mt(t.id),t.pageNumber&&U&&U(t.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[w,U]);const Wt=a.useCallback((t,o,i)=>{const d=t.width*o.width*i,s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${d}px`,s.style.fontSize=`${t.fontSize*i}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*i}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=t.text||"Text",document.body.appendChild(s);const f=s.scrollHeight;document.body.removeChild(s);const $=f/(o.height*i);return Math.max(.01,Math.min(1,$))},[]),ie=a.useCallback(t=>{A(o=>{let i=!1;const d=o.map(s=>{if(s.id!==t.id)return s;if(t.type==="textbox"){const f=t,$=X.current.get(f.pageNumber);if($){const z=Wt(f,$,N);return Math.abs((s.height||0)-z)>1e-4||Math.abs((s.x||0)-(f.x||0))>1e-4||Math.abs((s.y||0)-(f.y||0))>1e-4||Math.abs((s.width||0)-(f.width||0))>1e-4||Math.abs((s.rotation||0)-(f.rotation||0))>1e-4||s.type==="textbox"&&(s.text!==f.text||s.color!==f.color||s.fontSize!==f.fontSize)?(i=!0,{...f,height:z}):s}}return Math.abs((s.x||0)-(t.x||0))>1e-4||Math.abs((s.y||0)-(t.y||0))>1e-4||Math.abs((s.width||0)-(t.width||0))>1e-4||Math.abs((s.height||0)-(t.height||0))>1e-4||Math.abs((s.rotation||0)-(t.rotation||0))>1e-4||"color"in s&&"color"in t&&s.color!==t.color?(i=!0,t):s});return i?d:o})},[N,Wt]);a.useEffect(()=>{A(t=>t.map(o=>{if(o.type==="textbox"){const i=o,d=X.current.get(i.pageNumber);if(d){const s=Wt(i,d,N);return{...i,height:s}}}return o}))},[N,Wt]);const ae=a.useCallback(t=>{A(o=>o.filter(i=>i.id!==t)),yt===t&&mt(null)},[yt]),re=a.useCallback(async t=>{if(!h||!X.current.get(F))return;const i=new FileReader;i.onload=d=>{const s=d.target?.result,f=new Image;f.onload=()=>{const $=!s.startsWith("data:image/png")&&!s.startsWith("data:image/jpeg")&&!s.startsWith("data:image/jpg");let z=s;if($){const at=document.createElement("canvas");at.width=f.width,at.height=f.height;const J=at.getContext("2d");J&&(J.drawImage(f,0,0),z=at.toDataURL("image/png"))}const K=.2,q=f.width/f.height,it=K/q,W={id:`image-${Date.now()}`,type:"image",pageNumber:F,x:.4,y:.4,width:K,height:it,rotation:0,imageData:z,imageWidth:f.width,imageHeight:f.height};Lt(W),L("select")},f.src=s},i.readAsDataURL(t)},[h,F,Lt,L]),le=a.useCallback(()=>{if(!O)return;const{pageNumber:t,rect:o,pageElement:i}=O;if(n)A(d=>d.filter(s=>s.id!==n)),l(null),u(!1);else{const d=i.offsetWidth,s=i.offsetHeight,f=i.getBoundingClientRect(),$=(o.left-f.left)/d,z=(o.top-f.top)/s,K=o.width/d,q=o.height/s,it={id:crypto.randomUUID(),type:"highlight",pageNumber:t,x:Math.max(0,Math.min(1,$)),y:Math.max(0,Math.min(1,z)),width:Math.max(.01,Math.min(1,K)),height:Math.max(.01,Math.min(1,q)),rotation:0,color:r,opacity:.4};A(B=>[...B,it]),l(it.id),u(!0)}},[O,n,r]),ce=a.useCallback(t=>{S(t),n&&A(o=>o.map(i=>i.id===n&&i.type==="highlight"?{...i,color:t}:i))},[n]),Vt=a.useCallback(async()=>{if(h)try{if(E.length===0){const d=h.name;qt(h,d),await xt.trackPDFExport(!1);const s=xt.getCurrentDocumentId();s&&await xt.updateDocument(s,{has_export:!0});return}const t=await Se(h,E,X.current),o=h.name.replace(".pdf","_annotated.pdf");qt(t,o),await xt.trackPDFExport(!0);const i=xt.getCurrentDocumentId();i&&await xt.updateDocument(i,{has_export:!0})}catch(t){console.error("Error saving PDF:",t),alert("Failed to save annotated PDF. Please check the console for details.")}},[h,E]);a.useEffect(()=>{const t=()=>{pt&&pt()},o=()=>{Vt()};return window.addEventListener("pdf-new-session",t),window.addEventListener("pdf-download",o),()=>{window.removeEventListener("pdf-new-session",t),window.removeEventListener("pdf-download",o)}},[pt,Vt]);const de=a.useCallback(t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy",M(!0)},[]),he=a.useCallback(t=>{t.preventDefault(),t.stopPropagation(),P.current?.contains(t.relatedTarget)||M(!1)},[]),ue=a.useCallback(async t=>{t.preventDefault(),t.stopPropagation();const i=Array.from(t.dataTransfer.files).filter(z=>z.type.startsWith("image/"));if(i.length===0||!P.current?.getBoundingClientRect())return;let s=F,f=.5,$=.5;for(let z=1;z<=c;z++){const K=Z.current.get(z);if(K){const q=K.getBoundingClientRect();if(P.current?.getBoundingClientRect()){const B=t.clientX-q.left,I=t.clientY-q.top;if(B>=0&&B<=q.width&&I>=0&&I<=q.height){s=z;const W=X.current.get(z);W&&(f=B/(W.width*N),$=I/(W.height*N));break}}}}for(const z of i){const K=new FileReader;K.onload=q=>{const it=q.target?.result,B=new Image;B.onload=()=>{if(!X.current.get(s))return;const W=.2,at=B.width/B.height,J=W/at,kt=Math.max(0,Math.min(1-W,f-W/2)),jt=Math.max(0,Math.min(1-J,$-J/2)),Nt={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:s,x:kt,y:jt,width:W,height:J,rotation:0,imageData:it,imageWidth:B.width,imageHeight:B.height};Lt(Nt)},B.src=it},K.readAsDataURL(z)}},[F,c,N,Lt]),[Bt,fe]=a.useState(()=>Yt(3)),[ge,Zt]=a.useState(!1);if(a.useEffect(()=>{let t=!0;return Q&&Ee(3).then(o=>{t&&o&&o.length>0&&fe(o)}).catch(()=>{}),()=>{t=!1}},[Q]),a.useEffect(()=>{if(Q&&Bt&&Bt.length>0){const t=requestAnimationFrame(()=>Zt(!0));return()=>cancelAnimationFrame(t)}Zt(!1)},[Q,Bt]),!h&&!b){const t=Bt;return e.jsx("div",{className:`pdf-viewer-empty ${g==="floating"?"float-layout":""}`,children:e.jsxs("div",{className:"start-page-content",children:[e.jsxs("div",{className:"start-top",children:[e.jsx("img",{src:Fe,alt:"ChatNote Logo",className:"start-logo"}),e.jsxs("div",{className:"upload-container",children:[e.jsxs("label",{htmlFor:"pdf-upload",className:"upload-button modern-upload",children:[e.jsx("span",{className:"upload-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 19V6M5 12l7-7 7 7"}),e.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1"})]})}),e.jsx("span",{children:"Upload PDF"})]}),e.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:vt,style:{display:"none"}})]})]}),Q&&t.length>0&&e.jsxs("div",{className:"recent-pdf-suggestions",children:[e.jsx("div",{className:"suggestions-title",children:"Recent PDFs"}),e.jsx("div",{className:`suggestions-list ${ge?"show":""}`,children:t.map((o,i)=>e.jsxs("button",{className:"suggestion-card",onClick:()=>tt&&tt(o.pdfId),children:[e.jsx("span",{className:"suggestion-icon","aria-hidden":"true",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsx("span",{className:"suggestion-name",children:o.displayName||o.originalFileName})]},o.pdfId||i))})]})]})})}return e.jsxs("div",{className:`pdf-viewer ${x?"saving-session":""}`,ref:ht,children:[b&&e.jsx("div",{className:"pdf-loading-overlay",children:e.jsxs("div",{className:"pdf-loading-spinner",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Loading PDF..."})]})}),x&&e.jsx("div",{className:"pdf-saving-overlay",children:e.jsxs("div",{className:"pdf-saving-content",children:[e.jsx("div",{className:"saving-spinner"}),e.jsx("p",{children:"Saving PDF..."}),e.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})}),e.jsx(ve,{mode:Y,onModeChange:L,highlightColor:r,onHighlightColorChange:ce,onHighlightClick:le,hasTextSelection:!!O,isHighlightActive:!!n,showColorPicker:j,onImageUpload:re,onToggleLayout:ct,onClearAll:()=>{A([]),mt(null)},pageNumber:F,numPages:c,onPrevPage:It,onNextPage:_t,scale:N,onZoomIn:Tt,onZoomOut:Xt,onFitWidth:ne,onFitHeight:oe,layout:g,onZoomInputClick:Rt,isEditingZoom:dt,zoomInputValue:nt,onZoomInputChange:Gt,onZoomInputBlur:Qt,onZoomInputKeyDown:te,onZoomInputPaste:ee,zoomInputRef:H}),e.jsx("div",{ref:P,className:`pdf-content ${v?"drag-over":""}`,onMouseUp:Ut,onKeyUp:Ut,onClick:se,onDragOver:de,onDragLeave:he,onDrop:t=>{M(!1),ue(t)},children:h&&e.jsx(me,{file:ft||h,onLoadSuccess:Et,onLoadError:Pt,loading:e.jsx("div",{className:"loading",children:"Loading PDF..."}),error:e.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",e.jsx("br",{}),e.jsxs("small",{children:["Worker: ",Ht?.workerSrc||"Not set"]})]}),noData:e.jsx("div",{className:"loading",children:"No PDF file selected"}),options:Ct,children:Array.from(new Array(c),(t,o)=>{const i=o+1,d=X.current.get(i);return e.jsxs("div",{ref:s=>{s?Z.current.set(i,s):Z.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[e.jsx(xe,{pageNumber:i,scale:N,devicePixelRatio:window.devicePixelRatio||1,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:s=>Ft({pageNumber:i,page:s})},`page_${i}_${St}`),d&&e.jsxs(e.Fragment,{children:[e.jsx(ye,{pageNumber:i,pageWidth:d.width,pageHeight:d.height,scale:N,annotations:E,selectedAnnotationId:yt,onAnnotationUpdate:ie,onAnnotationDelete:ae,onAnnotationSelect:mt,mode:Y}),y&&e.jsx(je,{pageNumber:i,pageWidth:d.width,pageHeight:d.height,scale:N,knowledgeNotes:C,showKnowledgeNotes:y,layout:g,onNoteClick:rt})]})]},`page-wrapper-${i}`)})})})]})}export{Be as default};
