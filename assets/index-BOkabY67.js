const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PDFViewer-CTMDzOzL.js","assets/vendor-react-BWK-dEaB.js","assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css","assets/vendor-pdf-DDxsMbbh.js","assets/vendor-react-CBXYWCWZ.css","assets/PDFViewer-CjfT7EIe.css"])))=>i.map(i=>d[i]);
import{r,j as e,M as Ft,R as En,a as An}from"./vendor-react-BWK-dEaB.js";import{p as Mn}from"./vendor-pdf-DDxsMbbh.js";import{k as Lt,l as _t,n as Rt}from"./vendor-CLrFw-IM.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))o(l);new MutationObserver(l=>{for(const p of l)if(p.type==="childList")for(const h of p.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&o(h)}).observe(document,{childList:!0,subtree:!0});function i(l){const p={};return l.integrity&&(p.integrity=l.integrity),l.referrerPolicy&&(p.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?p.credentials="include":l.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function o(l){if(l.ep)return;l.ep=!0;const p=i(l);fetch(l.href,p)}})();if(typeof window<"u"){let t;{const o="/ChatNote/";t=`${o.endsWith("/")?o:`${o}/`}pdf.worker.min.js`}const n=o=>{try{if(o)if(!o.GlobalWorkerOptions)o.GlobalWorkerOptions={workerSrc:t};else try{o.GlobalWorkerOptions.workerSrc=t}catch{try{Object.defineProperty(o,"GlobalWorkerOptions",{value:{workerSrc:t},writable:!0,configurable:!0})}catch{}}}catch{}};window.pdfjsLib||(window.pdfjsLib={}),window.pdfjsLib.GlobalWorkerOptions?window.pdfjsLib.GlobalWorkerOptions.workerSrc=t:window.pdfjsLib.GlobalWorkerOptions={workerSrc:t},typeof window.pdfjs>"u"&&(window.pdfjs={}),window.pdfjs.GlobalWorkerOptions?window.pdfjs.GlobalWorkerOptions.workerSrc=t:window.pdfjs.GlobalWorkerOptions={workerSrc:t};const i=Mn;if(n(i),i.default&&n(i.default),i.GlobalWorkerOptions)try{i.GlobalWorkerOptions.workerSrc=t}catch{}}const Tn="modulepreload",In=function(t){return"/ChatNote/"+t},tn={},ut=function(n,i,o){let l=Promise.resolve();if(i&&i.length>0){let j=function(f){return Promise.all(f.map(u=>Promise.resolve(u).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const h=document.querySelector("meta[property=csp-nonce]"),k=h?.nonce||h?.getAttribute("nonce");l=j(i.map(f=>{if(f=In(f),f in tn)return;tn[f]=!0;const u=f.endsWith(".css"),m=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${m}`))return;const w=document.createElement("link");if(w.rel=u?"stylesheet":Tn,u||(w.as="script"),w.crossOrigin="",w.href=f,k&&w.setAttribute("nonce",k),document.head.appendChild(w),u)return new Promise((x,E)=>{w.addEventListener("load",x),w.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${f}`)))})}))}function p(h){const k=new Event("vite:preloadError",{cancelable:!0});if(k.payload=h,window.dispatchEvent(k),!k.defaultPrevented)throw h}return l.then(h=>{for(const k of h||[])k.status==="rejected"&&p(k.reason);return n().catch(p)})},un=r.createContext(void 0);function $n({children:t}){const[n,i]=r.useState(()=>localStorage.getItem("theme")||"light");r.useEffect(()=>{document.documentElement.setAttribute("data-theme",n),localStorage.setItem("theme",n)},[n]);const o=()=>{i(l=>l==="light"?"dark":"light")};return e.jsx(un.Provider,{value:{theme:n,toggleTheme:o},children:t})}function Mt(){const t=r.useContext(un);if(t===void 0)throw new Error("useTheme must be used within a ThemeProvider");return t}const ot=["meta-llama/llama-4-scout-17b-16e-instruct","meta-llama/llama-4-maverick-17b-128e-instruct","llama-3.3-70b-versatile"],ht=["openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-32b"],Dn=["openai/gpt-oss-120b","openai/gpt-oss-20b"],Fn=["qwen/qwen3-32b"];function Ln(t){return Dn.includes(t)}function _n(t){return Fn.includes(t)}const jt={primary:"groq/compound",fallback:"groq/compound-mini"},Rn=["moonshotai/kimi-k2-instruct-0905","openai/gpt-oss-safeguard-20b"],Ce="https://chatnote-backend-8pk3.onrender.com",nn="105659660993-u7lnrcbis23u3mlaigteag67d6h6inar.apps.googleusercontent.com",hn=r.createContext(void 0);function On({children:t}){const[n,i]=r.useState(null),[o,l]=r.useState(!0);r.useEffect(()=>{const j=localStorage.getItem("auth_token");j?p(j):l(!1)},[]);const p=async(j,f=0)=>{let m=!1;try{const w=new AbortController,x=setTimeout(()=>w.abort(),1e4),E=await fetch(`${Ce}/api/auth/me`,{headers:{Authorization:`Bearer ${j}`},signal:w.signal});if(clearTimeout(x),E.ok){const D=await E.json();i(D.user),m=!0}else if(E.status===401||E.status===403)console.warn("Token invalid, logging out"),localStorage.removeItem("auth_token"),i(null),m=!0;else{if(f<2)return console.warn(`Failed to fetch user (${E.status}), retrying... (${f+1}/2)`),await new Promise(D=>setTimeout(D,1e3*(f+1))),p(j,f+1);console.error("Failed to fetch user after retries, but keeping token:",E.status),m=!0}}catch(w){if(f<2){const x=w instanceof Error?w.name:"Unknown";return console.warn(`Network error (${x}), retrying... (${f+1}/2)`),await new Promise(E=>setTimeout(E,1e3*(f+1))),p(j,f+1)}else w instanceof Error&&w.name==="AbortError"?console.warn("Request timeout after retries, but keeping user logged in"):console.error("Network error fetching user after retries, but keeping token:",w),m=!0}finally{m&&l(!1)}},h=async j=>{try{const f=await fetch(`${Ce}/api/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:j})});if(!f.ok){const m=await f.json();throw new Error(m.error||"Authentication failed")}const u=await f.json();localStorage.setItem("auth_token",u.token),i(u.user)}catch(f){throw console.error("Login error:",f),console.error("Failed URL:",`${Ce}/api/auth/google`),f}},k=async()=>{const j=localStorage.getItem("auth_token");if(j)try{await fetch(`${Ce}/api/drive/revoke`,{method:"POST",headers:{Authorization:`Bearer ${j}`}}).catch(()=>{})}catch(f){console.warn("Error revoking Drive access during logout:",f)}localStorage.removeItem("auth_token");try{localStorage.removeItem("chatnote_pdf_history_cache")}catch(f){console.warn("Failed to clear PDF history cache:",f)}i(null)};return e.jsx(hn.Provider,{value:{user:n,loading:o,login:h,logout:k,isAuthenticated:!!n,isAdmin:n?.role==="admin"},children:t})}function ft(){const t=r.useContext(hn);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}const fn=r.createContext(void 0);function Hn({children:t}){const[n,i]=r.useState(()=>{const p=localStorage.getItem("chatVisible");return p!==null?p==="true":!0});r.useEffect(()=>{localStorage.setItem("chatVisible",String(n))},[n]);const o=()=>{i(p=>!p)},l=p=>{i(p)};return e.jsx(fn.Provider,{value:{isChatVisible:n,toggleChatVisibility:o,setChatVisible:l},children:t})}function gn(){const t=r.useContext(fn);if(t===void 0)throw new Error("useChatVisibility must be used within a ChatVisibilityProvider");return t}const mn=r.createContext(void 0);function Bn({children:t,hasUnsavedChanges:n,saveCurrentState:i,isSavingSession:o,setIsSavingSession:l}){return e.jsx(mn.Provider,{value:{hasUnsavedChanges:n,saveCurrentState:i,isSavingSession:o,setIsSavingSession:l},children:t})}function zn(){const t=r.useContext(mn);if(t===void 0)throw new Error("useSave must be used within a SaveProvider");return t}function pn(){return localStorage.getItem("auth_token")}function Wn(t){if(ot.includes(t)){const n=ot.indexOf(t);return ot.slice(n)}if(ht.includes(t)){const n=ht.indexOf(t);return ht.slice(n)}return t===jt.primary?[jt.primary,jt.fallback]:[t]}function qn(t,n){if(n===429||n>=500&&n<600)return!0;const i=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return["rate limit","too many requests","service unavailable","internal server error","bad gateway","gateway timeout","timeout"].some(l=>i.toLowerCase().includes(l))}function sn(t,n){if(n===429)return"Rate limit reached. Please wait a moment and try again.";if(n===401)return"Authentication failed. Please log in again.";if(n===400){const o=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return o.includes("API key not configured")?"API key not configured. Please add your API key in settings.":o.includes("model")||o.includes("invalid")?"Invalid request. Please try again or select a different model.":"Invalid request. Please check your input and try again."}if(n===403)return"Access denied. Please check your API key permissions.";if(n===404)return"Model not found. Please select a different model.";if(n>=500&&n<600)return"Service temporarily unavailable. Please try again in a moment.";const i=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return console.error("API error details (not shown to user):",{status:n,message:i,error:t}),"An error occurred while processing your request. Please try again."}async function At(t,n,i,o,l,p){const h=pn();if(!h)throw new Error("Authentication required. Please log in.");const k=o||ot[0],j=Wn(k),f=p||!1;let u=null;for(const m of j)try{const w={messages:t,context:n,model:m,temperature:.7,maxTokens:3e3,stream:!!i};f&&ht.includes(m)&&(Ln(m)?w.include_reasoning=!0:_n(m)&&(w.reasoning_format="parsed"));let x;try{x=await fetch(`${Ce}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${h}`},body:JSON.stringify(w),signal:l})}catch($){throw $ instanceof DOMException&&$.name==="AbortError"?new DOMException("Request aborted by user","AbortError"):$}if(!x.ok){let $;try{const y=await x.text();try{$=JSON.parse(y)}catch{$={error:{message:y||"Unknown error"}}}}catch{$={error:{message:"Unknown error"}}}if(x.status===401)throw localStorage.removeItem("auth_token"),new Error("Session expired. Please log in again.");if(x.status===400&&$.error?.message?.includes("API key not configured"))throw new Error("API key not configured. Please add your Groq API key in settings.");const a=qn($,x.status),c=j.length>1&&m!==j[j.length-1];if(a&&c){u=new Error(sn($,x.status));continue}const g=sn($,x.status);throw console.error("Backend error response (details logged, user sees sanitized message):",$),new Error(g)}if(i&&x.body){const $=x.body.getReader(),a=new TextDecoder;let c="",g="",y="";for(;;){if(l?.aborted)throw $.cancel(),new DOMException("Request aborted by user","AbortError");let C,O;try{const B=await $.read();C=B.done,O=B.value}catch(B){throw B instanceof DOMException&&B.name==="AbortError"?($.cancel(),new DOMException("Request aborted by user","AbortError")):B}if(C)break;y+=a.decode(O,{stream:!0});const G=y.split(`
`);y=G.pop()||"";for(const B of G){const Y=B.trim();if(Y&&Y.startsWith("data: ")){const re=Y.slice(6);if(re==="[DONE]")continue;try{const pe=JSON.parse(re).choices?.[0]?.delta;pe?.content&&(c+=pe.content,i(pe.content)),pe?.reasoning&&(g+=pe.reasoning)}catch(ne){console.warn("Failed to parse streaming chunk:",ne)}}}}if(y.trim()){const C=y.trim();if(C.startsWith("data: ")){const O=C.slice(6);if(O!=="[DONE]")try{const B=JSON.parse(O).choices?.[0]?.delta;B?.content&&(c+=B.content,i(B.content)),B?.reasoning&&(g+=B.reasoning)}catch{}}}return g?`__REASONING_START__${g}__REASONING_END__${c}`:c}const D=(await x.json()).choices[0]?.message;let q=D?.content||"No response from API";const I=D?.reasoning,L=D?.executed_tools;let N="";if(L&&L.length>0){const $=L.find(a=>a.search_results);if($?.search_results?.results&&$.search_results.results.length>0){const a=$.search_results.results;N=`

---

## Sources

`,a.forEach((c,g)=>{N+=`${g+1}. [${c.title}](${c.url})
`})}}return N&&(q=q+N),I?`__REASONING_START__${I}__REASONING_END__${q}`:q}catch(w){if(m===j[j.length-1])throw w instanceof DOMException&&w.name==="AbortError"?w:u||(console.error("Chat service error:",w),w);u=w instanceof Error?w:new Error(String(w))}throw u||new Error("Unable to process your request. Please try again later.")}async function xn(){const t=pn();if(!t)return!1;try{const n=await fetch(`${Ce}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(n.ok){const i=await n.json();return i.hasApiKey||i.isAdmin}if(n.status===429)throw new Error("Rate limited");return!1}catch(n){if(n instanceof Error&&n.message==="Rate limited")throw n;return!1}}function Gn(){const{user:t,login:n,logout:i,loading:o}=ft(),{hasUnsavedChanges:l,saveCurrentState:p,setIsSavingSession:h}=zn(),[k,j]=r.useState(!1),[f,u]=r.useState(null),[m,w]=r.useState(!1),x=async()=>{if(l)if(window.confirm("You have unsaved changes to your PDF annotations and notes. Would you like to save them before logging out?")){w(!0),h(!0);try{await p(),await i()}catch(L){console.error("Error saving or logging out:",L)}finally{w(!1),h(!1)}}else await i();else window.confirm("Are you sure you want to log out?")&&await i()};r.useEffect(()=>{const I=console.error,L=console.warn;console.error=(...$)=>{const a=$.join(" ");a.includes("Not signed in with the identity provider")||a.includes("AbortError")||a.includes("signal is aborted")||a.includes("FedCM get() rejects")||a.includes("GSI_LOGGER")||a.includes("Only one navigator.credentials.get request may be outstanding")||I.apply(console,$)},console.warn=(...$)=>{const a=$.join(" ");a.includes("GSI_LOGGER")||a.includes("Not signed in with the identity provider")||a.includes("Only one navigator.credentials.get request may be outstanding")||L.apply(console,$)};const N=window.onerror;return window.onerror=($,a,c,g,y)=>typeof $=="string"&&($.includes("Not signed in with the identity provider")||$.includes("Only one navigator.credentials.get request may be outstanding")||$.includes("AbortError")||a?.includes("accounts.google.com"))?!0:N?N($,a,c,g,y):!1,()=>{console.error=I,console.warn=L,window.onerror=N}},[]);const E=r.useCallback(async I=>{try{await n(I.credential);const L=document.getElementById("google-signin-button");L&&L.remove()}catch(L){console.error("Login failed:",L),alert(L instanceof Error?L.message:"Login failed. Please try again.")}},[n]);r.useEffect(()=>{if(t)return;if(window.google){try{window.google.accounts.id.initialize({client_id:nn,callback:E}),j(!0)}catch(N){console.error("Failed to initialize Google OAuth:",N),u("Failed to initialize Google OAuth")}return}const I=document.createElement("script");I.src="https://accounts.google.com/gsi/client",I.async=!0,I.defer=!0,I.onload=()=>{if(window.google)try{window.google.accounts.id.initialize({client_id:nn,callback:E,use_fedcm_for_prompt:!0}),j(!0)}catch(N){console.error("Failed to initialize Google OAuth:",N),u("Failed to initialize Google OAuth")}else console.error("Google script loaded but window.google is not available"),u("Google script failed to load")},I.onerror=()=>{console.error("Failed to load Google Identity Services script"),u("Failed to load Google Sign-In script"),j(!1)};const L=setTimeout(()=>{window.google||(console.error("Google script loading timeout"),u("Google Sign-In is taking too long to load"),j(!1))},1e4);return document.head.appendChild(I),()=>{clearTimeout(L)}},[E,t]),r.useEffect(()=>{if(t){const I=document.getElementById("google-login-backdrop"),L=document.getElementById("google-signin-button");I&&I.remove(),L&&L.remove()}},[t]);const D=()=>{const I=document.getElementById("google-login-backdrop"),L=document.getElementById("google-signin-button");I&&I.remove(),L&&L.remove();const N=document.createElement("div");N.id="google-login-backdrop",N.style.position="fixed",N.style.top="0",N.style.left="0",N.style.width="100%",N.style.height="100%",N.style.backgroundColor="rgba(0, 0, 0, 0.5)",N.style.zIndex="9999",N.style.display="flex",N.style.alignItems="center",N.style.justifyContent="center";const $=()=>{N.remove(),c.remove(),document.removeEventListener("keydown",a)};N.addEventListener("click",g=>{g.target===N&&$()});const a=g=>{g.key==="Escape"&&$()};document.addEventListener("keydown",a);const c=document.createElement("div");c.id="google-signin-button",c.style.position="relative",c.style.background="white",c.style.padding="20px",c.style.borderRadius="8px",c.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",c.style.zIndex="10000",c.addEventListener("click",g=>{g.stopPropagation()}),N.appendChild(c),document.body.appendChild(N);try{window.google.accounts.id.renderButton(c,{theme:"outline",size:"large",text:"signin_with",width:250})}catch(g){console.warn("Could not render Google button, showing manual login option:",g),c.innerHTML=`
                <p style="margin: 0 0 10px 0; text-align: center;">Sign in with Google</p>
                <button onclick="window.location.href='https://accounts.google.com/signin'" 
                        style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Continue with Google
                </button>
                <button onclick="document.getElementById('google-login-backdrop')?.remove(); document.getElementById('google-signin-button')?.remove();" 
                        style="margin-top: 10px; padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Cancel
                </button>
              `;const y=c.querySelector("button:last-child");y&&y.addEventListener("click",()=>{document.removeEventListener("keydown",a)})}},q=()=>{if(f){alert(`Google Sign-In error: ${f}. Please check the browser console.`);return}if(window.google&&k)try{window.google.accounts.id.prompt(I=>{const L=I.getNotDisplayedReason?.(),N=I.getSkippedReason?.(),$=I.getDismissedReason?.(),a=I.isNotDisplayed?.(),c=I.isSkippedMoment?.(),g=I.isDismissedMoment?.();(L||N||$||a||c||g)&&D()}),setTimeout(()=>{document.getElementById("google-login-backdrop")||D()},500)}catch(I){console.error("Error showing Google sign-in:",I),D()}else alert("Google Sign-In is still loading. Please wait a moment and try again.")};return o&&!t?e.jsx("div",{className:"login-button loading",children:e.jsx("span",{children:"Loading..."})}):t?e.jsxs("div",{className:"login-button user-info",children:[e.jsx("div",{className:"user-avatar",children:t.picture?e.jsx("img",{src:t.picture,alt:t.name||t.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:I=>{const L=I.target;L.style.display="none";const N=L.parentElement;if(N){const $=N.querySelector("span");$&&$.remove();const a=document.createElement("span");a.textContent=t.name?.[0]||t.email[0].toUpperCase(),N.appendChild(a)}}}):e.jsx("span",{children:t.name?.[0]||t.email[0].toUpperCase()})}),e.jsxs("div",{className:"user-details",children:[e.jsx("span",{className:"user-name",children:t.name||t.email}),t.role==="admin"&&e.jsx("span",{className:"user-role",children:"Admin"})]}),e.jsx("button",{onClick:x,className:"logout-button",title:m?"Saving changes...":"Logout",disabled:m,children:m?e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",opacity:"0.75",children:e.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"0 12 12",to:"360 12 12",dur:"1s",repeatCount:"indefinite"})})]}):e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e.jsx("polyline",{points:"16 17 21 12 16 7"}),e.jsx("line",{x1:"21",y1:"12",x2:"9",y2:"12"})]})})]}):f&&!k?e.jsxs("button",{onClick:q,className:"login-button sign-in error",title:f,children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Sign in (Error)"]}):e.jsx("button",{onClick:q,className:"login-button sign-in",disabled:!k,title:k?"Sign in with Google":"Loading Google Sign-In...",children:k?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"}),e.jsx("path",{d:"M3 20a6 6 0 0 1 6-6h6a6 6 0 0 1 6 6v1H3v-1Z"})]}),e.jsx("span",{className:"button-text-desktop",children:"Sign in with Google"}),e.jsx("span",{className:"button-text-mobile",children:"Sign in"})]}):e.jsx("span",{children:"Loading Google Sign-In..."})})}async function Un(t){const n=await fetch(`${Ce}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)throw new Error("Failed to check API key status");return n.json()}async function Vn(t,n){const i=await fetch(`${Ce}/api/user/api-key`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})});if(!i.ok){const o=await i.json();throw new Error(o.error||"Failed to save API key")}}function Kn(){const{user:t,isAdmin:n}=ft(),[i,o]=r.useState(""),[l,p]=r.useState(!1),[h,k]=r.useState(!1),[j,f]=r.useState(!1),[u,m]=r.useState(null);r.useEffect(()=>{t&&!n?w():n&&p(!0)},[t,n]);const w=async()=>{if(t){k(!0);try{const E=localStorage.getItem("auth_token");if(!E)return;const D=await Un(E);p(D.hasApiKey)}catch(E){console.error("Failed to load API key status:",E)}finally{k(!1)}}},x=async()=>{if(!(!t||!i.trim())){f(!0),m(null);try{const E=localStorage.getItem("auth_token");if(!E)throw new Error("Not authenticated");await Vn(E,i.trim()),m({type:"success",text:"API key saved securely!"}),o(""),p(!0)}catch(E){m({type:"error",text:E instanceof Error?E.message:"Failed to save API key"})}finally{f(!1)}}};return t?n?e.jsx("div",{className:"api-key-settings",children:e.jsxs("div",{className:"api-key-info admin",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"api-key-title",children:"Admin Account"}),e.jsx("p",{className:"api-key-description",children:"You're using the admin API key. No configuration needed."})]})]})}):h?e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Loading..."})}):e.jsxs("div",{className:"api-key-settings",children:[e.jsxs("div",{className:"api-key-header",children:[e.jsx("h3",{children:"Groq API Key"}),l&&e.jsx("span",{className:"api-key-status-badge",children:"Configured"})]}),e.jsx("p",{className:"api-key-description",children:l?"Your API key is securely stored and encrypted. You can update it below.":"Enter your Groq API key to use the chat feature. Your key will be encrypted and stored securely."}),e.jsxs("div",{className:"api-key-input-group",children:[e.jsx("input",{type:"password",value:i,onChange:E=>o(E.target.value),placeholder:"gsk_...",className:"api-key-input",disabled:j}),e.jsx("button",{onClick:x,disabled:!i.trim()||j,className:"api-key-save-button",children:j?"Saving...":l?"Update":"Save"})]}),u&&e.jsx("div",{className:`api-key-message ${u.type}`,children:u.text}),e.jsxs("div",{className:"api-key-help",children:[e.jsx("p",{children:e.jsx("strong",{children:"Don't have an API key?"})}),e.jsxs("ol",{children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://console.groq.com/keys",target:"_blank",rel:"noopener noreferrer",children:"Groq Console"})]}),e.jsx("li",{children:"Sign up or log in"}),e.jsx("li",{children:"Create a new API key"}),e.jsx("li",{children:"Copy and paste it here"})]}),e.jsx("p",{className:"api-key-security-note",children:"ðŸ”’ Your API key is encrypted with AES-256 and stored securely. Only you can use it."})]})]}):e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Please sign in to configure your API key."})})}const Yn="/ChatNote/assets/ucla-logo-BjjJ2cYq.svg";function Qn({onOpenHistory:t,isSavingSession:n=!1}){const{theme:i,toggleTheme:o}=Mt(),{isChatVisible:l,toggleChatVisibility:p}=gn(),{user:h}=ft(),[k,j]=r.useState(!1),f=r.useRef(null),u=r.useRef(null),m=r.useRef(null),w=h?.email?.endsWith("@g.ucla.edu")??!1;return r.useEffect(()=>{const x=setTimeout(()=>{f.current&&f.current.classList.add("animation-complete"),u.current&&u.current.classList.add("animation-complete"),m.current&&m.current.classList.add("animation-complete")},13500);return()=>clearTimeout(x)},[]),e.jsxs(e.Fragment,{children:[e.jsx("nav",{className:"navbar",children:e.jsxs("div",{className:"navbar-content",children:[t&&e.jsx("button",{className:"history-toggle",onClick:t,title:"PDF History","aria-label":"Open PDF history",disabled:n,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),e.jsxs("div",{className:"navbar-title",children:[e.jsx("span",{ref:f,className:"title-text",children:"ChatNote"}),w&&e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:u,className:"title-for",children:"for"}),e.jsx("img",{ref:m,src:Yn,alt:"UCLA",className:"ucla-logo"})]})]}),e.jsxs("div",{className:"navbar-actions",children:[e.jsx(Gn,{}),e.jsx("button",{className:"settings-toggle",onClick:()=>j(!k),title:"Settings","aria-label":"Settings",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"})]})}),e.jsx("button",{className:"chat-toggle",onClick:p,title:l?"Hide chat":"Show chat","aria-label":l?"Hide chat":"Show chat",disabled:n,children:l?e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"})]}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18",strokeWidth:"2.5"})]})}),e.jsx("button",{className:"theme-toggle",onClick:o,title:`Switch to ${i==="light"?"dark":"light"} mode`,"aria-label":`Switch to ${i==="light"?"dark":"light"} mode`,children:i==="light"?e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"5"}),e.jsx("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),e.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),e.jsx("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),e.jsx("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),e.jsx("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),e.jsx("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),e.jsx("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),e.jsx("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]})})]})]})}),k&&e.jsx("div",{className:"settings-modal-overlay",onClick:()=>j(!1),children:e.jsxs("div",{className:"settings-modal",onClick:x=>x.stopPropagation(),children:[e.jsxs("div",{className:"settings-modal-header",children:[e.jsx("h2",{children:"Settings"}),e.jsx("button",{className:"settings-modal-close",onClick:()=>j(!1),"aria-label":"Close settings",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("div",{className:"settings-modal-content",children:e.jsx(Kn,{})})]})})]})}function on({mode:t,onModeChange:n,disabled:i=!1}){const[o,l]=r.useState(!1),[p,h]=r.useState(0),[k,j]=r.useState(!1),[f,u]=r.useState(!1),m=r.useRef(null),w=r.useRef(null),x=["auto","reasoning","advanced"],E={auto:"Auto",reasoning:"Reasoning",advanced:"Advanced"},D={auto:"ChatNote will choose the best model automatically - best for daily use",reasoning:"Uses advanced reasoning models for complex problems with thinking process",advanced:"Most capable model for challenging tasks that need real-time information (limited usage)"},q=r.useCallback(()=>{const c=x.indexOf(t),g=m.current?.offsetWidth||80,y=w.current?.offsetWidth||20,G=(g-4-y)/(x.length-1);return c*G},[t]),I=c=>{i||(l(!0),j(!1),h(c.clientX),c.preventDefault(),c.stopPropagation())},L=r.useCallback(c=>{if(!o||i)return;const g=c.clientX-p;Math.abs(g)>3&&j(!0);const y=m.current?.offsetWidth||80,C=w.current?.offsetWidth||20,O=4,B=(y-O-C)/(x.length-1),Y=m.current?.getBoundingClientRect();if(!Y)return;const re=c.clientX-Y.left-O/2-C/2,ne=Math.round(re/B),pe=Math.max(0,Math.min(x.length-1,ne)),xe=x[pe];xe!==t&&n(xe)},[o,i,p,t,n]),N=r.useCallback(()=>{if(o&&(l(!1),!k)){const g=(x.indexOf(t)+1)%x.length;n(x[g])}},[o,k,t,n]);r.useEffect(()=>{if(o)return document.addEventListener("mousemove",L),document.addEventListener("mouseup",N),()=>{document.removeEventListener("mousemove",L),document.removeEventListener("mouseup",N)}},[o,L,N]);const $=c=>{if(i||o)return;const g=m.current?.getBoundingClientRect();if(!g)return;const y=c.clientX-g.left,C=g.width,O=w.current?.offsetWidth||20,G=4,Y=(C-G-O)/(x.length-1),re=y-G/2-O/2,ne=Math.round(re/Y),pe=Math.max(0,Math.min(x.length-1,ne)),xe=x[pe];xe!==t&&n(xe)},a=q();return e.jsxs("div",{className:"model-mode-toggle-wrapper",children:[e.jsx("div",{ref:m,className:`model-mode-toggle ${t} ${i?"disabled":""} ${o?"dragging":""}`,onMouseDown:I,onClick:$,children:e.jsx("div",{className:"model-mode-toggle-track",children:e.jsx("div",{ref:w,className:"model-mode-toggle-button",style:{transform:`translateX(${a}px)`,transition:o?"none":"transform 0.3s ease"}})})}),e.jsx("div",{className:"model-mode-toggle-label",children:E[t]}),e.jsxs("div",{className:"model-mode-info-icon-wrapper",onMouseEnter:()=>u(!0),onMouseLeave:()=>u(!1),children:[e.jsxs("svg",{className:"model-mode-info-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),f&&e.jsx("div",{className:"model-mode-tooltip",children:D[t]})]})]})}function Ot(t){if(!t||typeof t!="string")return"";let n=t.replace(/[\u2000-\u200B\u202F\u205F\u3000]/g," ");n=n.replace(/\u2011/g,"-"),n=n.replace(/(<[^>]*>)([^<]*)(<\/[^>]*>)/g,(a,c,g,y)=>{const C=g.replace(/\u2011/g,"-");return C!==g?c+C+y:a}),n=n.replace(/[\u2013\u2014]/g,"-"),n=n.replace(/[\u2018\u2019]/g,"'"),n=n.replace(/[\u201C\u201D]/g,'"'),n=n.replace(/\n{4,}/g,`


`),n=n.replace(/\$\$[\s\S]*?\$\$/g,a=>a.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-")),n=n.replace(/\$[^$\n]+?\$/g,a=>a.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-"));const i=[],o=a=>`__MATH_PLACEHOLDER_${a}__`;n=n.replace(/\$\$[\s\S]*?\$\$/g,a=>{const c=a.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return i.push(c),o(i.length-1)}),n=n.replace(/\\\(([\s\S]*?)\\\)/g,(a,c)=>{let g=c.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");g=g.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const y=`$${g}$`;return i.push(y),o(i.length-1)}),n=n.replace(/\$[^$\n]+?\$/g,a=>{const c=a.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return i.push(c),o(i.length-1)}),n=n.replace(/\\\[([\s\S]*?)\\\]/g,(a,c)=>{let g=c.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");g=g.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const y=`$$${g}$$`;return i.push(y),o(i.length-1)});const l=[],p=/\(([^()]*?(?:[\\_^]|\\[a-zA-Z@]+\{[^}]*\}|\\pm|\\sim|\\times|\\div|\\sqrt|\\frac|\\text\{|\\approx|\\leq|\\geq|\\neq|\\sum|\\int|\\prod|=\s*\\[a-zA-Z@]+|~\s*\\[a-zA-Z@]+)[^()]*?)\)/g;let h;for(;(h=p.exec(n))!==null;){const a=h[0],c=h.index,g=c>0?n[c-1]:"",y=c+a.length<n.length?n[c+a.length]:"";g==="$"&&y==="$"||n.substring(Math.max(0,c-2),c).includes("](")||g==="`"||y==="`"||n.substring(Math.max(0,c-10),c+a.length+10).includes("__MATH_PLACEHOLDER")||l.push({match:a,index:c})}const k=[],j=/\\[a-zA-Z@]+(?:_[a-zA-Z0-9{}]+|\^[a-zA-Z0-9{}]+)?\s*[~Â±â‰¤â‰¥â‰ â‰ˆ=]\s*[^.,;:!?\n]{5,150}?(?=\s|$|[.,;:!?]|\\[a-zA-Z@]|_[a-zA-Z0-9]|\^[a-zA-Z0-9])/g;let f;for(;(f=j.exec(n))!==null;){const a=f.index;let c=f[0];const g=Math.max(c.indexOf("~"),c.indexOf("="),c.indexOf("Â±"),c.indexOf("â‰¤"),c.indexOf("â‰¥"),c.indexOf("â‰ "),c.indexOf("â‰ˆ"));if(g===-1||g===c.length-1)continue;const y=c.substring(g+1);if(!/\\[a-zA-Z@]+|_[a-zA-Z0-9{}]|\^[a-zA-Z0-9{}]/.test(y))continue;const C=/[.,;:!?]/.exec(c);C&&C.index>10&&C.index<c.length-5&&(c=c.substring(0,C.index+1));const O=a>0?n[a-1]:"",G=a+c.length<n.length?n[a+c.length]:"";if(O==="$"||G==="$"||O==="`"||G==="`"||n.substring(Math.max(0,a-10),a+c.length+10).includes("__MATH_PLACEHOLDER"))continue;!l.some(Y=>{const re=Y.index,ne=re+Y.match.length;return a>=re&&a+c.length<=ne})&&c.length>10&&k.push({match:c,index:a})}const u=[],m=(a,c)=>{let g=0,y=c;for(;y<a.length;){if(a[y]==="{")g++;else if(a[y]==="}"&&(g--,g===0))return y+1;y++}return-1},w=/\\sqrt\[[^\]]+\](?=\{)/g;let x;for(;(x=w.exec(n))!==null;){const a=x.index,c=a+x[0].length;if(n[c]==="{"){const g=m(n,c);if(g!==-1){const y=n.substring(a,g),C=a>0?n[a-1]:"",O=g<n.length?n[g]:"";C!=="$"&&O!=="$"&&!n.substring(Math.max(0,a-10),g+10).includes("__MATH_PLACEHOLDER")&&u.push({match:y,index:a})}}}const E=/\\(sqrt|frac|text|overline|underline)(?=\{)/g;let D;for(;(D=E.exec(n))!==null;){const a=D.index,c=D[1],g=a+D[0].length;if(n[g]==="{")if(c==="frac"){const y=m(n,g);if(y===-1||n[y]!=="{")continue;const C=m(n,y);if(C===-1)continue;const O=n.substring(a,C),G=a>0?n[a-1]:"",B=C<n.length?n[C]:"";G!=="$"&&B!=="$"&&!n.substring(Math.max(0,a-10),C+10).includes("__MATH_PLACEHOLDER")&&u.push({match:O,index:a})}else{const y=m(n,g);if(y===-1)continue;const C=n.substring(a,y),O=a>0?n[a-1]:"",G=y<n.length?n[y]:"";O!=="$"&&G!=="$"&&!n.substring(Math.max(0,a-10),y+10).includes("__MATH_PLACEHOLDER")&&(l.some(Y=>{const re=Y.index,ne=re+Y.match.length;return a>=re&&y<=ne})||k.some(Y=>{const re=Y.index,ne=re+Y.match.length;return a>=re&&y<=ne})||u.push({match:C,index:a}))}}n=n.replace(/(\$?\s*)(\d{1,3}(?:\s+\d{3})+)(\b)/g,(a,c,g,y)=>{const C=g.replace(/\s+/g,",");return c.trim().startsWith("$")?`$${C}$${y}`:c+C+y}),n=n.replace(/\$(\d{1,3}(?:,\d{3})+)(?![$])/g,(a,c,g,y)=>{if((g>0?y[g-1]:"")==="$")return a;const O=g+a.length;if(O<y.length&&y[O]==="$")return a;const G=O<y.length?y[O]:"";return G===" "||/[.,;:!?)]/.test(G)?`$${c}$${G}`:`$${c}$`});const q=/(\d+)\{,\}(\d+)/g,I=[];let L;for(;(L=q.exec(n))!==null;){const a=L.index,c=L[0],g=a>0?n[a-1]:"",y=a+c.length<n.length?n[a+c.length]:"";if(g==="$"||y==="$"||n.substring(Math.max(0,a-10),a+c.length+10).includes("__MATH_PLACEHOLDER"))continue;let C=a;for(;C>0&&/\d/.test(n[C-1]);)C--;let O=a+c.length;for(;O<n.length&&/\d/.test(n[O]);)O++;const G=n.substring(C,O),B=Math.max(0,C-5),Y=n.substring(B,C),re=n.substring(O,Math.min(n.length,O+5));I.push({numberPart:G,fullMatch:G,startIndex:C,endIndex:O,prefix:Y,suffix:re})}const N=[...l.map(a=>({...a,type:"parentheses"})),...k.map(a=>({...a,type:"expression"})),...u.map(a=>({...a,type:"complex"})),...I.map(a=>({match:a.fullMatch,index:a.startIndex,type:"thousand",isThousand:!0,replacement:a.numberPart.replace(/\{,\}/g,",")}))].sort((a,c)=>a.index-c.index),$=[];for(let a=0;a<N.length;a++){const c=N[a];let g=!1;for(let y=0;y<$.length;y++){const C=$[y],O=c.index+c.match.length,G=C.index+C.match.length;if(c.index<G&&O>C.index){c.match.length>C.match.length&&($[y]=c),g=!0;break}}g||$.push(c)}$.sort((a,c)=>c.index-a.index);for(const a of $){const c=n.substring(0,a.index),g=n.substring(a.index+a.match.length);if(a.type==="thousand"){const y=a.replacement;n=c+`$${y}$`+g}else n=c+`$${a.match}$`+g}return i.forEach((a,c)=>{n=n.replace(o(c),a)}),n}const Jn="/ChatNote/assets/chatnote-icon-BQXPxUrH.svg";function Xn(t){if(!t)return[];const n=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","be","been","being","have","has","had","do","does","did","will","would","should","could","may","might","must","can","this","that","these","those","what","which","who","whom","whose","where","when","why","how","about","tell","me","please","help","does","mention","any","pdf"]),i=t.toLowerCase(),o=[],l=i.replace(/[^\w\s]/g," ").split(/\s+/).filter(h=>h.length>2&&!n.has(h));for(let h=0;h<l.length-1;h++){const k=`${l[h]} ${l[h+1]}`;l[h].length>3&&l[h+1].length>3&&o.push(k)}for(let h=0;h<l.length-2;h++){const k=`${l[h]} ${l[h+1]} ${l[h+2]}`;l[h].length>3&&l[h+1].length>2&&l[h+2].length>3&&o.push(k)}const p=[...o,...l];return[...new Set(p)].sort((h,k)=>k.length-h.length)}function Zn(t){const n=new Set(t),i={distribution:["spread","scatter","allocation","dispersion","arrangement"],data:["information","dataset","sample","observation","record"],figure:["chart","graph","plot","diagram","visualization","illustration"],table:["matrix","grid","tabular"],method:["approach","technique","algorithm","procedure","strategy"],result:["finding","outcome","conclusion","summary","finding"],analysis:["evaluation","examination","study","investigation","assessment"]};for(const o of t){const l=o.toLowerCase();n.add(l);for(const[p,h]of Object.entries(i))(l.includes(p)||p.includes(l))&&h.forEach(k=>n.add(k));l.endsWith("s")&&n.add(l.slice(0,-1)),l.endsWith("ed")&&n.add(l.slice(0,-2)),l.endsWith("ing")&&n.add(l.slice(0,-3))}return Array.from(n)}function es(t,n,i){if(!t||n.length===0)return t;const o=800,l=[];for(const f of n){const u=f.toLowerCase(),m=new RegExp(u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");let w;for(;(w=m.exec(t))!==null;){const x=w.index,E=w.index+w[0].length,D=Math.max(0,x-o),q=Math.min(t.length,E+o),I=f.length>4?3:2;l.push({start:D,end:q,score:I})}}if(l.length===0)return st(t,Math.floor(i/4));l.sort((f,u)=>f.start-u.start);const p=[];for(const f of l){let u=!1;for(let m=0;m<p.length;m++){const w=p[m];if(f.start<=w.end+200&&f.end>=w.start-200){w.start=Math.min(w.start,f.start),w.end=Math.max(w.end,f.end),w.score+=f.score,u=!0;break}}u||p.push(f)}p.sort((f,u)=>u.score-f.score);let h="",k=0;for(const f of p){if(k>=i*.9)break;const u=t.substring(f.start,f.end),m=u.length;if(k+m<=i)h&&(h+=`

---

`),h+=u,k+=m+10;else{const w=i-k-10;w>200&&(h&&(h+=`

---

`),h+=u.substring(0,w)+"...");break}}const j=i-k;if(j>500&&h){const f=Math.min(j*.3,500),u=Math.min(j*.2,300),m=t.substring(0,f),w=t.substring(Math.max(0,t.length-u));h=`[Document Introduction]
${m}

---

[Relevant Sections]
${h}

---

[Document Conclusion]
${w}`}else if(!h)return st(t,Math.floor(i/4));return h}async function rn(t,n,i){if(!t)return t;const o=i*4;if(t.length<=o)return t;try{const{getRAGContext:k}=await ut(async()=>{const{getRAGContext:f}=await import("./pdfRAG-BUQZRmsO.js");return{getRAGContext:f}},[]),j=await k(t,n,i);if(j&&j.length>100)return j}catch{}const l=Xn(n),p=Zn(l);if(p.length===0)return st(t,i);const h=es(t,p,o);return h&&h.length>100?h:st(t,i)}function st(t,n){if(!t)return t;const i=n*4;if(t.length<=i)return t;const o=Math.floor(i*.6),l=Math.floor(i*.4),p=t.substring(0,o),h=t.substring(Math.max(0,t.length-l));let k=p;const j=p.lastIndexOf("."),f=p.lastIndexOf(`
`),u=Math.max(j,f);if(u>o*.7)k=p.substring(0,u+1);else{const q=p.lastIndexOf(" ");q>o*.8&&(k=p.substring(0,q))}let m=h;const w=h.indexOf("."),x=h.indexOf(`
`),E=w!==-1&&x!==-1?Math.min(w,x):w!==-1?w:x;if(E!==-1&&E<l*.3)m=h.substring(E+1);else{const q=h.indexOf(" ");q!==-1&&q<l*.2&&(m=h.substring(q+1))}const D=k+`

[... middle content truncated ...]

`+m;if(D.length>i){const q=D.length-i,I=`

[... middle content truncated ...]

`;if(q<=I.length)return k+`

[...]

`+m;const L=Math.floor(q*.6);return k.substring(0,k.length-L)+I+m}return D}function Ht(t){if(!t)return 0;const n=t.trim().split(/\s+/).length,i=t.length;return Math.ceil(Math.max(n*1.33,i/4))}function $t(t,n){let i=0;n&&(i+=Ht(n));for(const o of t){const l=typeof o.content=="string"?o.content:Array.isArray(o.content)&&o.content.find(p=>p.type==="text")?.text||"";i+=Ht(l),i+=4}return i}function yn(t,n,i){const o=t.toLowerCase().trim(),l=n.length>0,p=[/^(what|who|when|where|which)\s+(is|are|was|were)\s+\w{1,30}\?*$/i,/^(yes|no|ok|thanks|thank you|got it)/i,/^(explain|define|tell me about)\s+\w{1,20}$/i],h=[/^(it|that|this|they|those|these)/i,/^(also|additionally|furthermore|moreover|and|but)/i,/^(what about|how about|can you|could you|would you)/i,/^(can you|could you|would you)\s+(also|please|again)/i],k=[/(pdf|document|text|chapter|section|page|according to|in the|from the)/i,/(what does.*say|what is.*about|what does the.*say)/i,/(what is this.*about|what is the.*about|what's this.*about|what's the.*about)/i,/(tell me about.*pdf|tell me about.*document|tell me about.*text)/i,/(summarize.*pdf|summarize.*document|summarize.*text)/i,/(explain.*pdf|explain.*document|explain.*text)/i,/(describe.*pdf|describe.*document|describe.*text)/i,/(this pdf|the pdf|this document|the document)/i],j=[/(why|how|explain|analyze|compare|contrast|evaluate|discuss)/i,/(calculate|solve|derive|prove|show|demonstrate)/i,/(relationship|connection|difference|similarity|correlation)/i],f=p.some(y=>y.test(o)),u=l&&h.some(y=>y.test(o)),m=i&&k.some(y=>y.test(o)),w=j.some(y=>y.test(o)),x=/^(what is|what are|define|definition)/i.test(o),E=/(calculate|solve|compute|formula|equation|math)/i.test(o),D=/(compare|contrast|difference|similar|versus|vs)/i.test(o),q=/(what do you mean|clarify|explain.*again|repeat)/i.test(o),I=/(what is|what's|what are|tell me about|summarize|explain|describe).*(about|say|contain|discuss)/i.test(o);let L=0;m?L=.9:I&&i&&!u?L=.85:i&&!f&&!u?L=.4:i&&(L=.2);let N=0;u?N=.9:l&&(q||/^(it|that|this)/i.test(o))?N=.7:l&&(N=.2);let $="detailed";f||x?$="quick":(w||E||D)&&($="reasoning");const a=i&&(m||I&&!u||!u&&!f&&i),c=l&&(u||q||N>.5);return{needsPdfContext:a,needsChatHistory:c,needsFullContext:a&&c,answerComplexity:$,isClarification:q,isFollowUp:u,isDefinition:x,isCalculation:E,isComparison:D,pdfRelevanceScore:L,historyRelevanceScore:N,classificationMethod:"rule-based",confidence:f||u||m?.9:.6}}async function ts(t,n,i,o){const l=n.length>0,p=f=>typeof f.content=="string"?f.content:Array.isArray(f.content)&&f.content.find(m=>m.type==="text")?.text||"",h=l?`Previous conversation has ${n.length} messages. Last user message: "${p(n[n.length-1]).substring(0,100)}"`:"No previous conversation history.",k=i?"A PDF document is available as context.":"No PDF document is available.",j={type:"object",properties:{needsPdfContext:{type:"boolean"},needsChatHistory:{type:"boolean"},needsFullContext:{type:"boolean"},answerComplexity:{type:"string",enum:["quick","detailed","reasoning"]},isClarification:{type:"boolean"},isFollowUp:{type:"boolean"},isDefinition:{type:"boolean"},isCalculation:{type:"boolean"},isComparison:{type:"boolean"},pdfRelevanceScore:{type:"number",minimum:0,maximum:1},historyRelevanceScore:{type:"number",minimum:0,maximum:1},confidence:{type:"number",minimum:0,maximum:1}},required:["needsPdfContext","needsChatHistory","needsFullContext","answerComplexity","isClarification","isFollowUp","isDefinition","isCalculation","isComparison","pdfRelevanceScore","historyRelevanceScore","confidence"],additionalProperties:!1};for(const f of Rn)try{const u=await fetch(`${Ce}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({messages:[{role:"system",content:`You are a question classification expert. Analyze the user's question and classify it to determine what context is needed for an optimal response. Consider:
- Whether the question is about the PDF document
- Whether the question references previous conversation
- The complexity of the answer needed (quick fact, detailed explanation, or reasoning)
- Question characteristics (clarification, follow-up, definition, calculation, comparison)

${k}
${h}

Output your classification as JSON matching the provided schema.`},{role:"user",content:t}],model:f,temperature:.3,maxTokens:500,response_format:{type:"json_schema",json_schema:{name:"question_classification",schema:j}}})});if(!u.ok)continue;const m=await u.json(),w=JSON.parse(m.choices[0]?.message?.content||"{}");return{...w,classificationMethod:"llm",confidence:w.confidence||.8}}catch{continue}return yn(t,n,i)}async function ns(t,n,i,o){const l=yn(t,n,i);if(l.confidence>=.85)return l;try{return await ts(t,n,i,o)}catch{return l}}function ss(t,n,i){const o=n==="reasoning";if(t.needsPdfContext&&!t.needsChatHistory){const h=t.answerComplexity==="quick"?o?1500:2e3:t.answerComplexity==="detailed"&&!o?2e3:1500,k=2;return{includePdfContext:!0,pdfContextTokens:h,includeChatHistory:i>0,chatHistoryDepth:k,summarizeOldMessages:i>k,recentMessagesCount:k,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning"}}if(t.needsChatHistory&&!t.needsPdfContext){const h=t.isFollowUp||o?2:5;return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:!0,chatHistoryDepth:h,summarizeOldMessages:i>h,recentMessagesCount:h,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning"}}if(t.answerComplexity==="quick"&&!t.needsPdfContext&&!t.needsChatHistory)return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:i>0,chatHistoryDepth:2,summarizeOldMessages:i>2,recentMessagesCount:2,preferQuickModel:!0,needsReasoning:!1};const l=t.needsPdfContext?t.answerComplexity==="quick"?o?1200:1500:o?1500:t.answerComplexity==="detailed"?2e3:1500:0,p=t.needsChatHistory?o||t.isFollowUp?2:5:2;return{includePdfContext:t.needsPdfContext,pdfContextTokens:l,includeChatHistory:i>0,chatHistoryDepth:p,summarizeOldMessages:i>p,recentMessagesCount:p,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning"}}function os(t,n=!1){if(t.length===0)return{role:"system",content:""};const i=[],o=n?50:80,l=n?80:120;for(let k=0;k<t.length;k+=2){const j=t[k],f=t[k+1];if(j&&j.role==="user"){const u=typeof j.content=="string"?j.content:Array.isArray(j.content)&&j.content.find(m=>m.type==="text")?.text||"";if(u.trim()){const m=u.length>o?u.substring(0,o)+"...":u;i.push(`Q: ${m}`)}}if(f&&f.role==="assistant"){const u=typeof f.content=="string"?f.content:Array.isArray(f.content)&&f.content.find(m=>m.type==="text")?.text||"";if(u.trim()){const m=u.length>l?u.substring(0,l)+"...":u;i.push(`A: ${m}`)}}}return{role:"system",content:`${n?`[Prev (${t.length})]`:`[Previous conversation (${t.length} msgs)]`}:
${i.join(`
`)}`}}function an(t){return typeof t=="string"?t.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim():Array.isArray(t)?t.map(n=>{if(n.type==="text"&&n.text){const i=n.text.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim();return{...n,text:i}}return n}).filter(n=>!(n.type==="text"&&n.text&&n.text.trim()==="")):t}function dt(t){if(!t)return{thinking:null,mainContent:t};const n="__REASONING_START__",i="__REASONING_END__",o=t.indexOf(n),l=t.indexOf(i);if(o!==-1&&l!==-1&&l>o){const w=o+n.length,x=t.substring(w,l).trim(),E=t.substring(l+i.length).trim();return{thinking:x||null,mainContent:E}}const p=t.indexOf("<think>"),h=t.lastIndexOf("</think>");if(p===-1||h===-1||h<=p)return{thinking:null,mainContent:t};const k=p+7,j=t.substring(k,h).trim(),f=t.substring(0,p),u=t.substring(h+8),m=(f+u).trim();return{thinking:j||null,mainContent:m}}function rs({selectedText:t,pdfText:n,onToggleLayout:i,layout:o,currentPageNumber:l,onCreateKnowledgeNote:p,onClearSelectedText:h,onAddAnnotationToPDF:k,onOpenKnowledgeNotes:j}){const{theme:f}=Mt(),{isAuthenticated:u,user:m,loading:w}=ft();r.useEffect(()=>{const s=console.warn;return console.warn=(...M)=>{const P=M.map(b=>{if(typeof b=="string")return b;if(b&&typeof b=="object")try{return JSON.stringify(b)}catch{return String(b)}return String(b)}).join(" ");P.includes("No character metrics")&&(P.includes("â€‘")||P.includes("8209")||P.includes("U+2011"))||P.includes("Unrecognized Unicode character")&&(P.includes("â€‘")||P.includes("8209")||P.includes("U+2011"))||P.includes("LaTeX-incompatible input")&&(P.includes("â€‘")||P.includes("8209")||P.includes("U+2011"))||P.includes("unknownSymbol")&&(P.includes("â€‘")||P.includes("8209")||P.includes("U+2011"))||s.apply(console,M)},()=>{console.warn=s}},[]);const[x,E]=r.useState([]),[D,q]=r.useState({}),[I,L]=r.useState({}),[N,$]=r.useState({}),[a,c]=r.useState({}),[g,y]=r.useState(""),[C,O]=r.useState(!1),[G,B]=r.useState(null),[Y,re]=r.useState(!0),[ne,pe]=r.useState(!0),[xe,S]=r.useState(!0),[Q,K]=r.useState(null),[J,ae]=r.useState("auto"),[fe,d]=r.useState(!1),[T,F]=r.useState(null),[_,z]=r.useState([]),[ue,le]=r.useState(!1),[Ee,De]=r.useState(!1),[Ye,Ue]=r.useState(!1),[gt,rt]=r.useState({}),[ve,Ve]=r.useState(!1),Fe=r.useRef(null),Qe=r.useRef(null),et=r.useRef(null),Re=r.useRef({}),Le=r.useRef(null),Oe=r.useRef(null),Ne=r.useRef(null),Ct=r.useRef(null),mt=r.useRef(null),ke=r.useRef(null),[A,W]=r.useState(null),[Z,se]=r.useState(null),ie=(s=!0,M=!1)=>{if(ke.current){const P=ke.current;(P.scrollHeight-P.scrollTop-P.clientHeight<100||M)&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!ke.current)return;const b=ke.current;s?Le.current?Le.current.scrollIntoView({behavior:"smooth"}):b.scrollTo({top:b.scrollHeight,behavior:"smooth"}):Le.current?Le.current.scrollIntoView({behavior:"auto"}):b.scrollTop=b.scrollHeight})})}},Te=()=>{const s=Oe.current;if(s){s.style.height="auto";const v=Math.min(Math.max(s.scrollHeight,24),200);s.style.height=`${v}px`}},Je=r.useRef(0),tt=r.useRef(null);r.useEffect(()=>{const s=x.length,M=Je.current,v=(x.length>0?x[x.length-1]:null)?.role||null;s>M?v==="user"?ie(!0,!0):ie(!0):s===M&&C&&ie(!1),Je.current=s,tt.current=v},[x,C]),r.useEffect(()=>{if(!ke.current||!C)return;const s=ke.current;let M=s.scrollHeight,P=null;const v=new ResizeObserver(()=>{if(!ke.current)return;const b=ke.current.scrollHeight,R=ke.current.scrollHeight-ke.current.scrollTop-ke.current.clientHeight<100;b>M&&R?(P&&clearTimeout(P),P=setTimeout(()=>{ie(!1),M=b},50)):M=b});return v.observe(s),()=>{v.disconnect(),P&&clearTimeout(P)}},[C]),r.useEffect(()=>()=>{Fe.current&&clearTimeout(Fe.current)},[]),r.useEffect(()=>{Oe.current?.focus(),Te()},[]),r.useEffect(()=>{const s=setTimeout(()=>{Te()},0);return()=>clearTimeout(s)},[g]);const we=async()=>{if(u){pe(!0);try{const s=await xn();re(!s)}catch(s){console.warn("API key check failed:",s)}finally{pe(!1)}}else re(!0),pe(!1)};r.useEffect(()=>{we();const s=setInterval(()=>{u&&we()},1e4);return()=>clearInterval(s)},[u]),r.useEffect(()=>{o==="split"&&(S(!1),K(null))},[o]),r.useEffect(()=>{o==="floating"&&!xe&&Q!==null&&ke.current&&requestAnimationFrame(()=>{ke.current&&(ke.current.scrollTop=Q)})},[xe,o,Q]),r.useEffect(()=>{if(o!=="floating"){W(null);return}const s=()=>{const M=window.innerHeight,P=window.innerWidth<=768?70:90,v=60,b=400,R=M-v-P;if(R<b)S(!0),W(null);else if(xe)W(null);else{const X=Math.min(R-200,600);W(Math.max(X,300))}};return s(),window.addEventListener("resize",s),()=>{window.removeEventListener("resize",s)}},[o,xe]),r.useEffect(()=>{if(!T||!ke.current||!mt.current){se(null);return}const s=()=>{const P=ke.current,v=mt.current;if(!P||!v)return;const b=P.clientHeight,R=window.innerHeight,X=Math.min(R*.7,600)+40;if(X<=b)se(null);else{const he=v.clientHeight-b,oe=X+he;se(oe)}},M=setTimeout(s,100);return window.addEventListener("resize",s),()=>{clearTimeout(M),window.removeEventListener("resize",s)}},[T]);const _e=()=>{switch(J){case"auto":return ot[0];case"reasoning":return ht[0];case"advanced":return jt.primary}},He=s=>{ae(s),s!=="auto"&&_.length>0&&z([])},Be=()=>{if(J!=="auto")return!1;const s=_e();return s==="meta-llama/llama-4-scout-17b-16e-instruct"||s==="meta-llama/llama-4-maverick-17b-128e-instruct"};r.useEffect(()=>{!Be()&&_.length>0&&z([])},[J]);const it=s=>{Array.from(s).forEach(P=>{if(!P.type.startsWith("image/")){B("Please upload image files only.");return}const v=new FileReader;v.onload=b=>{const R=b.target?.result;R&&z(V=>[...V,R])},v.onerror=()=>{B("Failed to read image file.")},v.readAsDataURL(P)})},Gt=s=>{const M=s.target.files;!M||M.length===0||(it(M),Qe.current&&(Qe.current.value=""))},kn=s=>{Be()&&(s.preventDefault(),s.stopPropagation(),le(!0))},bn=s=>{Be()&&(s.preventDefault(),s.stopPropagation(),le(!1))},jn=s=>{if(!Be())return;s.preventDefault(),s.stopPropagation(),le(!1);const M=s.dataTransfer.files;M&&M.length>0&&it(M)},at=()=>{const s=et.current;if(!s){De(!1),Ue(!1);return}De(s.scrollLeft>0),Ue(s.scrollLeft<s.scrollWidth-s.clientWidth-1)},Ut=s=>{const M=et.current;if(!M)return;const P=200,v=s==="left"?M.scrollLeft-P:M.scrollLeft+P;M.scrollTo({left:v,behavior:"smooth"})},St=s=>{const M=Re.current[s];if(!M){rt(b=>({...b,[s]:{canScrollLeft:!1,canScrollRight:!1}}));return}const P=M.scrollLeft>0,v=M.scrollLeft<M.scrollWidth-M.scrollWidth-1;rt(b=>({...b,[s]:{canScrollLeft:P,canScrollRight:v}}))},Vt=(s,M)=>{const P=Re.current[s];if(!P)return;const v=200,b=M==="left"?P.scrollLeft-v:P.scrollLeft+v;P.scrollTo({left:b,behavior:"smooth"})};r.useEffect(()=>{const s=setTimeout(()=>{at()},0),M=et.current;return M?(M.addEventListener("scroll",at),window.addEventListener("resize",at),()=>{clearTimeout(s),M.removeEventListener("scroll",at),window.removeEventListener("resize",at)}):()=>{clearTimeout(s)}},[_]),r.useEffect(()=>{const s=setTimeout(()=>{Object.keys(Re.current).forEach(P=>{St(P)})},0),M=()=>{Object.keys(Re.current).forEach(P=>{St(P)})};return window.addEventListener("resize",M),()=>{clearTimeout(s),window.removeEventListener("resize",M)}},[x]);const Kt=async()=>{const s=g.trim(),M=_.length>0;if(!s&&!t&&!M)return;if(!u){B("Please sign in to use the chat feature.");return}if(Y){B("Please configure your Groq API key in Settings.");return}xe&&S(!1),Ne.current&&Ne.current.abort(),Ne.current=new AbortController;let P=s;t&&!s?P=`Tell me about this: ${t}`:t&&s&&(P=`${s}

Context from PDF: ${t}`);let v;if(Be()&&_.length>0){const te=[];P&&te.push({type:"text",text:P}),_.forEach(We=>{te.push({type:"image_url",image_url:{url:We}})}),v=te}else v=P;const b=window.__lastSelectedTextPosition,R={id:Date.now().toString(),role:"user",content:v,selectedTextAtSend:t||void 0,pageNumberAtSend:b?.pageNumber,textYPositionAtSend:b?.textYPosition};E(te=>[...te,R]),y(""),z([]),setTimeout(()=>{Te()},0),O(!0),B(null),requestAnimationFrame(()=>{requestAnimationFrame(()=>{ie(!0,!0)})});const V=J==="reasoning",X=n&&n.trim().length>0||!!t,he=s||(t?`Tell me about: ${t}`:""),oe=localStorage.getItem("auth_token")||"";let Me,Ae;try{Me=await ns(he,x,X,oe),Ae=ss(Me,J,x.length)}catch(te){console.warn("[Smart Router] Classification failed, using default routing:",te),Ae={includePdfContext:X,pdfContextTokens:V?1500:2e3,includeChatHistory:!0,chatHistoryDepth:V?2:5,summarizeOldMessages:x.length>(V?2:5),recentMessagesCount:V?2:5,preferQuickModel:!1,needsReasoning:!1}}let ee;Ae.includePdfContext&&Ae.pdfContextTokens>0&&(t&&!s?ee=st(t,Ae.pdfContextTokens):n&&n.trim().length>0?s&&s.trim().length>0?ee=await rn(n,s,Ae.pdfContextTokens):ee=st(n,Ae.pdfContextTokens):t&&s&&(ee=st(t,Ae.pdfContextTokens)));const Ie=(Date.now()+1).toString(),ze=R.selectedTextAtSend,pt={id:Ie,role:"assistant",content:"",selectedTextAtSend:ze,pageNumberAtSend:R.pageNumberAtSend,textYPositionAtSend:R.textYPositionAtSend};E(te=>[...te,pt]),requestAnimationFrame(()=>{requestAnimationFrame(()=>{ie(!0,!0)})});try{let te=[];if(Ae.includeChatHistory&&x.length>0){const ge=x.length,H=Ae.recentMessagesCount;if(ge>H&&Ae.summarizeOldMessages){const me=x.slice(0,ge-H),ye=x.slice(-H);te=[os(me,V),...ye.map(je=>({role:je.role,content:je.content}))]}else ge<=H?te=x.map(me=>({role:me.role,content:me.content})):te=x.slice(-H).map(me=>({role:me.role,content:me.content}))}else te=[];const We=$t([...te,R],ee),Pe={"openai/gpt-oss-120b":7e3,"openai/gpt-oss-20b":7e3,"qwen/qwen3-32b":5e3},U=_e(),$e=Pe[U]||8e3;if(We>$e&&ee){const ge=$e/We,H=Math.floor(Ht(ee)*ge*.9);ee=st(ee,H)}const Se={role:"system",content:'You are a mathematical assistant. All mathematical equations you generate must be 100% compatible with the KaTeX rendering engine.\n\nFollow these strict rules:\n\n1. **Delimiters:**\n   * For block-level equations (on their own line), **must** use `$$...$$` delimiters.\n   * For inline equations (inside a sentence), **must** use `\\(...\\)` delimiters.\n   * **Do not** use single `$` or `\\[...\\]` delimiters.\n\n2. **Alignment (Crucial):**\n   * To align multiple equations, **must** use the `aligned` environment.\n   * **Do not** use the `align`, `align*`, or `eqnarray` environments, as they are not supported.\n   * Example of a correct multi-line equation:\n     ```\n     $$\n     \\begin{aligned}\n     a &= b + c \\\\\n     d &= e + f\n     \\end{aligned}\n     $$\n     ```\n\n3. **General Formatting:**\n   * Use standard, common LaTeX commands.\n   * To write plain text inside math, **must** use `\\text{...}`.\n   * To create a fraction, **must** use `\\frac{...}{...}`.\n   * To create a matrix or case, use the `pmatrix`, `bmatrix`, or `cases` environments.\n   * **Do not** use complex, obscure, or custom LaTeX packages. Stick to `amsmath`-style commands that are known to be supported by KaTeX.\n\n4. **Dollar Amounts and Numbers:**\n   * For dollar amounts in text (e.g., "$40,000", "$1,000"), use plain text with commas, NOT math delimiters.\n   * **Always include spaces** before and after dollar amounts when they appear in sentences (e.g., "between $40,000 and $42,000", not "between $40,000and$42,000").\n   * **Do not** wrap dollar amounts in `$` delimiters unless they are part of a mathematical expression.\n   * For consistency, use the same formatting style for similar phrases (e.g., if you use "no smaller than" in normal text, use "no larger than" in the same style, not italic).\n\n5. **Text Formatting Consistency:**\n   * Use consistent markdown formatting for similar phrases.\n   * If you use italic (`*text*`) for emphasis, use it consistently for similar phrases.\n   * **Always preserve spaces** between numbers and words (e.g., "1,000 and", not "1,000and$42,000").\n   * **Do not** wrap dollar amounts in `$` delimiters unless they are part of a mathematical expression.\n   * For consistency, use the same formatting style for similar phrases (e.g., if you use "no smaller than" in normal text, use "no larger than" in the same style, not italic).'},ce=te.length>0&&te[0]?.role==="system"?te:[Se,...te];let be=$t([...ce,R],ee);if(be>$e&&ce.length>1){const ge=ce[0]?.role==="system"?ce[0]:null,H=ge?ce.slice(1):ce,me=H[0],de=H.slice(1).slice(-2);te=me?.content?ge?[ge,me,...de]:[me,...de]:ge?[ge,...de]:de,be=$t([...te,R],ee)}else te=ce;be>$e&&ee&&(ee=void 0);let qe="";const Nt=R,Ge=At([...te,Nt],ee,ge=>{if(Ne.current?.signal.aborted)return;qe+=ge;const{thinking:H,mainContent:me}=dt(qe),ye=H&&H.trim().length>0;E(V||J==="advanced"&&ye?de=>de.map(je=>je.id===Ie?{...je,content:me||qe,thinking:ye?H:je.thinking}:je):de=>de.map(je=>je.id===Ie?{...je,content:qe}:je)),ie(!1)},U,Ne.current?.signal,V);Ge.catch(ge=>{if(!(ge instanceof DOMException&&ge.name==="AbortError"))throw ge});const xt=await Ge,{thinking:Ke,mainContent:lt}=dt(xt);let yt=Ke,Tt=lt;if(Ke&&(!lt||lt.trim().length===0)){const ge=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let H=null;for(const me of ge){const ye=Ke.match(me);if(ye&&ye[1]){const de=Ke.indexOf(ye[0]),je=Ke.substring(de+ye[0].length);let ct=ye[1].trim();const Zt=je.match(/^([^.!?]*[.!?]+)/);if(Zt)ct+=Zt[1];else{const nt=je.match(/^([^\n]+)/);nt&&(ct+=nt[1])}if(H=ct.trim(),H&&!H.match(/^[A-Z"']/)){const en=Ke.substring(Math.max(0,de-200),de).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);en&&(H=en[2]+H)}if(H.length>300){const nt=H.match(/[^.!?]*[.!?]+/g);nt&&nt.length>0?(H=nt.slice(0,2).join(" ").trim(),nt.length>2&&(H+="...")):H=H.substring(0,300).trim()+"..."}break}}if(!H){const me=Ke.split(/\n\n+/).filter(ye=>ye.trim().length>0);if(me.length>0){for(let ye=me.length-1;ye>=0;ye--){const de=me[ye].trim();if(!de.match(/^(?:Step \d+|## Step|\d+\.)/i)&&de.length>50){const je=de.match(/[^.!?]*[.!?]+/g);if(je&&je.length>0?H=je.slice(-2).join(" ").trim():H=de,H.length>300){const ct=je?je.slice(0,2).join(" ").trim():null;ct?H=ct+(je&&je.length>2?"...":""):H=de.substring(0,300).trim()+"..."}break}}if(!H&&me.length>0){const ye=me[me.length-1].trim(),de=ye.match(/[^.!?]*[.!?]+/g);de&&de.length>0?(H=de.slice(-2).join(" ").trim(),H.length>300&&(H=de.slice(0,2).join(" ").trim()+(de.length>2?"...":""))):(H=ye,H.length>300&&(H=ye.substring(0,300).trim()+"..."))}}}H&&(H=H.replace(/\$\\([0-7]{1,3})(\d[^$]*)\$/g,(me,ye,de)=>`$${ye}${de}$`),H=H.replace(/\$\\\$(\d[^$]*)\$/g,"$$$1$"),H=H.replace(/\\\$(\d[^$]*?)(?=\s|$|,|\.|;)/g,"$$$1$")),Tt=H||"",yt=Ke}else Ke&&lt&&Ke.trim()===lt.trim()&&(yt=null,Tt=lt);const It=yt&&yt.trim().length>0,Pt={content:Tt||(It?"":xt),thinking:It&&yt||void 0,timestamp:Date.now()};$(ge=>{const me=[...ge[Ie]||[],Pt],ye=me.length-1;return c(de=>({...de,[Ie]:ye})),{...ge,[Ie]:me}}),E(V||J==="advanced"&&It?ge=>ge.map(H=>H.id===Ie?{...H,content:Pt.content,thinking:Pt.thinking}:H):ge=>ge.map(H=>H.id===Ie?{...H,content:Pt.content,thinking:void 0}:H))}catch(te){te instanceof DOMException&&te.name==="AbortError"||(console.error("Error sending message (details logged, user sees sanitized message):",te),B(te instanceof Error?te.message:"Unable to send message. Please try again."),E(We=>We.filter(Pe=>Pe.id!==Ie)))}finally{O(!1),Ne.current=null,Oe.current?.focus()}},Cn=()=>{Ne.current&&(Ne.current.abort(),Ne.current=null,O(!1),Oe.current?.focus())},Sn=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),Kt())},Nn=()=>{t&&(y(`Tell me about this: ${t}`),Oe.current?.focus())},Pn=async s=>{const M=x.findIndex(R=>R.id===s);if(M===-1||x[M].role!=="assistant")return;let P=M-1;for(;P>=0&&x[P].role!=="user";)P--;if(P<0)return;const v=x[P],b=J==="reasoning";E(R=>R.map(V=>V.id===s?{...V,content:"",thinking:void 0}:V)),O(!0),Ne.current&&Ne.current.abort(),Ne.current=new AbortController;try{const R=typeof v.content=="string"?v.content:v.content.filter(Pe=>Pe.type==="text").map(Pe=>Pe.text).join(`
`),V=v.selectedTextAtSend,X=x.slice(0,M).map(Pe=>({role:Pe.role,content:Pe.content}));let he;n&&n.trim().length>0&&(V?he=V:he=await rn(n,R,b?1500:2e3));let oe;J==="auto"?oe=ot[0]:J==="reasoning"?oe=ht[0]:oe=jt.primary;let Me="";const Ae=await At([...X,v],he,Pe=>{if(Ne.current?.signal.aborted)return;Me+=Pe;const{thinking:U,mainContent:$e}=dt(Me),Se=U&&U.trim().length>0;E(b||J==="advanced"&&Se?ce=>ce.map(be=>be.id===s?{...be,content:$e||Me,thinking:Se?U:be.thinking}:be):ce=>ce.map(be=>be.id===s?{...be,content:Me}:be)),ie(!1)},oe,Ne.current.signal,b),{thinking:ee,mainContent:Ie}=dt(Ae),ze=ee&&ee.trim().length>0;let pt=ee,te=Ie;if(J==="advanced"&&ze)if(ee&&(!Ie||Ie.trim().length===0)){const Pe=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let U=null;for(const $e of Pe){const Se=ee.match($e);if(Se&&Se[1]){const ce=ee.indexOf(Se[0]),be=ee.substring(ce+Se[0].length);let qe=Se[1].trim();const Nt=be.match(/^([^.!?]*[.!?]+)/);if(Nt)qe+=Nt[1];else{const Ge=be.match(/^([^\n]+)/);Ge&&(qe+=Ge[1])}if(U=qe.trim(),U&&!U.match(/^[A-Z"']/)){const xt=ee.substring(Math.max(0,ce-200),ce).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);xt&&(U=xt[2]+U)}if(U.length>300){const Ge=U.match(/[^.!?]*[.!?]+/g);Ge&&Ge.length>0?(U=Ge.slice(0,2).join(" ").trim(),Ge.length>2&&(U+="...")):U=U.substring(0,300).trim()+"..."}break}}if(!U){const $e=ee.split(/\n\n+/).filter(Se=>Se.trim().length>0);if($e.length>0){for(let Se=$e.length-1;Se>=0;Se--){const ce=$e[Se].trim();if(!ce.match(/^(?:Step \d+|## Step|\d+\.)/i)&&ce.length>50){const be=ce.match(/[^.!?]*[.!?]+/g);if(be&&be.length>0?U=be.slice(-2).join(" ").trim():U=ce,U.length>300){const qe=be?be.slice(0,2).join(" ").trim():null;qe?U=qe+(be&&be.length>2?"...":""):U=ce.substring(0,300).trim()+"..."}break}}if(!U&&$e.length>0){const Se=$e[$e.length-1].trim(),ce=Se.match(/[^.!?]*[.!?]+/g);ce&&ce.length>0?(U=ce.slice(-2).join(" ").trim(),U.length>300&&(U=ce.slice(0,2).join(" ").trim()+(ce.length>2?"...":""))):(U=Se,U.length>300&&(U=Se.substring(0,300).trim()+"..."))}}}te=U||"",pt=ee}else ee&&Ie&&ee.trim()===Ie.trim()&&(pt=null,te=Ie);const We={content:te||(ze?"":Ae),thinking:ze&&pt||void 0,timestamp:Date.now()};$(Pe=>{const $e=[...Pe[s]||[],We];return c(Se=>{const ce=$e.length-1;return{...Se,[s]:ce}}),{...Pe,[s]:$e}}),E(b||J==="advanced"&&ze?Pe=>Pe.map(U=>U.id===s?{...U,content:We.content,thinking:We.thinking}:U):Pe=>Pe.map(U=>U.id===s?{...U,content:We.content,thinking:void 0}:U))}catch(R){if(!(R instanceof DOMException&&R.name==="AbortError")){console.error("Error resending message:",R),B(R instanceof Error?R.message:"Unable to resend message. Please try again.");const V=N[s]||[];if(V.length>0){const X=V[V.length-1];E(he=>he.map(oe=>oe.id===s?{...oe,content:X.content,thinking:X.thinking}:oe))}}}finally{O(!1),Ne.current=null}},Yt=(s,M)=>{const P=N[s]||[];if(P.length===0)return;const v=a[s]??P.length-1;let b=v;if(M==="prev"?b=Math.max(0,v-1):b=Math.min(P.length-1,v+1),b===v)return;c(V=>({...V,[s]:b}));const R=P[b];R&&E(V=>V.map(X=>X.id===s?{...X,content:R.content,thinking:R.thinking}:X))},Qt=s=>{let M="";typeof s=="string"?M=s:Array.isArray(s)&&(M=s.find(R=>R.type==="text")?.text||"");const P=M.match(/^(.+?)\n\nContext from PDF:\s*(.+)$/s);if(P)return{mainQuestion:P[1].trim(),pdfContext:P[2].trim()};const v=M.match(/^Tell me about this:\s*(.+)$/s);return v?{mainQuestion:"",pdfContext:v[1].trim()}:{mainQuestion:M.trim()}},Jt=()=>{const s=window.getSelection();if(!s||s.rangeCount===0)return null;const M=s.toString().trim();if(!M)return null;const v=s.getRangeAt(0).commonAncestorContainer;return(v.nodeType===Node.TEXT_NODE?v.parentElement?.closest(".message-assistant, .message-user"):v?.closest(".message-assistant, .message-user"))?M:null},Xt=()=>{ve?(E([]),B(null),Ve(!1),Fe.current&&(clearTimeout(Fe.current),Fe.current=null)):(Ve(!0),Fe.current&&clearTimeout(Fe.current),Fe.current=setTimeout(()=>{Ve(!1),Fe.current=null},3e3))};return e.jsxs("div",{className:"chatgpt-wrapper",children:[!w&&!u&&o==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!w&&u&&!ne&&Y&&o==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:m?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:s=>{s.preventDefault(),s.stopPropagation(),we()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),o==="floating"&&e.jsxs("div",{className:`model-selector-bar ${f==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:Ct,children:[e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(on,{mode:J,onModeChange:He,disabled:Y})}),Be()&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:Qe,type:"file",accept:"image/*",multiple:!0,onChange:Gt,style:{display:"none"}}),e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),Qe.current?.click()},className:"image-upload-button",title:"Upload images",disabled:Y,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]}),e.jsx("span",{className:"image-upload-text",children:"Image"})]})]})]}),e.jsxs("div",{className:"header-actions",children:[x.length>0&&e.jsxs("button",{onClick:Xt,className:`clear-button ${ve?"confirming":""}`,title:ve?"Click again to confirm":"Clear chat",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:ve?"Confirm":"Clear"})]}),o==="floating"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:i,className:"layout-toggle-button",title:o==="floating"?"Switch to split layout":"Switch to floating layout","aria-label":o==="floating"?"Switch to split layout":"Switch to floating layout",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:o==="floating"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]}):e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})}),e.jsx("button",{onClick:()=>{xe||ke.current&&K(ke.current.scrollTop),S(!xe)},className:"collapse-button",title:xe?"Expand chat":"Collapse chat","aria-label":xe?"Expand chat":"Collapse chat",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{transform:xe?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx("path",{d:"M18 15l-6-6-6 6"})})})]})]})]}),e.jsxs("div",{ref:mt,className:`chatgpt-inner ${f==="dark"?"theme-dark":"theme-light"} ${xe&&o==="floating"?"collapsed":""}`,style:{...Z?{maxHeight:`${Z}px`}:o==="floating"&&!xe&&A?{maxHeight:`${A}px`}:{}},children:[t&&e.jsxs("div",{className:"selected-text-banner",children:[e.jsxs("span",{className:"banner-text",children:["Selected Text: ",t.length>20?`${t.substring(0,20)}...`:t]}),e.jsxs("div",{className:"banner-buttons",children:[e.jsx("button",{onClick:Nn,className:"use-text-button",children:"Tell me more"}),h&&e.jsx("button",{onClick:h,className:"close-text-button",title:"Clear selection",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(!xe||o==="split")&&e.jsxs("div",{ref:ke,className:"chatgpt-messages",children:[x.length===0&&e.jsxs("div",{className:"welcome-screen",children:[e.jsx("div",{className:"welcome-icon",children:e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z",fill:"#10a37f",opacity:"0.1"}),e.jsx("path",{d:"M6 9H18M6 13H14",stroke:"#10a37f",strokeWidth:"2",strokeLinecap:"round"})]})}),e.jsx("h3",{children:"How can I help you today?"}),e.jsx("p",{children:"Ask me anything about your PDF, or select text to get context-specific answers."})]}),x.map((s,M)=>{const P=s.role==="assistant"&&M===x.length-1;return e.jsxs("div",{className:`message ${s.role==="user"?"message-user":"message-assistant"}`,children:[e.jsx("div",{className:"message-avatar",children:s.role==="user"?e.jsx("div",{className:"avatar-user",children:m?.picture?e.jsx("img",{src:m.picture,alt:m.name||m.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:v=>{const b=v.target;b.style.display="none";const R=b.parentElement;if(R){const V=R.querySelector("span.avatar-fallback");V&&V.remove();const X=document.createElement("span");X.className="avatar-fallback",X.textContent=m.name?.[0]?.toUpperCase()||m.email[0].toUpperCase(),R.appendChild(X)}}}):e.jsx("span",{className:"avatar-fallback",children:m?.name?.[0]?.toUpperCase()||m?.email?.[0]?.toUpperCase()||"U"})}):e.jsx("div",{className:"avatar-assistant",children:e.jsx("img",{src:Jn,alt:"ChatNote",className:"assistant-avatar-img",onError:v=>{const b=v.target;b.style.display="none";const R=b.parentElement;if(R){const V=R.querySelector("svg.avatar-fallback-svg");V&&V.remove();const X=document.createElementNS("http://www.w3.org/2000/svg","svg");X.setAttribute("width","32"),X.setAttribute("height","32"),X.setAttribute("viewBox","0 0 24 24"),X.setAttribute("fill","none"),X.setAttribute("class","avatar-fallback-svg");const he=document.createElementNS("http://www.w3.org/2000/svg","path");he.setAttribute("d","M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"),he.setAttribute("fill","currentColor"),X.appendChild(he),R.appendChild(X)}}})})}),e.jsxs("div",{className:"message-content-wrapper",children:[e.jsx("div",{className:"message-content",children:s.role==="assistant"&&C&&!s.content&&P?e.jsxs("div",{className:"typing-indicator",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]}):s.role==="assistant"&&s.content?e.jsxs(e.Fragment,{children:[(J==="reasoning"||J==="advanced")&&s.thinking&&s.thinking.trim().length>0?e.jsxs("div",{className:"thinking-process-container",children:[e.jsxs("button",{className:`thinking-toggle-button ${D[s.id]?"expanded":""}`,onClick:()=>{q(v=>({...v,[s.id]:!(v[s.id]??!1)}))},title:D[s.id]?"Collapse thinking":"Expand thinking",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:D[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Thinking Process"}),C&&P&&!D[s.id]&&e.jsx("span",{style:{marginLeft:"8px",fontSize:"12px",opacity:.7},children:"(generating...)"})]}),D[s.id]&&s.thinking?e.jsxs("div",{className:"thinking-content expanded",children:[e.jsx("div",{className:"markdown-content",children:e.jsx(Ft,{remarkPlugins:[_t,Rt],rehypePlugins:[[Lt,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],children:(()=>{try{const v=Ot(s.thinking||"");return v.includes("â€‘")?v.replace(/\u2011/g,"-"):v||""}catch(v){return console.error("Error preprocessing thinking content:",v),(s.thinking||"").replace(/\u2011/g,"-")}})()})}),C&&P&&e.jsxs("div",{className:"typing-indicator",style:{marginTop:"12px"},children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})]}):null]}):null,s.content&&(typeof s.content!="string"||s.content.trim().length>0)?e.jsx("div",{className:"markdown-content",children:e.jsx(Ft,{remarkPlugins:[_t,Rt],rehypePlugins:[[Lt,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],components:{table:({children:v,...b})=>e.jsx("div",{className:"table-scroll-wrapper",children:e.jsx("table",{...b,children:v})}),div:({children:v,className:b,...R})=>b&&typeof b=="string"&&b.includes("katex-display")&&!b.includes("math-scroll-wrapper")?e.jsx("div",{className:"math-scroll-wrapper",children:e.jsx("div",{className:b,...R,children:v})}):e.jsx("div",{...R,className:b,children:v}),pre:({children:v,...b})=>e.jsx("pre",{className:"code-scroll-wrapper",...b,children:v})},children:(()=>{try{if(typeof s.content=="string"&&s.content){const v=Ot(s.content);return v.includes("â€‘")?v.replace(/\u2011/g,"-"):v||""}return""}catch(v){return console.error("Error preprocessing message content:",v),(typeof s.content=="string"?s.content:"").replace(/\u2011/g,"-")}})()})}):null]}):s.role==="user"?e.jsx("div",{className:"user-message-content",children:Array.isArray(s.content)?e.jsx(e.Fragment,{children:(()=>{const v=an(s.content),b=v.filter(oe=>oe.type==="text"),R=v.filter(oe=>oe.type==="image_url"),V=gt[s.id]||{canScrollLeft:!1,canScrollRight:!1},X=b.map(oe=>oe.text||"").join(`
`),he=Qt(X);return e.jsxs(e.Fragment,{children:[he.mainQuestion&&e.jsx("div",{className:"message-text",children:he.mainQuestion}),he.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${I[s.id]?"expanded":""}`,onClick:()=>{L(oe=>({...oe,[s.id]:!(oe[s.id]??!1)}))},title:I[s.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:I[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),I[s.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:he.pdfContext})})]}),!he.mainQuestion&&!he.pdfContext&&b.map((oe,Me)=>e.jsx("div",{className:"message-text",children:oe.text},`text-${Me}`)),R.length>0&&e.jsxs(e.Fragment,{children:[R.map((oe,Me)=>{const Ae=oe.image_url?.url;if(!Ae)return null;const ee=`${s.id}-${Me}`;return T===ee?e.jsx("div",{className:"message-image-enlarged-container",children:e.jsx("div",{className:"message-image enlarged",children:e.jsx("div",{className:"message-image-wrapper",children:e.jsx("img",{src:Ae,alt:"Uploaded",onClick:ze=>{ze.stopPropagation(),F(null)}})})})},`enlarged-${Me}`):null}),e.jsxs("div",{className:"message-images-wrapper",children:[V.canScrollLeft&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-left",onClick:()=>Vt(s.id,"left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:oe=>{Re.current[s.id]=oe,oe&&setTimeout(()=>St(s.id),0)},className:"message-images-container",onScroll:()=>St(s.id),children:R.map((oe,Me)=>{const Ae=oe.image_url?.url;if(!Ae)return null;const ee=`${s.id}-${Me}`;return T===ee?null:e.jsx("div",{className:"message-image-item",children:e.jsx("div",{className:"message-image",children:e.jsxs("div",{className:"message-image-wrapper",children:[e.jsx("img",{src:Ae,alt:"Uploaded",onClick:ze=>{ze.stopPropagation(),F(ee)}}),e.jsx("div",{className:"image-magnifier",onClick:ze=>{ze.stopPropagation(),F(ee)},title:"Click to enlarge",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"}),e.jsx("circle",{cx:"11",cy:"11",r:"3"})]})})]})})},Me)})}),V.canScrollRight&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-right",onClick:()=>Vt(s.id,"right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]})]})]})})()}):(()=>{const v=typeof s.content=="string"?an(s.content):"",b=Qt(v);return e.jsxs(e.Fragment,{children:[b.mainQuestion&&e.jsx("div",{className:"message-text",children:b.mainQuestion}),b.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${I[s.id]?"expanded":""}`,onClick:()=>{L(R=>({...R,[s.id]:!(R[s.id]??!1)}))},title:I[s.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:I[s.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),I[s.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:b.pdfContext})})]}),!b.mainQuestion&&!b.pdfContext&&e.jsx("div",{className:"message-text",children:v})]})})()}):e.jsx("div",{className:"markdown-content",children:typeof s.content=="string"?s.content:""})}),s.role==="assistant"&&s.content&&e.jsxs("div",{className:"message-actions",children:[e.jsxs("button",{className:"message-action-button copy-button",onClick:async()=>{try{const v=typeof s.content=="string"?s.content:Array.isArray(s.content)?s.content.filter(b=>b.type==="text").map(b=>b.text).join(`
`):"";await navigator.clipboard.writeText(v)}catch(v){console.error("Failed to copy:",v)}},title:"Copy to clipboard",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),e.jsx("span",{className:"message-action-button-text",children:"Copy"})]}),n&&n.trim().length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"message-action-button knowledge-note-button",onClick:()=>{if(p){const v=Jt();let b="";v?b=v:b=typeof s.content=="string"?s.content:Array.isArray(s.content)?s.content.filter(he=>he.type==="text").map(he=>he.text).join(`
`):"";const R=s.selectedTextAtSend||t||void 0,V=s.pageNumberAtSend||l,X=s.textYPositionAtSend;p(b,R,V,X,s.id),j&&j()}},title:"Create knowledge note",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),e.jsx("span",{className:"message-action-button-text",children:"Save Note"})]}),e.jsxs("button",{className:"message-action-button add-to-pdf-button",onClick:()=>{if(k){const v=Jt();let b="";if(v)b=v;else if(typeof s.content=="string"){const{mainContent:he}=dt(s.content);b=he}else if(Array.isArray(s.content)){const he=s.content.filter(Me=>Me.type==="text").map(Me=>Me.text).join(`
`),{mainContent:oe}=dt(he);b=oe}const R=window.__lastSelectedTextPosition,V=R?.pageNumber||l||1,X=R?.textYPosition;b.trim()&&(k(b,V,X),o==="floating"&&(ke.current&&K(ke.current.scrollTop),S(!0)))}},title:"Add response to PDF as text box",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Add to PDF"})]})]}),e.jsxs("button",{className:"message-action-button refresh-button",onClick:()=>Pn(s.id),title:"Get a new response",disabled:C,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Redo"})]}),N[s.id]&&N[s.id].length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"message-action-button nav-button-left",onClick:()=>Yt(s.id,"prev"),title:"Previous response",disabled:!a[s.id]||a[s.id]===0,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("button",{className:"message-action-button nav-button-right",onClick:()=>Yt(s.id,"next"),title:"Next response",disabled:(()=>{const v=N[s.id]||[];return v.length===0?!0:(a[s.id]??v.length-1)>=v.length-1})(),children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})}),e.jsxs("span",{className:"response-counter",children:[(a[s.id]??N[s.id].length-1)+1," / ",N[s.id].length]})]})]})]})]},s.id)}),G&&e.jsxs("div",{className:"error-message",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("div",{className:"error-text",children:G})]}),e.jsx("div",{ref:Le})]}),!w&&!u&&o==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!w&&u&&!ne&&Y&&o==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:m?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:s=>{s.preventDefault(),s.stopPropagation(),we()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),o==="split"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:`model-selector-bar ${f==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:Ct,children:[e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(on,{mode:J,onModeChange:He,disabled:Y||!u})}),Be()&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:Qe,type:"file",accept:"image/*",multiple:!0,onChange:Gt,style:{display:"none"}}),e.jsxs("button",{type:"button",onClick:s=>{s.preventDefault(),s.stopPropagation(),Qe.current?.click()},className:"image-upload-button",title:"Upload images",disabled:Y||!u,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]}),e.jsx("span",{className:"image-upload-text",children:"Image"})]})]})]}),x.length>0&&e.jsxs("button",{onClick:Xt,className:`clear-button ${ve?"confirming":""}`,title:ve?"Click again to confirm":"Clear chat",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:ve?"Confirm":"Clear"})]}),e.jsx("button",{onClick:i,className:"layout-toggle-button",title:"Switch to floating layout","aria-label":"Switch to floating layout",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]})})]})}),e.jsxs("div",{className:"chatgpt-input-container",onDragOver:kn,onDragLeave:bn,onDrop:jn,children:[_.length>0&&e.jsxs("div",{className:"uploaded-images-preview-wrapper",children:[Ee&&e.jsx("button",{className:"image-scroll-button image-scroll-left",onClick:()=>Ut("left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:et,className:"uploaded-images-preview",onScroll:at,children:_.map((s,M)=>e.jsxs("div",{className:"image-preview-item",children:[e.jsx("img",{src:s,alt:`Upload ${M+1}`}),e.jsx("button",{type:"button",className:"image-preview-remove",onClick:()=>{z(P=>P.filter((v,b)=>b!==M))},title:"Remove image",children:"Ã—"})]},M))}),Ye&&e.jsx("button",{className:"image-scroll-button image-scroll-right",onClick:()=>Ut("right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),e.jsxs("div",{className:`input-wrapper${ue&&Be()?" drag-over":""}${fe?` focus-${J}`:""}`,children:[e.jsx("textarea",{ref:Oe,value:g,onChange:s=>y(s.target.value),onKeyPress:Sn,onFocus:()=>d(!0),onBlur:()=>d(!1),placeholder:"Ask a question...",rows:1,className:"chatgpt-input",disabled:C||Y||!u}),C?e.jsx("button",{onClick:Cn,className:"send-button pause-button",title:"Pause/Stop response",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"}),e.jsx("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"})]})}):e.jsx("button",{onClick:Kt,disabled:!g.trim()&&!t&&_.length===0||Y||!u,className:"send-button",title:"Send message",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})]}),o==="split"&&e.jsx("div",{className:`footer-text-outer split-footer ${f==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})}),o==="floating"&&e.jsx("div",{className:`footer-text-outer ${f==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})})]})]})}class is extends r.Component{constructor(n){super(n),this.state={hasError:!1,error:null}}static getDerivedStateFromError(n){return{hasError:!0,error:n}}render(){return this.state.hasError?this.props.fallback||e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#666",height:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{maxWidth:"400px"},children:[e.jsx("h3",{style:{marginBottom:"10px"},children:"PDF Viewer Temporarily Unavailable"}),e.jsx("p",{style:{marginBottom:"20px"},children:"There's a configuration issue with the PDF viewer. The rest of the app is working fine!"}),e.jsxs("p",{style:{fontSize:"12px",color:"#999",marginBottom:"20px"},children:["Error: ",this.state.error?.message||"Unknown error"]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("label",{htmlFor:"pdf-upload-fallback",style:{padding:"12px 24px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"6px",fontSize:"16px",fontWeight:"500",cursor:"pointer",display:"inline-block"},children:"Upload PDF (Basic)"}),e.jsx("input",{id:"pdf-upload-fallback",type:"file",accept:"application/pdf",onChange:n=>{const i=n.target.files?.[0];i&&alert(`PDF "${i.name}" selected. PDF viewing will work once the configuration issue is resolved.`)},style:{display:"none"}})]}),e.jsx("button",{onClick:()=>this.setState({hasError:!1,error:null}),style:{marginTop:"15px",padding:"8px 16px",backgroundColor:"#6c757d",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Try Again"})]})}):this.props.children}}const as=({notes:t,onDeleteNote:n,onClearAllNotes:i,onScrollToPage:o,onHighlightText:l,layout:p,theme:h,onNoteClick:k,isVisible:j=!0,onClose:f,pdfContentRef:u})=>{const[m,w]=r.useState(new Set),x=r.useRef(null),E=r.useRef(0),[D,q]=r.useState(0),[I,L]=r.useState(new Map),[N,$]=r.useState("following"),[a,c]=r.useState(!1),[g,y]=r.useState(null),[C,O]=r.useState(null),G=r.useRef(!1);r.useEffect(()=>{if(!a)return;const S=Q=>{Q.key==="Escape"&&(c(!1),y(null))};return document.addEventListener("keydown",S),()=>{document.removeEventListener("keydown",S)}},[a]);const B=r.useCallback((S,Q)=>{Q.preventDefault(),Q.stopPropagation(),w(K=>{const J=new Set(K);return J.has(S)?J.delete(S):J.add(S),J})},[]);r.useEffect(()=>{const S=()=>u?.current?u.current:window.__pdfContentRef||null,Q=()=>{const ae=S();if(ae&&x.current){const fe=ae.scrollHeight;if(E.current!==fe&&(E.current=fe,q(fe)),N==="following"?x.current.style.height=`${fe}px`:x.current.style.height="auto",N==="following"){const d=ae.scrollTop;x.current.style.transform=`translateY(-${d}px)`}else x.current.style.transform="none"}};Q();const K=S();if(K){const ae=()=>{if(x.current&&N==="following"){const T=K.scrollTop;x.current.style.transform=`translateY(-${T}px)`}else x.current&&N==="stack"&&(x.current.style.transform="none")};K.addEventListener("scroll",ae,{passive:!0});const fe=new ResizeObserver(()=>{Q()});fe.observe(K);const d=setInterval(Q,1e3);return()=>{clearInterval(d),K.removeEventListener("scroll",ae),fe.disconnect()}}const J=setTimeout(Q,100);return()=>clearTimeout(J)},[u,j,t.length,N]);const Y=S=>{S.pageNumber&&o?(o(S.pageNumber),setTimeout(()=>{S.linkedText&&l&&l(S.linkedText)},500)):S.linkedText&&l&&l(S.linkedText)},re=S=>{const Q=new Date(S);return Q.toLocaleDateString()+" "+Q.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},ne=r.useCallback(()=>{if(G.current)return;G.current=!0;const S=u?.current||window.__pdfContentRef;if(!S){G.current=!1;return}const Q=new Map;t.forEach(K=>{if(!K.pageNumber||K.textYPosition===void 0)return;const J=S.querySelectorAll(".pdf-page-wrapper");if(J.length<K.pageNumber){const _=S.querySelectorAll(".react-pdf__Page");if(_.length<K.pageNumber)return;const z=_[K.pageNumber-1];if(!z)return;const ue=z.offsetTop,le=z.offsetHeight,Ee=ue+K.textYPosition*le;Q.set(K.id,Ee);return}const ae=J[K.pageNumber-1];if(!ae)return;const fe=ae.offsetTop,d=ae.offsetHeight,T=K.textYPosition*d,F=fe+T;Q.set(K.id,F)}),L(Q),setTimeout(()=>{G.current=!1},0)},[t,u]);r.useEffect(()=>{if(!j)return;ne();const S=u?.current||window.__pdfContentRef;if(S){const Q=new ResizeObserver(()=>{ne()});Q.observe(S);const K=setInterval(ne,500);return()=>{Q.disconnect(),clearInterval(K)}}},[ne,u,j]),r.useEffect(()=>{if(D>0){const S=setTimeout(()=>{ne()},200);return()=>clearTimeout(S)}},[D,ne]),r.useEffect(()=>{if(t.length===0){O(null);return}const S=t.some(Q=>Q.id===C);C&&!S&&O(null)},[t,C]);const pe=S=>I.get(S.id),xe=(S,Q)=>{const K=pe(S);if(K===void 0)return{stackIndex:0,stackSize:1,basePosition:0,displayIndex:0};const J=10,ae=Q.filter(_=>{const z=pe(_);return z!==void 0&&Math.abs(z-K)<J}).sort((_,z)=>_.createdAt-z.createdAt),fe=ae.findIndex(_=>_.id===S.id),d=ae.length,T=Math.min(...ae.map(_=>pe(_)||0));let F=fe;if(d>1&&C){const _=ae.findIndex(z=>z.id===C);if(_!==-1){const z=ae.filter((ue,le)=>le>fe).length;if(fe>_)F=d-1-z;else{const ue=(fe-_+d)%d,le=ae.filter((Ee,De)=>De>_).length;F=Math.min(ue,d-1-le)}}}else d>1&&(F=fe);return{stackIndex:fe,stackSize:d,basePosition:T,displayIndex:F}};return e.jsxs("div",{className:`knowledge-notes-panel ${p}-layout theme-${h} ${j?"knowledge-notes-visible":""}`,children:[e.jsxs("div",{className:"knowledge-notes-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h3",{children:"Knowledge Notes"}),e.jsx("button",{className:"display-mode-toggle",onClick:()=>$(N==="following"?"stack":"following"),title:N==="following"?"Switch to stack mode":"Switch to following mode",style:{background:"transparent",border:"1px solid rgba(0, 0, 0, 0.2)",borderRadius:"4px",padding:"4px 8px",cursor:"pointer",fontSize:"12px",color:"inherit",display:"flex",alignItems:"center",gap:"4px"},children:N==="following"?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]}),"Following"]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),"Stack"]})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxs("button",{className:"notes-count-button",onClick:S=>{S.preventDefault(),S.stopPropagation(),t.length>0&&(y(null),c(!0))},title:t.length>0?"Clear all notes":"No notes to clear",disabled:t.length===0,children:[e.jsx("span",{className:"notes-count-text",children:t.length}),e.jsxs("svg",{className:"notes-count-clear-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})]}),e.jsx("button",{className:"knowledge-notes-close",onClick:S=>{S.stopPropagation(),f?.()},"aria-label":"Close knowledge notes",style:{display:"flex",alignItems:"center",justifyContent:"center",background:"transparent",border:"none",cursor:"pointer",padding:"4px",width:"32px",height:"32px",borderRadius:"6px",transition:"background 0.2s, color 0.2s"},children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx("div",{className:`knowledge-notes-list ${N==="stack"?"stack-mode":"following-mode"}`,ref:x,style:{height:N==="following"&&D>0?`${D}px`:"auto",overflow:N==="stack"?"auto":"visible"},children:t.length===0?e.jsx("div",{className:"empty-notes",children:"No knowledge notes yet"}):t.map(S=>{const Q=m.has(S.id),K=pe(S),ae=(S.content?S.content.split(`
`):[]).length>3||S.content&&S.content.length>200,fe=C===S.id,d=xe(S,t),T=8,F=1.5,_=2,z=d.displayIndex*T,ue=d.displayIndex*_,le=d.stackSize-1,Ee=d.stackIndex===d.stackSize-1,De=le*F,Ye=Ee?De:d.displayIndex*F,Ue=K!==void 0?d.displayIndex===0?K:K+z:void 0,gt=d.displayIndex===0?0:Ye,rt=d.displayIndex===0?0:ue;return e.jsxs("div",{className:`knowledge-note-item ${fe?"note-front":""} ${d.stackSize>1?"note-stacked":""}`,onClick:ve=>{const Ve=ve.target;if(!(Ve.closest("button")||Ve.closest(".note-linked-text")))if(Y(S),k?.(S),N==="following"&&d.stackSize>1)if(C!==S.id)O(S.id);else{const Fe=t.filter(Re=>{const Le=pe(Re),Oe=pe(S);return Le!==void 0&&Oe!==void 0&&Math.abs(Le-Oe)<10}).sort((Re,Le)=>Re.createdAt-Le.createdAt),et=(Fe.findIndex(Re=>Re.id===S.id)+1)%Fe.length;O(Fe[et].id)}else N==="following"&&O(S.id)},style:N==="following"&&Ue!==void 0?{position:"absolute",top:`${Ue}px`,left:`${8+rt}px`,right:`${8-rt}px`,width:"auto",zIndex:d.displayIndex===0?20+d.stackSize:10+d.displayIndex,pointerEvents:"auto",transform:`rotate(${gt}deg)`,transformOrigin:"center top",transition:"transform 0.3s ease, z-index 0.2s ease, top 0.3s ease, left 0.3s ease, right 0.3s ease",boxShadow:d.displayIndex===0?"0 4px 16px rgba(0, 0, 0, 0.15)":`0 ${2+d.displayIndex}px ${8+d.displayIndex*2}px rgba(0, 0, 0, ${.1+d.displayIndex*.02})`}:{position:"relative",marginBottom:"12px",marginLeft:"8px",marginRight:"8px",width:"auto"},children:[e.jsxs("div",{className:"note-header",children:[e.jsxs("div",{className:"note-meta",children:[S.pageNumber&&e.jsxs("span",{className:"note-page-badge",children:["Page ",S.pageNumber]}),S.linkedText&&e.jsx("span",{className:"note-text-badge",children:"Linked Text"}),e.jsx("span",{className:"note-date",children:re(S.createdAt)})]}),e.jsx("button",{className:"note-delete-button",onClick:ve=>{ve.stopPropagation(),y(S.id),c(!0)},title:"Delete note",children:"Ã—"})]}),S.linkedText&&e.jsxs("div",{className:"note-linked-text",onClick:()=>{Y(S),k?.(S)},children:['"',S.linkedText.substring(0,100),S.linkedText.length>100?"...":"",'"']}),e.jsxs("div",{className:"note-content-wrapper",children:[e.jsx("div",{className:`note-content ${Q?"expanded":"collapsed"}`,children:e.jsx("div",{className:"markdown-content",children:e.jsx(Ft,{remarkPlugins:[_t,Rt],rehypePlugins:[[Lt,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],components:{p:({children:ve})=>e.jsx("p",{style:{marginBottom:"0.5em"},children:ve}),a:({href:ve,children:Ve})=>e.jsx("a",{href:ve,target:"_blank",rel:"noopener noreferrer",onClick:Fe=>Fe.stopPropagation(),children:Ve})},children:Ot(S.content)})})}),ae&&e.jsx("button",{className:"note-expand-button",onClick:ve=>{ve.preventDefault(),ve.stopPropagation(),B(S.id,ve)},onMouseDown:ve=>{ve.stopPropagation()},title:Q?"Collapse":"Expand",type:"button",children:Q?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}),e.jsx("span",{children:"Show Less"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{children:"Show More"})]})})]})]},S.id)})}),a&&e.jsx("div",{className:"confirm-dialog-overlay",onClick:()=>{c(!1),y(null)},children:e.jsxs("div",{className:"confirm-dialog",onClick:S=>S.stopPropagation(),children:[e.jsx("div",{className:"confirm-dialog-header",children:e.jsx("h3",{children:g?"Delete Note":"Clear All Notes"})}),e.jsx("div",{className:"confirm-dialog-content",children:g?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"Are you sure you want to delete this knowledge note?"}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Are you sure you want to delete all ",e.jsx("strong",{children:t.length})," knowledge note",t.length===1?"":"s","?"]}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]})}),e.jsxs("div",{className:"confirm-dialog-actions",children:[e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-cancel",onClick:()=>{c(!1),y(null)},children:"Cancel"}),e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-confirm",onClick:()=>{g?(n(g),y(null)):i&&i(),c(!1)},children:g?"Delete":"Clear All"})]})]})})]})},Ze="chatnote_pdf_history_cache",wn=300*1e3,vn="chatnote_pdf_history_names",zt="chatnote_pdf_history_version",Wt="chatnote_pdf_history_last_fetch",ls=()=>{try{const t=localStorage.getItem(vn);if(!t)return{};const n=JSON.parse(t);if(n&&typeof n=="object")return n}catch(t){console.warn("Failed to parse generated name cache:",t)}return{}},ln=t=>{try{localStorage.setItem(vn,JSON.stringify(t))}catch(n){console.warn("Failed to persist generated name cache:",n)}},cs=t=>{try{const n=localStorage.getItem(Ze);if(!n)return;const i=JSON.parse(n);i.pdfs=(i.pdfs||[]).filter(o=>o.pdfId!==t),localStorage.setItem(Ze,JSON.stringify(i))}catch(n){console.warn("Failed to update history cache after deletion:",n)}},ds=t=>{if(!t)return"";const n="__REASONING_START__",i="__REASONING_END__";if(t.includes(n)&&t.includes(i)){const o=t.indexOf(i)+i.length;t=t.slice(o)}return t=t.replace(/<think>[\s\S]*?<\/think>/gi,""),t.trim()},us=(t,n)=>{const i=ds(t);if(!i)return n;const l=i.split(`
`)[0].replace(/^["'â€œâ€`]+|["'â€œâ€`]+$/g,"").replace(/[.:]+$/g,"").trim().replace(/\s+/g," ");return l?l.length>60?`${l.slice(0,57).trimEnd()}...`:l:n},wt=()=>{try{const t=localStorage.getItem(zt);if(!t)return 0;const n=Number(t);return Number.isFinite(n)?n:0}catch{return 0}},hs=()=>{try{const t=sessionStorage.getItem(Wt);if(!t)return 0;const n=Number(t);return Number.isFinite(n)?n:0}catch{return 0}},fs=t=>{try{sessionStorage.setItem(Wt,`${t}`)}catch{}},qt="chatnote_pdf_history_pending_save",gs=()=>{try{localStorage.setItem(qt,"true")}catch{}},cn=()=>{try{localStorage.removeItem(qt)}catch{}},Et=()=>{try{return localStorage.getItem(qt)==="true"}catch{return!1}},ms=()=>{try{sessionStorage.removeItem(Wt)}catch{}},kt=t=>{try{localStorage.setItem(zt,`${Date.now()}`),t&&gs()}catch{}},ps=()=>{try{localStorage.removeItem(zt)}catch{}};function bt(){try{localStorage.removeItem(Ze)}catch(t){console.warn("Failed to invalidate PDF history cache:",t)}}let vt=null;async function Dt(t){try{const n=localStorage.getItem("auth_token");if(!n)return;const i=localStorage.getItem(Ze);if(i)try{const o=JSON.parse(i);if(Date.now()-o.timestamp<wn)return}catch{}return vt||(vt=(async()=>{try{const o=await fetch(`${t}/api/drive/history`,{headers:{Authorization:`Bearer ${n}`}});if(o.ok){const p=(await o.json()).pdfs||[];try{const h={pdfs:p,timestamp:Date.now()};localStorage.setItem(Ze,JSON.stringify(h))}catch(h){console.warn("Failed to save cached history:",h)}}else if(o.status===403)try{localStorage.removeItem(Ze)}catch{}}finally{vt=null}})(),vt)}catch{}}function xs({isOpen:t,onClose:n,onSelectPdf:i,hasUnsavedChanges:o=!1,onSaveBeforeFetch:l,isDriveAuthorized:p=!1}){const{isAuthenticated:h}=ft(),[k,j]=r.useState([]),[f,u]=r.useState(!1),[m,w]=r.useState(null),[x,E]=r.useState(!1),[D,q]=r.useState(()=>ls()),[I,L]=r.useState({}),N=r.useRef(new Set),[$,a]=r.useState(!1),[c,g]=r.useState(""),[y,C]=r.useState({}),[O,G]=r.useState({}),B=r.useRef({}),[Y,re]=r.useState(()=>hs()),ne=r.useRef(t),pe=()=>{try{const d=localStorage.getItem(Ze);if(!d)return null;const T=JSON.parse(d);if(Date.now()-T.timestamp<wn)return T.pdfs}catch(d){console.warn("Failed to load cached history:",d)}return null},xe=d=>{try{const T={pdfs:d,timestamp:Date.now()};localStorage.setItem(Ze,JSON.stringify(T))}catch(T){console.warn("Failed to save cached history:",T)}};r.useEffect(()=>{ne.current=t},[t]),r.useEffect(()=>()=>{Object.values(B.current).forEach(d=>clearTimeout(d)),B.current={}},[]),r.useEffect(()=>{let d=!0;return xn().then(T=>{d&&a(T)}).catch(()=>{d&&a(!1)}),()=>{d=!1}},[]),r.useEffect(()=>{if(t&&h){E(!1);const d=pe();if(d){j(d),u(!1);const T=wt(),F=T>0&&T>Y,_=Et(),z=o;(F||_||z||!d||d.length===0)&&(z&&l?l().then(()=>{const le=wt(),Ee=Et();K(!0,le,Ee)}).catch(()=>{const le=wt(),Ee=Et();K(!0,le,Ee)}):K(!0,T,_))}else u(!0),K(!1,wt(),Et())}else h?t||(E(!1),g(""),G({})):(j([]),w(null),u(!1),E(!1),ps(),re(0),ms(),cn())},[t,h]),r.useEffect(()=>{if(!$||k.length===0)return;let d=!1;return(async()=>{for(const F of k){if(d)return;const _=D[F.pdfId];let z=!1;if(_?z=_.originalFileName!==F.originalFileName:z=F.displayName.toLowerCase().endsWith(".pdf")||F.displayName===F.originalFileName,!(!z||N.current.has(F.pdfId))){N.current.add(F.pdfId),L(ue=>({...ue,[F.pdfId]:!0}));try{const ue=`You generate short, descriptive titles for uploaded PDFs.
File name: "${F.originalFileName}".
Output a concise (<=5 words) human-friendly title without quotes.`,le=await At([{role:"user",content:ue}],void 0,void 0,ot[0]);if(d)return;const Ee=us(le,F.displayName||F.originalFileName);q(De=>{const Ye=De[F.pdfId];if(Ye&&Ye.name===Ee&&Ye.originalFileName===F.originalFileName)return De;const Ue={...De,[F.pdfId]:{name:Ee,originalFileName:F.originalFileName,updatedAt:Date.now()}};return ln(Ue),Ue})}catch(ue){console.warn("Failed to generate PDF title:",ue)}finally{N.current.delete(F.pdfId),L(ue=>{const le={...ue};return delete le[F.pdfId],le})}}}})(),()=>{d=!0}},[$,k]);const S=r.useCallback(d=>{G(T=>({...T,[d]:!0})),B.current[d]&&clearTimeout(B.current[d]),B.current[d]=window.setTimeout(()=>{G(T=>{const F={...T};return delete F[d],F}),delete B.current[d]},4e3)},[]),Q=r.useCallback(async d=>{if(d){C(T=>({...T,[d]:!0}));try{const T=localStorage.getItem("auth_token");if(!T)throw new Error("Please log in again.");const F=await fetch(`${Ce}/api/drive/history/${d}`,{method:"DELETE",headers:{Authorization:`Bearer ${T}`}});if(!F.ok){const _=await F.text();throw new Error(_||"Failed to delete PDF")}j(_=>_.filter(z=>z.pdfId!==d)),q(_=>{if(!_[d])return _;const z={..._};return delete z[d],ln(z),z}),cs(d),bt(),kt(!1)}catch(T){console.error("Failed to delete PDF:",T),alert(T instanceof Error?T.message:"Failed to delete PDF")}finally{C(T=>{const F={...T};return delete F[d],F}),G(T=>{if(!T[d])return T;const F={...T};return delete F[d],F}),B.current[d]&&(clearTimeout(B.current[d]),delete B.current[d])}}},[]),K=async(d=!1,T,F)=>{if(!p){ne.current&&!d&&(w("Google Drive not authorized. Please authorize Drive access to view PDF history."),u(!1));return}if(ne.current){d?E(!0):u(!0),w(null);try{const _=localStorage.getItem("auth_token");if(!_){ne.current&&w("Not authenticated"),d?E(!1):u(!1);return}const z=await fetch(`${Ce}/api/drive/history`,{headers:{Authorization:`Bearer ${_}`}});if(!z.ok){ne.current&&(z.status===403?(w("Drive not authorized. Please authorize Drive access first."),localStorage.removeItem(Ze)):w("Failed to load PDF history")),d?E(!1):u(!1);return}const le=(await z.json()).pdfs||[];if(ne.current){j(le),xe(le);const Ee=T&&T>0?T:wt();Ee>0&&(re(Ee),fs(Ee)),F&&cn()}}catch(_){console.error("Error loading history:",_),ne.current&&!d&&w("Failed to load PDF history")}finally{d?E(!1):u(!1)}}},J=d=>{const T=new Date(d),_=new Date().getTime()-T.getTime(),z=Math.floor(_/6e4),ue=Math.floor(_/36e5),le=Math.floor(_/864e5);return z<1?"Just now":z<60?`${z}m ago`:ue<24?`${ue}h ago`:le<7?`${le}d ago`:T.toLocaleDateString()},ae=r.useMemo(()=>{const d=c.trim().toLowerCase();return d?k.filter(T=>(D[T.pdfId]?.name||"").toLowerCase().includes(d)||T.originalFileName.toLowerCase().includes(d)||T.displayName.toLowerCase().includes(d)):k},[k,c,D]),fe=c.trim().length>0;return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pdf-history-overlay",onClick:n}),e.jsxs("div",{className:"pdf-history-panel",children:[e.jsxs("div",{className:"pdf-history-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h2",{children:"PDF History"}),x&&e.jsx("div",{className:"pdf-history-refresh-indicator",title:"Refreshing...",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"})})})]}),e.jsx("button",{className:"pdf-history-close",onClick:n,"aria-label":"Close history",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsxs("div",{className:"pdf-history-content",children:[!m&&e.jsxs("div",{className:"pdf-history-search",children:[e.jsx("input",{type:"search",placeholder:"Search by title or file name...",value:c,onChange:d=>g(d.target.value),"aria-label":"Search PDF history",disabled:f&&k.length===0}),c&&e.jsx("button",{type:"button",className:"pdf-history-search-clear",onClick:()=>g(""),"aria-label":"Clear search",children:"Ã—"})]}),f&&e.jsx("div",{className:"pdf-history-loading",children:e.jsx("span",{children:"Loading..."})}),m&&e.jsxs("div",{className:"pdf-history-error",children:[e.jsx("p",{children:m}),m.includes("not authorized")&&e.jsx("button",{className:"pdf-history-authorize-btn",onClick:async()=>{try{const d=localStorage.getItem("auth_token");if(!d){alert("Please log in first");return}const T=await fetch(`${Ce}/api/drive/auth`,{headers:{Authorization:`Bearer ${d}`}});if(!T.ok)throw new Error("Failed to initiate Drive authorization");const F=await T.json();F.authorized?K():F.authUrl&&(window.location.href=F.authUrl)}catch(d){console.error("Error authorizing Drive:",d),w("Failed to authorize Drive access. Please try again.")}},children:"Authorize Drive Access"})]}),!f&&!m&&k.length===0&&!fe&&e.jsxs("div",{className:"pdf-history-empty",children:[e.jsx("p",{children:"No PDFs yet"}),e.jsx("p",{className:"pdf-history-empty-hint",children:"Upload a PDF to get started"})]}),!f&&!m&&fe&&ae.length===0&&e.jsxs("div",{className:"pdf-history-empty",children:[e.jsx("p",{children:"No PDFs match your search"}),e.jsx("button",{type:"button",className:"pdf-history-search-reset",onClick:()=>g(""),children:"Clear search"})]}),!f&&!m&&ae.length>0&&e.jsx("div",{className:"pdf-history-list",children:ae.map(d=>{const T=D[d.pdfId]?.name||d.displayName,F=!!I[d.pdfId],_=!!y[d.pdfId],z=!!O[d.pdfId];return e.jsxs("div",{className:"pdf-history-item",onClick:()=>{_||(i(d.pdfId),n())},children:[e.jsx("div",{className:"pdf-history-item-icon",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsxs("div",{className:"pdf-history-item-content",children:[e.jsxs("div",{className:"pdf-history-item-header",children:[e.jsxs("div",{className:"pdf-history-item-name",children:[e.jsx("span",{children:T}),F&&e.jsx("span",{className:"pdf-history-name-spinner","aria-label":"Generating title"})]}),e.jsx("button",{type:"button",className:`pdf-history-delete ${z?"confirm":""}`,onClick:ue=>{if(ue.stopPropagation(),!_){if(!z){S(d.pdfId);return}Q(d.pdfId)}},"aria-label":"Delete PDF",disabled:_,children:_?e.jsx("span",{className:"pdf-history-delete-spinner","aria-hidden":"true"}):e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"}),e.jsx("path",{d:"M10 11v6"}),e.jsx("path",{d:"M14 11v6"}),e.jsx("path",{d:"M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"})]})})]}),e.jsxs("div",{className:"pdf-history-item-original",title:d.originalFileName,children:[e.jsx("span",{className:"pdf-history-original-name",children:d.originalFileName}),e.jsx("span",{className:"pdf-history-divider",children:"â€¢"}),e.jsx("span",{children:J(d.lastModifiedAt)})]}),e.jsx("div",{className:"pdf-history-item-meta",children:d.pageCount>0&&e.jsxs("span",{children:[d.pageCount," page",d.pageCount!==1?"s":""]})}),(d.hasAnnotations||d.hasNotes)&&e.jsxs("div",{className:"pdf-history-item-badges",children:[d.hasAnnotations&&e.jsx("span",{className:"pdf-history-badge",children:"Annotations"}),d.hasNotes&&e.jsx("span",{className:"pdf-history-badge",children:"Notes"})]})]})]},d.pdfId)})})]})]})]}):null}let Xe;async function ys(){if(!Xe){if(typeof window<"u"&&window.pdfjsLib)Xe=window.pdfjsLib;else{const t=await ut(()=>import("./vendor-pdf-DDxsMbbh.js").then(n=>n.p),[]);Xe=t.default||t}if(typeof window<"u"&&Xe&&!Xe.GlobalWorkerOptions?.workerSrc){let t;{const n="/ChatNote/";t=`${n.endsWith("/")?n:`${n}/`}pdf.worker.min.js`}Xe.GlobalWorkerOptions?Xe.GlobalWorkerOptions.workerSrc=t:Xe.GlobalWorkerOptions={workerSrc:t}}}return Xe}async function dn(t){try{const n=await ys(),i=await t.arrayBuffer(),l=await n.getDocument({data:i}).promise,p=l.numPages,h=[];for(let f=1;f<=p;f++){const w=(await(await l.getPage(f)).getTextContent()).items.map(x=>x.str).join(" ");h.push(Promise.resolve(w))}return(await Promise.all(h)).map((f,u)=>`--- Page ${u+1} ---
${f}`).join(`

`)}catch(n){throw console.error("Error extracting text from PDF:",n),new Error("Failed to extract text from PDF. The PDF may be corrupted or password-protected.")}}const ws=["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#FFC0CB"];function vs({isOpen:t,onConfirm:n,onCancel:i}){const{theme:o}=Mt();return t?e.jsx("div",{className:"drive-sync-backdrop",children:e.jsxs("div",{className:`drive-sync-modal ${o}`,children:[e.jsx("h3",{children:"Sync with Google Drive?"}),e.jsx("p",{children:"Would you like to sync your PDFs and notes with Google Drive? This allows you to access your files from any device."}),e.jsxs("div",{className:"drive-sync-buttons",children:[e.jsx("button",{onClick:i,className:"button-cancel",children:"Not Now"}),e.jsx("button",{onClick:n,className:"button-confirm",children:"Sync with Drive"})]})]})}):null}function ks({message:t,type:n="info",duration:i=3e3,onClose:o}){const[l,p]=r.useState(!1);return r.useEffect(()=>{const h=setTimeout(()=>{p(!0)},i-300),k=setTimeout(()=>{o()},i);return()=>{clearTimeout(h),clearTimeout(k)}},[i,o]),e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${l?"toast-exit":""}`,children:[e.jsx("svg",{className:`toast-icon ${n}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:n==="info"&&e.jsxs(e.Fragment,{children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]})}),e.jsx("span",{children:t})]})})}const bs=r.lazy(()=>ut(()=>import("./PDFViewer-CTMDzOzL.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function js(){const{theme:t}=Mt(),{isChatVisible:n,setChatVisible:i}=gn(),{isAuthenticated:o,user:l}=ft(),[p,h]=r.useState(null),[k,j]=r.useState(""),[f,u]=r.useState(""),[m,w]=r.useState("floating"),[x,E]=r.useState(1),[D,q]=r.useState([]),[I,L]=r.useState(!1),[N,$]=r.useState(null),[a,c]=r.useState(!1),[g,y]=r.useState(null),[C,O]=r.useState([]),[G,B]=r.useState(!1),[Y,re]=r.useState(!1),[ne,pe]=r.useState(!1),[xe,S]=r.useState(!1),[Q,K]=r.useState(null),[J,ae]=r.useState(!1),[fe,d]=r.useState(!1),[T,F]=r.useState(0),[_,z]=r.useState(0),ue=r.useRef(!1),[le,Ee]=r.useState(null),De=r.useMemo(()=>!g||!o?!1:T===0||_>T,[g,o,T,_]);r.useEffect(()=>{const A=new URLSearchParams(window.location.search),W=A.get("drive_auth_success"),Z=A.get("drive_auth_error");W==="true"?(window.history.replaceState({},"",window.location.pathname),ae(!1),setTimeout(()=>{Dt(Ce).catch(()=>{})},1e3)):Z&&(console.warn("Drive authorization failed:",Z),window.history.replaceState({},"",window.location.pathname))},[]),r.useEffect(()=>{o&&l&&!ue.current&&(kt(!1),ue.current=!0),o&&l&&!J?(ae(!0),setTimeout(()=>{Ye()},500)):o||(ae(!1),ue.current=!1,h(null),j(""),O([]),q([]),y(null),E(1),L(!1),u(""),c(!1),bt())},[o,l]);const Ye=async()=>{try{const A=localStorage.getItem("auth_token");if(!A)return;const W=await fetch(`${Ce}/api/drive/status`,{headers:{Authorization:`Bearer ${A}`}});if(W.ok)if((await W.json()).authorized){d(!0),Dt(Ce).catch(()=>{});return}else d(!1);const Z=await fetch(`${Ce}/api/drive/auth`,{headers:{Authorization:`Bearer ${A}`}});if(Z.ok){const se=await Z.json();!se.authorized&&se.authUrl&&(K(se.authUrl),S(!0))}}catch(A){console.warn("Failed to check/authorize Drive:",A)}},Ue=()=>{Q&&(window.location.href=Q),S(!1)},gt=()=>{S(!1)},rt=async A=>{h(A),pe(!0);try{const W=await dn(A);if(j(W),W&&W.trim().length>0)try{const{indexPDF:Z}=await ut(async()=>{const{indexPDF:se}=await import("./pdfRAG-BUQZRmsO.js");return{indexPDF:se}},[]);await Z(W)}catch(Z){console.warn("[RAG] Failed to index PDF, will use keyword search:",Z)}if(o&&fe)try{const Z=localStorage.getItem("auth_token");if(Z){const se=await A.arrayBuffer(),ie=new Uint8Array(se);let Te="";const Je=8192;for(let He=0;He<ie.length;He+=Je){const Be=ie.subarray(He,Math.min(He+Je,ie.length));for(let it=0;it<Be.length;it++)Te+=String.fromCharCode(Be[it])}const tt=btoa(Te);let we="";if(W&&W.trim().length>0)try{const He=W.slice(0,1e3),Be=`You generate short, descriptive titles for uploaded PDFs based on their content.
File name: "${A.name}"
Content snippet: "${He}"
Output a concise (<=5 words) human-friendly title without quotes. Do not include "Title:" prefix.`;we=(await At([{role:"user",content:Be}],void 0,void 0,ot[0])).replace(/^["'â€œâ€`]+|["'â€œâ€`]+$/g,"").replace(/[.:]+$/g,"").trim(),(!we||we.length>60)&&(we="")}catch(He){console.warn("Failed to generate title:",He)}const _e=await fetch(`${Ce}/api/drive/upload-pdf`,{method:"POST",headers:{Authorization:`Bearer ${Z}`,"Content-Type":"application/json"},body:JSON.stringify({pdfBase64:tt,fileName:A.name,displayName:we||void 0})});if(_e.ok){const He=await _e.json();y(He.pdfId),F(0),z(0),console.log("PDF uploaded to Drive:",He.pdfId),bt(),kt(!1)}else console.warn("Failed to upload PDF to Drive:",await _e.text())}}catch(Z){console.warn("Error uploading PDF to Drive:",Z)}}catch(W){console.error("Failed to extract PDF text:",W),j("")}finally{pe(!1)}};r.useEffect(()=>{p||(j(""),ut(async()=>{const{clearPDFIndices:A}=await import("./pdfRAG-BUQZRmsO.js");return{clearPDFIndices:A}},[]).then(({clearPDFIndices:A})=>{A()}).catch(()=>{}))},[p]);const ve=(A,W,Z)=>{u(A),A&&W!==void 0&&Z!==void 0&&($({text:A,pageNumber:W,textYPosition:Z}),window.__lastSelectedTextPosition={text:A,pageNumber:W,textYPosition:Z})},Ve=()=>{w(A=>A==="floating"?"split":"floating")},Fe=(A,W,Z,se,ie)=>{if(D.find(_e=>_e.messageId===ie&&_e.content===A)){Ee("This note has already been saved to your knowledge notes");return}const Je=Z||N?.pageNumber||x,tt=se??N?.textYPosition??0,we={id:`note-${Date.now()}`,content:A,linkedText:W||N?.text,pageNumber:Je,textYPosition:tt,createdAt:Date.now(),messageId:ie};q(_e=>[..._e,we])},Qe=A=>{q(W=>W.filter(Z=>Z.id!==A))},et=()=>{q([])},Re=A=>{E(A),window.__pdfScrollToPage&&window.__pdfScrollToPage(A)},Le=r.useCallback(async()=>{if(!(!g||!o)&&C.length!==0)try{const A=localStorage.getItem("auth_token");if(!A)return;await fetch(`${Ce}/api/drive/save-annotations/${g}`,{method:"POST",headers:{Authorization:`Bearer ${A}`,"Content-Type":"application/json"},body:JSON.stringify({annotations:C})}),bt(),kt(!0),F(Date.now())}catch(A){console.error("Failed to save annotations:",A)}},[g,o,C]),Oe=r.useCallback(async()=>{if(!(!g||!o)&&D.length!==0)try{const A=localStorage.getItem("auth_token");if(!A)return;await fetch(`${Ce}/api/drive/save-notes/${g}`,{method:"POST",headers:{Authorization:`Bearer ${A}`,"Content-Type":"application/json"},body:JSON.stringify({notes:D})}),bt(),kt(!0),F(Date.now())}catch(A){console.error("Failed to save notes:",A)}},[g,o,D]);r.useEffect(()=>{const A=()=>{if(!g||!o)return!1;const se=C.length>0,ie=D.length>0;return!se&&!ie?!1:T===0||_>T},W=()=>{if(document.visibilityState==="hidden"&&A()){const se=[];C.length>0&&se.push(Le()),D.length>0&&se.push(Oe()),Promise.race([Promise.all(se),new Promise(ie=>setTimeout(ie,1500))]).catch(()=>{})}},Z=se=>{if(A())try{const ie=localStorage.getItem("auth_token");if(ie){if(C.length>0){const Te=JSON.stringify({annotations:C});Te.length<6e4&&fetch(`${Ce}/api/drive/save-annotations/${g}`,{method:"POST",headers:{Authorization:`Bearer ${ie}`,"Content-Type":"application/json"},body:Te,keepalive:!0}).catch(()=>{})}if(D.length>0){const Te=JSON.stringify({notes:D});Te.length<6e4&&fetch(`${Ce}/api/drive/save-notes/${g}`,{method:"POST",headers:{Authorization:`Bearer ${ie}`,"Content-Type":"application/json"},body:Te,keepalive:!0}).catch(()=>{})}}}catch{}if(p&&A())return se.preventDefault(),se.returnValue="",""};return window.addEventListener("beforeunload",Z),document.addEventListener("visibilitychange",W),()=>{window.removeEventListener("beforeunload",Z),document.removeEventListener("visibilitychange",W)}},[p,g,o,C,D,T,_,Le,Oe]);const Ne=r.useCallback(async()=>{if(!g||!o)return;const A=n;L(!1),i(!1),re(!0);try{await Promise.all([Le(),Oe()])}finally{re(!1),A&&i(!0)}},[g,o,n,i,Le,Oe]),Ct=async A=>{if(A!==g){if(g&&o&&De)try{await Promise.race([Ne(),new Promise(W=>setTimeout(W,2e3))])}catch(W){console.warn("Failed to save before switching PDF:",W)}B(!0),h(null),O([]),q([]),y(null);try{const W=localStorage.getItem("auth_token");if(!W){alert("Please log in to load PDF from history"),B(!1);return}const Z=await fetch(`${Ce}/api/drive/load-pdf/${A}`,{headers:{Authorization:`Bearer ${W}`}});if(!Z.ok)throw new Error("Failed to load PDF");const se=await Z.json(),ie=atob(se.pdfBlob),Te=new Uint8Array(ie.length);for(let we=0;we<ie.length;we++)Te[we]=ie.charCodeAt(we);const Je=new Blob([Te],{type:"application/pdf"}),tt=new File([Je],se.metadata.originalFileName,{type:"application/pdf"});h(tt),y(se.metadata.pdfId),dn(tt).then(we=>{if(j(we),we&&we.trim().length>0)try{ut(async()=>{const{indexPDF:_e}=await import("./pdfRAG-BUQZRmsO.js");return{indexPDF:_e}},[]).then(({indexPDF:_e})=>{_e(we).catch(He=>{console.warn("[RAG] Failed to index PDF:",He)})})}catch(_e){console.warn("[RAG] Failed to index PDF:",_e)}}).catch(we=>{console.warn("Failed to extract PDF text:",we)}),O(se.annotations||[]),q(se.knowledgeNotes||[]),F(Date.now()),z(Date.now()),E(1),se.knowledgeNotes&&se.knowledgeNotes.length>0&&L(!0)}catch(W){console.error("Failed to load PDF from history:",W),alert("Failed to load PDF. Please try again."),B(!1)}}},mt=async()=>{const A=De;if(A){re(!0);try{await Ne()}catch(W){console.warn("Failed to save before starting new session:",W)}finally{re(!1)}}h(null),j(""),O([]),q([]),y(null),E(1),L(!1),u(""),A&&Dt(Ce).catch(()=>{})},ke=r.useCallback(async()=>{De&&await Ne()},[De,Ne]);return r.useEffect(()=>{(C.length>0||D.length>0)&&z(Date.now())},[C,D]),r.useEffect(()=>{if(g&&o&&C.length>0){const A=setTimeout(()=>{Le()},5e3);return()=>clearTimeout(A)}},[C,g,o,Le]),r.useEffect(()=>{if(g&&o&&D.length>0){const A=setTimeout(()=>{Oe()},5e3);return()=>clearTimeout(A)}},[D,g,o,Oe]),e.jsxs("div",{className:"app",children:[e.jsx(Bn,{hasUnsavedChanges:De,saveCurrentState:Ne,isSavingSession:Y,setIsSavingSession:re,children:e.jsx(Qn,{onOpenHistory:()=>c(!0),isSavingSession:Y})}),e.jsx(xs,{isOpen:a,onClose:()=>c(!1),onSelectPdf:Ct,hasUnsavedChanges:De,onSaveBeforeFetch:ke,isDriveAuthorized:fe}),e.jsxs("div",{className:`main-content ${m==="split"?"split-layout":""} ${I&&m==="floating"?"has-knowledge-notes":""}`,children:[e.jsx(is,{children:e.jsx(r.Suspense,{fallback:e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading PDF viewer..."}),children:e.jsx(bs,{file:p,onFileUpload:rt,onTextSelection:ve,layout:m,onPageChange:E,showKnowledgeNotes:I,onToggleKnowledgeNotes:()=>L(!I),knowledgeNotes:D,onScrollToPage:Re,onNoteClick:A=>{A.pageNumber&&Re(A.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0,onAddAnnotation:()=>{},initialAnnotations:C,onAnnotationsChange:O,isLoadingPdf:G,onLoadingComplete:()=>B(!1),isSavingSession:Y,onNewSession:mt})})}),I&&e.jsx(as,{notes:D,onDeleteNote:Qe,onClearAllNotes:et,onScrollToPage:Re,layout:m,theme:t,isVisible:I,onClose:()=>L(!1),onNoteClick:A=>{A.pageNumber&&Re(A.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0}),n&&e.jsx("div",{className:`chat-container ${m==="floating"?"floating-chat":"split-chat"} ${I?"knowledge-notes-open":""}`,children:e.jsx(rs,{selectedText:f,pdfText:k,onToggleLayout:Ve,layout:m,currentPageNumber:x,onCreateKnowledgeNote:Fe,onClearSelectedText:()=>u(""),onOpenKnowledgeNotes:()=>{I||L(!0)},onAddAnnotationToPDF:(A,W,Z)=>{if(window.__addPDFAnnotation){const ie=Z!==void 0?Z:.5,Te={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:W,x:Math.max(0,Math.min(1-.3,.4-.15)),y:Math.max(0,Math.min(1-.2,ie-.1)),width:.3,height:.2,rotation:0,text:A,fontSize:14,color:ws[0]};window.__addPDFAnnotation(Te)}}})})]}),ne&&e.jsxs("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.7)",zIndex:9999,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:"white"},children:[e.jsx("div",{className:"loading-spinner",style:{width:"40px",height:"40px",border:"4px solid rgba(255, 255, 255, 0.3)",borderTop:"4px solid white",borderRadius:"50%",animation:"spin 1s linear infinite",marginBottom:"16px"}}),e.jsx("style",{children:`
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `}),e.jsx("h3",{children:"Uploading PDF..."}),e.jsx("p",{children:"This may take a moment for large files"})]}),e.jsx(vs,{isOpen:xe,onConfirm:Ue,onCancel:gt}),le&&e.jsx(ks,{message:le,type:"info",duration:3e3,onClose:()=>Ee(null)})]})}function Cs(){return e.jsx($n,{children:e.jsx(On,{children:e.jsx(Hn,{children:e.jsx(js,{})})})})}const Bt=document.getElementById("root");if(!Bt)throw new Error("Root element not found");try{En.createRoot(Bt).render(e.jsx(An.StrictMode,{children:e.jsx(Cs,{})}))}catch(t){Bt.innerHTML=`
    <div style="padding: 20px; color: red;">
      <h1>Error Loading App</h1>
      <p>${t instanceof Error?t.message:String(t)}</p>
      <p>Check the browser console for more details.</p>
    </div>
  `}export{ws as C,ut as _};
