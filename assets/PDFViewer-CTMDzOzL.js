const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-CLrFw-IM.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r,j as t,a as ae,D as le,P as ce}from"./vendor-react-BWK-dEaB.js";import{_ as Ot,C as Ut}from"./index-BOkabY67.js";import{G as Ft}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-CLrFw-IM.js";const de=({pageNumber:g,pageWidth:S,pageHeight:F,scale:b,annotations:P,selectedAnnotationId:a,onAnnotationUpdate:d,onAnnotationDelete:x,onAnnotationSelect:R,mode:G})=>{const j=r.useRef(null),[O,nt]=r.useState(!1),[y,U]=r.useState(!1),[w,ht]=r.useState(!1),[D,it]=r.useState({x:0,y:0}),[v,c]=r.useState(null),[h,_]=r.useState(null),[at,lt]=r.useState({x:0,y:0,angle:0}),[A,Y]=r.useState(null),rt=P.filter(n=>n.pageNumber===g),Z=n=>n*S*b,k=n=>n*F*b,V=n=>n*S*b,gt=n=>n*F*b,mt=n=>n/(S*b),xt=n=>n/(F*b),X=r.useCallback((n,u,C,p)=>{const s=1-C,M=1-p;return{x:Math.max(0,Math.min(s,n)),y:Math.max(0,Math.min(M,u)),width:Math.max(.01,Math.min(1,C)),height:Math.max(.01,Math.min(1,p))}},[]),ot=r.useCallback((n,u,C,p)=>{const s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${C}px`,s.style.fontSize=`${u*p}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*p}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=n||"Text",document.body.appendChild(s);const M=s.scrollHeight;return document.body.removeChild(s),M},[]),J=r.useCallback((n,u)=>{n.stopPropagation();const C=n.target;if(C.classList.contains("resize-handle")){n.preventDefault(),U(!0),c(C.dataset.handle||null);const s=j.current?.getBoundingClientRect();s&&(it({x:n.clientX-s.left,y:n.clientY-s.top}),_({x:n.clientX-s.left,y:n.clientY-s.top,width:u.width,height:u.height,annotationX:u.x,annotationY:u.y}));return}if(C.classList.contains("rotate-handle")){n.preventDefault(),ht(!0);const s=j.current?.getBoundingClientRect();if(s){const M=Z(u.x+u.width/2),m=k(u.y+u.height/2),z=n.clientX-s.left,L=n.clientY-s.top,st=Math.atan2(L-m,z-M)*(180/Math.PI);lt({x:z,y:L,angle:u.rotation-st})}return}if(C.classList.contains("delete-button")){n.preventDefault(),x(u.id);return}n.preventDefault(),R(u.id),nt(!0);const p=j.current?.getBoundingClientRect();p&&it({x:n.clientX-p.left-Z(u.x),y:n.clientY-p.top-k(u.y)})},[G,Z,k,R,x]);r.useEffect(()=>{if(!O&&!y&&!w)return;const n=C=>{const p=j.current?.getBoundingClientRect();if(!p)return;const s=rt.find(M=>M.id===a);if(s){if(w){const M=Z(s.x+s.width/2),m=k(s.y+s.height/2),z=C.clientX-p.left,L=C.clientY-p.top,st=Math.atan2(L-m,z-M)*(180/Math.PI),Q=(at.angle+st)%360;d({...s,rotation:Q})}else if(y&&v&&h){const M=C.clientX-p.left,m=C.clientY-p.top,z=M-h.x,L=m-h.y,st=.5,Q=z/(S*b)*st,dt=L/(F*b)*st;let wt=h.annotationX,Nt=h.annotationY,Mt=h.width,zt=h.height;v.includes("n")&&(Nt=Math.max(0,h.annotationY+dt),zt=Math.max(.01,h.height-dt)),v.includes("s")&&(zt=Math.max(.01,h.height+dt)),v.includes("w")&&(wt=Math.max(0,h.annotationX+Q),Mt=Math.max(.01,h.width-Q)),v.includes("e")&&(Mt=Math.max(.01,h.width+Q));const jt=X(wt,Nt,Mt,zt);if(s.type==="textbox"){const Ct=s,Tt=V(jt.width),Dt=ot(Ct.text,Ct.fontSize,Tt,b)/(F*b);if(Math.abs(Dt-jt.height)>.001){const Et=Math.max(.01,Math.min(1,Dt)),Lt=X(wt,Nt,jt.width,Et);d({...s,...Lt})}else d({...s,...jt})}else d({...s,...jt})}else if(O){const M=mt(C.clientX-p.left-D.x),m=xt(C.clientY-p.top-D.y),z=X(M,m,s.width,s.height);d({...s,...z})}}},u=()=>{if(y&&a){const C=rt.find(p=>p.id===a);if(C&&C.type==="textbox"){const p=C,s=V(p.width),m=ot(p.text,p.fontSize,s,b)/(F*b),z=X(p.x,p.y,p.width,m);Math.abs(z.height-p.height)>.001&&d({...p,...z})}}nt(!1),U(!1),ht(!1),c(null),_(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",u),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",u)}},[O,y,w,v,h,D,at,a,rt,Z,k,V,gt,mt,xt,X,ot,d,S,F,b]),r.useEffect(()=>{const n=u=>{(u.key==="Delete"||u.key==="Backspace")&&a&&u.target.tagName!=="INPUT"&&u.target.tagName!=="TEXTAREA"&&(u.preventDefault(),x(a))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[a,x]);const yt=n=>{const u=n.id===a,C=Z(n.x),p=k(n.y),s=V(n.width),M=gt(n.height);return t.jsxs("div",{className:`annotation textbox-annotation ${u?"selected":""}`,style:{left:`${C}px`,top:`${p}px`,width:`${s}px`,height:`${M}px`,padding:`${4*b}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:m=>J(m,n),children:[u&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:m=>{m.stopPropagation(),x(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),A===n.id?t.jsx("textarea",{className:"textbox-input",value:n.text,onChange:m=>{d({...n,text:m.target.value})},onBlur:m=>{const z=m.relatedTarget;z&&(z.closest(".textbox-controls")!==null||z.closest(".textbox-font-size-input")!==null||z.classList.contains("textbox-font-size-input"))||(Y(null),R(null))},onKeyDown:m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),Y(null),R(null)),m.key==="Escape"&&(Y(null),R(null))},style:{fontSize:`${n.fontSize*b}px`,color:n.color,width:`${s}px`,maxWidth:`${s}px`,height:`${M}px`,maxHeight:`${M}px`},autoFocus:!0}):t.jsx("div",{className:"textbox-content",onClick:m=>{m.stopPropagation();const z=m.target;z.closest(".textbox-controls")!==null||z.closest(".textbox-font-size-input")!==null||z.closest(".textbox-color-button")!==null||z.closest(".textbox-color-picker")!==null||Y(n.id)},style:{fontSize:`${n.fontSize*b}px`,color:n.color},children:n.text||"Text"})]},n.id)},ct=n=>{const u=n.id===a,C=Z(n.x),p=k(n.y),s=V(n.width),M=gt(n.height),m=n.width*S,z=n.height*F,L=n.imageWidth/n.imageHeight,st=m/z;let Q,dt;return L>st?(Q=s,dt=s/L):(dt=M,Q=M*L),t.jsxs("div",{className:`annotation image-annotation ${u?"selected":""}`,style:{left:`${C}px`,top:`${p}px`,width:`${Q}px`,height:`${dt}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:wt=>J(wt,n),children:[u&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:wt=>{wt.stopPropagation(),x(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),t.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},vt=n=>{const u=n.id===a,C=Z(n.x),p=k(n.y),s=V(n.width),M=gt(n.height);return t.jsx("div",{className:`annotation highlight-annotation ${u?"selected":""}`,style:{left:`${C}px`,top:`${p}px`,width:`${s}px`,height:`${M}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:m=>J(m,n),children:u&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:m=>{m.stopPropagation(),x(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]})},n.id)},ut=S*b,kt=F*b,$={width:`${ut}px`,height:`${kt}px`,pointerEvents:"none"};return t.jsx("div",{ref:j,className:"annotation-layer",style:$,children:rt.map(n=>n.type==="textbox"?yt(n):n.type==="image"?ct(n):n.type==="highlight"?vt(n):null)})},he=({mode:g,onModeChange:S,highlightColor:F="#ffeb3b",onHighlightColorChange:b,onHighlightClick:P,hasTextSelection:a=!1,isHighlightActive:d=!1,showColorPicker:x=!1,onImageUpload:R,onDownload:G,onNewSession:j,onClearAll:O})=>{const nt=r.useRef(null),[y,U]=r.useState(!1),w=r.useRef(null),ht=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];ae.useEffect(()=>{const v=c=>{y&&(c.target.closest(".clear-button")||(U(!1),w.current&&(clearTimeout(w.current),w.current=null)))};if(y)return document.addEventListener("click",v),()=>{document.removeEventListener("click",v)}},[y]);const D=v=>{const c=v.target.files?.[0];c&&c.type.startsWith("image/")&&R(c),S(null),nt.current&&(nt.current.value="")},it=v=>{v.stopPropagation(),y?(O&&O(),U(!1),w.current&&(clearTimeout(w.current),w.current=null)):(U(!0),w.current=setTimeout(()=>{U(!1),w.current=null},3e3))};return t.jsxs("div",{className:"annotation-toolbar",children:[t.jsxs("div",{className:"toolbar-section",children:[t.jsx("button",{className:`toolbar-button ${d?"active":""}`,onClick:P,disabled:!a,title:a?d?"Remove highlight":"Highlight text":"Select text to highlight",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),t.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),t.jsxs("button",{className:`toolbar-button ${g==="textbox"?"active":""}`,onClick:()=>S("textbox"),title:"Add text box (click on PDF to add)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M4 20h16"}),t.jsx("path",{d:"M6 4v16"}),t.jsx("path",{d:"M18 4v16"}),t.jsx("path",{d:"M4 7h16"}),t.jsx("path",{d:"M4 10h16"}),t.jsx("path",{d:"M4 13h16"}),t.jsx("path",{d:"M4 16h16"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Text"})]}),t.jsxs("button",{className:`toolbar-button ${g==="image"?"active":""}`,onClick:()=>{S("image"),nt.current?.click()},title:"Add image (click to upload)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),t.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t.jsx("polyline",{points:"21 15 16 10 5 21"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Image"})]}),O&&t.jsxs("button",{className:`toolbar-button clear-button ${y?"confirming":""}`,onClick:it,title:y?"Click again to clear all annotations":"Clear all annotations",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"3 6 5 6 21 6"}),t.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Clear All"})]}),t.jsx("input",{ref:nt,type:"file",accept:"image/*",onChange:D,style:{display:"none"}})]}),x&&b&&t.jsx("div",{className:"toolbar-section color-picker",children:ht.map(v=>t.jsx("button",{className:`color-button ${F===v?"active":""}`,style:{backgroundColor:v},onClick:()=>b(v),title:"Select highlight color"},v))}),t.jsxs("div",{className:"toolbar-section toolbar-actions",children:[j&&t.jsxs("button",{className:"toolbar-button new-session-button",onClick:j,title:"Start new session (save current and upload new PDF)",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),t.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),t.jsx("span",{className:"toolbar-button-text",children:"New Session"})]}),t.jsxs("button",{className:"toolbar-button download-button",onClick:G,title:"Download annotated PDF",children:[t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),t.jsx("polyline",{points:"7 10 12 15 17 10"}),t.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),t.jsx("span",{className:"toolbar-button-text",children:"Download"})]})]})]})},ue=({pageNumber:g,pageWidth:S,pageHeight:F,scale:b,knowledgeNotes:P,showKnowledgeNotes:a,onNoteClick:d})=>{const x=P.filter(j=>j.pageNumber===g);if(!a||x.length===0)return null;const R=S*b,G=F*b;return t.jsx("div",{className:"knowledge-note-connections",style:{width:`${R}px`,height:`${G}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:t.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:x.map((j,O)=>{const nt=R-25,y=25+O*35;return t.jsxs("g",{children:[t.jsx("circle",{cx:nt,cy:y,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:U=>{U.stopPropagation(),d?.(j)},style:{cursor:"pointer",pointerEvents:"all"}}),t.jsx("text",{x:nt,y,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:O+1}),t.jsx("line",{x1:nt,y1:y+12,x2:nt,y2:y+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},j.id)})})})};let Ht,St=null,It=!1;async function ge(){if(!Ht)try{Ht=await Ot(()=>import("./vendor-CLrFw-IM.js").then(g=>g.o),__vite__mapDeps([0,1]))}catch(g){throw console.error("Failed to load pdf-lib:",g),new Error("PDF library not available. Please install pdf-lib.")}return Ht}async function fe(){if(!It){It=!0;try{const g=await Ot(()=>import("./vendor-CLrFw-IM.js").then(S=>S.p),__vite__mapDeps([0,1]));return g.default?St=g.default:St=g,St&&typeof St.create=="function"?St:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(g){return console.warn("Failed to load fontkit, falling back to standard fonts:",g),null}}return St}async function pe(){try{const g=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],S="/ChatNote/",b=`${S.endsWith("/")?S:`${S}/`}NotoSans-Regular.ttf`;try{const P=await fetch(b);if(P.ok){const a=await P.arrayBuffer();if(a.byteLength>1e3){const d=new Uint8Array(a);if(d.length>=4&&d[0]===0&&d[1]===1&&d[2]===0&&d[3]===0)return a}}}catch{}for(const P of g)if(!P.includes("fonts.googleapis.com/css"))try{const a=await fetch(P,{mode:"cors",cache:"default"});if(a.ok){const d=await a.arrayBuffer();if(d.byteLength>1e3){const x=new Uint8Array(d),R=x.length>=4&&x[0]===0&&x[1]===1&&x[2]===0&&x[3]===0,G=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===70,j=x.length>=4&&x[0]===119&&x[1]===79&&x[2]===70&&x[3]===50;if(R||G||j)return d;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(g){return console.warn("Failed to load Unicode font:",g),null}}async function me(g,S,F){try{const b=await ge(),{PDFDocument:P,rgb:a,degrees:d,StandardFonts:x}=b;if(!x)throw new Error("StandardFonts not available from pdf-lib");const R=await g.arrayBuffer(),G=await P.load(R);let j=null;try{const y=await fe();if(y){try{G.registerFontkit(y)}catch(w){(!w.message||!w.message.includes("already registered"))&&console.warn("Failed to register fontkit:",w)}const U=await pe();if(U){const w=new Uint8Array(U),ht=w.length>=4&&w[0]===0&&w[1]===1&&w[2]===0&&w[3]===0,D=w.length>=4&&w[0]===79&&w[1]===84&&w[2]===84&&w[3]===79,it=w.length>=4&&w[0]===116&&w[1]===116&&w[2]===99&&w[3]===102,v=w.length>=4&&w[0]===119&&w[1]===79&&w[2]===70&&w[3]===70,c=w.length>=4&&w[0]===119&&w[1]===79&&w[2]===70&&w[3]===50;v||c?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):ht||D||it?j=await G.embedFont(U):console.warn(`Invalid font format. File size: ${w.length} bytes`)}}}catch(y){console.warn("Failed to embed Unicode font, falling back to standard font:",y)}if(!j){const y=x.Helvetica||x.TimesRoman;if(!y)throw new Error("No standard font available");j=await G.embedFont(y),console.log("Using standard font (limited Unicode support)")}if(!j)throw new Error("Failed to embed font");const O=G.getPages();for(const y of S){const U=O[y.pageNumber-1];if(!U)continue;const w=F.get(y.pageNumber);if(!w)continue;const{width:ht,height:D}=w;let it=y.width*ht,v=y.height*D;if(y.type==="textbox"){const c=y,h=xe(c.color)||{r:0,g:0,b:0},_=y.x*ht,at=y.y*D;let lt=(y.y+y.height)*D;const A=4,Y=it-A*2,rt=(c.text||"").trimEnd();let k=rt.split(/\r\n|\r|\n/).filter($=>$!=null);for(;k.length>0&&k[k.length-1].length===0;)k.pop();if(k.length===0&&(k=[""]),k.length===1&&j&&typeof j.widthOfTextAtSize=="function"){const $=k[0],n=Y;let u;try{u=j.widthOfTextAtSize($,c.fontSize)}catch{u=$.length*c.fontSize*.5}if(u>n){const C=[],p=$.split(/(\s+)/);let s="";for(let M=0;M<p.length;M++){const m=p[M],z=s+m;let L;try{L=j.widthOfTextAtSize(z,c.fontSize)}catch{L=z.length*c.fontSize*.5}L<=n||s===""?s=z:(s.trim()&&C.push(s.trim()),s=m)}s.trim()&&C.push(s.trim()),C.length>1&&(k=C)}}const V=c.fontSize*1.2;v=k.length>0?(k.length-1)*V+c.fontSize+A*2:c.fontSize+A*2,lt=at+v;const xt=D-lt,ot=D-at-xt,yt=xt+ot/2,ct=c.fontSize*.2,vt=D-c.fontSize*.2,ut=Math.max(ct,Math.min(vt,yt));if((k.length>1||rt.includes(`
`)||rt.includes("\r"))&&k.length>0)try{const $=(k.length-1)*V,n=ut+$/2;k.forEach((u,C)=>{const p=n-C*V;let s;try{j&&typeof j.widthOfTextAtSize=="function"?s=j.widthOfTextAtSize(u,c.fontSize):s=u.length*c.fontSize*.5}catch{s=u.length*c.fontSize*.5}let m=_+A+Y/2-s/2;const z=_+A,L=_+it-s-A;m=Math.max(z,Math.min(L,m));const st=u.length>0?u:" ";U.drawText(st,{x:m,y:p,size:c.fontSize,color:a(h.r/255,h.g/255,h.b/255),rotate:d(c.rotation),font:j})})}catch($){if($.message&&$.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",$.message);const n=k.map(p=>p.split("").map(s=>s.charCodeAt(0)>255?"?":s).join("")),u=(n.length-1)*V,C=ut+u/2;try{n.forEach((p,s)=>{const M=C-s*V;let m;try{j&&typeof j.widthOfTextAtSize=="function"?m=j.widthOfTextAtSize(p,c.fontSize):m=p.length*c.fontSize*.5}catch{m=p.length*c.fontSize*.5}let L=_+A+Y/2-m/2;const st=_+A,Q=_+it-m-A;L=Math.max(st,Math.min(Q,L)),U.drawText(p,{x:L,y:M,size:c.fontSize,color:a(h.r/255,h.g/255,h.b/255),rotate:d(c.rotation),font:j})}),console.log("Drew text with Unicode characters replaced")}catch(p){console.error("Failed to draw text even after replacing Unicode characters:",p);continue}}else throw $}else{let $;try{j&&typeof j.widthOfTextAtSize=="function"?$=j.widthOfTextAtSize(c.text,c.fontSize):$=c.text.length*c.fontSize*.5}catch{$=c.text.length*c.fontSize*.5}let u=_+A+Y/2-$/2;const C=_+A,p=_+it-$-A;u=Math.max(C,Math.min(p,u));try{U.drawText(c.text,{x:u,y:ut,size:c.fontSize,color:a(h.r/255,h.g/255,h.b/255),rotate:d(c.rotation),font:j})}catch(s){if(s.message&&s.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",s.message);const M=c.text.split("").map(m=>m.charCodeAt(0)>255?"?":m).join("");try{U.drawText(M,{x:u,y:ut,size:c.fontSize,color:a(h.r/255,h.g/255,h.b/255),rotate:d(c.rotation),font:j}),console.log("Drew text with Unicode characters replaced")}catch(m){console.error("Failed to draw text even after replacing Unicode characters:",m);continue}}else throw s}}}else if(y.type==="image"){const c=y,h=await fetch(c.imageData).then(mt=>mt.arrayBuffer());let _;if(c.imageData.startsWith("data:image/png"))_=await G.embedPng(h);else if(c.imageData.startsWith("data:image/jpeg")||c.imageData.startsWith("data:image/jpg"))_=await G.embedJpg(h);else throw console.error("Unsupported image format for PDF embedding:",c.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const at=c.imageWidth/c.imageHeight;let lt=it,A=v;it/v>at?lt=v*at:A=it/at;const rt=y.x*ht,Z=(y.y+y.height)*D,gt=D-Z+(v-A)/2;U.drawImage(_,{x:rt,y:gt,width:lt,height:A,rotate:d(c.rotation)})}}const nt=await G.save();return new Blob([nt],{type:"application/pdf"})}catch(b){throw console.error("Error saving annotated PDF:",b),new Error("Failed to save annotated PDF")}}function xe(g){const S=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(g);return S?{r:parseInt(S[1],16),g:parseInt(S[2],16),b:parseInt(S[3],16)}:null}function we(g,S="annotated.pdf"){const F=URL.createObjectURL(g),b=document.createElement("a");b.href=F,b.download=S,document.body.appendChild(b),b.click(),document.body.removeChild(b),URL.revokeObjectURL(F)}const be=({selectedAnnotation:g,onUpdate:S})=>{const[F,b]=r.useState(g.fontSize.toString()),P=r.useRef(g.fontSize);return r.useEffect(()=>{P.current=g.fontSize,b(g.fontSize.toString())},[g.id,g.fontSize]),t.jsxs("div",{className:"textbox-controls",onClick:a=>{a.target.closest('input[type="number"]')||a.stopPropagation()},onMouseDown:a=>{a.target.closest('input[type="number"]')||a.stopPropagation()},children:[t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Font Size:"}),t.jsxs("div",{className:"font-size-input-wrapper",children:[t.jsx("button",{type:"button",className:"font-size-arrow-button font-size-arrow-left",onClick:a=>{a.stopPropagation(),a.preventDefault();const d=parseInt(F,10)||P.current,x=Math.max(1,d-1);b(x.toString());const R={...g,fontSize:x};S(R),P.current=x},onMouseDown:a=>{a.stopPropagation(),a.preventDefault()},title:"Decrease font size",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"15 18 9 12 15 6"})})}),t.jsx("input",{type:"number",min:"1",max:"200",value:F,onChange:a=>{const d=a.target.value;if(b(d),d===""||d==="-")return;const x=parseInt(d,10);if(!isNaN(x)&&x>0){const R=Math.max(1,Math.min(200,x)),G={...g,fontSize:R};S(G),P.current=R}},onBlur:a=>{const d=a.target.value.trim();if(d===""||d==="-"||isNaN(parseInt(d,10))||parseInt(d,10)<=0)b(P.current.toString());else{const x=parseInt(d,10),R=Math.max(1,Math.min(200,x));R!==x&&b(R.toString()),P.current=R}},onMouseDown:a=>{a.stopPropagation()},onClick:a=>{a.stopPropagation()},onFocus:a=>{a.stopPropagation()},onWheel:a=>{a.stopPropagation()},className:"textbox-font-size-input"}),t.jsx("button",{type:"button",className:"font-size-arrow-button font-size-arrow-right",onClick:a=>{a.stopPropagation(),a.preventDefault();const d=parseInt(F,10)||P.current,x=Math.min(200,d+1);b(x.toString());const R={...g,fontSize:x};S(R),P.current=x},onMouseDown:a=>{a.stopPropagation(),a.preventDefault()},title:"Increase font size",children:t.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:t.jsx("polyline",{points:"9 18 15 12 9 6"})})})]})]}),t.jsxs("div",{className:"textbox-control-group",children:[t.jsx("label",{className:"textbox-control-label",children:"Color:"}),t.jsx("div",{className:"textbox-color-picker",children:Ut.map(a=>t.jsx("button",{className:`textbox-color-button ${g.color===a?"active":""}`,style:{backgroundColor:a},onClick:d=>{d.stopPropagation(),d.preventDefault(),S({...g,color:a})},onMouseDown:d=>{d.stopPropagation(),d.preventDefault()},onFocus:d=>{d.stopPropagation()},title:a},a))})]})]})};function Ce({file:g,onFileUpload:S,onTextSelection:F,layout:b="floating",onPageChange:P,showKnowledgeNotes:a=!0,onToggleKnowledgeNotes:d,knowledgeNotes:x=[],onScrollToPage:R,onNoteClick:G,onAddAnnotation:j,initialAnnotations:O=[],onAnnotationsChange:nt,isLoadingPdf:y=!1,onLoadingComplete:U,isSavingSession:w=!1,onNewSession:ht}){const[D,it]=r.useState(0),[v,c]=r.useState(1),[h,_]=r.useState(1),[at,lt]=r.useState(!1),[A,Y]=r.useState("100"),rt=r.useRef(null),Z=r.useRef(new Map),k=r.useRef(null),V=r.useRef(null),gt=r.useRef(null),mt=r.useRef(null),xt=r.useRef(!1),X=r.useRef(new Map),[ot,J]=r.useState(O),[yt,ct]=r.useState(null),[vt,ut]=r.useState(null),[kt,$]=r.useState(null),[n,u]=r.useState(null),[C,p]=r.useState(!1),[s,M]=r.useState("#ffeb3b"),[m,z]=r.useState(!1),L=r.useRef(O),st=r.useRef(nt);r.useEffect(()=>{st.current=nt},[nt]),r.useEffect(()=>{const e=L.current,o=O.length!==e.length||O.some((i,f)=>i.id!==e[f]?.id);O&&O.length>0&&o?(J(O),L.current=O):g&&O.length===0&&e.length>0?(J([]),L.current=[],ct(null)):!g&&e.length>0&&(J([]),L.current=[],ct(null))},[O,g]),r.useEffect(()=>{JSON.stringify(L.current)!==JSON.stringify(ot)&&st.current&&(L.current=ot,st.current(ot))},[ot]),r.useEffect(()=>{const e=console.warn,o=console.error;return console.warn=(...i)=>{const f=i.join(" ");f.includes("TextLayer task cancelled")||f.includes("AbortException")||i.some(l=>typeof l=="string"&&(l.includes("TextLayer task cancelled")||l.includes("AbortException")))||e.apply(console,i)},console.error=(...i)=>{const f=i.join(" ");f.includes("TextLayer task cancelled")||f.includes("AbortException")&&f.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=e,console.error=o}},[]);const Q=r.useMemo(()=>g?URL.createObjectURL(g):null,[g]),dt=r.useRef(null);r.useEffect(()=>(dt.current&&dt.current!==Q&&URL.revokeObjectURL(dt.current),dt.current=Q,()=>{Q&&URL.revokeObjectURL(Q)}),[Q]);const wt=r.useMemo(()=>{let e;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";e=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Ft&&(Ft.workerSrc=e,Ft.standardFontDataUrl=o),{workerSrc:e,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),Nt=({numPages:e})=>{it(e);const o=1;c(o),setTimeout(()=>{P?.(o)},0),Z.current.clear(),X.current.clear(),U&&setTimeout(()=>{U()},300)},Mt=e=>{if(!X.current.has(e.pageNumber))try{const o=e.page;let i,f;o.viewport?(i=o.viewport.width,f=o.viewport.height):(i=o.width/h,f=o.height/h),X.current.set(e.pageNumber,{width:i,height:f})}catch(o){console.warn("Error getting page dimensions:",o);const i=e.page,f=i.width/h,l=i.height/h;X.current.set(e.pageNumber,{width:f,height:l})}};r.useEffect(()=>{if(!k.current||D===0)return;let e=null,o=!1;const i=()=>{if(xt.current||o||e)return;o=!0,e=setTimeout(()=>{e=null,o=!1},100);const l=k.current;if(!l){o=!1;return}const N=l.getBoundingClientRect(),I=N.top,T=N.height,B=I+T/2;if(l.scrollTop<100){c(H=>H!==1?(setTimeout(()=>{P?.(1)},0),1):H);return}let tt=1,W=0;for(let H=1;H<=D;H++){const E=Z.current.get(H);if(E){const et=E.getBoundingClientRect(),K=l.getBoundingClientRect(),pt=Math.max(K.top,et.top),ft=Math.min(K.bottom,et.bottom),bt=Math.max(0,ft-pt);bt>W&&(W=bt,tt=H)}}if(W<T*.1){let H=1,E=1/0;for(let et=1;et<=D;et++){const K=Z.current.get(et);if(K){const pt=K.getBoundingClientRect(),ft=pt.top+pt.height/2,bt=Math.abs(ft-B);bt<E&&(E=bt,H=et)}}tt=H}c(H=>tt!==H?(setTimeout(()=>{P?.(tt)},0),tt):H)},f=k.current;return f?.addEventListener("scroll",i,{passive:!0}),()=>{e&&clearTimeout(e),f?.removeEventListener("scroll",i)}},[D,P]);const zt=e=>{console.error("PDF load error:",e)},jt=e=>{const o=e.target.files?.[0];o&&o.type==="application/pdf"&&S(o)},Ct=r.useCallback(e=>{const o=Z.current.get(e);o&&k.current&&(xt.current=!0,c(e),P?.(e),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{xt.current=!1},1500))},[P]);r.useEffect(()=>(R&&(window.__pdfScrollToPage=Ct),k.current&&(window.__pdfContentRef=k.current),V.current&&(window.__pdfViewerHeight=V.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Ct,R,D,h]);const Tt=()=>{const e=Math.max(1,v-1);Ct(e)},Bt=()=>{const e=Math.min(D,v+1);Ct(e)},Dt=()=>{const e=Math.min(h+.2,5);_(e),Y(Math.round(e*100).toString())},Et=()=>{const e=Math.max(h-.2,.25);_(e),Y(Math.round(e*100).toString())};r.useEffect(()=>{at||Y(Math.round(h*100).toString())},[h,at]);const Lt=()=>{lt(!0),Y(Math.round(h*100).toString())},_t=e=>{let o=e.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),Y(o)},At=()=>{Yt()},Vt=e=>{if(e.key==="Enter")e.preventDefault(),Yt();else if(e.key==="Escape")lt(!1),Y(Math.round(h*100).toString()),rt.current?.blur();else{if(e.key==="Backspace"||e.key==="Delete"||e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Tab")return;(e.key==="-"||e.key==="+"||e.key==="."||e.key===","||e.key==="e"||e.key==="E"||!/[0-9]/.test(e.key)&&!e.ctrlKey&&!e.metaKey)&&e.preventDefault()}},Zt=e=>{e.preventDefault();const i=e.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const l=(i.replace(/^0+/,"")||"0").slice(0,3);if(Y(l),l&&l!=="0"){const N=parseInt(l,10);if(!isNaN(N)&&N>0){const I=Math.max(25,Math.min(500,N)),T=I/100;_(T),Y(I.toString()),lt(!1)}}}},Yt=()=>{if(A.trim()===""||A==="0"){Y(Math.round(h*100).toString()),lt(!1);return}const e=parseInt(A,10);if(isNaN(e)||e<=0){Y(Math.round(h*100).toString()),lt(!1);return}const o=Math.max(25,Math.min(500,e)),i=o/100;_(i),Y(o.toString()),lt(!1)};r.useEffect(()=>{at&&rt.current&&(rt.current.focus(),rt.current.select())},[at]);const qt=()=>{if(!V.current||X.current.size===0)return;const e=V.current.getBoundingClientRect();let o;o=e.width-40;const i=X.current.get(1);if(!i)return;const f=o/i.width,l=Math.max(.1,Math.min(f,5));_(l),Y(Math.round(l*100).toString())},Kt=()=>{if(!V.current||X.current.size===0)return;const e=V.current.getBoundingClientRect();let o=0,i=0;gt.current&&(o=gt.current.getBoundingClientRect().height),mt.current&&(i=mt.current.getBoundingClientRect().height);let f=0;const l=V.current.querySelector(".annotation-toolbar");l&&(f=l.getBoundingClientRect().height);const N=e.height-o-i-f,I=X.current.get(v);if(!I)return;const T=N/I.height,B=Math.max(.1,Math.min(T,5));_(B),Y(Math.round(B*100).toString())},Xt=r.useCallback(()=>{const e=window.getSelection();if(e&&e.toString().trim()){const o=e.toString().trim();let i,f;if(e.rangeCount>0&&k.current){const N=e.getRangeAt(0).getBoundingClientRect(),I=k.current.getBoundingClientRect(),T=N.top-I.top+k.current.scrollTop;for(let B=1;B<=D;B++){const q=Z.current.get(B);if(q){const tt=q.offsetTop,W=q.offsetHeight,H=tt+W;if(T>=tt&&T<=H){f=B;const E=(T-tt)/W;i=Math.max(0,Math.min(1,E)),$({text:o,pageNumber:B,rect:N,pageElement:q});const et=ot.find(K=>K.type==="highlight"&&K.pageNumber===B&&Math.abs(K.x-Math.max(0,Math.min(1,(N.left-q.getBoundingClientRect().left)/q.offsetWidth)))<.01&&Math.abs(K.y-Math.max(0,Math.min(1,E)))<.01);u(et?.id||null);break}}}}F(o,f,i)}else F("",void 0,void 0),$(null),u(null),p(!1)},[F,D,ot]),Gt=r.useCallback(e=>{const o=e.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker"))return;const f=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const l=window.getSelection(),N=l&&l.toString().trim().length>0;if(N||F(""),!f&&!N&&ct(null),vt==="textbox"&&!f&&!N){const I=k.current;if(!I)return;let T=v,B=.5,q=.5;for(let W=1;W<=D;W++){const H=Z.current.get(W);if(H){const E=H.getBoundingClientRect();if(I.getBoundingClientRect()){const K=e.clientX-E.left,pt=e.clientY-E.top;if(K>=0&&K<=E.width&&pt>=0&&pt<=E.height){T=W;const ft=X.current.get(W);if(ft){const bt=E.width/ft.width,re=E.height/ft.height;B=K/(ft.width*bt),q=pt/(ft.height*re)}break}}}}if(X.current.get(T)){const W=Math.max(0,Math.min(.8,B-.1)),H=Math.max(0,Math.min(1-.1,q-.05)),E={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:T,x:W,y:H,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:Ut[0]};J(et=>[...et,E]),ct(E.id),ut("select")}}},100)},[F,vt,v,D,h,ct,ut,J]),Rt=r.useCallback(e=>{J(o=>[...o,e]),ct(e.id)},[]);r.useEffect(()=>(j&&(window.__addPDFAnnotation=e=>{J(o=>[...o,e]),ct(e.id),e.pageNumber&&R&&R(e.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[j,R]);const Pt=r.useCallback((e,o,i)=>{const f=e.width*o.width*i,l=document.createElement("div");l.style.position="absolute",l.style.visibility="hidden",l.style.width=`${f}px`,l.style.fontSize=`${e.fontSize*i}px`,l.style.fontFamily="inherit",l.style.whiteSpace="pre-wrap",l.style.wordWrap="break-word",l.style.overflowWrap="break-word",l.style.padding=`${4*i}px`,l.style.boxSizing="border-box",l.style.lineHeight="1.2",l.textContent=e.text||"Text",document.body.appendChild(l);const N=l.scrollHeight;document.body.removeChild(l);const I=N/(o.height*i);return Math.max(.01,Math.min(1,I))},[]),$t=r.useCallback(e=>{J(o=>{const i=o.map(f=>f.id===e.id?e:f);if(e.type==="textbox"){const f=e,l=X.current.get(f.pageNumber);if(l){const N=Pt(f,l,h);return i.map(I=>I.id===e.id?{...f,height:N}:I)}}return i})},[h,Pt]);r.useEffect(()=>{J(e=>e.map(o=>{if(o.type==="textbox"){const i=o,f=X.current.get(i.pageNumber);if(f){const l=Pt(i,f,h);return{...i,height:l}}}return o}))},[h,Pt]);const Jt=r.useCallback(e=>{J(o=>o.filter(i=>i.id!==e)),yt===e&&ct(null)},[yt]),Qt=r.useCallback(async e=>{if(!g||!X.current.get(v))return;const i=new FileReader;i.onload=f=>{const l=f.target?.result,N=new Image;N.onload=()=>{const I=!l.startsWith("data:image/png")&&!l.startsWith("data:image/jpeg")&&!l.startsWith("data:image/jpg");let T=l;if(I){const et=document.createElement("canvas");et.width=N.width,et.height=N.height;const K=et.getContext("2d");K&&(K.drawImage(N,0,0),T=et.toDataURL("image/png"))}const B=.2,q=N.width/N.height,tt=B/q,E={id:`image-${Date.now()}`,type:"image",pageNumber:v,x:.4,y:.4,width:B,height:tt,rotation:0,imageData:T,imageWidth:N.width,imageHeight:N.height};Rt(E),ut("select")},N.src=l},i.readAsDataURL(e)},[g,v,Rt,ut]),te=r.useCallback(()=>{if(!kt)return;const{pageNumber:e,rect:o,pageElement:i}=kt;if(n)J(f=>f.filter(l=>l.id!==n)),u(null),p(!1);else{const f=i.offsetWidth,l=i.offsetHeight,N=i.getBoundingClientRect(),I=(o.left-N.left)/f,T=(o.top-N.top)/l,B=o.width/f,q=o.height/l,tt={id:crypto.randomUUID(),type:"highlight",pageNumber:e,x:Math.max(0,Math.min(1,I)),y:Math.max(0,Math.min(1,T)),width:Math.max(.01,Math.min(1,B)),height:Math.max(.01,Math.min(1,q)),rotation:0,color:s,opacity:.4};J(W=>[...W,tt]),u(tt.id),p(!0)}},[kt,n,s]),ee=r.useCallback(e=>{M(e),n&&J(o=>o.map(i=>i.id===n&&i.type==="highlight"?{...i,color:e}:i))},[n]),ne=r.useCallback(async()=>{if(!g||ot.length===0){alert("No annotations to save");return}try{const e=await me(g,ot,X.current),o=g.name.replace(".pdf","_annotated.pdf");we(e,o)}catch(e){console.error("Error saving PDF:",e),alert("Failed to save annotated PDF. Please check the console for details.")}},[g,ot]),oe=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy",z(!0)},[]),se=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),k.current?.contains(e.relatedTarget)||z(!1)},[]),ie=r.useCallback(async e=>{e.preventDefault(),e.stopPropagation();const i=Array.from(e.dataTransfer.files).filter(T=>T.type.startsWith("image/"));if(i.length===0||!k.current?.getBoundingClientRect())return;let l=v,N=.5,I=.5;for(let T=1;T<=D;T++){const B=Z.current.get(T);if(B){const q=B.getBoundingClientRect();if(k.current?.getBoundingClientRect()){const W=e.clientX-q.left,H=e.clientY-q.top;if(W>=0&&W<=q.width&&H>=0&&H<=q.height){l=T;const E=X.current.get(T);E&&(N=W/(E.width*h),I=H/(E.height*h));break}}}}for(const T of i){const B=new FileReader;B.onload=q=>{const tt=q.target?.result,W=new Image;W.onload=()=>{if(!X.current.get(l))return;const E=.2,et=W.width/W.height,K=E/et,pt=Math.max(0,Math.min(1-E,N-E/2)),ft=Math.max(0,Math.min(1-K,I-K/2)),bt={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:l,x:pt,y:ft,width:E,height:K,rotation:0,imageData:tt,imageWidth:W.width,imageHeight:W.height};Rt(bt)},W.src=tt},B.readAsDataURL(T)}},[v,D,h,Rt]);if(!g&&!y)return t.jsx("div",{className:`pdf-viewer-empty ${b==="floating"?"float-layout":""}`,children:t.jsxs("div",{className:"upload-container",children:[t.jsx("label",{htmlFor:"pdf-upload",className:"upload-button",children:"Upload PDF"}),t.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:jt,style:{display:"none"}})]})});const Wt=ot.find(e=>e.id===yt)||null;return t.jsxs("div",{className:`pdf-viewer ${w?"saving-session":""}`,ref:V,children:[y&&t.jsx("div",{className:"pdf-loading-overlay",children:t.jsxs("div",{className:"pdf-loading-spinner",children:[t.jsx("div",{className:"spinner"}),t.jsx("p",{children:"Loading PDF..."})]})}),w&&t.jsx("div",{className:"pdf-saving-overlay",children:t.jsxs("div",{className:"pdf-saving-content",children:[t.jsx("div",{className:"saving-spinner"}),t.jsx("p",{children:"Saving PDF..."}),t.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})}),t.jsx(he,{mode:vt,onModeChange:ut,highlightColor:s,onHighlightColorChange:ee,onHighlightClick:te,hasTextSelection:!!kt,isHighlightActive:!!n,showColorPicker:C,onImageUpload:Qt,onDownload:ne,onNewSession:ht,onClearAll:()=>{J([]),ct(null)}}),t.jsxs("div",{className:"pdf-controls-top",ref:gt,children:[Wt&&Wt.type==="textbox"&&t.jsx(be,{selectedAnnotation:Wt,onUpdate:$t}),t.jsxs("div",{className:"zoom-controls",children:[t.jsx("button",{onClick:qt,className:"control-button fit-button",title:"Fit to width",children:"↔"}),t.jsx("button",{onClick:Kt,className:"control-button fit-button",title:"Fit to height",children:"↕"}),t.jsx("button",{onClick:Et,className:"control-button",children:"−"}),at?t.jsx("input",{ref:rt,type:"text",inputMode:"numeric",pattern:"[0-9]*",value:A,onChange:_t,onBlur:At,onKeyDown:Vt,onPaste:Zt,className:"zoom-input"}):t.jsxs("span",{className:"zoom-level",onClick:Lt,title:"Click to edit zoom level",children:[Math.round(h*100),"%"]}),t.jsx("button",{onClick:Dt,className:"control-button",children:"+"}),d&&t.jsx("button",{onClick:d,className:"control-button knowledge-notes-toggle",title:a?"Hide knowledge notes":"Show knowledge notes",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),t.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),t.jsx("polyline",{points:"10 9 9 9 8 9"})]})})]})]}),t.jsx("div",{ref:k,className:`pdf-content ${m?"drag-over":""}`,onMouseUp:Xt,onKeyUp:Xt,onClick:Gt,onDragOver:oe,onDragLeave:se,onDrop:e=>{z(!1),ie(e)},children:g&&t.jsx(le,{file:Q||g,onLoadSuccess:Nt,onLoadError:zt,loading:t.jsx("div",{className:"loading",children:"Loading PDF..."}),error:t.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",t.jsx("br",{}),t.jsxs("small",{children:["Worker: ",Ft?.workerSrc||"Not set"]})]}),noData:t.jsx("div",{className:"loading",children:"No PDF file selected"}),options:wt,children:Array.from(new Array(D),(e,o)=>{const i=o+1,f=X.current.get(i);return t.jsxs("div",{ref:l=>{l?Z.current.set(i,l):Z.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[t.jsx(ce,{pageNumber:i,scale:h,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:l=>Mt({pageNumber:i,page:l})},`page_${i}`),f&&t.jsxs(t.Fragment,{children:[t.jsx(de,{pageNumber:i,pageWidth:f.width,pageHeight:f.height,scale:h,annotations:ot,selectedAnnotationId:yt,onAnnotationUpdate:$t,onAnnotationDelete:Jt,onAnnotationSelect:ct,mode:vt}),a&&t.jsx(ue,{pageNumber:i,pageWidth:f.width,pageHeight:f.height,scale:h,knowledgeNotes:x,showKnowledgeNotes:a,layout:b,onNoteClick:G})]})]},`page-wrapper-${i}`)})})}),t.jsxs("div",{className:"pdf-controls-bottom",ref:mt,children:[t.jsx("button",{onClick:Tt,disabled:v<=1,className:"nav-button",children:"Previous"}),t.jsxs("span",{className:"page-info",children:["Page ",v," of ",D]}),t.jsx("button",{onClick:Bt,disabled:v>=D,className:"nav-button",children:"Next"})]})]})}export{Ce as default};
