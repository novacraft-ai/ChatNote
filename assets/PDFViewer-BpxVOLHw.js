import{r,j as n,D as Q,P as X}from"./vendor-react-BecnK9Vx.js";import{G as F}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-DuqZcPz3.js";function oe({file:m,onFileUpload:U,onTextSelection:p,layout:L="floating"}){const[i,B]=r.useState(0),[u,v]=r.useState(1),[d,N]=r.useState(1),h=r.useRef(new Map),g=r.useRef(null),f=r.useRef(null),C=r.useRef(!1),a=r.useRef(new Map),j=r.useMemo(()=>m?URL.createObjectURL(m):null,[m]);r.useEffect(()=>()=>{j&&URL.revokeObjectURL(j)},[j]);const W=r.useMemo(()=>{let e;{const t="/ChatNote/";e=`${t.endsWith("/")?t:`${t}/`}pdf.worker.min.js`}return F&&(F.workerSrc=e),{workerSrc:e,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:"https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/"}},[]),z=({numPages:e})=>{B(e),v(1),h.current.clear(),a.current.clear()},H=e=>{if(!a.current.has(e.pageNumber))try{const t=e.page;let o,s;t.viewport?(o=t.viewport.width,s=t.viewport.height):(o=t.width/d,s=t.height/d),a.current.set(e.pageNumber,{width:o,height:s})}catch(t){console.warn("Error getting page dimensions:",t);const o=e.page;a.current.set(e.pageNumber,{width:o.width/d,height:o.height/d})}};r.useEffect(()=>{if(!g.current||i===0)return;let e=null,t=!1;const o=()=>{if(C.current||t||e)return;t=!0,e=setTimeout(()=>{e=null,t=!1},100);const P=g.current;if(!P){t=!1;return}const E=P.getBoundingClientRect(),q=E.top,T=E.height,J=q+T/2;if(P.scrollTop<100){v(c=>c!==1?1:c);return}let R=1,M=0;for(let c=1;c<=i;c++){const b=h.current.get(c);if(b){const l=b.getBoundingClientRect(),w=P.getBoundingClientRect(),k=Math.max(w.top,l.top),S=Math.min(w.bottom,l.bottom),x=Math.max(0,S-k);x>M&&(M=x,R=c)}}if(M<T*.1){let c=1,b=1/0;for(let l=1;l<=i;l++){const w=h.current.get(l);if(w){const k=w.getBoundingClientRect(),S=k.top+k.height/2,x=Math.abs(S-J);x<b&&(b=x,c=l)}}R=c}v(c=>R!==c?R:c)},s=g.current;return s?.addEventListener("scroll",o,{passive:!0}),()=>{e&&clearTimeout(e),s?.removeEventListener("scroll",o)}},[i]);const O=e=>{console.error("PDF load error:",e)},$=e=>{const t=e.target.files?.[0];t&&t.type==="application/pdf"&&U(t)},y=r.useCallback(e=>{const t=h.current.get(e);t&&g.current&&(C.current=!0,v(e),t.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{C.current=!1},1500))},[]),A=()=>{const e=Math.max(1,u-1);y(e)},V=()=>{const e=Math.min(i,u+1);y(e)},I=()=>{N(e=>Math.min(e+.2,3))},_=()=>{N(e=>Math.max(e-.2,.5))},G=()=>{if(!f.current||a.current.size===0)return;const e=f.current.getBoundingClientRect();let t;L==="split"?t=e.width-40:t=window.innerWidth-40;const o=a.current.get(1);if(!o)return;const s=t/o.width;N(Math.max(.1,Math.min(s,3)))},Z=()=>{if(!f.current||a.current.size===0)return;const t=f.current.getBoundingClientRect().height-100,o=a.current.get(u);if(!o)return;const s=t/o.height;N(Math.max(.1,Math.min(s,3)))},D=r.useCallback(()=>{const e=window.getSelection();if(e&&e.toString().trim()){const t=e.toString().trim();p(t)}else p("")},[p]),K=r.useCallback(()=>{setTimeout(()=>{const e=window.getSelection();(!e||!e.toString().trim())&&p("")},10)},[p]);return m?n.jsxs("div",{className:"pdf-viewer",ref:f,children:[n.jsx("div",{className:"pdf-controls-top",children:n.jsxs("div",{className:"zoom-controls",children:[n.jsx("button",{onClick:G,className:"control-button fit-button",title:"Fit to width",children:"⤢"}),n.jsx("button",{onClick:Z,className:"control-button fit-button",title:"Fit to height",children:"⤡"}),n.jsx("button",{onClick:_,className:"control-button",children:"−"}),n.jsxs("span",{className:"zoom-level",children:[Math.round(d*100),"%"]}),n.jsx("button",{onClick:I,className:"control-button",children:"+"})]})}),n.jsx("div",{ref:g,className:"pdf-content",onMouseUp:D,onKeyUp:D,onClick:K,children:n.jsx(Q,{file:j||m,onLoadSuccess:z,onLoadError:O,loading:n.jsx("div",{className:"loading",children:"Loading PDF..."}),error:n.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",n.jsx("br",{}),n.jsxs("small",{children:["Worker: ",F?.workerSrc||"Not set"]})]}),noData:n.jsx("div",{className:"loading",children:"No PDF file selected"}),options:W,children:Array.from(new Array(i),(e,t)=>{const o=t+1;return n.jsx("div",{ref:s=>{s?h.current.set(o,s):h.current.delete(o)},className:"pdf-page-wrapper",children:n.jsx(X,{pageNumber:o,scale:d,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:s=>H({pageNumber:o,page:s})},`page_${o}`)},`page-wrapper-${o}`)})})}),n.jsxs("div",{className:"pdf-controls-bottom",children:[n.jsx("button",{onClick:A,disabled:u<=1,className:"nav-button",children:"Previous"}),n.jsxs("span",{className:"page-info",children:["Page ",u," of ",i]}),n.jsx("button",{onClick:V,disabled:u>=i,className:"nav-button",children:"Next"})]})]}):n.jsx("div",{className:`pdf-viewer-empty ${L==="floating"?"float-layout":""}`,children:n.jsxs("div",{className:"upload-container",children:[n.jsx("label",{htmlFor:"pdf-upload",className:"upload-button",children:"Upload PDF"}),n.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:$,style:{display:"none"}})]})})}export{oe as default};
