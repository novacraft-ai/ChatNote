const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PDFViewer-D7vbbvlx.js","assets/vendor-react-rsP_hLAx.js","assets/vendor-DIPRGdMO.js","assets/vendor-C5EChc_d.css","assets/vendor-pdf-DDxsMbbh.js","assets/vendor-react-CBXYWCWZ.css","assets/PDFViewer-D6tbIiHA.css"])))=>i.map(i=>d[i]);
import{r as a,j as e,M as gt,R as Ls,a as Rs}from"./vendor-react-rsP_hLAx.js";import{p as $s}from"./vendor-pdf-DDxsMbbh.js";import{k as vt,l as mt,n as pt,o as Jt,p as _s,q as Fs,s as Ds}from"./vendor-DIPRGdMO.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const c of i)if(c.type==="childList")for(const d of c.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&r(d)}).observe(document,{childList:!0,subtree:!0});function n(i){const c={};return i.integrity&&(c.integrity=i.integrity),i.referrerPolicy&&(c.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?c.credentials="include":i.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function r(i){if(i.ep)return;i.ep=!0;const c=n(i);fetch(i.href,c)}})();if(typeof window<"u"){let t,s;{const i="/ChatNote/";t=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`,s="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/"}const n=i=>{try{if(i)if(!i.GlobalWorkerOptions)i.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:s};else try{i.GlobalWorkerOptions.workerSrc=t,i.GlobalWorkerOptions.standardFontDataUrl=s}catch{try{Object.defineProperty(i,"GlobalWorkerOptions",{value:{workerSrc:t,standardFontDataUrl:s},writable:!0,configurable:!0})}catch{}}}catch{}};window.pdfjsLib||(window.pdfjsLib={}),window.pdfjsLib.GlobalWorkerOptions?(window.pdfjsLib.GlobalWorkerOptions.workerSrc=t,window.pdfjsLib.GlobalWorkerOptions.standardFontDataUrl=s):window.pdfjsLib.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:s},typeof window.pdfjs>"u"&&(window.pdfjs={}),window.pdfjs.GlobalWorkerOptions?(window.pdfjs.GlobalWorkerOptions.workerSrc=t,window.pdfjs.GlobalWorkerOptions.standardFontDataUrl=s):window.pdfjs.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:s};const r=$s;if(n(r),r.default&&n(r.default),r.GlobalWorkerOptions)try{r.GlobalWorkerOptions.workerSrc=t,r.GlobalWorkerOptions.standardFontDataUrl=s}catch{}}const Os="modulepreload",zs=function(t){return"/ChatNote/"+t},qn={},Bt=function(s,n,r){let i=Promise.resolve();if(n&&n.length>0){let E=function(f){return Promise.all(f.map(p=>Promise.resolve(p).then(l=>({status:"fulfilled",value:l}),l=>({status:"rejected",reason:l}))))};document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),g=d?.nonce||d?.getAttribute("nonce");i=E(n.map(f=>{if(f=zs(f),f in qn)return;qn[f]=!0;const p=f.endsWith(".css"),l=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${l}`))return;const u=document.createElement("link");if(u.rel=p?"stylesheet":Os,p||(u.as="script"),u.crossOrigin="",u.href=f,g&&u.setAttribute("nonce",g),document.head.appendChild(u),p)return new Promise((m,M)=>{u.addEventListener("load",m),u.addEventListener("error",()=>M(new Error(`Unable to preload CSS for ${f}`)))})}))}function c(d){const g=new Event("vite:preloadError",{cancelable:!0});if(g.payload=d,window.dispatchEvent(g),!g.defaultPrevented)throw d}return i.then(d=>{for(const g of d||[])g.status==="rejected"&&c(g.reason);return s().catch(c)})},cs=a.createContext(void 0);function Bs({children:t}){const[s,n]=a.useState(()=>localStorage.getItem("theme")||"light");a.useEffect(()=>{document.documentElement.setAttribute("data-theme",s),localStorage.setItem("theme",s)},[s]);const r=()=>{n(i=>i==="light"?"dark":"light")};return e.jsx(cs.Provider,{value:{theme:s,toggleTheme:r},children:t})}function fn(){const t=a.useContext(cs);if(t===void 0)throw new Error("useTheme must be used within a ThemeProvider");return t}const ds=["meta-llama/llama-4-scout-17b-16e-instruct","meta-llama/llama-4-maverick-17b-128e-instruct"],us=["moonshotai/kimi-k2-instruct-0905","moonshotai/kimi-k2-instruct","llama-3.3-70b-versatile","llama-3.1-8b-instant"],Wt=[...ds,...us],Ws=["groq/compound","groq/compound-mini"],kt=["openai/gpt-oss-120b","openai/gpt-oss-20b","qwen/qwen3-32b"],qs=["openai/gpt-oss-120b","openai/gpt-oss-20b"],Hs=["qwen/qwen3-32b"];function Hn(t){return qs.includes(t)}function Us(t){return Hs.includes(t)}const Vs=["moonshotai/kimi-k2-instruct-0905","openai/gpt-oss-safeguard-20b"],pe="https://chatnote-backend-8pk3.onrender.com",Un="105659660993-u7lnrcbis23u3mlaigteag67d6h6inar.apps.googleusercontent.com";class Gs{sessionId;userId=null;currentDocumentId=null;noteModeStartTime=null;currentNoteMode=null;constructor(){const s=typeof window<"u"?sessionStorage.getItem("analytics_session_id"):null;if(s)this.sessionId=s;else{this.sessionId=this.generateSessionId();try{sessionStorage.setItem("analytics_session_id",this.sessionId)}catch{}}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}generateDocumentId(){return`doc_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}setUserId(s){this.userId=s,localStorage.setItem("analytics_user_id",s)}getUserId(){return this.userId||(this.userId=localStorage.getItem("analytics_user_id")),this.userId}setCurrentDocument(s){this.currentDocumentId=s}clearCurrentDocument(){this.currentDocumentId=null}getCurrentDocumentId(){return this.currentDocumentId}async trackEvent(s,n,r){const i=this.getUserId();if(i)try{const c=await fetch(`${pe}/api/internal/logs/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({eventName:s,properties:{...n,user_id:i},documentId:r,sessionId:this.sessionId})});if(!c.ok){const d=await c.json();console.error("[Analytics] Failed to track event:",s,d)}}catch(c){console.error("[Analytics] Error tracking event:",s,c)}}async trackPageView(){await this.trackEvent("page_viewed",{})}async resetAnalytics(){await this.endNoteModeTracking(),this.userId=null,this.currentDocumentId=null,this.noteModeStartTime=null,this.currentNoteMode=null;try{localStorage.removeItem("analytics_user_id")}catch{}}async trackQuerySubmitted(s,n,r){await this.trackEvent("query_submitted",{ai_mode:s,ui_mode:n,is_contextual:r})}async trackAIResponse(s,n){await this.trackEvent("ai_response_rendered",{ai_mode:s,response_time_ms:n})}async trackAIResultAction(s){await this.trackEvent("ai_result_action",{action_type:s})}async trackPDFUpload(s,n){await this.trackEvent("pdf_uploaded",{file_size_mb:s},n)}async trackAnnotationAdded(s){await this.trackEvent("annotation_added",{tool_name:s})}async trackPDFExport(s){await this.trackEvent("pdf_exported",{include_annotations:s})}async startNoteModeTracking(s){if(this.noteModeStartTime!==null&&this.currentNoteMode!==null&&this.currentNoteMode!==s){const n=Date.now()-this.noteModeStartTime;n>=100&&await this.trackEvent("note_mode_viewed",{view_mode:this.currentNoteMode,duration_ms:n}),this.noteModeStartTime=null,this.currentNoteMode=null}this.noteModeStartTime===null&&(this.noteModeStartTime=Date.now(),this.currentNoteMode=s)}async endNoteModeTracking(){if(this.noteModeStartTime===null||this.currentNoteMode===null)return;const s=Date.now()-this.noteModeStartTime;s>=100&&await this.trackEvent("note_mode_viewed",{view_mode:this.currentNoteMode,duration_ms:s}),this.noteModeStartTime=null,this.currentNoteMode=null}async trackError(s,n){await this.trackEvent("error_occurred",{error_type:s,error_message:n})}async upsertUser(s,n){try{const r=await fetch(`${pe}/api/internal/logs/user`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({userId:s,email:n})});if(!r.ok){const i=await r.json();console.error("Failed to upsert user:",i)}}catch(r){console.error("Error upserting user:",r)}}async createDocument(s,n){if(this.getUserId())try{const i=await fetch(`${pe}/api/internal/logs/document`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify({documentId:s,fileSizeMb:n})});if(!i.ok){const c=await i.json();console.error("Failed to create document:",c)}}catch(i){console.error("Error creating document:",i)}}async updateDocument(s,n){try{const r=await fetch(`${pe}/api/internal/logs/document/${s}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("auth_token")}`},body:JSON.stringify(n)});if(!r.ok){const i=await r.json();console.error("Failed to update document:",i)}}catch(r){console.error("Error updating document:",r)}}}const we=new Gs,hs=a.createContext(void 0);function Qs({children:t}){const[s,n]=a.useState(null),[r,i]=a.useState(!0),c=()=>{if(typeof window>"u")return!1;try{return sessionStorage.getItem("analytics_page_view_tracked")==="true"}catch{return!1}},d=()=>{if(!(typeof window>"u"))try{sessionStorage.setItem("analytics_page_view_tracked","true")}catch{}};a.useEffect(()=>{const l=localStorage.getItem("auth_token");l?g(l):i(!1)},[]);const g=async(l,u=0)=>{let M=!1;try{const y=new AbortController,A=setTimeout(()=>y.abort(),1e4),j=await fetch(`${pe}/api/auth/me`,{headers:{Authorization:`Bearer ${l}`},signal:y.signal});if(clearTimeout(A),j.ok){const x=await j.json();n({...x.user,privacyConsent:x.user.privacyConsent}),x.user&&x.user.id&&(we.setUserId(x.user.id),await we.upsertUser(x.user.id,x.user.email),c()||(await we.trackPageView(),d())),M=!0}else if(j.status===401||j.status===403)console.warn("Token invalid, logging out"),localStorage.removeItem("auth_token"),n(null),M=!0;else{if(u<2)return console.warn(`Failed to fetch user (${j.status}), retrying... (${u+1}/2)`),await new Promise(x=>setTimeout(x,1e3*(u+1))),g(l,u+1);console.error("Failed to fetch user after retries, but keeping token:",j.status),M=!0}}catch(y){if(u<2){const A=y instanceof Error?y.name:"Unknown";return console.warn(`Network error (${A}), retrying... (${u+1}/2)`),await new Promise(j=>setTimeout(j,1e3*(u+1))),g(l,u+1)}else y instanceof Error&&y.name==="AbortError"?console.warn("Request timeout after retries, but keeping user logged in"):console.error("Network error fetching user after retries, but keeping token:",y),M=!0}finally{M&&i(!1)}},E=async()=>{const l=localStorage.getItem("auth_token");l&&await g(l)},f=async l=>{try{const u=await fetch(`${pe}/api/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:l})});if(!u.ok){const M=await u.json();throw new Error(M.error||"Authentication failed")}const m=await u.json();localStorage.setItem("auth_token",m.token),n({...m.user,privacyConsent:m.user.privacyConsent}),m.user&&m.user.id&&(we.setUserId(m.user.id),await we.upsertUser(m.user.id,m.user.email),await we.trackPageView(),d())}catch(u){throw console.error("Login error:",u),console.error("Failed URL:",`${pe}/api/auth/google`),u}},p=async()=>{localStorage.removeItem("auth_token");try{sessionStorage.removeItem("analytics_page_view_tracked")}catch{}try{localStorage.removeItem("chatnote_pdf_history_cache")}catch(l){console.warn("Failed to clear PDF history cache:",l)}await we.resetAnalytics(),n(null)};return e.jsx(hs.Provider,{value:{user:s,loading:r,login:f,logout:p,isAuthenticated:!!s,isAdmin:s?.role==="admin",refreshUser:E},children:t})}function qt(){const t=a.useContext(hs);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}const gs=a.createContext(void 0);function Ys({children:t}){const[s,n]=a.useState(()=>{const c=localStorage.getItem("chatVisible");return c!==null?c==="true":!0});a.useEffect(()=>{localStorage.setItem("chatVisible",String(s))},[s]);const r=()=>{n(c=>!c)},i=c=>{n(c)};return e.jsx(gs.Provider,{value:{isChatVisible:s,toggleChatVisibility:r,setChatVisible:i},children:t})}function En(){const t=a.useContext(gs);if(t===void 0)throw new Error("useChatVisibility must be used within a ChatVisibilityProvider");return t}const ms=a.createContext(void 0);function Ks({children:t,hasUnsavedChanges:s,saveCurrentState:n,isSavingSession:r,setIsSavingSession:i}){return e.jsx(ms.Provider,{value:{hasUnsavedChanges:s,saveCurrentState:n,isSavingSession:r,setIsSavingSession:i},children:t})}function Js(){const t=a.useContext(ms);if(t===void 0)throw new Error("useSave must be used within a SaveProvider");return t}function ps(){return localStorage.getItem("auth_token")}function Xs(t){if(t.startsWith("groq/compound")){const s=["groq/compound","groq/compound-mini"],n=s.indexOf(t);return n!==-1?s.slice(n):[t]}if(Wt.includes(t)){const s=Wt.indexOf(t);return Wt.slice(s)}if(kt.includes(t)){const s=kt.indexOf(t),n=kt.filter(i=>!i.startsWith("groq/compound")),r=n.indexOf(t);return r!==-1?n.slice(r):kt.slice(s)}return[t]}function Zs(t,s){if(s===429||s>=500&&s<600)return!0;const n=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return["rate limit","too many requests","service unavailable","internal server error","bad gateway","gateway timeout","timeout"].some(i=>n.toLowerCase().includes(i))}function Vn(t,s){if(s===429)return"Rate limit reached. Please wait a moment and try again.";if(s===401)return"Authentication failed. Please log in again.";if(s===400){const r=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return r.includes("API key not configured")?"API key not configured. Please add your API key in settings.":r.includes("model")||r.includes("invalid")?"Invalid request. Please try again or select a different model.":"Invalid request. Please check your input and try again."}if(s===403)return"Access denied. Please check your API key permissions.";if(s===404)return"Model not found. Please select a different model.";if(s>=500&&s<600)return"Service temporarily unavailable. Please try again in a moment.";const n=typeof t?.error=="string"?t.error:t?.error?.message||t?.message||"";return console.error("API error details (not shown to user):",{status:s,message:n,error:t}),"An error occurred while processing your request. Please try again."}function Xt(t=[],s){if(!s||s.length===0)return t;const n=[...t],r=new Set(n.map((i,c)=>i?.url||`${i?.title||"source"}-${c}`));for(const i of s){if(!i)continue;const c=i.url||`${i.title||"source"}-${i.content||""}`;r.has(c)||(n.push(i),r.add(c))}return n}function er(t,s){return s||t.includes("gpt-oss")||t.includes("qwen")||t.includes("groq/compound")?.55:t.includes("llama-4-scout")||t.includes("llama-4-maverick")?.65:.7}function tr(t,s){return s||t.includes("gpt-oss")||t.includes("qwen")||t.includes("groq/compound")?s?8e3:4e3:t.includes("llama-4-scout")||t.includes("llama-4-maverick")?4e3:3e3}async function sn(t,s,n,r,i,c,d){const g=ps();if(!g)throw new Error("Authentication required. Please log in.");const E=r||Wt[0],f=Xs(E),p=c||!1;let l=null;for(const u of f)try{const m={messages:t,context:s,model:u,temperature:er(u,p),maxTokens:tr(u,p),stream:!!n};d?.tools&&(m.tools=d.tools),d?.toolChoice&&(m.tool_choice=d.toolChoice),(d?.includeReasoning??p)&&kt.includes(u)?Hn(u)?m.include_reasoning=!0:Us(u)&&(m.reasoning_format=d?.reasoningFormat||"parsed"):d?.includeReasoning===!1&&Hn(u)&&(m.include_reasoning=!1);let y;try{y=await fetch(`${pe}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${g}`},body:JSON.stringify(m),signal:i})}catch(N){throw N instanceof DOMException&&N.name==="AbortError"?new DOMException("Request aborted by user","AbortError"):N}if(!y.ok){let N;try{const L=await y.text();try{N=JSON.parse(L)}catch{N={error:{message:L||"Unknown error"}}}}catch{N={error:{message:"Unknown error"}}}if(y.status===401)throw localStorage.removeItem("auth_token"),new Error("Session expired. Please log in again.");if(y.status===400&&N.error?.message?.includes("API key not configured"))throw new Error("API key not configured. Please add your Groq API key in settings.");const R=Zs(N,y.status),$=f.length>1&&u!==f[f.length-1];if(R&&$){l=new Error(Vn(N,y.status));continue}const H=Vn(N,y.status);throw console.error("Backend error response (details logged, user sees sanitized message):",N),new Error(H)}if(n&&y.body){const N=y.body.getReader(),R=new TextDecoder;let $="",H="",L=[],Y="";for(;;){if(i?.aborted)throw N.cancel(),new DOMException("Request aborted by user","AbortError");let ne,re;try{const ie=await N.read();ne=ie.done,re=ie.value}catch(ie){throw ie instanceof DOMException&&ie.name==="AbortError"?(N.cancel(),new DOMException("Request aborted by user","AbortError")):ie}if(ne)break;Y+=R.decode(re,{stream:!0});const ce=Y.split(`
`);Y=ce.pop()||"";for(const ie of ce){const Be=ie.trim();if(Be&&Be.startsWith("data: ")){const F=Be.slice(6);if(F==="[DONE]")continue;try{const z=JSON.parse(F);if(z.type==="metadata"&&z.browserSearchSources){L=Xt(L,z.browserSearchSources);continue}const J=z.choices?.[0]?.delta,ke=z.choices?.[0]?.message;J?.content&&($+=J.content,n(J.content)),J?.reasoning&&(H+=J.reasoning);const de=J?.executed_tools||ke?.executed_tools;if(de&&de.length>0){const C=[];for(const T of de)T?.search_results?.results&&C.push(...T.search_results.results);C.length>0&&(L=Xt(L,C))}}catch{}}}}if(Y.trim()){const ne=Y.trim();if(ne.startsWith("data: ")){const re=ne.slice(6);if(re!=="[DONE]")try{const ce=JSON.parse(re);ce.type==="metadata"&&ce.browserSearchSources&&(L=Xt(L,ce.browserSearchSources));const ie=ce.choices?.[0]?.delta,Be=ce.choices?.[0]?.message;ie?.content&&($+=ie.content,n(ie.content)),ie?.reasoning&&(H+=ie.reasoning);const F=ie?.executed_tools||Be?.executed_tools;if(F&&F.length>0){const z=[];for(const J of F)J?.search_results?.results&&z.push(...J.search_results.results);z.length>0&&(L=Xt(L,z))}}catch{}}}const q=d?.tools?.some(ne=>ne.type==="browser_search")||!1;return H?{content:`__REASONING_START__${H}__REASONING_END__${$}`,usedBrowserSearch:q,browserSearchSources:L}:{content:$,usedBrowserSearch:q,browserSearchSources:L}}const A=await y.json(),j=A.choices[0]?.message;let x=j?.content||"No response from API";const S=j?.reasoning,P=j?.executed_tools,b=A.metadata?.browserSearch||!1;let h=A.metadata?.browserSearchSources||[],w="";if(P&&P.length>0){const N=[];for(const R of P)R?.search_results?.results&&R.search_results.results.length>0&&N.push(...R.search_results.results);N.length>0&&(h=Xt(h,N),w=`

---

## Sources

`,N.forEach((R,$)=>{w+=`${$+1}. [${R.title}](${R.url})
`}))}return w&&(x=x+w),S?{content:`__REASONING_START__${S}__REASONING_END__${x}`,usedBrowserSearch:b,browserSearchSources:h}:{content:x,usedBrowserSearch:b,browserSearchSources:h}}catch(m){if(u===f[f.length-1])throw m instanceof DOMException&&m.name==="AbortError"?m:l||(console.error("Chat service error:",m),m);l=m instanceof Error?m:new Error(String(m))}throw l||new Error("Unable to process your request. Please try again later.")}async function nr(){const t=ps();if(!t)return!1;try{const s=await fetch(`${pe}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(s.ok){const n=await s.json();return n.hasApiKey||n.isAdmin||n.freeTrial?.enabled&&n.freeTrial?.remaining>0}if(s.status===429)throw new Error("Rate limited");return!1}catch(s){if(s instanceof Error&&s.message==="Rate limited")throw s;return!1}}function sr(){const{user:t,login:s,logout:n,loading:r}=qt(),{hasUnsavedChanges:i,saveCurrentState:c,setIsSavingSession:d}=Js(),[g,E]=a.useState(!1),[f,p]=a.useState(null),[l,u]=a.useState(!1);a.useEffect(()=>{},[t,r]);const m=async()=>{if(i)if(window.confirm("You have unsaved changes to your PDF annotations and notes. Would you like to save them before logging out?")){u(!0),d(!0);try{await c(),await n()}catch(x){console.error("Error saving or logging out:",x)}finally{u(!1),d(!1)}}else await n();else window.confirm("Are you sure you want to log out?")&&await n()};a.useEffect(()=>{const j=console.error,x=console.warn;console.error=(...P)=>{const b=P.join(" ");b.includes("Not signed in with the identity provider")||b.includes("AbortError")||b.includes("signal is aborted")||b.includes("FedCM get() rejects")||b.includes("GSI_LOGGER")||b.includes("The given origin is not allowed")||b.includes("ERR_BLOCKED_BY_CLIENT")||b.includes("Cross-Origin-Opener-Policy")||b.includes("Only one navigator.credentials.get request may be outstanding")||b.includes("Identity not selected by user")||j.apply(console,P)},console.warn=(...P)=>{const b=P.join(" ");b.includes("GSI_LOGGER")||b.includes("The given origin is not allowed")||b.includes("Not signed in with the identity provider")||b.includes("Only one navigator.credentials.get request may be outstanding")||b.includes("Identity not selected by user")||x.apply(console,P)};const S=window.onerror;return window.onerror=(P,b,h,w,N)=>typeof P=="string"&&(P.includes("Not signed in with the identity provider")||P.includes("Only one navigator.credentials.get request may be outstanding")||P.includes("AbortError")||P.includes("The given origin is not allowed")||P.includes("Identity not selected by user")||b?.includes("accounts.google.com"))?!0:S?S(P,b,h,w,N):!1,()=>{console.error=j,console.warn=x,window.onerror=S}},[]);const M=a.useCallback(async j=>{try{const x=document.getElementById("google-login-backdrop"),S=document.getElementById("google-signin-button");x&&x.remove(),S&&S.remove(),await s(j.credential);const P=()=>{document.querySelectorAll(".g_id_signin, .google-one-tap-modal, #google-login-backdrop, #google-signin-button").forEach(h=>h.remove())};P(),setTimeout(P,100),setTimeout(P,500)}catch(x){console.error("Login failed:",x),alert(x instanceof Error?x.message:"Login failed. Please try again.")}},[s]);a.useEffect(()=>{if(t){(()=>{document.querySelectorAll(".g_id_signin, .google-one-tap-modal, #google-login-backdrop, #google-signin-button").forEach(b=>{b instanceof HTMLElement&&(b.style.display="none",setTimeout(()=>b.remove(),16))})})();return}if(window.google){try{window.google.accounts.id.initialize({client_id:Un,callback:M,auto_select:!1,cancel_on_tap_outside:!0}),E(!0)}catch(S){console.error("Failed to initialize Google OAuth:",S),p("Failed to initialize Google OAuth")}return}const j=document.createElement("script");j.src="https://accounts.google.com/gsi/client",j.async=!0,j.defer=!0,j.onload=()=>{if(window.google)try{window.google.accounts.id.initialize({client_id:Un,callback:M,use_fedcm_for_prompt:!0,auto_select:!1,cancel_on_tap_outside:!0}),E(!0),p(null)}catch(S){console.error("Failed to initialize Google OAuth:",S),p("Failed to initialize Google OAuth")}else console.error("Google script loaded but window.google is not available"),p("Google script failed to load")},j.onerror=S=>{console.error("Failed to load Google Identity Services script:",S),p("Failed to load Google Sign-In script. Please check your internet connection and try again."),E(!1)};const x=setTimeout(()=>{!window.google&&!f&&(console.error("Google script loading timeout"),p("Google Sign-In is taking too long to load. Please check your internet connection or try again later."),E(!1))},15e3);return document.head.appendChild(j),()=>{if(clearTimeout(x),window.google?.accounts.id)try{document.querySelectorAll(".g_id_signin, .google-one-tap-modal").forEach(P=>{P instanceof HTMLElement&&(P.style.display="none",setTimeout(()=>P.remove(),100))})}catch{}}},[M,t]),a.useEffect(()=>{if(t){const j=()=>{const S=document.getElementById("google-login-backdrop"),P=document.getElementById("google-signin-button"),b=document.querySelector(".g_id_signin");if(S&&S.remove(),P&&P.remove(),b&&b.remove(),window.google?.accounts.id)try{(()=>{document.querySelectorAll(".g_id_signin, .google-one-tap-modal").forEach(N=>{N instanceof HTMLElement&&(N.style.display="none")})})()}catch{}};j();const x=setTimeout(j,100);return()=>{clearTimeout(x)}}},[t]),a.useEffect(()=>{if(t||window.google&&g||r||f)return;localStorage.getItem("auth_token")&&!t&&!g&&!f&&(E(!1),p(null))},[t,g,f,r]);const y=()=>{const j=document.getElementById("google-login-backdrop"),x=document.getElementById("google-signin-button");j&&j.remove(),x&&x.remove();const S=document.createElement("div");S.id="google-login-backdrop",S.style.position="fixed",S.style.top="0",S.style.left="0",S.style.width="100%",S.style.height="100%",S.style.backgroundColor="rgba(0, 0, 0, 0.5)",S.style.zIndex="9999",S.style.display="flex",S.style.alignItems="center",S.style.justifyContent="center";const P=()=>{S.remove(),h.remove(),document.removeEventListener("keydown",b)};S.addEventListener("click",w=>{w.target===S&&P()});const b=w=>{w.key==="Escape"&&P()};document.addEventListener("keydown",b);const h=document.createElement("div");h.id="google-signin-button",h.style.position="relative",h.style.background="white",h.style.padding="20px",h.style.borderRadius="8px",h.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",h.style.zIndex="10000",h.addEventListener("click",w=>{w.stopPropagation()}),S.appendChild(h),document.body.appendChild(S);try{window.google.accounts.id.renderButton(h,{theme:"outline",size:"large",text:"signin_with",width:250})}catch(w){console.warn("Could not render Google button, showing manual login option:",w),h.innerHTML=`
                <p style="margin: 0 0 10px 0; text-align: center;">Sign in with Google</p>
                <button onclick="window.location.href='https://accounts.google.com/signin'" 
                        style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Continue with Google
                </button>
                <button onclick="document.getElementById('google-login-backdrop')?.remove(); document.getElementById('google-signin-button')?.remove();" 
                        style="margin-top: 10px; padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Cancel
                </button>
              `;const N=h.querySelector("button:last-child");N&&N.addEventListener("click",()=>{document.removeEventListener("keydown",b)})}},A=()=>{if(t){console.warn("Login button clicked but user is already logged in");return}if(f){alert(`Google Sign-In error: ${f}. Please check the browser console.`);return}if(window.google&&g)try{window.google.accounts.id&&document.querySelectorAll(".g_id_signin, .google-one-tap-modal").forEach(x=>{x instanceof HTMLElement&&(x.style.display="none")}),window.google.accounts.id.prompt(j=>{const x=j.getNotDisplayedReason?.(),S=j.getSkippedReason?.(),P=j.getDismissedReason?.(),b=j.isNotDisplayed?.(),h=j.isSkippedMoment?.(),w=j.isDismissedMoment?.();(x||S||P||b||h||w)&&y()}),setTimeout(()=>{document.getElementById("google-login-backdrop")||y()},500)}catch(j){console.error("Error showing Google sign-in:",j),y()}else alert("Google Sign-In is still loading. Please wait a moment and try again.")};return r&&!t?e.jsx("div",{className:"login-button loading",children:e.jsx("span",{children:"Loading..."})}):t?e.jsxs("div",{className:"login-button user-info",children:[e.jsx("div",{className:"user-avatar",children:t.picture?e.jsx("img",{src:t.picture,alt:t.name||t.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:j=>{const x=j.target;x.style.display="none";const S=x.parentElement;if(S){const P=S.querySelector("span");P&&P.remove();const b=document.createElement("span");b.textContent=t.name?.[0]||t.email[0].toUpperCase(),S.appendChild(b)}}}):e.jsx("span",{children:t.name?.[0]||t.email[0].toUpperCase()})}),e.jsxs("div",{className:"user-details",children:[e.jsx("span",{className:"user-name",children:t.name||t.email}),t.role==="admin"&&e.jsx("span",{className:"user-role",children:"Admin"})]}),e.jsx("button",{onClick:m,className:"logout-button",title:l?"Saving changes...":"Logout",disabled:l,children:l?e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",opacity:"0.75",children:e.jsx("animateTransform",{attributeName:"transform",type:"rotate",from:"0 12 12",to:"360 12 12",dur:"1s",repeatCount:"indefinite"})})]}):e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e.jsx("polyline",{points:"16 17 21 12 16 7"}),e.jsx("line",{x1:"21",y1:"12",x2:"9",y2:"12"})]})})]}):f&&!g?e.jsxs("div",{className:"login-button-group",children:[e.jsxs("button",{onClick:A,className:"login-button sign-in error",title:f,children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Sign in (Error)"]}),e.jsxs("button",{onClick:()=>{p(null),E(!1),window.location.reload()},className:"login-button retry",title:"Retry loading Google Sign-In",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"})}),"Retry"]})]}):e.jsx("button",{onClick:A,className:"login-button sign-in",disabled:!g,title:g?"Sign in with Google":"Loading Google Sign-In...",children:g?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"}),e.jsx("path",{d:"M3 20a6 6 0 0 1 6-6h6a6 6 0 0 1 6 6v1H3v-1Z"})]}),e.jsx("span",{children:"Sign in"})]}):e.jsx("span",{children:"Loading Google Sign-In..."})})}async function rr(t){const s=await fetch(`${pe}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)throw new Error("Failed to check API key status");return s.json()}async function or(t,s){const n=await fetch(`${pe}/api/user/api-key`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({apiKey:s})});if(!n.ok){const r=await n.json();throw new Error(r.error||"Failed to save API key")}}async function ir(t,s){try{(await fetch(`${pe}/api/user/free-trial/update`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({usedCount:s})})).ok||console.error("Failed to update free trial count on backend")}catch(n){console.error("Error syncing free trial count:",n)}}function ar(){const{user:t,isAdmin:s}=qt(),[n,r]=a.useState(""),[i,c]=a.useState(!1),[d,g]=a.useState(!1),[E,f]=a.useState(!1),[p,l]=a.useState(null),[u,m]=a.useState(null);a.useEffect(()=>{t&&!s?M():s&&c(!0)},[t,s]);const M=async()=>{if(t){g(!0);try{const A=localStorage.getItem("auth_token");if(!A)return;const j=await rr(A);c(j.hasApiKey),m(j.freeTrial||null)}catch(A){console.error("Failed to load API key status:",A)}finally{g(!1)}}},y=async()=>{if(!(!t||!n.trim())){f(!0),l(null);try{const A=localStorage.getItem("auth_token");if(!A)throw new Error("Not authenticated");await or(A,n.trim()),l({type:"success",text:"API key saved securely!"}),r(""),c(!0)}catch(A){l({type:"error",text:A instanceof Error?A.message:"Failed to save API key"})}finally{f(!1)}}};return t?s?e.jsx("div",{className:"api-key-settings",children:e.jsxs("div",{className:"api-key-info admin",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"api-key-title",children:"Admin Account"}),e.jsx("p",{className:"api-key-description",children:"You're using the admin API key. No configuration needed."})]})]})}):d?e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Loading..."})}):e.jsxs("div",{className:"api-key-settings",children:[e.jsxs("div",{className:"api-key-header",children:[e.jsx("h3",{children:"Groq API Key"}),i&&e.jsx("span",{className:"api-key-status-badge",children:"Configured"})]}),!i&&u&&u.enabled&&e.jsxs("div",{className:"api-key-info free-trial",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M12 6v6l4 2"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"api-key-title",children:"Free Trial Active"}),e.jsxs("p",{className:"api-key-description",children:[u.remaining," of ",u.limit," free conversations remaining"]}),e.jsx("div",{className:"free-trial-progress",children:e.jsx("div",{className:"free-trial-progress-bar",style:{width:`${u.remaining/u.limit*100}%`}})})]})]}),!i&&u&&!u.enabled&&u.used>=u.limit&&e.jsxs("div",{className:"api-key-info warning",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"api-key-title",children:"Free Trial Expired"}),e.jsxs("p",{className:"api-key-description",children:["You've used all ",u.limit," free conversations. Add your own API key below to continue."]})]})]}),e.jsx("p",{className:"api-key-description",children:i?"Your API key is securely stored and encrypted. You can update it below.":"Enter your Groq API key to use the chat feature. Your key will be encrypted and stored securely."}),e.jsxs("div",{className:"api-key-input-group",children:[e.jsx("input",{type:"password",value:n,onChange:A=>r(A.target.value),placeholder:"gsk_...",className:"api-key-input",disabled:E}),e.jsx("button",{onClick:y,disabled:!n.trim()||E,className:"api-key-save-button",children:E?"Saving...":i?"Update":"Save"})]}),p&&e.jsx("div",{className:`api-key-message ${p.type}`,children:p.text}),e.jsxs("div",{className:"api-key-help",children:[e.jsx("p",{children:e.jsx("strong",{children:"Don't have an API key?"})}),e.jsxs("ol",{children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://console.groq.com/keys",target:"_blank",rel:"noopener noreferrer",children:"Groq Console"})]}),e.jsx("li",{children:"Sign up or log in"}),e.jsx("li",{children:"Create a new API key"}),e.jsx("li",{children:"Copy and paste it here"})]}),e.jsx("p",{className:"api-key-security-note",children:"ðŸ”’ Your API key is encrypted with AES-256 and stored securely. Only you can use it."})]})]}):e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Please sign in to configure your API key."})})}const lr="/ChatNote/assets/ucla-logo-BjjJ2cYq.svg";function cr({onOpenHistory:t,isSavingSession:s=!1,currentMode:n,onResetMode:r,hasPdf:i=!1,isGoogleDriveEligible:c=!1}){const{theme:d,toggleTheme:g}=fn(),{isChatVisible:E,toggleChatVisibility:f}=En(),{user:p}=qt(),[l,u]=a.useState(!1),[m,M]=a.useState(!1),y=a.useRef(null),A=a.useRef(null),j=a.useRef(null),x=p?.email?.endsWith("@g.ucla.edu")??!1,P=n==="quiz-me"?"Quiz Mode":n==="guide-me-learn"?"Learn Mode":null;return a.useEffect(()=>{const b=setTimeout(()=>{y.current&&y.current.classList.add("animation-complete"),A.current&&A.current.classList.add("animation-complete"),j.current&&j.current.classList.add("animation-complete")},13500);return()=>clearTimeout(b)},[]),e.jsxs(e.Fragment,{children:[e.jsx("nav",{className:"navbar",children:e.jsxs("div",{className:"navbar-content",children:[c&&t&&e.jsx("button",{className:"history-toggle",onClick:t,title:"PDF History","aria-label":"Open PDF history",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})}),e.jsxs("div",{className:"navbar-title",children:[P&&i&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"mode-indicator",onClick:r,title:"Click to change mode",children:[e.jsx("span",{className:"mode-text",children:P}),e.jsx("svg",{className:"mode-change-icon",width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})]}),e.jsx("span",{className:"mode-separator",children:"â€¢"})]}),e.jsx("span",{ref:y,className:"title-text",children:"ChatNote"}),x&&e.jsxs(e.Fragment,{children:[e.jsx("span",{ref:A,className:"title-for",children:"for"}),e.jsx("img",{ref:j,src:lr,alt:"UCLA",className:"ucla-logo"})]})]}),e.jsxs("div",{className:"navbar-actions",children:[e.jsx(sr,{}),e.jsxs("div",{className:"navbar-actions-desktop",children:[i&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"history-toggle",onClick:()=>window.dispatchEvent(new CustomEvent("pdf-new-session")),title:"New Session","aria-label":"New Session",disabled:s,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]})}),e.jsx("button",{className:"history-toggle",onClick:()=>window.dispatchEvent(new CustomEvent("pdf-download")),title:"Download","aria-label":"Download PDF",disabled:s,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]})})]}),e.jsx("button",{className:"settings-toggle",onClick:()=>u(!l),title:"Settings","aria-label":"Settings",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:`M19.14 12.94
                       C19.18 12.64 19.2 12.32 19.2 12
                       C19.2 11.68 19.18 11.36 19.14 11.06
                       L20.74 9.88
                       C20.9 9.76 20.95 9.54 20.86 9.35
                       L19.26 6.35
                       C19.16 6.16 18.95 6.08 18.75 6.14
                       L16.82 6.76
                       C16.43 6.48 16.02 6.25 15.57 6.07
                       L15.3 4.06
                       C15.27 3.86 15.11 3.72 14.9 3.72
                       H9.1
                       C8.89 3.72 8.73 3.86 8.7 4.06
                       L8.43 6.07
                       C7.98 6.25 7.57 6.48 7.18 6.76
                       L5.25 6.14
                       C5.05 6.08 4.84 6.16 4.74 6.35
                       L3.14 9.35
                       C3.05 9.54 3.1 9.76 3.26 9.88
                       L4.86 11.06
                       C4.82 11.36 4.8 11.68 4.8 12
                       C4.8 12.32 4.82 12.64 4.86 12.94
                       L3.26 14.12
                       C3.1 14.24 3.05 14.46 3.14 14.65
                       L4.74 17.65
                       C4.84 17.84 5.05 17.92 5.25 17.86
                       L7.18 17.24
                       C7.57 17.52 7.98 17.75 8.43 17.93
                       L8.7 19.94
                       C8.73 20.14 8.89 20.28 9.1 20.28
                       H14.9
                       C15.11 20.28 15.27 20.14 15.3 19.94
                       L15.57 17.93
                       C16.02 17.75 16.43 17.52 16.82 17.24
                       L18.75 17.86
                       C18.95 17.92 19.16 17.84 19.26 17.65
                       L20.86 14.65
                       C20.95 14.46 20.9 14.24 20.74 14.12
                       L19.14 12.94Z`,stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("circle",{cx:"12",cy:"12",r:"3",stroke:"currentColor",strokeWidth:"1.5"})]})}),e.jsx("button",{className:"theme-toggle",onClick:g,title:`Switch to ${d==="light"?"dark":"light"} mode`,"aria-label":`Switch to ${d==="light"?"dark":"light"} mode`,children:d==="light"?e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"5"}),e.jsx("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),e.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),e.jsx("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),e.jsx("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),e.jsx("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),e.jsx("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),e.jsx("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),e.jsx("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]})})]}),e.jsx("button",{className:"mobile-menu-toggle",onClick:()=>M(!m),title:"More options","aria-label":"Toggle menu",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"1"}),e.jsx("circle",{cx:"12",cy:"5",r:"1"}),e.jsx("circle",{cx:"12",cy:"19",r:"1"})]})})]}),m&&e.jsxs("div",{className:"mobile-menu",children:[P&&i&&e.jsxs("button",{className:"mobile-menu-item mobile-menu-mode",onClick:()=>{r?.(),M(!1)},title:"Change study mode","aria-label":"Change study mode",type:"button",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M3 12h18"}),e.jsx("polyline",{points:"15 6 21 12 15 18"})]}),e.jsxs("div",{className:"mobile-mode-text",children:[e.jsx("span",{className:"mobile-mode-label",children:"Mode"}),e.jsx("span",{className:"mobile-mode-value",children:P})]})]}),e.jsxs("button",{className:"mobile-menu-item",onClick:()=>{u(!l),M(!1)},children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"})]}),e.jsx("span",{children:"Settings"})]}),i&&e.jsx("button",{className:"mobile-menu-item",onClick:()=>{f(),M(!1)},disabled:s,children:E?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"})]}),e.jsx("span",{children:"Hide Chat"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18",strokeWidth:"2.5"})]}),e.jsx("span",{children:"Show Chat"})]})}),t&&c&&e.jsxs("button",{className:"mobile-menu-item",onClick:()=>{t(),M(!1)},disabled:s,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]}),e.jsx("span",{children:"PDF History"})]}),i&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"mobile-menu-item",onClick:()=>{window.dispatchEvent(new CustomEvent("pdf-new-session")),M(!1)},disabled:s,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),e.jsx("span",{children:"New Session"})]}),e.jsxs("button",{className:"mobile-menu-item",onClick:()=>{window.dispatchEvent(new CustomEvent("pdf-download")),M(!1)},disabled:s,children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),e.jsx("span",{children:"Download"})]})]}),e.jsx("button",{className:"mobile-menu-item",onClick:()=>{g(),M(!1)},children:d==="light"?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})}),e.jsx("span",{children:"Dark Mode"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"5"}),e.jsx("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),e.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),e.jsx("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),e.jsx("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),e.jsx("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),e.jsx("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),e.jsx("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),e.jsx("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]}),e.jsx("span",{children:"Light Mode"})]})})]})]})}),l&&e.jsx("div",{className:"settings-modal-overlay",onClick:()=>u(!1),children:e.jsxs("div",{className:"settings-modal",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"settings-modal-header",children:[e.jsx("h2",{children:"Settings"}),e.jsx("button",{className:"settings-modal-close",onClick:()=>u(!1),"aria-label":"Close settings",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("div",{className:"settings-modal-content",children:e.jsx(ar,{})})]})})]})}const dr=`You are an AI assistant for ChatNote, a personal knowledge management application. Your role is to help users organize, understand, and work with their notes and documents.

## Core Principles

1. **Be helpful, accurate, and concise**
2. **Think step by step before answering**
3. **Use available context (PDF documents, web search) when relevant**
4. **Break down complex tasks into manageable steps**

## Prompting Quick Rules

- Set the **role** first (helpful, adaptive assistant) and mirror the user's tone and formality
- Give crisp **instructions** as bullet points; put must-do items first
- Add **context** only when it is needed; avoid over-stuffing the prompt
- Keep **input** clearly delimited (e.g., triple backticks or <<< >>>) when long
- Define **expected output** with a short schema or tiny example when structure matters
- Ask **at most one** short clarifying question; otherwise answer directly
- Prefer structured outputs (JSON, bullet lists, tables) when the user needs reliable formatting
- Keep temperature moderate (about 0.5-0.65) unless the task explicitly needs more creativity

### Quick Parameter Presets
- Factual/structured (JSON, extraction): temp 0.2, top_p 0.9, stop optional (e.g., '###' if you cue it), consider seed for determinism
- Math/reasoning: temp 0.35-0.5, top_p 0.9, raise max tokens if proof is long
- Creative/brainstorm: temp 0.7-0.85, top_p 0.95-1.0, keep answers concise unless user asks for long form
- Long-form code: temp 0.3, top_p 0.85, stop on language-appropriate delimiters if needed
- If you set temperature, avoid also setting top_p unless a preset above calls for it

### OpenAI-Style Persona (migration helper)
- Flexible persona: 'I am a helpful, adaptive assistant that mirrors your tone and formality.'
- Tone mirroring: adjust vocabulary and sentence length to match the user
- Follow-up policy: ask exactly one short clarifying question only when truly needed; otherwise answer directly
- Tool use: may call search for factual queries and code execution for computations when available
- Visual aid preference: offer diagrams when they improve understanding
- Limit probing: do not ask for confirmation after every step unless instructions are ambiguous
- Safety: respect local laws and organizational policies; refuse prohibited content

### Pattern Chooser (ChatNote quick reference)
- Zero-shot: simple Q&A, quick summaries, direct answers
- Few-shot: schema-locked JSON or tables, custom labels, edge cases
- Chain-of-thought: multi-step math/logic; keep temp low (0.35-0.5)
- ReAct: needs tools (search/code) for fresh facts or calculations; think-act-observe cycles
- CoVe (verify): high-stakes or ambiguous outputs; plan checks then revise
- Chain-of-density: concise but info-dense summaries (notifications, briefs)

## Response Process

When a user asks a question or requests help, follow this process:

### Step 1: Analyze the Request

First, determine:
- **Does this require real-time/current information?** (e.g., weather, news, stock prices, current events)
  - If yes â†’ Web search is needed
- **Does this relate to uploaded PDF documents?** 
  - If yes â†’ Use PDF context if available
- **Is this a simple factual question?**
  - If yes â†’ Answer directly or use web search if needed
- **Is this a complex task?**
  - If yes â†’ Proceed to Step 2

### Step 2: Break Down Complex Tasks

For complex tasks (e.g., "analyze this document", "create a summary", "compare these concepts"), break them into subtasks:

1. **Identify the main goal**
2. **List required steps/subtasks**
3. **Prioritize the steps**
4. **Execute each step systematically**
5. **Synthesize the results**

Example for "Analyze this document":
- Step 1: Read and understand the document structure
- Step 2: Identify key themes and topics
- Step 3: Extract important information
- Step 4: Summarize findings
- Step 5: Provide insights or recommendations

### Step 3: Use Available Resources

**Web Search:**
- Use web search for real-time information, current events, or when you need up-to-date data
- When web search results are provided, extract and use the actual information from them
- Cite sources when available

**PDF Context:**
- When PDF content is provided, use it as the primary source
- Reference specific parts of the document when relevant
- Combine PDF context with web search if needed for comprehensive answers

**General Knowledge:**
- Use your training knowledge for general questions
- Acknowledge when information might be outdated and suggest web search

### Step 4: Structure Your Response

For complex answers, structure them clearly:

1. **Brief summary** (1-2 sentences)
2. **Main content** (organized by subtasks if applicable)
3. **Key takeaways** (if relevant)
4. **Sources** (if web search was used)

### Step 5: Quality Check

Before finalizing your response:
- âœ… Is the answer accurate and relevant?
- âœ… Did I use available context appropriately?
- âœ… Is the response clear and well-organized?
- âœ… Did I break down complex tasks properly?
- âœ… Are sources cited when using web search?

## Special Instructions

### For Weather Queries
- Always use web search for current weather
- Extract actual temperature, conditions, and forecasts from search results
- If search results only contain links, acknowledge that and describe what those weather sites provide

### For Document Analysis
- Read the entire document context carefully
- Identify key sections and themes
- Provide structured analysis with clear sections

### For Task Breakdown
- When a task has multiple steps, explicitly list them
- Execute steps in logical order
- Show progress as you work through subtasks

### For Web Search Results
- **Always extract and use actual information from search results**
- **You receive results from BOTH Wikipedia and web search - use information from both sources**
- Don't say "information is not provided" if it exists in the search results
- If results are links to websites, describe what those sites provide
- **ALWAYS cite sources with URLs** - include Wikipedia URLs and web search URLs in your response
- Format sources clearly: "Sources: [URL1], [URL2], [URL3]"
- Provide direct answers - avoid asking questions unless information is truly insufficient

### For Ambiguous Queries (Multiple Matches)
- **If the router detected ambiguity BEFORE searching, a clarification question was already asked**
- **When you receive search results with multiple matches, try to answer directly if one option is clearly most relevant**
- Only ask for clarification if the results are truly ambiguous and you cannot determine which one
- When answering, always include sources (URLs) from both Wikipedia and web search
- Example good response: "Based on the search results, [Name] appears to be [description]. Sources: [URL1], [URL2]"
- Avoid asking follow-up questions unless absolutely necessary - provide the best answer you can with available information

## Response Format

- Use clear, concise language
- Break up long responses with headings or bullet points
- Use markdown formatting when helpful (bold, lists, etc.)
- Be conversational but professional

### Mathematical Notation with KaTeX

**CRITICAL: This application uses KaTeX to render math. Math rendering FAILS easily. Follow these STRICT rules:**

**GOLDEN RULE: When in doubt, DO NOT use math mode. Use plain text instead.**

**Basic Syntax (STRICT):**
1. Inline math: Single dollar sign, expression, single dollar sign (NO spaces after/before dollar signs)
2. Display math: Double dollar signs on their own line, equation on next line, double dollar signs on line after
3. ONLY use dollar signs as delimiters - NEVER use backslash-parenthesis or backslash-bracket
4. ONLY use the commands listed in "Safe KaTeX Commands" below
5. ANY command not listed below will likely FAIL

**CRITICAL - Math Delimiters:**
- âœ… ONLY use dollar signs: dollar-sign x dollar-sign for inline, double-dollar-sign for display
- âŒ NEVER use backslash-( and backslash-) - these will break rendering
- âŒ NEVER use backslash-[ and backslash-] - these will break rendering
- âŒ NEVER mix dollar signs with backslash delimiters like backslash-) dollar-sign
- âœ… Example correct: "answer in dollar-sign x dollar-sign" 
- âŒ Example wrong: "answer in backslash-( x backslash-)" or "answer in backslash-) dollar-sign"

**CRITICAL: Numbers and Text - DO NOT PUT THESE IN MATH MODE:**
- âŒ NEVER EVER use dollar signs around numbers with commas: dollar-sign 42,500 dollar-sign WILL FAIL
- âŒ NEVER put numbers with commas inside ANY math expression, even in parentheses: dollar-sign f(37,500) dollar-sign WILL FAIL
- âŒ NEVER use dollar signs around regular numbers with decimal points in text context
- âŒ NEVER use backslash-text unless absolutely critical (it often breaks)
- âŒ NEVER use backslash-bigl, backslash-bigr, backslash-left, backslash-right (these break in KaTeX)
- âŒ NEVER use complex bracket sizing commands
- âŒ If a number has a comma anywhere in your expression, DO NOT use math mode at all

**How to Write Numbers (CRITICAL):**
- Regular numbers: ALWAYS use plain text
  - âœ… "The value is 42,500" (plain text, NO dollar signs)
  - âœ… "The price is 37,700 dollars" (plain text)
  - âœ… "Point forecast for luxury = 0 is (37,500)" (ALL plain text, no dollar signs anywhere)
  - âŒ "The value is dollar-sign 42,500 dollar-sign" (WILL FAIL)
  - âŒ "Point forecast for luxury = dollar-sign 0 dollar-sign is dollar-sign (37,500) dollar-sign" (WILL FAIL)
- Number ranges: ALWAYS use plain text
  - âœ… "between 30,000 and 46,000" (plain text)
  - âœ… "from 10.415 to 10.635" (plain text)
  - âŒ Using any math mode for number ranges (WILL FAIL)
- Mathematical calculations with actual numbers: Remove commas OR use plain text
  - âœ… "42,500 plus-or-minus 1,000" (plain text, preferred)
  - âœ… dollar-sign x = 42500 dollar-sign (no comma, only if needed)
  - âŒ dollar-sign 42,500 dollar-sign (WILL FAIL)
  - âŒ dollar-sign f(42,500) dollar-sign (WILL FAIL - comma in parentheses)

**Safe KaTeX Commands (ONLY USE THESE):**
- Variables and simple expressions: dollar-sign x dollar-sign, dollar-sign y = 2 dollar-sign
- Greek letters (MUST be inside dollar signs): dollar-sign backslash-alpha dollar-sign, dollar-sign backslash-beta dollar-sign, dollar-sign backslash-sigma dollar-sign, dollar-sign backslash-mu dollar-sign, dollar-sign backslash-pi dollar-sign
  - âœ… CORRECT: "The mean is dollar-sign backslash-mu dollar-sign"
  - âœ… CORRECT: dollar-sign P(backslash-mu underscore 1 backslash-sigma < Y) dollar-sign
  - âŒ WRONG: "The mean is backslash-mu" (backslash-mu NOT in dollar signs)
  - âŒ WRONG: "P(backslash-mu backslash-sigma < Y)" (Greek letters need dollar signs)
- Superscript/subscript: x caret 2, x underscore i, x caret curly-brace n+1 curly-brace
  - **IMPORTANT**: When combining subscript AND superscript, ALWAYS use curly braces:
    - âœ… dollar-sign x underscore curly-brace i curly-brace caret curly-brace 2 curly-brace dollar-sign (for x_i^2)
    - âœ… dollar-sign backslash-varepsilon underscore curly-brace i curly-brace caret curly-brace 2 curly-brace dollar-sign
    - âŒ NEVER write: dollar-sign x underscore i caret 2 dollar-sign (missing braces causes rendering issues)
- Simple fractions: backslash-frac curly-brace a curly-brace curly-brace b curly-brace
  - **IMPORTANT**: Always use curly braces for both numerator and denominator
    - âœ… dollar-sign backslash-frac curly-brace 1 curly-brace curly-brace n-2 curly-brace dollar-sign
    - âŒ NEVER write: dollar-sign backslash-frac 1 curly-brace n-2 curly-brace dollar-sign (missing numerator braces)
- Square root: backslash-sqrt curly-brace x curly-brace
- Basic operators: +, -, =, backslash-times, backslash-div, backslash-pm, backslash-neq
- Simple comparison: less-than, greater-than, backslash-leq, backslash-geq, backslash-approx (use carefully)
- Basic calculus and summation: backslash-int, backslash-sum underscore curly-brace i=1 curly-brace caret curly-brace n curly-brace
  - **IMPORTANT**: Summation must have proper brace wrapping:
    - âœ… dollar-sign backslash-sum underscore curly-brace i=1 curly-brace caret curly-brace N curly-brace backslash-varepsilon underscore curly-brace i curly-brace caret curly-brace 2 curly-brace dollar-sign
    - âœ… Use backslash-varepsilon (not backslash-epsilon) for the epsilon symbol
    - âŒ NEVER write: dollar-sign backslash-sum_{i=1}^N (incorrect brace format - must be curly-brace curly-brace format)
- Simple parentheses: Use regular parentheses ( ) only, NOT backslash-bigl or backslash-bigr

**UNSAFE Commands (DO NOT USE - THEY WILL FAIL):**
- âŒ backslash-bigl, backslash-bigr, backslash-Bigl, backslash-Bigr (use regular parentheses instead)
- âŒ backslash-left, backslash-right (use regular brackets instead)
- âŒ backslash-text with complex content (minimize use, often breaks)
- âŒ Any spacing commands: backslash-; (thin space), backslash-: (medium space), backslash-quad, backslash-qquad (these break in KaTeX)
- âŒ Any command with "big", "Big", "bigg", "Bigg" in it
- âŒ Complex array or matrix environments (keep simple)
- âŒ Custom spacing commands
- âŒ Any LaTeX package-specific commands
- âŒ Never use semicolons inside math expressions: "backslash-pm;" will FAIL - just use "backslash-pm"

**Safe Writing Patterns:**

For equations with variables:
double-dollar-sign
y = backslash-alpha x + backslash-beta
double-dollar-sign

For simple inline formulas:
"where dollar-sign x = 0.5 dollar-sign"

For statistical notation:
"with dollar-sign backslash-sigma = 0.10 dollar-sign"

For functions (if simple):
dollar-sign f(x) = x caret 2 + 1 dollar-sign

**UNSAFE Writing Patterns (DO NOT DO THIS):**

âŒ Mixing text and numbers in math mode:
"dollar-sign backslash-text when luxury = 0.5 dollar-sign"

âŒ Using big brackets:
"dollar-sign backslash-bigl[ backslash-exp(10.415) backslash-bigr] dollar-sign"

âŒ Numbers with commas in math:
"dollar-sign 42,500 dollar-sign"

âŒ Complex expressions with backslash-text:
"dollar-sign x backslash-text to y dollar-sign"

âŒ Spacing commands in math mode:
"dollar-sign backslash-pm; 2.0 backslash-times 28,000 dollar-sign" (WRONG - semicolon breaks it, comma breaks it)

**Correct Version:**
"dollar-sign backslash-pm 2.0 backslash-times 28000 dollar-sign plus-or-minus 28,000 (plain text for the final number with comma)"

âŒ Never put punctuation after operators:
"dollar-sign backslash-pm; dollar-sign" (WRONG)
"dollar-sign backslash-div, dollar-sign" (WRONG)

**BEST PRACTICE - Follow This Pattern:**

1. Write your response in plain text first
2. Only add dollar signs around TRUE mathematical notation (variables, Greek letters, simple formulas)
3. Leave ALL numbers as plain text unless they are part of a simple formula like dollar-sign x = 5 dollar-sign
4. If you're not sure if something will render, use plain text instead
5. Test mentally: "Is this a mathematical expression or just a number?" If just a number, NO dollar signs

**When Math Mode IS Required (MUST use dollar signs):**
- âœ… Variables with subscripts: dollar-sign x underscore 0 dollar-sign, dollar-sign y underscore i dollar-sign
- âœ… Variables with hats/tildes: dollar-sign backslash-hat y dollar-sign, dollar-sign backslash-hat backslash-beta dollar-sign
- âœ… Greek letters (ALWAYS in dollar signs): dollar-sign backslash-sigma caret 2 dollar-sign, dollar-sign backslash-mu dollar-sign, dollar-sign backslash-alpha dollar-sign
  - Example: "The mean dollar-sign backslash-mu dollar-sign equals..." NOT "The mean backslash-mu equals..."
  - Example: dollar-sign P(backslash-mu underscore 1 backslash-sigma < Y) dollar-sign for probability statements
- âœ… Formulas with operators: dollar-sign y = backslash-beta underscore 0 + backslash-beta underscore 1 x dollar-sign
- âœ… Fractions with variables: dollar-sign backslash-frac curly-brace 1 curly-brace curly-brace n-2 curly-brace dollar-sign
- âœ… Summations: dollar-sign backslash-sum underscore curly-brace i=1 curly-brace caret curly-brace n curly-brace dollar-sign
- âœ… Square roots with expressions: dollar-sign backslash-sqrt curly-brace x caret 2 + 1 curly-brace dollar-sign
- âœ… Statistical notation: dollar-sign t underscore curly-brace backslash-alpha/2, n-2 curly-brace dollar-sign

**Common Errors to Avoid:**
- âŒ Greek letters without dollar signs: "The mean backslash-mu" (WRONG - backslash-mu shows literally)
  - âœ… CORRECT: "The mean dollar-sign backslash-mu dollar-sign"
- âŒ Writing LaTeX commands without dollar signs: "hat y_0" should be dollar-sign backslash-hat y underscore 0 dollar-sign
- âŒ Combining subscript and superscript without curly braces: dollar-sign x underscore i caret 2 dollar-sign
  - âœ… CORRECT: dollar-sign x underscore curly-brace i curly-brace caret curly-brace 2 curly-brace dollar-sign
- âŒ Fractions with missing braces: dollar-sign backslash-frac 1 curly-brace n-2 curly-brace dollar-sign
  - âœ… CORRECT: dollar-sign backslash-frac curly-brace 1 curly-brace curly-brace n-2 curly-brace dollar-sign
- âŒ Greek letter with subscript/superscript missing braces: dollar-sign backslash-sigma caret 2 dollar-sign
  - âœ… CORRECT: dollar-sign backslash-sigma caret curly-brace 2 curly-brace dollar-sign

**Specific Statistical Formula Examples (COPY THESE PATTERNS):**

For variance formula:
double-dollar-sign
backslash-sigma caret curly-brace 2 curly-brace = backslash-frac curly-brace 1 curly-brace curly-brace N curly-brace backslash-sum underscore curly-brace i=1 curly-brace caret curly-brace N curly-brace backslash-varepsilon underscore curly-brace i curly-brace caret curly-brace 2 curly-brace
double-dollar-sign

For probability with Greek letters and subscripts:
dollar-sign P(backslash-mu underscore curly-brace 1 curly-brace backslash-sigma < Y) dollar-sign

For squared errors:
dollar-sign backslash-varepsilon underscore curly-brace i curly-brace caret curly-brace 2 curly-brace dollar-sign
- âŒ Random characters before math: "backslash-h3 backslash-sigma" should be dollar-sign backslash-sigma caret 2 dollar-sign
- âŒ Forgetting dollar signs around any Greek letter or special symbol
- âŒ Mixing dollar-sign and triple-dollar-sign incorrectly
- âŒ Not wrapping subscripts/superscripts with multiple characters in braces: "x_i+1" should be "x underscore curly-brace i+1 curly-brace"

**Example - CORRECT way to explain math with numbers:**

"The point forecast when luxury = 0.5 is given by:

dollar-sign y = backslash-exp(10.525) backslash-times 0.5 caret 0.10 dollar-sign

which equals approximately 37,700 dollars.

The 95% prediction interval for a future car with the same luxury index is [10.415, 10.635] on the log scale, which translates to approximately [30,000, 42,500] in dollars."

Notice: Numbers with commas are ALWAYS in plain text, NEVER in math mode.

## Response Length Guidelines

**IMPORTANT: Keep responses within token limits to ensure complete answers are delivered.**

- **For simple questions**: Provide direct, concise answers (typically 50-200 tokens)
- **For moderate questions**: Aim for 200-800 tokens - be thorough but focused
- **For complex tasks**: Structure your response to stay within 2000-3000 tokens maximum
- **If a response is getting long**: 
  - Prioritize the most important information first
  - Use bullet points and headings to organize content efficiently
  - Provide a summary at the beginning if the full answer is extensive
  - If you're approaching the token limit, conclude with key takeaways rather than cutting off mid-sentence
- **Always complete your thoughts**: If you're running out of tokens, provide a clear conclusion rather than leaving the response incomplete
- **For very long topics**: Offer to continue in a follow-up response if needed, but always provide a complete answer to the core question within the token limit

## Example Workflow

**User:** "What's the weather today and should I bring an umbrella?"

**Your Process:**
1. **Analyze:** This requires real-time weather information â†’ Web search needed
2. **Search:** Use web search to get current weather
3. **Extract:** Get temperature, conditions, and forecast from search results
4. **Reason:** Determine if umbrella is needed based on forecast
5. **Respond:** 
   - Current weather conditions
   - Forecast for today
   - Recommendation about umbrella
   - Sources (weather websites)

Remember: Think step by step, use available resources, and provide high-quality, helpful responses.`;function Gn(t){return t.includes("gpt-oss")||t.includes("qwen")?"Always response with emojis and with visualizations if applicable.":t.includes("kimi")||t.includes("llama")?"Always response with emojis":""}function Qn({mode:t,onModeChange:s,disabled:n=!1}){const[r,i]=a.useState(!1),[c,d]=a.useState(0),[g,E]=a.useState(!1),[f,p]=a.useState(!1),l=a.useRef(null),u=a.useRef(null),m=["auto","quick","thinking"],M={auto:"Auto",quick:"Quick",thinking:"Thinking"},y={auto:"ChatNote auto-selects between quick and thinking for you",quick:"Fast answers with lightweight models",thinking:"For deep reasoning, tool use, and citations (no image uploads)"},A=a.useCallback(()=>{const h=m.indexOf(t),w=l.current?.offsetWidth||80,N=u.current?.offsetWidth||20,H=(w-4-N)/(m.length-1);return h*H},[t]),j=h=>{n||(i(!0),E(!1),d(h.clientX),h.preventDefault(),h.stopPropagation())},x=a.useCallback(h=>{if(!r||n)return;const w=h.clientX-c;Math.abs(w)>3&&E(!0);const N=l.current?.offsetWidth||80,R=u.current?.offsetWidth||20,$=4,L=(N-$-R)/(m.length-1),Y=l.current?.getBoundingClientRect();if(!Y)return;const q=h.clientX-Y.left-$/2-R/2,ne=Math.round(q/L),re=Math.max(0,Math.min(m.length-1,ne)),ce=m[re];ce!==t&&s(ce)},[r,n,c,t,s]),S=a.useCallback(()=>{if(r&&(i(!1),!g)){const w=(m.indexOf(t)+1)%m.length;s(m[w])}},[r,g,t,s]);a.useEffect(()=>{if(r)return document.addEventListener("mousemove",x),document.addEventListener("mouseup",S),()=>{document.removeEventListener("mousemove",x),document.removeEventListener("mouseup",S)}},[r,x,S]);const P=h=>{if(n||r)return;const w=l.current?.getBoundingClientRect();if(!w)return;const N=h.clientX-w.left,R=w.width,$=u.current?.offsetWidth||20,H=4,Y=(R-H-$)/(m.length-1),q=N-H/2-$/2,ne=Math.round(q/Y),re=Math.max(0,Math.min(m.length-1,ne)),ce=m[re];ce!==t&&s(ce)},b=A();return e.jsxs("div",{className:"model-mode-toggle-wrapper",children:[e.jsx("div",{ref:l,className:`model-mode-toggle ${t} ${n?"disabled":""} ${r?"dragging":""}`,onMouseDown:j,onClick:P,children:e.jsx("div",{className:"model-mode-toggle-track",children:e.jsx("div",{ref:u,className:"model-mode-toggle-button",style:{transform:`translateX(${b}px)`,transition:r?"none":"transform 0.3s ease"}})})}),e.jsx("div",{className:"model-mode-toggle-label",children:M[t]}),e.jsxs("div",{className:"model-mode-info-icon-wrapper",onMouseEnter:()=>p(!0),onMouseLeave:()=>p(!1),children:[e.jsxs("svg",{className:"model-mode-info-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]}),f&&e.jsx("div",{className:"model-mode-tooltip",children:y[t]})]})]})}function ur(t){return t=t.replace(/\\(pm|times|div|approx|leq|geq|neq|pm|mp|ast);/g,"\\$1"),t=t.replace(/(\$\$?[^$]*\d+),(\d{3}[^$]*\$\$?)/g,"$1$2"),t=t.replace(/(\$\$?)([^$]*\d),(\s*\$\$?)/g,"$1$2$3"),t=t.replace(/\\[;:]/g," "),t=t.replace(/\\quad\b/g," "),t}function ft(t){if(!t||typeof t!="string")return"";let n=ur(t).replace(/[\u2000-\u200B\u202F\u205F\u3000]/g," ");n=n.replace(/\u2011/g,"-"),n=n.replace(/(<[^>]*>)([^<]*)(<\/[^>]*>)/g,(h,w,N,R)=>{const $=N.replace(/\u2011/g,"-");return $!==N?w+$+R:h}),n=n.replace(/[\u2013\u2014]/g,"-"),n=n.replace(/[\u2018\u2019]/g,"'"),n=n.replace(/[\u201C\u201D]/g,'"'),n=n.replace(/\n{4,}/g,`


`),n=n.replace(/\$\$[\s\S]*?\$\$/g,h=>h.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-")),n=n.replace(/\$[^$\n]+?\$/g,h=>h.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-"));const r=[],i=h=>`__MATH_PLACEHOLDER_${h}__`;n=n.replace(/\$\$[\s\S]*?\$\$/g,h=>{const w=h.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return r.push(w),i(r.length-1)}),n=n.replace(/\\\(([\s\S]*?)\\\)/g,(h,w)=>{let N=w.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");N=N.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const R=`$${N}$`;return r.push(R),i(r.length-1)}),n=n.replace(/\$[^$\n]+?\$/g,h=>{const w=h.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");return r.push(w),i(r.length-1)}),n=n.replace(/\\\[([\s\S]*?)\\\]/g,(h,w)=>{let N=w.replace(/\u2011/g,"-").replace(/[\u2013\u2014]/g,"-");N=N.replace(/(\d+)\{,\}(\d+)/g,"$1,$2");const R=`$$${N}$$`;return r.push(R),i(r.length-1)});const c=[],d=/\(([^()]*?(?:[\\_^]|\\[a-zA-Z@]+\{[^}]*\}|\\pm|\\sim|\\times|\\div|\\sqrt|\\frac|\\text\{|\\approx|\\leq|\\geq|\\neq|\\sum|\\int|\\prod|=\s*\\[a-zA-Z@]+|~\s*\\[a-zA-Z@]+)[^()]*?)\)/g;let g;for(;(g=d.exec(n))!==null;){const h=g[0],w=g.index,N=w>0?n[w-1]:"",R=w+h.length<n.length?n[w+h.length]:"";N==="$"&&R==="$"||n.substring(Math.max(0,w-2),w).includes("](")||N==="`"||R==="`"||n.substring(Math.max(0,w-10),w+h.length+10).includes("__MATH_PLACEHOLDER")||c.push({match:h,index:w})}const E=[],f=/\\[a-zA-Z@]+(?:_[a-zA-Z0-9{}]+|\^[a-zA-Z0-9{}]+)?\s*[~Â±â‰¤â‰¥â‰ â‰ˆ=]\s*[^.,;:!?\n]{5,150}?(?=\s|$|[.,;:!?]|\\[a-zA-Z@]|_[a-zA-Z0-9]|\^[a-zA-Z0-9])/g;let p;for(;(p=f.exec(n))!==null;){const h=p.index;let w=p[0];const N=Math.max(w.indexOf("~"),w.indexOf("="),w.indexOf("Â±"),w.indexOf("â‰¤"),w.indexOf("â‰¥"),w.indexOf("â‰ "),w.indexOf("â‰ˆ"));if(N===-1||N===w.length-1)continue;const R=w.substring(N+1);if(!/\\[a-zA-Z@]+|_[a-zA-Z0-9{}]|\^[a-zA-Z0-9{}]/.test(R))continue;const $=/[.,;:!?]/.exec(w);$&&$.index>10&&$.index<w.length-5&&(w=w.substring(0,$.index+1));const H=h>0?n[h-1]:"",L=h+w.length<n.length?n[h+w.length]:"";if(H==="$"||L==="$"||H==="`"||L==="`"||n.substring(Math.max(0,h-10),h+w.length+10).includes("__MATH_PLACEHOLDER"))continue;!c.some(q=>{const ne=q.index,re=ne+q.match.length;return h>=ne&&h+w.length<=re})&&w.length>10&&E.push({match:w,index:h})}const l=[],u=(h,w)=>{let N=0,R=w;for(;R<h.length;){if(h[R]==="{")N++;else if(h[R]==="}"&&(N--,N===0))return R+1;R++}return-1},m=/\\sqrt\[[^\]]+\](?=\{)/g;let M;for(;(M=m.exec(n))!==null;){const h=M.index,w=h+M[0].length;if(n[w]==="{"){const N=u(n,w);if(N!==-1){const R=n.substring(h,N),$=h>0?n[h-1]:"",H=N<n.length?n[N]:"";$!=="$"&&H!=="$"&&!n.substring(Math.max(0,h-10),N+10).includes("__MATH_PLACEHOLDER")&&l.push({match:R,index:h})}}}const y=/\\(sqrt|frac|text|overline|underline)(?=\{)/g;let A;for(;(A=y.exec(n))!==null;){const h=A.index,w=A[1],N=h+A[0].length;if(n[N]==="{")if(w==="frac"){const R=u(n,N);if(R===-1||n[R]!=="{")continue;const $=u(n,R);if($===-1)continue;const H=n.substring(h,$),L=h>0?n[h-1]:"",Y=$<n.length?n[$]:"";L!=="$"&&Y!=="$"&&!n.substring(Math.max(0,h-10),$+10).includes("__MATH_PLACEHOLDER")&&l.push({match:H,index:h})}else{const R=u(n,N);if(R===-1)continue;const $=n.substring(h,R),H=h>0?n[h-1]:"",L=R<n.length?n[R]:"";H!=="$"&&L!=="$"&&!n.substring(Math.max(0,h-10),R+10).includes("__MATH_PLACEHOLDER")&&(c.some(q=>{const ne=q.index,re=ne+q.match.length;return h>=ne&&R<=re})||E.some(q=>{const ne=q.index,re=ne+q.match.length;return h>=ne&&R<=re})||l.push({match:$,index:h}))}}n=n.replace(/(\$?\s*)(\d{1,3}(?:\s+\d{3})+)(\b)/g,(h,w,N,R)=>{const $=N.replace(/\s+/g,",");return w.trim().startsWith("$")?`$${$}$${R}`:w+$+R}),n=n.replace(/\$(\d{1,3}(?:,\d{3})+)(?![$])/g,(h,w,N,R)=>{if((N>0?R[N-1]:"")==="$")return h;const H=N+h.length;if(H<R.length&&R[H]==="$")return h;const L=H<R.length?R[H]:"";return L===" "||/[.,;:!?)]/.test(L)?`$${w}$${L}`:`$${w}$`});const j=/(\d+)\{,\}(\d+)/g,x=[];let S;for(;(S=j.exec(n))!==null;){const h=S.index,w=S[0],N=h>0?n[h-1]:"",R=h+w.length<n.length?n[h+w.length]:"";if(N==="$"||R==="$"||n.substring(Math.max(0,h-10),h+w.length+10).includes("__MATH_PLACEHOLDER"))continue;let $=h;for(;$>0&&/\d/.test(n[$-1]);)$--;let H=h+w.length;for(;H<n.length&&/\d/.test(n[H]);)H++;const L=n.substring($,H),Y=Math.max(0,$-5),q=n.substring(Y,$),ne=n.substring(H,Math.min(n.length,H+5));x.push({numberPart:L,fullMatch:L,startIndex:$,endIndex:H,prefix:q,suffix:ne})}const P=[...c.map(h=>({...h,type:"parentheses"})),...E.map(h=>({...h,type:"expression"})),...l.map(h=>({...h,type:"complex"})),...x.map(h=>({match:h.fullMatch,index:h.startIndex,type:"thousand",isThousand:!0,replacement:h.numberPart.replace(/\{,\}/g,",")}))].sort((h,w)=>h.index-w.index),b=[];for(let h=0;h<P.length;h++){const w=P[h];let N=!1;for(let R=0;R<b.length;R++){const $=b[R],H=w.index+w.match.length,L=$.index+$.match.length;if(w.index<L&&H>$.index){w.match.length>$.match.length&&(b[R]=w),N=!0;break}}N||b.push(w)}b.sort((h,w)=>w.index-h.index);for(const h of b){const w=n.substring(0,h.index),N=n.substring(h.index+h.match.length);if(h.type==="thousand"){const R=h.replacement;n=w+`$${R}$`+N}else n=w+`$${h.match}$`+N}return r.forEach((h,w)=>{n=n.replace(i(w),h)}),n}const hr="/ChatNote/assets/chatnote-icon-BQXPxUrH.svg";function gr({onModeSelect:t,disabled:s=!1}){const[n,r]=a.useState(null);return e.jsxs("div",{className:"interaction-mode-selector",children:[e.jsxs("div",{className:"mode-selector-header",children:[e.jsx("h2",{children:"How would you like to learn today?"}),e.jsx("p",{children:"Choose your preferred learning experience"})]}),e.jsxs("div",{className:"mode-cards",children:[e.jsxs("button",{className:`mode-card ${n==="guide-me-learn"?"hovered":""}`,onClick:()=>!s&&t("guide-me-learn"),onMouseEnter:()=>r("guide-me-learn"),onMouseLeave:()=>r(null),disabled:s,children:[e.jsx("div",{className:"mode-icon guide-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M12 2L2 7L12 12L22 7L12 2Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M2 17L12 22L22 17",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M2 12L12 17L22 12",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsx("h3",{children:"Guide Me Learn"}),e.jsx("p",{children:"Interactive learning with AI tutor assistance"}),e.jsxs("ul",{className:"mode-features",children:[e.jsx("li",{children:"ðŸ’¬ Chat with AI about PDF"}),e.jsx("li",{children:"ðŸ“– Get detailed explanations"}),e.jsx("li",{children:"ðŸ’¡ Ask questions anytime"}),e.jsx("li",{children:"ðŸ” Deep dive into any topic"})]}),e.jsx("div",{className:"mode-action",children:"Start Learning â†’"})]}),e.jsxs("button",{className:`mode-card ${n==="quiz-me"?"hovered":""}`,onClick:()=>!s&&t("quiz-me"),onMouseEnter:()=>r("quiz-me"),onMouseLeave:()=>r(null),disabled:s,children:[e.jsx("div",{className:"mode-icon quiz-icon",children:e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M9 11L12 14L22 4",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsx("h3",{children:"Quiz Me"}),e.jsx("p",{children:"Test your knowledge with AI-generated quizzes"}),e.jsxs("ul",{className:"mode-features",children:[e.jsx("li",{children:"ðŸŽ¯ Multiple types questions"}),e.jsx("li",{children:"ðŸ§  AI-powered generation"}),e.jsx("li",{children:"ðŸ“Š Track your progress"}),e.jsx("li",{children:"ðŸ”„ Request more questions"})]}),e.jsx("div",{className:"mode-action",children:"Take Quiz â†’"})]})]})]})}async function mr(t,s={}){const{count:n=10,difficulty:r="mixed",questionTypes:i=["multiple-choice"],focusPages:c}=s,d=Date.now(),g=Math.floor(Math.random()*1e4),E=`You are an expert quiz generator. Generate high-quality quiz questions based on the provided content.

IMPORTANT: Generate UNIQUE questions each time. Use varied topics, concepts, and difficulty levels across the content.
Generation ID: ${d}-${g}

Requirements:
- Generate exactly ${n} questions
- Difficulty: ${r}
- Question types: ${i.join(", ")}
- Each question must have clear, unambiguous answers
- For multiple choice: provide 4 options with only ONE correct answer
- For short answer: provide the correct answer text (NO options)
- For true/false: correctAnswer should be "true" or "false" (NO options)
- For fill-blank: provide the word/phrase that fills the blank (NO options)
- Include page references when possible
- Provide detailed explanations for correct answers
- Vary the topics and concepts tested - don't focus on the same areas

Return ONLY a valid JSON array of questions. Use these structures based on question type:

For multiple-choice:
{
  "id": "q1",
  "type": "multiple-choice",
  "question": "What is...",
  "options": [
    {"id": "a", "text": "Option A", "isCorrect": false},
    {"id": "b", "text": "Option B", "isCorrect": true},
    {"id": "c", "text": "Option C", "isCorrect": false},
    {"id": "d", "text": "Option D", "isCorrect": false}
  ],
  "correctAnswer": "b",
  "explanation": "The correct answer is B because...",
  "pageReference": 1,
  "difficulty": "medium"
}

For short-answer (NO options array):
{
  "id": "q2",
  "type": "short-answer",
  "question": "Explain the concept of...",
  "correctAnswer": "The expected answer text",
  "explanation": "A good answer should include...",
  "pageReference": 2,
  "difficulty": "medium"
}
NOTE: For short-answer questions, avoid answers that require typing math functions or complex formulas. Use simple text answers instead.

For true-false (NO options array):
{
  "id": "q3",
  "type": "true-false",
  "question": "Statement to evaluate...",
  "correctAnswer": "true",
  "explanation": "This is true/false because...",
  "pageReference": 3,
  "difficulty": "easy"
}

For fill-blank (NO options array):
{
  "id": "q4",
  "type": "fill-blank",
  "question": "The ____ is responsible for...",
  "correctAnswer": "nucleus",
  "explanation": "The nucleus is correct because...",
  "pageReference": 4,
  "difficulty": "medium"
}

IMPORTANT: 
- Do NOT include "options" field for short-answer, true-false, or fill-blank questions. Only multiple-choice questions should have options.
- Ensure all text fields use proper JSON escaping (escape quotes, backslashes, and newlines)
- Keep text clean and simple - avoid special characters that need escaping when possible
- Do not use literal newlines in text fields - use spaces instead

Focus on testing understanding, not just memorization.`,f=`Generate ${n} ${r} quiz questions from this content:

${c?`Focus on pages: ${c.join(", ")}

`:""}${t}`,p=6e3;let l=t;t.length>p&&(l=t.slice(0,p));let u=null;for(let m=0;m<kt.length;m++)for(let M=0;M<3;M++)try{const y=await sn([{role:"system",content:E},{role:"user",content:f.replace(t,l)}],kt[m]),A=typeof y=="string"?y:"";let j=A.match(/\[[\s\S]*\]/),x=j?j[0]:null;if(!x){const b=A.match(/\{[\s\S]*\}/);b&&(x=`[${b[0]}]`)}if(!x){console.error("No JSON array/object found in response:",A.substring(0,500)),u=new Error("Failed to parse quiz questions from AI response");continue}x=x.replace(/```json\s*/g,"").replace(/```\s*/g,""),x=x.replace(/\\n/g," ").replace(/\\t/g," ").replace(/\n/g," ").replace(/\t/g," ").replace(/\r/g," ");let S=[];try{S=JSON.parse(x)}catch(b){console.warn("JSON parse failed, attempting to fix:",b),x=x.replace(/,\s*([}\]])/g,"$1"),S=JSON.parse(x)}const P=S.map((b,h)=>{const w={id:b.id||`q${h+1}`,type:b.type||"multiple-choice",question:b.question,correctAnswer:b.correctAnswer,explanation:b.explanation,pageReference:b.pageReference,difficulty:b.difficulty||"medium"};return b.type==="multiple-choice"&&b.options&&(w.options=b.options),w}).filter(b=>b.question&&typeof b.question=="string"&&b.question.trim().length>0&&(b.type!=="multiple-choice"||Array.isArray(b.options)&&b.options.length>0));if(P.length>0)return P;console.warn(`Attempt ${M+1}: No valid questions, retrying...`)}catch(y){if(u=y,y?.message?.includes("rate limit")||y?.message?.includes("Payload Too Large")){console.warn("Model error, trying next fallback:",y?.message);break}break}throw console.error("Quiz generation error:",u),new Error("Failed to generate quiz. Please try again.")}async function pr(t,s){const n=localStorage.getItem("auth_token");if(!n)return{canGenerate:!1,error:"Authentication required"};try{const r=await fetch(`${pe}/api/quiz/generate`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({pdfText:t,options:s})});return r.ok?(await r.json(),{canGenerate:!0}):{canGenerate:!1,error:(await r.json()).error||"Failed to check quiz generation eligibility"}}catch(r){return console.error("Error checking quiz generation eligibility:",r),{canGenerate:!1,error:"Network error while checking quiz generation eligibility"}}}function pn(t,s){const r=(Array.isArray(t.correctAnswer)?t.correctAnswer:[t.correctAnswer]).some(c=>c.toLowerCase().trim()===s.toLowerCase().trim()),i=r?`âœ… Correct! ${t.explanation}`:`âŒ Incorrect. ${t.explanation}`;return{isCorrect:r,feedback:i}}function fr({questions:t,userAnswers:s,score:n,onAddToPDF:r,onAddToNotes:i,onRetake:c,onExit:d}){const g=t.length,E=Math.round(n/g*100),f=(l,u)=>{let m=u;if(l.type==="multiple-choice"&&l.options){const M=l.options.find(y=>y.id===u);m=M?M.text:u}return e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1}]],children:ft(m)})},p=l=>{let u="N/A";if(l.type==="multiple-choice"&&l.options){const m=l.options.find(M=>M.isCorrect);u=m?m.text:"N/A"}else Array.isArray(l.correctAnswer)?u=l.correctAnswer.join(", "):u=l.correctAnswer;return e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1}]],children:ft(u)})};return e.jsxs("div",{className:"quiz-review",children:[e.jsxs("div",{className:"review-header",children:[e.jsxs("div",{className:"score-summary",children:[e.jsxs("div",{className:"score-circle-small",children:[e.jsxs("svg",{viewBox:"0 0 120 120",children:[e.jsx("circle",{cx:"60",cy:"60",r:"54",fill:"none",stroke:"#e5e7eb",strokeWidth:"12"}),e.jsx("circle",{cx:"60",cy:"60",r:"54",fill:"none",stroke:"url(#reviewGradient)",strokeWidth:"12",strokeDasharray:`${E*3.39} 339`,strokeLinecap:"round",transform:"rotate(-90 60 60)"}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"reviewGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#667eea"}),e.jsx("stop",{offset:"100%",stopColor:"#764ba2"})]})})]}),e.jsx("div",{className:"score-text-small",children:e.jsxs("div",{className:"score-percentage-small",children:[E,"%"]})})]}),e.jsxs("div",{className:"summary-text",children:[e.jsx("h2",{children:"Quiz Review"}),e.jsxs("p",{className:"score-details",children:["You answered ",e.jsx("strong",{children:n})," out of ",e.jsx("strong",{children:g})," questions correctly"]}),e.jsxs("div",{className:"performance-badge",children:[E>=90&&"ðŸŒŸ Excellent Work!",E>=70&&E<90&&"ðŸ‘ Good Job!",E>=50&&E<70&&"ðŸ“š Keep Studying!",E<50&&"ðŸ’ª Practice More!"]})]})]}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{className:"action-btn secondary",onClick:c,children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M1 4V10H7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M3.51 15C4.15839 16.8404 5.38734 18.4202 7.01166 19.5014C8.63598 20.5826 10.5677 21.1066 12.5157 20.9945C14.4637 20.8824 16.3226 20.1402 17.8121 18.8798C19.3017 17.6193 20.3413 15.9089 20.7742 14.0064C21.2072 12.1038 21.0101 10.1119 20.2126 8.33111C19.4152 6.55029 18.0605 5.07462 16.3528 4.1235C14.6451 3.17238 12.6769 2.78949 10.7447 3.02841C8.81245 3.26733 7.02091 4.11638 5.64 5.45",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),"Retake Quiz"]}),e.jsxs("button",{className:"action-btn primary",onClick:d,children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M9 11L12 14L22 4",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),"Done"]})]})]}),e.jsx("div",{className:"questions-review-list",children:t.map((l,u)=>{const m=s.get(l.id)||"",y=pn(l,m).isCorrect;return e.jsxs("div",{className:`review-question-card ${y?"correct":"incorrect"}`,children:[e.jsxs("div",{className:"review-question-header",children:[e.jsxs("div",{className:"question-number-badge",children:["Question ",u+1,y?e.jsx("span",{className:"status-icon correct-icon",children:"âœ“"}):e.jsx("span",{className:"status-icon incorrect-icon",children:"âœ—"})]}),e.jsxs("div",{className:"question-meta",children:[e.jsx("span",{className:`difficulty-badge ${l.difficulty}`,children:l.difficulty}),l.pageReference&&e.jsxs("span",{className:"page-ref",children:["Page ",l.pageReference]})]})]}),e.jsx("div",{className:"review-question-text",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1}]],children:ft(l.question)})}),e.jsxs("div",{className:"answer-comparison",children:[e.jsxs("div",{className:`answer-box ${y?"correct-answer-box":"incorrect-answer-box"}`,children:[e.jsx("div",{className:"answer-label",children:"Your Answer"}),e.jsx("div",{className:"answer-content",children:m?f(l,m):e.jsx("span",{className:"no-answer",children:"No answer provided"})})]}),!y&&e.jsxs("div",{className:"answer-box correct-answer-box",children:[e.jsx("div",{className:"answer-label",children:"Correct Answer"}),e.jsx("div",{className:"answer-content",children:p(l)})]})]}),e.jsxs("div",{className:"review-explanation",children:[e.jsxs("div",{className:"explanation-label",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2"}),e.jsx("path",{d:"M12 16V12M12 8H12.01",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round"})]}),"Explanation"]}),e.jsx("div",{className:"explanation-content",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1}]],children:ft(l.explanation)})})]}),e.jsxs("div",{className:"review-question-actions",children:[e.jsxs("button",{className:"mini-action-btn",onClick:()=>r(l,m,y),title:"Add question and answer to PDF as annotation",children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M14 2V8H20",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M12 18V12M9 15H15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),"Add to PDF"]}),e.jsxs("button",{className:"mini-action-btn",onClick:()=>i(l,m,y),title:"Save question to Knowledge Notes",children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M19 21L12 16L5 21V5C5 4.46957 5.21071 3.96086 5.58579 3.58579C5.96086 3.21071 6.46957 3 7 3H17C17.5304 3 18.0391 3.21071 18.4142 3.58579C18.7893 3.96086 19 4.46957 19 5V21Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),"Save to Notes"]})]})]},l.id)})})]})}function xr({session:t,onAnswer:s,onNextQuestion:n,onPreviousQuestion:r,onRequestMore:i,onFinish:c,onRestart:d,onAddToPDF:g,onAddToNotes:E,onExitReview:f}){const[p,l]=a.useState(""),[u,m]=a.useState(!1),[M,y]=a.useState(!1),[A,j]=a.useState(!1),x=t.questions[t.currentQuestionIndex],S=t.currentQuestionIndex===t.questions.length-1,P=t.currentQuestionIndex===0,b=t.answers.has(x?.id||"");a.useEffect(()=>{const L=t.answers.get(x?.id||"");L&&b?(l(L),m(!0)):(l(""),m(!1))},[t.currentQuestionIndex,x?.id,b,t.answers]);const h=L=>{b||(l(L),s(x.id,L),m(!0))},w=()=>{S?c():n()},N=()=>{r()},R=(L,Y)=>{y(!1),i(L,Y)};if(!x)return e.jsx("div",{className:"quiz-interface",children:e.jsx("div",{className:"quiz-empty",children:e.jsx("h3",{children:"Loading quiz..."})})});if(t.isComplete){if(A)return e.jsx(fr,{questions:t.questions,userAnswers:t.answers,score:t.score,onAddToPDF:g||(()=>{}),onAddToNotes:E||(()=>{}),onRetake:()=>{j(!1),d()},onExit:()=>{j(!1),f&&f()}});const L=t.questions.length,Y=Array.from(t.answers.entries()).filter(([ne,re])=>{const ce=t.questions.find(ie=>ie.id===ne);return ce?pn(ce,re).isCorrect:!1}).length,q=Math.round(Y/L*100);return e.jsx("div",{className:"quiz-interface quiz-complete",children:e.jsxs("div",{className:"quiz-results",children:[e.jsxs("div",{className:"results-header",children:[e.jsx("div",{className:"trophy-icon",children:"ðŸ†"}),e.jsx("h2",{children:"Quiz Complete!"})]}),e.jsxs("div",{className:"score-circle",children:[e.jsxs("svg",{viewBox:"0 0 200 200",children:[e.jsx("circle",{cx:"100",cy:"100",r:"90",fill:"none",stroke:"#e5e7eb",strokeWidth:"20"}),e.jsx("circle",{cx:"100",cy:"100",r:"90",fill:"none",stroke:"url(#scoreGradient)",strokeWidth:"20",strokeDasharray:`${q*5.65} 565`,strokeLinecap:"round",transform:"rotate(-90 100 100)"}),e.jsx("defs",{children:e.jsxs("linearGradient",{id:"scoreGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"#667eea"}),e.jsx("stop",{offset:"100%",stopColor:"#764ba2"})]})})]}),e.jsxs("div",{className:"score-text",children:[e.jsxs("div",{className:"score-percentage",children:[q,"%"]}),e.jsxs("div",{className:"score-label",children:[Y," / ",L]})]})]}),e.jsxs("div",{className:"performance-label",children:[q>=90&&"ðŸŒŸ Excellent!",q>=70&&q<90&&"ðŸ‘ Good job!",q>=50&&q<70&&"ðŸ“š Keep studying!",q<50&&"ðŸ’ª Practice more!"]}),e.jsxs("div",{className:"results-actions review-actions",children:[e.jsxs("button",{className:"result-btn primary",onClick:()=>j(!0),children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M9 5H7C6.46957 5 5.96086 5.21071 5.58579 5.58579C5.21071 5.96086 5 6.46957 5 7V19C5 19.5304 5.21071 20.0391 5.58579 20.4142C5.96086 20.7893 6.46957 21 7 21H17C17.5304 21 18.0391 20.7893 18.4142 20.4142C18.7893 20.0391 19 19.5304 19 19V7C19 6.46957 18.7893 5.96086 18.4142 5.58579C18.0391 5.21071 17.5304 5 17 5H15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M9 5C9 4.46957 9.21071 3.96086 9.58579 3.58579C9.96086 3.21071 10.4696 3 11 3H13C13.5304 3 14.0391 3.21071 14.4142 3.58579C14.7893 3.96086 15 4.46957 15 5C15 5.53043 14.7893 6.03914 14.4142 6.41421C14.0391 6.78929 13.5304 7 13 7H11C10.4696 7 9.96086 6.78929 9.58579 6.41421C9.21071 6.03914 9 5.53043 9 5Z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M9 12H15M9 16H15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),e.jsx("span",{className:"btn-label",children:"Review Answers"})]}),e.jsxs("button",{className:"result-btn",onClick:d,children:[e.jsxs("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M1 4V10H7",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M23 20V14H17",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M20.49 9C19.9828 7.56678 19.1209 6.28536 17.9845 5.27541C16.8482 4.26546 15.4745 3.55977 13.9917 3.22426C12.5089 2.88875 10.9652 2.93434 9.50481 3.35677C8.04437 3.77921 6.71475 4.56471 5.64 5.64L1 10M23 14L18.36 18.36C17.2853 19.4353 15.9556 20.2208 14.4952 20.6432C13.0348 21.0657 11.4911 21.1112 10.0083 20.7757C8.52547 20.4402 7.1518 19.7345 6.01547 18.7246C4.87913 17.7146 4.01717 16.4332 3.51 15",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),e.jsx("span",{className:"btn-label",children:"Try Again"})]}),e.jsxs("button",{className:"result-btn",onClick:()=>y(!0),children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 5V19M5 12H19",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),e.jsx("span",{className:"btn-label",children:"More Questions"})]})]}),M&&e.jsxs("div",{className:"request-more-panel",children:[e.jsx("h4",{children:"Request More Questions"}),e.jsxs("div",{className:"more-options",children:[e.jsx("button",{onClick:()=>R(5),children:"+5 Mixed Questions"}),e.jsx("button",{onClick:()=>R(5,"multiple-choice"),children:"+5 Multiple Choice"}),e.jsx("button",{onClick:()=>R(10),children:"+10 Mixed Questions"})]})]})]})})}const $=t.answers.get(x.id),H=$?pn(x,$):null;return e.jsxs("div",{className:"quiz-interface",children:[e.jsxs("div",{className:"quiz-header",children:[e.jsxs("div",{className:"quiz-progress",children:[e.jsxs("div",{className:"progress-text",children:["Question ",t.currentQuestionIndex+1," of ",t.questions.length]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${(t.currentQuestionIndex+1)/t.questions.length*100}%`}})})]}),e.jsxs("div",{className:"quiz-score",children:["Score: ",t.score," / ",t.questions.length]})]}),e.jsxs("div",{className:"question-card",children:[e.jsxs("div",{className:"question-header",children:[e.jsx("span",{className:`difficulty-badge ${x.difficulty}`,children:x.difficulty}),x.pageReference&&e.jsxs("span",{className:"page-ref",children:["Page ",x.pageReference]})]}),e.jsx("div",{className:"question-text",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1}]],children:ft(x.question)})}),x.type==="multiple-choice"&&x.options&&e.jsx("div",{className:"options-list",children:x.options.map(L=>{const Y=p===L.id||$===L.id,q=L.isCorrect,ne=b&&q,re=b&&Y&&!q;return e.jsxs("button",{className:`option-btn ${Y?"selected":""} ${ne?"correct":""} ${re?"incorrect":""}`,onClick:()=>h(L.id),disabled:b,children:[e.jsx("div",{className:"option-letter",children:L.id.toUpperCase()}),e.jsx("div",{className:"option-text",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1}]],children:ft(L.text)})}),ne&&e.jsx("div",{className:"option-icon",children:"âœ“"}),re&&e.jsx("div",{className:"option-icon",children:"âœ—"})]},L.id)})}),x.type==="true-false"&&e.jsx("div",{className:"true-false-options",children:["true","false"].map(L=>{const Y=p===L||$===L,q=x.correctAnswer===L,ne=b&&q,re=b&&Y&&!q;return e.jsxs("button",{className:`tf-btn ${Y?"selected":""} ${ne?"correct":""} ${re?"incorrect":""}`,onClick:()=>h(L),disabled:b,children:[e.jsx("div",{className:"tf-icon",children:L==="true"?"âœ“":"âœ—"}),e.jsx("div",{className:"tf-text",children:L==="true"?"True":"False"}),ne&&e.jsx("div",{className:"option-icon",children:"âœ“"}),re&&e.jsx("div",{className:"option-icon",children:"âœ—"})]},L)})}),x.type==="short-answer"&&e.jsxs("div",{className:"short-answer-container",children:[e.jsx("textarea",{className:"short-answer-input",placeholder:"Type your answer here...",value:p,onChange:L=>l(L.target.value),disabled:b,rows:4}),!b&&e.jsx("button",{className:"submit-answer-btn",onClick:()=>h(p),disabled:!p.trim(),children:"Submit Answer"})]}),x.type==="fill-blank"&&e.jsxs("div",{className:"fill-blank-container",children:[e.jsx("input",{type:"text",className:"fill-blank-input",placeholder:"Type your answer...",value:p,onChange:L=>l(L.target.value),disabled:b}),!b&&e.jsx("button",{className:"submit-answer-btn",onClick:()=>h(p),disabled:!p.trim(),children:"Submit Answer"})]}),u&&H&&e.jsxs("div",{className:`explanation ${H.isCorrect?"correct":"incorrect"}`,children:[e.jsx("div",{className:"explanation-header",children:H.isCorrect?"âœ… Correct!":"âŒ Incorrect"}),e.jsx("div",{className:"explanation-text",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1}]],children:ft(x.explanation)})})]})]}),e.jsxs("div",{className:"quiz-navigation",children:[e.jsxs("button",{className:"nav-btn",onClick:N,disabled:P,children:[e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M15 18L9 12L15 6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),"Previous"]}),b&&e.jsxs("button",{className:"nav-btn primary",onClick:w,children:[S?"Finish Quiz":"Next Question",!S&&e.jsx("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M9 18L15 12L9 6",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})]})]}),e.jsx("button",{className:"request-more-btn",onClick:()=>y(!M),children:"+ Request More Questions"}),M&&e.jsxs("div",{className:"request-more-panel",children:[e.jsx("h4",{children:"Add More Questions"}),e.jsxs("div",{className:"more-options",children:[e.jsx("button",{onClick:()=>R(5),children:"+5 Questions"}),e.jsx("button",{onClick:()=>R(5,"multiple-choice"),children:"+5 Multiple Choice"}),e.jsx("button",{onClick:()=>R(10),children:"+10 Questions"})]})]})]})}const Yn={"multiple-choice":20,"true-false":30,"short-answer":15,"fill-blank":15,mixed:20};function yr({onStartQuiz:t,onBack:s,apiKeyStatus:n}){const[r,i]=a.useState(["multiple-choice"]),[c,d]=a.useState(10),g=n?.freeTrial&&!n.hasApiKey&&!n.isAdmin&&(n.freeTrial.quizGenerated||0)>=(n.freeTrial.quizLimit||1),E=y=>{switch(y){case"multiple-choice":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M9 11l3 3L22 4"}),e.jsx("path",{d:"M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"})]});case"true-false":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M9 12l2 2 4-4"}),e.jsx("path",{d:"M15 9l-6 6",opacity:"0.4"})]});case"short-answer":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"}),e.jsx("path",{d:"M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"})]});case"mixed":return e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("rect",{x:"3",y:"14",width:"7",height:"7"})]})}},f=[{value:"multiple-choice",label:"Multiple Choice",description:"Select from 4 options"},{value:"true-false",label:"True/False",description:"Binary choice questions"},{value:"short-answer",label:"Short Answer",description:"Brief written responses"},{value:"mixed",label:"Mixed",description:"Combination of types"}],p=()=>r.length===0?10:Math.min(...r.map(y=>Yn[y])),l=y=>{if(y==="mixed")i(["mixed"]),c<3&&d(3);else{const A=r.includes(y)?r.filter(j=>j!==y):[...r.filter(j=>j!=="mixed"),y];if(A.length===0)i(["multiple-choice"]);else{i(A);const j=A.length;c<j&&d(j)}}},u=y=>{const A=p(),j=r.includes("mixed")?3:Math.max(1,r.length);d(Math.min(Math.max(j,y),A))},m=()=>{const y=r.includes("mixed")?["multiple-choice","true-false","short-answer"]:r.filter(A=>A!=="mixed");t(c,y)},M=p();return e.jsxs("div",{className:`quiz-configuration ${g?"limit-reached":""}`,children:[e.jsxs("button",{className:"quiz-config-back",onClick:s,title:"Back to mode selection",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})}),"Back"]}),e.jsxs("div",{className:"quiz-config-header",children:[e.jsx("h2",{children:"Configure Your Quiz"}),e.jsx("p",{children:"Customize your learning experience"}),g&&e.jsx("div",{className:"quiz-limit-warning",children:"âš ï¸ You've reached your free trial quiz limit. Please add your own API key to generate more quizzes."})]}),e.jsxs("div",{className:"quiz-config-content",children:[e.jsxs("div",{className:"config-section",children:[e.jsx("h3",{children:"Question Types"}),e.jsx("p",{className:"section-description",children:"Select one or more types (or choose Mixed)"}),e.jsx("div",{className:"question-type-grid",children:f.map(y=>e.jsxs("button",{className:`question-type-card ${r.includes(y.value)?"selected":""}`,onClick:()=>l(y.value),disabled:g,children:[e.jsx("div",{className:"type-icon",children:E(y.value)}),e.jsx("div",{className:"type-label",children:y.label}),e.jsx("div",{className:"type-description",children:y.description}),e.jsxs("div",{className:"type-limit",children:["Max: ",Yn[y.value]]})]},y.value))})]}),e.jsxs("div",{className:"config-section",children:[e.jsx("h3",{children:"Number of Questions"}),e.jsxs("p",{className:"section-description",children:["Choose between 1 and ",M," questions"]}),e.jsxs("div",{className:"question-count-selector",children:[e.jsxs("div",{className:"count-input-wrapper",children:[e.jsx("button",{className:"count-btn",onClick:()=>u(c-1),disabled:c<=1||g,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),e.jsx("input",{type:"number",value:c,onChange:y=>u(parseInt(y.target.value)||1),min:1,max:M,className:"count-input",disabled:g}),e.jsx("button",{className:"count-btn",onClick:()=>u(c+1),disabled:c>=M||g,children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),e.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]}),e.jsx("input",{type:"range",value:c,onChange:y=>u(parseInt(y.target.value)),min:1,max:M,className:"count-slider",disabled:g})]})]}),e.jsxs("div",{className:"config-summary",children:[e.jsxs("div",{className:"summary-info",children:[e.jsx("div",{className:"summary-icon",children:"ðŸ“"}),e.jsxs("div",{className:"summary-text",children:[e.jsx("strong",{children:c})," ",r.join(" + ")," question",c!==1?"s":""]})]}),e.jsxs("button",{className:"start-quiz-btn",onClick:m,disabled:g,children:[e.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polygon",{points:"5 3 19 12 5 21 5 3"})}),g?"Quiz Limit Reached":"Generate Quiz"]})]})]})]})}function wr(t){if(!t)return"";const s=/(<sup class="browser-citation-pill"[^>]*>)(\d+)(<\/sup>)(?:\s|&nbsp;)*(<sup class="browser-citation-pill"[^>]*>)(\d+)(<\/sup>)/g;let n=t,r=t;do n=r,r=r.replace(s,(i,c,d,g,E,f,p)=>d===f&&c===E&&g===p?`${c}${d}${g}`:i);while(r!==n);return r}function br(t){if(!t)return"";const s=/ã€(\d+)â€ ([^ã€‘]+)ã€‘/g,n=t.replace(s,(r,i,c)=>{const d=String(i).trim(),g=typeof c=="string"?c:"";let E="";const f=g.match(/L?(\d+)\s*-\s*L?(\d+)/i);if(f){const u=f[1],m=f[2];E=u===m?`Line ${u}`:`Lines ${u}â€“${m}`}else{const u=g.match(/L?(\d+)/i);u?E=`Line ${u[1]}`:g.trim()&&(E=g.replace(/[^\w\s-]/g,"").trim())}const p=[`Source ${d}`];return E&&p.push(E),` <sup class="browser-citation-pill" title="${p.join(" Â· ")}">${d}</sup>`});return wr(n)}function vr(t){if(typeof t!="string"||t.length===0)return[];const s=new Set,n=/ã€(\d+)â€ /g;let r;for(;(r=n.exec(t))!==null;){const i=Number.parseInt(r[1],10);Number.isNaN(i)||s.add(i)}return Array.from(s).sort((i,c)=>i-c)}function fs(t){if(!t)return"Source";try{return new URL(t).hostname.replace(/^www\./,"")||t}catch{return t}}function kr(t){const s=t?.title?.trim()||"";if(s){const n=s.replace(/-?\s*viewing lines?\s*\[[^\]]+\].*$/i,"").trim();if(n)return n}return fs(t?.url)}function jr(t){const s=t?.content||"";if(!s)return null;const n=s.match(/lines?\s*\[(\d+)\s*-\s*(\d+)\]/i);if(n){const r=n[1],i=n[2];return r===i?`Line ${r}`:`Lines ${r}â€“${i}`}return null}function Cr(t){const s=t?.content||"";if(!s)return null;const n=s.replace(/\s+/g," ").trim();if(!n)return null;const i=n.replace(/viewing lines?\s*\[[^\]]+\]\s*of\s*\d+/i,"").trim()||n;return i?i.length>180?`${i.slice(0,177)}...`:i:null}const Nr={...Jt,attributes:{...Jt.attributes,"*":[...Jt.attributes?.["*"]||[],"className"],a:[...Jt.attributes?.a||[],"target","rel"],sup:[...Jt.attributes?.sup||[],"className","title","id"]}},Sr={strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1},Kn=[_s,[Fs,Nr],Ds,[vt,Sr]];function Er(t){if(!t)return[];const s=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","be","been","being","have","has","had","do","does","did","will","would","should","could","may","might","must","can","this","that","these","those","what","which","who","whom","whose","where","when","why","how","about","tell","me","please","help","does","mention","any","pdf"]),n=t.toLowerCase(),r=[],i=n.replace(/[^\w\s]/g," ").split(/\s+/).filter(d=>d.length>2&&!s.has(d));for(let d=0;d<i.length-1;d++){const g=`${i[d]} ${i[d+1]}`;i[d].length>3&&i[d+1].length>3&&r.push(g)}for(let d=0;d<i.length-2;d++){const g=`${i[d]} ${i[d+1]} ${i[d+2]}`;i[d].length>3&&i[d+1].length>2&&i[d+2].length>3&&r.push(g)}const c=[...r,...i];return[...new Set(c)].sort((d,g)=>g.length-d.length)}function Tr(t){const s=new Set(t),n={distribution:["spread","scatter","allocation","dispersion","arrangement"],data:["information","dataset","sample","observation","record"],figure:["chart","graph","plot","diagram","visualization","illustration"],table:["matrix","grid","tabular"],method:["approach","technique","algorithm","procedure","strategy"],result:["finding","outcome","conclusion","summary","finding"],analysis:["evaluation","examination","study","investigation","assessment"]};for(const r of t){const i=r.toLowerCase();s.add(i);for(const[c,d]of Object.entries(n))(i.includes(c)||c.includes(i))&&d.forEach(g=>s.add(g));i.endsWith("s")&&s.add(i.slice(0,-1)),i.endsWith("ed")&&s.add(i.slice(0,-2)),i.endsWith("ing")&&s.add(i.slice(0,-3))}return Array.from(s)}function Ir(t,s,n){if(!t||s.length===0)return t;const r=800,i=[];for(const f of s){const p=f.toLowerCase(),l=new RegExp(p.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");let u;for(;(u=l.exec(t))!==null;){const m=u.index,M=u.index+u[0].length,y=Math.max(0,m-r),A=Math.min(t.length,M+r),j=f.length>4?3:2;i.push({start:y,end:A,score:j})}}if(i.length===0)return jt(t,Math.floor(n/4));i.sort((f,p)=>f.start-p.start);const c=[];for(const f of i){let p=!1;for(let l=0;l<c.length;l++){const u=c[l];if(f.start<=u.end+200&&f.end>=u.start-200){u.start=Math.min(u.start,f.start),u.end=Math.max(u.end,f.end),u.score+=f.score,p=!0;break}}p||c.push(f)}c.sort((f,p)=>p.score-f.score);let d="",g=0;for(const f of c){if(g>=n*.9)break;const p=t.substring(f.start,f.end),l=p.length;if(g+l<=n)d&&(d+=`

---

`),d+=p,g+=l+10;else{const u=n-g-10;u>200&&(d&&(d+=`

---

`),d+=p.substring(0,u)+"...");break}}const E=n-g;if(E>500&&d){const f=Math.min(E*.3,500),p=Math.min(E*.2,300),l=t.substring(0,f),u=t.substring(Math.max(0,t.length-p));d=`[Document Introduction]
${l}

---

[Relevant Sections]
${d}

---

[Document Conclusion]
${u}`}else if(!d)return jt(t,Math.floor(n/4));return d}async function Jn(t,s,n,r,i){const c=m=>({contextText:m,evidence:[]});if(!t)return c(t);const d=r*4,g=n.match(/page\s+(\d+)/i);if(!!g&&s?.pages){const M=parseInt(g[1])-1;if(M>=0&&M<s.pages.length){const y=Math.max(0,M-1),A=Math.min(s.pages.length-1,M+1);let j="";for(let x=y;x<=A;x++)s.pages[x]?.text&&(j+=`
--- Page ${x+1} ---
${s.pages[x].text}`);if(j.length>100)return j.length>d?c(jt(j,r)):c(j)}}if(t.length<=d)return c(t);const f=s||t;if(f)try{const{getRAGContext:m}=await Bt(async()=>{const{getRAGContext:A}=await import("./pdfRAG-SvKsxZz1.js");return{getRAGContext:A}},[]),M=typeof f=="string"?f:f.fullText,y=await m(M,n,r);if(y&&y.length>100)return{contextText:y,evidence:[]}}catch{}const p=Er(n),l=Tr(p);if(l.length===0)return c(jt(t,r));const u=Ir(t,l,d);return u&&u.length>100?c(u):c(jt(t,r))}function Pr(t,s){if(t&&t.pages?.length){const n=t.pages.length,r=[];for(const c of t.pages)if(c.blocks?.forEach(d=>{d.type==="heading"&&d.text&&r.push(d.text.trim())}),r.length>=8)break;const i=r.slice(0,8).map((c,d)=>`${d+1}. ${c}`).join(`
`);return`PDF Summary:
Pages: ${n}
Top headings:
${i||"N/A"}`}return s?`PDF Summary:
Text excerpt: ${s.slice(0,500).replace(/\s+/g," ").trim()}`:"PDF Summary: unavailable"}function Ar(){return`Available tools:
- browser_search: query the web for up-to-date information.
- code_interpreter: run code for calculations and data transforms.`}function Xn(t,s){const n=Pr(t,s),r=Ar();return`${dr}

${r}

${n}`}function jt(t,s){if(!t)return t;const n=s*4;if(t.length<=n)return t;const r=Math.floor(n*.6),i=Math.floor(n*.4),c=t.substring(0,r),d=t.substring(Math.max(0,t.length-i));let g=c;const E=c.lastIndexOf("."),f=c.lastIndexOf(`
`),p=Math.max(E,f);if(p>r*.7)g=c.substring(0,p+1);else{const A=c.lastIndexOf(" ");A>r*.8&&(g=c.substring(0,A))}let l=d;const u=d.indexOf("."),m=d.indexOf(`
`),M=u!==-1&&m!==-1?Math.min(u,m):u!==-1?u:m;if(M!==-1&&M<i*.3)l=d.substring(M+1);else{const A=d.indexOf(" ");A!==-1&&A<i*.2&&(l=d.substring(A+1))}const y=g+`

[... middle content truncated ...]

`+l;if(y.length>n){const A=y.length-n,j=`

[... middle content truncated ...]

`;if(A<=j.length)return g+`

[...]

`+l;const x=Math.floor(A*.6);return g.substring(0,g.length-x)+j+l}return y}function Nn(t){if(!t)return 0;const s=t.trim().split(/\s+/).length,n=t.length;return Math.ceil(Math.max(s*1.33,n/4))}function kn(t,s){let n=0;s&&(n+=Nn(s));for(const r of t){const i=typeof r.content=="string"?r.content:Array.isArray(r.content)&&r.content.find(c=>c.type==="text")?.text||"";n+=Nn(i),n+=4}return n}const Zn=ds[0],es=us[0];function ts(t,s,n,r,i){const c=t!=="thinking"&&(r||n.needsVisionModel||s.needsVision),d=n.needsRealtimeTools||s.needsRealtime,g=n.needsReasoning||s.answerComplexity==="reasoning",E=n.needsCodeInterpreter||s.needsCodeExecution,f=i?/https?:\/\/[^\s]+/i.test(i):!1,p=Ws[0];if(f&&p)return{model:p,includeReasoning:t==="thinking",useBrowserSearch:!1,useCodeInterpreter:!1,isVisionRequest:!1};if(c&&Zn)return{model:Zn,includeReasoning:!1,useBrowserSearch:!1,useCodeInterpreter:!1,isVisionRequest:!0};const l=kt[0];return t==="thinking"&&l?{model:l,includeReasoning:!0,useBrowserSearch:!!d,useCodeInterpreter:!!E,isVisionRequest:!1}:t==="quick"?(g||d||E)&&l?{model:l,includeReasoning:!1,useBrowserSearch:!!d,useCodeInterpreter:!!E,isVisionRequest:!1}:{model:es,includeReasoning:!1,useBrowserSearch:!1,useCodeInterpreter:!1,isVisionRequest:!1}:(g||d||E)&&l?{model:l,includeReasoning:!0,useBrowserSearch:!!d,useCodeInterpreter:!!E,isVisionRequest:!1}:{model:es,includeReasoning:!1,useBrowserSearch:!1,useCodeInterpreter:!1,isVisionRequest:!1}}function xs(t,s,n){const r=t.toLowerCase().trim(),i=s.length>0,c=[/^(what|who|when|where|which)\s+(is|are|was|were)\s+\w{1,30}\?*$/i,/^(yes|no|ok|thanks|thank you|got it)/i,/^(explain|define|tell me about)\s+\w{1,20}$/i],d=[/^(it|that|this|they|those|these)/i,/^(also|additionally|furthermore|moreover|and|but)/i,/^(what about|how about|can you|could you|would you)/i,/^(can you|could you|would you)\s+(also|please|again)/i],g=[/(pdf|document|text|chapter|section|page|according to|in the|from the)/i,/(what does.*say|what is.*about|what does the.*say)/i,/(what is this.*about|what is the.*about|what's this.*about|what's the.*about)/i,/(tell me about.*pdf|tell me about.*document|tell me about.*text)/i,/(summarize.*pdf|summarize.*document|summarize.*text)/i,/(explain.*pdf|explain.*document|explain.*text)/i,/(describe.*pdf|describe.*document|describe.*text)/i,/(this pdf|the pdf|this document|the document)/i],E=[/(why|how|explain|analyze|compare|contrast|evaluate|discuss)/i,/(calculate|solve|derive|prove|show|demonstrate)/i,/(relationship|connection|difference|similarity|correlation)/i],f=[/(figure|fig\.?|chart|graph|diagram|image|picture|illustration|plot|table)/i,/(red line|blue line|green line|curve)/i],p=[/(today|current|latest|recent|this week|this month|breaking|news|update)/i,/(on the internet|online|google|web)/i],l=[/(run|execute)\s+(python|code|script)/i,/(write|generate)\s+(python|code|script)/i,/(simulate|program|algorithm)/i],u=c.some(q=>q.test(r)),m=i&&d.some(q=>q.test(r)),M=n&&g.some(q=>q.test(r)),y=E.some(q=>q.test(r)),A=/^(what is|what are|define|definition)/i.test(r),j=/(calculate|solve|compute|formula|equation|math)/i.test(r),x=/(compare|contrast|difference|similar|versus|vs)/i.test(r),S=/(what do you mean|clarify|explain.*again|repeat)/i.test(r),P=f.some(q=>q.test(r)),b=p.some(q=>q.test(r)),h=j||l.some(q=>q.test(r)),w=/(what is|what's|what are|tell me about|summarize|explain|describe).*(about|say|contain|discuss)/i.test(r);let N=0;M?N=.9:w&&n&&!m?N=.85:n&&!u&&!m?N=.4:n&&(N=.2);let R=0;m?R=.9:i&&(S||/^(it|that|this)/i.test(r))?R=.7:i&&(R=.2);let $="detailed";u||A?$="quick":(y||j||x)&&($="reasoning");const H=n&&(M||w&&!m||!m&&!u&&n),L=i&&(m||S||R>.5);return{needsPdfContext:H,needsChatHistory:L,needsFullContext:H&&L,needsVision:P,needsRealtime:b,needsCodeExecution:h,answerComplexity:$,isClarification:S,isFollowUp:m,isDefinition:A,isCalculation:j,isComparison:x,pdfRelevanceScore:N,historyRelevanceScore:R,classificationMethod:"rule-based",confidence:u||m||M?.9:.6}}async function Mr(t,s,n,r){const i=s.length>0,c=p=>typeof p.content=="string"?p.content:Array.isArray(p.content)&&p.content.find(u=>u.type==="text")?.text||"",d=i?`Previous conversation has ${s.length} messages. Last user message: "${c(s[s.length-1]).substring(0,100)}"`:"No previous conversation history.",g=n?"A PDF document is available as context.":"No PDF document is available.",E={type:"object",properties:{needsPdfContext:{type:"boolean"},needsChatHistory:{type:"boolean"},needsFullContext:{type:"boolean"},needsVision:{type:"boolean"},needsRealtime:{type:"boolean"},needsCodeExecution:{type:"boolean"},answerComplexity:{type:"string",enum:["quick","detailed","reasoning"]},isClarification:{type:"boolean"},isFollowUp:{type:"boolean"},isDefinition:{type:"boolean"},isCalculation:{type:"boolean"},isComparison:{type:"boolean"},pdfRelevanceScore:{type:"number",minimum:0,maximum:1},historyRelevanceScore:{type:"number",minimum:0,maximum:1},confidence:{type:"number",minimum:0,maximum:1}},required:["needsPdfContext","needsChatHistory","needsFullContext","needsVision","needsRealtime","needsCodeExecution","answerComplexity","isClarification","isFollowUp","isDefinition","isCalculation","isComparison","pdfRelevanceScore","historyRelevanceScore","confidence"],additionalProperties:!1};for(const p of Vs)try{const l=await fetch(`${pe}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({messages:[{role:"system",content:`You are a question classification expert. Analyze the user's question and classify it to determine what context is needed for an optimal response. Consider:
- Whether the question is about the PDF document
- Whether the question references previous conversation
- The complexity of the answer needed (quick fact, detailed explanation, or reasoning)
- Question characteristics (clarification, follow-up, definition, calculation, comparison)
- Whether the question references figures/images requiring vision support
- Whether the question needs real-time or internet data
- Whether the question needs code execution beyond simple reasoning

${g}
${d}

Output your classification as JSON matching the provided schema.`},{role:"user",content:t}],model:p,temperature:.3,maxTokens:500,response_format:{type:"json_schema",json_schema:{name:"question_classification",schema:E}}})});if(!l.ok)continue;const u=await l.json(),m=JSON.parse(u.choices[0]?.message?.content||"{}");return{...m,classificationMethod:"llm",confidence:m.confidence||.8}}catch{continue}return xs(t,s,n)}async function ns(t,s,n,r){const i=xs(t,s,n);if(i.confidence>=.85)return i;try{return await Mr(t,s,n,r)}catch{return i}}function ss(t,s,n){const r=s==="thinking";if(t.needsPdfContext&&!t.needsChatHistory){const g=t.answerComplexity==="quick"?r?1500:2e3:t.answerComplexity==="detailed"&&!r?2e3:1500,E=2;return{includePdfContext:!0,pdfContextTokens:g,includeChatHistory:n>0,chatHistoryDepth:E,summarizeOldMessages:n>E,recentMessagesCount:E,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning",needsVisionModel:t.needsVision,needsRealtimeTools:t.needsRealtime,needsCodeInterpreter:t.needsCodeExecution}}if(t.needsChatHistory&&!t.needsPdfContext){const g=t.isFollowUp||r?2:5;return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:!0,chatHistoryDepth:g,summarizeOldMessages:n>g,recentMessagesCount:g,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning",needsVisionModel:t.needsVision,needsRealtimeTools:t.needsRealtime,needsCodeInterpreter:t.needsCodeExecution}}if(t.answerComplexity==="quick"&&!t.needsPdfContext&&!t.needsChatHistory)return{includePdfContext:!1,pdfContextTokens:0,includeChatHistory:n>0,chatHistoryDepth:2,summarizeOldMessages:n>2,recentMessagesCount:2,preferQuickModel:!0,needsReasoning:!1,needsVisionModel:t.needsVision,needsRealtimeTools:t.needsRealtime,needsCodeInterpreter:t.needsCodeExecution};const i=t.needsPdfContext?t.answerComplexity==="quick"?r?1200:1500:r?1500:t.answerComplexity==="detailed"?2e3:1500:0,c=t.needsChatHistory?r||t.isFollowUp?2:5:2;return{includePdfContext:t.needsPdfContext,pdfContextTokens:i,includeChatHistory:n>0,chatHistoryDepth:c,summarizeOldMessages:n>c,recentMessagesCount:c,preferQuickModel:t.answerComplexity==="quick",needsReasoning:t.answerComplexity==="reasoning",needsVisionModel:t.needsVision,needsRealtimeTools:t.needsRealtime,needsCodeInterpreter:t.needsCodeExecution}}function Lr(t,s=!1){if(t.length===0)return{role:"system",content:""};const n=[],r=s?50:80,i=s?80:120;for(let g=0;g<t.length;g+=2){const E=t[g],f=t[g+1];if(E&&E.role==="user"){const p=typeof E.content=="string"?E.content:Array.isArray(E.content)&&E.content.find(l=>l.type==="text")?.text||"";if(p.trim()){const l=p.length>r?p.substring(0,r)+"...":p;n.push(`Q: ${l}`)}}if(f&&f.role==="assistant"){const p=typeof f.content=="string"?f.content:Array.isArray(f.content)&&f.content.find(l=>l.type==="text")?.text||"";if(p.trim()){const l=p.length>i?p.substring(0,i)+"...":p;n.push(`A: ${l}`)}}}return{role:"system",content:`${s?`[Prev (${t.length})]`:`[Previous conversation (${t.length} msgs)]`}:
${n.join(`
`)}`}}function rs(t){return typeof t=="string"?t.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim():Array.isArray(t)?t.map(s=>{if(s.type==="text"&&s.text){const n=s.text.replace(/\n\n\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n?/g,"").replace(/\n\n\[IMPORTANT: Please think step by step[^\]]+\]\n?/g,"").replace(/\[IMPORTANT: Please provide a concise and direct response[^\]]+\]\n\n?/g,"").replace(/\[IMPORTANT: Please think step by step[^\]]+\]\n\n?/g,"").trim();return{...s,text:n}}return s}).filter(s=>!(s.type==="text"&&s.text&&s.text.trim()==="")):t}function zt(t){if(!t)return{thinking:null,mainContent:t};const s="__REASONING_START__",n="__REASONING_END__",r=t.indexOf(s),i=t.indexOf(n);if(r!==-1&&i!==-1&&i>r){const u=r+s.length,m=t.substring(u,i).trim(),M=t.substring(i+n.length).trim();return{thinking:m||null,mainContent:M}}const c=t.indexOf("<think>"),d=t.lastIndexOf("</think>");if(c===-1||d===-1||d<=c)return{thinking:null,mainContent:t};const g=c+7,E=t.substring(g,d).trim(),f=t.substring(0,c),p=t.substring(d+8),l=(f+p).trim();return{thinking:E||null,mainContent:l}}function Rr({selectedText:t,pdfText:s,pdfDocument:n,layout:r,currentPageNumber:i,onCreateKnowledgeNote:c,onClearSelectedText:d,onAddAnnotationToPDF:g,onOpenKnowledgeNotes:E,onToggleKnowledgeNotes:f,showKnowledgeNotes:p,onModeChange:l,resetModeRef:u,modelMode:m,onModelModeChange:M}){const{theme:y}=fn(),{isAuthenticated:A,user:j,loading:x}=qt(),{setChatVisible:S}=En();a.useEffect(()=>{const o=console.warn;return console.warn=(...D)=>{const _=D.map(v=>{if(typeof v=="string")return v;if(v&&typeof v=="object")try{return JSON.stringify(v)}catch{return String(v)}return String(v)}).join(" ");_.includes("No character metrics")&&(_.includes("â€‘")||_.includes("8209")||_.includes("U+2011"))||_.includes("Unrecognized Unicode character")&&(_.includes("â€‘")||_.includes("8209")||_.includes("U+2011"))||_.includes("LaTeX-incompatible input")&&(_.includes("â€‘")||_.includes("8209")||_.includes("U+2011"))||_.includes("unknownSymbol")&&(_.includes("â€‘")||_.includes("8209")||_.includes("U+2011"))||o.apply(console,D)},()=>{console.warn=o}},[]);const[P,b]=a.useState([]),[h,w]=a.useState({}),[N,R]=a.useState({}),[$,H]=a.useState({}),[L,Y]=a.useState({}),[q,ne]=a.useState({}),[re,ce]=a.useState(""),[ie,Be]=a.useState(!1),[F,z]=a.useState(null),[J,ke]=a.useState(!1),[de,C]=a.useState(!1),[T,B]=a.useState(null),[X,Z]=a.useState(!0),[K,me]=a.useState(!0),[be,Ge]=a.useState(null),[fe,nt]=a.useState(m||"auto"),[Et,Tt]=a.useState(!1),[Ke,De]=a.useState(null),[Oe,ze]=a.useState([]),[on,it]=a.useState(!1),[xt,Xe]=a.useState(!1),[It,an]=a.useState(!1),[yn,at]=a.useState({}),[yt,lt]=a.useState(!1),st=a.useRef(null),[Ve,Pt]=a.useState(()=>{const o=localStorage.getItem("chatnote-interaction-mode");return o||null}),[Ce,rt]=a.useState(null),[wn,ln]=a.useState(!1),[cn,wt]=a.useState(!1),Lt=a.useRef(null),Rt=a.useRef(null),At=a.useRef({}),Mt=a.useRef(null),Ct=a.useRef(null),$e=a.useRef(null),bt=a.useRef(null),ct=a.useRef(null),je=a.useRef(null),[Ht,$t]=a.useState(null),[dn,Ut]=a.useState(null),dt=(o=!0,D=!1)=>{if(je.current){const _=je.current;(_.scrollHeight-_.scrollTop-_.clientHeight<100||D)&&requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(!je.current)return;const v=je.current;o?Mt.current?Mt.current.scrollIntoView({behavior:"smooth"}):v.scrollTo({top:v.scrollHeight,behavior:"smooth"}):Mt.current?Mt.current.scrollIntoView({behavior:"auto"}):v.scrollTop=v.scrollHeight})})}},I=()=>{const o=Ct.current;if(o){o.style.height="auto";const k=Math.min(Math.max(o.scrollHeight,24),200);o.style.height=`${k}px`}},V=a.useRef(0),U=a.useRef(null);a.useEffect(()=>{const o=P.length,D=V.current,k=(P.length>0?P[P.length-1]:null)?.role||null;o>D?k==="user"?dt(!0,!0):dt(!0):o===D&&ie&&dt(!1),V.current=o,U.current=k},[P,ie]),a.useEffect(()=>{if(!je.current||!ie)return;const o=je.current;let D=o.scrollHeight,_=null;const k=new ResizeObserver(()=>{if(!je.current)return;const v=je.current.scrollHeight,O=je.current.scrollHeight-je.current.scrollTop-je.current.clientHeight<100;v>D&&O?(_&&clearTimeout(_),_=setTimeout(()=>{dt(!1),D=v},50)):D=v});return k.observe(o),()=>{k.disconnect(),_&&clearTimeout(_)}},[ie]),a.useEffect(()=>()=>{st.current&&clearTimeout(st.current)},[]),a.useEffect(()=>{Ct.current?.focus(),I()},[]),a.useEffect(()=>{const o=setTimeout(()=>{I()},0);return()=>clearTimeout(o)},[re]);const ae=async()=>{if(A){Z(!0);try{const o=localStorage.getItem("auth_token")||"",D=await fetch(`${pe}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${o}`}});if(D.ok){const _=await D.json();ke(!!_.hasApiKey),C(!!_.isAdmin),B(_.freeTrial||null)}else console.warn("Failed to fetch API key status:",D.status)}catch(o){console.warn("API key check failed:",o)}finally{Z(!1)}}else Z(!1)},le=A&&(de||J||T&&T.enabled&&T.remaining>0);a.useEffect(()=>(ae(),()=>{}),[A]),a.useEffect(()=>{r==="split"&&(me(!1),Ge(null))},[r]),a.useEffect(()=>{r==="floating"&&!K&&be!==null&&je.current&&requestAnimationFrame(()=>{je.current&&(je.current.scrollTop=be)})},[K,r,be]),a.useEffect(()=>{if(r!=="floating"){$t(null);return}const o=()=>{const D=window.innerHeight,_=window.innerWidth<=768?70:90,k=60,v=400,O=D-k-_;if(O<v)me(!0),$t(null);else if(K)$t(null);else{const ee=Math.min(O-200,600);$t(Math.max(ee,300))}};return o(),window.addEventListener("resize",o),()=>{window.removeEventListener("resize",o)}},[r,K]),a.useEffect(()=>{if(!Ke||!je.current||!ct.current){Ut(null);return}const o=()=>{const _=je.current,k=ct.current;if(!_||!k)return;const v=_.clientHeight,O=window.innerHeight,ee=Math.min(O*.7,600)+40;if(ee<=v)Ut(null);else{const ue=k.clientHeight-v,G=ee+ue;Ut(G)}},D=setTimeout(o,100);return window.addEventListener("resize",o),()=>{clearTimeout(D),window.removeEventListener("resize",o)}},[Ke]);const We=o=>{nt(o),M&&M(o),o==="thinking"&&Oe.length>0&&ze([])},qe=()=>fe!=="thinking";a.useEffect(()=>{!qe()&&Oe.length>0&&ze([])},[fe]),a.useEffect(()=>{m&&m!==fe&&nt(m)},[m]);const Nt=o=>{Array.from(o).forEach(_=>{if(!_.type.startsWith("image/")){z("Please upload image files only.");return}const k=new FileReader;k.onload=v=>{const O=v.target?.result;O&&ze(oe=>[...oe,O])},k.onerror=()=>{z("Failed to read image file.")},k.readAsDataURL(_)})},Ze=o=>{if(!qe()){z("Image uploads are not available in Thinking mode. Switch to Auto or Quick mode to use vision features.");return}const D=o.target.files;!D||D.length===0||(Nt(D),Lt.current&&(Lt.current.value=""))},Ae=o=>{qe()&&(o.preventDefault(),o.stopPropagation(),it(!0))},He=o=>{qe()&&(o.preventDefault(),o.stopPropagation(),it(!1))},_t=o=>{if(!qe())return;o.preventDefault(),o.stopPropagation(),it(!1);const D=o.dataTransfer.files;D&&D.length>0&&Nt(D)},ot=()=>{const o=Rt.current;if(!o){Xe(!1),an(!1);return}Xe(o.scrollLeft>0),an(o.scrollLeft<o.scrollWidth-o.clientWidth-1)},An=o=>{const D=Rt.current;if(!D)return;const _=200,k=o==="left"?D.scrollLeft-_:D.scrollLeft+_;D.scrollTo({left:k,behavior:"smooth"})},un=o=>{const D=At.current[o];if(!D){at(v=>({...v,[o]:{canScrollLeft:!1,canScrollRight:!1}}));return}const _=D.scrollLeft>0,k=D.scrollLeft<D.scrollWidth-D.scrollWidth-1;at(v=>({...v,[o]:{canScrollLeft:_,canScrollRight:k}}))},Mn=(o,D)=>{const _=At.current[o];if(!_)return;const k=200,v=D==="left"?_.scrollLeft-k:_.scrollLeft+k;_.scrollTo({left:v,behavior:"smooth"})};a.useEffect(()=>{const o=setTimeout(()=>{ot()},0),D=Rt.current;return D?(D.addEventListener("scroll",ot),window.addEventListener("resize",ot),()=>{clearTimeout(o),D.removeEventListener("scroll",ot),window.removeEventListener("resize",ot)}):()=>{clearTimeout(o)}},[Oe]),a.useEffect(()=>{const o=setTimeout(()=>{Object.keys(At.current).forEach(_=>{un(_)})},0),D=()=>{Object.keys(At.current).forEach(_=>{un(_)})};return window.addEventListener("resize",D),()=>{clearTimeout(o),window.removeEventListener("resize",D)}},[P]);const Ln=async()=>{const o=re.trim();if(!o&&!t&&Oe.length===0)return;if(!A){z("Please sign in to use the chat feature.");return}if(!le){z("Free trial exhausted or API key not configured. Please add your Groq API key in Settings to continue.");return}if(!J&&!de&&T&&T.enabled&&T.remaining>0){const te=T.used+1;B(Q=>Q?{...Q,used:te,remaining:Math.max(0,Q.limit-te)}:null);const se=localStorage.getItem("auth_token");se&&ir(se,te).catch(Q=>{console.error("Failed to sync free trial count to backend:",Q),ae()})}K&&me(!1),$e.current&&$e.current.abort(),$e.current=new AbortController;const D=Date.now(),_=!!t;we.trackQuerySubmitted(fe,r,_);let k=o;t&&!o?k=`Tell me about this: ${t}`:t&&o&&(k=`${o}

Context from PDF: ${t}`);const v=fe==="thinking",O=s&&s.trim().length>0||!!t,oe=o||(t?`Tell me about: ${t}`:""),ee=Oe.length>0,ue=localStorage.getItem("auth_token")||"";let G,he;try{G=await ns(oe,P,O,ue),he=ss(G,fe,P.length)}catch(te){console.warn("[Smart Router] Classification failed, using default routing:",te),G={needsPdfContext:O,needsChatHistory:P.length>0,needsFullContext:O&&P.length>0,needsVision:ee,needsRealtime:!1,needsCodeExecution:!1,answerComplexity:"detailed",isClarification:!1,isFollowUp:!1,isDefinition:!1,isCalculation:!1,isComparison:!1,pdfRelevanceScore:O?.5:0,historyRelevanceScore:P.length>0?.5:0,classificationMethod:"rule-based",confidence:.3},he={includePdfContext:O,pdfContextTokens:v?1500:2e3,includeChatHistory:!0,chatHistoryDepth:v?2:5,summarizeOldMessages:P.length>(v?2:5),recentMessagesCount:v?2:5,preferQuickModel:!1,needsReasoning:!1}}G||(G={needsPdfContext:O,needsChatHistory:P.length>0,needsFullContext:O&&P.length>0,needsVision:ee,needsRealtime:!1,needsCodeExecution:!1,answerComplexity:"detailed",isClarification:!1,isFollowUp:!1,isDefinition:!1,isCalculation:!1,isComparison:!1,pdfRelevanceScore:O?.5:0,historyRelevanceScore:P.length>0?.5:0,classificationMethod:"rule-based",confidence:.3});const ge=ts(fe,G,he,Oe.length>0,o),Ue=ge.model,Te=fe==="thinking"||ge.includeReasoning;let Ne=null,Ie;if(ge.isVisionRequest){const te=[];k&&te.push({type:"text",text:k}),Oe.forEach(se=>{te.push({type:"image_url",image_url:{url:se}})}),Ie=te}else Ie=k;const et=window.__lastSelectedTextPosition,Le={id:Date.now().toString(),role:"user",content:Ie,selectedTextAtSend:t||void 0,pageNumberAtSend:et?.pageNumber,textYPositionAtSend:et?.textYPosition};b(te=>[...te,Le]),ce(""),ze([]),setTimeout(()=>{I()},0),Be(!0),z(null),requestAnimationFrame(()=>{requestAnimationFrame(()=>{dt(!0,!0)})});let _e;if(he.includePdfContext&&he.pdfContextTokens>0)if(t&&!o)_e=jt(t,he.pdfContextTokens);else if(s&&s.trim().length>0)if(o&&o.trim().length>0){Ne=await Jn(s,n||null,o,he.pdfContextTokens,{needsVision:G.needsVision,needsPdfContext:G.needsPdfContext}),_e=Ne.contextText;const te=Ne.evidence?.filter(se=>se.type==="figure"&&se.figurePreview).map(se=>se.figurePreview)||[];if(ge.isVisionRequest&&Array.isArray(Ie)&&(te.forEach(se=>{Ie.push({type:"image_url",image_url:{url:se}})}),G.needsVision&&(!te||te.length===0))){const se=o?.match(/page\s+(\d{1,3})/i),Q=se?parseInt(se[1],10):void 0;if(Q&&n?.pages){const Se=n.pages.find(xe=>xe.pageNumber===Q);Se?.pageImageDataUrl&&Ie.push({type:"image_url",image_url:{url:Se.pageImageDataUrl}})}}}else _e=jt(s,he.pdfContextTokens);else t&&o&&(_e=jt(t,he.pdfContextTokens));const Qe=(Date.now()+1).toString(),Vt=Le.selectedTextAtSend,Gt={id:Qe,role:"assistant",content:"",selectedTextAtSend:Vt,pageNumberAtSend:Le.pageNumberAtSend,textYPositionAtSend:Le.textYPositionAtSend,pdfCitations:Ne?.evidence?.map(te=>te.citation).filter(Boolean)||[]};b(te=>[...te,Gt]),requestAnimationFrame(()=>{requestAnimationFrame(()=>{dt(!0,!0)})});try{let te=[];if(he.includeChatHistory&&P.length>0){const ve=P.length,W=he.recentMessagesCount;if(ve>W&&he.summarizeOldMessages){const Ee=P.slice(0,ve-W),Pe=P.slice(-W);te=[Lr(Ee,v),...Pe.map(Re=>({role:Re.role,content:Re.content}))]}else ve<=W?te=P.map(Ee=>({role:Ee.role,content:Ee.content})):te=P.slice(-W).map(Ee=>({role:Ee.role,content:Ee.content}))}else if(P.length>0){const ve=Math.min(2,P.length);te=P.slice(-ve).map(W=>({role:W.role,content:W.content}))}else te=[];const se=kn([...te,Le],_e),Se={"openai/gpt-oss-120b":7e3,"openai/gpt-oss-20b":7e3,"qwen/qwen3-32b":5e3,"meta-llama/llama-4-scout-17b-16e-instruct":12e4,"meta-llama/llama-4-maverick-17b-128e-instruct":12e4}[Ue]||8e3;if(se>Se&&_e){const ve=Se/se,W=Math.floor(Nn(_e)*ve*.9);_e=jt(_e,W)}let xe=Xn(n||null,s);const Me=Gn(Ue);Me&&(xe+=`

`+Me);const Fe={role:"system",content:xe},Ye=te.length>0&&te[0]?.role==="system"?te:[Fe,...te];let Ft=kn([...Ye,Le],_e);if(Ft>Se&&Ye.length>1){const ve=Ye[0]?.role==="system"?Ye[0]:null,W=ve?Ye.slice(1):Ye,Ee=W[0],ye=W.slice(1).slice(-2);te=Ee?.content?ve?[ve,Ee,...ye]:[Ee,...ye]:ve?[ve,...ye]:ye,Ft=kn([...te,Le],_e)}else te=Ye;Ft>Se&&_e&&(_e=void 0);let Je="";const hn=Le,Qt=[];ge.useBrowserSearch&&Qt.push({type:"browser_search"}),ge.useCodeInterpreter&&Qt.push({type:"code_interpreter"});const On=sn([...te,hn],_e,ve=>{if($e.current?.signal.aborted)return;Je+=ve;const{thinking:W,mainContent:Ee}=zt(Je),Pe=W&&W.trim().length>0;b(Te&&Pe?ye=>ye.map(Re=>Re.id===Qe?{...Re,content:Ee||Je,thinking:Pe?W:Re.thinking}:Re):ye=>ye.map(Re=>Re.id===Qe?{...Re,content:Je}:Re)),dt(!1)},Ue,$e.current?.signal,Te,{includeReasoning:ge.includeReasoning,tools:Qt.length>0?Qt:void 0,toolChoice:Qt.length>0?"auto":void 0});On.catch(ve=>{if(!(ve instanceof DOMException&&ve.name==="AbortError"))throw ve});const Yt=await On,zn=Yt.content,{thinking:ut,mainContent:Dt}=zt(zn);let Kt=ut,bn=Dt;if(ut&&(!Dt||Dt.trim().length===0)){const ve=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let W=null;for(const Ee of ve){const Pe=ut.match(Ee);if(Pe&&Pe[1]){const ye=ut.indexOf(Pe[0]),Re=ut.substring(ye+Pe[0].length);let Ot=Pe[1].trim();const Bn=Re.match(/^([^.!?]*[.!?]+)/);if(Bn)Ot+=Bn[1];else{const St=Re.match(/^([^\n]+)/);St&&(Ot+=St[1])}if(W=Ot.trim(),W&&!W.match(/^[A-Z"']/)){const Wn=ut.substring(Math.max(0,ye-200),ye).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);Wn&&(W=Wn[2]+W)}if(W.length>300){const St=W.match(/[^.!?]*[.!?]+/g);St&&St.length>0?(W=St.slice(0,2).join(" ").trim(),St.length>2&&(W+="...")):W=W.substring(0,300).trim()+"..."}break}}if(!W){const Ee=ut.split(/\n\n+/).filter(Pe=>Pe.trim().length>0);if(Ee.length>0){for(let Pe=Ee.length-1;Pe>=0;Pe--){const ye=Ee[Pe].trim();if(!ye.match(/^(?:Step \d+|## Step|\d+\.)/i)&&ye.length>50){const Re=ye.match(/[^.!?]*[.!?]+/g);if(Re&&Re.length>0?W=Re.slice(-2).join(" ").trim():W=ye,W.length>300){const Ot=Re?Re.slice(0,2).join(" ").trim():null;Ot?W=Ot+(Re&&Re.length>2?"...":""):W=ye.substring(0,300).trim()+"..."}break}}if(!W&&Ee.length>0){const Pe=Ee[Ee.length-1].trim(),ye=Pe.match(/[^.!?]*[.!?]+/g);ye&&ye.length>0?(W=ye.slice(-2).join(" ").trim(),W.length>300&&(W=ye.slice(0,2).join(" ").trim()+(ye.length>2?"...":""))):(W=Pe,W.length>300&&(W=Pe.substring(0,300).trim()+"..."))}}}W&&(W=W.replace(/\$\\([0-7]{1,3})(\d[^$]*)\$/g,(Ee,Pe,ye)=>`$${Pe}${ye}$`),W=W.replace(/\$\\\$(\d[^$]*)\$/g,"$$$1$"),W=W.replace(/\\\$(\d[^$]*?)(?=\s|$|,|\.|;)/g,"$$$1$")),bn=W||"",Kt=ut}else ut&&Dt&&ut.trim()===Dt.trim()&&(Kt=null,bn=Dt);const vn=Kt&&Kt.trim().length>0,gn={content:bn||(vn?"":zn),thinking:vn&&Kt||void 0,timestamp:Date.now()};Y(ve=>{const Ee=[...ve[Qe]||[],gn],Pe=Ee.length-1;return ne(ye=>({...ye,[Qe]:Pe})),{...ve,[Qe]:Ee}}),b(Te&&vn?ve=>ve.map(W=>W.id===Qe?{...W,content:gn.content,thinking:gn.thinking,usedBrowserSearch:Yt.usedBrowserSearch,browserSearchSources:Yt.browserSearchSources}:W):ve=>ve.map(W=>W.id===Qe?{...W,content:gn.content,thinking:void 0,usedBrowserSearch:Yt.usedBrowserSearch,browserSearchSources:Yt.browserSearchSources}:W))}catch(te){if(!(te instanceof DOMException&&te.name==="AbortError")){console.error("Error sending message (details logged, user sees sanitized message):",te);const se=te instanceof Error?te.message:"Unable to send message. Please try again.";z(se),b(Se=>Se.filter(xe=>xe.id!==Qe)),(se.toLowerCase().includes("timeout")||se.toLowerCase().includes("timed out"))&&await we.trackError("ai_timeout",`Model: ${fe}, Error: ${se}`)}}finally{const te=Date.now()-D;we.trackAIResponse(fe,te),!J&&!de&&T&&T.enabled&&ae().catch(se=>{console.error("Failed to sync free trial status after message:",se)}),Be(!1),$e.current=null,Ct.current?.focus()}},bs=()=>{$e.current&&($e.current.abort(),$e.current=null,Be(!1),Ct.current?.focus())},vs=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),Ln())},ks=()=>{t&&(ce(`Tell me about this: ${t}`),Ct.current?.focus())},js=async o=>{const D=P.findIndex(v=>v.id===o);if(D===-1||P[D].role!=="assistant")return;let _=D-1;for(;_>=0&&P[_].role!=="user";)_--;if(_<0)return;const k=P[_];b(v=>v.map(O=>O.id===o?{...O,content:"",thinking:void 0}:O)),Be(!0),$e.current&&$e.current.abort(),$e.current=new AbortController;try{const v=localStorage.getItem("auth_token");if(!v)throw new Error("Authentication required");const O=typeof k.content=="string"?k.content:k.content.filter(se=>se.type==="text").map(se=>se.text).join(`
`),oe=k.selectedTextAtSend;let ee=P.slice(0,D).map(se=>({role:se.role,content:se.content})),ue;s&&s.trim().length>0&&(oe?ue=oe:ue=s);const G=await ns(O,ee,!!ue,v),he=ss(G,fe,ee.length),ge=ts(fe,G,he,!1,O),Ue=fe==="thinking"||ge.includeReasoning;{const se=ge?.model||(fe==="auto"?kt[0]:ge?.model);let Q=Xn(n||null,s);const Se=Gn(se);Se&&(Q+=`

`+Se);const xe={role:"system",content:Q};ee.length>0&&ee[0]?.role==="system"||(ee=[xe,...ee])}s&&s.trim().length>0&&(ue=(await Jn(s,n||null,O,he.pdfContextTokens,{needsVision:G.needsVision,needsPdfContext:G.needsPdfContext})).contextText);const Te=[];ge.useBrowserSearch&&Te.push({type:"browser_search"}),ge.useCodeInterpreter&&Te.push({type:"code_interpreter"});let Ne="";const Ie=await sn([...ee,k],ue,se=>{if($e.current?.signal.aborted)return;Ne+=se;const{thinking:Q,mainContent:Se}=zt(Ne),xe=Q&&Q.trim().length>0;b(Ue&&xe?Me=>Me.map(Fe=>Fe.id===o?{...Fe,content:Se||Ne,thinking:xe?Q:Fe.thinking}:Fe):Me=>Me.map(Fe=>Fe.id===o?{...Fe,content:Ne}:Fe)),dt(!1)},ge.model,$e.current?.signal,ge.includeReasoning,{includeReasoning:ge.includeReasoning,tools:Te.length>0?Te:void 0,toolChoice:Te.length>0?"auto":void 0}),et=Ie.content,{thinking:Le,mainContent:_e}=zt(et),Qe=Le&&Le.trim().length>0;let Vt=Le,Gt=_e;if(Ue&&Qe)if(Le&&(!_e||_e.trim().length===0)){const se=[/(?:Therefore|In conclusion|To summarize|The answer is|The result is|In summary|To conclude)[:.]?\s*(.+?)(?:\n\n|$)/is,/(?:So|Thus|Hence)[,.]?\s*(.+?)(?:\n\n|$)/is,/(?:The final answer is|The solution is|The answer)[:.]?\s*(.+?)(?:\n\n|$)/is];let Q=null;for(const Se of se){const xe=Le.match(Se);if(xe&&xe[1]){const Me=Le.indexOf(xe[0]),Fe=Le.substring(Me+xe[0].length);let Ye=xe[1].trim();const Ft=Fe.match(/^([^.!?]*[.!?]+)/);if(Ft)Ye+=Ft[1];else{const Je=Fe.match(/^([^\n]+)/);Je&&(Ye+=Je[1])}if(Q=Ye.trim(),Q&&!Q.match(/^[A-Z"']/)){const hn=Le.substring(Math.max(0,Me-200),Me).match(/([.!?]\s+)([A-Z"'][^.!?]*)$/);hn&&(Q=hn[2]+Q)}if(Q.length>300){const Je=Q.match(/[^.!?]*[.!?]+/g);Je&&Je.length>0?(Q=Je.slice(0,2).join(" ").trim(),Je.length>2&&(Q+="...")):Q=Q.substring(0,300).trim()+"..."}break}}if(!Q){const Se=Le.split(/\n\n+/).filter(xe=>xe.trim().length>0);if(Se.length>0){for(let xe=Se.length-1;xe>=0;xe--){const Me=Se[xe].trim();if(!Me.match(/^(?:Step \d+|## Step|\d+\.)/i)&&Me.length>50){const Fe=Me.match(/[^.!?]*[.!?]+/g);if(Fe&&Fe.length>0?Q=Fe.slice(-2).join(" ").trim():Q=Me,Q.length>300){const Ye=Fe?Fe.slice(0,2).join(" ").trim():null;Ye?Q=Ye+(Fe&&Fe.length>2?"...":""):Q=Me.substring(0,300).trim()+"..."}break}}if(!Q&&Se.length>0){const xe=Se[Se.length-1].trim(),Me=xe.match(/[^.!?]*[.!?]+/g);Me&&Me.length>0?(Q=Me.slice(-2).join(" ").trim(),Q.length>300&&(Q=Me.slice(0,2).join(" ").trim()+(Me.length>2?"...":""))):(Q=xe,Q.length>300&&(Q=xe.substring(0,300).trim()+"..."))}}}Gt=Q||"",Vt=Le}else Le&&_e&&Le.trim()===_e.trim()&&(Vt=null,Gt=_e);const te={content:Gt||(Qe?"":et),thinking:Qe&&Vt||void 0,timestamp:Date.now()};Y(se=>{const Se=[...se[o]||[],te];return ne(xe=>{const Me=Se.length-1;return{...xe,[o]:Me}}),{...se,[o]:Se}}),b(Ue&&Qe?se=>se.map(Q=>Q.id===o?{...Q,content:te.content,thinking:te.thinking,usedBrowserSearch:Ie.usedBrowserSearch,browserSearchSources:Ie.browserSearchSources}:Q):se=>se.map(Q=>Q.id===o?{...Q,content:te.content,thinking:void 0,usedBrowserSearch:Ie.usedBrowserSearch,browserSearchSources:Ie.browserSearchSources}:Q))}catch(v){if(!(v instanceof DOMException&&v.name==="AbortError")){console.error("Error resending message:",v),z(v instanceof Error?v.message:"Unable to resend message. Please try again.");const O=L[o]||[];if(O.length>0){const oe=O[O.length-1];b(ee=>ee.map(ue=>ue.id===o?{...ue,content:oe.content,thinking:oe.thinking}:ue))}}}finally{Be(!1),$e.current=null}},Rn=(o,D)=>{const _=L[o]||[];if(_.length===0)return;const k=q[o]??_.length-1;let v=k;if(D==="prev"?v=Math.max(0,k-1):v=Math.min(_.length-1,k+1),v===k)return;ne(oe=>({...oe,[o]:v}));const O=_[v];O&&b(oe=>oe.map(ee=>ee.id===o?{...ee,content:O.content,thinking:O.thinking}:ee))},$n=o=>{let D="";typeof o=="string"?D=o:Array.isArray(o)&&(D=o.find(O=>O.type==="text")?.text||"");const _=D.match(/^(.+?)\n\nContext from PDF:\s*(.+)$/s);if(_)return{mainQuestion:_[1].trim(),pdfContext:_[2].trim()};const k=D.match(/^Tell me about this:\s*(.+)$/s);return k?{mainQuestion:"",pdfContext:k[1].trim()}:{mainQuestion:D.trim()}},_n=()=>{const o=window.getSelection();if(!o||o.rangeCount===0)return null;const D=o.toString().trim();if(!D)return null;const k=o.getRangeAt(0).commonAncestorContainer;return(k.nodeType===Node.TEXT_NODE?k.parentElement?.closest(".message-assistant, .message-user"):k?.closest(".message-assistant, .message-user"))?D:null},Fn=()=>{yt?(b([]),z(null),lt(!1),st.current&&(clearTimeout(st.current),st.current=null)):(lt(!0),st.current&&clearTimeout(st.current),st.current=setTimeout(()=>{lt(!1),st.current=null},3e3))},Cs=o=>{Pt(o),o==="quiz-me"&&wt(!0),l?.(o)},Ns=()=>{Pt(null),l?.(null)},Ss=()=>{wt(!1),Pt(null),l?.(null)};a.useEffect(()=>{u&&(u.current=Ns)},[u]),a.useEffect(()=>{Ve?localStorage.setItem("chatnote-interaction-mode",Ve):localStorage.removeItem("chatnote-interaction-mode")},[Ve]),a.useEffect(()=>{Ve&&l?.(Ve)},[Ve,l]),a.useEffect(()=>{Ve==="quiz-me"&&!Ce&&wt(!0)},[]);const Es=async(o,D)=>{if(!s){z("Please load a PDF document first");return}wt(!1),rt(null),ln(!0),z(null);try{const k=await pr(s,{count:o,difficulty:"medium",questionTypes:D});if(!k.canGenerate)throw new Error(k.error||"You are not eligible to generate a quiz at this time.");const v=await mr(s,{count:o,difficulty:"medium",questionTypes:D});rt({questions:v,currentQuestionIndex:0,score:0,answers:new Map,startTime:new Date,isComplete:!1})}catch(_){z(_ instanceof Error?_.message:"Failed to generate quiz"),Pt(null)}finally{ln(!1)}},Ts=async(o,D)=>{if(!Ce)return;const _=Ce.questions[Ce.currentQuestionIndex],k=await pn(_,D),v=new Map(Ce.answers);v.set(o,D);const O=k.isCorrect?Ce.score+1:Ce.score,oe=Ce.currentQuestionIndex===Ce.questions.length-1;rt({...Ce,answers:v,score:O,currentQuestionIndex:oe?Ce.currentQuestionIndex:Ce.currentQuestionIndex+1,isComplete:oe,endTime:oe?new Date:void 0})},Is=()=>{rt(null),wt(!0)},Ps=()=>{Ce?rt({...Ce,currentQuestionIndex:0,score:0,answers:new Map,startTime:new Date,endTime:void 0,isComplete:!1}):(rt(null),wt(!0))},Dn=()=>{rt(null),Pt(null),l?.(null)},As=(o,D,_)=>{if(o.pageReference){const k=`Quiz Question: ${o.question}

Your Answer: ${D}
${_?"âœ“ Correct!":"âœ— Incorrect"}

Explanation: ${o.explanation}`;g?.(k,o.pageReference,.5)}else{const k=i||1,v=`Quiz Question: ${o.question}

Your Answer: ${D}
${_?"âœ“ Correct!":"âœ— Incorrect"}

Explanation: ${o.explanation}`;g?.(v,k,.5)}},Ms=(o,D,_)=>{const k=o.pageReference||i||1;let v="N/A";if(o.type==="multiple-choice"&&o.options){const oe=o.options.find(ee=>ee.isCorrect);v=oe?oe.text:"N/A"}else Array.isArray(o.correctAnswer)?v=o.correctAnswer.join(", "):v=o.correctAnswer;const O=`**Quiz Question** ${_?"âœ“":"âœ—"}

${o.question}

**Correct Answer:** ${v}

**Explanation:** ${o.explanation}`;c?.(O,o.question,k,.5,`quiz-${o.id}`)};return e.jsx("div",{className:"chatgpt-wrapper",children:s&&e.jsxs(e.Fragment,{children:[!Ve&&e.jsx(gr,{onModeSelect:Cs}),Ve==="quiz-me"&&e.jsxs(e.Fragment,{children:[cn&&e.jsx(yr,{onStartQuiz:Es,onBack:Ss,apiKeyStatus:{hasApiKey:J,isAdmin:de,freeTrial:T||void 0}}),wn&&e.jsxs("div",{className:"quiz-loading",children:[e.jsx("div",{className:"quiz-loading-spinner"}),e.jsx("p",{children:"Generating quiz questions..."})]}),Ce&&!cn&&e.jsx(xr,{session:Ce,onAnswer:Ts,onNextQuestion:()=>{Ce.currentQuestionIndex<Ce.questions.length-1&&rt({...Ce,currentQuestionIndex:Ce.currentQuestionIndex+1})},onPreviousQuestion:()=>{Ce.currentQuestionIndex>0&&rt({...Ce,currentQuestionIndex:Ce.currentQuestionIndex-1})},onRequestMore:(o,D)=>Is(),onFinish:Dn,onRestart:Ps,onAddToPDF:As,onAddToNotes:Ms,onExitReview:Dn})]}),(!Ve||Ve==="guide-me-learn")&&e.jsxs(e.Fragment,{children:[!x&&!A&&r==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),r==="split"&&e.jsxs("div",{className:`chat-panel-header ${y==="dark"?"theme-dark":"theme-light"}`,children:[e.jsx("span",{className:"chat-panel-title",children:"Chat"}),e.jsxs("div",{className:"chat-panel-header-actions",children:[e.jsxs("button",{onClick:Fn,className:`clear-button ${yt?"confirming":""}`,title:yt?"Click again to confirm":"Clear chat",disabled:P.length===0,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:yt?"Confirm":"Clear"})]}),e.jsx("button",{onClick:()=>{S(!1)},className:"close-chat-button",title:"Close chat panel","aria-label":"Close chat panel",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),r==="floating"&&e.jsxs("div",{className:`model-selector-bar ${y==="dark"?"theme-dark":"theme-light"}`,children:[e.jsx("div",{className:"model-selector-wrapper",ref:bt,children:e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(Qn,{mode:fe,onModeChange:We,disabled:!le})})}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{onClick:Fn,disabled:P.length===0,className:`clear-button ${yt?"confirming":""}`,title:yt?"Click again to confirm":"Clear chat",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M3 6h18"}),e.jsx("path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"}),e.jsx("path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"})]}),e.jsx("span",{className:"clear-button-text",children:yt?"Confirm":"Clear"})]}),r==="floating"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:f,className:"notes-toggle-button collapse-button",title:p?"Hide knowledge notes":"Show knowledge notes",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsx("button",{onClick:()=>{K||je.current&&Ge(je.current.scrollTop),me(!K)},className:"collapse-button",title:K?"Expand chat":"Collapse chat","aria-label":K?"Expand chat":"Collapse chat",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{transform:K?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx("path",{d:"M18 15l-6-6-6 6"})})})]})]})]}),e.jsxs("div",{ref:ct,className:`chatgpt-inner ${y==="dark"?"theme-dark":"theme-light"} ${K&&r==="floating"?"collapsed":""}`,style:{...dn?{maxHeight:`${dn}px`}:r==="floating"&&!K&&Ht?{maxHeight:`${Ht}px`}:{}},children:[t&&e.jsxs("div",{className:"selected-text-banner",children:[e.jsxs("span",{className:"banner-text",children:["Selected Text: ",t.length>20?`${t.substring(0,20)}...`:t]}),e.jsxs("div",{className:"banner-buttons",children:[e.jsx("button",{onClick:ks,className:"use-text-button",children:"Tell me more"}),d&&e.jsx("button",{onClick:d,className:"close-text-button",title:"Clear selection",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),(!K||r==="split")&&e.jsxs("div",{ref:je,className:"chatgpt-messages",children:[!x&&A&&!X&&!le&&r==="floating"&&e.jsxs("div",{className:"api-key-warning-floating",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:j?.role==="admin"?"Admin API key not configured on server":T&&T.enabled&&T.remaining>0?`Free trial available: ${T.remaining} remaining`:"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:o=>{o.preventDefault(),o.stopPropagation(),ae()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),!x&&!A&&r==="split"&&e.jsxs("div",{className:"api-key-warning-floating",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!x&&A&&!X&&!le&&r==="split"&&e.jsxs("div",{className:"api-key-warning-floating",children:[e.jsxs("div",{className:"warning-content",children:[e.jsx("span",{children:"âš ï¸ Groq API key not configured"}),e.jsx("span",{className:"warning-hint",children:j?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),e.jsx("button",{className:"api-key-refresh-button",onClick:o=>{o.preventDefault(),o.stopPropagation(),ae()},title:"Refresh API key status",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]})})]}),P.map((o,D)=>{const _=o.role==="assistant"&&D===P.length-1;return e.jsxs("div",{className:`message ${o.role==="user"?"message-user":"message-assistant"}`,children:[e.jsx("div",{className:"message-avatar",children:o.role==="user"?e.jsx("div",{className:"avatar-user",children:j?.picture?e.jsx("img",{src:j.picture,alt:j.name||j.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:k=>{const v=k.target;v.style.display="none";const O=v.parentElement;if(O){const oe=O.querySelector("span.avatar-fallback");oe&&oe.remove();const ee=document.createElement("span");ee.className="avatar-fallback",ee.textContent=j.name?.[0]?.toUpperCase()||j.email[0].toUpperCase(),O.appendChild(ee)}}}):e.jsx("span",{className:"avatar-fallback",children:j?.name?.[0]?.toUpperCase()||j?.email?.[0]?.toUpperCase()||"U"})}):e.jsx("div",{className:"avatar-assistant",children:e.jsx("img",{src:hr,alt:"ChatNote",className:"assistant-avatar-img",onError:k=>{const v=k.target;v.style.display="none";const O=v.parentElement;if(O){const oe=O.querySelector("svg.avatar-fallback-svg");oe&&oe.remove();const ee=document.createElementNS("http://www.w3.org/2000/svg","svg");ee.setAttribute("width","32"),ee.setAttribute("height","32"),ee.setAttribute("viewBox","0 0 24 24"),ee.setAttribute("fill","none"),ee.setAttribute("class","avatar-fallback-svg");const ue=document.createElementNS("http://www.w3.org/2000/svg","path");ue.setAttribute("d","M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"),ue.setAttribute("fill","currentColor"),ee.appendChild(ue),O.appendChild(ee)}}})})}),e.jsxs("div",{className:"message-content-wrapper",children:[e.jsx("div",{className:"message-content",children:o.role==="assistant"&&ie&&!o.content&&_?e.jsxs("div",{className:"typing-indicator",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]}):o.role==="assistant"&&o.content?e.jsxs(e.Fragment,{children:[fe==="thinking"&&o.thinking&&o.thinking.trim().length>0?e.jsxs("div",{className:"thinking-process-container",children:[e.jsxs("button",{className:`thinking-toggle-button ${h[o.id]?"expanded":""}`,onClick:()=>{w(k=>({...k,[o.id]:!(k[o.id]??!1)}))},title:h[o.id]?"Collapse thinking":"Expand thinking",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:h[o.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Thinking Process"}),ie&&_&&!h[o.id]&&e.jsx("span",{style:{marginLeft:"8px",fontSize:"12px",opacity:.7},children:"(generating...)"})]}),h[o.id]&&o.thinking?e.jsxs("div",{className:"thinking-content expanded",children:[e.jsx("div",{className:"markdown-content",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:Kn,children:(()=>{try{const k=ft(o.thinking||"");return k.includes("â€‘")?k.replace(/\u2011/g,"-"):k||""}catch(k){return console.error("Error preprocessing thinking content:",k),(o.thinking||"").replace(/\u2011/g,"-")}})()})}),ie&&_&&e.jsxs("div",{className:"typing-indicator",style:{marginTop:"12px"},children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})]}):null]}):null,o.content&&(typeof o.content!="string"||o.content.trim().length>0)?e.jsx("div",{className:"markdown-content",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:Kn,components:{table:({children:k,...v})=>e.jsx("div",{className:"table-scroll-wrapper",children:e.jsx("table",{...v,children:k})}),div:({children:k,className:v,...O})=>v&&typeof v=="string"&&v.includes("katex-display")&&!v.includes("math-scroll-wrapper")?e.jsx("div",{className:"math-scroll-wrapper",children:e.jsx("div",{className:v,...O,children:k})}):e.jsx("div",{...O,className:v,children:k}),pre:({children:k,className:v,...O})=>{let oe="",ee=!1;const ue=Te=>{if(Te?.props?.className&&typeof Te.props.className=="string"){const Ne=Te.props.className.match(/language-(\w+)/);if(Ne)return ee=!0,Ne[1].toUpperCase()}if(Te?.props?.children){const Ne=Array.isArray(Te.props.children)?Te.props.children:[Te.props.children];for(const Ie of Ne){const et=ue(Ie);if(et)return et}}return null},G=ue(k);G&&(oe=G);const[he,ge]=a.useState(!1),Ue=()=>{let Te="";const Ne=Ie=>{typeof Ie=="string"?Te+=Ie:Ie?.props?.children&&(Array.isArray(Ie.props.children)?Ie.props.children:[Ie.props.children]).forEach(Le=>Ne(Le))};Ne(k),navigator.clipboard.writeText(Te).then(()=>{ge(!0),setTimeout(()=>ge(!1),2e3)})};return e.jsxs("pre",{className:ee?"code-scroll-wrapper":"output-scroll-wrapper","data-language":oe,...O,children:[ee&&e.jsxs("button",{className:`copy-code-button ${he?"copied":""}`,onClick:Ue,title:he?"Copied!":"Copy code",children:[he?e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})}):e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"}),e.jsx("rect",{x:"8",y:"2",width:"8",height:"4",rx:"1",ry:"1"})]}),he?"COPIED":"COPY"]}),k]})}},children:(()=>{try{if(typeof o.content=="string"&&o.content){let k=o.content.replace(/<tool>[\s\S]*?<\/tool>/gi,"").replace(/<think>[\s\S]*?<\/think>/gi,"");return k=ft(k),k=br(k),k.includes("â€‘")?k.replace(/\u2011/g,"-"):k||""}return""}catch(k){return console.error("Error preprocessing message content:",k),(typeof o.content=="string"?o.content:"").replace(/\u2011/g,"-")}})()})}):null]}):o.role==="user"?e.jsx("div",{className:"user-message-content",children:Array.isArray(o.content)?e.jsx(e.Fragment,{children:(()=>{const k=rs(o.content),v=k.filter(G=>G.type==="text"),O=k.filter(G=>G.type==="image_url"),oe=yn[o.id]||{canScrollLeft:!1,canScrollRight:!1},ee=v.map(G=>G.text||"").join(`
`),ue=$n(ee);return e.jsxs(e.Fragment,{children:[ue.mainQuestion&&e.jsx("div",{className:"message-text",children:ue.mainQuestion}),ue.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${N[o.id]?"expanded":""}`,onClick:()=>{R(G=>({...G,[o.id]:!(G[o.id]??!1)}))},title:N[o.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:N[o.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),N[o.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:ue.pdfContext})})]}),!ue.mainQuestion&&!ue.pdfContext&&v.map((G,he)=>e.jsx("div",{className:"message-text",children:G.text},`text-${he}`)),O.length>0&&e.jsxs(e.Fragment,{children:[O.map((G,he)=>{const ge=G.image_url?.url;if(!ge)return null;const Ue=`${o.id}-${he}`;return Ke===Ue?e.jsx("div",{className:"message-image-enlarged-container",children:e.jsx("div",{className:"message-image enlarged",children:e.jsx("div",{className:"message-image-wrapper",children:e.jsx("img",{src:ge,alt:"Uploaded",onClick:Ne=>{Ne.stopPropagation(),De(null)}})})})},`enlarged-${he}`):null}),e.jsxs("div",{className:"message-images-wrapper",children:[oe.canScrollLeft&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-left",onClick:()=>Mn(o.id,"left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:G=>{At.current[o.id]=G,G&&setTimeout(()=>un(o.id),0)},className:"message-images-container",onScroll:()=>un(o.id),children:O.map((G,he)=>{const ge=G.image_url?.url;if(!ge)return null;const Ue=`${o.id}-${he}`;return Ke===Ue?null:e.jsx("div",{className:"message-image-item",children:e.jsx("div",{className:"message-image",children:e.jsxs("div",{className:"message-image-wrapper",children:[e.jsx("img",{src:ge,alt:"Uploaded",onClick:Ne=>{Ne.stopPropagation(),De(Ue)}}),e.jsx("div",{className:"image-magnifier",onClick:Ne=>{Ne.stopPropagation(),De(Ue)},title:"Click to enlarge",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("path",{d:"m21 21-4.35-4.35"}),e.jsx("circle",{cx:"11",cy:"11",r:"3"})]})})]})})},he)})}),oe.canScrollRight&&e.jsx("button",{className:"message-image-scroll-button message-image-scroll-right",onClick:()=>Mn(o.id,"right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]})]})]})})()}):(()=>{const k=typeof o.content=="string"?rs(o.content):"",v=$n(k);return e.jsxs(e.Fragment,{children:[v.mainQuestion&&e.jsx("div",{className:"message-text",children:v.mainQuestion}),v.pdfContext&&e.jsxs("div",{className:"pdf-context-container",children:[e.jsxs("button",{className:`pdf-context-toggle ${N[o.id]?"expanded":""}`,onClick:()=>{R(O=>({...O,[o.id]:!(O[o.id]??!1)}))},title:N[o.id]?"Collapse PDF context":"Expand PDF context",children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:N[o.id]?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:"Context from PDF"})]}),N[o.id]&&e.jsx("div",{className:"pdf-context-content",children:e.jsx("div",{className:"message-text",children:v.pdfContext})})]}),!v.mainQuestion&&!v.pdfContext&&e.jsx("div",{className:"message-text",children:k})]})})()}):e.jsx("div",{className:"markdown-content",children:typeof o.content=="string"?o.content:""})}),o.role==="assistant"&&!o?.usedBrowserSearch&&o?.pdfCitations&&o.pdfCitations.length>0&&e.jsxs("div",{className:"message-citations",children:[e.jsx("span",{className:"message-citations-label",children:"Citations:"}),e.jsx("ul",{className:"message-citations-list",children:o.pdfCitations.map((k,v)=>e.jsx("li",{children:k},v))})]}),o.role==="assistant"&&o?.usedBrowserSearch&&o?.browserSearchSources&&o.browserSearchSources.length>0&&(()=>{const k=o.browserSearchSources,v=$[o.id]??!1,O=vr(typeof o.content=="string"?o.content:""),oe=O.length,ee=k.length,ue=oe>0?`${oe} cited`:"No explicit citations";return e.jsxs("div",{className:`message-citations ${v?"expanded":"collapsed"}`,children:[e.jsxs("div",{className:"message-citations-header",children:[e.jsx("span",{className:"message-citations-label",children:"Sources"}),e.jsxs("span",{className:"message-citations-count",children:[ue," â€¢ ",ee," retrieved"]})]}),e.jsxs("button",{className:`message-citations-toggle ${v?"expanded":""}`,onClick:()=>{H(G=>({...G,[o.id]:!v}))},"aria-expanded":v,children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{transform:v?"rotate(90deg)":"rotate(0deg)",transition:"transform 0.2s"},children:e.jsx("polyline",{points:"9 18 15 12 9 6"})}),e.jsx("span",{children:v?"Hide sources":`Show sources (${ee})`})]}),v&&e.jsx("ul",{className:"message-citations-list",children:k.map((G,he)=>{const ge=kr(G),Ue=fs(G?.url),Te=jr(G),Ne=Cr(G),Ie=he+1,et=O.includes(Ie);return e.jsxs("li",{id:`browser-source-${Ie}`,className:et?"browser-source-referenced":void 0,children:[e.jsx("div",{className:"browser-source-index",children:Ie}),e.jsxs("div",{className:"browser-source-body",children:[e.jsx("a",{href:G.url,target:"_blank",rel:"noopener noreferrer",className:"browser-source-title",children:ge}),e.jsxs("div",{className:"browser-source-meta",children:[e.jsx("span",{className:"browser-source-domain",children:Ue}),Te&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"browser-source-meta-divider","aria-hidden":"true",children:"â€¢"}),e.jsx("span",{className:"browser-source-lines",children:Te})]}),et&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"browser-source-meta-divider","aria-hidden":"true",children:"â€¢"}),e.jsx("span",{className:"browser-source-lines",children:"Cited"})]})]}),Ne&&e.jsx("p",{className:"browser-source-snippet",children:Ne})]}),e.jsx("a",{href:G.url,target:"_blank",rel:"noopener noreferrer",className:"browser-source-open","aria-label":`Open ${ge} in new tab`,children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"}),e.jsx("polyline",{points:"15 3 21 3 21 9"}),e.jsx("line",{x1:"10",y1:"14",x2:"21",y2:"3"})]})})]},he)})})]})})(),o.role==="assistant"&&o.content&&e.jsxs("div",{className:"message-actions",children:[e.jsxs("button",{className:"message-action-button copy-button",onClick:async()=>{try{const k=typeof o.content=="string"?o.content:Array.isArray(o.content)?o.content.filter(v=>v.type==="text").map(v=>v.text).join(`
`):"";await navigator.clipboard.writeText(k)}catch(k){console.error("Failed to copy:",k)}},title:"Copy to clipboard",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),e.jsx("span",{className:"message-action-button-text",children:"Copy"})]}),s&&s.trim().length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:"message-action-button knowledge-note-button",onClick:()=>{if(c){we.trackAIResultAction("save_note");const k=we.getCurrentDocumentId();k&&we.updateDocument(k,{has_notes:!0});const v=_n();let O="";v?O=v:O=typeof o.content=="string"?o.content:Array.isArray(o.content)?o.content.filter(G=>G.type==="text").map(G=>G.text).join(`
`):"";const oe=o.selectedTextAtSend||t||void 0,ee=o.pageNumberAtSend||i,ue=o.textYPositionAtSend;c(O,oe,ee,ue,o.id),E&&E()}},title:"Create knowledge note",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),e.jsx("span",{className:"message-action-button-text",children:"Save Note"})]}),e.jsxs("button",{className:"message-action-button add-to-pdf-button",onClick:()=>{if(g){we.trackAIResultAction("add_to_pdf");const k=we.getCurrentDocumentId();k&&we.updateDocument(k,{has_annotations:!0});const v=_n();let O="";if(v)O=v;else if(typeof o.content=="string"){const{mainContent:G}=zt(o.content);O=G}else if(Array.isArray(o.content)){const G=o.content.filter(ge=>ge.type==="text").map(ge=>ge.text).join(`
`),{mainContent:he}=zt(G);O=he}const oe=window.__lastSelectedTextPosition,ee=oe?.pageNumber||i||1,ue=oe?.textYPosition;O.trim()&&(g(O,ee,ue),r==="floating"&&(je.current&&Ge(je.current.scrollTop),me(!0)))}},title:"Add response to PDF as text box",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"12",y1:"18",x2:"12",y2:"12"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Add to PDF"})]})]}),e.jsxs("button",{className:"message-action-button refresh-button",onClick:()=>js(o.id),title:"Get a new response",disabled:ie,children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"23 4 23 10 17 10"}),e.jsx("polyline",{points:"1 20 1 14 7 14"}),e.jsx("path",{d:"M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"})]}),e.jsx("span",{className:"message-action-button-text",children:"Redo"})]}),L[o.id]&&L[o.id].length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"message-action-button nav-button-left",onClick:()=>Rn(o.id,"prev"),title:"Previous response",disabled:!q[o.id]||q[o.id]===0,children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("button",{className:"message-action-button nav-button-right",onClick:()=>Rn(o.id,"next"),title:"Next response",disabled:(()=>{const k=L[o.id]||[];return k.length===0?!0:(q[o.id]??k.length-1)>=k.length-1})(),children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})}),e.jsxs("span",{className:"response-counter",children:[(q[o.id]??L[o.id].length-1)+1," / ",L[o.id].length]})]})]})]})]},o.id)}),F&&e.jsxs("div",{className:"error-message",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("div",{className:"error-text",children:F})]}),e.jsx("div",{ref:Mt})]}),r==="split"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:`model-selector-bar ${y==="dark"?"theme-dark":"theme-light"}`,children:[e.jsx("div",{className:"model-selector-wrapper",ref:bt,children:e.jsx("div",{className:"model-mode-toggle-container",children:e.jsx(Qn,{mode:fe,onModeChange:We,disabled:!le||!A})})}),e.jsx("div",{className:"header-actions",children:e.jsx("button",{onClick:f,className:"layout-toggle-button collapse-button",title:p?"Hide knowledge notes":"Show knowledge notes","aria-label":p?"Hide knowledge notes":"Show knowledge notes",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})})})]})}),e.jsxs("div",{className:"chatgpt-input-container",onDragOver:Ae,onDragLeave:He,onDrop:_t,children:[Oe.length>0&&e.jsxs("div",{className:"uploaded-images-preview-wrapper",children:[xt&&e.jsx("button",{className:"image-scroll-button image-scroll-left",onClick:()=>An("left"),title:"Scroll left",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"15 18 9 12 15 6"})})}),e.jsx("div",{ref:Rt,className:"uploaded-images-preview",onScroll:ot,children:Oe.map((o,D)=>e.jsxs("div",{className:"image-preview-item",children:[e.jsx("img",{src:o,alt:`Upload ${D+1}`}),e.jsx("button",{type:"button",className:"image-preview-remove",onClick:()=>{ze(_=>_.filter((k,v)=>v!==D))},title:"Remove image",children:"Ã—"})]},D))}),It&&e.jsx("button",{className:"image-scroll-button image-scroll-right",onClick:()=>An("right"),title:"Scroll right",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),!J&&!de&&T&&T.enabled&&e.jsxs("div",{className:"free-trial-badge",children:[e.jsxs("div",{className:"free-trial-content",children:[e.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"})}),e.jsx("span",{className:"trial-text",children:"Free Trial"}),e.jsxs("div",{className:"trial-count-badge",children:[T.remaining,"/",T.limit]})]}),e.jsx("div",{className:"trial-progress-mini",children:e.jsx("div",{className:"trial-fill-mini",style:{width:`${Math.round(T.remaining/Math.max(1,T.limit)*100)}%`}})})]}),e.jsxs("div",{className:`input-wrapper${on&&qe()?" drag-over":""}${Et?` focus-${fe}`:""}`,children:[qe()&&e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:Lt,type:"file",accept:"image/*",multiple:!0,onChange:Ze,style:{display:"none"},disabled:!le||!A}),e.jsx("button",{type:"button",onClick:o=>{o.preventDefault(),o.stopPropagation(),Lt.current?.click()},className:"image-upload-button",title:"Upload images",disabled:!le||!A,style:{order:-1},children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),e.jsx("polyline",{points:"21 15 16 10 5 21"})]})})]}),e.jsx("textarea",{ref:Ct,value:re,onChange:o=>ce(o.target.value),onKeyPress:vs,onFocus:()=>Tt(!0),onBlur:()=>Tt(!1),placeholder:"Ask a question...",rows:1,className:"chatgpt-input",disabled:ie||!le||!A}),ie?e.jsx("button",{onClick:bs,className:"send-button pause-button",title:"Pause/Stop response",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"}),e.jsx("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"})]})}):e.jsx("button",{onClick:Ln,disabled:!re.trim()&&!t&&Oe.length===0||!le||!A,className:"send-button",title:"Send message",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})]}),r==="split"&&!Ve&&P.length===0&&!t&&e.jsx("div",{className:`footer-text-outer split-footer ${y==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})}),r==="floating"&&!Ve&&P.length===0&&!t&&e.jsx("div",{className:`footer-text-outer ${y==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})})]})]})]})})}class $r extends a.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}render(){return this.state.hasError?this.props.fallback||e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#666",height:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{maxWidth:"400px"},children:[e.jsx("h3",{style:{marginBottom:"10px"},children:"PDF Viewer Temporarily Unavailable"}),e.jsx("p",{style:{marginBottom:"20px"},children:"There's a configuration issue with the PDF viewer. The rest of the app is working fine!"}),e.jsxs("p",{style:{fontSize:"12px",color:"#999",marginBottom:"20px"},children:["Error: ",this.state.error?.message||"Unknown error"]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("label",{htmlFor:"pdf-upload-fallback",style:{padding:"12px 24px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"6px",fontSize:"16px",fontWeight:"500",cursor:"pointer",display:"inline-block"},children:"Upload PDF (Basic)"}),e.jsx("input",{id:"pdf-upload-fallback",type:"file",accept:"application/pdf",onChange:s=>{const n=s.target.files?.[0];n&&alert(`PDF "${n.name}" selected. PDF viewing will work once the configuration issue is resolved.`)},style:{display:"none"}})]}),e.jsx("button",{onClick:()=>this.setState({hasError:!1,error:null}),style:{marginTop:"15px",padding:"8px 16px",backgroundColor:"#6c757d",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Try Again"})]})}):this.props.children}}const _r=({notes:t,onDeleteNote:s,onClearAllNotes:n,onScrollToPage:r,onHighlightText:i,layout:c,theme:d,onNoteClick:g,isVisible:E=!0,onClose:f,pdfContentRef:p})=>{const[l,u]=a.useState(new Set),m=a.useRef(null),M=a.useRef(0),[y,A]=a.useState(0),[j,x]=a.useState(new Map),[S,P]=a.useState("following"),[b,h]=a.useState(!1),[w,N]=a.useState(null),[R,$]=a.useState(null),H=a.useRef(!1),L=a.useRef(null),Y=a.useRef(0);a.useEffect(()=>{if(!b)return;const F=z=>{z.key==="Escape"&&(h(!1),N(null))};return document.addEventListener("keydown",F),()=>{document.removeEventListener("keydown",F)}},[b]);const q=a.useCallback((F,z)=>{z.preventDefault(),z.stopPropagation(),u(J=>{const ke=new Set(J);return ke.has(F)?ke.delete(F):ke.add(F),ke})},[]);a.useEffect(()=>{const F=L.current!==S&&L.current!==null,z=Y.current!==t.length&&Y.current>0,J=L.current===null;z?we.endNoteModeTracking().then(()=>{we.startNoteModeTracking(S),Y.current=t.length}):F?(we.startNoteModeTracking(S),L.current=S):J&&t.length>0?(we.startNoteModeTracking(S),L.current=S,Y.current=t.length):we.startNoteModeTracking(S);const ke=()=>{we.endNoteModeTracking()};return window.addEventListener("pagehide",ke),document.addEventListener("visibilitychange",ke),()=>{window.removeEventListener("pagehide",ke),document.removeEventListener("visibilitychange",ke)}},[S,t.length]),a.useEffect(()=>{const F=()=>p?.current?p.current:window.__pdfContentRef||null,z=()=>{const de=F();if(de&&m.current){const C=de.scrollHeight;if(M.current!==C&&(M.current=C,A(C)),S==="following"?m.current.style.height=`${C}px`:m.current.style.height="auto",S==="following"){const T=de.scrollTop;m.current.style.transform=`translateY(-${T}px)`}else m.current.style.transform="none"}};z();const J=F();if(J){const de=()=>{if(m.current&&S==="following"){const B=J.scrollTop;m.current.style.transform=`translateY(-${B}px)`}else m.current&&S==="stack"&&(m.current.style.transform="none")};J.addEventListener("scroll",de,{passive:!0});const C=new ResizeObserver(()=>{z()});C.observe(J);const T=setInterval(z,1e3);return()=>{clearInterval(T),J.removeEventListener("scroll",de),C.disconnect()}}const ke=setTimeout(z,100);return()=>clearTimeout(ke)},[p,E,t.length,S]);const ne=F=>{F.pageNumber&&r?(r(F.pageNumber),setTimeout(()=>{F.linkedText&&i&&i(F.linkedText)},500)):F.linkedText&&i&&i(F.linkedText)},re=F=>{const z=new Date(F);return z.toLocaleDateString()+" "+z.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},ce=a.useCallback(()=>{if(H.current)return;H.current=!0;const F=p?.current||window.__pdfContentRef;if(!F){H.current=!1;return}const z=new Map;t.forEach(J=>{if(!J.pageNumber||J.textYPosition===void 0)return;const ke=F.querySelectorAll(".pdf-page-wrapper");if(ke.length<J.pageNumber){const Z=F.querySelectorAll(".react-pdf__Page");if(Z.length<J.pageNumber)return;const K=Z[J.pageNumber-1];if(!K)return;const me=K.offsetTop,be=K.offsetHeight,Ge=me+J.textYPosition*be;z.set(J.id,Ge);return}const de=ke[J.pageNumber-1];if(!de)return;const C=de.offsetTop,T=de.offsetHeight,B=J.textYPosition*T,X=C+B;z.set(J.id,X)}),x(z),setTimeout(()=>{H.current=!1},0)},[t,p]);a.useEffect(()=>{if(!E)return;ce();const F=p?.current||window.__pdfContentRef;if(F){const z=new ResizeObserver(()=>{ce()});z.observe(F);const J=setInterval(ce,500);return()=>{z.disconnect(),clearInterval(J)}}},[ce,p,E]),a.useEffect(()=>{if(y>0){const F=setTimeout(()=>{ce()},200);return()=>clearTimeout(F)}},[y,ce]),a.useEffect(()=>{if(t.length===0){$(null);return}const F=t.some(z=>z.id===R);R&&!F&&$(null)},[t,R]);const ie=F=>j.get(F.id),Be=(F,z)=>{const J=ie(F);if(J===void 0)return{stackIndex:0,stackSize:1,basePosition:0,displayIndex:0};const ke=10,de=z.filter(Z=>{const K=ie(Z);return K!==void 0&&Math.abs(K-J)<ke}).sort((Z,K)=>Z.createdAt-K.createdAt),C=de.findIndex(Z=>Z.id===F.id),T=de.length,B=Math.min(...de.map(Z=>ie(Z)||0));let X=C;if(T>1&&R){const Z=de.findIndex(K=>K.id===R);if(Z!==-1){const K=de.filter((me,be)=>be>C).length;if(C>Z)X=T-1-K;else{const me=(C-Z+T)%T,be=de.filter((Ge,fe)=>fe>Z).length;X=Math.min(me,T-1-be)}}}else T>1&&(X=C);return{stackIndex:C,stackSize:T,basePosition:B,displayIndex:X}};return e.jsxs("div",{className:`knowledge-notes-panel ${c}-layout theme-${d} ${E?"knowledge-notes-visible":""}`,children:[e.jsxs("div",{className:"knowledge-notes-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h3",{children:"Knowledge Notes"}),e.jsx("button",{className:"display-mode-toggle",onClick:()=>P(S==="following"?"stack":"following"),title:S==="following"?"Switch to stack mode":"Switch to following mode",style:{background:"transparent",border:"1px solid rgba(0, 0, 0, 0.2)",borderRadius:"4px",padding:"4px 8px",cursor:"pointer",fontSize:"12px",color:"inherit",display:"flex",alignItems:"center",gap:"4px"},children:S==="following"?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]}),"Following"]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),"Stack"]})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxs("button",{className:"notes-count-button",onClick:F=>{F.preventDefault(),F.stopPropagation(),t.length>0&&(N(null),h(!0))},title:t.length>0?"Clear all notes":"No notes to clear",disabled:t.length===0,children:[e.jsx("span",{className:"notes-count-text",children:t.length}),e.jsxs("svg",{className:"notes-count-clear-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})]}),e.jsx("button",{className:"knowledge-notes-close",onClick:async F=>{F.stopPropagation(),await we.endNoteModeTracking(),f?.()},"aria-label":"Close knowledge notes",style:{display:"flex",alignItems:"center",justifyContent:"center",background:"transparent",border:"none",cursor:"pointer",padding:"4px",width:"32px",height:"32px",borderRadius:"6px",transition:"background 0.2s, color 0.2s"},children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx("div",{className:`knowledge-notes-list ${S==="stack"?"stack-mode":"following-mode"}`,ref:m,style:{height:S==="following"&&y>0?`${y}px`:"auto",overflow:S==="stack"?"auto":"visible"},children:t.length===0?e.jsx("div",{className:"empty-notes",children:"No knowledge notes yet"}):t.map(F=>{const z=l.has(F.id),J=ie(F),de=(F.content?F.content.split(`
`):[]).length>3||F.content&&F.content.length>200,C=R===F.id,T=Be(F,t),B=8,X=1.5,Z=2,K=T.displayIndex*B,me=T.displayIndex*Z,be=T.stackSize-1,Ge=T.stackIndex===T.stackSize-1,fe=be*X,nt=Ge?fe:T.displayIndex*X,Et=J!==void 0?T.displayIndex===0?J:J+K:void 0,Tt=T.displayIndex===0?0:nt,Ke=T.displayIndex===0?0:me;return e.jsxs("div",{className:`knowledge-note-item ${C?"note-front":""} ${T.stackSize>1?"note-stacked":""}`,onClick:De=>{const Oe=De.target;if(!(Oe.closest("button")||Oe.closest(".note-linked-text")))if(ne(F),g?.(F),S==="following"&&T.stackSize>1)if(R!==F.id)$(F.id);else{const ze=t.filter(xt=>{const Xe=ie(xt),It=ie(F);return Xe!==void 0&&It!==void 0&&Math.abs(Xe-It)<10}).sort((xt,Xe)=>xt.createdAt-Xe.createdAt),it=(ze.findIndex(xt=>xt.id===F.id)+1)%ze.length;$(ze[it].id)}else S==="following"&&$(F.id)},style:S==="following"&&Et!==void 0?{position:"absolute",top:`${Et}px`,left:`${8+Ke}px`,right:`${8-Ke}px`,width:"auto",zIndex:T.displayIndex===0?20+T.stackSize:10+T.displayIndex,pointerEvents:"auto",transform:`rotate(${Tt}deg)`,transformOrigin:"center top",transition:"transform 0.3s ease, z-index 0.2s ease, top 0.3s ease, left 0.3s ease, right 0.3s ease",boxShadow:T.displayIndex===0?"0 4px 16px rgba(0, 0, 0, 0.15)":`0 ${2+T.displayIndex}px ${8+T.displayIndex*2}px rgba(0, 0, 0, ${.1+T.displayIndex*.02})`}:{position:"relative",marginBottom:"12px",marginLeft:"8px",marginRight:"8px",width:"auto"},children:[e.jsxs("div",{className:"note-header",children:[e.jsxs("div",{className:"note-meta",children:[F.pageNumber&&e.jsxs("span",{className:"note-page-badge",children:["Page ",F.pageNumber]}),F.linkedText&&e.jsx("span",{className:"note-text-badge",children:"Linked Text"}),e.jsx("span",{className:"note-date",children:re(F.createdAt)})]}),e.jsx("button",{className:"note-delete-button",onClick:De=>{De.stopPropagation(),N(F.id),h(!0)},title:"Delete note",children:"Ã—"})]}),F.linkedText&&e.jsxs("div",{className:"note-linked-text",onClick:()=>{ne(F),g?.(F)},children:['"',F.linkedText.substring(0,100),F.linkedText.length>100?"...":"",'"']}),e.jsxs("div",{className:"note-content-wrapper",children:[e.jsx("div",{className:`note-content ${z?"expanded":"collapsed"}`,children:e.jsx("div",{className:"markdown-content",children:e.jsx(gt,{remarkPlugins:[mt,pt],rehypePlugins:[[vt,{strict:!1,throwOnError:!1,errorColor:"#cc0000",macros:{},fleqn:!1,output:"html",trust:!1}]],components:{p:({children:De})=>e.jsx("p",{style:{marginBottom:"0.5em"},children:De}),a:({href:De,children:Oe})=>e.jsx("a",{href:De,target:"_blank",rel:"noopener noreferrer",onClick:ze=>ze.stopPropagation(),children:Oe})},children:ft(F.content)})})}),de&&e.jsx("button",{className:"note-expand-button",onClick:De=>{De.preventDefault(),De.stopPropagation(),q(F.id,De)},onMouseDown:De=>{De.stopPropagation()},title:z?"Collapse":"Expand",type:"button",children:z?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}),e.jsx("span",{children:"Show Less"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{children:"Show More"})]})})]})]},F.id)})}),b&&e.jsx("div",{className:"confirm-dialog-overlay",onClick:()=>{h(!1),N(null)},children:e.jsxs("div",{className:"confirm-dialog",onClick:F=>F.stopPropagation(),children:[e.jsx("div",{className:"confirm-dialog-header",children:e.jsx("h3",{children:w?"Delete Note":"Clear All Notes"})}),e.jsx("div",{className:"confirm-dialog-content",children:w?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"Are you sure you want to delete this knowledge note?"}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Are you sure you want to delete all ",e.jsx("strong",{children:t.length})," knowledge note",t.length===1?"":"s","?"]}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]})}),e.jsxs("div",{className:"confirm-dialog-actions",children:[e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-cancel",onClick:()=>{h(!1),N(null)},children:"Cancel"}),e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-confirm",onClick:()=>{w?(s(w),N(null)):n&&n(),h(!1)},children:w?"Delete":"Clear All"})]})]})})]})},xn="chatnote_pdf_history_cache",Fr="pdf-history-cache-updated",Dr=300*1e3;function rn(){if(!(typeof window>"u"||typeof window.dispatchEvent!="function"))try{window.dispatchEvent(new CustomEvent(Fr))}catch{}}function jn(t=3){const s=localStorage.getItem(xn);let n=[];try{if(s){const r=JSON.parse(s);r&&Array.isArray(r.pdfs)&&(n=r.pdfs.slice(0,t))}}catch{}return n}function Or(t){try{const s={pdfs:t,timestamp:Date.now()};localStorage.setItem(xn,JSON.stringify(s)),rn()}catch{}}function zr(t=Dr){try{const s=localStorage.getItem(xn);if(!s)return!1;const n=JSON.parse(s);return!n||typeof n.timestamp!="number"?!1:Date.now()-n.timestamp<t}catch{return!1}}async function xo(t=3){try{const s=localStorage.getItem("auth_token");if(!s)return jn(t);const n=jn(t),r=zr(),i=fetch(`${pe}/api/drive/history`,{headers:{Authorization:`Bearer ${s}`}}).then(async d=>{if(!d.ok){if(d.status===403){try{localStorage.removeItem(xn),rn()}catch{}return[]}return[]}const E=(await d.json()).pdfs||[];return Or(E),E.slice(0,t)}).catch(()=>[]);if(r)return i.catch(()=>{}),n;const c=await i;return c.length>0?c:n}catch{return jn(t)}}const tt="chatnote_pdf_history_cache",ys=300*1e3,ws="chatnote_pdf_history_names",Tn="chatnote_pdf_history_version",In="chatnote_pdf_history_last_fetch",Br=()=>{try{const t=localStorage.getItem(ws);if(!t)return{};const s=JSON.parse(t);if(s&&typeof s=="object")return s}catch(t){console.warn("Failed to parse generated name cache:",t)}return{}},os=t=>{try{localStorage.setItem(ws,JSON.stringify(t))}catch(s){console.warn("Failed to persist generated name cache:",s)}},Wr=t=>{try{const s=localStorage.getItem(tt);if(!s)return;const n=JSON.parse(s);n.pdfs=(n.pdfs||[]).filter(r=>r.pdfId!==t),localStorage.setItem(tt,JSON.stringify(n)),rn()}catch(s){console.warn("Failed to update history cache after deletion:",s)}},qr=t=>{if(!t)return"";const s="__REASONING_START__",n="__REASONING_END__";if(t.includes(s)&&t.includes(n)){const r=t.indexOf(n)+n.length;t=t.slice(r)}return t=t.replace(/<think>[\s\S]*?<\/think>/gi,""),t.trim()},Hr=(t,s)=>{const n=qr(t);if(!n)return s;const i=n.split(`
`)[0].replace(/^["'â€œâ€`]+|["'â€œâ€`]+$/g,"").replace(/[.:]+$/g,"").trim().replace(/\s+/g," ");return i?i.length>60?`${i.slice(0,57).trimEnd()}...`:i:s},Zt=()=>{try{const t=localStorage.getItem(Tn);if(!t)return 0;const s=Number(t);return Number.isFinite(s)?s:0}catch{return 0}},Ur=()=>{try{const t=sessionStorage.getItem(In);if(!t)return 0;const s=Number(t);return Number.isFinite(s)?s:0}catch{return 0}},Vr=t=>{try{sessionStorage.setItem(In,`${t}`)}catch{}},Pn="chatnote_pdf_history_pending_save",Gr=()=>{try{localStorage.setItem(Pn,"true")}catch{}},is=()=>{try{localStorage.removeItem(Pn)}catch{}},mn=()=>{try{return localStorage.getItem(Pn)==="true"}catch{return!1}},Qr=()=>{try{sessionStorage.removeItem(In)}catch{}},tn=t=>{try{localStorage.setItem(Tn,`${Date.now()}`),t&&Gr()}catch{}},Yr=()=>{try{localStorage.removeItem(Tn)}catch{}};function nn(){try{const t=localStorage.getItem(tt);if(t)try{const s=JSON.parse(t);s.timestamp=0,localStorage.setItem(tt,JSON.stringify(s))}catch{localStorage.removeItem(tt)}else localStorage.removeItem(tt);rn()}catch(t){console.warn("Failed to invalidate PDF history cache:",t)}}let en=null;async function Cn(t){try{const s=localStorage.getItem("auth_token");if(!s)return;const n=localStorage.getItem(tt);if(n)try{const r=JSON.parse(n);if(Date.now()-r.timestamp<ys)return}catch{}return en||(en=(async()=>{try{const r=await fetch(`${t}/api/drive/history`,{headers:{Authorization:`Bearer ${s}`}});if(r.ok){const c=(await r.json()).pdfs||[];try{const d={pdfs:c,timestamp:Date.now()};localStorage.setItem(tt,JSON.stringify(d))}catch(d){console.warn("Failed to save cached history:",d)}}else if(r.status===403)try{localStorage.removeItem(tt)}catch{}}finally{en=null}})(),en)}catch{}}function Kr({isOpen:t,onClose:s,onSelectPdf:n,hasUnsavedChanges:r=!1,onSaveBeforeFetch:i,isDriveAuthorized:c=!1,isGoogleDriveEligible:d=!1}){const{isAuthenticated:g}=qt(),[E,f]=a.useState([]),[p,l]=a.useState(!1),[u,m]=a.useState(null),[M,y]=a.useState(!1),[A,j]=a.useState(()=>Br()),[x,S]=a.useState({}),P=a.useRef(new Set),[b,h]=a.useState(!1),[w,N]=a.useState(""),[R,$]=a.useState({}),[H,L]=a.useState({}),Y=a.useRef({}),[q,ne]=a.useState(()=>Ur()),re=a.useRef(t),ce=()=>{try{const C=localStorage.getItem(tt);if(!C)return null;const T=JSON.parse(C);if(Date.now()-T.timestamp<ys)return T.pdfs}catch(C){console.warn("Failed to load cached history:",C)}return null},ie=C=>{try{const T={pdfs:C,timestamp:Date.now()};localStorage.setItem(tt,JSON.stringify(T)),rn()}catch(T){console.warn("Failed to save cached history:",T)}};a.useEffect(()=>{re.current=t},[t]),a.useEffect(()=>()=>{Object.values(Y.current).forEach(C=>clearTimeout(C)),Y.current={}},[]),a.useEffect(()=>{let C=!0;return nr().then(T=>{C&&h(T)}).catch(()=>{C&&h(!1)}),()=>{C=!1}},[]),a.useEffect(()=>{if(t&&g){y(!1);const C=ce();if(C){f(C),l(!1);const T=Zt(),B=T>0&&T>q,X=mn(),Z=r;(B||X||Z||!C||C.length===0)&&(Z&&i?i().then(()=>{const me=Zt(),be=mn();z(!0,me,be)}).catch(()=>{const me=Zt(),be=mn();z(!0,me,be)}):z(!0,T,X))}else l(!0),z(!1,Zt(),mn())}else g?t||(y(!1),N(""),L({})):(f([]),m(null),l(!1),y(!1),Yr(),ne(0),Qr(),is())},[t,g]),a.useEffect(()=>{if(!b||E.length===0)return;let C=!1;return(async()=>{for(const B of E){if(C)return;const X=A[B.pdfId];let Z=!1;if(X?Z=X.originalFileName!==B.originalFileName:Z=B.displayName.toLowerCase().endsWith(".pdf")||B.displayName===B.originalFileName,!(!Z||P.current.has(B.pdfId))){P.current.add(B.pdfId),S(K=>({...K,[B.pdfId]:!0}));try{const K=`You generate short, descriptive titles for uploaded PDFs.
File name: "${B.originalFileName}".
Output a concise (<=5 words) human-friendly title without quotes.`,me=await sn([{role:"user",content:K}],void 0,void 0,Wt[0]);if(C)return;const be=Hr(me.content,B.displayName||B.originalFileName);j(Ge=>{const fe=Ge[B.pdfId];if(fe&&fe.name===be&&fe.originalFileName===B.originalFileName)return Ge;const nt={...Ge,[B.pdfId]:{name:be,originalFileName:B.originalFileName,updatedAt:Date.now()}};return os(nt),nt})}catch(K){console.warn("Failed to generate PDF title:",K)}finally{P.current.delete(B.pdfId),S(K=>{const me={...K};return delete me[B.pdfId],me})}}}})(),()=>{C=!0}},[b,E]);const Be=a.useCallback(C=>{L(T=>({...T,[C]:!0})),Y.current[C]&&clearTimeout(Y.current[C]),Y.current[C]=window.setTimeout(()=>{L(T=>{const B={...T};return delete B[C],B}),delete Y.current[C]},4e3)},[]),F=a.useCallback(async C=>{if(C){$(T=>({...T,[C]:!0}));try{const T=localStorage.getItem("auth_token");if(!T)throw new Error("Please log in again.");const B=await fetch(`${pe}/api/drive/history/${C}`,{method:"DELETE",headers:{Authorization:`Bearer ${T}`}});if(!B.ok){const X=await B.text();throw new Error(X||"Failed to delete PDF")}f(X=>X.filter(Z=>Z.pdfId!==C)),j(X=>{if(!X[C])return X;const Z={...X};return delete Z[C],os(Z),Z}),Wr(C),nn(),tn(!1)}catch(T){console.error("Failed to delete PDF:",T),alert(T instanceof Error?T.message:"Failed to delete PDF")}finally{$(T=>{const B={...T};return delete B[C],B}),L(T=>{if(!T[C])return T;const B={...T};return delete B[C],B}),Y.current[C]&&(clearTimeout(Y.current[C]),delete Y.current[C])}}},[]),z=async(C=!1,T,B)=>{if(!d||!c){re.current&&!C&&(m("Google Drive not authorized. Please authorize Drive access to view PDF history."),l(!1));return}if(re.current){C?y(!0):l(!0),m(null);try{const X=localStorage.getItem("auth_token");if(!X){re.current&&m("Not authenticated"),C?y(!1):l(!1);return}const Z=await fetch(`${pe}/api/drive/history`,{headers:{Authorization:`Bearer ${X}`}});if(!Z.ok){if(re.current){const be=await Z.text();Z.status===403?be.includes("expired")||be.includes("try again")?m("Drive authorization may have expired. Please try again or re-authorize."):(m("Drive not authorized. Please authorize Drive access first."),localStorage.removeItem(tt)):m("Failed to load PDF history")}C?y(!1):l(!1);return}const me=(await Z.json()).pdfs||[];if(re.current){f(me),ie(me);const be=T&&T>0?T:Zt();be>0&&(ne(be),Vr(be)),B&&is()}}catch(X){console.error("Error loading history:",X),re.current&&!C&&m("Failed to load PDF history")}finally{C?y(!1):l(!1)}}},J=C=>{const T=new Date(C),X=new Date().getTime()-T.getTime(),Z=Math.floor(X/6e4),K=Math.floor(X/36e5),me=Math.floor(X/864e5);return Z<1?"Just now":Z<60?`${Z}m ago`:K<24?`${K}h ago`:me<7?`${me}d ago`:T.toLocaleDateString()},ke=a.useMemo(()=>{const C=w.trim().toLowerCase();return C?E.filter(T=>(A[T.pdfId]?.name||"").toLowerCase().includes(C)||T.originalFileName.toLowerCase().includes(C)||T.displayName.toLowerCase().includes(C)):E},[E,w,A]),de=w.trim().length>0;return t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"pdf-history-overlay",onClick:s}),e.jsxs("div",{className:"pdf-history-panel",children:[e.jsxs("div",{className:"pdf-history-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h2",{children:"PDF History"}),M&&e.jsx("div",{className:"pdf-history-refresh-indicator",title:"Refreshing...",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"})})})]}),e.jsx("button",{className:"pdf-history-close",onClick:s,"aria-label":"Close history",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsxs("div",{className:"pdf-history-content",children:[!d&&e.jsxs("div",{className:"pdf-history-unavailable",children:[e.jsx("h3",{children:"PDF History Not Available"}),e.jsx("p",{children:"You don't have access to the PDF history feature. Please contact support if you believe this is an error."})]}),d&&e.jsxs(e.Fragment,{children:[!u&&e.jsxs("div",{className:"pdf-history-search",children:[e.jsx("input",{type:"search",placeholder:"Search by title or file name...",value:w,onChange:C=>N(C.target.value),"aria-label":"Search PDF history",disabled:p&&E.length===0}),w&&e.jsx("button",{type:"button",className:"pdf-history-search-clear",onClick:()=>N(""),"aria-label":"Clear search",children:"Ã—"})]}),p&&e.jsxs("div",{className:"pdf-history-loading",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading PDF history..."})]}),u&&e.jsxs("div",{className:"pdf-history-error",children:[e.jsx("p",{children:u}),(!c||u.includes("expired")||u.includes("try again"))&&e.jsx("button",{className:"authorize-drive-button",onClick:async()=>{try{const C=localStorage.getItem("auth_token");if(!C)return;const T=await fetch(`${pe}/api/drive/auth`,{headers:{Authorization:`Bearer ${C}`}});if(!T.ok)throw new Error("Failed to initiate Drive authorization");const B=await T.json();B.authorized?z():B.authUrl&&(window.location.href=B.authUrl)}catch(C){console.error("Error authorizing Drive:",C),m("Failed to authorize Drive access. Please try again.")}},children:"Authorize Drive Access"})]}),!p&&!u&&E.length===0&&!de&&e.jsxs("div",{className:"pdf-history-empty",children:[e.jsx("p",{children:"No PDFs yet"}),e.jsx("p",{className:"pdf-history-empty-hint",children:"Upload a PDF to get started"})]}),!p&&!u&&de&&ke.length===0&&e.jsxs("div",{className:"pdf-history-empty",children:[e.jsx("p",{children:"No PDFs match your search"}),e.jsx("button",{type:"button",className:"pdf-history-search-reset",onClick:()=>N(""),children:"Clear search"})]}),!p&&!u&&ke.length>0&&e.jsx("div",{className:"pdf-history-list",children:ke.map(C=>{const T=A[C.pdfId]?.name||C.displayName,B=!!x[C.pdfId],X=!!R[C.pdfId],Z=!!H[C.pdfId];return e.jsxs("div",{className:"pdf-history-item",onClick:()=>{X||(n(C.pdfId),s())},children:[e.jsx("div",{className:"pdf-history-item-icon",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),e.jsxs("div",{className:"pdf-history-item-content",children:[e.jsxs("div",{className:"pdf-history-item-title",children:[B?e.jsx("div",{className:"pdf-history-title-placeholder",children:e.jsxs("div",{className:"loading-dots",children:[e.jsx("div",{}),e.jsx("div",{}),e.jsx("div",{})]})}):e.jsx("span",{className:"pdf-history-display-name",title:T,children:T}),Z?e.jsx("button",{className:"pdf-history-delete-confirm",onClick:K=>{K.stopPropagation(),F(C.pdfId)},disabled:X,title:X?"Deleting...":"Confirm delete","aria-live":"polite",children:X?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"delete-spinner",role:"status","aria-label":"Deleting..."}),e.jsx("span",{children:"Deleting..."})]}):"Confirm Delete"}):e.jsx("button",{className:"pdf-history-delete",onClick:K=>{K.stopPropagation(),Be(C.pdfId)},disabled:X,title:X?"Deleting...":"Delete PDF",children:X?e.jsx("div",{className:"delete-spinner"}):e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("polyline",{points:"3 6 5 6 21 6"}),e.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),e.jsx("line",{x1:"10",y1:"11",x2:"10",y2:"17"}),e.jsx("line",{x1:"14",y1:"11",x2:"14",y2:"17"})]})})]}),e.jsxs("div",{className:"pdf-history-item-original",title:C.originalFileName,children:[e.jsx("span",{className:"pdf-history-original-name",children:C.originalFileName}),e.jsx("span",{className:"pdf-history-divider",children:"â€¢"}),e.jsx("span",{children:J(C.lastModifiedAt)})]}),e.jsx("div",{className:"pdf-history-item-meta",children:C.pageCount>0&&e.jsxs("span",{children:[C.pageCount," page",C.pageCount!==1?"s":""]})}),(C.hasAnnotations||C.hasNotes)&&e.jsxs("div",{className:"pdf-history-item-badges",children:[C.hasAnnotations&&e.jsx("span",{className:"pdf-history-badge",children:"Annotations"}),C.hasNotes&&e.jsx("span",{className:"pdf-history-badge",children:"Notes"})]})]})]},C.pdfId)})})]})]})]})]}):null}let ht;async function Jr(){if(!ht){if(typeof window<"u"&&window.pdfjsLib)ht=window.pdfjsLib;else{const t=await Bt(()=>import("./vendor-pdf-DDxsMbbh.js").then(s=>s.p),[]);ht=t.default||t}if(typeof window<"u"&&ht&&!ht.GlobalWorkerOptions?.workerSrc){let t;const s="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const n="/ChatNote/";t=`${n.endsWith("/")?n:`${n}/`}pdf.worker.min.js`}ht.GlobalWorkerOptions?(ht.GlobalWorkerOptions.workerSrc=t,ht.GlobalWorkerOptions.standardFontDataUrl=s):ht.GlobalWorkerOptions={workerSrc:t,standardFontDataUrl:s}}}return ht}function Xr(t){return t.replace(/\s+/g," ").trim()}function Zr(t){const s=t.trim();if(!s||s.length>140)return null;const n=s.match(/^(\d+(\.\d+)+|\d+)[)\s.-]+/);if(n){const i=n[1].split(".").length;return Math.min(i+1,4)}if(/^(chapter|section|appendix)\b/i.test(s))return 2;const r=s.replace(/[^a-zA-Z]/g,"");return r.length>0&&r.replace(/[^A-Z]/g,"").length/r.length>.65&&s.length>=4?2:/[:ï¼š]$/.test(s)?3:null}function eo(t){return/^(figure|fig\.?|table)\s+[\w.-]+/i.test(t.trim())}function to(t,s){const n=[],r=[];let i="";const c=()=>{const d=i.trim();d&&n.push({type:"paragraph",text:d}),i=""};return t.forEach(d=>{const g=d.trim();if(!g){c();return}const E=Zr(g);if(E){c(),n.push({type:"heading",text:g,level:E});return}if(eo(g)){c();const f=g.match(/^(figure|fig\.?|table)\s+([\w.-]+)/i),p=f?`${f[1]} ${f[2]}`:`Figure ${r.length+1}`,l=[...n].reverse().find(u=>u.type==="paragraph");r.push({id:`p${s}-fig${r.length+1}`,label:p,pageNumber:s,caption:g,altText:Xr(g),context:l?.text});return}i+=(i?" ":"")+g,i.length>800&&c()}),c(),{blocks:n,figures:r}}async function as(t,s=.6){if(typeof document>"u")return;const n=t.getViewport({scale:s}),r=document.createElement("canvas"),i=r.getContext("2d");if(i)return r.height=n.height,r.width=n.width,await t.render({canvasContext:i,viewport:n}).promise,r.toDataURL("image/png")}async function ls(t){try{const s=await Jr(),n=await t.arrayBuffer(),i=await s.getDocument({data:n,standardFontDataUrl:"https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/"}).promise,c=i.numPages,d=[];for(let f=1;f<=c;f++){const p=await i.getPage(f),m=(await p.getTextContent()).items.map(x=>{const S=x.str||"";return x.hasEOL?`${S}
`:`${S} `}).join("").replace(/\s+\n/g,`
`).replace(/\n{2,}/g,`
`),M=m.split(/\n+/).map(x=>x.trim()).filter(Boolean),{blocks:y,figures:A}=to(M,f);let j;try{j=await as(p,1)}catch(x){console.warn(`Failed to render page image for page ${f}:`,x)}if(A.length>0)try{const x=await as(p,.6);x&&A.forEach(S=>{S.previewDataUrl=x,S.altText||(S.altText=S.caption)})}catch(x){console.warn("Failed to render page preview for figure context",x)}d.push(Promise.resolve({text:m.trim(),number:f,blocks:y,figures:A,pageImageDataUrl:j}))}const g=await Promise.all(d);return{fullText:g.map(({text:f,number:p})=>`--- Page ${p} ---
${f}`).join(`

`),fileName:t.name,pages:g.map(({text:f,number:p,blocks:l,figures:u,pageImageDataUrl:m})=>({pageNumber:p,text:f,blocks:l,figures:u,pageImageDataUrl:m}))}}catch(s){throw console.error("Error extracting text from PDF:",s),new Error("Failed to extract text from PDF. The PDF may be corrupted or password-protected.")}}const no=["#000000","#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#FFC0CB"];function so({isOpen:t,onConfirm:s,onCancel:n}){const{theme:r}=fn();return t?e.jsx("div",{className:"drive-sync-backdrop",children:e.jsxs("div",{className:`drive-sync-modal ${r}`,children:[e.jsx("h3",{children:"Sync with Google Drive?"}),e.jsx("p",{children:"Would you like to sync your PDFs and notes with Google Drive? This allows you to access your files from any device."}),e.jsxs("div",{className:"drive-sync-buttons",children:[e.jsx("button",{onClick:n,className:"button-cancel",children:"Not Now"}),e.jsx("button",{onClick:s,className:"button-confirm",children:"Sync with Drive"})]})]})}):null}function ro({message:t,type:s="info",duration:n=3e3,onClose:r}){const[i,c]=a.useState(!1);return a.useEffect(()=>{const d=setTimeout(()=>{c(!0)},n-300),g=setTimeout(()=>{r()},n);return()=>{clearTimeout(d),clearTimeout(g)}},[n,r]),e.jsx("div",{className:"toast-container",children:e.jsxs("div",{className:`toast ${i?"toast-exit":""}`,children:[e.jsx("svg",{className:`toast-icon ${s}`,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:s==="info"&&e.jsxs(e.Fragment,{children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"16",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"8",x2:"12.01",y2:"8"})]})}),e.jsx("span",{children:t})]})})}const oo=({onResize:t,initialWidth:s,minWidth:n,maxWidth:r,modelMode:i,onDragStateChange:c})=>{const[d,g]=a.useState(!1),[E,f]=a.useState(!1),p=a.useRef(0),l=a.useRef(s),u=()=>{switch(i){case"auto":return"#4285f4";case"quick":return"#4caf50";case"thinking":return"#9c27b0";default:return"#4285f4"}},m=M=>{M.preventDefault(),g(!0),c?.(!0),p.current=M.clientX,l.current=s,document.body.style.cursor="ew-resize",document.body.style.userSelect="none"};return a.useEffect(()=>{if(!d)return;const M=A=>{const j=A.clientX-p.current,x=l.current-j,S=Math.max(n,Math.min(r,x));t(S)},y=()=>{g(!1),c?.(!1),document.body.style.cursor="",document.body.style.userSelect=""};return document.addEventListener("mousemove",M),document.addEventListener("mouseup",y),()=>{document.removeEventListener("mousemove",M),document.removeEventListener("mouseup",y)}},[d,n,r,t,c]),e.jsx("div",{className:`resizable-divider ${d?"dragging":""} ${E?"hovering":""}`,onMouseDown:m,onMouseEnter:()=>f(!0),onMouseLeave:()=>f(!1),style:{"--model-color":u()},children:e.jsxs("div",{className:"divider-handle",children:[e.jsx("div",{className:"divider-grip"}),e.jsx("div",{className:"divider-grip"}),e.jsx("div",{className:"divider-grip"})]})})},io=`
ChatNote â€“ Privacy Policy

Last Updated: Nov 29, 2025

ChatNote (â€œweâ€, â€œourâ€, â€œusâ€) is created and operated by a small independent team. By using our Web App you agree to the practices below.

1. Information We Collect

We only collect the data necessary to operate and improve the product:
- Account details: email, username
- Usage data and interactions: features used, timestamps, basic telemetry
- Device & browser info: operating system, browser version (for compatibility)

2. How We Use Your Data

We use your data only to:
- Provide and maintain ChatNote features
- Improve performance and user experience
- Secure the service and prevent abuse

We do not sell your personal data to third parties.

3. Data Storage & Security

We store data on secure infrastructure and apply industry-standard protections (encryption in transit and at rest where supported). No online system can guarantee absolute security, but we take reasonable steps to protect your information.

4. Cookies & Analytics

We may use cookies and trusted analytics partners to understand usage patterns, diagnose issues, and improve the app. These tools collect aggregated usage data and do not include content you upload.

5. Your Rights

You can request access to, correction of, export of, or deletion of your data. To make a request, contact us at the email below; we will respond to legitimate requests as required by applicable law.

6. Contact

Email: nova.ai.craft@gmail.com
`,ao=`
ChatNote â€“ Terms of Use

By using ChatNote you agree to the terms set out below.

1. License to Use

- We grant you a limited, non-exclusive, non-transferable license to use ChatNote for personal, non-commercial purposes.
- You may not claim ownership of the platform or redistribute the software.

2. Acceptable Use

You agree not to:
- Use ChatNote for illegal, harmful, or abusive activities
- Reverse-engineer, copy, or modify the service
- Upload content that is illegal, harmful, or infringes others' rights

We reserve the right to suspend or terminate accounts that violate these rules.

3. User Content

- You retain ownership of the content you create or upload.
- By using the service you grant ChatNote permission to store and process that content as necessary to provide the service.

4. Service Availability

ChatNote may modify, update, or discontinue features at any time. We do our best to maintain availability but are not liable for outages or data loss.

5. Limitation of Liability

ChatNote is provided "as is" and we limit our liability to the extent permitted by law. We are not responsible for indirect or consequential damages.

6. Changes to Terms

We may update these terms. Continued use after changes indicates acceptance of the updated terms.

7. Contact

Email: nova.ai.craft@gmail.com
`,lo=({onAgree:t,onDisagree:s,isVisible:n})=>{const[r,i]=a.useState("consent");a.useEffect(()=>(n?document.body.style.overflow="hidden":document.body.style.overflow="",()=>{document.body.style.overflow=""}),[n]);const c=()=>i("privacy"),d=()=>i("terms"),g=()=>i("consent"),E=p=>p.split(`

`).map(u=>u.trim()).filter(Boolean).map((u,m)=>{if(/^\d+\.\s+/.test(u))return e.jsx("h4",{children:u},m);const M=u.split(`
`).map(A=>A.trim()).filter(Boolean),y=A=>A.replace(/^[-*â€¢]\s*/,"").trim();return M.length>1?e.jsx("ul",{children:M.map((A,j)=>e.jsx("li",{children:y(A)},j))},m):/^[-*â€¢]\s+/.test(u)?e.jsx("ul",{children:e.jsx("li",{children:y(u)})},m):e.jsx("p",{children:u},m)}),f=(p,l)=>e.jsxs("div",{className:"detail-content",children:[e.jsxs("div",{className:"detail-header",children:[e.jsx("button",{className:"back-button",onClick:g,"aria-label":"Back to consent",children:"â† Back"}),e.jsx("h3",{className:"detail-title",children:p})]}),e.jsx("div",{className:"detail-body",tabIndex:0,children:E(l)})]});return n?e.jsx("div",{className:"privacy-consent-modal",role:"dialog","aria-modal":"true","aria-labelledby":"consent-title",children:e.jsxs("div",{className:"modal-content",tabIndex:-1,children:[r==="consent"&&e.jsxs(e.Fragment,{children:[e.jsx("h2",{id:"consent-title",children:"ChatNote â€“ Privacy Consent"}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{children:"To continue, please agree to the following:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"We collect essential data to create your account and improve app features."}),e.jsx("li",{children:"Your data is protected and never sold to third parties."}),e.jsx("li",{children:"We may use trusted partners for analytics and secure storage."}),e.jsx("li",{children:"You can request to access or delete your data at any time."})]}),e.jsx("p",{className:"modal-note",children:"By tapping â€œAgreeâ€, you confirm that you have read and consent to ChatNoteâ€™s data practices."})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",onClick:t,className:"btn agree-button",children:"Agree"}),e.jsx("button",{type:"button",onClick:s,className:"btn disagree-button",children:"Disagree"})]}),e.jsxs("div",{className:"modal-links",children:[e.jsx("button",{className:"link-button",onClick:c,"aria-label":"Open Privacy Policy",children:"Privacy Policy"}),e.jsx("button",{className:"link-button",onClick:d,"aria-label":"Open Terms of Use",children:"Terms of Use"})]})]})]}),r==="privacy"&&f("ChatNote â€“ Privacy Policy",io),r==="terms"&&f("ChatNote â€“ Terms of Use",ao)]})}):null},co=({open:t,title:s="ChatNote:",message:n,onClose:r})=>t?e.jsx("div",{className:"app-dialog-backdrop",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"app-dialog",children:[e.jsx("div",{className:"app-dialog-title",children:s}),e.jsx("div",{className:"app-dialog-message",children:n}),e.jsx("div",{className:"app-dialog-actions",children:e.jsx("button",{className:"app-dialog-ok",onClick:r,children:"OK"})})]})}):null,uo=a.lazy(()=>Bt(()=>import("./PDFViewer-D7vbbvlx.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function ho(){const{theme:t}=fn(),{isChatVisible:s,setChatVisible:n}=En(),{isAuthenticated:r,user:i,refreshUser:c}=qt(),[d,g]=a.useState(null),[E,f]=a.useState(""),[p,l]=a.useState(null),[u,m]=a.useState(""),[M,y]=a.useState("split"),[A,j]=a.useState(1),[x,S]=a.useState([]),[P,b]=a.useState(!1),[h,w]=a.useState(null),[N,R]=a.useState(!1),[$,H]=a.useState(null),[L,Y]=a.useState([]),[q,ne]=a.useState(!1),[re,ce]=a.useState(!1),[ie,Be]=a.useState(!1),[F,z]=a.useState(!1),[J,ke]=a.useState(null),[de,C]=a.useState(!1),[T,B]=a.useState(!1),[X,Z]=a.useState(0),[K,me]=a.useState(0),[be,Ge]=a.useState(null),fe=a.useRef(!1),nt=a.useRef(null),[Et,Tt]=a.useState(null),[Ke,De]=a.useState(!1),[Oe,ze]=a.useState({open:!1,message:""}),on=()=>ze({open:!1,message:""}),[it,xt]=a.useState(()=>{const I=localStorage.getItem("chatModelMode");return I==="auto"||I==="quick"||I==="thinking"?I:"auto"}),[Xe,It]=a.useState(()=>{const I=localStorage.getItem("chatWidth");return I?parseInt(I,10):500}),[an,yn]=a.useState(!1),[at,yt]=a.useState(()=>{if(typeof window<"u"){const I=window.innerWidth,V=Math.max(150,Math.round(I*.1)),U=Math.max(V+100,Math.round(I*.9));return{min:V,max:U}}return{min:350,max:800}}),lt=a.useMemo(()=>!$||!r?!1:X===0||K>X,[$,r,X,K]);a.useEffect(()=>{const I=new URLSearchParams(window.location.search),V=I.get("drive_auth_success"),U=I.get("drive_auth_error");V==="true"?(window.history.replaceState({},"",window.location.pathname),c(),setTimeout(()=>{B(!0)},500),C(!1),setTimeout(()=>{Cn(pe).catch(()=>{})},1e3)):U&&(console.warn("Drive authorization failed:",U),window.history.replaceState({},"",window.location.pathname))},[]),a.useEffect(()=>{localStorage.setItem("chatModelMode",it)},[it]),a.useEffect(()=>{localStorage.setItem("chatWidth",Xe.toString())},[Xe]);const st=a.useCallback(I=>{xt(I)},[]),Ve=a.useCallback(I=>{It(Math.min(Math.max(I,at.min),at.max))},[at]),Pt=a.useCallback(I=>{yn(I)},[]);a.useEffect(()=>{if(typeof window>"u")return;const I=()=>{const V=window.innerWidth,U=Math.max(150,Math.round(V*.1)),ae=Math.max(U+100,Math.round(V*.9));yt({min:U,max:ae}),It(le=>Math.min(Math.max(le,U),ae))};return I(),window.addEventListener("resize",I),()=>window.removeEventListener("resize",I)},[]),a.useEffect(()=>{r&&i&&!fe.current&&(tn(!1),fe.current=!0),r&&i&&!de?i.privacyConsent&&(C(!0),setTimeout(()=>{Ce()},500)):r||(C(!1),B(!1),fe.current=!1,we.endNoteModeTracking(),g(null),f(""),l(null),Y([]),S([]),H(null),j(1),b(!1),m(""),R(!1),nn())},[r,i]),a.useEffect(()=>{(Ke||!r)&&z(!1)},[Ke,r]);const Ce=async()=>{try{const I=localStorage.getItem("auth_token");if(!I||!r||!i||!i.privacyConsent||!i.googleDriveEligible)return;const V=await fetch(`${pe}/api/drive/status`,{headers:{Authorization:`Bearer ${I}`}});if(V.ok)if((await V.json()).authorized){setTimeout(()=>{B(!0)},100),Cn(pe).catch(()=>{});return}else B(!1);const U=await fetch(`${pe}/api/drive/auth`,{headers:{Authorization:`Bearer ${I}`}});if(U.ok){const ae=await U.json();!ae.authorized&&ae.authUrl?(ke(ae.authUrl),z(!0)):ae.authorized&&setTimeout(()=>{B(!0)},100)}}catch(I){console.warn("Failed to check/authorize Drive:",I)}},rt=()=>{J&&(window.location.href=J),z(!1)},wn=()=>{z(!1)},ln=async I=>{g(I),Be(!0);try{const V=await ls(I);if(f(V.fullText),l(V),V.fullText&&V.fullText.trim().length>0)try{const{indexPDF:U}=await Bt(async()=>{const{indexPDF:ae}=await import("./pdfRAG-SvKsxZz1.js");return{indexPDF:ae}},[]);await U(V.fullText)}catch{}if(r&&T)try{const U=localStorage.getItem("auth_token");if(U){const ae=await I.arrayBuffer(),le=new Uint8Array(ae);let We="";const qe=8192;for(let He=0;He<le.length;He+=qe){const _t=le.subarray(He,Math.min(He+qe,le.length));for(let ot=0;ot<_t.length;ot++)We+=String.fromCharCode(_t[ot])}const Nt=btoa(We);let Ze="";if(V.fullText&&V.fullText.trim().length>0)try{const He=V.fullText.slice(0,1e3),_t=`You generate short, descriptive titles for uploaded PDFs based on their content.
File name: "${I.name}"
Content snippet: "${He}"
Output a concise (<=5 words) human-friendly title without quotes. Do not include "Title:" prefix.`;Ze=(await sn([{role:"user",content:_t}],void 0,void 0,Wt[0])).content.replace(/^["'â€œâ€`]+|["'â€œâ€`]+$/g,"").replace(/[.:]+$/g,"").trim(),(!Ze||Ze.length>60)&&(Ze="")}catch(He){console.warn("Failed to generate title:",He)}const Ae=await fetch(`${pe}/api/drive/upload-pdf`,{method:"POST",headers:{Authorization:`Bearer ${U}`,"Content-Type":"application/json"},body:JSON.stringify({pdfBase64:Nt,fileName:I.name,displayName:Ze||void 0})});if(Ae.ok){const He=await Ae.json();H(He.pdfId),Z(0),me(0),nn(),tn(!1)}else console.warn("Failed to upload PDF to Drive:",await Ae.text())}}catch(U){console.warn("Error uploading PDF to Drive:",U)}}catch(V){console.error("Failed to extract PDF text:",V),f(""),l(null);const U=V instanceof Error?V.message:"Unknown error during PDF upload",ae=(I.size/(1024*1024)).toFixed(2);await we.trackError("upload_fail",`File: ${I.name}, Size: ${ae}MB, Error: ${U}`)}finally{Be(!1)}};a.useEffect(()=>{d||(f(""),l(null),Bt(async()=>{const{clearPDFIndices:I}=await import("./pdfRAG-SvKsxZz1.js");return{clearPDFIndices:I}},[]).then(({clearPDFIndices:I})=>{I()}).catch(()=>{}))},[d]);const cn=(I,V,U)=>{m(I),I&&V!==void 0&&U!==void 0&&(w({text:I,pageNumber:V,textYPosition:U}),window.__lastSelectedTextPosition={text:I,pageNumber:V,textYPosition:U})},wt=()=>{if(M==="split"&&!s){n(!0);return}const I=M==="floating"?"split":"floating";y(I),I==="split"&&!s&&n(!0)},Lt=I=>{Ge(I)},Rt=()=>{y("split"),nt.current&&nt.current()},At=(I,V,U,ae,le)=>{if(x.find(Ae=>Ae.messageId===le&&Ae.content===I)){Tt("This note has already been saved to your knowledge notes");return}const qe=U||h?.pageNumber||A,Nt=ae??h?.textYPosition??0,Ze={id:`note-${Date.now()}`,content:I,linkedText:V||h?.text,pageNumber:qe,textYPosition:Nt,createdAt:Date.now(),messageId:le};S(Ae=>[...Ae,Ze]),qe&&$e(qe)},Mt=I=>{S(V=>V.filter(U=>U.id!==I))},Ct=()=>{S([])},$e=I=>{j(I),window.__pdfScrollToPage&&window.__pdfScrollToPage(I)},bt=a.useCallback(async()=>{if(!(!$||!r))try{const I=localStorage.getItem("auth_token");if(!I)return;await fetch(`${pe}/api/drive/save-annotations/${$}`,{method:"POST",headers:{Authorization:`Bearer ${I}`,"Content-Type":"application/json"},body:JSON.stringify({annotations:L})}),nn(),tn(!0),Z(Date.now())}catch(I){console.error("Failed to save annotations:",I)}},[$,r,L]),ct=a.useCallback(async()=>{if(!(!$||!r))try{const I=localStorage.getItem("auth_token");if(!I)return;await fetch(`${pe}/api/drive/save-notes/${$}`,{method:"POST",headers:{Authorization:`Bearer ${I}`,"Content-Type":"application/json"},body:JSON.stringify({notes:x})}),nn(),tn(!0),Z(Date.now())}catch(I){console.error("Failed to save notes:",I)}},[$,r,x]);a.useEffect(()=>{const I=()=>{if(!$||!r)return!1;const ae=L.length>0,le=x.length>0;return!ae&&!le?!1:X===0||K>X},V=()=>{if(document.visibilityState==="hidden"&&I()){const ae=[];L.length>0&&ae.push(bt()),x.length>0&&ae.push(ct()),Promise.race([Promise.all(ae),new Promise(le=>setTimeout(le,1500))]).catch(()=>{})}},U=ae=>{if(I())try{const le=localStorage.getItem("auth_token");if(le){if(L.length>0){const We=JSON.stringify({annotations:L});We.length<6e4&&fetch(`${pe}/api/drive/save-annotations/${$}`,{method:"POST",headers:{Authorization:`Bearer ${le}`,"Content-Type":"application/json"},body:We,keepalive:!0}).catch(()=>{})}if(x.length>0){const We=JSON.stringify({notes:x});We.length<6e4&&fetch(`${pe}/api/drive/save-notes/${$}`,{method:"POST",headers:{Authorization:`Bearer ${le}`,"Content-Type":"application/json"},body:We,keepalive:!0}).catch(()=>{})}}}catch{}if(d&&I())return ae.preventDefault(),ae.returnValue="",""};return window.addEventListener("beforeunload",U),document.addEventListener("visibilitychange",V),()=>{window.removeEventListener("beforeunload",U),document.removeEventListener("visibilitychange",V)}},[d,$,r,L,x,X,K,bt,ct]);const je=a.useCallback(async I=>{if(!$||!r)return()=>{};const V=s;await we.endNoteModeTracking(),b(!1),n(!1),ce(!0);let U=!1;const ae=()=>{U||(U=!0,ce(!1),V&&n(!0))};try{await Promise.all([bt(),ct()])}catch(le){throw I?.keepOverlay&&ae(),le}finally{I?.keepOverlay||ae()}return I?.keepOverlay?()=>{ae()}:()=>{}},[$,r,s,n,bt,ct]),Ht=async I=>{if(I===$)return;let V=null;if($&&r&&lt)try{V=je({keepOverlay:!0}),await Promise.race([V,new Promise(U=>setTimeout(U,2e3))])}catch(U){console.warn("Failed to save before switching PDF:",U),V=null,ce(!1)}await we.endNoteModeTracking(),ne(!0),b(!1);try{const U=localStorage.getItem("auth_token");if(!U){ze({open:!0,message:"Please log in to load PDF from history"}),ne(!1);return}const ae=await fetch(`${pe}/api/drive/load-pdf/${I}`,{headers:{Authorization:`Bearer ${U}`}});if(!ae.ok)throw new Error("Failed to load PDF");const le=await ae.json(),We=atob(le.pdfBlob),qe=new Uint8Array(We.length);for(let Ae=0;Ae<We.length;Ae++)qe[Ae]=We.charCodeAt(Ae);const Nt=new Blob([qe],{type:"application/pdf"}),Ze=new File([Nt],le.metadata.originalFileName,{type:"application/pdf"});g(Ze),H(le.metadata.pdfId),ls(Ze).then(Ae=>{if(Ae.fileName=le.metadata.originalFileName,f(Ae.fullText),l(Ae),Ae.fullText&&Ae.fullText.trim().length>0)try{Bt(async()=>{const{indexPDF:He}=await import("./pdfRAG-SvKsxZz1.js");return{indexPDF:He}},[]).then(({indexPDF:He})=>{He(Ae.fullText).catch(()=>{})})}catch{}}).catch(Ae=>{console.warn("Failed to extract PDF text:",Ae),l(null)}),Y(le.annotations||[]),S(le.knowledgeNotes||[]),Z(Date.now()),me(Date.now()),j(1)}catch(U){console.error("Failed to load PDF from history:",U),ze({open:!0,message:"Failed to load PDF. Please try again."}),ne(!1)}finally{V&&V.then(U=>U()).catch(U=>{console.warn("Failed to finalize save before releasing overlay:",U),ce(!1)})}},$t=async()=>{const I=lt;if(await we.endNoteModeTracking(),I){let V=null;try{V=await je({keepOverlay:!0})}catch(U){console.warn("Failed to save before starting new session:",U)}finally{V&&V()}}g(null),f(""),l(null),Y([]),S([]),H(null),j(1),b(!1),m(""),I&&Cn(pe).catch(()=>{})},dn=a.useCallback(async()=>{lt&&await je()},[lt,je]);a.useEffect(()=>{me(Date.now())},[L,x]),a.useEffect(()=>{if($&&r&&L.length>0){const I=setTimeout(()=>{bt()},5e3);return()=>clearTimeout(I)}},[L,$,r,bt]),a.useEffect(()=>{if($&&r&&x.length>0){const I=setTimeout(()=>{ct()},5e3);return()=>clearTimeout(I)}},[x,$,r,ct]),a.useEffect(()=>{r&&i&&!i.privacyConsent&&De(!0)},[r,i]);const Ut=async()=>{const I=localStorage.getItem("auth_token");if(!I){ze({open:!0,message:"Please log in to agree to the privacy consent."});return}try{if((await fetch(`${pe}/api/user/privacy-consent`,{method:"POST",headers:{Authorization:`Bearer ${I}`,"Content-Type":"application/json"},body:JSON.stringify({consent:!0})})).ok){await c(),De(!1);try{C(!0),setTimeout(()=>{Ce()},300)}catch{}}else ze({open:!0,message:"Failed to update consent. Please try again."})}catch(V){console.error("Failed to update consent:",V),ze({open:!0,message:"An error occurred. Please try again."})}},dt=()=>{ze({open:!0,message:"You must agree to the privacy consent to use the platform."})};return e.jsxs("div",{className:"app",children:[Ke&&e.jsx(lo,{onAgree:Ut,onDisagree:dt,isVisible:Ke}),Oe.open&&e.jsx(co,{open:Oe.open,message:Oe.message,onClose:on}),e.jsx(Ks,{hasUnsavedChanges:lt,saveCurrentState:je,isSavingSession:re,setIsSavingSession:ce,children:e.jsx(cr,{onOpenHistory:()=>R(!0),isSavingSession:re,currentMode:be,onResetMode:Rt,hasPdf:d!==null,isGoogleDriveEligible:i?.googleDriveEligible??!1})}),e.jsx(Kr,{isOpen:N,onClose:()=>R(!1),onSelectPdf:Ht,hasUnsavedChanges:lt,onSaveBeforeFetch:dn,isDriveAuthorized:T,isGoogleDriveEligible:i?.googleDriveEligible??!1}),e.jsxs("div",{className:`main-content ${M==="split"?"split-layout":""} ${P&&M==="floating"?"has-knowledge-notes":""}`,children:[e.jsx($r,{children:e.jsx(a.Suspense,{fallback:e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading PDF viewer..."}),children:e.jsx(uo,{file:d,onFileUpload:ln,onTextSelection:cn,layout:M,showLayoutToggle:be==="guide-me-learn",onPageChange:j,onTotalPagesChange:I=>{window.__pdfTotalPages!==I&&(window.__pdfTotalPages=I)},showKnowledgeNotes:P,onToggleLayout:wt,knowledgeNotes:x,onScrollToPage:$e,onNoteClick:I=>{I.pageNumber&&$e(I.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0,onAddAnnotation:()=>{},initialAnnotations:L,onAnnotationsChange:Y,isLoadingPdf:q,onLoadingComplete:()=>ne(!1),isSavingSession:re,onNewSession:$t,isDriveAuthorized:T,onSelectRecentPdf:Ht},r?"authenticated":"unauthenticated")})}),P&&e.jsx(_r,{notes:x,onDeleteNote:Mt,onClearAllNotes:Ct,onScrollToPage:$e,layout:M,theme:t,isVisible:P,onClose:()=>b(!1),onNoteClick:I=>{I.pageNumber&&$e(I.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0}),M==="split"&&s&&d&&e.jsx(oo,{modelMode:it,onResize:Ve,initialWidth:Xe,minWidth:at.min,maxWidth:at.max,onDragStateChange:Pt}),d&&e.jsx("div",{className:`chat-container ${M==="floating"?"floating-chat":"split-chat"} ${P?"knowledge-notes-open":""} ${an?"divider-dragging":""}`,style:{...M==="split"?{"--chat-width":`${Xe}px`,"--chat-min-width":`${at.min}px`,"--chat-max-width":`${at.max}px`}:{},display:s?"flex":"none"},children:e.jsx(Rr,{selectedText:u,pdfText:E,pdfDocument:p,onToggleLayout:wt,onToggleKnowledgeNotes:async()=>{P&&await we.endNoteModeTracking(),b(I=>!I)},showKnowledgeNotes:P,layout:M,currentPageNumber:A,pdfTotalPages:window.__pdfTotalPages,onCreateKnowledgeNote:At,onClearSelectedText:()=>m(""),onOpenKnowledgeNotes:()=>{P||b(!0)},onModeChange:Lt,resetModeRef:nt,onRequestPageChange:j,modelMode:it,onModelModeChange:st,onAddAnnotationToPDF:(I,V,U)=>{if(window.__addPDFAnnotation){const le=U!==void 0?U:.5,We={id:`textbox-${Date.now()}`,type:"textbox",pageNumber:V,x:Math.max(0,Math.min(1-.3,.4-.15)),y:Math.max(0,Math.min(1-.2,le-.1)),width:.3,height:.2,rotation:0,text:I,fontSize:14,color:no[0]};window.__addPDFAnnotation(We)}}})})]}),ie&&e.jsxs("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.7)",zIndex:9999,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:"white"},children:[e.jsx("div",{className:"loading-spinner",style:{width:"40px",height:"40px",border:"4px solid rgba(255, 255, 255, 0.3)",borderTop:"4px solid white",borderRadius:"50%",animation:"spin 1s linear infinite",marginBottom:"16px"}}),e.jsx("style",{children:`
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `}),e.jsx("h3",{children:"Uploading PDF..."}),e.jsx("p",{children:"This may take a moment for large files"})]}),e.jsx(so,{isOpen:F&&!Ke&&(i?.googleDriveEligible??!1),onConfirm:rt,onCancel:wn}),Et&&e.jsx(ro,{message:Et,type:"info",duration:3e3,onClose:()=>Tt(null)})]})}function go(){return e.jsx(Bs,{children:e.jsx(Qs,{children:e.jsx(Ys,{children:e.jsx(ho,{})})})})}const Sn=document.getElementById("root");if(!Sn)throw new Error("Root element not found");try{Ls.createRoot(Sn).render(e.jsx(Rs.StrictMode,{children:e.jsx(go,{})}))}catch(t){Sn.innerHTML=`
    <div style="padding: 20px; color: red;">
      <h1>Error Loading App</h1>
      <p>${t instanceof Error?t.message:String(t)}</p>
      <p>Check the browser console for more details.</p>
    </div>
  `}export{no as C,Fr as P,Bt as _,we as a,jn as g,xo as p,En as u};
