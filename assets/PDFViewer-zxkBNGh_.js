const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/vendor-DIPRGdMO.js","assets/vendor-C5EChc_d.css"])))=>i.map(i=>d[i]);
import{r,j as t,D as kt,P as jt}from"./vendor-react-rsP_hLAx.js";import{_ as nt,u as Ct,C as Mt,a as xe,g as Je,p as St,P as Qe}from"./index-Dn6xQZ7Y.js";import{G as Ie}from"./vendor-pdf-DDxsMbbh.js";import"./vendor-DIPRGdMO.js";const Nt=({pageNumber:d,pageWidth:D,pageHeight:O,scale:y,annotations:fe,selectedAnnotationId:j,onAnnotationUpdate:S,onAnnotationDelete:C,onAnnotationSelect:ge,mode:G})=>{const x=r.useRef(null),[be,V]=r.useState(!1),[w,Z]=r.useState(!1),[p,ye]=r.useState(!1),[ne,he]=r.useState({x:0,y:0}),[q,h]=r.useState(null),[N,R]=r.useState(null),[ve,Q]=r.useState({x:0,y:0,angle:0}),[Y,b]=r.useState(null),oe=fe.filter(n=>n.pageNumber===d),[ee,H]=r.useState(()=>({width:D*y,height:O*y,offsetLeft:0,offsetTop:0})),se=r.useCallback(()=>{const n=x.current?.parentElement;if(!n)return;const u=n.querySelector(".react-pdf__Page");if(!u)return;const f=n.getBoundingClientRect(),c=u.getBoundingClientRect();!c.width||!c.height||H(a=>{const $=Math.abs(a.width-c.width)>.5,v=Math.abs(a.height-c.height)>.5,k=Math.abs(a.offsetLeft-(c.left-f.left))>.5||Math.abs(a.offsetTop-(c.top-f.top))>.5;return $||v||k?{width:c.width,height:c.height,offsetLeft:c.left-f.left,offsetTop:c.top-f.top}:a})},[]);r.useEffect(()=>{se();const n=x.current?.parentElement;if(n&&typeof ResizeObserver<"u"){const f=new ResizeObserver(()=>se());return f.observe(n),()=>f.disconnect()}const u=()=>se();return window.addEventListener("resize",u),()=>{window.removeEventListener("resize",u)}},[se,D,O,y]),r.useEffect(()=>{se()},[y,D,O,se]);const T=n=>n*ee.width,_=n=>n*ee.height,U=n=>n*ee.width,F=n=>n*ee.height,pe=n=>n/ee.width,Se=n=>n/ee.height,I=r.useCallback((n,u,f,c)=>{const a=1-f,$=1-c;return{x:Math.max(0,Math.min(a,n)),y:Math.max(0,Math.min($,u)),width:Math.max(.01,Math.min(1,f)),height:Math.max(.01,Math.min(1,c))}},[]),me=r.useCallback((n,u,f,c)=>{const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.width=`${f}px`,a.style.fontSize=`${u*c}px`,a.style.fontFamily="inherit",a.style.whiteSpace="pre-wrap",a.style.wordWrap="break-word",a.style.overflowWrap="break-word",a.style.padding=`${4*c}px`,a.style.boxSizing="border-box",a.style.lineHeight="1.2",a.textContent=n||"Text",document.body.appendChild(a);const $=a.scrollHeight;return document.body.removeChild(a),$},[]),Re=r.useCallback((n,u)=>{n.stopPropagation();const f=n.target;if(f.classList.contains("resize-handle")){n.preventDefault(),Z(!0),h(f.dataset.handle||null);const a=x.current?.getBoundingClientRect();a&&(he({x:n.clientX-a.left,y:n.clientY-a.top}),R({x:n.clientX-a.left,y:n.clientY-a.top,width:u.width,height:u.height,annotationX:u.x,annotationY:u.y}));return}if(f.classList.contains("rotate-handle")){n.preventDefault(),ye(!0);const a=x.current?.getBoundingClientRect();if(a){const $=T(u.x+u.width/2),v=_(u.y+u.height/2),k=n.clientX-a.left,we=n.clientY-a.top,Ne=Math.atan2(we-v,k-$)*(180/Math.PI);Q({x:k,y:we,angle:u.rotation-Ne})}return}if(f.classList.contains("delete-button")){n.preventDefault(),C(u.id);return}n.preventDefault(),ge(u.id),V(!0);const c=x.current?.getBoundingClientRect();c&&he({x:n.clientX-c.left-T(u.x),y:n.clientY-c.top-_(u.y)})},[G,T,_,ge,C]);r.useEffect(()=>{if(!be&&!w&&!p)return;const n=f=>{const c=x.current?.getBoundingClientRect();if(!c)return;const a=oe.find($=>$.id===j);if(a){if(p){const $=T(a.x+a.width/2),v=_(a.y+a.height/2),k=f.clientX-c.left,we=f.clientY-c.top,Ne=Math.atan2(we-v,k-$)*(180/Math.PI),ue=(ve.angle+Ne)%360;Math.abs((a.rotation||0)-ue)>.01&&S({...a,rotation:ue})}else if(w&&q&&N){const $=f.clientX-c.left,v=f.clientY-c.top,k=$-N.x,we=v-N.y,Ne=.5,ue=k/(D*y)*Ne,ke=we/(O*y)*Ne;let ze=N.annotationX,Fe=N.annotationY,Le=N.width,We=N.height;q.includes("n")&&(Fe=Math.max(0,N.annotationY+ke),We=Math.max(.01,N.height-ke)),q.includes("s")&&(We=Math.max(.01,N.height+ke)),q.includes("w")&&(ze=Math.max(0,N.annotationX+ue),Le=Math.max(.01,N.width-ue)),q.includes("e")&&(Le=Math.max(.01,N.width+ue));const Ce=I(ze,Fe,Le,We);if(a.type==="textbox"){const Ee=a,Oe=U(Ce.width),He=me(Ee.text,Ee.fontSize,Oe,y)/(O*y);if(Math.abs(He-Ce.height)>.001){const _e=Math.max(.01,Math.min(1,He)),Pe=I(ze,Fe,Ce.width,_e);(Math.abs((a.x||0)-Pe.x)>1e-4||Math.abs((a.y||0)-Pe.y)>1e-4||Math.abs((a.width||0)-Pe.width)>1e-4||Math.abs((a.height||0)-Pe.height)>1e-4)&&S({...a,...Pe})}else(Math.abs((a.x||0)-Ce.x)>1e-4||Math.abs((a.y||0)-Ce.y)>1e-4||Math.abs((a.width||0)-Ce.width)>1e-4||Math.abs((a.height||0)-Ce.height)>1e-4)&&S({...a,...Ce})}else S({...a,...Ce})}else if(be){const $=pe(f.clientX-c.left-ne.x),v=Se(f.clientY-c.top-ne.y),k=I($,v,a.width,a.height);(Math.abs((a.x||0)-k.x)>1e-4||Math.abs((a.y||0)-k.y)>1e-4)&&S({...a,...k})}}},u=()=>{if(w&&j){const f=oe.find(c=>c.id===j);if(f&&f.type==="textbox"){const c=f,a=U(c.width),v=me(c.text,c.fontSize,a,y)/(O*y),k=I(c.x,c.y,c.width,v);Math.abs(k.height-c.height)>.001&&S({...c,...k})}}V(!1),Z(!1),ye(!1),h(null),R(null)};return window.addEventListener("mousemove",n),window.addEventListener("mouseup",u),()=>{window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",u)}},[be,w,p,q,N,ne,ve,j,oe,T,_,U,F,pe,Se,I,me,S,D,O,y]),r.useEffect(()=>{const n=u=>{(u.key==="Delete"||u.key==="Backspace")&&j&&u.target.tagName!=="INPUT"&&u.target.tagName!=="TEXTAREA"&&(u.preventDefault(),C(j))};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[j,C]);const ie=n=>{const u=n.id===j,f=T(n.x),c=_(n.y),a=U(n.width),$=F(n.height);return t.jsxs("div",{className:`annotation textbox-annotation ${u?"selected":""}`,style:{left:`${f}px`,top:`${c}px`,width:`${a}px`,height:`${$}px`,padding:`${4*y}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>Re(v,n),children:[u&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),Y===n.id?t.jsx("textarea",{className:"textbox-input",value:n.text,onChange:v=>{S({...n,text:v.target.value})},onBlur:v=>{const k=v.relatedTarget;k&&(k.closest(".textbox-controls")!==null||k.closest(".textbox-font-size-input")!==null||k.classList.contains("textbox-font-size-input")||k.closest(".floating-textbox-toolbar")!==null||k.closest(".color-swatch")!==null||k.classList.contains("toolbar-icon"))||(b(null),ge(null))},onKeyDown:v=>{v.key==="Enter"&&!v.shiftKey&&(v.preventDefault(),b(null),ge(null)),v.key==="Escape"&&(b(null),ge(null))},style:{fontSize:`${n.fontSize*y}px`,color:n.color,width:`${a}px`,maxWidth:`${a}px`,height:`${$}px`,maxHeight:`${$}px`},autoFocus:!0}):t.jsx("div",{className:"textbox-content",onClick:v=>{v.stopPropagation();const k=v.target;k.closest(".textbox-controls")!==null||k.closest(".textbox-font-size-input")!==null||k.closest(".textbox-color-button")!==null||k.closest(".textbox-color-picker")!==null||b(n.id)},style:{fontSize:`${n.fontSize*y}px`,color:n.color},children:n.text||"Text"})]},n.id)},re=n=>{const u=n.id===j,f=T(n.x),c=_(n.y),a=U(n.width),$=F(n.height),v=n.width*D,k=n.height*O,we=n.imageWidth/n.imageHeight,Ne=v/k;let ue,ke;return we>Ne?(ue=a,ke=a/we):(ke=$,ue=$*we),t.jsxs("div",{className:`annotation image-annotation ${u?"selected":""}`,style:{left:`${f}px`,top:`${c}px`,width:`${ue}px`,height:`${ke}px`,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:ze=>Re(ze,n),children:[u&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:ze=>{ze.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]}),t.jsx("img",{src:n.imageData,alt:"Annotation",draggable:!1})]},n.id)},m=n=>{const u=n.id===j,f=T(n.x),c=_(n.y),a=U(n.width),$=F(n.height);return t.jsx("div",{className:`annotation highlight-annotation ${u?"selected":""}`,style:{left:`${f}px`,top:`${c}px`,width:`${a}px`,height:`${$}px`,backgroundColor:n.color,opacity:n.opacity||.4,transform:`rotate(${n.rotation}deg)`,transformOrigin:"center center"},onMouseDown:v=>Re(v,n),children:u&&t.jsxs(t.Fragment,{children:[t.jsx("button",{className:"delete-button",onClick:v=>{v.stopPropagation(),C(n.id)},title:"Delete (or press Delete key)",children:"×"}),t.jsx("div",{className:"resize-handle","data-handle":"ne"}),t.jsx("div",{className:"resize-handle","data-handle":"sw"}),t.jsx("div",{className:"resize-handle","data-handle":"se"}),t.jsx("div",{className:"resize-handle","data-handle":"n"}),t.jsx("div",{className:"resize-handle","data-handle":"s"}),t.jsx("div",{className:"resize-handle","data-handle":"w"}),t.jsx("div",{className:"resize-handle","data-handle":"e"}),t.jsx("div",{className:"rotate-handle"})]})},n.id)},L=ee.width,A=ee.height,ae={width:`${L}px`,height:`${A}px`,left:`${ee.offsetLeft}px`,top:`${ee.offsetTop}px`,pointerEvents:"none"},M=oe.find(n=>n.id===j&&n.type==="textbox"),[E,le]=r.useState(null);return r.useEffect(()=>{if(!M||!x.current){le(null);return}const n=T(M.x),u=_(M.y);le({left:n+U(M.width)/2,top:Math.max(0,u-40)})},[M,D,O,y,Y]),t.jsxs("div",{ref:x,className:"annotation-layer",style:ae,children:[oe.map(n=>n.type==="textbox"?ie(n):n.type==="image"?re(n):n.type==="highlight"?m(n):null),M&&Y===M.id&&E&&t.jsxs("div",{className:"floating-textbox-toolbar",style:{left:`${E.left}px`,top:`${E.top}px`,position:"absolute",zIndex:9999},onMouseDown:n=>n.stopPropagation(),children:[t.jsxs("div",{className:"font-size-group",children:[t.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=M.fontSize||16;S({...M,fontSize:Math.max(1,n-1)})},title:"Decrease font size",children:"−"}),t.jsx("span",{className:"font-size-display",children:M.fontSize||16}),t.jsx("button",{className:"toolbar-icon",onClick:()=>{const n=M.fontSize||16;S({...M,fontSize:Math.min(200,n+1)})},title:"Increase font size",children:"+"})]}),t.jsx("div",{className:"color-swatch-group",children:["#000000","#ff0000","#0000ff","#00ff00","#ffeb3b"].map(n=>t.jsx("button",{className:`color-swatch ${M.color===n?"active":""}`,style:{backgroundColor:n},onClick:()=>S({...M,color:n}),title:n},n))})]})]})},Rt=({mode:d,onModeChange:D,highlightColor:O="#ffeb3b",onHighlightColorChange:y,onHighlightClick:fe,hasTextSelection:j=!1,isHighlightActive:S=!1,showColorPicker:C=!1,onImageUpload:ge,layout:G,onToggleLayout:x,showLayoutToggle:be=!0,isChatVisible:V=!0,onClearAll:w,pageNumber:Z,numPages:p,onPrevPage:ye,onNextPage:ne,scale:he,onZoomIn:q,onZoomOut:h,onFitWidth:N,onFitHeight:R,onZoomInputClick:ve,isEditingZoom:Q,zoomInputValue:Y,onZoomInputChange:b,onZoomInputBlur:oe,onZoomInputKeyDown:ee,onZoomInputPaste:H,zoomInputRef:se})=>{const T=r.useRef(null),[_,U]=r.useState(!1),[F,pe]=r.useState(!1),[Se,I]=r.useState(()=>typeof window<"u"?window.innerWidth<=720:!1),me=r.useRef(null),Re=["#ffeb3b","#8bc34a","#03a9f4","#e91e63","#9c27b0"];r.useEffect(()=>{const m=L=>{_&&(L.target.closest(".clear-button")||(U(!1),me.current&&(clearTimeout(me.current),me.current=null)))};if(_)return document.addEventListener("click",m),()=>{document.removeEventListener("click",m)}},[_]),r.useEffect(()=>{if(typeof window>"u")return;const m=()=>{const L=window.innerWidth<=720;I(L),!L&&F&&pe(!1)};return m(),window.addEventListener("resize",m),()=>window.removeEventListener("resize",m)},[F]);const ie=m=>{const L=m.target.files?.[0];L&&L.type.startsWith("image/")&&ge(L),D(null),T.current&&(T.current.value="")},re=m=>{m.stopPropagation(),_?(w&&w(),U(!1),me.current&&(clearTimeout(me.current),me.current=null)):(U(!0),me.current=setTimeout(()=>{U(!1),me.current=null},3e3))};return t.jsxs("div",{className:"annotation-toolbar",children:[t.jsxs("div",{className:"toolbar-left",children:[Se&&t.jsx("button",{type:"button",className:`toolbar-button mobile-tools-toggle ${F?"active":""}`,onClick:()=>pe(m=>!m),"aria-pressed":F,"aria-expanded":F,"aria-label":F?"Hide annotation tools":"Show annotation tools",children:t.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[t.jsx("path",{d:"M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25Z",stroke:"currentColor",strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"}),t.jsx("path",{d:"M14.06 6.19L17.31 2.94C17.7 2.55 18.33 2.55 18.72 2.94L21.06 5.28C21.45 5.67 21.45 6.3 21.06 6.69L17.81 9.94",stroke:"currentColor",strokeWidth:"1.7",strokeLinecap:"round",strokeLinejoin:"round"})]})}),t.jsxs("div",{className:`toolbar-section annotation-tools ${Se&&F?"mobile-visible":""}`,children:[t.jsx("button",{className:`toolbar-button ${S?"active":""}`,onClick:fe,disabled:!j,title:j?S?"Remove highlight":"Highlight text":"Select text to highlight",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M9 11l-6 6v3h9l3-3"}),t.jsx("path",{d:"M22 12l-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"})]})}),t.jsx("button",{className:`toolbar-button ${d==="textbox"?"active":""}`,onClick:()=>D("textbox"),title:"Add text box",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("path",{d:"M4 7V4h16v3M9 20h6M12 4v16"})})}),t.jsx("button",{className:`toolbar-button ${d==="image"?"active":""}`,onClick:()=>{D("image"),T.current?.click()},title:"Add image",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),t.jsx("circle",{cx:"8.5",cy:"8.5",r:"1.5"}),t.jsx("polyline",{points:"21 15 16 10 5 21"})]})}),w&&t.jsx("button",{className:`toolbar-button clear-button ${_?"confirming":""}`,onClick:re,title:_?"Click again to clear all":"Clear all",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"3 6 5 6 21 6"}),t.jsx("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"})]})}),t.jsx("input",{ref:T,type:"file",accept:"image/*",onChange:ie,style:{display:"none"}})]}),C&&y&&t.jsx("div",{className:"toolbar-section color-picker",children:Re.map(m=>t.jsx("button",{className:`color-button ${O===m?"active":""}`,style:{backgroundColor:m},onClick:()=>y(m),title:"Highlight color"},m))})]}),t.jsxs("div",{className:"toolbar-center",children:[Z!==void 0&&p!==void 0&&t.jsxs("div",{className:"toolbar-section pdf-navigation",children:[t.jsx("button",{className:"toolbar-button nav-button",onClick:ye,disabled:Z<=1,title:"Previous page",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("polyline",{points:"15 18 9 12 15 6"})})}),t.jsxs("span",{className:"page-info",children:[Z," / ",p]}),t.jsx("button",{className:"toolbar-button nav-button",onClick:ne,disabled:Z>=p,title:"Next page",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("polyline",{points:"9 18 15 12 9 6"})})})]}),he!==void 0&&t.jsxs("div",{className:"toolbar-section zoom-controls",children:[t.jsx("button",{onClick:N,className:"toolbar-button",title:"Fit width",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"5 9 2 12 5 15"}),t.jsx("polyline",{points:"19 9 22 12 19 15"}),t.jsx("line",{x1:"2",y1:"12",x2:"22",y2:"12"})]})}),t.jsx("button",{onClick:R,className:"toolbar-button",title:"Fit height",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("polyline",{points:"9 5 12 2 15 5"}),t.jsx("polyline",{points:"9 19 12 22 15 19"}),t.jsx("line",{x1:"12",y1:"2",x2:"12",y2:"22"})]})}),t.jsx("button",{onClick:h,className:"toolbar-button",title:"Zoom out",children:t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:t.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})})}),Q?t.jsx("input",{ref:se,type:"text",inputMode:"numeric",value:Y,onChange:b,onBlur:oe,onKeyDown:ee,onPaste:H,className:"zoom-input"}):t.jsxs("span",{className:"zoom-level",onClick:ve,title:"Click to edit zoom",children:[Math.round((he||1)*100),"%"]}),t.jsx("button",{onClick:q,className:"toolbar-button",title:"Zoom in",children:t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",children:[t.jsx("line",{x1:"12",y1:"5",x2:"12",y2:"19"}),t.jsx("line",{x1:"5",y1:"12",x2:"19",y2:"12"})]})})]})]}),t.jsx("div",{className:"toolbar-right",children:be&&x&&t.jsx("div",{className:"toolbar-section toolbar-actions",children:t.jsx("button",{className:"toolbar-button layout-toggle-button",onClick:x,title:G==="floating"?"Switch to split layout":V?"Switch to floating layout":"Show chat panel",children:G==="floating"?t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),t.jsx("rect",{x:"3",y:"14",width:"7",height:"7"})]}):V?t.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),t.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),t.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),t.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"21"})]}):t.jsx("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})})})})})]})},zt=({pageNumber:d,pageWidth:D,pageHeight:O,scale:y,knowledgeNotes:fe,showKnowledgeNotes:j,onNoteClick:S})=>{const C=fe.filter(x=>x.pageNumber===d);if(!j||C.length===0)return null;const ge=D*y,G=O*y;return t.jsx("div",{className:"knowledge-note-connections",style:{width:`${ge}px`,height:`${G}px`,position:"absolute",top:0,left:0,pointerEvents:"none",zIndex:5},children:t.jsx("svg",{className:"connection-svg",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",overflow:"visible"},children:C.map((x,be)=>{const V=ge-25,w=25+be*35;return t.jsxs("g",{children:[t.jsx("circle",{cx:V,cy:w,r:"10",fill:"#4285f4",stroke:"white",strokeWidth:"2",className:"knowledge-note-marker",onClick:Z=>{Z.stopPropagation(),S?.(x)},style:{cursor:"pointer",pointerEvents:"all"}}),t.jsx("text",{x:V,y:w,textAnchor:"middle",dominantBaseline:"middle",fill:"white",fontSize:"11",fontWeight:"bold",pointerEvents:"none",children:be+1}),t.jsx("line",{x1:V,y1:w+12,x2:V,y2:w+20,stroke:"#4285f4",strokeWidth:"2",opacity:"0.7"})]},x.id)})})})};let Ue,Te=null,et=!1;async function Dt(){if(!Ue)try{Ue=await nt(()=>import("./vendor-DIPRGdMO.js").then(d=>d.x),__vite__mapDeps([0,1]))}catch(d){throw console.error("Failed to load pdf-lib:",d),new Error("PDF library not available. Please install pdf-lib.")}return Ue}async function Et(){if(!et){et=!0;try{const d=await nt(()=>import("./vendor-DIPRGdMO.js").then(D=>D.y),__vite__mapDeps([0,1]));return d.default?Te=d.default:Te=d,Te&&typeof Te.create=="function"?Te:(console.warn("Fontkit module loaded but does not have create method"),null)}catch(d){return console.warn("Failed to load fontkit, falling back to standard fonts:",d),null}}return Te}async function Pt(){try{const d=["https://unpkg.com/@fontsource/noto-sans@5/files/noto-sans-all-400-normal.woff2","https://raw.githubusercontent.com/google/fonts/main/ofl/notosans/NotoSans-Regular.ttf","https://fonts.googleapis.com/css2?family=Noto+Sans&display=swap"],D="/ChatNote/",y=`${D.endsWith("/")?D:`${D}/`}NotoSans-Regular.ttf`;try{const fe=await fetch(y);if(fe.ok){const j=await fe.arrayBuffer();if(j.byteLength>1e3){const S=new Uint8Array(j);if(S.length>=4&&S[0]===0&&S[1]===1&&S[2]===0&&S[3]===0)return j}}}catch{}for(const fe of d)if(!fe.includes("fonts.googleapis.com/css"))try{const j=await fetch(fe,{mode:"cors",cache:"default"});if(j.ok){const S=await j.arrayBuffer();if(S.byteLength>1e3){const C=new Uint8Array(S),ge=C.length>=4&&C[0]===0&&C[1]===1&&C[2]===0&&C[3]===0,G=C.length>=4&&C[0]===119&&C[1]===79&&C[2]===70&&C[3]===70,x=C.length>=4&&C[0]===119&&C[1]===79&&C[2]===70&&C[3]===50;if(ge||G||x)return S;continue}}}catch{continue}return console.warn("All font loading methods failed. To enable Unicode support, please download NotoSans-Regular.ttf and place it in the public/ folder."),null}catch(d){return console.warn("Failed to load Unicode font:",d),null}}async function Tt(d,D,O){try{const y=await Dt(),{PDFDocument:fe,rgb:j,degrees:S,StandardFonts:C}=y;if(!C)throw new Error("StandardFonts not available from pdf-lib");const ge=await d.arrayBuffer(),G=await fe.load(ge);let x=null;try{const w=await Et();if(w){try{G.registerFontkit(w)}catch(p){(!p.message||!p.message.includes("already registered"))&&console.warn("Failed to register fontkit:",p)}const Z=await Pt();if(Z){const p=new Uint8Array(Z),ye=p.length>=4&&p[0]===0&&p[1]===1&&p[2]===0&&p[3]===0,ne=p.length>=4&&p[0]===79&&p[1]===84&&p[2]===84&&p[3]===79,he=p.length>=4&&p[0]===116&&p[1]===116&&p[2]===99&&p[3]===102,q=p.length>=4&&p[0]===119&&p[1]===79&&p[2]===70&&p[3]===70,h=p.length>=4&&p[0]===119&&p[1]===79&&p[2]===70&&p[3]===50;q||h?console.warn("Font file is WOFF/WOFF2 format, fontkit requires TTF/OTF. Font will not be embedded."):ye||ne||he?x=await G.embedFont(Z):console.warn(`Invalid font format. File size: ${p.length} bytes`)}}}catch(w){console.warn("Failed to embed Unicode font, falling back to standard font:",w)}if(!x){const w=C.Helvetica||C.TimesRoman;if(!w)throw new Error("No standard font available");x=await G.embedFont(w)}if(!x)throw new Error("Failed to embed font");const be=G.getPages();for(const w of D){const Z=be[w.pageNumber-1];if(!Z)continue;const p=O.get(w.pageNumber);if(!p)continue;const{width:ye,height:ne}=p;let he=w.width*ye,q=w.height*ne;if(w.type==="textbox"){const h=w,N=Ft(h.color)||{r:0,g:0,b:0},R=w.x*ye,ve=w.y*ne;let Q=(w.y+w.height)*ne;const Y=4,b=he-Y*2,oe=(h.text||"").trimEnd();let H=oe.split(/\r\n|\r|\n/).filter(m=>m!=null);for(;H.length>0&&H[H.length-1].length===0;)H.pop();if(H.length===0&&(H=[""]),H.length===1&&x&&typeof x.widthOfTextAtSize=="function"){const m=H[0],L=b;let A;try{A=x.widthOfTextAtSize(m,h.fontSize)}catch{A=m.length*h.fontSize*.5}if(A>L){const ae=[],M=m.split(/(\s+)/);let E="";for(let le=0;le<M.length;le++){const n=M[le],u=E+n;let f;try{f=x.widthOfTextAtSize(u,h.fontSize)}catch{f=u.length*h.fontSize*.5}f<=L||E===""?E=u:(E.trim()&&ae.push(E.trim()),E=n)}E.trim()&&ae.push(E.trim()),ae.length>1&&(H=ae)}}const se=h.fontSize*1.2;q=H.length>0?(H.length-1)*se+h.fontSize+Y*2:h.fontSize+Y*2,Q=ve+q;const U=ne-Q,pe=ne-ve-U,I=U+pe/2,me=h.fontSize*.2,Re=ne-h.fontSize*.2,ie=Math.max(me,Math.min(Re,I));if((H.length>1||oe.includes(`
`)||oe.includes("\r"))&&H.length>0)try{const m=(H.length-1)*se,L=ie+m/2;H.forEach((A,ae)=>{const M=L-ae*se;let E;try{x&&typeof x.widthOfTextAtSize=="function"?E=x.widthOfTextAtSize(A,h.fontSize):E=A.length*h.fontSize*.5}catch{E=A.length*h.fontSize*.5}let n=R+Y+b/2-E/2;const u=R+Y,f=R+he-E-Y;n=Math.max(u,Math.min(f,n));const c=A.length>0?A:" ";Z.drawText(c,{x:n,y:M,size:h.fontSize,color:j(N.r/255,N.g/255,N.b/255),rotate:S(h.rotation),font:x})})}catch(m){if(m.message&&m.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",m.message);const L=H.map(M=>M.split("").map(E=>E.charCodeAt(0)>255?"?":E).join("")),A=(L.length-1)*se,ae=ie+A/2;try{L.forEach((M,E)=>{const le=ae-E*se;let n;try{x&&typeof x.widthOfTextAtSize=="function"?n=x.widthOfTextAtSize(M,h.fontSize):n=M.length*h.fontSize*.5}catch{n=M.length*h.fontSize*.5}let f=R+Y+b/2-n/2;const c=R+Y,a=R+he-n-Y;f=Math.max(c,Math.min(a,f)),Z.drawText(M,{x:f,y:le,size:h.fontSize,color:j(N.r/255,N.g/255,N.b/255),rotate:S(h.rotation),font:x})})}catch(M){console.error("Failed to draw text even after replacing Unicode characters:",M);continue}}else throw m}else{let m;try{x&&typeof x.widthOfTextAtSize=="function"?m=x.widthOfTextAtSize(h.text,h.fontSize):m=h.text.length*h.fontSize*.5}catch{m=h.text.length*h.fontSize*.5}let A=R+Y+b/2-m/2;const ae=R+Y,M=R+he-m-Y;A=Math.max(ae,Math.min(M,A));try{Z.drawText(h.text,{x:A,y:ie,size:h.fontSize,color:j(N.r/255,N.g/255,N.b/255),rotate:S(h.rotation),font:x})}catch(E){if(E.message&&E.message.includes("cannot encode")){console.warn("Unicode character encoding failed, replacing unsupported characters:",E.message);const le=h.text.split("").map(n=>n.charCodeAt(0)>255?"?":n).join("");try{Z.drawText(le,{x:A,y:ie,size:h.fontSize,color:j(N.r/255,N.g/255,N.b/255),rotate:S(h.rotation),font:x})}catch(n){console.error("Failed to draw text even after replacing Unicode characters:",n);continue}}else throw E}}}else if(w.type==="image"){const h=w,N=await fetch(h.imageData).then(_=>_.arrayBuffer());let R;if(h.imageData.startsWith("data:image/png"))R=await G.embedPng(N);else if(h.imageData.startsWith("data:image/jpeg")||h.imageData.startsWith("data:image/jpg"))R=await G.embedJpg(N);else throw console.error("Unsupported image format for PDF embedding:",h.imageData.substring(0,30)),new Error("Unsupported image format. Only PNG and JPEG are supported for PDF embedding.");const ve=h.imageWidth/h.imageHeight;let Q=he,Y=q;he/q>ve?Q=q*ve:Y=he/ve;const oe=w.x*ye,ee=(w.y+w.height)*ne,T=ne-ee+(q-Y)/2;Z.drawImage(R,{x:oe,y:T,width:Q,height:Y,rotate:S(h.rotation)})}}const V=await G.save();return new Blob([V],{type:"application/pdf"})}catch(y){throw console.error("Error saving annotated PDF:",y),new Error("Failed to save annotated PDF")}}function Ft(d){const D=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(d);return D?{r:parseInt(D[1],16),g:parseInt(D[2],16),b:parseInt(D[3],16)}:null}function tt(d,D="annotated.pdf"){const O=URL.createObjectURL(d),y=document.createElement("a");y.href=O,y.download=D,document.body.appendChild(y),y.click(),document.body.removeChild(y),URL.revokeObjectURL(O)}const Lt="/ChatNote/assets/chatnote-logo-BGY00N4J.svg",Xe=d=>Math.max(0,Math.min(1,d)),Wt=d=>d?(d.querySelector(".react-pdf__Page")??d).getBoundingClientRect():null;function It({file:d,onFileUpload:D,onTextSelection:O,layout:y="floating",showLayoutToggle:fe=!0,onPageChange:j,onTotalPagesChange:S,showKnowledgeNotes:C=!0,knowledgeNotes:ge=[],onScrollToPage:G,onNoteClick:x,onAddAnnotation:be,initialAnnotations:V=[],onAnnotationsChange:w,isLoadingPdf:Z=!1,onLoadingComplete:p,isSavingSession:ye=!1,onNewSession:ne,onToggleLayout:he,isDriveAuthorized:q,onSelectRecentPdf:h}){const{isChatVisible:N}=Ct(),[R,ve]=r.useState(0),[Q,Y]=r.useState(1),[b,oe]=r.useState(1),[ee,H]=r.useState(!1),[se,T]=r.useState("100"),_=r.useRef(null),U=r.useRef(new Map),F=r.useRef(null),pe=r.useRef(null),Se=r.useRef(!1),I=r.useRef(new Map),[me,Re]=r.useState(0),[ie,re]=r.useState(V),[m,L]=r.useState(null),[A,ae]=r.useState(null),[M,E]=r.useState(null),[le,n]=r.useState(null),[u,f]=r.useState(!1),[c,a]=r.useState("#ffeb3b"),[$,v]=r.useState(!1),k=r.useRef(V),we=r.useRef(w),Ne=r.useRef(0);r.useEffect(()=>{we.current=w},[w]),r.useEffect(()=>{const e=k.current,o=V.length!==e.length||V.some((i,l)=>i.id!==e[l]?.id);V&&V.length>0&&o?(re(V),k.current=V):d&&V.length===0&&e.length>0?(re([]),k.current=[],L(null)):!d&&e.length>0&&(re([]),k.current=[],L(null))},[V,d]),r.useEffect(()=>{JSON.stringify(k.current)!==JSON.stringify(ie)&&we.current&&(k.current=ie,we.current(ie))},[ie]),r.useEffect(()=>{const e=console.warn,o=console.error;return console.warn=(...i)=>{const l=i.join(" ");l.includes("TextLayer task cancelled")||l.includes("AbortException")||i.some(s=>typeof s=="string"&&(s.includes("TextLayer task cancelled")||s.includes("AbortException")))||e.apply(console,i)},console.error=(...i)=>{const l=i.join(" ");l.includes("TextLayer task cancelled")||l.includes("AbortException")&&l.includes("TextLayer")||o.apply(console,i)},()=>{console.warn=e,console.error=o}},[]);const ue=r.useMemo(()=>d?URL.createObjectURL(d):null,[d]),ke=r.useRef(null);r.useEffect(()=>(ke.current&&ke.current!==ue&&URL.revokeObjectURL(ke.current),ke.current=ue,()=>{ue&&URL.revokeObjectURL(ue)}),[ue]);const ze=r.useMemo(()=>{let e;const o="https://unpkg.com/pdfjs-dist@5.4.394/standard_fonts/";{const i="/ChatNote/";e=`${i.endsWith("/")?i:`${i}/`}pdf.worker.min.js`}return Ie&&(Ie.workerSrc=e,Ie.standardFontDataUrl=o),{workerSrc:e,cMapUrl:"https://unpkg.com/pdfjs-dist@5.4.394/cmaps/",cMapPacked:!0,standardFontDataUrl:o,verbosity:0}},[]),Fe=({numPages:e})=>{ve(e),S?.(e);const o=1;Y(o),setTimeout(()=>{j?.(o)},0),U.current.clear(),I.current.clear(),p&&setTimeout(()=>{p()},300)},Le=e=>{if(!I.current.has(e.pageNumber))try{const o=e.page;let i,l;o.viewport?(i=o.viewport.width,l=o.viewport.height):(i=o.width/b,l=o.height/b),I.current.set(e.pageNumber,{width:i,height:l})}catch(o){console.warn("Error getting page dimensions:",o);const i=e.page,l=i.width/b,s=i.height/b;I.current.set(e.pageNumber,{width:l,height:s})}};r.useEffect(()=>{if(!F.current||R===0)return;let e=null,o=!1;const i=()=>{if(Se.current||o||e)return;o=!0,e=setTimeout(()=>{e=null,o=!1},100);const s=F.current;if(!s){o=!1;return}const g=s.getBoundingClientRect(),X=g.top,P=g.height,J=X+P/2;if(s.scrollTop<100){Y(z=>z!==1?(setTimeout(()=>{j?.(1)},0),1):z);return}let de=1,B=0;for(let z=1;z<=R;z++){const W=U.current.get(z);if(W){const ce=W.getBoundingClientRect(),K=s.getBoundingClientRect(),je=Math.max(K.top,ce.top),Me=Math.min(K.bottom,ce.bottom),De=Math.max(0,Me-je);De>B&&(B=De,de=z)}}if(B<P*.1){let z=1,W=1/0;for(let ce=1;ce<=R;ce++){const K=U.current.get(ce);if(K){const je=K.getBoundingClientRect(),Me=je.top+je.height/2,De=Math.abs(Me-J);De<W&&(W=De,z=ce)}}de=z}Y(z=>de!==z?(setTimeout(()=>{j?.(de)},0),de):z)},l=F.current;return l?.addEventListener("scroll",i,{passive:!0}),()=>{e&&clearTimeout(e),l?.removeEventListener("scroll",i)}},[R,j]),r.useEffect(()=>{let e=null;const o=()=>{e&&clearTimeout(e),e=setTimeout(()=>{Re(i=>i+1)},150)};return window.addEventListener("resize",o),()=>{e&&clearTimeout(e),window.removeEventListener("resize",o)}},[]);const We=e=>{console.error("PDF load error:",e)},Ce=async e=>{const o=e.target.files?.[0];if(o&&o.type==="application/pdf"){D(o);const i=o.size/(1024*1024),l=xe.generateDocumentId();xe.setCurrentDocument(l),await xe.createDocument(l,i),await xe.trackPDFUpload(i,l)}},Ee=r.useCallback(e=>{const o=U.current.get(e);o&&F.current&&(Se.current=!0,Y(e),j?.(e),o.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{Se.current=!1},1500))},[j]);r.useEffect(()=>(G&&(window.__pdfScrollToPage=Ee),F.current&&(window.__pdfContentRef=F.current),pe.current&&(window.__pdfViewerHeight=pe.current.clientHeight),()=>{delete window.__pdfScrollToPage,delete window.__pdfContentRef,delete window.__pdfViewerHeight}),[Ee,G,R,b]);const Oe=()=>{const e=Math.max(1,Q-1);Ee(e)},Ae=()=>{const e=Math.min(R,Q+1);Ee(e)},He=()=>{const e=Math.min(b+.2,5);oe(e),T(Math.round(e*100).toString())},_e=()=>{const e=Math.max(b-.2,.25);oe(e),T(Math.round(e*100).toString())};r.useEffect(()=>{ee||T(Math.round(b*100).toString())},[b,ee]);const Pe=()=>{H(!0),T(Math.round(b*100).toString())},ot=e=>{let o=e.target.value;o=o.replace(/[^0-9]/g,""),o.length>1&&o.startsWith("0")&&(o=o.replace(/^0+/,"")||"0"),o.length>3&&(o=o.slice(0,3)),T(o)},st=()=>{Ve()},it=e=>{if(e.key==="Enter")e.preventDefault(),Ve();else if(e.key==="Escape")H(!1),T(Math.round(b*100).toString()),_.current?.blur();else{if(e.key==="Backspace"||e.key==="Delete"||e.key==="ArrowLeft"||e.key==="ArrowRight"||e.key==="Tab")return;(e.key==="-"||e.key==="+"||e.key==="."||e.key===","||e.key==="e"||e.key==="E"||!/[0-9]/.test(e.key)&&!e.ctrlKey&&!e.metaKey)&&e.preventDefault()}},rt=e=>{e.preventDefault();const i=e.clipboardData.getData("text").replace(/[^0-9]/g,"");if(i){const s=(i.replace(/^0+/,"")||"0").slice(0,3);if(T(s),s&&s!=="0"){const g=parseInt(s,10);if(!isNaN(g)&&g>0){const X=Math.max(25,Math.min(500,g)),P=X/100;oe(P),T(X.toString()),H(!1)}}}},Ve=()=>{if(se.trim()===""||se==="0"){T(Math.round(b*100).toString()),H(!1);return}const e=parseInt(se,10);if(isNaN(e)||e<=0){T(Math.round(b*100).toString()),H(!1);return}const o=Math.max(25,Math.min(500,e)),i=o/100;oe(i),T(o.toString()),H(!1)};r.useEffect(()=>{ee&&_.current&&(_.current.focus(),_.current.select())},[ee]);const at=()=>{if(I.current.size===0)return;let e=null;if(F.current){const s=F.current,g=getComputedStyle(s),X=parseFloat(g.paddingLeft||"0")||0,P=parseFloat(g.paddingRight||"0")||0;e=s.clientWidth-X-P,s.scrollHeight>s.clientHeight&&(e-=12),e=Math.max(0,e-4)}else if(pe.current){const s=pe.current.getBoundingClientRect();e=Math.max(0,s.width-40)}if(!e||e<=0)return;const o=I.current.get(1);if(!o)return;const i=e/o.width*.999,l=Math.max(.1,Math.min(i,5));oe(l),T(Math.round(l*100).toString())},lt=()=>{if(!pe.current||I.current.size===0)return;const e=pe.current.getBoundingClientRect();let o=0;const i=pe.current.querySelector(".annotation-toolbar");i&&(o=i.getBoundingClientRect().height);const l=e.height-o,s=I.current.get(Q);if(!s)return;const g=l/s.height,X=Math.max(.1,Math.min(g,5));oe(X),T(Math.round(X*100).toString())},Ze=r.useCallback(()=>{const e=window.getSelection();if(e&&e.toString().trim()){const o=e.toString().trim();let i,l;if(e.rangeCount>0&&F.current){const g=e.getRangeAt(0).getBoundingClientRect(),X=F.current.getBoundingClientRect(),P=g.top-X.top+F.current.scrollTop;for(let J=1;J<=R;J++){const te=U.current.get(J);if(te){const de=te.offsetTop,B=te.offsetHeight,z=de+B;if(P>=de&&P<=z){l=J;const W=(P-de)/B;i=Math.max(0,Math.min(1,W)),E({text:o,pageNumber:J,rect:g,pageElement:te});const ce=ie.find(K=>K.type==="highlight"&&K.pageNumber===J&&Math.abs(K.x-Math.max(0,Math.min(1,(g.left-te.getBoundingClientRect().left)/te.offsetWidth)))<.01&&Math.abs(K.y-Math.max(0,Math.min(1,W)))<.01);n(ce?.id||null);break}}}}O(o,l,i)}else O("",void 0,void 0),E(null),n(null),f(!1)},[O,R,ie]),ct=r.useCallback(e=>{const o=e.target;if(o.closest(".textbox-controls")!==null||o.closest(".textbox-font-size-input")!==null||o.closest(".textbox-color-button")!==null||o.closest(".textbox-color-picker")!==null||o.closest(".floating-textbox-toolbar")!==null||o.closest(".color-swatch")!==null||o.classList.contains("textbox-controls")||o.classList.contains("textbox-font-size-input")||o.classList.contains("textbox-color-button")||o.classList.contains("textbox-color-picker")||o.classList.contains("floating-textbox-toolbar")||o.classList.contains("color-swatch"))return;const l=o.closest(".annotation")!==null||o.closest(".annotation-layer")!==null||o.closest(".resize-handle")!==null||o.closest(".rotate-handle")!==null||o.closest(".delete-button")!==null||o.classList.contains("annotation")||o.classList.contains("annotation-layer")||o.classList.contains("resize-handle")||o.classList.contains("rotate-handle")||o.classList.contains("delete-button");setTimeout(()=>{const s=window.getSelection(),g=s&&s.toString().trim().length>0;if(g||O(""),!l&&!g&&L(null),A==="textbox"&&!l&&!g){const X=F.current;if(!X)return;let P=Q,J=.5,te=.5;for(let B=1;B<=R;B++){const z=U.current.get(B);if(z){const W=z.getBoundingClientRect();if(X.getBoundingClientRect()){const K=e.clientX-W.left,je=e.clientY-W.top;if(K>=0&&K<=W.width&&je>=0&&je<=W.height){P=B;const Me=I.current.get(B);if(Me){const De=W.width/Me.width,vt=W.height/Me.height;J=K/(Me.width*De),te=je/(Me.height*vt)}break}}}}if(I.current.get(P)){const B=Math.max(0,Math.min(.8,J-.1)),z=Math.max(0,Math.min(1-.1,te-.05)),W={id:`textbox-${Date.now()}-${Ne.current++}`,type:"textbox",pageNumber:P,x:B,y:z,width:.2,height:.1,rotation:0,text:"Text",fontSize:16,color:Mt[0]};re(ce=>{const K=[...ce,W];return Be(W).catch(je=>{console.warn("Failed to track text box annotation:",je)}),K}),L(W.id),ae("select")}}},100)},[O,A,Q,R,b,L,ae,re]),Be=r.useCallback(async e=>{re(o=>[...o,e]),L(e.id);try{let o="text";e.type==="highlight"?o="highlight":e.type==="image"?o="image":e.type==="textbox"&&(o="text"),await xe.trackAnnotationAdded(o);const i=xe.getCurrentDocumentId();i&&await xe.updateDocument(i,{has_annotations:!0})}catch(o){console.warn("Failed to track annotation creation:",o)}},[]);r.useEffect(()=>(be&&(window.__addPDFAnnotation=e=>{re(o=>[...o,e]),L(e.id),e.pageNumber&&G&&G(e.pageNumber)}),()=>{delete window.__addPDFAnnotation}),[be,G]);const $e=r.useCallback((e,o,i)=>{const l=e.width*o.width*i,s=document.createElement("div");s.style.position="absolute",s.style.visibility="hidden",s.style.width=`${l}px`,s.style.fontSize=`${e.fontSize*i}px`,s.style.fontFamily="inherit",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.padding=`${4*i}px`,s.style.boxSizing="border-box",s.style.lineHeight="1.2",s.textContent=e.text||"Text",document.body.appendChild(s);const g=s.scrollHeight;document.body.removeChild(s);const X=g/(o.height*i);return Math.max(.01,Math.min(1,X))},[]),dt=r.useCallback(e=>{re(o=>{let i=!1;const l=o.map(s=>{if(s.id!==e.id)return s;if(e.type==="textbox"){const g=e,X=I.current.get(g.pageNumber);if(X){const P=$e(g,X,b);return Math.abs((s.height||0)-P)>1e-4||Math.abs((s.x||0)-(g.x||0))>1e-4||Math.abs((s.y||0)-(g.y||0))>1e-4||Math.abs((s.width||0)-(g.width||0))>1e-4||Math.abs((s.rotation||0)-(g.rotation||0))>1e-4||s.type==="textbox"&&(s.text!==g.text||s.color!==g.color||s.fontSize!==g.fontSize)?(i=!0,{...g,height:P}):s}}return Math.abs((s.x||0)-(e.x||0))>1e-4||Math.abs((s.y||0)-(e.y||0))>1e-4||Math.abs((s.width||0)-(e.width||0))>1e-4||Math.abs((s.height||0)-(e.height||0))>1e-4||Math.abs((s.rotation||0)-(e.rotation||0))>1e-4||"color"in s&&"color"in e&&s.color!==e.color?(i=!0,e):s});return i?l:o})},[b,$e]);r.useEffect(()=>{re(e=>e.map(o=>{if(o.type==="textbox"){const i=o,l=I.current.get(i.pageNumber);if(l){const s=$e(i,l,b);return{...i,height:s}}}return o}))},[b,$e]);const ht=r.useCallback(e=>{re(o=>o.filter(i=>i.id!==e)),m===e&&L(null)},[m]),ut=r.useCallback(async e=>{if(!d||!I.current.get(Q))return;const i=new FileReader;i.onload=l=>{const s=l.target?.result,g=new Image;g.onload=()=>{const X=!s.startsWith("data:image/png")&&!s.startsWith("data:image/jpeg")&&!s.startsWith("data:image/jpg");let P=s;if(X){const ce=document.createElement("canvas");ce.width=g.width,ce.height=g.height;const K=ce.getContext("2d");K&&(K.drawImage(g,0,0),P=ce.toDataURL("image/png"))}const J=.2,te=g.width/g.height,de=J/te,W={id:`image-${Date.now()}`,type:"image",pageNumber:Q,x:.4,y:.4,width:J,height:de,rotation:0,imageData:P,imageWidth:g.width,imageHeight:g.height};Be(W),ae("select")},g.src=s},i.readAsDataURL(e)},[d,Q,Be,ae]),ft=r.useCallback(async()=>{if(!M)return;const{pageNumber:e,rect:o,pageElement:i}=M;if(le)re(l=>l.filter(s=>s.id!==le)),n(null),f(!1);else{const s=Wt(i)??i.getBoundingClientRect(),g=s.width||i.offsetWidth,X=s.height||i.offsetHeight,P=Xe((o.left-s.left)/g),J=Xe((o.top-s.top)/X),te=Xe(o.width/g),de=Xe(o.height/X),B={id:crypto.randomUUID(),type:"highlight",pageNumber:e,x:P,y:J,width:Math.max(.01,te),height:Math.max(.01,de),rotation:0,color:c,opacity:.4};re(z=>[...z,B]),n(B.id),f(!0);try{await xe.trackAnnotationAdded("highlight");const z=xe.getCurrentDocumentId();z&&await xe.updateDocument(z,{has_annotations:!0})}catch(z){console.warn("Failed to track highlight annotation:",z)}}},[M,le,c]),gt=r.useCallback(e=>{a(e),le&&re(o=>o.map(i=>i.id===le&&i.type==="highlight"?{...i,color:e}:i))},[le]),qe=r.useCallback(async()=>{if(d)try{if(ie.length===0){const l=d.name;tt(d,l),await xe.trackPDFExport(!1);const s=xe.getCurrentDocumentId();s&&await xe.updateDocument(s,{has_export:!0});return}const e=await Tt(d,ie,I.current),o=d.name.replace(".pdf","_annotated.pdf");tt(e,o),await xe.trackPDFExport(!0);const i=xe.getCurrentDocumentId();i&&await xe.updateDocument(i,{has_export:!0})}catch(e){console.error("Error saving PDF:",e),alert("Failed to save annotated PDF. Please check the console for details.")}},[d,ie]);r.useEffect(()=>{const e=()=>{ne&&ne()},o=()=>{qe()};return window.addEventListener("pdf-new-session",e),window.addEventListener("pdf-download",o),()=>{window.removeEventListener("pdf-new-session",e),window.removeEventListener("pdf-download",o)}},[ne,qe]);const pt=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy",v(!0)},[]),mt=r.useCallback(e=>{e.preventDefault(),e.stopPropagation(),F.current?.contains(e.relatedTarget)||v(!1)},[]),xt=r.useCallback(async e=>{e.preventDefault(),e.stopPropagation();const i=Array.from(e.dataTransfer.files).filter(P=>P.type.startsWith("image/"));if(i.length===0||!F.current?.getBoundingClientRect())return;let s=Q,g=.5,X=.5;for(let P=1;P<=R;P++){const J=U.current.get(P);if(J){const te=J.getBoundingClientRect();if(F.current?.getBoundingClientRect()){const B=e.clientX-te.left,z=e.clientY-te.top;if(B>=0&&B<=te.width&&z>=0&&z<=te.height){s=P;const W=I.current.get(P);W&&(g=B/(W.width*b),X=z/(W.height*b));break}}}}for(const P of i){const J=new FileReader;J.onload=te=>{const de=te.target?.result,B=new Image;B.onload=()=>{if(!I.current.get(s))return;const W=.2,ce=B.width/B.height,K=W/ce,je=Math.max(0,Math.min(1-W,g-W/2)),Me=Math.max(0,Math.min(1-K,X-K/2)),De={id:`image-${Date.now()}-${Math.random()}`,type:"image",pageNumber:s,x:je,y:Me,width:W,height:K,rotation:0,imageData:de,imageWidth:B.width,imageHeight:B.height};Be(De)},B.src=de},J.readAsDataURL(P)}},[Q,R,b,Be]),[Ye,Ke]=r.useState(()=>Je(3)),[wt,Ge]=r.useState(!1);r.useEffect(()=>{let e=!0;return q&&St(3).then(o=>{e&&o&&o.length>0&&Ke(o)}).catch(()=>{}),()=>{e=!1}},[q]),r.useEffect(()=>{if(typeof window>"u")return;const e=()=>{Ke(Je(3))};return window.addEventListener(Qe,e),()=>{window.removeEventListener(Qe,e)}},[]),r.useEffect(()=>{if(q&&Ye&&Ye.length>0){const e=requestAnimationFrame(()=>Ge(!0));return()=>cancelAnimationFrame(e)}Ge(!1)},[q,Ye]);const bt=!d&&!Z,yt=()=>{const e=Ye;return t.jsx("div",{className:`pdf-viewer-empty ${y==="floating"?"float-layout":""}`,children:t.jsxs("div",{className:"start-page-content",children:[t.jsxs("div",{className:"start-top",children:[t.jsx("img",{src:Lt,alt:"ChatNote Logo",className:"start-logo"}),t.jsxs("div",{className:"upload-container",children:[t.jsxs("label",{htmlFor:"pdf-upload",className:"upload-button modern-upload",children:[t.jsx("span",{className:"upload-icon","aria-hidden":"true",children:t.jsxs("svg",{width:"28",height:"28",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M12 19V6M5 12l7-7 7 7"}),t.jsx("rect",{x:"3",y:"19",width:"18",height:"2",rx:"1"})]})}),t.jsx("span",{children:"Upload PDF"})]}),t.jsx("input",{id:"pdf-upload",type:"file",accept:"application/pdf",onChange:Ce,style:{display:"none"}})]})]}),q&&e.length>0&&t.jsxs("div",{className:"recent-pdf-suggestions",children:[t.jsx("div",{className:"suggestions-title",children:"Recent PDFs"}),t.jsx("div",{className:`suggestions-list ${wt?"show":""}`,children:e.map((o,i)=>t.jsxs("button",{className:"suggestion-card",onClick:()=>h&&h(o.pdfId),children:[t.jsx("span",{className:"suggestion-icon","aria-hidden":"true",children:t.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[t.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),t.jsx("polyline",{points:"14 2 14 8 20 8"}),t.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),t.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]})}),t.jsx("span",{className:"suggestion-name",children:o.displayName||o.originalFileName})]},o.pdfId||i))})]})]})})};return t.jsxs("div",{className:`pdf-viewer ${ye?"saving-session":""}`,ref:pe,children:[bt?yt():t.jsxs(t.Fragment,{children:[Z&&t.jsx("div",{className:"pdf-loading-overlay",children:t.jsxs("div",{className:"pdf-loading-spinner",children:[t.jsx("div",{className:"spinner"}),t.jsx("p",{children:"Loading PDF..."})]})}),t.jsx(Rt,{mode:A,onModeChange:ae,highlightColor:c,onHighlightColorChange:gt,onHighlightClick:ft,hasTextSelection:!!M,isHighlightActive:!!le,showColorPicker:u,onImageUpload:ut,onToggleLayout:he,showLayoutToggle:fe,isChatVisible:N,onClearAll:()=>{re([]),L(null)},pageNumber:Q,numPages:R,onPrevPage:Oe,onNextPage:Ae,scale:b,onZoomIn:He,onZoomOut:_e,onFitWidth:at,onFitHeight:lt,layout:y,onZoomInputClick:Pe,isEditingZoom:ee,zoomInputValue:se,onZoomInputChange:ot,onZoomInputBlur:st,onZoomInputKeyDown:it,onZoomInputPaste:rt,zoomInputRef:_}),t.jsx("div",{ref:F,className:`pdf-content ${$?"drag-over":""}`,onMouseUp:Ze,onKeyUp:Ze,onClick:ct,onDragOver:pt,onDragLeave:mt,onDrop:e=>{v(!1),xt(e)},children:d&&t.jsx(kt,{file:ue||d,onLoadSuccess:Fe,onLoadError:We,loading:t.jsx("div",{className:"loading",children:"Loading PDF..."}),error:t.jsxs("div",{className:"error",children:["Failed to load PDF. Please check the console for details.",t.jsx("br",{}),t.jsxs("small",{children:["Worker: ",Ie?.workerSrc||"Not set"]})]}),noData:t.jsx("div",{className:"loading",children:"No PDF file selected"}),options:ze,children:Array.from(new Array(R),(e,o)=>{const i=o+1,l=I.current.get(i);return t.jsxs("div",{ref:s=>{s?U.current.set(i,s):U.current.delete(i)},className:"pdf-page-wrapper",style:{position:"relative"},children:[t.jsx(jt,{pageNumber:i,scale:b,devicePixelRatio:window.devicePixelRatio||1,renderTextLayer:!0,renderAnnotationLayer:!0,onLoadSuccess:s=>Le({pageNumber:i,page:s})},`page_${i}_${me}`),l&&t.jsxs(t.Fragment,{children:[t.jsx(Nt,{pageNumber:i,pageWidth:l.width,pageHeight:l.height,scale:b,annotations:ie,selectedAnnotationId:m,onAnnotationUpdate:dt,onAnnotationDelete:ht,onAnnotationSelect:L,mode:A}),C&&t.jsx(zt,{pageNumber:i,pageWidth:l.width,pageHeight:l.height,scale:b,knowledgeNotes:ge,showKnowledgeNotes:C,layout:y,onNoteClick:x})]})]},`page-wrapper-${i}`)})})})]}),ye&&t.jsx("div",{className:"pdf-saving-overlay",children:t.jsxs("div",{className:"pdf-saving-content",children:[t.jsx("div",{className:"saving-spinner"}),t.jsx("p",{children:"Saving PDF..."}),t.jsx("p",{className:"saving-subtitle",children:"Preparing for new session"})]})})]})}export{It as default};
