const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/PDFViewer-BbiCSIdv.js","assets/vendor-react-QLvrzKBK.js","assets/vendor-D8Lt8S1G.js","assets/vendor-C5EChc_d.css","assets/vendor-pdf-DDxsMbbh.js","assets/vendor-react-CBXYWCWZ.css","assets/PDFViewer-D5-_US88.css"])))=>i.map(i=>d[i]);
import{r as i,j as e,M as je,R as ve,a as be}from"./vendor-react-QLvrzKBK.js";import{p as Ne}from"./vendor-pdf-DDxsMbbh.js";import{k as Se,l as Ce,n as Ee}from"./vendor-D8Lt8S1G.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))m(r);new MutationObserver(r=>{for(const f of r)if(f.type==="childList")for(const x of f.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&m(x)}).observe(document,{childList:!0,subtree:!0});function p(r){const f={};return r.integrity&&(f.integrity=r.integrity),r.referrerPolicy&&(f.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?f.credentials="include":r.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function m(r){if(r.ep)return;r.ep=!0;const f=p(r);fetch(r.href,f)}})();if(typeof window<"u"){let t;{const m="/ChatNote/";t=`${m.endsWith("/")?m:`${m}/`}pdf.worker.min.js`}const o=m=>{try{if(m)if(!m.GlobalWorkerOptions)m.GlobalWorkerOptions={workerSrc:t};else try{m.GlobalWorkerOptions.workerSrc=t}catch{try{Object.defineProperty(m,"GlobalWorkerOptions",{value:{workerSrc:t},writable:!0,configurable:!0})}catch{}}}catch{}};window.pdfjsLib||(window.pdfjsLib={}),window.pdfjsLib.GlobalWorkerOptions?window.pdfjsLib.GlobalWorkerOptions.workerSrc=t:window.pdfjsLib.GlobalWorkerOptions={workerSrc:t},typeof window.pdfjs>"u"&&(window.pdfjs={}),window.pdfjs.GlobalWorkerOptions?window.pdfjs.GlobalWorkerOptions.workerSrc=t:window.pdfjs.GlobalWorkerOptions={workerSrc:t};const p=Ne;if(o(p),p.default&&o(p.default),p.GlobalWorkerOptions)try{p.GlobalWorkerOptions.workerSrc=t}catch{}}const Pe="modulepreload",Ae=function(t){return"/ChatNote/"+t},pe={},me=function(o,p,m){let r=Promise.resolve();if(p&&p.length>0){let y=function(l){return Promise.all(l.map(h=>Promise.resolve(h).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const x=document.querySelector("meta[property=csp-nonce]"),g=x?.nonce||x?.getAttribute("nonce");r=y(p.map(l=>{if(l=Ae(l),l in pe)return;pe[l]=!0;const h=l.endsWith(".css"),u=h?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const d=document.createElement("link");if(d.rel=h?"stylesheet":Pe,h||(d.as="script"),d.crossOrigin="",d.href=l,g&&d.setAttribute("nonce",g),document.head.appendChild(d),h)return new Promise((a,s)=>{d.addEventListener("load",a),d.addEventListener("error",()=>s(new Error(`Unable to preload CSS for ${l}`)))})}))}function f(x){const g=new Event("vite:preloadError",{cancelable:!0});if(g.payload=x,window.dispatchEvent(g),!g.defaultPrevented)throw x}return r.then(x=>{for(const g of x||[])g.status==="rejected"&&f(g.reason);return o().catch(f)})},fe=i.createContext(void 0);function Le({children:t}){const[o,p]=i.useState(()=>localStorage.getItem("theme")||"light");i.useEffect(()=>{document.documentElement.setAttribute("data-theme",o),localStorage.setItem("theme",o)},[o]);const m=()=>{p(r=>r==="light"?"dark":"light")};return e.jsx(fe.Provider,{value:{theme:o,toggleTheme:m},children:t})}function ce(){const t=i.useContext(fe);if(t===void 0)throw new Error("useTheme must be used within a ThemeProvider");return t}const se=[{id:"openai/gpt-oss-120b",name:"GPT OSS",provider:"OpenAI"},{id:"tngtech/deepseek-r1t2-chimera:free",name:"DeepSeek R1",provider:"DeepSeek"},{id:"deepseek/deepseek-chat-v3.1:free",name:"DeepSeek V3.1",provider:"DeepSeek"},{id:"meta-llama/llama-3.3-70b-instruct:free",name:"Llama 3.3",provider:"Meta"},{id:"qwen/qwen3-235b-a22b:free",name:"Qwen 3",provider:"Qwen"}],Te=se[0].id,Q="https://chatnote-backend-8pk3.onrender.com",ge="105659660993-u7lnrcbis23u3mlaigteag67d6h6inar.apps.googleusercontent.com",xe=i.createContext(void 0);function Ie({children:t}){const[o,p]=i.useState(null),[m,r]=i.useState(!0);i.useEffect(()=>{const y=localStorage.getItem("auth_token");y?f(y):r(!1)},[]);const f=async(y,l=0)=>{let u=!1;try{const d=new AbortController,a=setTimeout(()=>d.abort(),1e4),s=await fetch(`${Q}/api/auth/me`,{headers:{Authorization:`Bearer ${y}`},signal:d.signal});if(clearTimeout(a),s.ok){const N=await s.json();p(N.user),u=!0}else if(s.status===401||s.status===403)console.warn("Token invalid, logging out"),localStorage.removeItem("auth_token"),p(null),u=!0;else{if(l<2)return console.warn(`Failed to fetch user (${s.status}), retrying... (${l+1}/2)`),await new Promise(N=>setTimeout(N,1e3*(l+1))),f(y,l+1);console.error("Failed to fetch user after retries, but keeping token:",s.status),u=!0}}catch(d){if(l<2){const a=d instanceof Error?d.name:"Unknown";return console.warn(`Network error (${a}), retrying... (${l+1}/2)`),await new Promise(s=>setTimeout(s,1e3*(l+1))),f(y,l+1)}else d instanceof Error&&d.name==="AbortError"?console.warn("Request timeout after retries, but keeping user logged in"):console.error("Network error fetching user after retries, but keeping token:",d),u=!0}finally{u&&r(!1)}},x=async y=>{try{const l=await fetch(`${Q}/api/auth/google`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({credential:y})});if(!l.ok){const u=await l.json();throw new Error(u.error||"Authentication failed")}const h=await l.json();localStorage.setItem("auth_token",h.token),p(h.user)}catch(l){throw console.error("Login error:",l),l}},g=()=>{localStorage.removeItem("auth_token"),p(null)};return e.jsx(xe.Provider,{value:{user:o,loading:m,login:x,logout:g,isAuthenticated:!!o,isAdmin:o?.role==="admin"},children:t})}function de(){const t=i.useContext(xe);if(t===void 0)throw new Error("useAuth must be used within an AuthProvider");return t}function Me(){const{user:t,login:o,logout:p,loading:m}=de(),[r,f]=i.useState(!1),[x,g]=i.useState(null);i.useEffect(()=>{const h=console.error,u=console.warn;console.error=(...a)=>{const s=a.join(" ");s.includes("Not signed in with the identity provider")||s.includes("AbortError")||s.includes("signal is aborted")||s.includes("FedCM get() rejects")||s.includes("GSI_LOGGER")||s.includes("Only one navigator.credentials.get request may be outstanding")||h.apply(console,a)},console.warn=(...a)=>{const s=a.join(" ");s.includes("GSI_LOGGER")||s.includes("Not signed in with the identity provider")||s.includes("Only one navigator.credentials.get request may be outstanding")||u.apply(console,a)};const d=window.onerror;return window.onerror=(a,s,N,C,D)=>typeof a=="string"&&(a.includes("Not signed in with the identity provider")||a.includes("Only one navigator.credentials.get request may be outstanding")||a.includes("AbortError")||s?.includes("accounts.google.com"))?!0:d?d(a,s,N,C,D):!1,()=>{console.error=h,console.warn=u,window.onerror=d}},[]);const y=i.useCallback(async h=>{try{await o(h.credential);const u=document.getElementById("google-signin-button");u&&u.remove()}catch(u){console.error("Login failed:",u),alert(u instanceof Error?u.message:"Login failed. Please try again.")}},[o]);i.useEffect(()=>{if(window.google){try{window.google.accounts.id.initialize({client_id:ge,callback:y}),f(!0),setTimeout(()=>{try{window.google?.accounts?.id&&window.google.accounts.id.prompt(d=>{})}catch{}},300)}catch(d){console.error("Failed to initialize Google OAuth:",d),g("Failed to initialize Google OAuth")}return}const h=document.createElement("script");h.src="https://accounts.google.com/gsi/client",h.async=!0,h.defer=!0,h.onload=()=>{if(window.google)try{window.google.accounts.id.initialize({client_id:ge,callback:y,use_fedcm_for_prompt:!0}),f(!0),setTimeout(()=>{try{window.google?.accounts?.id&&window.google.accounts.id.prompt(d=>{})}catch{}},300)}catch(d){console.error("Failed to initialize Google OAuth:",d),g("Failed to initialize Google OAuth")}else console.error("Google script loaded but window.google is not available"),g("Google script failed to load")},h.onerror=()=>{console.error("Failed to load Google Identity Services script"),g("Failed to load Google Sign-In script"),f(!1)};const u=setTimeout(()=>{window.google||(console.error("Google script loading timeout"),g("Google Sign-In is taking too long to load"),f(!1))},1e4);return document.head.appendChild(h),()=>{clearTimeout(u)}},[y]),i.useEffect(()=>{if(t){const h=document.getElementById("google-login-backdrop"),u=document.getElementById("google-signin-button");h&&h.remove(),u&&u.remove()}},[t]);const l=()=>{if(x){alert(`Google Sign-In error: ${x}. Please check the browser console.`);return}if(window.google&&r)try{const h=console.error,u=console.warn;console.error=(...a)=>{const s=a.join(" ");s.includes("AbortError")||s.includes("signal is aborted")||s.includes("FedCM get() rejects")||s.includes("The request has been aborted")||s.includes("403")||s.includes("credential_button_library")||s.includes("The given origin is not allowed")||s.includes("GSI_LOGGER")||typeof a[0]=="string"&&a[0].includes("403")||h.apply(console,a)},console.warn=(...a)=>{const s=a.join(" ");s.includes("Cross-Origin-Opener-Policy")||s.includes("window.postMessage")||s.includes("GSI_LOGGER")||u.apply(console,a)};const d=window.onerror;window.onerror=(a,s,N,C,D)=>typeof a=="string"&&(a.includes("403")||a.includes("credential_button_library")||a.includes("accounts.google.com")||s?.includes("accounts.google.com"))?!0:d?d(a,s,N,C,D):!1,setTimeout(()=>{console.error=h,console.warn=u,window.onerror=d},5e3),window.google.accounts.id.prompt(a=>{const s=a.getNotDisplayedReason?.(),N=a.getSkippedReason?.(),C=a.getDismissedReason?.(),D=a.isNotDisplayed?.(),E=a.isSkippedMoment?.(),M=a.isDismissedMoment?.();if(s||N||C||D||E||M){const F=document.getElementById("google-login-backdrop"),O=document.getElementById("google-signin-button");F&&F.remove(),O&&O.remove();const S=document.createElement("div");S.id="google-login-backdrop",S.style.position="fixed",S.style.top="0",S.style.left="0",S.style.width="100%",S.style.height="100%",S.style.backgroundColor="rgba(0, 0, 0, 0.5)",S.style.zIndex="9999",S.style.display="flex",S.style.alignItems="center",S.style.justifyContent="center";const $=()=>{S.remove(),b.remove(),document.removeEventListener("keydown",H)};S.addEventListener("click",w=>{w.target===S&&$()});const H=w=>{w.key==="Escape"&&$()};document.addEventListener("keydown",H);const b=document.createElement("div");b.id="google-signin-button",b.style.position="relative",b.style.background="white",b.style.padding="20px",b.style.borderRadius="8px",b.style.boxShadow="0 4px 12px rgba(0,0,0,0.3)",b.style.zIndex="10000",b.addEventListener("click",w=>{w.stopPropagation()}),S.appendChild(b),document.body.appendChild(S);try{window.google.accounts.id.renderButton(b,{theme:"outline",size:"large",text:"signin_with",width:250})}catch(w){console.warn("Could not render Google button, showing manual login option:",w),b.innerHTML=`
                <p style="margin: 0 0 10px 0; text-align: center;">Sign in with Google</p>
                <button onclick="window.location.href='https://accounts.google.com/signin'" 
                        style="padding: 10px 20px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Continue with Google
                </button>
                <button onclick="document.getElementById('google-login-backdrop')?.remove(); document.getElementById('google-signin-button')?.remove();" 
                        style="margin-top: 10px; padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 4px; cursor: pointer; width: 100%;">
                  Cancel
                </button>
              `;const A=b.querySelector("button:last-child");A&&A.addEventListener("click",()=>{document.removeEventListener("keydown",H)})}}})}catch(h){console.error("Error showing Google sign-in:",h);try{window.google.accounts.id.prompt()}catch(u){console.error("Fallback prompt also failed:",u),alert("Failed to show Google Sign-In. Please try refreshing the page.")}}else alert("Google Sign-In is still loading. Please wait a moment and try again.")};return m&&!t?e.jsx("div",{className:"login-button loading",children:e.jsx("span",{children:"Loading..."})}):t?e.jsxs("div",{className:"login-button user-info",children:[e.jsx("div",{className:"user-avatar",children:t.picture?e.jsx("img",{src:t.picture,alt:t.name||t.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:h=>{const u=h.target;u.style.display="none";const d=u.parentElement;if(d){const a=d.querySelector("span");a&&a.remove();const s=document.createElement("span");s.textContent=t.name?.[0]||t.email[0].toUpperCase(),d.appendChild(s)}}}):e.jsx("span",{children:t.name?.[0]||t.email[0].toUpperCase()})}),e.jsxs("div",{className:"user-details",children:[e.jsx("span",{className:"user-name",children:t.name||t.email}),t.role==="admin"&&e.jsx("span",{className:"user-role",children:"Admin"})]}),e.jsx("button",{onClick:p,className:"logout-button",title:"Logout",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e.jsx("polyline",{points:"16 17 21 12 16 7"}),e.jsx("line",{x1:"21",y1:"12",x2:"9",y2:"12"})]})})]}):x&&!r?e.jsxs("button",{onClick:l,className:"login-button sign-in error",title:x,children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),e.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),"Sign in (Error)"]}):e.jsx("button",{onClick:l,className:"login-button sign-in",disabled:!r,title:r?"Sign in with Google":"Loading Google Sign-In...",children:r?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"}),e.jsx("path",{d:"M3 20a6 6 0 0 1 6-6h6a6 6 0 0 1 6 6v1H3v-1Z"})]}),"Sign in with Google"]}):e.jsx("span",{children:"Loading Google Sign-In..."})})}async function Oe(t){const o=await fetch(`${Q}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(!o.ok)throw new Error("Failed to check API key status");return o.json()}async function De(t,o){const p=await fetch(`${Q}/api/user/api-key`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({apiKey:o})});if(!p.ok){const m=await p.json();throw new Error(m.error||"Failed to save API key")}}function $e(){const{user:t,isAdmin:o}=de(),[p,m]=i.useState(""),[r,f]=i.useState(!1),[x,g]=i.useState(!1),[y,l]=i.useState(!1),[h,u]=i.useState(null);i.useEffect(()=>{t&&!o?d():o&&f(!0)},[t,o]);const d=async()=>{if(t){g(!0);try{const s=localStorage.getItem("auth_token");if(!s)return;const N=await Oe(s);f(N.hasApiKey)}catch(s){console.error("Failed to load API key status:",s)}finally{g(!1)}}},a=async()=>{if(!(!t||!p.trim())){l(!0),u(null);try{const s=localStorage.getItem("auth_token");if(!s)throw new Error("Not authenticated");await De(s,p.trim()),u({type:"success",text:"API key saved securely!"}),m(""),f(!0)}catch(s){u({type:"error",text:s instanceof Error?s.message:"Failed to save API key"})}finally{l(!1)}}};return t?o?e.jsx("div",{className:"api-key-settings",children:e.jsxs("div",{className:"api-key-info admin",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"api-key-title",children:"Admin Account"}),e.jsx("p",{className:"api-key-description",children:"You're using the admin API key. No configuration needed."})]})]})}):x?e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Loading..."})}):e.jsxs("div",{className:"api-key-settings",children:[e.jsxs("div",{className:"api-key-header",children:[e.jsx("h3",{children:"OpenRouter API Key"}),r&&e.jsx("span",{className:"api-key-status-badge",children:"Configured"})]}),e.jsx("p",{className:"api-key-description",children:r?"Your API key is securely stored and encrypted. You can update it below.":"Enter your OpenRouter API key to use the chat feature. Your key will be encrypted and stored securely."}),e.jsxs("div",{className:"api-key-input-group",children:[e.jsx("input",{type:"password",value:p,onChange:s=>m(s.target.value),placeholder:"sk-or-v1-...",className:"api-key-input",disabled:y}),e.jsx("button",{onClick:a,disabled:!p.trim()||y,className:"api-key-save-button",children:y?"Saving...":r?"Update":"Save"})]}),h&&e.jsx("div",{className:`api-key-message ${h.type}`,children:h.text}),e.jsxs("div",{className:"api-key-help",children:[e.jsx("p",{children:e.jsx("strong",{children:"Don't have an API key?"})}),e.jsxs("ol",{children:[e.jsxs("li",{children:["Go to ",e.jsx("a",{href:"https://openrouter.ai/keys",target:"_blank",rel:"noopener noreferrer",children:"OpenRouter"})]}),e.jsx("li",{children:"Sign up or log in"}),e.jsx("li",{children:"Create a new API key"}),e.jsx("li",{children:"Copy and paste it here"})]}),e.jsx("p",{className:"api-key-security-note",children:"ðŸ”’ Your API key is encrypted with AES-256 and stored securely. Only you can use it."})]})]}):e.jsx("div",{className:"api-key-settings",children:e.jsx("p",{className:"api-key-message",children:"Please sign in to configure your API key."})})}function Re(){const{theme:t,toggleTheme:o}=ce(),[p,m]=i.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsx("nav",{className:"navbar",children:e.jsxs("div",{className:"navbar-content",children:[e.jsx("h1",{className:"navbar-title",children:"ChatNote"}),e.jsxs("div",{className:"navbar-actions",children:[e.jsx(Me,{}),e.jsx("button",{className:"settings-toggle",onClick:()=>m(!p),title:"Settings","aria-label":"Settings",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"3"}),e.jsx("path",{d:"M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"})]})}),e.jsx("button",{className:"theme-toggle",onClick:o,title:`Switch to ${t==="light"?"dark":"light"} mode`,"aria-label":`Switch to ${t==="light"?"dark":"light"} mode`,children:t==="light"?e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("path",{d:"M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"})}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"5"}),e.jsx("line",{x1:"12",y1:"1",x2:"12",y2:"3"}),e.jsx("line",{x1:"12",y1:"21",x2:"12",y2:"23"}),e.jsx("line",{x1:"4.22",y1:"4.22",x2:"5.64",y2:"5.64"}),e.jsx("line",{x1:"18.36",y1:"18.36",x2:"19.78",y2:"19.78"}),e.jsx("line",{x1:"1",y1:"12",x2:"3",y2:"12"}),e.jsx("line",{x1:"21",y1:"12",x2:"23",y2:"12"}),e.jsx("line",{x1:"4.22",y1:"19.78",x2:"5.64",y2:"18.36"}),e.jsx("line",{x1:"18.36",y1:"5.64",x2:"19.78",y2:"4.22"})]})})]})]})}),p&&e.jsx("div",{className:"settings-modal-overlay",onClick:()=>m(!1),children:e.jsxs("div",{className:"settings-modal",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"settings-modal-header",children:[e.jsx("h2",{children:"Settings"}),e.jsx("button",{className:"settings-modal-close",onClick:()=>m(!1),"aria-label":"Close settings",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),e.jsx("div",{className:"settings-modal-content",children:e.jsx($e,{})})]})})]})}function we(){return localStorage.getItem("auth_token")}async function Be(t,o,p,m,r){const f=we();if(!f)throw new Error("Authentication required. Please log in.");try{const x={messages:t,context:o,model:m||"openai/gpt-oss-120b",temperature:.7,maxTokens:3e3,stream:!!p};let g;try{g=await fetch(`${Q}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f}`},body:JSON.stringify(x),signal:r})}catch(l){throw l instanceof DOMException&&l.name==="AbortError"?new DOMException("Request aborted by user","AbortError"):l}if(!g.ok){const l=await g.json().catch(()=>({error:{message:"Unknown error"}}));throw g.status===401?(localStorage.removeItem("auth_token"),new Error("Session expired. Please log in again.")):g.status===400&&l.error?.includes("API key not configured")?new Error("API key not configured. Please add your OpenRouter API key in settings."):new Error(l.error?.message||`API request failed with status ${g.status}`)}if(p&&g.body){const l=g.body.getReader(),h=new TextDecoder;let u="",d="";for(;;){if(r?.aborted)throw l.cancel(),new DOMException("Request aborted by user","AbortError");let a,s;try{const C=await l.read();a=C.done,s=C.value}catch(C){throw C instanceof DOMException&&C.name==="AbortError"?(l.cancel(),new DOMException("Request aborted by user","AbortError")):C}if(a)break;d+=h.decode(s,{stream:!0});const N=d.split(`
`);d=N.pop()||"";for(const C of N){const D=C.trim();if(D&&D.startsWith("data: ")){const E=D.slice(6);if(E==="[DONE]")continue;try{const F=JSON.parse(E).choices?.[0]?.delta?.content||"";F&&(u+=F,p(F))}catch(M){console.warn("Failed to parse streaming chunk:",M)}}}}if(d.trim()){const a=d.trim();if(a.startsWith("data: ")){const s=a.slice(6);if(s!=="[DONE]")try{const C=JSON.parse(s).choices?.[0]?.delta?.content||"";C&&(u+=C,p(C))}catch{}}}return u}return(await g.json()).choices[0]?.message?.content||"No response from API"}catch(x){throw x instanceof DOMException&&x.name==="AbortError"||console.error("Chat service error:",x),x}}async function Fe(){const t=we();if(!t)return!1;try{const o=await fetch(`${Q}/api/user/api-key/status`,{headers:{Authorization:`Bearer ${t}`}});if(o.ok){const p=await o.json();return p.hasApiKey||p.isAdmin}return!1}catch{return!1}}function _e(t){if(!t)return t;let o=t.replace(/^([-*+])\s*\n+(?=\S)/gm,"$1 ");return o=o.replace(/\n{3,}/g,`

`),o=o.replace(/([-*+]\s+[^\n]+)\n{2,}([-*+])/g,`$1
$2`),o=o.replace(/[ \t]+$/gm,""),o=o.replace(/\n{2,}(#{1,6}\s+)/g,`

$1`),o=o.replace(/^([-*+])\s*\n+([^\n-*+\s])/gm,"$1 $2"),o}function Ge(t){let o=_e(t);const p=/\[\s*\n*\s*((?:[^[\]]*\\[a-zA-Z@]+[^[\]]*)+)\s*\n*\s*\]/g;return o.replace(p,(m,r)=>/\\[a-zA-Z@]+/.test(r)?`\\[${r.trim().replace(/\n\s*\n+/g,`
`).replace(/^\s+|\s+$/gm,"")}\\]`:m)}function We({selectedText:t,pdfText:o,isExtractingText:p,onToggleLayout:m,layout:r,currentPageNumber:f,onCreateKnowledgeNote:x}){const{theme:g}=ce(),{isAuthenticated:y,user:l,loading:h}=de(),[u,d]=i.useState([]),[a,s]=i.useState(""),[N,C]=i.useState(!1),[D,E]=i.useState(null),[M,F]=i.useState(!0),[O,S]=i.useState(!0),[$,H]=i.useState(Te),[b,w]=i.useState(!1),[A,z]=i.useState(!0),[_,J]=i.useState("quick"),c=i.useRef(null),j=i.useRef(null),k=i.useRef(null),R=i.useRef(null),B=i.useRef(null),[G,I]=i.useState(null),U=()=>{c.current?.scrollIntoView({behavior:"smooth"})},ee=()=>{const n=j.current;if(n){n.style.height="auto";const P=Math.min(Math.max(n.scrollHeight,24),200);n.style.height=`${P}px`}};i.useEffect(()=>{U()},[u]),i.useEffect(()=>{j.current?.focus(),ee()},[]),i.useEffect(()=>{const n=setTimeout(()=>{ee()},0);return()=>clearTimeout(n)},[a]),i.useEffect(()=>{(async()=>{if(y){const v=await Fe();F(!v)}else F(!0)})()},[y,l]),i.useEffect(()=>{r==="split"&&S(!1)},[r]),i.useEffect(()=>{o&&o.trim().length>0&&z(!0)},[o]),i.useEffect(()=>{if(!b){I(null);return}const n=()=>{if(R.current){const T=R.current.getBoundingClientRect(),W=Math.max(T.width,220);I({width:W})}};n();const v=setTimeout(n,10),q=requestAnimationFrame(n),P=setTimeout(n,50);return window.addEventListener("scroll",n,!0),window.addEventListener("resize",n),()=>{clearTimeout(v),clearTimeout(P),cancelAnimationFrame(q),window.removeEventListener("scroll",n,!0),window.removeEventListener("resize",n)}},[b]),i.useEffect(()=>{if(!b)return;const n=q=>{const P=q.target;R.current&&B.current&&!R.current.contains(P)&&!B.current.contains(P)&&w(!1)},v=setTimeout(()=>{document.addEventListener("mousedown",n)},100);return()=>{clearTimeout(v),document.removeEventListener("mousedown",n)}},[b]);const te=n=>{H(n),w(!1)},X=()=>{if(M)return"Select Model";const n=se.find(v=>v.id===$);return n?n.name:"Select Model"},oe=async()=>{const n=a.trim();if(!n&&!t)return;if(!y){E("Please sign in to use the chat feature.");return}if(M){E("Please configure your OpenRouter API key in Settings.");return}O&&S(!1),k.current&&k.current.abort(),k.current=new AbortController;let v=n;t&&!n?v=`Tell me about this: ${t}`:t&&n&&(v=`${n}

Context from PDF: ${t}`);let q;t&&!n?q=t:A&&o&&o.trim().length>0?q=o:t&&n&&(q=t);const P={id:Date.now().toString(),role:"user",content:v,selectedTextAtSend:t||void 0};d(L=>[...L,P]),s(""),setTimeout(()=>{ee()},0),C(!0),E(null);const T=(Date.now()+1).toString(),W=P.selectedTextAtSend,Z={id:T,role:"assistant",content:"",selectedTextAtSend:W};d(L=>[...L,Z]);try{const L=u.slice(-10).map(Y=>({role:Y.role,content:Y.content}));let V="",ne={...P};_==="quick"?ne.content=`${v}

[IMPORTANT: Please provide a concise and direct response. Be brief and to the point, avoiding unnecessary elaboration.]`:_==="thinking"&&(ne.content=`${v}

[IMPORTANT: Please think step by step. Show your reasoning process, break down the problem, and explain your thought process before providing the final answer.]`);const he=Be([...L,ne],q,Y=>{k.current?.signal.aborted||(V+=Y,d(ke=>ke.map(ae=>ae.id===T?{...ae,content:V}:ae)),U())},$,k.current?.signal);he.catch(Y=>{if(!(Y instanceof DOMException&&Y.name==="AbortError"))throw Y}),await he}catch(L){L instanceof DOMException&&L.name==="AbortError"||(console.error("Error sending message:",L),E(L instanceof Error?L.message:"Failed to send message"),d(V=>V.filter(ne=>ne.id!==T)))}finally{C(!1),k.current=null,j.current?.focus()}},re=()=>{k.current&&(k.current.abort(),k.current=null,C(!1),j.current?.focus())},ie=n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),oe())},ye=()=>{t&&(s(`Tell me about this: ${t}`),j.current?.focus())},ue=()=>{d([]),E(null)};return e.jsxs("div",{className:"chatgpt-wrapper",children:[!h&&!y&&r==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!h&&y&&M&&r==="floating"&&e.jsxs("div",{className:"api-key-warning-outer",children:[e.jsx("span",{children:"âš ï¸ OpenRouter API key not configured"}),e.jsx("span",{className:"warning-hint",children:l?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),r==="floating"&&e.jsxs("div",{className:`model-selector-bar ${g==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:R,children:[e.jsxs("button",{type:"button",onClick:n=>{n.preventDefault(),n.stopPropagation();const v=!b;w(v),v||I(null)},className:"model-selector-button",title:"Select AI model",disabled:M,children:[e.jsx("span",{className:"model-selector-text",children:X()}),e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{transform:b?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]}),b&&e.jsx("div",{ref:B,className:"model-selector-dropdown",onClick:n=>n.stopPropagation(),onMouseDown:n=>n.stopPropagation(),style:G?{width:`${G.width}px`}:void 0,children:se.map(n=>e.jsxs("button",{type:"button",onClick:v=>{v.preventDefault(),v.stopPropagation(),te(n.id)},className:`model-option ${$===n.id?"selected":""}`,children:[e.jsxs("div",{className:"model-option-content",children:[e.jsx("span",{className:"model-option-name",children:n.name}),e.jsx("span",{className:"model-option-provider",children:n.provider})]}),$===n.id&&e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})]},n.id))}),e.jsx("button",{type:"button",onClick:n=>{n.preventDefault(),n.stopPropagation(),J(v=>v==="quick"?"thinking":"quick")},className:"response-mode-button",title:_==="quick"?"Switch to thinking mode":"Switch to quick mode",disabled:M,children:e.jsx("span",{className:"response-mode-text",children:_==="quick"?"âš¡ Quick":"ðŸ§  Thinking"})})]}),e.jsxs("div",{className:"header-actions",children:[u.length>0&&e.jsx("button",{onClick:ue,className:"clear-button",title:"Clear chat",children:"Clear"}),r==="floating"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:m,className:"layout-toggle-button",title:r==="floating"?"Switch to split layout":"Switch to floating layout","aria-label":r==="floating"?"Switch to split layout":"Switch to floating layout",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:r==="floating"?e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]}):e.jsxs(e.Fragment,{children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2"}),e.jsx("line",{x1:"9",y1:"3",x2:"9",y2:"21"})]})})}),e.jsx("button",{onClick:()=>S(!O),className:"collapse-button",title:O?"Expand chat":"Collapse chat","aria-label":O?"Expand chat":"Collapse chat",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{transform:O?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx("path",{d:"M18 15l-6-6-6 6"})})})]})]})]}),e.jsxs("div",{className:`chatgpt-inner ${g==="dark"?"theme-dark":"theme-light"} ${O&&r==="floating"?"collapsed":""}`,children:[t&&e.jsxs("div",{className:"selected-text-banner",children:[e.jsx("span",{className:"banner-text",children:"Selected text available"}),e.jsx("button",{onClick:ye,className:"use-text-button",children:"Use in chat"})]}),(!O||r==="split")&&e.jsxs("div",{className:"chatgpt-messages",children:[u.length===0&&e.jsxs("div",{className:"welcome-screen",children:[e.jsx("div",{className:"welcome-icon",children:e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z",fill:"#10a37f",opacity:"0.1"}),e.jsx("path",{d:"M6 9H18M6 13H14",stroke:"#10a37f",strokeWidth:"2",strokeLinecap:"round"})]})}),e.jsx("h3",{children:"How can I help you today?"}),e.jsx("p",{children:"Ask me anything about your PDF, or select text to get context-specific answers."})]}),u.map((n,v)=>{const q=n.role==="assistant"&&v===u.length-1;return e.jsxs("div",{className:`message ${n.role==="user"?"message-user":"message-assistant"}`,children:[e.jsx("div",{className:"message-avatar",children:n.role==="user"?e.jsx("div",{className:"avatar-user",children:l?.picture?e.jsx("img",{src:l.picture,alt:l.name||l.email,crossOrigin:"anonymous",referrerPolicy:"no-referrer",onError:P=>{const T=P.target;T.style.display="none";const W=T.parentElement;if(W){const Z=W.querySelector("span.avatar-fallback");Z&&Z.remove();const L=document.createElement("span");L.className="avatar-fallback",L.textContent=l.name?.[0]?.toUpperCase()||l.email[0].toUpperCase(),W.appendChild(L)}}}):e.jsx("span",{className:"avatar-fallback",children:l?.name?.[0]?.toUpperCase()||l?.email?.[0]?.toUpperCase()||"U"})}):e.jsx("div",{className:"avatar-assistant",children:e.jsx("img",{src:"/chatnote-icon.svg",alt:"ChatNote",className:"assistant-avatar-img",onError:P=>{const T=P.target;T.style.display="none";const W=T.parentElement;if(W){const Z=W.querySelector("svg.avatar-fallback-svg");Z&&Z.remove();const L=document.createElementNS("http://www.w3.org/2000/svg","svg");L.setAttribute("width","32"),L.setAttribute("height","32"),L.setAttribute("viewBox","0 0 24 24"),L.setAttribute("fill","none"),L.setAttribute("class","avatar-fallback-svg");const V=document.createElementNS("http://www.w3.org/2000/svg","path");V.setAttribute("d","M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z"),V.setAttribute("fill","currentColor"),L.appendChild(V),W.appendChild(L)}}})})}),e.jsxs("div",{className:"message-content-wrapper",children:[e.jsx("div",{className:"message-content",children:n.role==="assistant"&&N&&!n.content&&q?e.jsxs("div",{className:"typing-indicator",children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]}):n.role==="assistant"&&n.content?e.jsx("div",{className:"markdown-content",children:e.jsx(je,{remarkPlugins:[Ce,Ee],rehypePlugins:[Se],components:{table:({children:P,...T})=>e.jsx("div",{className:"table-scroll-wrapper",children:e.jsx("table",{...T,children:P})}),div:({children:P,className:T,...W})=>T&&(T.includes("katex-display")||T.includes("math-display"))?e.jsx("div",{className:`math-scroll-wrapper ${T}`,...W,children:P}):e.jsx("div",{...W,className:T,children:P}),pre:({children:P,...T})=>e.jsx("pre",{className:"code-scroll-wrapper",...T,children:P})},children:Ge(n.content)})}):e.jsx("div",{className:"markdown-content",children:n.content})}),n.role==="assistant"&&n.content&&e.jsxs("div",{className:"message-actions",children:[e.jsxs("button",{className:"message-action-button copy-button",onClick:async()=>{try{await navigator.clipboard.writeText(n.content)}catch(P){console.error("Failed to copy:",P)}},title:"Copy to clipboard",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"9",y:"9",width:"13",height:"13",rx:"2",ry:"2"}),e.jsx("path",{d:"M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"})]}),"Copy"]}),e.jsxs("button",{className:"message-action-button knowledge-note-button",onClick:()=>{if(x){const P=n.selectedTextAtSend||t||void 0;x(n.content,P,f,n.id)}},title:"Create knowledge note",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),"Save Note"]})]})]})]},n.id)}),D&&e.jsxs("div",{className:"error-message",children:[e.jsx("div",{className:"error-icon",children:"âš ï¸"}),e.jsx("div",{className:"error-text",children:D})]}),e.jsx("div",{ref:c})]}),!h&&!y&&r==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsx("span",{children:"ðŸ” Please sign in to use the chat feature"}),e.jsx("span",{className:"warning-hint",children:'Click "Sign in with Google" in the navigation bar'})]}),!h&&y&&M&&r==="split"&&e.jsxs("div",{className:"api-key-warning-split-top",children:[e.jsx("span",{children:"âš ï¸ OpenRouter API key not configured"}),e.jsx("span",{className:"warning-hint",children:l?.role==="admin"?"Admin API key not configured on server":"Add your API key in Settings (click the gear icon)"})]}),r==="split"&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:`model-selector-bar ${g==="dark"?"theme-dark":"theme-light"}`,children:[e.jsxs("div",{className:"model-selector-wrapper",ref:R,children:[e.jsxs("button",{type:"button",onClick:n=>{n.preventDefault(),n.stopPropagation();const v=!b;w(v),v||I(null)},className:"model-selector-button",title:"Select AI model",disabled:M||!y,children:[e.jsx("span",{className:"model-selector-text",children:X()}),e.jsx("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{transform:b?"rotate(180deg)":"rotate(0deg)",transition:"transform 0.3s"},children:e.jsx("path",{d:"M6 9l6 6 6-6"})})]}),b&&e.jsx("div",{ref:B,className:"model-selector-dropdown",onClick:n=>n.stopPropagation(),onMouseDown:n=>n.stopPropagation(),style:G?{width:`${G.width}px`}:void 0,children:se.map(n=>e.jsxs("button",{type:"button",onClick:v=>{v.preventDefault(),v.stopPropagation(),te(n.id)},className:`model-option ${$===n.id?"selected":""}`,children:[e.jsxs("div",{className:"model-option-content",children:[e.jsx("span",{className:"model-option-name",children:n.name}),e.jsx("span",{className:"model-option-provider",children:n.provider})]}),$===n.id&&e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})]},n.id))}),e.jsx("button",{type:"button",onClick:n=>{n.preventDefault(),n.stopPropagation(),J(v=>v==="quick"?"thinking":"quick")},className:"response-mode-button",title:_==="quick"?"Switch to thinking mode":"Switch to quick mode",disabled:M||!y,children:e.jsx("span",{className:"response-mode-text",children:_==="quick"?"âš¡ Quick":"ðŸ§  Thinking"})})]}),u.length>0&&e.jsx("button",{onClick:ue,className:"clear-button",title:"Clear chat",children:"Clear"}),e.jsx("button",{onClick:m,className:"layout-toggle-button",title:"Switch to floating layout","aria-label":"Switch to floating layout",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"}),e.jsx("line",{x1:"10",y1:"3",x2:"10",y2:"10"}),e.jsx("line",{x1:"3",y1:"10",x2:"10",y2:"10"})]})})]})}),o&&o.trim().length>0&&e.jsx("div",{className:`pdf-context-toggle-container ${g==="dark"?"theme-dark":"theme-light"}`,children:e.jsxs("button",{type:"button",onClick:()=>z(!A),className:`pdf-context-toggle ${A?"active":""}`,title:A?"PDF context is enabled. Click to disable.":"PDF context is disabled. Click to enable.",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"}),e.jsx("polyline",{points:"10 9 9 9 8 9"})]}),e.jsx("span",{className:"pdf-context-toggle-text",children:A?"Using PDF context":"PDF context off"}),p&&e.jsx("span",{className:"pdf-context-extracting",children:"Extracting..."})]})}),e.jsx("div",{className:"chatgpt-input-container",children:e.jsxs("div",{className:"input-wrapper",children:[e.jsx("textarea",{ref:j,value:a,onChange:n=>s(n.target.value),onKeyPress:ie,placeholder:"Ask a question...",rows:1,className:"chatgpt-input",disabled:N||M||!y}),N?e.jsx("button",{onClick:re,className:"send-button pause-button",title:"Pause/Stop response",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"}),e.jsx("rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",fill:"currentColor"})]})}):e.jsx("button",{onClick:oe,disabled:!a.trim()&&!t||M||!y,className:"send-button",title:"Send message",children:e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",children:e.jsx("path",{d:"M22 2L11 13M22 2L15 22L11 13M22 2L2 9L11 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})})]})}),r==="split"&&e.jsx("div",{className:`footer-text-outer split-footer ${g==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})}),r==="floating"&&e.jsx("div",{className:`footer-text-outer ${g==="dark"?"theme-dark":"theme-light"}`,children:e.jsx("span",{className:"footer-text",children:"AI responses may contain errors. Please verify important information."})})]})]})}class ze extends i.Component{constructor(o){super(o),this.state={hasError:!1,error:null}}static getDerivedStateFromError(o){return{hasError:!0,error:o}}render(){return this.state.hasError?this.props.fallback||e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#666",height:"100%",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:e.jsxs("div",{style:{maxWidth:"400px"},children:[e.jsx("h3",{style:{marginBottom:"10px"},children:"PDF Viewer Temporarily Unavailable"}),e.jsx("p",{style:{marginBottom:"20px"},children:"There's a configuration issue with the PDF viewer. The rest of the app is working fine!"}),e.jsxs("p",{style:{fontSize:"12px",color:"#999",marginBottom:"20px"},children:["Error: ",this.state.error?.message||"Unknown error"]}),e.jsxs("div",{style:{marginTop:"20px"},children:[e.jsx("label",{htmlFor:"pdf-upload-fallback",style:{padding:"12px 24px",backgroundColor:"#007bff",color:"white",border:"none",borderRadius:"6px",fontSize:"16px",fontWeight:"500",cursor:"pointer",display:"inline-block"},children:"Upload PDF (Basic)"}),e.jsx("input",{id:"pdf-upload-fallback",type:"file",accept:"application/pdf",onChange:o=>{const p=o.target.files?.[0];p&&alert(`PDF "${p.name}" selected. PDF viewing will work once the configuration issue is resolved.`)},style:{display:"none"}})]}),e.jsx("button",{onClick:()=>this.setState({hasError:!1,error:null}),style:{marginTop:"15px",padding:"8px 16px",backgroundColor:"#6c757d",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Try Again"})]})}):this.props.children}}const qe=({notes:t,onDeleteNote:o,onClearAllNotes:p,onScrollToPage:m,onHighlightText:r,layout:f,theme:x,onNoteClick:g,isVisible:y=!0,onClose:l,pdfContentRef:h})=>{const[u,d]=i.useState(new Set),a=i.useRef(null),[s,N]=i.useState(0),[C,D]=i.useState(new Map),[E,M]=i.useState("following"),[F,O]=i.useState(!1),[S,$]=i.useState(null),[H,b]=i.useState(null);i.useEffect(()=>{if(!F)return;const c=j=>{j.key==="Escape"&&(O(!1),$(null))};return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[F]);const w=i.useCallback((c,j)=>{j.preventDefault(),j.stopPropagation(),d(k=>{const R=new Set(k);return R.has(c)?R.delete(c):R.add(c),R})},[]);i.useEffect(()=>{const c=()=>h?.current?h.current:window.__pdfContentRef||null,j=()=>{const B=c();if(B&&a.current){const G=B.scrollHeight;if(N(G),E==="following"?a.current.style.height=`${G}px`:a.current.style.height="auto",E==="following"){const I=B.scrollTop;a.current.style.transform=`translateY(-${I}px)`}else a.current.style.transform="none"}};j();const k=c();if(k){const B=()=>{if(a.current&&E==="following"){const U=k.scrollTop;a.current.style.transform=`translateY(-${U}px)`}else a.current&&E==="stack"&&(a.current.style.transform="none")};k.addEventListener("scroll",B,{passive:!0});const G=new ResizeObserver(()=>{j()});G.observe(k);const I=setInterval(j,1e3);return()=>{clearInterval(I),k.removeEventListener("scroll",B),G.disconnect()}}const R=setTimeout(j,100);return()=>clearTimeout(R)},[h,y,t.length,E]);const A=c=>{c.pageNumber&&m?(m(c.pageNumber),setTimeout(()=>{c.linkedText&&r&&r(c.linkedText)},500)):c.linkedText&&r&&r(c.linkedText)},z=c=>{const j=new Date(c);return j.toLocaleDateString()+" "+j.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},_=i.useCallback(()=>{const c=h?.current||window.__pdfContentRef;if(!c)return;const j=new Map;t.forEach(k=>{if(!k.pageNumber||k.textYPosition===void 0)return;const R=c.querySelectorAll(".pdf-page-wrapper");if(R.length<k.pageNumber){const te=c.querySelectorAll(".react-pdf__Page");if(te.length<k.pageNumber)return;const X=te[k.pageNumber-1];if(!X)return;const oe=X.offsetTop,re=X.offsetHeight,ie=oe+k.textYPosition*re;j.set(k.id,ie);return}const B=R[k.pageNumber-1];if(!B)return;const G=B.offsetTop,I=B.offsetHeight,U=k.textYPosition*I,ee=G+U;j.set(k.id,ee)}),D(j)},[t,h]);i.useEffect(()=>{_();const c=h?.current||window.__pdfContentRef;if(c){const j=new ResizeObserver(()=>{_()});j.observe(c);const k=setInterval(_,500);return()=>{j.disconnect(),clearInterval(k)}}},[_,h,y]),i.useEffect(()=>{if(s>0){const c=setTimeout(()=>{_()},200);return()=>clearTimeout(c)}},[s,_]);const J=c=>C.get(c.id);return e.jsxs("div",{className:`knowledge-notes-panel ${f}-layout theme-${x} ${y?"knowledge-notes-visible":""}`,children:[e.jsxs("div",{className:"knowledge-notes-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx("h3",{children:"Knowledge Notes"}),e.jsx("button",{className:"display-mode-toggle",onClick:()=>M(E==="following"?"stack":"following"),title:E==="following"?"Switch to stack mode":"Switch to following mode",style:{background:"transparent",border:"1px solid rgba(0, 0, 0, 0.2)",borderRadius:"4px",padding:"4px 8px",cursor:"pointer",fontSize:"12px",color:"inherit",display:"flex",alignItems:"center",gap:"4px"},children:E==="following"?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]}),"Following"]}):e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"9",y1:"9",x2:"15",y2:"9"}),e.jsx("line",{x1:"9",y1:"15",x2:"15",y2:"15"})]}),"Stack"]})})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxs("button",{className:"notes-count-button",onClick:c=>{c.preventDefault(),c.stopPropagation(),t.length>0&&($(null),O(!0))},title:t.length>0?"Clear all notes":"No notes to clear",disabled:t.length===0,children:[e.jsx("span",{className:"notes-count-text",children:t.length}),e.jsxs("svg",{className:"notes-count-clear-icon",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})]}),e.jsx("button",{className:"knowledge-notes-close",onClick:c=>{c.stopPropagation(),l?.()},"aria-label":"Close knowledge notes",style:{display:"none",background:"transparent",border:"none",cursor:"pointer",padding:"4px"},children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]}),e.jsx("div",{className:`knowledge-notes-list ${E==="stack"?"stack-mode":"following-mode"}`,ref:a,style:{height:E==="following"&&s>0?`${s}px`:"auto",overflow:E==="stack"?"auto":"visible"},children:t.length===0?e.jsx("div",{className:"empty-notes",children:"No knowledge notes yet"}):t.map(c=>{const j=u.has(c.id),k=J(c),B=(c.content?c.content.split(`
`):[]).length>3||c.content&&c.content.length>200,G=H===c.id;return e.jsxs("div",{className:`knowledge-note-item ${G?"note-front":""}`,onClick:I=>{const U=I.target;U.closest("button")||U.closest(".note-linked-text")||E==="following"&&b(c.id)},style:E==="following"&&k!==void 0?{position:"absolute",top:`${k}px`,left:"8px",right:"8px",width:"auto",zIndex:G?20:10,pointerEvents:"auto",transition:"z-index 0.2s ease"}:{position:"relative",marginBottom:"12px",marginLeft:"8px",marginRight:"8px",width:"auto"},children:[e.jsxs("div",{className:"note-header",children:[e.jsxs("div",{className:"note-meta",children:[c.pageNumber&&e.jsxs("span",{className:"note-page-badge",children:["Page ",c.pageNumber]}),c.linkedText&&e.jsx("span",{className:"note-text-badge",children:"Linked Text"}),e.jsx("span",{className:"note-date",children:z(c.createdAt)})]}),e.jsx("button",{className:"note-delete-button",onClick:I=>{I.stopPropagation(),$(c.id),O(!0)},title:"Delete note",children:"Ã—"})]}),c.linkedText&&e.jsxs("div",{className:"note-linked-text",onClick:()=>{A(c),g?.(c)},children:['"',c.linkedText.substring(0,100),c.linkedText.length>100?"...":"",'"']}),e.jsxs("div",{className:"note-content-wrapper",children:[e.jsx("div",{className:`note-content ${j?"expanded":"collapsed"}`,children:c.content}),B&&e.jsx("button",{className:"note-expand-button",onClick:I=>{I.preventDefault(),I.stopPropagation(),w(c.id,I)},onMouseDown:I=>{I.stopPropagation()},title:j?"Collapse":"Expand",type:"button",children:j?e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"18 15 12 9 6 15"})}),e.jsx("span",{children:"Show Less"})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})}),e.jsx("span",{children:"Show More"})]})})]})]},c.id)})}),F&&e.jsx("div",{className:"confirm-dialog-overlay",onClick:()=>{O(!1),$(null)},children:e.jsxs("div",{className:"confirm-dialog",onClick:c=>c.stopPropagation(),children:[e.jsx("div",{className:"confirm-dialog-header",children:e.jsx("h3",{children:S?"Delete Note":"Clear All Notes"})}),e.jsx("div",{className:"confirm-dialog-content",children:S?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"Are you sure you want to delete this knowledge note?"}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Are you sure you want to delete all ",e.jsx("strong",{children:t.length})," knowledge note",t.length===1?"":"s","?"]}),e.jsx("p",{className:"confirm-dialog-warning",children:"This action cannot be undone."})]})}),e.jsxs("div",{className:"confirm-dialog-actions",children:[e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-cancel",onClick:()=>{O(!1),$(null)},children:"Cancel"}),e.jsx("button",{className:"confirm-dialog-button confirm-dialog-button-confirm",onClick:()=>{S?(o(S),$(null)):p&&p(),O(!1)},children:S?"Delete":"Clear All"})]})]})})]})};let K;async function He(){if(!K){if(typeof window<"u"&&window.pdfjsLib)K=window.pdfjsLib;else{const t=await me(()=>import("./vendor-pdf-DDxsMbbh.js").then(o=>o.p),[]);K=t.default||t}if(typeof window<"u"&&K&&!K.GlobalWorkerOptions?.workerSrc){let t;{const o="/ChatNote/";t=`${o.endsWith("/")?o:`${o}/`}pdf.worker.min.js`}K.GlobalWorkerOptions?K.GlobalWorkerOptions.workerSrc=t:K.GlobalWorkerOptions={workerSrc:t}}}return K}async function Ue(t){try{const o=await He(),p=await t.arrayBuffer(),r=await o.getDocument({data:p}).promise,f=r.numPages,x=[];for(let l=1;l<=f;l++){const d=(await(await r.getPage(l)).getTextContent()).items.map(a=>a.str).join(" ");x.push(Promise.resolve(d))}return(await Promise.all(x)).map((l,h)=>`--- Page ${h+1} ---
${l}`).join(`

`)}catch(o){throw console.error("Error extracting text from PDF:",o),new Error("Failed to extract text from PDF. The PDF may be corrupted or password-protected.")}}const Ke=i.lazy(()=>me(()=>import("./PDFViewer-BbiCSIdv.js"),__vite__mapDeps([0,1,2,3,4,5,6])));function Ve(){const{theme:t}=ce(),[o,p]=i.useState(null),[m,r]=i.useState(""),[f,x]=i.useState(""),[g,y]=i.useState("floating"),[l,h]=i.useState(!1),[u,d]=i.useState(1),[a,s]=i.useState([]),[N,C]=i.useState(!1),[D,E]=i.useState(null),M=async w=>{p(w),h(!0);try{const A=await Ue(w);r(A)}catch(A){console.error("Failed to extract PDF text:",A),r("")}finally{h(!1)}};i.useEffect(()=>{o||r("")},[o]),i.useEffect(()=>{const w=A=>{if(o)return A.preventDefault(),A.returnValue="",""};return window.addEventListener("beforeunload",w),()=>{window.removeEventListener("beforeunload",w)}},[o]);const F=(w,A,z)=>{x(w),w&&A!==void 0&&z!==void 0&&E({text:w,pageNumber:A,textYPosition:z})},O=()=>{y(w=>w==="floating"?"split":"floating")},S=(w,A,z,_)=>{const J=z||D?.pageNumber||u,c=D?.textYPosition,j={id:`note-${Date.now()}`,content:w,linkedText:A||D?.text,pageNumber:J,textYPosition:c,createdAt:Date.now(),messageId:_};s(k=>[...k,j])},$=w=>{s(A=>A.filter(z=>z.id!==w))},H=()=>{s([])},b=w=>{d(w),window.__pdfScrollToPage&&window.__pdfScrollToPage(w)};return e.jsxs("div",{className:"app",children:[e.jsx(Re,{}),e.jsxs("div",{className:`main-content ${g==="split"?"split-layout":""} ${N&&g==="floating"?"has-knowledge-notes":""}`,children:[e.jsx(ze,{children:e.jsx(i.Suspense,{fallback:e.jsx("div",{style:{padding:"20px",textAlign:"center"},children:"Loading PDF viewer..."}),children:e.jsx(Ke,{file:o,onFileUpload:M,onTextSelection:F,layout:g,onPageChange:d,showKnowledgeNotes:N,onToggleKnowledgeNotes:()=>C(!N),knowledgeNotes:a,onScrollToPage:b,onNoteClick:w=>{w.pageNumber&&b(w.pageNumber)}})})}),N&&e.jsx(qe,{notes:a,onDeleteNote:$,onClearAllNotes:H,onScrollToPage:b,layout:g,theme:t,isVisible:N,onClose:()=>C(!1),onNoteClick:w=>{w.pageNumber&&b(w.pageNumber)},pdfContentRef:window.__pdfContentRef?{current:window.__pdfContentRef}:void 0}),e.jsx("div",{className:`chat-container ${g==="floating"?"floating-chat":"split-chat"} ${N?"knowledge-notes-open":""}`,children:e.jsx(We,{selectedText:f,pdfText:m,isExtractingText:l,onToggleLayout:O,layout:g,currentPageNumber:u,onCreateKnowledgeNote:S})})]})]})}function Ye(){return e.jsx(Le,{children:e.jsx(Ie,{children:e.jsx(Ve,{})})})}const le=document.getElementById("root");if(!le)throw new Error("Root element not found");try{ve.createRoot(le).render(e.jsx(be.StrictMode,{children:e.jsx(Ye,{})}))}catch(t){le.innerHTML=`
    <div style="padding: 20px; color: red;">
      <h1>Error Loading App</h1>
      <p>${t instanceof Error?t.message:String(t)}</p>
      <p>Check the browser console for more details.</p>
    </div>
  `}export{me as _};
